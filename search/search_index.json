{"config":{"lang":["nl","en"],"separator":"[\\s\\-\\.]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"The LPIC2 Exam Prep","text":"<p>8<sup>th</sup> edition \u03b2, for version 4.5</p> <p>Update your bookmark!</p> <p>\"The former <code>https://lpic2...</code> URL might no longer be available.\"</p> <p>A PDF version is also available</p> <p>https://lpic2book.github.io/src/pdf/lpic2book.pdf</p> <p>Written, updated and reviewed by many past and present colleagues @ Sue B.V., Geldermalsen, The Netherlands.</p> <p>Donated in 2021 to the community for many more updates and reviews.</p> <p>Copyright \u00a9 2001-2021 Sue B.V. -  Open Sourced 2021</p>"},{"location":"#abstract","title":"Abstract","text":"<ul> <li> <p>Audience:  this book is intended to help people prepare for the LPIC-2     exam. You will need to have at least 2 years of practical experience     with Unix, preferably Linux. Though you may take the LPIC-2 exam     without it, you should be an LPIC-1 alumnus to be allowed to the     titles and rights that come with the LPIC-2 certification.</p> </li> <li> <p>Approach: We wanted to create a set of documents that could help us     and others to pass the LPIC-2 exams. This book contains all the     information (and more) needed to pass the exam.</p> </li> <li> <p>Sources: Our sources of information were partly acquired from material     on the Internet. Also practical experience of the authors and others     and research done by the authors are to be credited. We try to give     credit where due, but are fallible. We apologize.</p> </li> </ul> <p></p>"},{"location":"#disclaimer","title":"Disclaimer","text":"<p>While every precaution was made in the preparation of this book, we can assume no responsibility for errors or omissions. When you feel we have not given you proper credit or feel we may have violated your rights or when you have suggestions how we may improve our work please notify us immediately creating an issue on the GitHub repository so corrective  action can be taken.</p> <p>Organization of this book: This book has been organized to follow the Linux Professional Institute level 2 objectives for LPIC-2 certification revision 4.5.0 of February 13<sup>th</sup>, 2017. The detailed objectives are available via https://www.lpi.org/study-resources/lpic-2-201-exam-objectives/ and https://www.lpi.org/study-resources/lpic-2-202-exam-objectives/ .</p> <p>In case new objectives are published, the book will follow shortly thereafter.</p> <p>The editors used Markdown as markup language for this book, and Pandoc as converter.</p>"},{"location":"lpic2.200.0/","title":"200 Capacity Planning (200)","text":"<p>This topic has a total weight of 8 points and contains the following objectives:</p>"},{"location":"lpic2.200.0/#objective-2001-measure-and-troubleshoot-resource-usage-6-points","title":"Objective 200.1; Measure and Troubleshoot Resource Usage (6 points)","text":"<ul> <li>Candidates should be able to measure hardware resource and network     bandwidth, identify and troubleshoot resource problems.</li> </ul>"},{"location":"lpic2.200.0/#objective-2002-predict-future-resource-needs-2-points","title":"Objective 200.2; Predict Future Resource Needs (2 points)","text":"<ul> <li>Candidates should be able to monitor resource usage to predict     future resource needs.</li> </ul>"},{"location":"lpic2.200.1/","title":"Measure and Troubleshoot Resource Usage (200.1)","text":""},{"location":"lpic2.200.1/#measure-and-troubleshoot-resource-usage","title":"Measure and Troubleshoot Resource Usage","text":""},{"location":"lpic2.200.1/#objectives","title":"Objectives","text":"<p>Candidates should be able to measure hardware resource and network bandwidth, identify and troubleshoot resource problems.</p>"},{"location":"lpic2.200.1/#key-knowledge-areas","title":"Key Knowledge Areas:","text":"<ul> <li> <p>Measure CPU usage</p> </li> <li> <p>Measure memory usage</p> </li> <li> <p>Measure disk I/O</p> </li> <li> <p>Measure network I/O</p> </li> <li> <p>Measure firewalling and routing throughput</p> </li> <li> <p>Map client bandwith usage</p> </li> <li> <p>Match / correlate system symptoms with likely problems</p> </li> <li> <p>Estimate throughput and identify bottlenecks in a system including     networking</p> </li> </ul>"},{"location":"lpic2.200.1/#terms-and-utilities","title":"Terms and utilities:","text":"<ul> <li> <p><code>iostat</code></p> </li> <li> <p><code>iotop</code></p> </li> <li> <p><code>vmstat</code></p> </li> <li> <p><code>netstat</code></p> </li> <li> <p><code>ss</code></p> </li> <li> <p><code>iptraf</code></p> </li> <li> <p><code>pstree, ps</code></p> </li> <li> <p><code>w</code></p> </li> <li> <p><code>lsof</code></p> </li> <li> <p><code>top</code></p> </li> <li> <p><code>htop</code></p> </li> <li> <p><code>uptime</code></p> </li> <li> <p><code>sar</code></p> </li> <li> <p>swap</p> </li> <li> <p>processes blocked on I/O</p> </li> <li> <p>blocks in</p> </li> <li> <p>blocks out</p> </li> <li> <p>network</p> </li> </ul>"},{"location":"lpic2.200.1/#iostat","title":"iostat","text":"<p>Note Depending on the version of your Linux distribution it may be necessary to install a package like Debian <code>sysstat</code> to access tools like <code>iostat</code>, <code>sar</code>, <code>mpstat</code>, etc. The Debian <code>procps</code> package contains utilities like <code>free</code>, <code>uptime</code>, <code>vmstat</code>, <code>w</code>, <code>sysctl</code>, etc.</p> <p>The <code>iostat</code> command is used for monitoring system input/output (I/O) device load. This is done by observing the time the devices are active in relation to their average transfer rates. Without any options, the <code>iostat</code> command displays statistics since the last system reboot. When interval and count arguments are passed to <code>iostat</code>, statistics for each specified time interval are added to the output. The <code>-y</code> option can also be used to suppress statistics since the last reboot.</p> <p>Usage:</p> <pre><code>    $ iostat options interval count\n</code></pre> <p>Examples:</p> <pre><code>    $ iostat\n    Linux 3.2.0-4-686-pae (debian)  05/07/2013  _i686_  (2 CPU)\n\n    avg-cpu:  %user   %nice %system %iowait  %steal   %idle\n    1.25    0.32    3.76    0.20    0.00   94.46\n\n    Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn\n    sda              12.21       214.81        17.38     333479      26980\n\n    $ iostat 1 3\n    Linux 3.2.0-4-686-pae (debian)  05/07/2013  _i686_  (2 CPU)\n\n    avg-cpu:  %user   %nice %system %iowait  %steal   %idle\n    24.24    1.51    7.49    4.97    0.00   61.79\n\n    Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn\n    sda              14.06       249.94       121.22    1337998     648912\n\n    avg-cpu:  %user   %nice %system %iowait  %steal   %idle\n    13.13    0.00    6.21    0.60    0.00   80.06\n\n    Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn\n    sda               2.51         4.01        28.86         40        288\n\n    avg-cpu:  %user   %nice %system %iowait  %steal   %idle\n    11.11    0.00    5.71    0.00    0.00   83.18\n\n    Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn\n    sda               0.30         0.00         3.20          0         32\n\n    $ iostat -c\n    Linux 3.2.0-4-686-pae (debian)  05/07/2013  _i686_  (2 CPU)\n\n    avg-cpu:  %user   %nice %system %iowait  %steal   %idle\n    9.16    0.05   17.01    1.37    0.00   72.42\n</code></pre>"},{"location":"lpic2.200.1/#iotop","title":"iotop","text":"<p>The <code>iotop</code> command is similar to the <code>top</code> command. It shows I/O usage information output by the Linux kernel and displays a table of current I/O usage by processes or threads on the system.</p> <p><code>iotop</code> displays columns for the I/O bandwidth read and written by each process/thread during the sampling period. It also displays the percentage of time the thread/process spent while swapping in and while waiting on I/O. For each process, its I/O priority (class/level) is shown. In addition, the total I/O bandwidth read and written during the sampling period is displayed at the top of the interface.</p> <p>Usage:</p> <pre><code>    $ iotop options\n</code></pre> <p>Example:</p> <pre><code>    $ iotop -b |head\nTotal DISK READ :       0.00 B/s | Total DISK WRITE :     213.38 M/s\nActual DISK READ:       0.00 B/s | Actual DISK WRITE:       0.00 B/s\n  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN      IO    COMMAND\n    6 be/4 root        0.00 B/s    0.00 B/s  0.00 % 99.99 % [kworker/u8:0]\n  191 be/3 root        0.00 B/s    0.00 B/s  0.00 % 94.14 % [jbd2/sda1-8]\n 2976 be/4 root        0.00 B/s  213.38 M/s  0.00 %  0.00 % dd if=/dev/zero of=/tmp/foo\n    1 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % init\n    2 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % [kthreadd]\n    3 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % [ksoftirqd/0]\n    5 be/0 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % [kworker/0:0H]\n</code></pre>"},{"location":"lpic2.200.1/#vmstat","title":"vmstat","text":"<p>The <code>vmstat</code> command reports virtual memory statistics about processes, memory, paging, block I/O, traps, and CPU utilization.</p> <p>Usage:</p> <pre><code>    $ vmstat options delay count\n</code></pre> <p>Example:</p> <pre><code>    $ vmstat 2 2\n    procs ---memory-- ---swap-- -----io---- -system-- ----cpu----\n    r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa\n    0  0      0 109112  33824 242204    0    0   603    26  196  516  7 11 81  1\n    0  0      0 109152  33824 242204    0    0     0     2  124  239  0  1 98  0\n</code></pre> <p>Please beware that the first row will always show average measurements since the machine has booted, and should therefore be neglected. Values which are related to memory and I/O are expressed in kilobytes (1024 bytes). Old (pre-2.6) kernels might report blocks as 512, 2048 or 4096 bytes instead. Values related to CPU measurements are expressed as a percent of total CPU time. Keep this in mind when interpreting measurements from a multi-CPU system, as on these systems <code>vmstat</code> averages the number of CPUs into the output. All five CPU fields should add up to a total of 100% for each interval shown. This is independent of the number of processors or cores. In other words: <code>vmstat</code> can NOT be used to show statistics per processor or core (<code>mpstat</code> or <code>ps</code> should be used in that case). <code>vmstat</code> will accept delay in seconds and a number of counts (repetitions) as an argument, but the process and memory measurement results will always remain to be instantaneous.</p> <p>The first process column, \"r\" lists the number of processes currently allocated to the processor run queue. These processes are waiting for processor run time, also known as CPU time.</p> <p>The second process column, \"b\" lists the number of processes currently allocated to the block queue. These processes are listed as being in uninterruptable sleep, which means they are waiting for a device to return either input or output (I/O).</p> <p>The first memory column, \"swpd\" lists the amount of virtual memory being used expressed in kilobytes (1024 bytes). Virtual memory consists of swap space from disk, which is considerably slower than physical memory allocated inside memory chips.</p> <p>The second memory column, \"free\" lists the amount of memory currently not in use, not cached and not buffered expressed.</p> <p>The third memory column, \"buff\" lists the amount of memory currently allocated to buffers. Buffered memory contains raw disk blocks.</p> <p>The fourth memory column, \"cache\" lists the amount of memory currently allocated to caching. Cached memory contains files.</p> <p>The fifth memory column, \"inact\" lists the amount of inactive memory. This is only shown using the <code>-a</code> option.</p> <p>The sixth memory column, \"active\" lists the amount of active memory. This is only shown using the <code>-a</code> option.</p> <p>The first swap column, \"si\" lists the amount of memory being swapped in from disk (per second).</p> <p>The second swap column, \"so\" lists the amount of memory being swapped out to disk (per second).</p> <p>The first io column, \"bi\" lists the amount of blocks per second being received from a block device.</p> <p>The second io column, \"bo\" lists the amount of blocks per second being sent to a block device.</p> <p>The first system column, \"in\" lists the number of interrupts per second (including the clock).</p> <p>The second system column, \"cs\" lists the number of context switches per second.</p> <p>The cpu columns are expressed as percentages of total CPU time.</p> <p>The first cpu column, \"us\" (user code) shows the percentage of time spent running non-kernel code.</p> <p>The second cpu column, \"sy\" (system code) shows the percentage of time spent running kernel code.</p> <p>The third cpu column, \"id\" shows the percentage of idle time.</p> <p>The fourth cpu column, \"wa\" shows the percentage of time spent waiting for I/O (Input/Output).</p> <p>The fifth cpu column, \"st\" (steal time) shows the percentage of time stolen from a virtual machine. This is the amount of real CPU time the virtual machine (hypervisor or VirtualBox) has allocated to tasks other than running your virtual machine.</p>"},{"location":"lpic2.200.1/#netstat","title":"netstat","text":"<p>The <code>netstat</code> command shows network connections, routing tables, interface statistics, masquerade connections and multicast memberships. The results are dependant on the first argument:</p> <ul> <li> <p><code>(no argument given)</code> - all active sockets of all configured address     families will be listed.</p> </li> <li> <p><code>--route, -r</code> - the kernel routing tables are     shown, output is identical to <code>route -e</code> (note: in order to use     <code>route</code>, elevated privileges might be needed whereas <code>netstat -r</code>     can be run with user privileges instead).</p> </li> <li> <p><code>--groups, -g</code> - lists multicast group membership information for     IPv4 and IPv6</p> </li> <li> <p><code>--interfaces, -i</code> - lists all network interfaces and certain     specific properties</p> </li> <li> <p><code>--statistics, -s</code> - lists a summary of statistics for each     protocol, similar to SNMP output</p> </li> <li> <p><code>--masquerade, -M</code> - lists masqueraded connections on pre-2.4 kernels.     On newer kernels, use <code>cat /proc/net/ip_conntrack</code> instead. In order for     this to work, the ipt_MASQUERADE kernel module has to be loaded.     This applies to 2.x and 3.x kernels.</p> </li> </ul> <p>Usage:</p> <pre><code>    $ netstat address_family_options options\n</code></pre> <p>Examples:</p> <pre><code>    $ netstat -aln --tcp\n    Active Internet connections (servers and established)\n    Proto Recv-Q Send-Q Local Address           Foreign Address         State\n    tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN\n    tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN\n    tcp        0      0 0.0.0.0:34236           0.0.0.0:*               LISTEN\n    tcp        0      0 0.0.0.0:389             0.0.0.0:*               LISTEN\n    tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN\n    tcp6       0      0 :::22                   :::*                    LISTEN\n    tcp6       0      0 ::1:25                  :::*                    LISTEN\n    tcp6       0      0 :::32831                :::*                    LISTEN\n\n    $ netstat -al --tcp\n    Active Internet connections (servers and established)\n    Proto Recv-Q Send-Q Local Address           Foreign Address         State\n    tcp        0      0 *:ssh                   *:*                     LISTEN\n    tcp        0      0 localhost:smtp          *:*                     LISTEN\n    tcp        0      0 *:34236                 *:*                     LISTEN\n    tcp        0      0 *:ldap                  *:*                     LISTEN\n    tcp        0      0 *:sunrpc                *:*                     LISTEN\n    tcp6       0      0 [::]:ssh                [::]:*                  LISTEN\n    tcp6       0      0 localhost:smtp          [::]:*                  LISTEN\n    tcp6       0      0 [::]:32831              [::]:*                  LISTEN\n</code></pre>"},{"location":"lpic2.200.1/#ss","title":"ss","text":"<p>The <code>ss</code> command is used to show socket statistics. It can display stats for PACKET sockets, TCP sockets, UDP sockets, DCCP sockets, RAW sockets, Unix domain sockets, and more. It allows showing information similar to the <code>netstat</code> command, but it can display more TCP and state information.</p> <p>Most Linux distributions are shipped with <code>ss</code>. Being familiar with this tool helps enhance your understand of what's going on in the system sockets and helps you find the possible causes of a performance problem.</p> <p>Usage:</p> <pre><code>    $ ss options filter\n</code></pre> <p>Example:</p> <pre><code>    $ ss -t -a\n    State      Recv-Q Send-Q              Local Address:Port             Peer Address:Port\n    LISTEN     0      5                   192.168.122.1:domain                  *:*\n    LISTEN     0      128                             *:ssh                     *:*\n    LISTEN     0      128                     127.0.0.1:ipp                     *:*\n    LISTEN     0      100                     127.0.0.1:smtp                    *:*\n</code></pre>"},{"location":"lpic2.200.1/#iptraf","title":"iptraf","text":"<p>The <code>iptraf</code> tool is a network monitoring utility for IP networks and can be used to monitor the load on an IP network. It intercepts packets on the network and displays information about the current traffic over it.</p> <p><code>iptraf</code> gathers data like TCP connection packet and byte counts, interface statistics and activity indicators, TCP/UDP traffic breakdowns, and LAN station packet and byte counts. IPTraf features include an IP traffic monitor which shows TCP flag information, packet and byte counts, ICMP details, OSPF packet types, and oversized IP packet warnings.</p> <p>Usage:</p> <pre><code>    $ iptraf options\n</code></pre> <p>Example:</p> <pre><code>    $ iptraf\n</code></pre> <p></p>"},{"location":"lpic2.200.1/#ps","title":"ps","text":"<p>Usage:</p> <pre><code>    $ ps options\n</code></pre> <p>The <code>ps</code> command shows a list of the processes currently running. These are the same processes which are being shown by the <code>top</code> command. The GNU version of <code>ps</code> accepts three different kind of options:</p> <ol> <li> <p>UNIX options - these may be grouped and must be preceded by a single dash</p> </li> <li> <p>BSD options - these may be grouped and must be used without a dash</p> </li> <li> <p>GNU long options - these are preceded by two dashes</p> </li> </ol> <p>These options may be mixed on GNU <code>ps</code> up to some extent, but bear in mind that depending on the version of Linux you are working on you might encounter a less flexible variant of <code>ps</code>. The <code>ps</code> manpage can be, depending on the distribution being questioned, nearly 900 lines long. Because of its versatile nature, you are encouraged to read through the manpage and try out some of the options <code>ps</code> has to offer.</p> <p>Examples:</p> <pre><code>    $ ps ef\n    PID TTY      STAT   TIME COMMAND\n    4417 pts/0    Ss     0:00 bashDISPLAY=:0 PWD=/home/user HOME=/home/user SESSI\n    4522 pts/0    R+     0:00  \\_ ps efSSH_AGENT_PID=4206 GPG_AGENT_INFO=/home/user/\n\n    $ ps -ef\n    UID        PID  PPID  C STIME TTY          TIME CMD\n    root         1     0  0 02:02 ?        00:00:01 init [2]\n    root         2     0  0 02:02 ?        00:00:00 [kthreadd]\n    root         3     2  0 02:02 ?        00:00:01 [ksoftirqd/0]\n    root         4     2  0 02:02 ?        00:00:01 [kworker/0:0]\n    root         6     2  0 02:02 ?        00:00:00 [migration/0]\n    root         7     2  0 02:02 ?        00:00:00 [watchdog/0]\n</code></pre>"},{"location":"lpic2.200.1/#pstree","title":"pstree","text":"<p>The <code>pstree</code> command displays the same processes as <code>ps</code> and <code>top</code>, but the output is presented in a tree-like structure. The tree is rooted at pid (or <code>init</code> if pid is omitted), and if a username is specified the tree will root at all processes owned by that username. <code>pstree</code> provides an easy way to track back a process to its parent process id (PPID). Output between square brackets prefixed by a number are identical branches of processes grouped together, the prefixed number represents the repetition count. Grouped child threads are shown between square brackets as well but the process name will be shown between curly braces as an addition. The last line of the output shows the number of children for a given process.</p> <p>Usage:</p> <pre><code>    $ pstree options pid|username\n</code></pre> <p>Example:</p> <pre><code>    $ pstree 3655\n    gnome-terminal---bash---pstree\n                   |-bash---man---pager\n                   |-gnome-pty-helpe\n                   `-3*[{gnome-terminal}]\n</code></pre>"},{"location":"lpic2.200.1/#w","title":"w","text":"<p>The <code>w</code> command displays information about the users currently logged on to the machine, their processes and the same statistics as provided by the <code>uptime</code> command.</p> <p>Usage:</p> <pre><code>    $ w options user\n</code></pre> <p>Example:</p> <pre><code>    $ w -s\n    02:52:10 up 49 min,  2 users,  load average: 0.11, 0.10, 0.13\n    USER     TTY      FROM              IDLE WHAT\n    user     tty9     :0                49:51  gdm-session-worker [pam/gdm3]\n    user     pts/0    :0                0.00s w -s\n</code></pre> <p>Option <code>-s</code> stands for \"short format\".</p>"},{"location":"lpic2.200.1/#lsof","title":"lsof","text":"<p>The <code>lsof</code> command is used to list information about open files and their corresponding processes. <code>lsof</code> will handle regular files, directories, block special files, character special files, executing text references, libraries, streams or network files. By default, lsof will show unformatted output which might be hard to read but is very suitable to be interpreted by other programs. The <code>-F</code> option plays an important role here. The <code>-F</code> option is used to get output that can be used by programs like C, Perl and awk. Read the manpages for detailed usage and the possibilities.</p> <p>Usage:</p> <pre><code>    $ lsof options names\n</code></pre> <p>The names argument acts as a filter here. Without options, <code>lsof</code> will display all open files belonging to all active processes.</p> <p>Examples:</p> <pre><code>    $ sudo lsof /var/run/utmp\n    COMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\n    gdm-simpl 4040 root   10u   REG   0,14     5376  636 /run/utmp\n\n    $ sudo lsof +d /var/log\n    COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF   NODE NAME\n    rsyslogd 2039 root    1w   REG    8,1    44399 262162 /var/log/syslog\n    rsyslogd 2039 root    2w   REG    8,1   180069 271272 /var/log/messages\n    rsyslogd 2039 root    3w   REG    8,1    54012 271269 /var/log/auth.log\n    rsyslogd 2039 root    6w   REG    8,1   232316 271268 /var/log/kern.log\n    rsyslogd 2039 root    7w   REG    8,1   447350 271267 /var/log/daemon.log\n    rsyslogd 2039 root    8w   REG    8,1    68368 271271 /var/log/debug\n    rsyslogd 2039 root    9w   REG    8,1     7888 271270 /var/log/user.log\n    Xorg     4041 root    0r   REG    8,1    31030 262393 /var/log/Xorg.0.log\n</code></pre> <p>This last example causes <code>lsof</code> to search for all open instances of directory <code>/var/log</code> and the files and directory it contains at its top level.</p>"},{"location":"lpic2.200.1/#free","title":"free","text":"<p>The <code>free</code> command displays a current overview of the total amount of both physical and swap memory on a system, as well as the amount of free memory, memory in use and buffers used by the kernel.</p> <p>The fourth column, called shared has been obsolete but is now used to display the memory used for tmpfs (shmem in /proc/meminfo)</p> <p>Usage:</p> <pre><code>    $ free  options\n</code></pre> <p>Example:</p> <pre><code>    $ free -h\n                 total       used       free     shared    buffers     cached\n    Mem:          502M       489M        13M        50B        44M       290M\n    -/+ buffers/cache:       154M       347M\n    Swap:         382M       3.9M       379M\n</code></pre>"},{"location":"lpic2.200.1/#top","title":"top","text":"<p>The <code>top</code> command provides a \"dynamic real-time view\" of a running system.</p> <p>Usage:</p> <pre><code>    $ top options\n</code></pre> <p>Example:</p> <pre><code>    $ top\n    top - 03:01:24 up 59 min,  2 users,  load average: 0.15, 0.19, 0.16\n    Tasks: 117 total,   2 running, 115 sleeping,   0 stopped,   0 zombie\n    %Cpu(s):  0.9 us,  4.5 sy,  0.1 ni, 94.3 id,  0.1 wa,  0.0 hi,  0.1 si,  0.0 st\n    KiB Mem:    514332 total,   497828 used,    16504 free,    63132 buffers\n    KiB Swap:   392188 total,        0 used,   392188 free,   270552 cached\n\n      PID USER      PR  NI  VIRT  RES  SHR S  %CPU %MEM    TIME+  COMMAND\n     4041 root      20   0  106m  31m 9556 R  30.4  6.3   3:05.58 Xorg\n     4262 user      20   0  527m  71m  36m S  18.2 14.3   2:04.42 gnome-shell\n</code></pre> <p>Because of its interactive mode, the most important keys while operating <code>top</code> are the help keys <code>h</code> or <code>?</code> and the quit key <code>q</code>. The following scheme provides an overview of the most important function keys and their equivalent alternatives:</p> <pre><code>    key      equivalent-key-combinations\n    Up       alt + \\      or  alt + k\n    Down     alt + /      or  alt + j\n    Left     alt + &lt;      or  alt + h\n    Right    alt + &gt;      or  alt + l (lower case L)\n    PgUp     alt + Up     or  alt + ctrl + k\n    PgDn     alt + Down   or  alt + ctrl + j\n    Home     alt + Left   or  alt + ctrl + h\n    End      alt + Right  or  alt + ctrl + l\n</code></pre>"},{"location":"lpic2.200.1/#htop","title":"htop","text":"<p>Usage:</p> <pre><code>    $ htop options\n</code></pre> <p>The <code>htop</code> command is similar to the <code>top</code> command, but allows you to scroll vertically and horizontally, so you can see all the processes running on the system, along with their full command lines. Tasks related to processes (killing, renicing) can be done without entering their PIDs.</p> <p>Example:</p> <pre><code>    $ htop\n</code></pre> <p></p>"},{"location":"lpic2.200.1/#uptime","title":"uptime","text":"<p>The <code>uptime</code> command shows how long the system has been running, how many users are logged on, the system load averages for the past 1, 5 and 15 minutes and the current time. It support the <code>-V</code> option for version information.</p> <p>Usage:</p> <pre><code>    $ uptime options\n</code></pre> <p>Example:</p> <pre><code>    $ uptime\n    03:03:12 up  1:00,  2 users,  load average: 0.17, 0.18, 0.16\n</code></pre>"},{"location":"lpic2.200.1/#sar","title":"sar","text":"<p>The <code>sar</code> command collects, reports or saves system activity information.</p> <p>Usage:</p> <pre><code>    $ sar options interval count\n</code></pre> <p>Examples:</p> <pre><code>    $ sar\n    Linux 3.2.0-4-686-pae (debian)  05/07/2013  _i686_  (2 CPU)\n\n    02:02:34      LINUX RESTART\n\n    02:05:01    CPU     %user     %nice   %system   %iowait    %steal     %idle\n    02:15:01    all      0.15      0.00      1.06      0.23      0.00     98.56\n    02:25:01    all      0.98      0.83      3.84      0.04      0.00     94.31\n    02:35:01    all      0.46      0.00      4.84      0.04      0.00     94.66\n    02:45:01    all      0.90      0.00      5.29      0.01      0.00     93.80\n    02:55:01    all      0.66      0.00      4.64      0.03      0.00     94.67\n    03:05:02    all      0.66      0.00      5.57      0.01      0.00     93.76\n    Average:    all      0.64      0.14      4.19      0.06      0.00     94.98\n</code></pre> <p>Without options, sar will output the statistics above.</p> <p>Using the <code>-d</code> option sar will output disk statistics.</p> <pre><code>    $ sar -d\n    06:45:01     DEV      tps  rd_sec/s  wr_sec/s  avgrq-sz avgqu-sz   await   svctm   %util\n    06:55:01  dev8-0     6.89    227.01     59.67     41.59     0.02    2.63    1.38    0.95\n    07:05:01  dev8-0     2.08     17.73     17.78     17.06     0.00    2.19    0.94    0.20\n    07:15:01  dev8-0     1.50     12.16     12.96     16.69     0.00    1.35    0.68    0.10\n    Average:  dev8-0     3.49     85.63     30.14     33.15     0.01    2.36    1.19    0.42\n</code></pre> <p>The <code>-b</code> option switch shows output related to I/O and transfer rate statistics:</p> <pre><code>    $ sar -b\n    06:45:01      tps      rtps      wtps   bread/s   bwrtn/s\n    06:55:01     6.89      4.52      2.38    227.01     59.67\n    07:05:01     2.08      0.95      1.13     17.73     17.78\n    07:15:01     1.50      0.50      1.00     12.16     12.96\n    Average:     3.49      1.99      1.50     85.63     30.14\n</code></pre> <p>Some of the most important options to be used with <code>sar</code> are:</p> <ul> <li> <p><code>-c</code> System calls</p> </li> <li> <p><code>-p and -w</code> Paging and swapping activity</p> </li> <li> <p><code>-q</code> Run queue</p> </li> <li> <p><code>-r</code> Free memory and swap over time</p> </li> </ul>"},{"location":"lpic2.200.1/#match-correlate-system-symptoms-with-likely-problems","title":"Match / correlate system symptoms with likely problems","text":"<p>To troubleshoot a given problem, one must first be able to distinguish normal system behaviour from abnormal system behaviour.</p> <p>In the previous section, a number of very specific system utilities as well as their utilization is explained. In this section, the focus lies on correlating these measurements and being able to detect anomalies, which in turn can be tied to abnormal system behaviour. Resource related problems have a very distinguishable factor in common:</p> <p>They are the result of one or more resources not being able to cope with the demand during certain circumstances.</p> <p>These resources might be related, but are not limited to: the CPU, physical or virtual memory, storage, network interfaces and connections, or the input/output between one or more of these components.</p>"},{"location":"lpic2.200.1/#estimate-throughput-and-identify-bottlenecks-in-a-system-including-networking","title":"Estimate throughput and identify bottlenecks in a system including networking","text":"<p>To determine whether or not a certain problem is related to a lack of resources, the problem itself has to be properly formulated first. Then, this formulated \"deviated\" behaviour has to be compared to the expected behaviour which would result from a trouble-free operating system.</p> <p>If possible, historical data from <code>sar</code> or other tools should be investigated and compared to real-time tools like <code>top</code>, <code>vmstat</code>, <code>netstat</code> and <code>iostat</code>.</p> <p>Problems reported by either users or reporting tools are often related to availability: either resources aren't available in an orderly fashion or are unavailable altogether. Orderly fashion may be interpreted as \"within an acceptable period of time\" here. These kinds of issues are often reported because they are easily noticeable to users\u2014i.e., it affects the user experience.</p> <p>Examples of these kinds of issues might be certain files or (web) applications which aren't accessible or responding within a reasonable period of time. To adequately analyse such a situation, it may be useful to establish a baseline which dictates the \"expected behaviour\" of the program. This baseline should be established on a properly behaving system, and providing a threshold should also be considered.</p> <p>If there is no baseline, resource measurements themselves may help to determine the root cause of a resource-related problem. If one of the resources mentioned above is at 100% of its capacity, for example, the existence of abnormal system behaviour should be easy to explain; finding the precise source of the issue, however, may require a bit more effort. The utilities presented in the previous chapter should be helpful here as well.</p> <p>Examples:</p> <pre><code>    $ top\n    $ vmstat\n    $ iostat\n    $ netstat\n</code></pre> <p>Identifying bottlenecks in a networking environment requires several steps. A best practice approach could be outlined as follows:</p> <ul> <li> <p>Create a map of the network</p> </li> <li> <p>Identify time-dependent behaviour</p> </li> <li> <p>Identify the problem</p> </li> <li> <p>Identify deviating behaviour</p> </li> <li> <p>Identify the cause</p> </li> </ul>"},{"location":"lpic2.200.2/","title":"Predict Future Resource Needs (200.2)","text":""},{"location":"lpic2.200.2/#predict-future-resource-needs-2002","title":"Predict Future Resource Needs (200.2)","text":"<p>Candidates should be able to monitor resource usage to predict future resource needs.</p> <p>Key Knowledge Areas:</p> <ul> <li> <p>Use monitoring and measurement tools to monitor IT infrastructure     usage</p> </li> <li> <p>Predict capacity break point of a configuration</p> </li> <li> <p>Observe growth rate of capacity usage</p> </li> <li> <p>Graph the trend of capacity usage.</p> </li> <li> <p>Awareness of monitoring solutions such as     Icinga2,     Nagios,     collectd,     MRTG and     Cacti.</p> </li> </ul> <p>The following is a partial list of used files, terms and utilities:</p> <ul> <li> <p>diagnose</p> </li> <li> <p>predict growth</p> </li> <li> <p>resource exhaustion</p> </li> </ul>"},{"location":"lpic2.200.2/#diagnose-resource-usage","title":"Diagnose resource usage","text":"<p>Using the tools and knowledge presented in the previous two chapters, it should be possible to diagnose the usage of resources for specific components or processes. One of the tools mentioned was <code>sar</code>, which is capable of recording measurements over a longer period of time. Being able to use the recorded data for trend analysis is one of the advantages of using a tool that is able to log measurements.</p>"},{"location":"lpic2.200.2/#monitor-it-infrastructure","title":"Monitor IT infrastructure","text":"<p>One of the tools that can be used to monitor an IT infrastructure is collectd. collectd is a daemon which collects system performance statistics periodically and provides mechanisms to store the values in a variety of ways. It gathers statistics about the system it is running on and stores this information. Those statistics can then be used to find current performance bottlenecks (i.e. performance analysis) and predict future system load (i.e. capacity planning). collectd is written in C for performance and portability, allowing it to run on systems without scripting language or cron daemon, such as embedded systems. Note that collectd only collects data, to display the collected data addtional tools are required.</p> <p>Also other monitoring tools like Icinga2, Nagios, MRTG and Cacti can be used to measure, collect and display resource performance statistics. Using a montoring tool can help you identify possible bottlenecks related to the measured resources but can also help you predict future growth.</p>"},{"location":"lpic2.200.2/#predict-future-growth","title":"Predict future growth","text":"<p>By analyzing and observing the data from measurements, over time it should be possible to predict the statistical growth of resource needs. We deliberately say statistical growth here, because there are many circumstances which can influence resource needs. The demand for fax machines and phone lines has suffered from the introduction of e-mail, for instance. But numerical or statistical based growth estimations also suffer from the lack of linearity: When expanding due to increased demand the expansion often incorporates a variety of services. The demand for these services usually doesn't grow at the same speed for all provided services. This means that measurement data should not just be analysed, but also evaluated regarding to judge its relevance.</p> <p>The steps to predict future needs can be done as follows:</p> <ul> <li> <p>Decide what to measure.</p> </li> <li> <p>Use the appropriate tools to measure and record relevant data to     meat your goals.</p> </li> <li> <p>Analyze the measurement results, starting with the biggest     fluctuations.</p> </li> <li> <p>Predict future needs based on the analysis.</p> </li> </ul>"},{"location":"lpic2.200.2/#resource-exhaustion","title":"Resource Exhaustion","text":"<p>When a resource cannot deliver to the request in an orderly fashion anymore, it is exhausted. The demand and delivery are not aligned anymore, and the availability of resources will become a problem. Resource Exhaustion can lead to a denial-of-service. Apart from disrupting the availability of a resource, devices which are configured to \"fail open\" can be tricked by exhausting it's resources. Some switches fall back to forwarding all traffic to all ports when the ARP table becomes flooded, as an example.</p> <p>Most of the time, a single resource which gets exhausted will be extractable from collected measurement data. This is what we call a bottleneck: a single point within the system narrows throughput and slows down everything below. It is important to have a clear understanding of the bigger picture here. Simply resolving a specific bottleneck will only shift the problem, if you increase the capacity of one component another component will become the limiting factor as soon as it hits it's capacity limit.</p> <p>Therefore it is important to identify as many bottlenecks as possible right away during analysis.</p>"},{"location":"lpic2.201.0/","title":"Linux Kernel (201)","text":"<p>This topic has a total weight of 9 points and contains the following three objectives:</p>"},{"location":"lpic2.201.0/#objective-2011-kernel-components-weight-2","title":"Objective 201.1: Kernel Components (weight: 2)","text":"<ul> <li>Candidates should be able to utilize kernel components that are     necessary to specific hardware, hardware drivers, system resources     and requirements. This objective includes implementing different     types of kernel images, understanding stable and longterm kernels     and patches, as well as using kernel modules.</li> </ul>"},{"location":"lpic2.201.0/#objective-2012-compiling-a-linux-kernel-weight-3","title":"Objective 201.2: Compiling a Linux kernel (weight: 3)","text":"<ul> <li>Candidates should be able to properly configure a kernel to include     or disable specific features of the Linux kernel as necessary. This     objective includes compiling and recompiling the Linux kernel as     needed, updating and noting changes in a new kernel, creating an     <code>initrd</code> image and installing new kernels.</li> </ul>"},{"location":"lpic2.201.0/#objective-2013-kernel-runtime-management-and-troubleshooting-weight-4","title":"Objective 201.3: Kernel runtime management and troubleshooting (weight: 4)","text":"<ul> <li>Candidates should be able to manage and/or query a 2.6.x, 3.x or 4.x     kernel and its loadable modules. Candidates should be able to     identify and correct common boot and run time issues. Candidates     should understand device detection and management using udev. This     objective includes troubleshooting udev rules.</li> </ul>"},{"location":"lpic2.201.1/","title":"Kernel Components (201.1)","text":""},{"location":"lpic2.201.1/#kernel-components-2011","title":"Kernel Components (201.1)","text":"<p>Candidates should be able to utilise kernel components that are necessary to specific hardware, hardware drivers, system resources and requirements. This objective includes implementing different types of kernel images, identifying stable and development kernels and patches, as well as using kernel modules.</p>"},{"location":"lpic2.201.1/#key-knowledge-areas","title":"Key knowledge Areas:","text":"<ul> <li> <p>Kernel 2.6.x documentation</p> </li> <li> <p>Kernel 3.x documentation</p> </li> <li> <p>Kernel 4.x documentation</p> </li> </ul>"},{"location":"lpic2.201.1/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/usr/src/linux</code></p> </li> <li> <p><code>/usr/src/linux/Documentation</code></p> </li> <li> <p><code>zImage</code></p> </li> <li> <p><code>bzImage</code></p> </li> <li> <p><code>xz compression</code></p> </li> </ul>"},{"location":"lpic2.201.1/#different-types-of-kernel-images","title":"Different types of kernel images","text":"<p>The Linux kernel was originally designed to be a monolithic kernel. Monolithic kernels contain all drivers for all the various types of supported hardware, regardless if your system uses that hardware. As the list of supported hardware grew the amount of code that was never used on any given system grew too. Therefore a system was introduced that allowed the kernel to load some hardware drivers dynamically. These loadable device drivers were named \"kernel modules\".</p> <p>Though the Linux kernel can load and unload modules it does not qualify as a microkernel. Microkernels are designed such that only the least possible amount of code is run in supervisor mode - this was never a design goal for Linux kernels. The Linux kernel is best described as a hybrid kernel: it is capable of loading and unloading code as microkernels do, but runs almost exclusively in supervisor mode, as monolithic kernels do.</p> <p>It is still possible to build the Linux kernel as a monolithic kernel. But it is rarely done, as updating device drivers requires a complete recompile of the kernel. However, building a monolithic kernel has its advantages too: it may have a smaller footprint as you can download and build just the parts you need and dependencies are clearer.</p> <p>When stored on disk most kernel images are compressed to save space. There are two types of compressed kernel types: <code>zImage</code> and <code>bzImage</code>.</p> <p><code>zImage</code> and <code>bzImage</code> files have different layouts and loading algorithms. The maximum allowed kernel size for a <code>zImage</code> is 512Kb, where a <code>bzImage</code> does not pose this limit. As a result the <code>bzImage</code> kernel is the preferred image type for larger kernels. <code>zImage</code> will be loaded in low memory and <code>bzImage</code> can also be loaded in high memory if needed.</p> <p>Note Both <code>zImage</code> and <code>bzImage</code> use gzip compression. The \"bz\" in <code>bzImage</code> refers to \"big zImage\" - not to the \"bzip\" compression algorithm.</p>"},{"location":"lpic2.201.1/#overview-of-numbering-schemes-for-kernels-and-patches","title":"Overview of numbering schemes for kernels and patches","text":"<p>The numbering schemes in use for Linux kernels has changed several times over the years: the original scheme, valid for all kernels up to version 2.6.0, the scheme for kernels version 2.6.0 up to 3.0, the previous scheme, for kernels 3.0 and later, and the current scheme starting with version 4.0. In the next sections we discuss each of them.</p>"},{"location":"lpic2.201.1/#scheme-up-to-260-kernels","title":"Scheme up to 2.6.0 kernels","text":"<p>Initially, a kernel version number consisted of three parts: major release number, minor release number and the patch level, all separated by periods.</p> <p>The major release was incremented when a major change was made to the kernel.</p> <p>The minor release was incremented when significant changes and additions were made. Even-numbered minor releases, e.g. 2.2, 2.4, were considered stable releases and odd-numbered releases, e.g. 2.1, 2.3, 2.5 were considered to be development releases. They were primarily used by kernel developers and people that preferred bleeding edge functionality at the risk of instability.</p> <p>The last part of the kernel version number indicated the patch level. As errors in the code were corrected (and/or features were added) the patch level was incremented. A kernel should only be upgraded to a higher patch level when the current kernel has a functional or security problem.</p>"},{"location":"lpic2.201.1/#kernel-versioning-since-kernel-version-260-and-up-to-30","title":"Kernel Versioning since kernel version 2.6.0 and up to 3.0","text":"<p>In 2004, after the release of 2.6.0, the versioning system was changed, and it was decided that a time-based release cycle would be adopted. For the next seven years the kernel remained at 2.6 and the third number was increased with each new release (which happend every two or three months). A fourth number was added to account for bug and security fixes. An example of this scheme is kernel <code>2.6.32.71</code>. The even-odd numbering system was no longer used.</p>"},{"location":"lpic2.201.1/#kernel-versioning-from-version-30-to-40","title":"Kernel Versioning from version 3.0 to 4.0","text":"<p>On 29 May 2011, Linus Torvalds announced the release of kernel version 3.0.0 in honour of the 20<sup>th</sup> anniversary of Linux. This changed the numbering scheme yet again. It would still be a time-based release system but the second number would indicate the release number, and the third number would be the patch number. For test releases the -rc designation is used. Following this scheme, <code>3.2.84</code> would refer to a stable kernel release. <code>3.2-rc4</code> on the other hand would point to the fourth release candidate of the <code>3.2</code> kernel.</p>"},{"location":"lpic2.201.1/#kernel-versioning-from-40","title":"Kernel Versioning from 4.0","text":"<p>In April 2015 kernel version 4.0.0 was released. The versioning system didn't change this time. At the time of this writing, kernel version <code>6.4.2</code> is the latest stable version available through https://kernel.org. The 4.x kernel did however introduce a couple of new features. The possibility to perform \"Live Patching\" being one of the more noteworthy ones. Live patching offers the possibility to install kernel patches without the need to reboot the system. This can be accomplished by unloading and loading appropriate kernel modules. Every time a new Linux kernel version gets released, it is accompanied by a <code>changelog</code>. These changelog files hold detailed information about what has changed in this release compared to previous versions.</p>"},{"location":"lpic2.201.1/#xz-compression","title":"XZ Compression","text":"<p>Every Linux distribution comes with a kernel that has been configured and compiled by the distribution developers. Most Linux distributions also offer possibilities to upgrade the kernel binary through some sort of package system. It is however also possible to compile a kernel for your system using kernel sources from the previously mentioned website kernel.org. These kernel sources are packed using tar and compressed using the XZ compression method. XZ is the successor to LZMA and LZMA2. Recent Linux kernels offer built-in support for XZ. Depending on the Linux distribution in use, it might be necessary to install a <code>xz-utils</code> or equivalent package to uncompress xz compressed files. After having downloaded the kernel sources for one of the available kernels as a <code>tar.xz</code> archive, these source files may be unpacked using the following command line:</p> <pre><code>    $ tar xvf linux-4.10-rc3.tar.xz\n</code></pre> <p>Note GNU <code>tar</code> needs to be at least version 1.22 for the above command to work.</p>"},{"location":"lpic2.201.1/#what-are-kernel-modules","title":"What are kernel modules","text":"<p>Linux kernel modules are object files (<code>.ko</code> files) produced by the C compiler but not linked into a complete executable. Kernel modules can be loaded into the kernel to add functionality when needed. Most modules are distributed with the kernel and compiled along with it. Every kernel version has its own set of modules.</p> <p>Modules are stored in a directory hierarchy under <code>/lib/modules/</code>kernel-version, where kernel-version is the string reported by <code>uname -r</code> or found in <code>/proc/sys/kernel/osrelease</code>, such as 2.6.5-15smp. Multiple module hierarchies are available under <code>/lib/modules</code> in case multiple kernels are installed.</p> <p>Subdirectories that contain modules of a particular type exist under the <code>/lib/modules/</code> kernel-version directory. This grouping is convenient for administrators, but also enables important functionality within the <code>modprobe</code> command.</p>"},{"location":"lpic2.201.1/#typical-module-types","title":"Typical module types","text":"<ul> <li> <p>block</p> <ul> <li>Modules for a few block-specific devices such as RAID controllers or IDE tape drives.</li> </ul> </li> <li> <p>cdrom</p> <ul> <li>Device driver modules for nonstandard CD-ROM drives.</li> </ul> </li> <li> <p>fs</p> <ul> <li>Drivers for filesystems such as MS-DOS (the msdos.ko module).</li> </ul> </li> <li> <p>ipv4</p> <ul> <li>Includes modular kernel features having to do with IP processing, such as IP masquerading.</li> </ul> </li> <li> <p>misc</p> <ul> <li>Anything that does not fit into one of the other subdirectories ends up here. Note that no modules are stored at the top of this tree.</li> </ul> </li> <li> <p>net</p> <ul> <li>Network interface driver modules.</li> </ul> </li> <li> <p>scsi</p> <ul> <li>Contains driver modules for the SCSI controller.</li> </ul> </li> <li> <p>video</p> <ul> <li>Special driver modules for video adapters.</li> </ul> </li> </ul> <p>Module directories are also referred to as tags within the context of module manipulation commands.</p>"},{"location":"lpic2.201.2/","title":"Compiling a Linux kernel (201.2)","text":""},{"location":"lpic2.201.2/#compiling-a-linux-kernel-2012","title":"Compiling a Linux kernel (201.2)","text":"<p>Candidates should be able to properly configure a kernel to include or disable specific features of the Linux kernel as necessary. This objective includes compiling and recompiling the Linux kernel as needed, updating and noting changes in a new kernel, creating an <code>initrd</code> image and installing new kernels.</p>"},{"location":"lpic2.201.2/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p><code>/usr/src/linux/</code></p> </li> <li> <p>Kernel Makefiles</p> </li> <li> <p>Kernel 2.6.x, 3.x and 4.x make targets</p> </li> <li> <p>Customize the current kernel configuration</p> </li> <li> <p>Build a new kernel and appropriate kernel modules</p> </li> <li> <p>Install a new kernel and any modules</p> </li> <li> <p>Ensure that the boot manager can locate the new kernel and     associated files</p> </li> <li> <p>Module configuration files</p> </li> <li> <p>Use DKMS to compile kernel modules</p> </li> <li> <p>Awareness of <code>dracut</code></p> </li> </ul>"},{"location":"lpic2.201.2/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>mkinitrd</code></p> </li> <li> <p><code>mkinitramfs</code></p> </li> <li> <p><code>make</code></p> </li> <li> <p><code>make</code> targets (all, config, xconfig, menuconfig, gconfig,     oldconfig, mrproper, zImage, bzImage, modules, modules_install,     rpm-pkg, binrpm-pkg, deb-pkg)</p> </li> <li> <p><code>gzip</code></p> </li> <li> <p><code>bzip2</code></p> </li> <li> <p>module tools</p> </li> <li> <p><code>/usr/src/linux/.config</code></p> </li> <li> <p><code>/lib/modules/kernel-version/</code></p> </li> <li> <p><code>depmod</code></p> </li> </ul>"},{"location":"lpic2.201.2/#getting-the-kernel-sources","title":"Getting the kernel sources","text":"<p>Kernel sources for almost all kernel versions can be found at The Linux Kernel Archives.</p> <p>The filenames in the Linux Kernel Archive mimic the version numbering conventions for the kernel. For example: The filename format for kernel version 3.0 and 4.0 is <code>linux-</code>kernel-version<code>.tar.xz</code> Thus, <code>linux-3.18.43.tar.xz</code> is the kernel archive for version \"3.18.43\".</p> <p>The used version numbering convention for the 3.0 and 4.0 kernel is <code>linux-</code>A.B.C<code>.tar.xz</code> where:</p> <ul> <li> <p>A denotes the kernel version. It is only changed when major changes     in code and concept take place.</p> </li> <li> <p>B denotes the revision.</p> </li> <li> <p>C is the patch number</p> </li> </ul> <p>See the paragraph on Kernel Versioning to learn more about the various conventions that are and have been in use.</p> <p>A common location to store and unpack kernel sources is <code>/usr/src</code>. You can use another location as long as you create a symbolic link from your new source directory to <code>/usr/src/linux</code></p> <p>The source code for the kernel is available as a compressed tar archive in <code>xz</code> (<code>.xz</code> extention) format. Decompress the archive with <code>unxz</code>. The resulting <code>tar</code> archive can be unpacked with the <code>tar</code> utility, for example:</p> <pre><code>    # unxz linux-3.18.43.tar.xz\n    # tar xvf linux-3.18.43.tar\n</code></pre> <p>You can also uncompress and untar in one step <code>tar</code> using the <code>J</code>option:</p> <pre><code>    # tar Jxvf linux-3.18.43.tar.xz\n</code></pre> <p>Refer to the man-pages on <code>tar</code> and, <code>xz</code> for more information.</p>"},{"location":"lpic2.201.2/#cleaning-the-kernel","title":"Cleaning the kernel","text":"<p>To make sure you start with a clean state you should \"clean\" the kernel first. When you compile a kernel into objects, the <code>make</code> utility keeps track of things and will not recompile any code it thinks has been correctly compiled before. In some cases, however, this may cause problems, especially when you change the kernel configuration. It is therefore customary to \"clean\" the source directory if you reconfigure the kernel.</p> <p>Cleaning can be done on three levels:</p> <p><code>make clean</code></p> <ul> <li>Deletes most generated files, but leaves enough to build external     modules.</li> </ul> <p><code>make mrproper</code></p> <ul> <li>Deletes the current configuration and all generated files.</li> </ul> <p><code>make distclean</code></p> <ul> <li>Removes editor backup files, patch leftover files and the like.</li> </ul> <p>Running <code>make mrproper</code> before configuring and building a kernel is generally a good idea.</p> <p>Note Be warned that <code>make mrproper</code> deletes the main configuration file too. You may want to make a backup of it first for future reference.</p>"},{"location":"lpic2.201.2/#creating-a-config-file","title":"Creating a <code>.config</code> file","text":"<p>First you will need to configure the kernel. Configuration information is stored in the <code>.config</code> file. There are well over 500 options in that file, for example for filesystem, SCSI and networking support. Most of the options allow you to choose if you will have them compiled directly into the kernel or have them compiled as a module. Some selections imply a group of other selections. For example, when you indicate that you wish to include SCSI support, additional options become available for specific SCSI drivers and features.</p> <p>Some of the kernel support options must be compiled as a module, some can only be compiled as permanent part of the kernel and for some options you will be able to select either possibility.</p> <p>There are a number of methods to configure the kernel, but regardless which method you use, the results of your choices are always stored in the kernel configuration file <code>/usr/src/linux/.config</code>. It is a plain text file which lists all the options as shell variables.</p> <pre><code>    #\n    # Automatically generated make config: don't edit\n    # Linux kernel version: 2.6.28\n    # Sat Feb  6 18:16:23 2010\n    #\n    CONFIG_64BIT=y\n    # CONFIG_X86_32 is not set\n    CONFIG_X86_64=y\n    CONFIG_X86=y\n    CONFIG_ARCH_DEFCONFIG=\"arch/x86/configs/x86_64_defconfig\"\n    CONFIG_GENERIC_TIME=y\n    CONFIG_GENERIC_CMOS_UPDATE=y\n    CONFIG_CLOCKSOURCE_WATCHDOG=y\n    CONFIG_GENERIC_CLOCKEVENTS=y\n    CONFIG_GENERIC_CLOCKEVENTS_BROADCAST=y\n    CONFIG_LOCKDEP_SUPPORT=y\n    CONFIG_STACKTRACE_SUPPORT=y\n    CONFIG_HAVE_LATENCYTOP_SUPPORT=y\n    CONFIG_FAST_CMPXCHG_LOCAL=y\n    CONFIG_MMU=y\n    CONFIG_ZONE_DMA=y\n    CONFIG_GENERIC_ISA_DMA=y\n    CONFIG_GENERIC_IOMAP=y\n    CONFIG_GENERIC_BUG=y\n    CONFIG_GENERIC_HWEIGHT=y\n    ...\n</code></pre> <p>To start configuration, change your current working directory to the top of the source tree:</p> <pre><code>    # cd /usr/src/linux\n</code></pre> <p>As said, there are several ways to create or modify the <code>.config</code> file. It is strongly discouraged to edit this file manually. Instead you should use the <code>make</code> command with one of the four appropriate targets to configure your kernel.</p> <p>These four targets are:</p> <ul> <li> <p>config</p> </li> <li> <p>menuconfig</p> </li> <li> <p>xconfig|gconfig</p> </li> <li> <p>oldconfig</p> </li> </ul> <p>These targets will be explained below in more detail.</p>"},{"location":"lpic2.201.2/#make-config","title":"make config","text":"<p>Running <code>make config</code> is the most rudimentary approach.</p> <p>It has clear advantages and disadvantages:</p> <ul> <li> <p>It does not depend on full-screen display capabilities. You can use     it on extremely slow links, or on systems with very limited display     capabilities.</p> </li> <li> <p>You will have to work your way through all possible questions     concerning kernel options. The system will present them sequentially     and without exception. Only when you have answered all questions     will you be allowed to save the configuration file. Given that,     there are many hundreds of options to go through so this method is     tedious. Because you cannot move back and forth through the various     questions you are forced to redo everything if you make a mistake.</p> </li> </ul> <p>An example session looks like this:</p> <pre><code>    # make config\n      HOSTCC  scripts/basic/fixdep\n      HOSTCC  scripts/basic/docproc\n      HOSTCC  scripts/basic/hash\n      HOSTCC  scripts/kconfig/conf.o\n    scripts/kconfig/conf.c: In function 'conf_askvalue':\n    scripts/kconfig/conf.c:104: warning: ignoring return value of 'fgets', \\\n        declared with attribute warn_unused_result\n    scripts/kconfig/conf.c: In function 'conf_choice':\n    scripts/kconfig/conf.c:306: warning: ignoring return value of 'fgets', \\\n        declared with attribute warn_unused_result\n      HOSTCC  scripts/kconfig/kxgettext.o\n      HOSTCC  scripts/kconfig/zconf.tab.o\n    In file included from scripts/kconfig/zconf.tab.c:2486:\n    scripts/kconfig/confdata.c: In function 'conf_write':\n    scripts/kconfig/confdata.c:501: warning: ignoring return value of 'fwrite', \\\n        declared with attribute warn_unused_result\n    scripts/kconfig/confdata.c: In function 'conf_write_autoconf':\n    scripts/kconfig/confdata.c:739: warning: ignoring return value of 'fwrite', \\\n        declared with attribute warn_unused_result\n    scripts/kconfig/confdata.c:740: warning: ignoring return value of 'fwrite', \\\n        declared with attribute warn_unused_result\n    In file included from scripts/kconfig/zconf.tab.c:2487:\n    scripts/kconfig/expr.c: In function 'expr_print_file_helper':\n    scripts/kconfig/expr.c:1090: warning: ignoring return value of 'fwrite', \\\n        declared with attribute warn_unused_result\n      HOSTLD  scripts/kconfig/conf\n    scripts/kconfig/conf arch/x86/Kconfig\n    *\n    * Linux Kernel Configuration\n    *\n    *\n    * General setup\n    *\n    Prompt for development and/or incomplete code/drivers (EXPERIMENTAL) [Y/n/?]\n</code></pre>"},{"location":"lpic2.201.2/#make-menuconfig","title":"make menuconfig","text":"<p>The <code>make menuconfig</code> method is more intuitive and can be used as an alternative to <code>make config</code>. It creates a text-mode windowed environment based on the <code>ncurses</code> libraries. You can switch back and forth between options. The sections are laid out in a menu-like structure which is easy to navigate and you can save and quit whenever you want. If you prefer a darker color scheme, use <code>make nconfig</code>. The <code>make menuconfig</code> menu display.</p> <p>When done, use the arrow keys to select the Exit option at the bottom of the screen. If any changes were made you will be prompted if you would like to save the new configuration. You can also choose to save the configuration using another name and/or location in the filesystem.</p> <p>Note If you choose another name or location you need to move the <code>.config</code> file into the <code>/usr/src/linux</code> directory to compile the kernel.</p>"},{"location":"lpic2.201.2/#make-xconfig-and-make-gconfig","title":"<code>make xconfig</code> and <code>make gconfig</code>","text":"<p>The <code>make xconfig</code> command presents a GUI menu to configure the kernel. It requires a working X Window System and the QT development libraries to work. It will provide a menu which can be navigated using a mouse. Use <code>make gconfig</code> to use Gnome instead of QT. This requires the GTK+ 2.x development libraries to be available. First, we show you how the top-level <code>make xconfig</code> window looks:</p> <p></p> <p>As said, the command <code>make gconfig</code> does exactly the same, but uses GTK instead of QT:</p> <p></p>"},{"location":"lpic2.201.2/#make-oldconfig","title":"make oldconfig","text":"<p><code>make oldconfig</code> can be used to preserve options you choose during an earlier kernel build.</p> <p>Make sure the <code>.config</code> file that was the result of the earlier build is copied into <code>/usr/src/linux/</code>. When you run <code>make oldconfig</code>, the original <code>.config</code> file will be moved to <code>.config.old</code> and a new <code>.config</code> will be created. You will be prompted for answers that can not be found in the previous configuration file, for example when there are new options for the new kernel.</p> <p>Note Be sure to make a backup of <code>.config</code> before upgrading the kernel source, because the distribution might contain a default <code>.config</code> file, overwriting your old file.</p> <p>Note <code>make  xconfig</code>, <code>make                  gconfig</code> and <code>make                  menuconfig</code> will automatically use the old <code>.config</code> file (if available) to construct a new one, preserving as much options as possible while adding new options using their default values.</p>"},{"location":"lpic2.201.2/#CompileKernel","title":"Compiling the kernel","text":"<p>Use the following sequence of <code>make</code> commands to build and install the kernel and modules:</p> <ol> <li> <p><code>make clean</code></p> </li> <li> <p><code>make zImage/bzImage</code></p> </li> <li> <p><code>make modules</code></p> </li> <li> <p><code>make modules_install</code></p> </li> </ol>"},{"location":"lpic2.201.2/#make-clean","title":"make clean","text":"<p>The \"clean\" argument removes old output files that may exist from previous kernel builds. These include core files, system map files and others.</p>"},{"location":"lpic2.201.2/#make-zimagebzimage","title":"make zImage/bzImage","text":"<p>The <code>zImage</code> and <code>bzImage</code> arguments both effectively build the kernel. The difference between these two is explained in Different types of kernel images.</p> <p>After the compile process the kernel image can be found in the <code>/usr/src/linux/arch/i386/boot</code> directory (on i386 systems).</p>"},{"location":"lpic2.201.2/#make-modules","title":"make modules","text":"<p>The <code>modules</code> argument builds the modules; the device drivers and other items that were configured as modules.</p>"},{"location":"lpic2.201.2/#make-modules_install","title":"make modules_install","text":"<p>The <code>modules_install</code> argument installs the modules you just compiled under <code>/lib/modules/</code>kernel-version. The kernel-version directory will be created if nonexistent.</p>"},{"location":"lpic2.201.2/#installing-the-new-kernel","title":"Installing the new kernel","text":"<p>When the new kernel has been compiled the system can be configured to boot it.</p> <p>First you need to put a copy of the new <code>bzImage</code> in the boot directory (which should reside on its own boot partition). For clarity the name of the kernel file should contain the kernel-version number, for example: <code>vmlinuz-2.6.31</code>:</p> <pre><code>    # cp /usr/src/linux/arch/x86_64/boot/bzImage\n    /boot/vmlinuz-2.6.31\n</code></pre> <p>This also ensures that you can have more than one kernel version in the <code>/boot</code> directory, for example if you need to boot an older kernel due to problems with the new one.</p> <p>After moving the kernel file to the correct location, you will need to configure the bootmanager (GRUB) so it will be able to boot the new kernel.</p> <p>For more specific information on GRUB, please refer to grub.</p>"},{"location":"lpic2.201.2/#the-initial-ram-disk-initrd","title":"The initial ram disk (<code>initrd</code>)","text":"<p>Say your bootdisk has the bootloader, kernel and proper modules on it. Given the advantages of kernel modules you decided to use them. But if you also want to use them for the boot device drivers, you face a problem. GRUB will load the kernel, then execute it. The kernel will try to access the disk to obtain the modules. However, as it has not loaded the proper module yet, it can't access that disk and hangs.</p> <p>A perfectly good solution would be to build a kernel with the required disk-driver hardcoded into it. But if you have a larger number of differing systems to maintain, you either need a personalised configuration and kernel for each type of system or have to live with a bloated kernel. To circumvent all of these problems, the kernel developers came up with a solution: the <code>initrd</code> RAM disk.</p> <p>A RAM disk is a chunk of memory that the kernel sees as if it were a disk. It can be mounted like any other disk. The kernel supports RAM disks by default. GRUB and LILO can handle RAM disks too. You can instruct them to load the RAM disk from a file and when the kernel boots it has the RAM disk readily available. Such RAM disks are often used to hold scripts and modules to aid the boot process.</p> <p>By convention the name of the image that holds the initial RAM disk is <code>initrd</code>. The name is short for \"initial ram disk\".</p> <p>The bootloader loads the <code>initrd</code>, it is mounted by the kernel as its root filesystem. Once mounted as the root filesystem, programs can be run from it and kernel modules loaded from it. After this step a new root filesystem can be mounted from a different device. The previous root (from <code>initrd</code>) is then either moved to the directory <code>/initrd</code> or it is unmounted.</p> <p>There are a number of ways to create your own <code>initrd</code> file. A very convenient method, mainly used by Red Hat (based) distributions is by using the <code>mkinitrd</code> script. It is a shell script which you might want to inspect to see how it works. On Debian-based distributions a utility named mkinitramfs <code>mkinitramfs</code> can be used for the same purpose. You can also opt to build the file by hand, see the chapter below.</p>"},{"location":"lpic2.201.2/#manual-initrd-creation","title":"Manual <code>initrd</code> creation","text":"<p><code>initrd</code> files are compressed archives that contain the files of a minimal root filesystem. This root filesystem normally contains modules, scripts and some additional binaries required to allow the kernel to properly continue its boot.</p> <p>As said, the <code>mkinitrd</code> script offers a convenient way to build the <code>initrd</code> file, however not all distributions provide it. If you want (or must) build one by hand the steps are: create a root filesystem, populate it with modules and files, create a <code>tar</code> or <code>cpio</code> archive from it and lastly <code>gzip</code> it.</p> <p>What type of archive to use depends on the distribution and kernel version. Older kernels employ <code>tar</code>, newer use <code>cpio</code>. If you are unsure and have a <code>initrd</code> at hand that came with your distribution, you may use a command sequence like the one below to check:</p> <pre><code>    $ sudo zcat /boot/initrd-2.6.18-348.6.1.el5.img |file -\n    /dev/stdin: ASCII cpio archive (SVR4 with no CRC)\n</code></pre> <p>The example above shows the output of a CentOS 5 distribution that uses <code>cpio</code> as its archiving tool.</p> <p>To be able to work with the <code>initrd</code> images, the kernel has to be compiled with support for the RAM disk and configured such that it will use it. Whatever you put on the initial RAM disk, it should be compatible with the kernel and architecture you will use. For example, your boot kernel should be able to recognize the filesystem type used in the image and the modules you include should match the boot kernel version.</p> <p>The next step is to actually create the RAM disk image. First create a filesystem on a block device and then copy the files to that filesystem as needed. Suitable block devices to be used for this purpose are:</p> <ol> <li> <p>A RAM disk (fast, allocates physical memory)</p> </li> <li> <p>A loopback device (slightly slower, allocates disk space)</p> </li> </ol> <p>In the rest of this example we will use the RAM disk method, so we will need to make sure a RAM disk device node is present (there may be more than one):</p> <pre><code>    # ls -la /dev/ram0\n    brw-rw---- 1 root disk 1,  0 Feb 13 00:18 /dev/ram0\n</code></pre> <p>Note The number of RAM disks that is available by default on a system is an option in the kernel configuration: CONFIG_BLK_DEV_RAM_COUNT.</p> <p>Next an empty filesystem needs to be created of the appropriate size:</p> <pre><code>    # mke2fs -m0 /dev/ram0 300\n</code></pre> <p>Note If space is critical, you may wish to use a filesystem which is more efficient with space, such as the Minix FS. Remember that the boot-kernel will need built-in support for whatever filesystem you choose.</p> <p>After having created the filesystem, you need to mount it on the appropriate directory:</p> <pre><code>    # mount -t ext2 /dev/ram0 /mnt\n</code></pre> <p>Now the stub for the console device needs to be created. This will be the device node that will be used when the <code>initrd</code> is active.</p> <pre><code>    # mkdir /mnt/dev\n    # mknod /mnt/dev/tty1 c 4 1\n</code></pre> <p>Next, copy all files you think are necessary to the image; modules, scripts, binaries, it does not matter. One of the most important files to copy over is <code>/linuxrc</code>. Whenever the kernel is set up to use a <code>initrd</code> image it will search for a file <code>/linuxrc</code> and execute it. It can be a script or a compiled binary. Hence, what will happen after mounting your image file is totally under your control. In this example we will make <code>/linuxrc</code> a link to <code>/bin/sh</code>. Make sure <code>/linuxrc</code> is given execute permissions.</p> <pre><code>    # ln -s /bin/sh /mnt/linuxrc\n</code></pre> <p>After you have completed copying the files and have made sure that the <code>/linuxrc</code> has the correct attributes, you can unmount the RAM disk image:</p> <pre><code>    # umount /dev/ram0\n</code></pre> <p>The RAM disk image can then be copied to a file:</p> <pre><code>    # dd if=/dev/ram0 bs=1k count=300 of=/boot/initrd\n</code></pre> <p>Finally, if you have no more use for the RAM disk and you wish to reclaim the memory, deallocate the RAM disk:</p> <pre><code>    # freeramdisk /dev/ram0\n</code></pre> <p>To test the newly created <code>initrd</code>, add a new section to your GRUB menufile, which refers to the <code>initrd</code> image you've just created:</p> <pre><code>    title=initrd test entry\n    root (hd0,0)\n    kernel /vmlinuz-2.6.28\n    initrd /initrd\n</code></pre> <p>If you have followed the steps above and have rebooted using this test entry from the bootloader menu, the system will continue to boot. After a few seconds you should find yourself at a command prompt, since <code>/linuxrc</code> refers to <code>/bin/sh</code>, a shell.</p> <p>Of course, real <code>initrd</code> files will contain a more complex <code>/linuxrc</code> boot file, that loads modules, mounts the real root filesystem etc.</p>"},{"location":"lpic2.201.2/#kernelpatching","title":"Patching a Kernel","text":"<p>Note This section offers information on a subject that is no longer part of the LPIC-2 objectives. It is maintained because it still contains valid and valuable information.</p> <p>In older versions of the LPIC-2 objectives candidates were assumed to be able to properly patch the source code of a kernel to add support for new hardware. The objectives included being able to remove kernel patches from patched kernels.</p> <p>Key files, terms and utilities include:</p> <ul> <li> <p>Kernel Makefiles</p> </li> <li> <p><code>patch</code></p> </li> <li> <p><code>xz</code></p> </li> </ul> <p>A patch file contains a list of differences between two versions of a file. The standard command <code>diff</code> is capable of producing such lists. The command <code>patch</code> can be used to apply the contents of a patch file to update the file from the old version to a newer version.</p> <p>Patching the kernel is very straightforward:</p> <ol> <li> <p>Place patch file in the <code>/usr/src</code> directory.</p> </li> <li> <p>Change directory to <code>/usr/src</code>.</p> </li> <li> <p>Uncompress the patch file using <code>unxz</code></p> </li> <li> <p>Use the <code>patch</code> utility to apply the patch file to the kernel     source:</p> <pre><code>    # patch -p1 &lt;patchfile\n</code></pre> </li> <li> <p>Check for failures.</p> </li> <li> <p>Build the kernel.</p> </li> </ol> <p>If the <code>patch</code> utility is unable to apply a part of a patch, it puts that part in a reject file. The name of a reject file is the name of the output file plus a <code>.rej</code> suffix, or a <code>#</code> if the addition of <code>.rej</code> would generate a filename that is too long. In case even the addition of a mere <code>#</code> would result in a filename that is too long, the last character of the filename is replaced with a <code>#</code>.</p> <p>The common options for the <code>patch</code> utility: patch</p> <p>-p<code>number</code>; <code>--strip=number</code></p> <ul> <li>Strip the smallest prefix containing <code>number</code>     leading slashes from each file name found in the patch file. A     sequence of one or more adjacent slashes is counted as a single     slash. This controls how file names found in the patch file are     treated, in case you keep your files in a different directory than     the person who sent out the patch. For example, supposing the file     name in the patch file was <code>/u/howard/src/blurfl/blurfl.c</code>, then     using <code>-p0</code> gives the entire file name unmodified, while using <code>-p1</code>     gives <code>u/howard/src/blurfl/blurfl.c</code>.</li> </ul> <p><code>-s</code>; <code>--silent</code>; <code>--quiet</code></p> <ul> <li>Work silently (suppress output), unless an error occurs.</li> </ul> <p><code>-E</code>; <code>--remove-empty-files</code></p> <ul> <li>Remove output files that are empty after the patches have been     applied. Normally this option is unnecessary, since patch     can examine the time stamps on the header to determine     whether a file should exist after patching. However, if     the input is not a context diff or if patch conforms to the POSIX     specification, patch does not remove empty patched files unless this     option is given. When patch removes a file, it also attempts to     remove any empty ancestor directories.</li> </ul> <p><code>-R</code>; <code>--reverse</code></p> <ul> <li> <p>Assume that this patch was created with the old and new     files reversed, so that you are basically applying the     patch to the file which already contains the modifications in the     patch file. The <code>patch</code> will attempt to swap each hunk around before     applying it and rejects will come out in the swapped format. The     <code>-R</code> option does not work with <code>ed</code> diff scripts because there is     too little information to reconstruct the reverse operation. If the     first hunk of a <code>patch</code> fails, <code>patch</code> reverses the hunk to see if     it can be applied that way. If it can, you are asked if you want to     have the <code>-R</code> option set. If it can't, the patch continues to be     applied normally.</p> <p>Note This method cannot detect a reversed patch if it is a normal diff and if the first command is an append (i.e. it should have been a delete) since appends always succeed. This is due to the fact that a null context matches anywhere. Luckily, most patches add or change lines rather than delete them, so most reversed normal diffs begin with a delete, which fails, triggering the heuristic.</p> </li> </ul> <p>For more information consult the man-pages of the <code>diff</code> command and the <code>patch</code> command.</p>"},{"location":"lpic2.201.2/#removing-a-kernel-patch-from-a-production-kernel","title":"Removing a kernel patch from a production kernel","text":"<p>A kernel patch can be removed from a production kernel by removing it from the production kernel source tree and compiling a new kernel. In the previous topic we've learned that to remove a patch from a file, you either need to apply it again, or run <code>patch</code> with the <code>-R</code> parameter:</p> <pre><code>    # patch -p1&lt;patch-2.6.28\n    patching file linux/Documentation/Configure.help\n    Reversed (or previously applied) patch detected! Assume -R? [n] y\n</code></pre>"},{"location":"lpic2.201.2/#dkms","title":"DKMS","text":"<p>DKMS (Dynamic Kernel Module Support) was developed by Dell in 2003. DKMS was created as a solution to combat software problems caused by the dependencies between kernels and kernel modules. As a vendor of computer systems running (amongst others) Linux operating systems, Dell offered software support to customers. When customers would upgrade the Linux kernel, the kernel modules had to be upgraded as well. And whenever Dell released newer versions of kernel modules for hardware support, these modules had to match the Linux kernel in use.</p> <p>DKMS is a framework, capable of automatically compiling and/or installing kernel modules for every kernel version available on the system. DKMS achieves this functionality by seperating the kernel module files or sources from the actual kernel source tree. This way, both the kernel and kernel modules may be upgraded independent of each other. Major Linux distributions offer the DKMS framework through their package system. When the kernel is upgraded by the package manager software on a system running DKMS, a hook will take care of deciding whether any kernel modules need to be compiled and/or installed for the new kernel. The other way around, new kernel modules can be compiled and/or installed by DKMS without requirements towards the kernel version.</p> <p>DKMS does have a few requirements in order to function properly. The software dependencies are dependant on the Linux distribution in use. But one requirement that is uniform across all distributions is the necessity for kernel header files. The headers for the running kernel version can be installed using the following package manager commands:</p> <p>On Red Hat based Linux distributions:</p> <pre><code>    $  yum install kernel-devel\n</code></pre> <p>On Debian-based Linux distributions:</p> <pre><code>    $ apt-get install linux-headers-$(uname -r)\n</code></pre> <p>Due to the adoption of DKMS amongst major Linux distributions, many kernel modules available through package managers are (also) available as DKMS-modules. On Debian-based Linux systems, these DKMS kernel modules can be identified by their naming convention. The package names for these files end in <code>-dkms</code>. For example: <code>oss4-dkms</code>. After installation of these packages, the kernel module source files are placed within a corresponding <code>/usr/src/module-version</code> directory together with a <code>dkms.conf</code> configuration file. Whenever a kernel or kernel module change triggers the DKMS system, the directory specified by the <code>source_tree</code> variable from <code>/etc/dkms/framework.conf</code> will be checked for the existence of subdirectories containing <code>dkms.conf</code> files. The contents of these <code>dkms.conf</code> files then determine what happens next. The following example comes from a Debian-based Linux system and should clarify this explanation:</p> <pre><code>    $ sudo apt-get install flashcache-dkms\n    $ ls /usr/src/\n    flashcache-3.1.1+git20140801  linux-headers-3.16.0-4-amd64  linux-headers-3.16.0-4-common  linux-kbuild-3.16 \n    $ ls /usr/src/flashcache-3.1.1+git20140801/\n    dkms.conf          flashcache.h        flashcache_ioctl.h  flashcache_procfs.c   flashcache_subr.c\n    flashcache_conf.c  flashcache_ioctl.c  flashcache_main.c   flashcache_reclaim.c  Makefile\n    $ cat /usr/src/flashcache-3.1.1+git20140801/dkms.conf \n    BUILT_MODULE_NAME=\"flashcache\"\n    DEST_MODULE_LOCATION=\"/kernel/drivers/block\"\n    PACKAGE_NAME=\"flashcache\"\n    PACKAGE_VERSION=\"3.1.1+git20140801\"\n    AUTOINSTALL=\"yes\"\n    REMAKE_INITRD=\"yes\"\n    MAKE=\"COMMIT_REV=3.1.1+git20140801 KERNEL_TREE=$kernel_source_dir make modules\"\n</code></pre> <p><code>BUILT_MODULE_NAME</code> determines the name of the compiled module. This directive is mandatory if the DKMS-module package contains more than one module. <code>DEST_MODULE_LOCATION</code> determines the location for the compiled module. The value for this directive should always start with \"/kernel\" which in turn redirects to <code>/lib/modules/kernelversion/kernel</code>. This value is mandatory except for the following Linux distributions which use a distribution specific directory: Fedora Core 6 and higher, RHEL 5 and higher, Novell SuSE Linux ES 10 and higher and Ubuntu. <code>PACKAGE_NAME</code> determines the name associated with the entire package of modules. This directive is mandatory. <code>PACKAGE_VERSION</code> determines the version associated with the entire package of modules and is mandatory. <code>AUTOINSTALL</code> is a boolean value that determines whether or not the <code>dkms_autoinstaller</code> service will try to install this module for every kernel the system boots in to. <code>REMAKE_INITRD</code> determines whether the <code>initrd</code> image should be generated again after this module is installed. The value of this directive defaults to \"no\". When configuring a value, know that all characters after the first character are discared. The first character is only interpreted if it is a \"y\" or \"Y\". <code>MAKE</code> is one of many directives that stores its value in to an array. The <code>MAKE</code> value determines the build options. When not defined, DKMS will try to build the module using a generic <code>MAKE</code> command.</p> <p>On Debian-based Linux distributions, the directory <code>/usr/share/doc/dkms/examples</code> holds example configuration files. On Red Hat based Linux systems, example files can be found within the <code>/usr/share/doc/dkms</code> directory.</p> <p>After a module is built by DKMS, it is part of an extensible framework. DKMS provides several commands to issue on the module. Covering all these commands reaches beyond the scope of this book. But apart from <code>man dkms</code> the <code>dkms</code> command should be familiar. The <code>dkms</code> command makes it possible to <code>add</code> or <code>remove</code> modules to or from the source tree. Once part of the source tree, modules may be <code>build</code>. After building, a module may be installed onto the kernel it was build for using the <code>install</code> option. <code>uninstall</code> reverts this process. The <code>status</code> option prints information about added modules to standard output.</p> <p>The example above uses a module from the package manager. DKMS is also capable of accepting archive formats containing binary modules, module sources or both. When adding modules to DKMS this way it is important that the archive also contains a valid <code>dkms.conf</code> file. Using the <code>dkms mktarball</code> command, such an archive can be created based on modules extracted from the current system. This tarball archive can then be imported to the source tree using the <code>dkms ldtarball</code> command.</p>"},{"location":"lpic2.201.2/#dracut","title":"Dracut","text":"<p>Just like DKMS may be configured to behave as an event-driven tool, <code>dracut</code> can behave in a similar way. Instead of compiling kernel modules, <code>dracut</code> can take care of generating a new <code>initramfs</code> image whenever there seems a need to do so.</p>"},{"location":"lpic2.201.3/","title":"Kernel runtime management and troubleshooting (201.3)","text":"<p>Candidates should be able to manage and/or query a 2.6.x, 3.x or 4.x kernel and its loadable modules. Candidates should be able to identify and correct common boot and run time issues. Candidates should understand device detection and management using udev. This objective includes troubleshooting udev rules.</p>"},{"location":"lpic2.201.3/#key-knowledge-areas","title":"Key Knowledge Areas:","text":"<ul> <li> <p>Use command-line utilities to get information about the currently     running kernel and kernel modules.</p> </li> <li> <p>Manually load and unload kernel modules.</p> </li> <li> <p>Determine when modules can be unloaded.</p> </li> <li> <p>Determine what parameters a module accepts.</p> </li> <li> <p>Configure the system to load modules by names other than their file     name.</p> </li> <li> <p>/proc filesystem</p> </li> <li> <p>Content of /, /boot , and /lib/modules</p> </li> <li> <p>Tools and utilities to analyse information about the available     hardware</p> </li> <li> <p>udev rules</p> </li> </ul> <p>The following is a partial list of used files, terms, and utilities:</p> <ul> <li> <p><code>/lib/modules/kernel-version/modules.dep</code></p> </li> <li> <p>module configuration files in <code>/etc</code></p> </li> <li> <p><code>/proc/sys/kernel/</code></p> </li> <li> <p><code>/sbin/depmod</code></p> </li> <li> <p><code>/sbin/rmmod</code></p> </li> <li> <p><code>/sbin/modinfo</code></p> </li> <li> <p><code>/bin/dmesg</code></p> </li> <li> <p><code>/sbin/lspci</code></p> </li> <li> <p><code>/usr/bin/lsdev</code></p> </li> <li> <p><code>/sbin/lsmod</code></p> </li> <li> <p><code>/sbin/modprobe</code></p> </li> <li> <p><code>/sbin/insmod</code></p> </li> <li> <p><code>/bin/uname</code></p> </li> <li> <p><code>/usr/bin/lsusb</code></p> </li> <li> <p><code>/etc/sysctl.conf</code>, <code>/etc/sysctl.d/</code></p> </li> <li> <p><code>/sbin/sysctl</code></p> </li> <li> <p>udevmonitor</p> </li> <li> <p><code>udevadm</code> monitor</p> </li> <li> <p><code>/etc/udev</code></p> </li> </ul> <p>Customise, build and install a custom kernel and kernel modules {#UsingKernelModules}</p> <p>kernel modules</p> <p>In the paragraph ??? you have learned what kernel modules are. There are various utilities and configuration files associated with these modules. This paragraph will explain how you can use these to manage a running kernel and it's modules.</p>"},{"location":"lpic2.201.3/#manipulating-modules","title":"Manipulating modules","text":"<p>For each kernel module loaded, display its name, size, use count and a list of other referring modules. This command yields the same information as is available in <code>/proc/modules</code>. On a particular laptop, for instance, the command <code>/sbin/lsmod</code> reports:</p> <pre><code>    Module      Size   Used by\n    serial_cb   1120   1\n    tulip_cb    31968  2\n    cb_enabler  2512   4 [serial_cb tulip_cb]\n    ds          6384   2 [cb_enabler]\n    i82365      22384  2\n    pcmcia_core 50080  0 [cb_enabler ds i82365]\n</code></pre> <p>The format is name, size, use count, list of referring modules. If the module controls its own unloading via a \"can_unload\" routine, then the user count displayed by lsmod is always -1, irrespective of the real use count.</p>"},{"location":"lpic2.201.3/#insmod","title":"insmod","text":"<p>Insert a module into the running kernel. The module is located automatically and inserted. You must be logged in as superuser to insert modules. It is generally recommended to use <code>modprobe</code> instead, since <code>insmod</code> only returns very general error codes and <code>modprobe</code> is more specific about errors. Also, you will need to pass the complete filename to <code>insmod</code>, whereas <code>modprobe</code> will work with just the module name.</p> <p>-s</p> <ul> <li>Write results to syslog instead of the terminal.</li> </ul> <p>-v</p> <ul> <li>Set verbose mode.</li> </ul> <p>Suppose the kernel was compiled with modular support for a specific scsi card. To verify that this specific module exists, in this case <code>sym53c8xx.ko</code> exists, look for the file <code>sym53c8xx.ko</code> in the <code>/lib/modules/kernel-version/kernel/drivers/scsi/</code> directory:</p> <pre><code>    # insmod sym53c8xx.ko\n    # echo $?\n    0\n</code></pre> <p>Modules can depend on other modules. In this example all the prerequisite modules had been loaded before, so this specific module loaded successfully. However, <code>insmod</code> does not know about prerequisites, it simply loads whatever you tell it to load. This may go wrong if there are missing prerequisites:</p> <pre><code>    # insmod snd-ens1371.ko\n    insmod: error inserting 'snd-ens1371.ko': -1 Unknown symbol in module\n    # echo $?\n    1\n</code></pre> <p>The message indicates that the module requires a function or variable that is missing from the current kernel. This is usually caused by not having the prerequisite module(s) loaded or compiled into the kernel.</p>"},{"location":"lpic2.201.3/#rmmod","title":"rmmod","text":"<p><code>device or resource busy</code></p> <p>Unless a module is in use or referred to by another module, the module is removed from the running kernel. You must be logged in as the superuser to remove modules.</p> <pre><code>    # rmmod snd_ac97_codec\n    ERROR: Module snd_ac97_codec is in use by snd_ens1371\n    # echo $?\n    1\n</code></pre> <p>In this example the module could not be unloaded because it was in use, in this case by the <code>snd_ens1371</code> module. The solution is to remove the <code>snd_ens1371</code> module first:</p> <pre><code>    # rmmod snd_ens1371\n    # rmmod snd_ac97_codec\n    # echo $?\n    0\n</code></pre> <p>Issue the command <code>lsmod</code> to verify that the modules have indeed been removed from the running kernel.</p>"},{"location":"lpic2.201.3/#modprobe","title":"modprobe","text":"<p>Like <code>insmod</code>, <code>modprobe</code> is used to insert modules. However, <code>modprobe</code> has the ability to load single modules, modules and their prerequisites, or all modules stored in a specific directory. The <code>modprobe</code> command can also remove modules when combined with the <code>-r</code> option. It also is more specific in it's error messages than <code>insmod</code>.</p> <p>Modules can be inserted with optional <code>symbol=value</code> parameters such as <code>irq=5</code> or <code>dma=3</code>. Such parameters can be specified on the command line or by specifying them in the module configuration file, which will be explained later. If the module is dependent upon other modules these will be loaded first. The <code>modprobe</code> command determines prerequisite relationships between modules by reading the file <code>modules.dep</code> at the top of the module directory hierarchy, for instance <code>/lib/modules/2.6.31/modules.dep</code>. You must be logged in as the superuser to insert modules.</p> <p>-a</p> <ul> <li>Load all modules. When used with the -t tag, \"all\" is restricted to     modules in the tag directory. This action probes hardware by     successive module-insertion attempts for a single type of hardware,     such as a network adapter. This may be necessary, for example, to     probe for more than one kind of network interface.</li> </ul> <p>-c</p> <ul> <li>Display a complete module configuration, including defaults and     directives found in <code>/etc/modules.conf</code> (or <code>/etc/conf.modules</code>,     depending on your version of module utilities.) The <code>-c</code> option is     not used with any other options.</li> </ul> <p>-l</p> <ul> <li>List modules. When used with the -t tag, list only modules in     directory tag.</li> </ul> <p>-r</p> <ul> <li>Remove module, similar to <code>rmmod</code>. Multiple modules may be     specified.</li> </ul> <p>-s</p> <ul> <li>Display results in <code>syslog</code> instead of on the terminal.</li> </ul> <p><code>-t tag</code></p> <ul> <li>Attempt to load multiple modules found in the directory <code>tag</code> until     a module succeeds or all modules in tag are exhausted. This action     probes hardware by successive module-insertion attempts for a single     type of hardware, such as a network adapter.</li> </ul> <p><code>-v</code></p> <ul> <li>Set verbose mode.</li> </ul> <p>Loading sound modules using <code>modprobe</code>.</p> <pre><code>    # modprobe snd_ens1371\n    # echo $?\n    0\n    # lsmod\n    Module                  Size  Used by\n    snd_ens1371            20704  0\n    snd_rawmidi            22448  1 snd_ens1371\n    snd_seq_device          7436  1 snd_rawmidi\n    snd_ac97_codec        112280  1 snd_ens1371\n    ac97_bus                1992  1 snd_ac97_codec\n    snd_pcm                72016  2 snd_ens1371,snd_ac97_codec\n    snd_timer              21256  1 snd_pcm\n    snd                    62392  6 snd_ens1371,snd_rawmidi,snd_seq_device,snd_ac97_codec,snd_pcm,snd_timer\n    soundcore               7952  1 snd\n    snd_page_alloc          9528  1 snd_pcm\n</code></pre> <p>All prerequisite modules for snd_ens1371 have been loaded. To remove both snd_ac97_codec and snd_ens1371 modules, use <code>modprobe -r snd_ac97_codec</code>.</p> <p>Module configuration is handled in the file <code>/etc/modules.conf</code>. If this file does not exist the <code>modprobe</code> utility will try to read the <code>/etc/conf.modules</code> instead. The latter file is the historical name and is deprecated. It should be replaced by <code>/etc/modules.conf</code>.</p> <p>Note On some systems this file is called <code>/etc/modprobe.conf</code> or there are configuration files in a directory called <code>/etc/modprobe.d</code>.</p> <p>More information on module configuration is given in the section on configuring modules.</p>"},{"location":"lpic2.201.3/#modinfo","title":"modinfo","text":"<p>Display information about a module from its <code>module-object-file</code>. Some modules contain no information at all, some have a short one-line description, others have a fairly descriptive message.</p> <p>-a, --author</p> <ul> <li>Display the module's author.</li> </ul> <p>-d, --description</p> <ul> <li>Display the module's description.</li> </ul> <p>-n, --filename</p> <ul> <li>Display the module's filename.</li> </ul> <p><code>-fformat_string</code>, <code>--format                format_string</code></p> <ul> <li>Let's the user specify an arbitrary format string which can extract     values from the ELF section in module_file which contains the     module information. Replacements consist of a percent sign followed     by a tag name in curly braces. A tag name of %{filename} is always     supported, even if the module has no modinfo section.</li> </ul> <p><code>-p</code>, <code>--parameters</code></p> <ul> <li>Display the typed parameters that a module may support.</li> </ul> <p><code>-h</code>, <code>--help</code></p> <ul> <li>Display a small usage screen.</li> </ul> <p><code>-V</code>, <code>--version</code></p> <ul> <li>Display the version of <code>modinfo</code>.</li> </ul> <p>What information can be retrieved from the snd-ens1371 module:</p> <pre><code>    # modinfo snd_ens1371\n    filename:       /lib/modules/2.6.31/kernel/sound/pci/snd-ens1371.ko\n    description:    Ensoniq/Creative AudioPCI ES1371+\n    license:        GPL\n    author:         Jaroslav Kysela &lt;perex@perex.cz&gt;, Thomas Sailer &lt;sailer@ife.ee.ethz.ch&gt;\n    alias:          pci:v00001102d00008938sv*sd*bc*sc*i*\n    alias:          pci:v00001274d00005880sv*sd*bc*sc*i*\n    alias:          pci:v00001274d00001371sv*sd*bc*sc*i*\n    depends:        snd-pcm,snd,snd-rawmidi,snd-ac97-codec\n    vermagic:       2.6.31-gentoo-r10 SMP mod_unload modversions\n    parm:           index:Index value for Ensoniq AudioPCI soundcard. (array of int)\n    parm:           id:ID string for Ensoniq AudioPCI soundcard. (array of charp)\n    parm:           enable:Enable Ensoniq AudioPCI soundcard. (array of bool)\n    parm:           spdif:S/PDIF output (-1 = none, 0 = auto, 1 = force). (array of int)\n    parm:           lineio:Line In to Rear Out (0 = auto, 1 = force). (array of int)\n</code></pre>"},{"location":"lpic2.201.3/#configuring-modules","title":"Configuring modules","text":""},{"location":"lpic2.201.3/#etcmodulesconf","title":"/etc/modules.conf","text":"<p>You may sometimes need to control assignments of the resources a module uses, such as hardware interrupts or Direct Memory Access (DMA) channels. Other situations may dictate special procedures to prepare for, or to clean up after, module insertion or removal. This type of special control of modules is configured in the file <code>/etc/modules.conf</code>.</p> <p><code>keep</code></p> <ul> <li>kernel modules keep The keep directive, when found before any path     directives, causes the default paths to be retained and added to any     paths specified.</li> </ul> <p><code>depfile=</code>full_path</p> <ul> <li>kernel modules depfile= This directive overrides the default     location for the modules dependency file, <code>modules.dep</code> which will     be described in the next section.</li> </ul> <p><code>path=</code>path</p> <ul> <li>kernel modules path= This directive specifies an additional     directory to search for modules.</li> </ul> <p><code>options</code> modulename module-specific-options</p> <ul> <li>kernel modules options Options for modules can be specified using     the options configuration line in <code>modules.conf</code> or on the     <code>modprobe</code> command line. The command line overrides configurations     in the file. modulename is the name of a single module file     without the <code>.ko</code> extension. Module-specific options are specified     as name=value pairs, where the name is understood by the module     and is reported using <code>modinfo -p</code>.</li> </ul> <p><code>alias</code> aliasname result</p> <ul> <li>kernel modules alias Aliases can be used to associate a generic name     with a specific module, for example:<pre><code>    alias /dev/ppp ppp_generic\n    alias char-major-108 ppp_generic\n    alias tty-ldisc-3 ppp_async\n    alias tty-ldisc-14 ppp_synctty\n    alias ppp-compress-21 bsd_comp\n    alias ppp-compress-24 ppp_deflate\n    alias ppp-compress-26 ppp_deflate\n</code></pre> </li> </ul> <p><code>pre-install</code> module command</p> <ul> <li>kernel modules pre-install /etc/init.d/pcmcia This directive causes     a specified shell command to be executed prior to the insertion of a     module. For example, PCMCIA services need to be started prior to     installing the <code>pcmcia_core</code> module:<pre><code>    pre-install pcmcia_core /etc/init.d/pcmcia start\n</code></pre> </li> </ul> <p><code>install</code> module command</p> <ul> <li>kernel modules install This directive allows a specific shell     command to override the default module-insertion command.</li> </ul> <p><code>post-install</code> module command</p> <ul> <li>kernel modules post-install This directive causes a specified shell     command to be executed after insertion of the module.</li> </ul> <p><code>pre-remove</code> module command</p> <ul> <li>kernel modules pre-remove This directive causes a specified shell     command to be executed prior to removal of module.</li> </ul> <p><code>remove</code> module command</p> <ul> <li>kernel modules remove This directive allows a specific shell command     to override the default module-removal command.</li> </ul> <p><code>post-remove</code> module command</p> <ul> <li>kernel modules post-remove This directive causes a specified shell     command to be executed after removal of module.</li> </ul> <p>For more detailed information concerning the module-configuration file see <code>man modules.conf</code>.</p> <p>Blank lines and lines beginning with a <code>#</code> are ignored in <code>modules.conf</code>.</p>"},{"location":"lpic2.201.3/#module-dependency-file","title":"Module Dependency File","text":"<p>The command <code>modprobe</code> can determine module dependencies and install prerequisite modules automatically. To do this, <code>modprobe</code> scans the first column of <code>/lib/modules/kernel-version/modules.dep</code> to find the module it is to install. Lines in <code>modules.dep</code> are in the following form:</p> <pre><code>    module_name.(k)o: dependency1 dependency2 ...\n</code></pre> <p>Find below an example for <code>thermal</code> and <code>processor</code> modules (which are part of the ACPI layer):</p> <pre><code>    /lib/modules/2.6.31/kernel/drivers/acpi/thermal.ko: \\\n        /lib/modules/2.6.31/kernel/drivers/thermal/thermal_sys.ko\n    /lib/modules/2.6.31/kernel/drivers/acpi/processor.ko: \\\n        /lib/modules/2.6.31/kernel/drivers/thermal/thermal_sys.ko\n</code></pre> <p>In this case both the <code>processor</code> and <code>thermal</code> module depend on the <code>thermal_sys</code> module.</p> <p>All of the modules that are available on the system should be listed in the <code>modules.dep</code> file. They are listed with full path and filenames, so including their .(k)o extension. Those that are not depending on other modules are listed without dependencies. Dependencies that are listed are inserted into the kernel by <code>modprobe</code> first, and after they have been successfully inserted, the subject module itself can be loaded.</p> <p>The <code>modules.dep</code> file must be kept current to ensure the correct operation of <code>modprobe</code>. If module dependencies were to change without a corresponding modification to <code>modules.dep</code>, then <code>modprobe</code> would fail because a dependency would be missed. As a result, <code>modules.dep</code> needs to be (re)created each time the system is booted. Most distributions will do this by executing <code>depmod -a</code> automatically when the system is booted.</p>"},{"location":"lpic2.201.3/#depmod","title":"depmod","text":"<p>The <code>depmod -a</code> procedure is also necessary after any change in module dependencies.</p> <p>The <code>/lib/modules/kernel-version/modules.dep</code> file contains a list of module dependencies. It is generated by the <code>depmod</code> command, which reads each module under <code>/lib/modules/kernel-version</code> to determine what symbols the module needs and which ones it exports. By default the list is written to the file <code>modules.dep</code>. The <code>modprobe</code> command in turn uses this file to determine the order in which modules are to be loaded into or unloaded from the kernel.</p> <p><code>kmod</code> versus <code>kerneld</code></p> <p>kmod kerneld Both <code>kmod</code> and <code>kerneld</code> provide for dynamic loading of kernel-modules. A module is loaded when the kernel first needs it. For a description on modules see ???.</p> <p><code>kerneld</code> is a daemon, <code>kmod</code> is a thread in the kernel itself. The communication with <code>kerneld</code> is done through System V IPC. <code>kmod</code> operates directly from the kernel and does not use System V IPC thereby making it an optional module.</p> <p><code>kmod</code> replaces <code>kerneld</code> as of Linux kernel 2.2.x.</p> <p><code>kerneld</code> and <code>kmod</code> both facilitate dynamic loading of kernel modules. Both use <code>modprobe</code> to manage dependencies and dynamic loading of modules.</p> <p>Manual loading of modules with <code>modprobe</code> or <code>insmod</code> is possible without the need for <code>kmod</code> or <code>kerneld</code>. In both cases, the kernel-option <code>CONFIG_MODULES</code> must be set to enable the usage of modules.</p> <p>CONFIG_KMOD CONFIG_MODULESTo enable the use of <code>kmod</code>, a kernel must be compiled with the kernel-option <code>CONFIG_KMOD</code> enabled. Because <code>kmod</code> is implemented as a kernel module the kernel-option <code>CONFIG_MODULES</code> needs to be enabled too.</p>"},{"location":"lpic2.201.3/#building-a-custom-kernel","title":"Building A Custom Kernel","text":"<p>A summary on how to configure and compile a kernel to meet custom needs follows. You start with the configuration, normally using one of the <code>make</code> targets for configuration (<code>make</code> <code>config</code>, <code>xconfig</code>, <code>menuconfig</code>, <code>gconfig</code>, <code>oldconfig</code>), see the section on creating a .config file.</p> <p>Once the kernel is configured it can be built with the command <code>make zImage/bzImage</code>. To build the modules, use <code>make modules</code> followed by <code>make modules_install</code>. To compile the kernel image and loadable modules in one step you can use the command <code>make all</code>. After configuring and compiling the kernel it can be installed with <code>make install</code>. Installing the kernel means installing the following files into the <code>/boot</code> directory:</p> <ul> <li> <p><code>System.map-2.6.x</code></p> </li> <li> <p><code>config-2.6.x</code></p> </li> <li> <p><code>vmlinuz-2.6.x</code></p> </li> </ul> <p>The <code>depmod</code> command builds a <code>modules.dep</code> file which is needed by modprobe to determine the dependencies of the (newly) built modules.</p> <p>Besides building and installing a kernel on a local machine, you can also create packages that allow you to distribute your newly built kernel to other machines. The common package formats are all available, each has its own <code>make</code> parameter:</p> <ul> <li> <p><code>make</code> <code>rpm-pkg</code>: builds both source and binary RPM packages.</p> </li> <li> <p><code>make</code> <code>binrpm-pkg</code>: builds (only) binary kernel RPM package.</p> </li> <li> <p><code>make</code> <code>deb-pkg</code>: builds the kernel package as a deb(ian) package.</p> </li> </ul>"},{"location":"lpic2.201.3/#proc-filesystem","title":"/proc filesystem","text":"<p>troubleshooting/proc The <code>/proc</code> filesystem is a pseudo-filesystem, meaning that its contents are directly presented by the kernel. It contains directories and other files that reflect the state of the running system. Some commands read the <code>/proc</code> filesystem to get information about the state of the system. You can extract statistical information, hardware information, network and host parameters and memory and performance information. The <code>/proc</code> filesystem also allows you to modify some parameters at runtime by writing values to files.</p> <p>Contents of <code>/</code>, <code>/boot</code>, and <code>/lib/modules</code></p> <p>As an example the contents of these directories on a Debian system are presented.</p> <p>Contents of /:</p> <pre><code>    debian-601a:/$ ls -a\n    .    boot  home        lib32       media  proc  selinux  tmp  .ure vmlinuz\n    ..   dev   initrd.img  lib64       mnt    root  srv      u8   usr\n    bin  etc   lib         lost+found  opt    sbin  sys      u9   var\n</code></pre> <p>The most important directories are <code>/bin</code> which contains the generic systemwide commands, <code>/var</code> which is the top level directory for data that will be constantly changing (logs etc.), <code>/srv</code> which contains data related to services the system provides (e.g. a webserver), <code>/tmp</code> to hold temporary files, <code>/mnt</code> where USB disks, tape-units and other devices that contain a filesystem can be mounted temporarily, <code>/lib</code>, <code>/lib32</code> and <code>/lib64</code> to hold modules and other libraries, <code>/boot</code> to hold files used during boot, <code>/sbin</code> under which we find special commands for the system administrator, <code>/opt</code> for third party packages, and <code>/etc</code> that contains the configuration files for your system.</p> <p>The <code>/usr</code> directory contains a shadow hierarchy that mimics parts of the contents of the root directory. Hence, you will find a <code>/usr/bin</code> directory, a <code>/usr/sbin</code> directory, a <code>/usr/lib</code> directory and a <code>/usr/etc</code> directory. The 'secondary hierarchy' was meant to allow users to override or enhance the system, for example by allowing them to put local system administrator commands in <code>/usr/sbin</code>, and local system configuration data in <code>/usr/etc</code>. A special case are <code>/usr/local</code> and its subdirectories, which contain yet another shadow hierarchy that mimics parts of the contents of the root directory, this time containing very specific (local system) commands and configuration data. Hence, you will find commands in <code>/bin</code>, <code>/usr/bin</code> and in <code>/usr/local/bin</code>: the ones in <code>/bin</code> will be part of the distribution, the ones in <code>/usr/bin</code> may be commands that are non-mandatory or added later by the system administrator and finally the ones in <code>/usr/local/bin</code> are commands that are specific to the local system.</p> <p>Note The <code>lost+found</code> directory is used by the filesystem itself.</p> <ul> <li>Contents of /boot:<pre><code>debian-601a:/boot$ ls -a\n.                      debian.bmp                 sarge.bmp\n..                     debianlilo.bmp             sid.bmp\ncoffee.bmp             grub           System.map-2.6.32-5-amd64\nconfig-2.6.32-5-amd64  initrd.img-2.6.32-5-amd64  vmlinuz-2.6.32-5-amd64\n</code></pre> </li> </ul> <p>The most important are <code>vmlinuz</code>, <code>System.map</code>, <code>initrd.img</code> and <code>config</code> file. The <code>grub</code> directory resides here too. Also some bitmap images live here.</p> <ul> <li>Contents of <code>/lib/modules</code>:<pre><code>debian-601a:/lib/modules$ ls -a\n.  ..  2.6.32-5-amd64\n\ndebian-601a:/lib/modules/2.6.32-5-amd64$ ls -a\n.      kernel             modules.dep      modules.order    modules.symbols.bin\n..     modules.alias      modules.dep.bin  modules.softdep  source\nbuild  modules.alias.bin  modules.devname  modules.symbols  updates\n</code></pre> </li> </ul> <p>See also the section on the FHS standard.</p>"},{"location":"lpic2.201.3/#tools-and-utilities-to-trace-software-and-their-system-and-library-calls","title":"Tools and utilities to trace software and their system and library calls","text":""},{"location":"lpic2.201.3/#strace-trace-system-calls-and-signals","title":"strace - trace system calls and signals","text":"<pre><code>    SYNOPSIS\n        strace  [  -CdffhiqrtttTvxx  ] [ -acolumn ] [ -eexpr ] ...  [ -ofile ] [ -ppid ]\n        ...  [ -sstrsize ] [ -uusername ] [ -Evar=val ] ...  [ -Evar ] ...  [ command  [\n        arg ...  ] ]\n\n        strace -c [ -eexpr ] ...  [ -Ooverhead ] [ -Ssortby ] [ command [ arg ...  ] ]\n</code></pre> <p><code>strace</code> is a useful diagnostic, instructional, and debugging tool. System administrators, diagnosticians and trouble-shooters will find it invaluable for solving problems with programs for which the source is not readily available since they do not need to be recompiled in order to trace them. Students, hackers and the overly-curious will find that a great deal can be learned about a system and its system calls by tracing even ordinary programs. And programmers will find that since system calls and signals are events that happen at the user/kernel interface, a close examination of this boundary is very useful for bug isolation, sanity checking and attempting to capture race conditions.</p> <p>In the simplest case <code>strace</code> runs the specified command until it exits. It intercepts and records the system calls which are called by a process and the signals which are received by a process. The name of each system call, its arguments and its return value are printed on standard error or to the file specified with the <code>-o</code> option.</p> <p>By default <code>strace</code> reports the name of the system call, its arguments and the return value on standard error.</p> <p>Example:</p> <pre><code>    debian-601a:~$ strace cat /dev/null\n    execve(\"/bin/cat\", [\"cat\", \"/dev/null\"], [/* 34 vars */]) = 0\n    brk(0)                                  = 0xc25000\n    access(\"/etc/ld.so.nohwcap\", F_OK)      = -1 ENOENT (No such file or directory)\n    mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fcac8fb4000\n    access(\"/etc/ld.so.preload\", R_OK)      = -1 ENOENT (No such file or directory)\n    open(\"/etc/ld.so.cache\", O_RDONLY)      = 3\n    fstat(3, {st_mode=S_IFREG|0644, st_size=59695, ...}) = 0\n    mmap(NULL, 59695, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcac8fa5000\n    close(3)                                = 0\n    access(\"/etc/ld.so.nohwcap\", F_OK)      = -1 ENOENT (No such file or directory)\n    open(\"/lib/libc.so.6\", O_RDONLY)        = 3\n    read(3, \"\\177ELF\\2\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0`\\355\\1\\0\\0\\0\\0\\0\"..., 832) = 832\n    fstat(3, {st_mode=S_IFREG|0755, st_size=1432968, ...}) = 0\n    mmap(NULL, 3541032, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fcac8a38000\n    mprotect(0x7fcac8b90000, 2093056, PROT_NONE) = 0\n    mmap(0x7fcac8d8f000, 20480, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x157000) = 0x7fcac8d8f000\n    mmap(0x7fcac8d94000, 18472, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7fcac8d94000\n    close(3)                                = 0\n    mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fcac8fa4000\n    mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fcac8fa3000\n    mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fcac8fa2000\n    arch_prctl(ARCH_SET_FS, 0x7fcac8fa3700) = 0\n    mprotect(0x7fcac8d8f000, 16384, PROT_READ) = 0\n    mprotect(0x7fcac8fb6000, 4096, PROT_READ) = 0\n    munmap(0x7fcac8fa5000, 59695)           = 0\n    brk(0)                                  = 0xc25000\n    brk(0xc46000)                           = 0xc46000\n    open(\"/usr/lib/locale/locale-archive\", O_RDONLY) = 3\n    fstat(3, {st_mode=S_IFREG|0644, st_size=1527584, ...}) = 0\n    mmap(NULL, 1527584, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcac8e2d000\n    close(3)                                = 0\n    fstat(1, {st_mode=S_IFCHR|0620, st_rdev=makedev(136, 1), ...}) = 0\n    open(\"/dev/null\", O_RDONLY)             = 3\n    fstat(3, {st_mode=S_IFCHR|0666, st_rdev=makedev(1, 3), ...}) = 0\n    read(3, \"\", 32768)                      = 0\n    close(3)                                = 0\n    close(1)                                = 0\n    close(2)                                = 0\n    exit_group(0)                           = ?\n</code></pre> <p>Another very useful feature of <code>strace</code> is its ability to connect to a running process using the <code>-p</code> flag. In combination with the <code>-f</code> flag you can connect to say a running daemon that seems to malfunction and gain insight in what it is actually doing.</p>"},{"location":"lpic2.201.3/#strings","title":"strings","text":"<p><code>strings</code> - print the strings of printable characters in files. <code>strings</code> can be useful for reading non-text files.</p> <pre><code>    SYNOPSIS\n        strings [-afovV] [-min-len]\n               [-n min-len] [--bytes=min-len]\n               [-t radix] [--radix=radix]\n               [-e encoding] [--encoding=encoding]\n               [-] [--all] [--print-file-name]\n               [-T bfdname] [--target=bfdname]\n               [--help] [--version] file...\n</code></pre> <p>For each file given, GNU <code>strings</code> prints the printable character sequences that are at least 4 characters long (or the number given with the options below) and are followed by an unprintable character. By default, it only prints the strings from the initialized and loaded sections of object files; for other types of files, it prints the strings from the whole file. troubleshootingstrings</p> <p><code>strings</code> is mainly useful for determining the contents of non-text files, such as executables. Often used to check for names of environment variables and configurations files used by an executable.</p>"},{"location":"lpic2.201.3/#ltrace","title":"ltrace","text":"<p><code>ltrace</code> - a library call tracer</p> <pre><code>    SYNOPSIS\n        ltrace  [-CfhiLrStttV]  [-a  column] [-A maxelts] [-D level] [-e expr] [-l file-\n        name] [-n nr] [-o filename] [-p pid] ... [-s strsize] [-u username] [-X  extern]\n        [-x   extern]   ...   [--align=column]   [--debug=level]  [--demangle]  [--help]\n        [--indent=nr] [--library=filename] [--output=filename] [--version] [command [arg\n        ...]]\n</code></pre> <p>Similar to the <code>strace</code>, that intercepts and records system calls, <code>ltrace</code> intercepts and records the dynamic library calls which are called by the executed process and the signals which are received by that process. The program to be traced need not be recompiled for this, so you can use it on binaries for which you don't have the source handy. By default, <code>ltrace</code> will start the program you specify on the command line and traces it until the program exits.</p> <p>Example:</p> <pre><code>    debian-601a:~$ ltrace cat /dev/null\n    __libc_start_main(0x401ad0, 2, 0x7fff5f357f38, 0x409110, 0x409100 &lt;unfinished ...&gt;\n    getpagesize()                                                     = 4096\n    strrchr(\"cat\", '/')                                               = NULL\n    setlocale(6, \"\")                                                  = \"en_US.utf8\"\n    bindtextdomain(\"coreutils\", \"/usr/share/locale\")                  = \"/usr/share/locale\"\n    textdomain(\"coreutils\")                                           = \"coreutils\"\n    __cxa_atexit(0x4043d0, 0, 0, 0x736c6974756572, 0x7f4069c04ea8)    = 0\n    getenv(\"POSIXLY_CORRECT\")                                         = NULL\n    __fxstat(1, 1, 0x7fff5f357d80)                                    = 0\n    open(\"/dev/null\", 0, 02)                                          = 3\n    __fxstat(1, 3, 0x7fff5f357d80)                                    = 0\n    malloc(36863)                                                     = 0x014c4030\n    read(3, \"\", 32768)                                                = 0\n    free(0x014c4030)                                                  = &lt;void&gt;\n    close(3)                                                          = 0\n    exit(0 &lt;unfinished ...&gt;\n    __fpending(0x7f4069c03780, 0, 0x7f4069c04330, 0x7f4069c04330, 0x7f4069c04e40) = 0\n    fclose(0x7f4069c03780)                                            = 0\n    __fpending(0x7f4069c03860, 0, 0x7f4069c04df0, 0, 0x7f4069e13700)  = 0\n    fclose(0x7f4069c03860)                                            = 0\n    +++ exited (status 0) +++\n</code></pre>"},{"location":"lpic2.201.3/#the-boot-process","title":"The boot process","text":"<p>When using an <code>initrd</code>, the system goes through the following steps:</p> <ol> <li> <p>The boot loader loads the kernel and the initial RAM disk.</p> </li> <li> <p>The kernel converts <code>initrd</code> into a \"normal\" RAM disk and frees the     memory used by the <code>initrd</code> image.</p> </li> <li> <p>The <code>initrd</code> image is mounted read-write as root</p> </li> <li> <p>The <code>linuxrc</code> is executed (this can be any valid executable,     including shell scripts; it is run with uid 0 and can do everything     <code>init</code> can do)</p> </li> <li> <p>After <code>linuxrc</code> terminates, the \"real\" root filesystem is mounted</p> </li> <li> <p>If a directory <code>/initrd</code> exists, the <code>initrd</code> image is moved there,     otherwise, <code>initrd</code> image is unmounted</p> </li> <li> <p>The usual boot sequence (e.g. invocation of the <code>/sbin/init</code>) is     performed on the root filesystem</p> </li> </ol> <p>As moving the <code>initrd</code> from <code>/</code> to <code>/initrd</code> does not require to unmount it, process(es) that use files on the RAMdisk may kept running. All filesystems that were mounted will remain mounted during the move. However, if <code>/initrd</code> does not exist the move is not made and in that case any running processes that use files from the <code>initrd</code> image will prevent it from becoming unmounted. It will remain in memory until forced out of existence by the continuation of the bootprocess.</p>"},{"location":"lpic2.201.3/#procmounts","title":"/proc/mounts","text":"<p>Also, even when the move can be made and so filesystems mounted under <code>initrd</code> remain accessible, the entries in <code>/proc/mounts</code> will not be updated. Also keep in mind that if the directory <code>/initrd</code> does not exist it is impossible to unmount the RAM disk image. The image will be forced out of existence during the rest of the bootprocess, so any filesystems mounted within it will also disappear and can not be remounted. Therefore, it is strongly recommendated to unmount all filesystems before switching from the <code>initrd</code> filesystem to the normal root filesystem, including the <code>/proc</code> filesystem.</p> <p>The memory used for the <code>initrd</code> image can be reclaimed. To do this, the command <code>freeramdisk</code> must be used directly after unmounting <code>/initrd</code>.</p>"},{"location":"lpic2.201.3/#boot-option","title":"boot option","text":"<p>initrd=</p> <p>Including <code>initrd</code> support to the kernel adds options to the boot command line:</p> <p><code>initrd=</code></p> <ul> <li>This option loads the file that is specified as the initial RAM     disk.</li> </ul> <p><code>noinitrd</code></p> <ul> <li> <p>This option causes the <code>initrd</code> data to be preserved, but it is not     converted to a RAM disk and the normal root filesystem is mounted     instead. The <code>initrd</code> data can be read from <code>/dev/initrd</code>. If read     through <code>/dev/initrd</code>, the data can have any structure so it need     not necessarily be a filesystem image. This option is used mainly     for debugging purposes.</p> <p>Note The <code>/dev/initrd</code> is read-only and can be used only once. As soon as the last process has closed it, all memory is freed and <code>/dev/initrd</code> can no longer be accessed. :::</p> </li> </ul> <p><code>root=/dev/ram</code></p> <ul> <li>The <code>initrd</code> is mounted as root and subsequently <code>/linuxrc</code> is     started. If there is no <code>/linuxrc</code> the normal boot procedure will be     followed. Without using this parameter, the <code>initrd</code> would be moved     or unloaded, however in this case, the root filesystem will continue     to be the RAM disk. The advantage of this is that it allows the use     of a compressed filesystem and it is slightly faster.</li> </ul>"},{"location":"lpic2.201.3/#hardware-and-kernel-information","title":"Hardware and Kernel Information","text":""},{"location":"lpic2.201.3/#uname","title":"uname","text":"<p><code>uname</code> prints system information such as machine type, network hostname, OS release, OS name, OS version and processor type of the host. The parameters are: uname</p> <p><code>-a</code>; <code>--all</code></p> <ul> <li>uname -a uname --all print all information, in the order below,     except omit -p and -i if these are unknown.</li> </ul> <p><code>-s</code>; <code>--kernel-name</code></p> <ul> <li>uname-s uname--kernel-name prints the kernel name</li> </ul> <p><code>-n</code>; <code>--nodename</code></p> <ul> <li>uname-n uname--nodename prints the network node hostname</li> </ul> <p><code>-r</code>; <code>--kernel-release</code></p> <ul> <li>uname-r uname--kernel-release prints the kernel release</li> </ul> <p><code>-v</code>; <code>--kernel-version</code></p> <ul> <li>uname-v uname--kernel-version prints the kernel build version, date     and time</li> </ul> <p><code>-m</code>; <code>--machine</code></p> <ul> <li>uname-m uname--machine prints the machine hardware architecture     name</li> </ul> <p><code>-p</code>; <code>--processor</code></p> <ul> <li>uname-p uname--processor prints the name of the processor type</li> </ul> <p><code>-i</code>; <code>--hardware-platform</code></p> <ul> <li>uname-i uname--hardware-platform prints the name of hardware     platform</li> </ul> <p><code>-o</code>; <code>--operating-system</code></p> <ul> <li>uname-o uname--operating-system prints the name of the operating     system</li> </ul> <p>Example:</p> <pre><code>    debian-601a:~$ uname -a\n    Linux debian-601a 2.6.32-5-amd64 #1 SMP Mon Mar 7 21:35:22 UTC 2011 x86_64 GNU/Linux\n</code></pre>"},{"location":"lpic2.201.3/#procstyskernel","title":"/proc/stys/kernel","text":"<p><code>/proc/sys/kernel/</code> is a directory in the <code>/proc</code> pseudo filesystem. It contains files that allow you to tune and monitor the Linux kernel. Be careful, as modification of some of the files may lead to a hanging or dysfunctional system. As these parameters are highly dependant on the kernel verions, it is advisable to read both documentation and source before actually making adjustments. See also the section on the <code>/proc</code> filesystem.</p> <p>Some files are quite harmless and can safely be used to obtain information, for instance to show the version of the running kernel:</p> <pre><code>    debian-601a:~$ cat /proc/sys/kernel/osrelease\n</code></pre> <p>Some files can be used to set information in the kernel. For instance, the following will tell the kernel not to loop on a panic, but to auto-reboot after 20 seconds:</p> <pre><code>    debian-601a:~$ echo 20 &gt; /proc/sys/kernel/panic\n</code></pre>"},{"location":"lpic2.201.3/#lspci","title":"lspci","text":"<p>With <code>lspci</code> you can display information about all the PCI buses in the system and all the devices that are connected to them. Keep in mind that you need to have Linux kernel 2.1.82 or newer. With older kernels direct hardware access is only available to root. To make the output of <code>lspci</code> more verbose, one or more <code>-v</code> paramaters (up to 3) can be added. Access to some parts of the PCI configuraion space is restricted to root on many operating systems. So <code>lspci</code> features available to normal users are limited.</p> <p>Example of <code>lspci</code> output on a system running Debian in Virtualbox:</p> <pre><code>    debian-601a:~$ lspci\n    00:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC [Natoma] (rev 02)\n    00:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]\n    00:01.1 IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)\n    00:02.0 VGA compatible controller: InnoTek Systemberatung GmbH VirtualBox Graphics Adapter\n    00:03.0 Ethernet controller: Intel Corporation 82540EM Gigabit Ethernet Controller (rev 02)\n    00:04.0 System peripheral: InnoTek Systemberatung GmbH VirtualBox Guest Service\n    00:05.0 Multimedia audio controller: Intel Corporation 82801AA AC'97 Audio Controller (rev 01)\n    00:06.0 USB Controller: Apple Computer Inc. KeyLargo/Intrepid USB\n    00:07.0 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 08)\n    00:0d.0 SATA controller: Intel Corporation 82801HBM/HEM (ICH8M/ICH8M-E) SATA AHCI Controller (rev 02)\n</code></pre>"},{"location":"lpic2.201.3/#lsusb","title":"lsusb","text":"<p>lsusb <code>lsusb</code> is similiar to <code>lspci</code>, but checks the USB buses and devices. To make use of <code>lsusb</code> a Linux kernel which supports the <code>/proc/bus/usb</code> inferface is needed (Linux 2.3.15 or newer). <code>lsusb -v</code> will provide verbose information.</p> <p>Example of <code>lsusb</code> output as generated on a laptop running Ubuntu:</p> <pre><code>    ubuntu:/var/log$ lsusb\n    Bus 007 Device 003: ID 03f0:0324 Hewlett-Packard SK-2885 keyboard\n    Bus 007 Device 002: ID 045e:0040 Microsoft Corp. Wheel Mouse Optical\n    Bus 007 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub\n    Bus 006 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub\n    Bus 005 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub\n    Bus 004 Device 002: ID 147e:2016 Upek Biometric Touchchip/Touchstrip Fingerprint Sensor\n    Bus 004 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub\n    Bus 003 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub\n    Bus 002 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub\n    Bus 001 Device 002: ID 04f2:b018 Chicony Electronics Co., Ltd 2M UVC Webcam\n    Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub\n</code></pre>"},{"location":"lpic2.201.3/#lsdev","title":"lsdev","text":"<p>lsdev <code>lsdev</code> displays information about installed hardware. It gathers information from interupts, DMA files, and interrupts from the <code>/proc</code> directory. <code>lsdev</code> gives a quick overview about which device is using what I/O address and IRQ/DMA channels. Files being used:</p> <pre><code>/proc/interrupts\n\n/proc/ioports\n\n/proc/dma\n</code></pre> <p>Example of <code>lsdev</code> output on a Debian based system:</p> <pre><code>    debian-601a:/var/log$ lsdev\n    Device            DMA   IRQ  I/O Ports\n    ------------------------------------------------\n    0000:00:01.1                 0170-0177 01f0-01f7 0376-0376 03f6-03f6 d000-d00f\n    0000:00:03.0                 d010-d017\n    0000:00:04.0                 d020-d03f\n    0000:00:05.0                 d100-d1ff d200-d23f\n    0000:00:0d.0                 d240-d247 d250-d257 d260-d26f\n    82801AA-ICH               5\n    ACPI                         4000-4003 4004-4005 4008-400b 4020-4021\n    ahci                           d240-d247   d250-d257   d260-d26f\n    ata_piix              14 15    0170-0177   01f0-01f7   0376-0376   03f6-03f6   d000-d00f\n    cascade             4     2\n    dma                          0080-008f\n    dma1                         0000-001f\n    dma2                         00c0-00df\n    e1000                          d010-d017\n    eth1                     10\n    fpu                          00f0-00ff\n    i8042                  1 12\n    Intel                          d100-d1ff   d200-d23f\n    keyboard                     0060-0060 0064-0064\n    ohci_hcd:usb1            11\n    PCI                          0cf8-0cff\n    pic1                         0020-0021\n    pic2                         00a0-00a1\n    rtc0                      8    0070-0071\n    rtc_cmos                     0070-0071\n    timer                     0\n    timer0                       0040-0043\n    timer1                       0050-0053\n    vboxguest                 9\n    vga+                         03c0-03df\n</code></pre> <p>Note</p> <p>On some systems <code>lsdev</code> is missing, use <code>procinfo</code> instead.</p>"},{"location":"lpic2.201.3/#sysctl","title":"sysctl","text":"<p>sysctl sysctl is used to modify kernel paramaters at runtime. The parameters available are those listed under <code>/proc/sys/</code>. The configuration file can usually be found in <code>/etc/sysctl.conf</code>. It is important to know that modules loaded after <code>sysctl</code> is used may override its settings. You can prevent this by running <code>sysctl</code> only after all modules are loaded.</p>"},{"location":"lpic2.201.3/#kernel-runtime-management","title":"Kernel Runtime Management","text":"<p>With the <code>dmesg</code> command you can write kernel messages to standard output. Or write them to a file using <code>dmesg &gt; /var/log/boot.messages</code>. This can be helpful when it comes to troubleshooting issues with your system or when you just want to get some information about the hardware in your system. The output of <code>dmesg</code> can usually be found in <code>/var/log/dmesg</code>. Use <code>dmesg</code> in combination with <code>grep</code> to find specific information.</p>"},{"location":"lpic2.201.3/#udev","title":"udev","text":"<p>Candidates should understand device detection and management using <code>udev</code>. This objective includes troubleshooting udev rules</p> <p>Key Knowledge Areas:</p> <ul> <li> <p>udev rules</p> </li> <li> <p>Kernel interfaces</p> </li> </ul> <p><code>udev</code> was designed to make Linux device handling more flexible and safe by taking device handling out of system space into userspace.</p> <p><code>udev</code> consists of a userspace daemon (<code>udevd</code>) which receives \"uevents\" from the kernel. Communication between the userspace daemon and the kernel is done through the <code>sysfs</code> pseudo filesystem. The kernel sends the aforementioned \"uevents\" when it detects addition or removal of hardware, for example when you plug in your camera or USB disk. Based on a set of rules to match these uevents the kernel provides a dynamic device directory containing only device files for devices that are actually present, and can fire up scripts etc. to perform various actions. Hence, it is possible, for example, to plug in a camera, which will be automatically detected and properly mounted in the right place. After that a script might be started that copies all files to the local disk into a properly named subdirectory that will be created using the proper rights.</p> <p><code>/etc/udev/</code></p> <p>The <code>/etc/udev/</code> directory contains the configuration and the rule files for the udev utility. The <code>udev.conf</code> is the main configuration file for udev. Here, for instance, the logging priority can be changed.</p> <p><code>udev rules</code></p> <p><code>udev</code> rules are read from files located in the default rules directory. <code>/lib/udev/rules.d/</code>. Custom rules to override these default rules are specified in the <code>/etc/udev/rules.d/</code> directory.</p> <p>When devices are initialized or removed, the kernel sends an 'uevent'. These uevents contain information such as the subsystem (e.g. net, sub), action and attributes (e.g. mac, vendor). <code>udev</code> listens to these events, matches the uevent information to the specified rules, and responds accordingly.</p> <p>A <code>udev</code> rule consists of multiple key value pairs separated by a comma. Each key value pair represents either a match key, that matches to information provided with the uevent or an assign key, which assign values, names and actions to the device nodes maintained by <code>udev</code>:</p> <pre><code>    SUBSYSTEM==\"net\", ACTION==\"ADD\", DRIVERS=\"?*\", ATTR{address}==\"00:21:86:9e:c2:c4\", \n    ATTR{type}==\"1\", KERNEL=\"eth*\", NAME==\"eth0\"\n</code></pre> <p>The rule specified above would add a device <code>/dev/eth0</code> for a network card with MAC address 00:21:86:9e:c2:c4</p> <p>As shown, a key value pair also specifies an operator. Depending on the used operator, different actions are taken. Valid operators are: ==, Compare for equality, !=, Compare for inequality, =, Assign a value to a key. Keys that represent a list, are reset and only this single value is assigned, +=, Add the value to a key finally; disallow any later changes, which may be used to prevent changes by any later rules</p> <p>When specifying rules, be careful not to create conflicting rules (e.g. do not point two different netword cards to the same device name). Also, changing device names into something else could cause userpsace software incompatibilities. You have power, use it wisely.</p> <p><code>udevmonitor</code></p> <p><code>udevmonitor</code> will print <code>udev</code> and kernel uevents to standard output. You can use it to analyze event timing by comparing the timestamps of the kernel uevent and the <code>udev</code> event. Usually <code>udevmonitor</code> is a symbolic link to <code>udevadm</code>. In some distributions, this symbolic link no longer exists. To access the monitor on these systems, use the command <code>udevadm monitor</code>.</p>"},{"location":"lpic2.202.0/","title":"System Startup (202)","text":"<p>This topic has a total weight of 9 points and contains the following 3 objectives:</p>"},{"location":"lpic2.202.0/#objective-2021-customizing-sysv-init-system-startup-3-points","title":"Objective 202.1 Customizing SysV-init system startup (3 points)","text":"<ul> <li>Candidates should be able to query and modify the behaviour of     system services at various run levels. A thorough understanding of     the init structure and boot process is required. This objective     includes interacting with run levels.</li> </ul>"},{"location":"lpic2.202.0/#objective-2022-system-recovery-4-points","title":"Objective 202.2 System recovery (4 points)","text":"<ul> <li>Candidates should be able to properly manipulate a Linux system     during both the boot process and during recovery mode. This     objective includes using both the init utility and init-related     kernel options. Candidates should be able to determine the cause of     errors in loading and usage of bootloaders. GRUB version 2 and GRUB     Legacy are the bootloaders of interest.</li> </ul>"},{"location":"lpic2.202.0/#objective-2023-alternate-bootloaders-2-points","title":"Objective 202.3 Alternate Bootloaders (2 points)","text":"<ul> <li>Candidates should be aware of other bootloaders and their major     features.</li> </ul>"},{"location":"lpic2.202.1/","title":"Customizing system startup (202.1)","text":""},{"location":"lpic2.202.1/#customizing-system-startup-2021","title":"Customizing system startup (202.1)","text":"<p>Candidates should be able to query and modify the behaviour of system services at various targets / run levels. A thorough understanding of the systemd, SysV Init and the Linux boot proces is required. This objective includes interacting with systemd targets and SysV init run levels.</p>"},{"location":"lpic2.202.1/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Systemd</p> </li> <li> <p>SysV init</p> </li> <li> <p>Linux Standard Base Specification (LSB)</p> </li> </ul>"},{"location":"lpic2.202.1/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/usr/lib/systemd/</code></p> </li> <li> <p><code>/etc/systemd/</code></p> </li> <li> <p><code>/run/systemd/</code></p> </li> <li> <p><code>systemctl</code></p> </li> <li> <p><code>systemd-delta</code></p> </li> <li> <p><code>/etc/inittab</code></p> </li> <li> <p><code>/etc/init.d/</code></p> </li> <li> <p><code>/etc/rc.d/</code></p> </li> <li> <p><code>chkconfig</code></p> </li> <li> <p><code>update-rc.d</code></p> </li> <li> <p><code>init and telinit</code></p> </li> </ul>"},{"location":"lpic2.202.1/#create-initrd-using-mkinitrd","title":"Create <code>initrd</code> using <code>mkinitrd</code>","text":"<p>Note</p> <p><code>mkinitrd</code> was discussed in a previous section, which also discusses how to create such an image manually.</p> <p>To limit the size of the kernel, often initial ramdisk (initrd) images are used to preload any modules needed to access the root filesystem.</p> <p>The <code>mkinitrd</code> is a tool which is specific to RPM based distributions (such as Red Hat, SuSE, etc.). This tool automates the process of creating an <code>initrd</code> file, thereby making sure that the relatively complex process is followed correctly.</p> <p>In most of the larger Linux distributions the <code>initrd</code> image contains almost all necessary kernel modules; very few will be compiled directly into the kernel. This enables the deployment of easy fixes and patches to the kernel and its modules through RPM packages: an update of a single module will not require a recompilation or replacement of the whole kernel, but just the single module, or worst case a few dependent modules. Because these modules are contained within the <code>initrd</code> file, this file needs to be regenerated every time the kernel is (manually) recompiled, or a kernel (module) patch is installed. Generating a new <code>initrd</code> image is very simple if you use the standard tool provided on many distributions:</p> <pre><code>    # mkinitrd initrd-image kernel-version\n</code></pre> <p>Useful options for <code>mkinitrd</code> include:</p> <p><code>--version</code></p> <ul> <li>This option displays the version number of the <code>mkinitrd</code> utility.</li> </ul> <p><code>-f</code></p> <ul> <li>By specifying this switch, the utility will overwrite any existing     image file with the same name.</li> </ul> <p><code>--builtin=</code></p> <ul> <li>This causes <code>mkinitrd</code> to assume the module specified was compiled     into the kernel. It will not look for the module and will not show     any errors if it does not exist.</li> </ul> <p><code>--omit-lvm-modules</code>, <code>--omit-raid-modules</code>, <code>--omit-scsi-modules</code></p> <ul> <li>Using these options it is possible to prevent inclusion of,     respectively, LVM, RAID or SCSI modules, even if they are present,     or the utility would normally include them based on the contents of     <code>/etc/fstab</code> and/or <code>/etc/raidtab</code>.</li> </ul>"},{"location":"lpic2.202.1/#mkinitramfsmc","title":"Create <code>initrd</code> using <code>mkinitramfs</code>","text":"<p>Dissatisfied with the tool the RPM based distributions use (<code>mkinitrd</code>), some Debian developers wrote another utility to generate an <code>initrd</code> file. This tool is called <code>mkinitramfs</code>. The <code>mkinitramfs</code> tool is a shell script which generates a gzipped cpio image. It was designed to be much simpler (in code as well as in usage) than <code>mkinitrd</code>. The script consists of around 380 lines of code.</p> <p>Configuration of mkinitramfs is done through a configuration file: <code>initramfs.conf</code>. This file is usually located in <code>/etc/initramfs-tools/initramfs.conf</code>. This configuration file is sourced by the script - it contains standard <code>bash</code> declarations. Comments are prefixed by a #. Variables are specified by:</p> <pre><code>    variable=value\n</code></pre> <p>Options which can be used with <code>mkinitramfs</code> include:</p> <p><code>-d confdir</code></p> <ul> <li>This option sets an alternate configuration directory.</li> </ul> <p><code>-k</code></p> <ul> <li>\"Keep\" the temporary directory used for creating the image.</li> </ul> <p><code>-o outfile</code></p> <ul> <li>Write the resulting image to <code>outfile</code>.</li> </ul> <p><code>-r root</code></p> <ul> <li>Override the <code>ROOT</code> setting in the <code>initramfs.conf</code> file.</li> </ul> <p>Note On Debian(-based) distributions you should always use <code>mkinitramfs</code> as <code>mkinitrd</code> is broken there for more recent kernels.</p>"},{"location":"lpic2.202.1/#setting-the-root-device","title":"Setting the root device","text":"<p>Setting the root device is one of the many kernel settings. Kernel settings originate from or can be overwritten by:</p> <ul> <li> <p>defaults as set in the source code,</p> </li> <li> <p>defaults as set by the <code>rdev</code> command,</p> </li> <li> <p>values passed to the kernel at boot time, for example     <code>root=/dev/xyz</code></p> </li> <li> <p>values specified in the GRUB configuration file.</p> </li> </ul> <p>The most obvious to use are block devices like harddisks, SAN storage, CDs or DVDs. You can even have a NFS mounted root-disk, this requires usage of <code>initrd</code> and setting the <code>nfs_root_name</code> and <code>nfs_root_addrs</code> boot options. You can set or change the root device to almost anything from within the <code>initrd</code> environment. In order to do so, make sure that the <code>/proc</code> filesystem was mounted by the scripts in the <code>initrd</code> image. The following files are available in <code>/proc</code>:</p> <pre><code>    /proc/sys/kernel/real-root-dev\n    /proc/sys/kernel/nfs-root-name\n    /proc/sys/kernel/nfs-root-addrs\n</code></pre> <p>The <code>real-root-dev</code> refers to the node number of the root file system device. It can be easily changed by writing the new number to it:</p> <pre><code>    # echo 0x301&gt;/proc/sys/kernel/real-root-dev\n</code></pre> <p>This will change the real root to the filesystem on <code>/dev/hda1</code>. If you wish to use an NFS-mounted root, the files <code>nfs-root-name</code> and <code>nfs-root-addrs</code> have to be set using the appropriate values and the device number should be set to 0xff:</p> <pre><code>    # echo /var/nfsroot &gt;/proc/sys/kernel/nfs-root-name\n    # echo 193.8.232.2:193.8.232.7::255.255.255.0:idefix \\\n      &gt;/proc/sys/kernel/nfs-root-addrs\n    # echo 255&gt;/proc/sys/kernel/real-root-dev\n</code></pre> <p>Note If the root device is set to the RAM disk, the root filesystem is not moved to <code>/initrd</code>, but the boot procedure is simply continued by starting init on the initial RAM disk.</p>"},{"location":"lpic2.202.1/#the-linux-boot-process","title":"The Linux Boot process","text":"<p>There are seven phases distinguishable during boot:</p> <ol> <li> <p>Kernel loader loading, setup and execution</p> </li> <li> <p>Register setup</p> </li> <li> <p>Kernel decompression</p> </li> <li> <p>Kernel and memory initialization</p> </li> <li> <p>Kernel setup</p> </li> <li> <p>Enabling of remaining CPU's</p> </li> <li> <p>Init process creation</p> </li> </ol> <p>The boot process is described in detail at Gustavo Duarte's \"The Kernel Boot Process\"</p> <p>The kernel's final step in the boot process  tries to execute these commands in order, until one succeeds:</p> <ol> <li> <p>/sbin/init</p> </li> <li> <p>/etc/init</p> </li> <li> <p>/bin/init</p> </li> <li> <p>/bin/sh</p> </li> </ol> <p>If none of these succeed, the kernel will panic.</p>"},{"location":"lpic2.202.1/#the-init-process","title":"The <code>init</code> process","text":"<p><code>init</code> is the parent of all processes, it reads the file <code>/etc/inittab</code> and creates processes based on its contents. One of the things it usually does is spawn <code>gettys</code> allowing users to log in. It also defines \"runlevels\".</p> <p>A \"runlevel\" is a software configuration of the system which allows only a selected group of processes to exist. runlevel</p>"},{"location":"lpic2.202.1/#runlevel-0-reserved","title":"runlevel 0 (reserved)","text":"<ul> <li>Runlevel 0 is used to halt the system.</li> </ul>"},{"location":"lpic2.202.1/#runlevel-1-reserved","title":"runlevel 1 (reserved)","text":"<ul> <li>Runlevel 1 is used to get the system in single user mode. runlevel 1</li> </ul>"},{"location":"lpic2.202.1/#runlevel-2-5","title":"runlevel 2-5","text":"<ul> <li>Runlevels 2,3,4 and 5 are multi-user runlevels.</li> </ul>"},{"location":"lpic2.202.1/#runlevel-6","title":"runlevel 6","text":"<ul> <li>Runlevel 6 is used to reboot the system.</li> </ul>"},{"location":"lpic2.202.1/#runlevel-7-9","title":"runlevel 7-9","text":"<ul> <li>Runlevels 7, 8 and 9 can be used as you wish. Most of the     Unix(/Linux) variants don't use these runlevels. On a typical     Debian Linux System for instance, the <code>/etc/rc&lt;runlevel&gt;.d</code>     directories, which we will discuss later, are not available for     these runlevels, though that would be perfectly legal.</li> </ul>"},{"location":"lpic2.202.1/#runlevel-s-or-s","title":"runlevel s or S","text":"<ul> <li>Runlevels s and S are internally the same. It brings runlevel s     runlevel S the system in \"single-user mode\". The scripts in the     <code>/etc/rcS.d</code> directory are executed when booting the system.     Although runlevel S is not meant to be activated by the user, it can     be.</li> </ul>"},{"location":"lpic2.202.1/#runlevels-a-b-and-c","title":"runlevels A, B and C","text":"<ul> <li>Runlevels A, B and C are so called \"on demand\" runlevels. If the     current runlevel is \"2\" for instance, and an <code>init A</code> command is     executed, the scripts to start or stop processes within runlevel \"A\"     are executed but the actual runlevel remains \"2\".</li> </ul>"},{"location":"lpic2.202.1/#configuring-etcinittab","title":"Configuring <code>/etc/inittab</code>","text":"<p>As mentioned before <code>init</code> reads the file <code>/etc/inittab</code> to determine what it should do. An entry in this file has the following format:</p> <p>id:runlevels:action:process</p> <p>Included below is an example <code>/etc/inittab</code> file.</p> <pre><code>    # The default runlevel.\n    id:2:initdefault:\n\n    # Boot-time system configuration/initialization script.\n    # This is run first except when booting in emergency (-b) mode.\n    si::sysinit:/etc/init.d/rcS\n\n    # What to do in single-user mode.\n    ~~:S:wait:/sbin/sulogin\n\n    # /etc/init.d executes the S and K scripts upon change\n    # of runlevel.\n    #\n    # Runlevel 0 is halt.\n    # Runlevel 1 is single-user.\n    # Runlevels 2-5 are multi-user.\n    # Runlevel 6 is reboot.\n\n    l0:0:wait:/etc/init.d/rc 0\n    l1:1:wait:/etc/init.d/rc 1\n    l2:2:wait:/etc/init.d/rc 2\n    l3:3:wait:/etc/init.d/rc 3\n    l4:4:wait:/etc/init.d/rc 4\n    l5:5:wait:/etc/init.d/rc 5\n    l6:6:wait:/etc/init.d/rc 6\n    # Normally not reached, but fall through in case of emergency.\n    z6:6:respawn:/sbin/sulogin\n\n    # /sbin/getty invocations for the runlevels.\n    #\n    # The \"id\" field MUST be the same as the last\n    # characters of the device (after \"tty\").\n    #\n    # Format:\n    #  &lt;id&gt;:&lt;runlevels&gt;:&lt;action&gt;:&lt;process&gt;\n    1:2345:respawn:/sbin/getty 38400 tty1\n    2:23:respawn:/sbin/getty 38400 tty2\n</code></pre> <ul> <li> <p>id</p> <ul> <li>The id-field uniquely identifies an entry in the file <code>/etc/inittab</code> and can be 1-4 characters in length. For gettys and other login processes however, the id field should contain the suffix of the corresponding tty, otherwise the login accounting might not work.</li> </ul> </li> <li> <p>runlevels</p> <ul> <li>This field contains the runlevels for which the specified action should be taken.</li> </ul> </li> <li> <p>action</p> <ul> <li> <p>respawn</p> <ul> <li>The process will be restarted whenever it terminates, respawn (e.g. getty). getty</li> </ul> </li> <li> <p>wait</p> <ul> <li>The process will be started once when the specified wait runlevel is entered and <code>init</code> will wait for its termination.</li> </ul> </li> <li> <p>once</p> <ul> <li>The process will be executed once when the specified once unlevel is entered.</li> </ul> </li> <li> <p>boot</p> <ul> <li>The process will be executed during system boot. The boot runlevels field is ignored.</li> </ul> </li> <li> <p>bootwait</p> <ul> <li>The process will be executed during system boot, while bootwait <code>init</code> waits for its termination (e.g. <code>/etc/rc)</code>. The runlevels field is ignored.</li> </ul> </li> <li> <p>off</p> <ul> <li>This does absolutely nothing.</li> </ul> </li> <li> <p>ondemand</p> <ul> <li>A process marked with an on demand runlevel will be ondemand executed whenever the specified ondemand runlevel is called. However, no runlevel change will occur (on demand runlevels are \"a\", \"b\", and \"c\").</li> </ul> </li> <li> <p>initdefault</p> <ul> <li>An initdefault entry specifies the runlevel which should initdefault be entered after system boot. If none exists, init will ask for a runlevel on the console. The process field is ignored. In the example above, the system will go to runlevel 2 after boot.</li> </ul> </li> <li> <p>sysinit</p> <ul> <li>The process will be executed during system boot. It will sysinit be executed before any boot or bootwait entries. The runlevels field is ignored.</li> </ul> </li> <li> <p>powerwait</p> <ul> <li>The process will be executed when the power goes down. powerwait <code>init</code> is usually informed about this by a process talking to a UPS connected to the computer. UPS <code>init</code> will wait for the process to finish before continuing.</li> </ul> </li> <li> <p>powerfail</p> <ul> <li>As for powerwait, except that <code>init</code> does powerfail not wait for the process' completion.</li> </ul> </li> <li> <p>powerokwait</p> <ul> <li>This process will be executed as soon as <code>init                                          powerokwait</code> is informed that the power has been restored.</li> </ul> </li> <li> <p>powerfailnow</p> <ul> <li>This process will be executed when <code>init</code> powerfailnow is told that the battery of the external UPS is almost empty and the power is failing (provided that the external UPS and the monitoring process are able to detect this condition).</li> </ul> </li> <li> <p>ctrlaltdel</p> <ul> <li>The process will be executed when <code>init</code> ctrlaltdel receives the SIGINT signal. This means that someone on the system console has pressed the CTRL-ALT-DEL key CTRL-ALT-DEL combination. Typically one wants to execute some sort of shutdown either to get into single-user level or to reboot the machine.</li> </ul> </li> <li> <p>kbdrequest</p> <ul> <li>The process will be executed when init receives a signal from the keyboard handler that a special key combination kbdrequest was pressed on the console keyboard. Basically you want to map some keyboard combination to the \"KeyboardSignal\" action. For example, to map Alt-Uparrow for this purpose use the following in your keymaps file: <code>alt keycode 103 = KeyboardSignal</code>.</li> </ul> </li> </ul> </li> <li> <p>process</p> <ul> <li>This field specifies the process that should be executed. If the process field starts with a \"+\", <code>init</code> will not do <code>utmp</code> and <code>wtmp</code> accounting. Some <code>getty</code>s insist on doing their own housekeeping.</li> </ul> </li> </ul>"},{"location":"lpic2.202.1/#the-etcinitdrc-script","title":"The <code>/etc/init.d/rc</code> script","text":"<p>For each of the runlevels 0-6 there is an entry in <code>/etc/inittab</code> that executes <code>/etc/init.d/rc ?</code> where \"?\" is 0-6, as you can see in following line from /etc/init.d/rc the earlier example above:</p> <pre><code>    l2:2:wait:/etc/init.d/rc 2\n</code></pre> <p>So, what actually happens is that <code>/etc/init.d/rc</code> is called with the runlevel as a parameter.</p> <p>The directory <code>/etc</code> contains several, runlevel specific, directories which in their turn contain runlevel specific symbolic links to scripts in <code>/etc/init.d/</code>. Those directories are:</p> <pre><code>    $ ls -d /etc/rc*\n    /etc/rc.boot  /etc/rc1.d  /etc/rc3.d  /etc/rc5.d  /etc/rcS.d\n    /etc/rc0.d    /etc/rc2.d  /etc/rc4.d  /etc/rc6.d\n</code></pre> <p>As you can see, there also is a <code>/etc/rc.boot</code> directory. This directory is obsolete and has been replaced by the /etc/rcN.d directory <code>/etc/rcS.d</code>. At boot time, the directory <code>/etc/rcS.d</code> is scanned first and then, for backwards compatibility, the <code>/etc/rc.boot</code>.</p> <p>The name of the symbolic link either starts with an \"S\" or with a \"K\". Let's examine the <code>/etc/rc2.d</code> directory:</p> <pre><code>    $ ls /etc/rc2.d\n    K20gpm       S11pcmcia   S20logoutd  S20ssh      S89cron\n    S10ipchains  S12kerneld  S20lpd      S20xfs      S91apache\n    S10sysklogd  S14ppp      S20makedev  S22ntpdate  S99gdm\n    S11klogd     S20inetd    S20mysql    S89atd      S99rmnologin\n</code></pre> <p>If the name of the symbolic link starts with a \"K\", the script is called with \"stop\" as a parameter to stop the process. This is the case for <code>K20gpm</code>, so the command becomes <code>K20gpm stop</code>. Let's find out what program or script is called:</p> <pre><code>    $ ls -l /etc/rc2.d/K20gpm\n    lrwxrwxrwx 1 root root 13 Mar 23 2001 /etc/rc2.d/K20gpm -&gt; ../init.d/gpm\n</code></pre> <p>So, <code>K20gpm stop</code> results in <code>/etc/init.d/gpm stop</code>. Let's see what happens with the \"stop\" parameter by examining part of the script: init scripts</p> <pre><code>    #!/bin/sh\n    #\n    # Start Mouse event server\n    ...\n    case \"$1\" in\n    start)\n       gpm_start\n       ;;\n    stop)\n       gpm_stop\n       ;;\n    force-reload|restart)\n       gpm_stop\n       sleep 3\n       gpm_start\n       ;;\n    *)\n       echo \"Usage: /etc/init.d/gpm {start|stop|restart|force-reload}\"\n       exit 1\n    esac\n</code></pre> <p>In the case..esac the first parameter, $1, is examined and in case its value is \"stop\", <code>gpm_stop</code> is executed.</p> <p>On the other hand, if the name of the symbolic link starts with an \"S\", the script is called with \"start\" as a parameter to start the process.</p> <p>The scripts are executed in a lexical sort order of the filenames. initorder of scripts</p> <p>Let's say we have a daemon <code>SomeDaemon</code>, an accompanying script <code>/etc/init.d/SDscript</code> and we want <code>SomeDaemon</code> to be running when the system is in runlevel 2 but not when the system is in runlevel 3.</p> <p>As you know by now this means we need a symbolic link, starting with an \"S\", for runlevel 2 and a symbolic link, starting with a \"K\", for runlevel 3. We've also determined that the daemon <code>SomeDaemon</code> is to be started after <code>S19someotherdaemon</code>, which implicates S20 and K80 since starting/stopping is symmetrical, i.e. that what is started first is stopped last. This is accomplished with the following set of commands:</p> <pre><code>    # cd /etc/rc2.d\n    # ln -s ../init.d/SDscript S20SomeDaemon\n    # cd /etc/rc3.d\n    # ln -s ../init.d/SDscript K80SomeDaemon\n</code></pre> <p>Should you wish to manually start, restart or stop a process, it is good practice to use the appropriate script in <code>/etc/init.d/</code>, e.g. <code>/etc/init.d/gpm restart</code> to initiate the restart of the process.</p> <p><code>update-rc.d</code> {#scupdatercd}</p>"},{"location":"lpic2.202.1/#update-rcd","title":"update-rc.d","text":"<p>Note This section only applies to Debian (based) distributions</p> <p>Debian-derived Linux distributions use the <code>update-rc.d</code> command to install and remove the init script links mentioned in the previous section.</p> <p>If you have a startup script called \"foobar\" in <code>/etc/init.d/</code> and want to add it to the default runlevels, you can use:</p> <pre><code>    # update-rc.d foobar defaults\n    Adding system startup for /etc/init.d/foobar ...\n     /etc/rc0.d/K20foobar -&gt; ../init.d/foobar\n     /etc/rc1.d/K20foobar -&gt; ../init.d/foobar\n     /etc/rc6.d/K20foobar -&gt; ../init.d/foobar\n     /etc/rc2.d/S20foobar -&gt; ../init.d/foobar\n     /etc/rc3.d/S20foobar -&gt; ../init.d/foobar\n     /etc/rc4.d/S20foobar -&gt; ../init.d/foobar\n     /etc/rc5.d/S20foobar -&gt; ../init.d/foobar\n</code></pre> <p><code>update-rc.d</code> will create K (stop) links in rc0.d, rc1.d and rc6.d, and S (start) links in rc2.d, rc3.d, rc4.d and rc5.d.</p> <p>If you do not want an installed package to start automatically, use <code>update-rc.d</code> to remove the startup links, for example to disable starting <code>dovecot</code> on boot:</p> <pre><code>    # update-rc.d -f dovecot remove\n    Removing any system startup links for /etc/init.d/dovecot ...\n     /etc/rc2.d/S24dovecot\n     /etc/rc3.d/S24dovecot\n     /etc/rc4.d/S24dovecot\n     /etc/rc5.d/S24dovecot\n</code></pre> <p>The <code>-f</code> (force) option is required if the rc script still exists. If you install an updated <code>dovecot</code> package, the links will be restored. To prevent this create \"stop\" links in the startup runlevel directories:</p> <pre><code>    # update-rc.d -f dovecot stop 24 2 3 4 5 .\n    Adding system startup for /etc/init.d/dovecot ...\n     /etc/rc2.d/K24dovecot -&gt; ../init.d/dovecot\n     /etc/rc3.d/K24dovecot -&gt; ../init.d/dovecot\n     /etc/rc4.d/K24dovecot -&gt; ../init.d/dovecot\n     /etc/rc5.d/K24dovecot -&gt; ../init.d/dovecot\n</code></pre> <p>Note Don't forget the trailing . (dot).</p>"},{"location":"lpic2.202.1/#using-systemd-targets","title":"Using systemd targets","text":"<p>Instead of predefined runlevels, systemd uses targets to define the system state. These targets are represented by target units. Target units end with the <code>.target</code> file extensions and their only purpose is to group together other systemd units through a chain of dependencies. This also means that, in comparison to the init runlevels, multiple targets can be active at the same time.</p> <p>For example, the graphical.target unit, start services as the GNOME Display Manager but also depends on multi-user.target (which is the non-graphical system state) which in turn depends on basic.target.</p> <p>Before we will continue with managing and using the targets you should know which directories are used to store the default target files and how you can override them.</p> <p>As with all units the default target files are stored in <code>/usr/lib/systemd</code>, the files in this directory are created by the vendor of the software you've installed and these should never be changed except by installation scripts. The directory where you can store you custom targets and overrides is <code>/etc/systemd</code>, everything written in this directory takes precendence over the files in <code>/usr/lib/systemd</code>.</p> <p>There are multiple ways to override or append properties to unit files. You can create a completely new file with the same name, for example ssh.server, in the <code>/etc/systemd/system</code>. This will override the complete unit definition. If you only want to append or change some properties you can create a new directory in <code>/etc/systemd/system</code> with the name of the unit with <code>.d</code> appended, for example sshd.server.d. In this directory you can create files with a <code>.conf</code> extension in which you can place the properties you lik to append or override. Both of these ways can also be done by using the <code>systemctl</code> command, this is further described in chaper 206.3.</p> <p>There is also a third location available in which you can place files to override your unit definitions, this is the <code>/run/systemd</code> directory. Definitions in this directory take precedence over the files in <code>/usr/lib/systemd</code> but not over those in <code>/etc/systemd</code>. Overrides in <code>/run/systemd</code> will only be used until the system is rebooted since all files in <code>/run/systemd</code> will be deleted at a reboot of the system.</p> <p>systemd-delta To get an overview of all overrides active you can use the <code>systemd-delta</code> command. This command can return the following types:</p> <ul> <li> <p>masked</p> <ul> <li>Masked units, units that can't be started.</li> </ul> </li> <li> <p>equivalent</p> <ul> <li>Overridden files that do not differ in content.</li> </ul> </li> <li> <p>redirected</p> <ul> <li>Symbolic links to other unit files.</li> </ul> </li> <li> <p>overridden</p> <ul> <li>Overridden unit files.</li> </ul> </li> <li> <p>extended</p> <ul> <li>Extended unit files using a .conf file.</li> </ul> </li> </ul> <p>You can also filter by the types above using the <code>-t</code> of <code>--type=</code> flags, these take a list of the above types. If you also want to see unchanged files you can add <code>unchanged</code> as a type. Other options you can use are <code>--diff=false</code> if you don't want <code>systemd-delta</code> to show the diffs of overridden files, and <code>--no-pager</code> if you don't want the output piped to a pager.</p> <p>Now that we know where the unit files are stored and how we can override them we can take a look at changing system states.</p> <p>For getting and changing the (default) system state we use the <code>systemctl</code> command. A full explanation of the possibilities for this command can be found in chapter 206.3.</p> <p>If we want to get the default target we can run the following command:</p> <pre><code>    $ systemctl get-default\n</code></pre> <p>This will output the current default target which is used at boot. To get a list of all currently loaded target units you can run the following commandL</p> <pre><code>    $ systemctl list-units --type=target\n</code></pre> <p>This will give you a list of all currently active targets. To get all available target units you can run the following command:</p> <pre><code>    $ systemctl list-unit-files --type=target\n</code></pre> <p>If you want to change the default target you can use the <code>systemctl set-default</code> command. For example, to set the default target to multi-user.target you can run the following command:</p> <pre><code>    $ systemctl set-default multi-user.target\n</code></pre> <p>This command will create a symbolic link <code>/etc/systemd/system/default.target</code> which links to the target file in <code>/usr/lib/systemd/system</code>.</p> <p>A comparison between the init runlevels and the system targets:</p> Runlevel Target Description 0 runlevel0.target, poweroff.target Shutdown and poweroff the system. 1 runlevel1.target, rescue.target Set up a rescue shell. 2 runlevel2.target, multi-user.target Set up a non-graphical multi-user system. 3 runlevel3.target, multi-user.target Set up a non-graphical multi-user system. 4 runlevel4.target, multi-user.target Set up a non-graphical multi-user system. 5 runlevel5.target, graphical.target Set up a graphical multi-user system. 6 runlevel6.target, reboot.target Shutdown and reboot the system. <p>You can also change the system state at runtime, this can be done using the <code>systemctl isolate</code> command. This will stop all services not defined for the chosen target, and start all the services that are defined for the target.</p> <p>For example, to go to rescue mode, you can run the following command:</p> <pre><code>    $ systemctl isolate rescue.target\n</code></pre> <p>This will stop all services except those defined for the rescue target. Note that this command will not notify any logged in users of the action.</p> <p>There are also some shortcuts available to change the system state, these have an added bonus that they will notify the logged in users of the action. For example, another way to get the system into rescue mode is the following:</p> <pre><code>    $ systemctl rescue\n</code></pre> <p>This will first notify the logged in users of the action and then stop all services not defined in the target. If you don't want the users to get notified you can add the <code>--no-wall</code> flag.</p> <p>If your system is too broken to use rescue mode there is also an emergency mode available. This can be started by using the following command:</p> <pre><code>    $ systemctl emergency\n</code></pre> <p>If you want to start certain services at boot you have to enable them. You can enable services using the <code>systemctl enable</code> command. For example, to enable sshd you run the following command:</p> <pre><code>    $ systemctl enable sshd.service\n</code></pre> <p>To disable the service again you use <code>systemctl disable</code>. For example:</p> <pre><code>    $ systemctl disable sshd.service\n</code></pre> <p>The unit file of the service defines at which system state the service will be running. This is configured by setting the <code>WantedBy=</code> option under the <code>[Install]</code> section. If this is set to <code>multi-user.target</code> than it will run in both non-graphical as graphical mode.</p>"},{"location":"lpic2.202.1/#the-lsb-standard","title":"The LSB standard","text":"<p>The Linux Standard Base (LSB) defines an interface for application programs that are compiled and packaged for LSB-conforming implementations. Hence, a program which was compiled in an LSB compatible environment will run on any distribution that supports the LSB standard. LSB compatible programs can rely on the availability of certain standard libraries. The standard also includes a list of mandatory utilities and scripts which define an environment suitable for installation of LSB-compatible binaries.</p> <p>The specification includes processor architecture specific information. This implies that the LSB is a family of specifications, rather than a single one. In other words: if your LSB compatible binary was compiled for an Intel based system, it will not run on, for example, an Alpha based LSB compatible system, but will install and run on any Intel based LSB compatible system. The LSB specifications therefore consist of a common and an architecture-specific part; \"LSB-generic\" or \"generic LSB\" and \"LSB-arch\" or \"archLSB\".</p> <p>The LSB standard lists which generic libraries should be available, e.g. <code>libdl</code>, <code>libcrypt</code>, <code>libpthread</code> and so on, and provides a list of processor specific libraries, like <code>libc</code> and <code>libm</code>. The standard also lists searchpaths for these libraries, their names and format (ELF). Another section handles the way dynamic linking should be implemented. For each standard library a list of functions is given, and data definitions and accompanying header files are listed.</p> <p>The LSB defines a list of 130+ commands that should be available on an LSB compatible system, and their calling conventions and behaviour. Some examples are <code>cp</code>, <code>tar</code>, <code>kill</code> and <code>gzip</code>, and the runtime languages <code>perl</code> and <code>python</code>.</p> <p>The expected behaviour of an LSB compatible system during system initialization is part of the LSB specification. So is a definition of the <code>cron</code> system, and are actions, functions and location of the <code>init</code> scripts. Any LSB compliant init script should be able to handle the following options: <code>start</code>, <code>stop</code>, <code>restart</code>, <code>force-reload</code> and <code>status</code>. The <code>reload</code> and <code>try-restart</code> options are optional. The standard also lists the definitions for runlevels and listings of user- and groupnames and their corresponding UID's/GID's.</p> <p>Though it is possible to install an LSB compatible program without the use of a package manager (by applying a script that contains only LSB compliant commands), the LSB specification contains a description for software packages and their naming conventions.</p> <p>Note LSB employs the Red Hat Package Manager standard. Debian based LSB compatible distributions may read RPM packages by using the <code>alien</code> command.</p> <p>The LSB standards frequently refers to other well known standards, for example ISO/IEC 9945-2009 (Portable OS base, very Unix like). Any LSB conforming implementation needs to provide the mandatory portions of the file system hierarchy as specified in the Filesystem Hierarchy Standard (FHS), and a number of LSB specific requirements. See also the section on the FHS standard.</p>"},{"location":"lpic2.202.1/#the-bootscript-environment-and-commands","title":"The bootscript environment and commands","text":"<p>Initially, Linux contained only a limited set of services and had a very simple boot environment. As Linux aged and the number of services in a distribution grew, the number of initscripts grew accordingly. After a while a set of standards emerged. Init scripts would routinely include some other script, which contained functions to start, stop and verify a process.</p> <p>The LSB standard lists a number of functions that should be made available for runlevel scripts. These functions should be listed in files in the directory <code>/lib/lsb/init-functions</code> and need to implement (at least) the following functions:</p> <ol> <li> <p><code>start_daemon</code> <code>[-f] [-n nicelevel]                              [-p pidfile]</code> <code>pathname</code> <code>[args...]</code></p> <p>runs the specified program as a daemon. The <code>start_daemon</code> function will check whether the program is already running. If so, it will not start another copy of the daemon unless the <code>-f</code> option is given. The <code>-n</code> option specifies a nice level.</p> </li> <li> <p><code>killproc</code> <code>[-ppidfile]</code> <code>pathname</code> <code>[signal]</code></p> <p>will stop the specified program, trying to terminate it using the specified signal first. If that fails, the <code>SIGTERM</code> signal will be sent. If a program has been terminated, the <code>pidfile</code> should be removed if the terminated process has not already done so.</p> </li> <li> <p><code>pidofproc</code> <code>[-p pidfile]</code> <code>pathname</code></p> <p>returns one or more process identifiers for a particular daemon, as specified by the pathname. Multiple process identifiers are separated by a single space.</p> </li> </ol> <p>In some cases, these functions are provided as stand-alone commands and the scripts simply assure that the path to these scripts is set properly. Often some logging functions and function to display status lines are also included.</p>"},{"location":"lpic2.202.1/#changing-and-configuring-runlevels","title":"Changing and configuring runlevels","text":"<p>Changing runlevels on a running machine requires comparison of the services running in the current runlevel with those that need to be run in the new runlevel. Subsequently, it is likely that some processes need to be stopped and others need to be started.</p> <p>Recall that the initscripts for a runlevel \"X\" are grouped in directory <code>/etc/rc.d/rcX.d</code> (or, on newer (LSB based) systems, in <code>/etc/init.d/rcX.d</code>). The filenames determine how the scripts are called: if the name starts with a \"K\", the script will be run with the <code>stop</code> option, if the name starts with a \"S\", the script will be run with the <code>start</code> option. The normal procedure during a runlevel change is to stop the superfluous processes first and then start the new ones.</p> <p>The actual init scripts are located in <code>/etc/init.d</code>. The files you find in the <code>rcX.d</code> directory are symbolic links which link to these. In many cases, the start- and stop-scripts are symbolic links to the same script. This implies that such init scripts should be able to handle at least the <code>start</code> and <code>stop</code> options.</p> <p>For example, the symbolic link named <code>S06syslog</code> in <code>/etc/init.d/rc3.d</code> might point to the script <code>/etc/init.d/syslog</code>, as may the symbolic link found in <code>/etc/init.d/rc2.d</code>, named <code>K17syslog</code>.</p> <p>The order in which services are stopped or started can be of great importance. Some services may be started simultaneously, others need to start in a strict order. For example your network needs to be up before you can start the <code>httpd</code>. The order is determined by the names of the symbolic links. The naming conventions dictate that the names of init scripts (the ones found in the <code>rcN.d</code> directories) include two digits, just after the initial letter. They are executed in alphabetical order.</p> <p>In the early days system administrators created these links by hand. Later most Linux distributors decided to provide Linux commands/scripts which allow the administrator to disable or enable certain scripts in certain runlevels and to check which systems (commands) would be started in which runlevel. These commands typically will manage both the aforementioned links and will name these in such a way that the scripts are run in the proper order.</p>"},{"location":"lpic2.202.1/#the-chkconfig-command","title":"The <code>chkconfig</code> command","text":"<p>Another tool to manage the proper linking of start up (init) scripts is <code>chckconfig</code>. On some systems (e.g. SuSE/Novell) it serves as a front-end for <code>insserv</code> and uses the LSB standardized comment block to maintain its administration. On older systems it maintains its own special comment section, that has a much simpler and less flexible syntax. This older syntax consists of two lines, one of them is a description of the service, it starts with the keyword <code>description:</code>. The other line starts with the keyword <code>chkconfig:</code>, and lists the run levels for which to start the service and the priority (which determines in what order the scripts will be run while changing runlevels). For example:</p> <pre><code>    # Init script for foo daemon\n    #\n    # description: food, the foo daemon\n    # chkconfig: 2345 55 25\n    #\n    #\n</code></pre> <p>This denotes that the <code>foo</code> daemon will start in runlevels 2, 3, 4 and 5, will have priority 55 in the queue of initscripts that are run during startup and priority 25 in the queue of initscripts that are run if the daemon needs to be stopped.</p> <p>The <code>chkconfig</code> utility can be used to list which services will be started in which runlevels, to add a service to or to delete it from a runlevel and to add an entire service to or to delete it from the startup scripts.</p> <p>Note We are providing some examples here, but be warned: there are various versions of <code>chkconfig</code> around. Please read the manual pages for the <code>chkconfig</code> command on your distribution first.</p> <p><code>chkconfig</code> does not automatically disable or enable a service immediately, but simply changes the symbolic links. If the <code>cron</code> daemon is running and you are on a Red Hat based system which is running in runlevel 2, the command</p> <pre><code>    # chkconfig --levels 2345 crond off\n</code></pre> <p>would change the administration but would not stop the <code>cron</code> daemon immediately. Also note that on a Red Hat system it is possible to specify more than one runlevel, as we did in our previous example. On Novell/SuSE systems, you may use:</p> <pre><code>    # chkconfig food 2345\n</code></pre> <p>and to change this so it only will run in runlevel 1 simply use</p> <pre><code>    # chkconfig food 1\n\n\n    # chkconfig --list\n</code></pre> <p>will list the current status of services and the runlevels in which they are active. For example, the following two lines may be part of the output:</p> <pre><code>    xdm                       0:off   1:off   2:off   3:off   4:off   5:on    6:off\n    xfs                       0:off   1:off   2:off   3:off   4:off   5:off   6:off\n</code></pre> <p>They indicate that the xfs service is not started in any runlevel and the xdm service only will be started while switching to runlevel 5.</p> <p>To add a new service, let's say the <code>foo</code> daemon, we create a new init script and name it after the service, in this case we might use <code>food</code>. This script is consecutively put into the <code>/etc/init.d</code> directory, after which we need to insert the proper header in that script (either the old <code>chkconfig</code> header, or the newer LSB compliant header) and then run</p> <pre><code>    # chkconfig --add food\n</code></pre> <p>To remove the <code>foo</code> service from all runlevels, you may type:</p> <pre><code>    # chkconfig --del food\n</code></pre> <p>Note, that the <code>food</code> script will remain in the <code>/etc/init.d/</code> directory.</p>"},{"location":"lpic2.202.2/","title":"System recovery (202.2)","text":""},{"location":"lpic2.202.2/#system-recovery-2022","title":"System recovery (202.2)","text":""},{"location":"lpic2.202.2/#lpic2.202.2.objectives","title":"Objectives","text":"<p>Candidates should be able to properly manipulate a Linux system during both the boot process and during recovery mode. This objective includes using both the init utility and init-related kernel options. Candidates should be able to determine the cause of errors in loading and usage of bootloaders. GRUB version 2 and GRUB Legacy are the bootloaders of interest.</p>"},{"location":"lpic2.202.2/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>GRUB version 2 and Legacy</p> </li> <li> <p>Grub shell</p> </li> <li> <p>Boot loader start and hand off to kernel</p> </li> <li> <p>Kernel loading</p> </li> <li> <p>Hardware initialisation and setup</p> </li> <li> <p>Daemon/service initialisation and setup</p> </li> <li> <p>Know the different boot loader install locations on a hard disk or     removable device</p> </li> <li> <p>Overwriting standard boot loader options and using boot loader     shells</p> </li> <li> <p>Awareness of UEFI</p> </li> <li> <p>UEFI and NVMe booting</p> </li> </ul>"},{"location":"lpic2.202.2/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>mount</code></p> </li> <li> <p><code>fsck</code></p> </li> <li> <p><code>inittab</code>, <code>telinit</code> and <code>init</code> with SysV init</p> </li> <li> <p>The contents of <code>/boot/</code> and <code>/boot/grub/</code></p> </li> <li> <p>GRUB</p> </li> <li> <p><code>grub-install</code></p> </li> <li> <p><code>initrd</code>, <code>initramfs</code></p> </li> <li> <p>Master boot record</p> </li> </ul>"},{"location":"lpic2.202.2/#grub-explained","title":"GRUB explained","text":"<p>GRUB (short for GRand Unified Bootloader) loads the operating system kernel and transfers execution control to it.</p> <p>Two major versions of GRUB exist. The current version is known as GRUB but is in fact GRUB 2. GRUB has been developed around 2011. The older version was developed back in 1999 and is now referred to as GRUB Legacy. GRUB Legacy is still in use but its development has been frozen.</p>"},{"location":"lpic2.202.2/#grub-2","title":"GRUB 2","text":"<p>GRUB is a modular bootloader and supports booting from PC UEFI, PC BIOS and other platforms. The advantage of its modular design is that as new filesystems and/or storage solutions are added to the kernel, boot support can easily be added to GRUB 2 in separate modules.</p> <p>Examples of boot support added by such modules are modules for filesystem support (like ext4, NTFS, btrf and zfs), and LVM and software RAID devices.</p> <p>GRUB is able to boot many operating systems, both free and proprietary ones. Open operating systems, like FreeBSD, NetBSD, OpenBSD, and Linux, are supported by GRUB directly. Proprietary kernels (e.g. DOS, Windows and OS/2) are supported using GRUB's chain-loading function. Chain-loading implies that GRUB will be used to boot the system, and in turn will load and run the proprietary systems bootloader, which then boots the operating system.</p> <p>The GRUB boot process features both a menu interface and a command-line interface (CLI). The CLI called is called the GRUB shell and allows you to execute commands to select a root device (<code>root</code> command), load a kernel from it (<code>linux</code> command) and, if necessary load some additional kernel modules (<code>insmod</code>) and subsequently boot the kernel (<code>boot</code> command). The menu interface offers a quick selection method of the desired runtime environment. While booting, both interfaces are available. On boot the menu is displayed, and the user can simply choose one of the menu entries. Without user interaction, the system will boot the default entry after a pre-defined time value has passed.</p> <p>Alternatively, the user can hit e to edit the current entry before booting, or hit c to enter the CLI. Some Linux distributions hide the GRUB screen during boot. Pressing the SHIFT key right after BIOS/UEFI initialization will unhide the GRUB screen.</p> <p>After invoking the GRUB shell, the user can type commands from the list below. The list of commands may vary, and depends on which modules are present on the system. The <code>help</code> command will produce a list of available commands.</p> <pre><code>o acpi:                 Load ACPI tables\no badram:               Filter out bad regions of RAM\no blocklist:            Print a block list\no boot:                 Start up your operating system\no cat:                  Show the contents of a file\no chainloader:          Chain-load another boot loader\no cmp:                  Compare two files\no configfile:           Load a configuration file\no cpuid:                Check for CPU features\no crc:                  Calculate CRC32 checksums\no date:                 Display or set current date and time\no drivemap:             Map a drive to another\no echo:                 Display a line of text\no export:               Export an environment variable\no false:                Do nothing, unsuccessfully\no gettext:              Translate a string\no gptsync:              Fill an MBR based on GPT entries\no halt:                 Shut down your computer\no help:                 Show help messages\no initrd:               Load a Linux initrd\no initrd16:             Load a Linux initrd (16-bit mode)\no insmod:               Insert a module\no keystatus:            Check key modifier status\no linux:                Load a Linux kernel\no linux16:              Load a Linux kernel (16-bit mode)\no list_env:             List variables in environment block\no load_env:             Load variables from environment block\no loopback:             Make a device from a filesystem image\no ls:                   List devices or files\no normal:               Enter normal mode\no normal_exit:          Exit from normal mode\no parttool:             Modify partition table entries\no password:             Set a clear-text password\no password_pbkdf2:      Set a hashed password\no play:                 Play a tune\no pxe_unload:           Unload the PXE environment\no read:                 Read user input\no reboot:               Reboot your computer\no save_env:             Save variables to environment block\no search:               Search devices by file, label, or UUID\no sendkey:              Emulate keystrokes\no set:                  Set an environment variable\no true:                 Do nothing, successfully\no unset:                Unset an environment variable\no uppermem:             Set the upper memory size\n</code></pre> <p>GRUB uses its own syntax to describe hard disks. Device names need to be enclosed in brackets, e.g</p> <pre><code>    (fd0)\n</code></pre> <p>denotes the floppy disk, and</p> <pre><code>    (hd0,1)\n</code></pre> <p>denotes the first partition on the first hard disk. Note that while disk numbers start at zero, partition numbers start at one, so the last example references the first disk and the first partition.</p> <p>GRUB uses the computer BIOS to find out which hard drives are available. But it can not always figure out the relation between Linux device filenames and the BIOS drives. The special file <code>/boot/grub/device.map</code> can be created to map these, e.g.:</p> <pre><code>    (fd0)  /dev/fd0\n    (hd0)  /dev/hda\n</code></pre> <p>Note that when you are using software RAID-1 (mirroring), you need to set up GRUB on both disks. Upon boot, the system will not be able to use the software RAID system yet, so booting can only be done from one disk. If you only set up GRUB on the first disk and that disk would be damaged, the system would not be able to boot.</p>"},{"location":"lpic2.202.2/#grub-configuration-file","title":"GRUB Configuration File","text":"<p>The configuration file for GRUB 2 is <code>/boot/grub/grub.cfg</code>. The GRUB configuration file is written in a shell-like scripting language with conditional statements and functions.</p> <p>It is not recommended to modify <code>grub.cfg</code> directly; the configuration file is updated whenever a kernel is added, updated, or removed using the package manager of the distribution or when the user runs the <code>update-grub</code> script. The <code>update-grub</code> is a wrapper around <code>grub-mkconfig</code>, specifying <code>grub.cfg</code> as its output file. The behaviour of <code>grub-mkconfig</code> is controlled by files in the directory <code>/etc/grub.d</code> and keywords in the <code>/etc/default/grub</code> file.</p> <p>Examples keywords: the default menu entry to boot (GRUB_DEFAULT) or the timeout in seconds to boot the default menu entry after the menu is displayed (GRUB_TIMEOUT).</p> <p>Operating systems, including foreign operating systems like Windows are automatically detected by the <code>/etc/grub.d/30_os_prober</code> script. A custom file (by default <code>40_custom</code>) can be modified by the user to create custom entries.</p> <p>GRUB 2 menu entries start with the <code>menuentry</code> keyword. The menu entry's title can be found within quotation marks on the <code>menuentry</code> line. The <code>menuentry</code> line ends with an opening curly brace ({). The menu entry ends with a closing curly brace (}).</p> <p>A very simple example:</p> <pre><code>    menuentry 'Linux 3.3.10' {\n    &lt;... &gt;\n    }\n</code></pre>"},{"location":"lpic2.202.2/#differences-with-grub-legacy","title":"Differences with GRUB Legacy","text":"<p>At first glance, the two versions do not differ much. However, there are some obvious differences:</p> <ul> <li> <p>The GRUB configuration file is now called <code>/boot/grub/menu.list</code>,     while Red Hat based distributions favor the <code>/boot/grub/grub.conf</code>     filename. Besides the slightly different name, the configuration     file also has a different syntax. The grub.cfg file is now generated     during grub-install, and is not supposed to be edited by hand.</p> </li> <li> <p>The core GRUB engine is smaller and less platform dependent. Support     for many different filesystems and platforms is now available in     separate modules. As a consequence, the platform, and filesystem(s)     in use determine the modules loaded during the boot sequence. In     contrast, GRUB Legacy has a fixed boot sequence with critical     components hardcoded, making it less flexible.</p> </li> <li> <p>Partition numbering starts at 1 in GRUB 2, rather than 0. Disks are     still numbered from 0. This can be a bit confusing.</p> </li> <li> <p>GRUB 2 kernel specification is done with the <code>linux</code> command, while     in GRUB Legacy, we use the <code>kernel</code> command instead.</p> </li> <li> <p>The root device can be selected with <code>set root</code> in stead of the     <code>root</code> command. The root device can also be set from the <code>search</code>     command which can find devices by disk label or UUID.</p> </li> <li> <p>GRUB 2 uses <code>insmod</code> to load modules. In GRUB Legacy modules are     loaded with <code>module</code> or <code>modulenounzip</code>.</p> </li> </ul>"},{"location":"lpic2.202.2/#grub-legacy","title":"GRUB Legacy","text":"<p>The GRUB Legacy definitions for the menu-entries are stored in <code>/boot/grub/menu.lst</code>. On some systems you may find a <code>grub.conf</code> (not to be confused with GRUB 2 <code>grub.cfg</code> config file) link in the <code>/etc</code> or <code>/boot/grub</code> directory. Because GRUB accesses the file directly, any changes in that file will impact the bootloader immediately.</p> <p>On systems with the Legacy bootloader, GRUB shell is available to install and emulate it. This shell emulates the boot loader and can be used to install the boot loader. It also comes in handy to inspect your current set up and modify it. To start it up (as <code>root</code>) simply type <code>grub</code>. In the following example we display the help screen:</p> <pre><code>    # grub\n    grub&gt; help\n    blocklist FILE                         boot\n    cat FILE                               chainloader [--force] FILE\n    color NORMAL [HIGHLIGHT]               configfile FILE\n    device DRIVE DEVICE                    displayapm\n    displaymem                             find FILENAME\n    geometry DRIVE [CYLINDER HEAD SECTOR [ halt [--no-apm]\n    help [--all] [PATTERN ...]             hide PARTITION\n    initrd FILE [ARG ...]                  kernel [--no-mem-option] [--type=TYPE]\n    makeactive                             map TO_DRIVE FROM_DRIVE\n    md5crypt                               module FILE [ARG ...]\n    modulenounzip FILE [ARG ...]           pager [FLAG]\n    partnew PART TYPE START LEN            parttype PART TYPE\n    quit                                   reboot\n    root [DEVICE [HDBIAS]]                 rootnoverify [DEVICE [HDBIAS]]\n    serial [--unit=UNIT] [--port=PORT] [-- setkey [TO_KEY FROM_KEY]\n    setup [--prefix=DIR] [--stage2=STAGE2_ terminal [--dumb] [--timeout=SECS] [--\n    testvbe MODE                           unhide PARTITION\n    uppermem KBYTES                        vbeprobe [MODE]\n\n    grub &gt;_\n</code></pre> <p>Note Note that the grub shell is not available for GRUB 2. Instead, you can install the Grub Emulator, <code>grub-emu</code>.</p> <p>Other GRUB Legacy commands include the <code>blocklist</code> command, which can be used to find out on which disk blocks a file is stored, or the <code>geometry</code> command, which can be used to find out the disk geometry. You can create new (primary) partitions using the <code>partnew</code> command, load an <code>initrd</code> image using the <code>initrd</code> command, and many more. All options are described in the GRUB documentation. GRUB is part of the GNU software library and as such is documented using the <code>info</code> system. On most systems there is a limited <code>man</code> page available as well.</p> <p>The initial boot process , upon boot, the BIOS accesses the initial sector of the hard disk, the so-called MBR (Master Boot Record), loads the data found there in memory and transfers execution to it. If GRUB is used, the MBR contains a copy of the first stage of GRUB, which tries to load stage 2.</p> <p>To be able to load stage 2, GRUB needs to have access to code to handle the filesystem(s). There are many filesystem types and the code to handle them will not fit within the 512 byte MBR, even less so since the MBR also contains the partitioning table. The GRUB parts that deal with filesystems are therefore stored in the so-called DOS compatibility region. That region consists of sectors on the same cylinder where the MBR resides (cylinder 0). In the old days, when disks were adressed using the CHS (Cylinder/Head/Sector) specification, the MBR typically would load DOS. DOS requires that its image is on the same cylinder. Therefore, by tradition, the first cylinder on a disk is reserved and it is this space that GRUB uses to store the filesystem code. That section is referred to as stage 1.5. Stage 1.5 is commonly referred to as the <code>core.img</code>; it is constructed from several files by the installer, based on the filesystem(s) grub needs to support during boot.</p> <p>Stage 2 contains most of the boot-logic. It presents a menu to the end-user and an additional command prompt, where the user can manually specify boot-parameters. GRUB is typically configured to automatically load a particular kernel after a timeout period. Once the end-user made his/her selection, GRUB loads the selected kernel into memory and passes control on to the kernel. At this stage GRUB can pass control of the boot process to another loader using chain loading if required by the operating system.</p> <p>grub-install In Linux, the <code>grub-install</code> command is used to install stage 1 to either the MBR or within a partition.</p>"},{"location":"lpic2.202.2/#influencing-the-regular-boot-process","title":"Influencing the regular boot process","text":"<p>The regular boot process is the process that normally takes place when GRUB (re)booting the system. This process can be influenced by the GRUB prompt. What can be influenced will be discussed in the following sections, but first we must activate the prompt.</p>"},{"location":"lpic2.202.2/#choosing-another-kernel","title":"Choosing another kernel","text":"<p>If you have just compiled a new kernel and you are experiencing difficulties with the new kernel, chances are that you would like to revert to the old kernel.</p> <p>For GRUB, once you see the boot screen, use the cursor keys to select the kernel you would like to boot, and press Enter to boot it.</p>"},{"location":"lpic2.202.2/#booting-into-single-user-mode-or-a-specific-runlevel","title":"Booting into single user mode or a specific runlevel","text":"<p>This can be useful if, for instance, you have installed a graphical environment which is not functioning properly. You either do not see anything at all or the system does not reach a finite state because is keeps trying to start X over and over again.</p> <p>Booting into single user mode or into another runlevel where the single user mode graphical environment is not running will give you access to the system so you can correct the problem.</p> <p>To boot into single user mode in GRUB, point the cursor to the kernel entry you would like to boot and press e. Then select the line starting with \"linux\" (for GRUB 2) or \"kernel\" in GRUB Legacy. Go to the end of the line, and add \"single\". After that, press Enter to exit the editing mode and then press [CTRL+x]{.keycombo} (GRUB 2), or b in GRUB Legacy to exit the editor and boot that entry.</p>"},{"location":"lpic2.202.2/#switching-runlevels","title":"Switching runlevels","text":"<p>telinit It is possible in Linux to switch to a different runlevel than the currently active one. This is done through the <code>telinit</code> command. It's syntax is simple: telinit [OPTION] RUNLEVEL where RUNLEVEL is the number of the runlevel.</p> <p>The only option which <code>telinit</code> supports is <code>-e KEY=VALUE</code>. It is used to specify an additional environment variable to be included in the event along with RUNLEVEL and PREVLEVEL. Usually you will not use this option.</p> <p>You will find you use <code>telinit</code> mostly to switch to single-user mode (runlevel 1), for example to be able to umount a filesystem and <code>fsck</code> it. In that case you can use:</p> <pre><code>    # telinit 1\n</code></pre> <p>telinit Note that <code>telinit</code> on most systems is a symbolic link to the <code>init</code> command.</p> <p>init Use of the command <code>/sbin/init q</code> forces init to reload <code>/etc/inittab</code>.</p> <p>inittab</p>"},{"location":"lpic2.202.2/#passing-parameters-to-the-kernel","title":"Passing parameters to the kernel","text":"<p>If a device doesn't work:</p> <p>A possible cause can be that the device driver in the kernel has to be told to use another irq and/or another I/O port. This is only applicable if support for the device has been compiled into the kernel, not if you are using a loadable module.</p> <p>As an example, let us pretend we have got a system with two identical ethernet-cards for which support is compiled into the kernel. By default only one card will be detected, so we need to tell the driver in the kernel to probe for both cards. Suppose the first card is to become eth0 with an address of 0x300 and an irq of 5 and the second card is to become eth1 with an irq of 11 and an address ether= of 0x340. For GRUB, you can add the additions the same way as booting into single-user mode, replacing the keyword \"single\" by the parameters you need pass.</p> <p>For the example above, the keywords to pass to the kernel would be:</p> <pre><code>    ether=5,0x300,eth0 ether=11,0x340,eth1\n</code></pre>"},{"location":"lpic2.202.2/#lpic2.202.boot.rescue","title":"The Rescue Boot process","text":""},{"location":"lpic2.202.2/#lpic2.202.fsckfail","title":"When <code>fsck</code> is started but fails","text":"<p>During boot file systems are checked. On a Debian system this is done by fsck <code>/etc/rcS.d/S30check.fs</code>. All filesystems are checked based on the contents of <code>/etc/fstab</code>.</p> <p>If the command <code>fsck</code> returns an exit status larger than 1, the command has failed. The exit status is the result of one or more of the following conditions:</p> <pre><code>    0    - No errors\n    1    - File system errors corrected\n    2    - System should be rebooted\n    4    - File system errors left uncorrected\n    8    - Operational error\n    16   - Usage or syntax error\n    128  - Shared library error\n</code></pre> <p>If the command has failed you wil get a message:</p> <pre><code>    fsck failed. Please repair manually\n\n    \"CONTROL-D\" will exit from this shell and\n    continue system startup.\n</code></pre> <p>If you do not press [Ctrl+D]{.keycombo} but enter the root password, you will get a shell, in fact <code>/sbin/sulogin</code> is launched, and you should be /sbin/sulogin able to run <code>fsck</code> and fix the problem if the root filesystem is mounted read-only.</p> <p>Alternatively (see next section) you can boot from boot media.</p>"},{"location":"lpic2.202.2/#if-your-root-filesystem-is-corrupt","title":"If your root (/) filesystem is corrupt","text":""},{"location":"lpic2.202.2/#using-the-distributions-bootmedia","title":"Using the distribution's bootmedia","text":"<p>A lot of distributions come with one or more CD's or boot images which can be put on a USB stick. One of these CD's usually contains a \"rescue\" option to boot Linux in core. This allows you to fix things.</p> <p>Remember to set the boot-order in the BIOS to boot from CD-ROM or USB stick first and then HDD. In the case of a USB stick it may also be necessary to enable \"USB Legacy Support\" in the bios.</p> <p>What the rescue mode entails is distribution specific. But it should allow you to open a shell with root-privileges. There you can run <code>fsck</code> on the unmounted corrupt filesystem.</p> <p>Let's assume your root partition was <code>/dev/sda2</code>. You can then run a filesystem check on the root filesystem by typing <code>fsck -y                     /dev/sda2</code>. The \"-y\" flag prevents <code>fsck</code> from asking questions which you must answer (this can result in a lot of Enters) and causes <code>fsck</code> to use \"yes\" as an answer to all questions.</p> <p>mount Although the root (/) filesystem of a rescue image is completely in RAM, you can <code>mount</code> a filesystem from harddisk on an existing mountpoint in RAM, such as <code>/target</code>. Or, you can create a directory first and then <code>mount</code> a harddisk partition there.</p> <p>After you corrected the errors, do not forget to <code>umount</code> the filesystems you have mounted before you reboot the system, otherwise you will get a message during boot that one or more filesystems have not been cleanly umounted and <code>fsck</code> will try to fix it again.</p>"},{"location":"lpic2.202.2/#uefi-and-nvme-boot-considerations","title":"UEFI and NVMe boot considerations","text":"<p>For many decades, the system BIOS (Basic Input Output System) took care of hardware and software initialization during the boot process. Early BIOS versions required manual configuration of physical jumpers on the motherboard. Later versions replaced the manual jumper routine by a software menu, capable of providing an interface to configure the most elementary computer settings. As convenient as this may sound, the constant evolution of computer systems evolved to a point where even the most sophisticated BIOS software proved to have its limitations. To combat these limitations, Intel developed the EFI (Extensible Firmware Interface) system in 1998 as a BIOS replacement. The EFI system dit not catch on, until the standard was adopted by the UEFI Forum around 2005. The standard was then (re)branded from EFI to UEFI (Universal Extensible Firmware Interface). UEFI is sometimes also referred to as (U)EFI. Linux kernel 3.15 and newer should be able to use the UEFI advantages.</p> <p>What are these advantages you may ask? To answer that question we have to look at the BIOS limitations first. One of the limitations of BIOS systems is noticable when booting operating systems. Traditionally, a BIOS can be configured to use one or more boot devices in a specific order. A boot device can be an optical drive, a harddrive, a portable USB volume or a network interface card. After the BIOS has performed the POST (Power On Self Test), each configured boot device will be checked for the existence of a boot loader. The first bootloader detected will be loaded. In case of a harddrive, the BIOS expects the bootloader to be located at sector 0 or the MBR*(Master Boot Record). Since the MBR only allows for a small amount of data (446 bytes) to be stored, the MBR usually contains instructions that point to another piece of code on disk. This two stage approach is known as *chainloading. This other piece of code could then consist of a boot manager. A boot manager is capable of loading operating systems located at various locations on the storage volumes. Both the first and second stage of the boot code have to be stored within the first MegaByte of available storage on the harddrive.</p> <p>UEFI uses a different approach. Instead of being limited to the MBR contents of one specific drive, UEFI reads boot data from an ESP partition. ESP stands for EFI System Partition. The ESP is a designated boot partition. The filesystem is usually of the type FAT , and it can hold any size of bootloader, or even multiple ones. On Linux systems, the ESP is usually mounted as <code>/boot/efi</code>. Underneath that mountpoint will be a directory structure that depends on the Operating System in use. The boot files located within those directories carry a <code>.efi</code> extension. With UEFI, the UEFI software acts as a mini-bootloader looking for filenames ending in <code>.efi</code> within pre-defined locations. On a Fedora based system, the contents of the ESP may look as follows:</p> <pre><code>    # cd /boot/efi/\n    # ls -a\n    .  ..  EFI\n    #  cd EFI\n    #  ls\n    BOOT  fedora\n    # ls -l BOOT\n    total 1332\n    -rw-r--r-- 1 root root 1293304 May 17  2016 BOOTX64.EFI\n    -rw-r--r-- 1 root root   66072 May 17  2016 fallback.efi\n    # ls -l fedora/\n    total 3852\n    -rw-r--r-- 1 root root     104 May 17  2016 BOOT.CSV\n    drwxr-xr-x 2 root root    4096 Sep 28 22:17 fw\n    -rwxr-xr-x 1 root root   70864 Sep 28 22:17 fwupx64.efi\n    -rw-r--r-- 1 root root 1276192 May 17  2016 MokManager.efi\n    -rw-r--r-- 1 root root 1293304 May 17  2016 shim.efi\n    -rw-r--r-- 1 root root 1287000 May 17  2016 shim-fedora.efi\n</code></pre> <p>In the example above, every file ending in <code>.efi</code> can add functionality to the UEFI system. So, whereas BIOS based systems depend on harddrive metadata to boot up a system, UEFI based systems are capable of reading files within the ESP portion of the harddrive. UEFI offers backwards compatibility towards legacy BIOS functions, while at the same time offering more advanced functions for modern computers. Computers using BIOS software have trouble dealing with todays 8TB harddrives. UEFI based computers are able to use GPT disk layouts that defeat the 2TB partition limit of their BIOS counterparts. The UEFI software comes with network support for IPv4 and IPv6. TCP and UDP are supported, and booting remote boot media is supported using TFTP and even HTTP. Booting over HTTP does require UEFI 2.5 or newer. Version 2.5 was released in Januari 2016.</p> <p>LPIC-2 exam candidates should be aware of the possibility to switch between UEFI and Legacy BIOS boot modes on modern computers. Despite the advantages that UEFI may have, there are also requirements that should be met. The <code>.efi</code> boot files are expected to be located beneath a certain path. When Secure Boot is enabled, the boot code has to be digitally signed. Otherwise, systems may encounter boot issues. When troubleshooting boot issues on a modern Linux computer, try to distinguish MBR from GPT disk layouts. When using the UEFI boot mode, confirm that the Linux distribution in use can also handle UEFI boot. When Secure Boot is enabled, confirm that the required conditions are met. When in doubt, switch back to \"Legacy BIOS\" or equivalent within the UEFI interface. When booting from USB, it may be necessary to enable 'Legacy USB' settings for Mass Storage Devices in the UEFI interface.</p>"},{"location":"lpic2.202.2/#nvm","title":"NVM","text":"<p>In the previous chapter, 8TB harddrives are mentioned as a result of recent computer storage evolution. These conventional SATA (Serial Advanced Technology Attachmenti) harddrives have moving parts, and are controlled using a protocol called AHCI (Advanced Host Configuration Interface). In recent years, SSD (Solid State Disk) harddrives have become more popular. One of the advantages of these drives is the lack of moving parts. This makes SSD harddrives not only more energy efficient but also faster than mechanical harddrives. Because the SSD drives have to be compatible with existing computers, they are connected with the same SATA connector mechanical harddrives use. And they also use the same AHCI protocol. This protocol was initially designed with mechanical harddrives in mind. AHCI uses 1 queue with 32 commands to control the harddrive. This poses a bottleneck for the newer generation of SSD harddrives. To combat this bottleneck, a new technology called NVMe (Non Volatile Memory Express) has been developed. NVMe allows SSD harddrives to connect to a NVMe controller that is connected to the PCI-E bus on the motherboard. The SSD harddisk is then controlled using the NVMHCI (Non Volatile Memory Host Configuration Interface) protocol. Instead of 1 queue holding 32 commands at a time, the SSD can now be controlled using 65.000 queues holding up to 65.000 commands each. This is possible because the PCI-E bus is much faster than the SATA bus. The latest generation of fast SSD harddrives can achieve throughput speeds up to seven times faster using NVMe when compared to PCI-E connected AHCI harddrives.</p> <p>Just as traditional harddrives connected to a Linux computer are represented by <code>/dev/hda*</code> or <code>/dev/sda*</code> references, NVMe harddrives are represented by <code>/dev/nvme*</code> within the Linux filesystem tree. When working with these harddrives, be aware that the disk notation starts at <code>0</code>, but the namespace and partition on disk start at <code>1</code>. Therefore, the first partition on the first namespace on the first NVMe harddrive of a system is represented by <code>/dev/nvme0n1p1</code>. More about UEFI and NVMe booting at 204.2</p>"},{"location":"lpic2.202.3/","title":"Alternate Bootloaders (202.3)","text":""},{"location":"lpic2.202.3/#alternate-bootloaders-2023","title":"Alternate Bootloaders (202.3)","text":"<p>Candidates should be aware of other bootloaders and their major features.</p>"},{"location":"lpic2.202.3/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>SYSLINUX, ISOLINUX, PXELINUX</p> </li> <li> <p>Understanding of PXE for both BIOS and UEFI</p> </li> <li> <p>Awareness of systemd-boot and U-Boot</p> </li> <li> <p>Booting UEFI systems</p> </li> <li> <p>Systemd-boot</p> </li> <li> <p>U-Boot</p> </li> </ul>"},{"location":"lpic2.202.3/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>syslinux</code></p> </li> <li> <p><code>extlinux</code></p> </li> <li> <p><code>isolinux.bin</code></p> </li> <li> <p><code>isolinux.cfg</code></p> </li> <li> <p><code>isohdpfx.bin</code></p> </li> <li> <p><code>efiboot.img</code></p> </li> <li> <p><code>pxelinux.0</code></p> </li> <li> <p><code>pxelinux.cfg/</code></p> </li> <li> <p><code>uefi/shim.efi</code></p> </li> <li> <p><code>uefi/grubx64.efi</code></p> </li> <li> <p><code>UEFI</code></p> </li> <li> <p><code>Systemd-boot</code></p> </li> <li> <p><code>U-boot</code></p> </li> </ul>"},{"location":"lpic2.202.3/#lilo","title":"LILO","text":"<p>The lilo bootloader consists of two stages. During the two stage boot, LILO indicates its progress by printing consecutive letters from the word \\\"LILO\\\" to the BIOS console, with one letter at the start and end of each stage.</p> <p>Errors during either stage result in only parts of the word being printed, optionally followed by a numeric BIOS error code, or a single character. E.g, <code>LIL-</code> or <code>LIL?</code>.</p> <p>In interactive mode (<code>prompt</code> keyword in <code>/etc/lilo.conf</code>) LILO presents the user with a choice of up to 16 entries. If no <code>timeout=nnn</code> (<code>nnn</code> in tens of a second) is specified, the bootloader will wait indefinitely. If the timeout expires, or no <code>prompt</code> was included, LILO proceeds by loading the first image listed. This can be overruled with the <code>default=name</code> keyword.</p>"},{"location":"lpic2.202.3/#etcliloconf-and-sbinlilo","title":"/etc/lilo.conf and /sbin/lilo","text":"<p>Unless modern bootloaders, neither stage of LILO is actually aware of the contents of <code>/etc/lilo.conf</code>. Instead, the file is used only as a specification for the lilo installer, typically at <code>/sbin/lilo</code>. Without additional options, <code>/sbin/lilo</code> will install the bootloader into the MBR, and process the contents of <code>/etc/lilo.conf</code>, creating a mapping of any files specified to store into <code>/boot/map</code>.</p> <p>Please refer to the <code>lilo.conf(5)</code> man page online for a detailed description of <code>/etc/lilo.conf</code>.</p> <p>Example <code>/etc/lilo.conf</code> (from an older debian distribution)</p> <pre><code>    # lilo.conf\n    #\n    #  global options:\n    boot=/dev/hda\n    prompt\n    timeout=150\n    lba32\n    compact\n    vga=normal\n    root=/dev/hda1\n    read-only\n    menu-title=\" John's Computer \"\n    #\n    #  bootable kernel images:\n    image=/boot/zImage-1.5.99\n         label=try\n    image=/boot/zImage-1.0.9\n         label=1.0.9\n    image=/tamu/vmlinuz\n         label=tamu\n         initrd=initramdisk.img\n         root=/dev/hdb2\n         vga=ask\n    #\n    #  other operating systems:\n    other=/dev/hda3\n         label=dos\n         boot-as=0x80    # must be C:\n    other=/dev/hdb1\n         label=Win98\n         boot-as=0x80    # must be C:\n    other=/dev/hdb5\n         label=os2\n         loader=os2_d\n         table=E:   # os2 sees as E:\n</code></pre>"},{"location":"lpic2.202.3/#syslinux-isolinux-pxelinux-the-syslinux-project","title":"SYSLINUX, ISOLINUX, PXELINUX: The Syslinux Project","text":"<p><code>SYSLINUX</code> is a linux bootloader designed to run from an MS-DOS/Windows FAT file system. It is limited to Intel/AMD hardware.</p> <p>Over time, the Syslinux project (http://syslinux.org) expanded to include support for booting natively from CD-ROMS (<code>ISOLINUX</code>), linux file systems (<code>EXTLINUX</code>) and over PXE (<code>PXELINUX</code>).</p> <p>This summary handles the LPIC-2 specific objectives. A full description can be found in the syslinux wiki at http://www.syslinux.org/wiki/index.php/SYSLINUX</p>"},{"location":"lpic2.202.3/#syslinux","title":"SYSLINUX","text":"<p>SYSLINUX is an Intel Linux bootloader which is able to boot from Windows/MS-DOS FAT based file systems. It can be installed with the command of the same name, from either Windows, MS-DOS, or linux.</p> <p>The syslinux system consists of the actual bootloader and its installer. The bootloader itself is a 32bit native binary written in assembler.</p> <p>The <code>syslinux</code> installer command comes in different versions: <code>syslinux.exe</code> for Windows, <code>syslinux</code> for linux. There is even a <code>syslinux.com</code> for DOS based systems.</p>"},{"location":"lpic2.202.3/#syslinux-installer-options","title":"SYSLINUX Installer Options","text":"<pre><code>    --offset        -t      Offset of the file system on the device\n    --directory     -d      Directory for installation target\n    --install       -i      Install over the current bootsector\n    --update        -U      Update a previous installation\n    --sectors=#     -S      Force the number of sectors per track\n    --heads=#       -H      Force number of heads\n    --stupid        -s      Slow, safe and stupid mode\n    --raid          -r      Fall back to the next device on boot failure\n    --once=...              Execute a command once upon boot\n    --clear-once    -O      Clear the boot-once command\n    --reset-adv             Reset auxilliary data\n    --menu-save=    -M      Set the label to select as default on the next boot\n    --force         -f      Ignore precautions\n</code></pre>"},{"location":"lpic2.202.3/#msdos-specific-options","title":"MSDOS specific options","text":"<pre><code>    -m      MBR: install a bootable MBR sector to the beginning of the drive.\n    -a      Active: marks the partition used active (=bootable)\n</code></pre>"},{"location":"lpic2.202.3/#linux-only","title":"Linux only","text":"<pre><code>    -t      (-o on older systems) Specifies the byte offset of the filesystem \n            image in the file. It has to be used with a disk image file.\n</code></pre>"},{"location":"lpic2.202.3/#exceptions-for-isolinux-extlinux-pxelinux","title":"Exceptions for ISOLINUX, EXTLINUX, PXELINUX","text":""},{"location":"lpic2.202.3/#the-isolinux-installer","title":"The ISOLINUX Installer","text":"<p>While <code>syslinux</code> expects a target device to write the bootloader, the <code>isolinux</code> installer generates an ISO image from a directory structure. The directory must include a subdirectory <code>isolinux</code> which in turn must include the actual <code>isolinux.bin</code> bootloader.</p>"},{"location":"lpic2.202.3/#the-extlinux-installer","title":"The EXTLINUX Installer","text":"<p>The <code>extlinux</code> installer expects a mounted file system to install the bootloader into.</p>"},{"location":"lpic2.202.3/#pxelinux","title":"PXELINUX","text":"<p>is treated in PXELINUX.</p>"},{"location":"lpic2.202.3/#syslinux-boot-configuration","title":"Syslinux Boot Configuration","text":"<p>The bootloaders installed by these utilities will look for a <code>syslinux.cfg</code> file in the following three directories: <code>/boot/syslinux</code>, <code>/syslinux</code>, <code>/</code> (root).</p> <p>The ISOLINUX bootloader will first look for <code>/boot/isolinux</code> and <code>/isolinux</code>. The EXTLINUX bootloader looks for <code>/boot/extlinux</code> and <code>/extlinux</code> first.</p> <p>The directory where the config file is found will be the default directory for further pathnames in the boot process.</p> <p>The CONFIG keyword will restart the boot process with a new config file. If two pathnames are supplied, the second parameter overrides the default directory.</p> <p>The boot process will look in the <code>syslinux.cfg</code> file for a line with \\\"LABEL linux\\\". When found, it will use any subsequent keywords to guide the boot process. (A <code>DEFAULT label</code> phrase can be used to override the \\\"linux\\\" label.)</p> <p>Typical keywords in a boot configuration:</p> <p><code>KERNEL</code> image</p> <ul> <li> <p>The <code>KERNEL</code>keyword specifies an image file. This does not have to     be an actual kernel image, but can be the name of the next stage     bootprogram. SYSLINUX e.a. rely on filename extensions to decide on     the file format.</p> <p><code>.0</code></p> <p>:   is used with PXELINUX for the PXE NBP (Network Boot Program),     with <code>pxelinux.0</code> being the default.</p> <p><code>.bin</code></p> <p>:   used with ISOLINUX, and refers to the CD Boot Sector,</p> <p><code>.bs</code> or <code>.bss</code></p> <p>:   refer to (patched) DOS bootsectors [SYSLINUX].</p> <p><code>.com</code>, <code>.cbt</code>, and <code>.c32</code></p> <p>:   are COMBOOT images (DOS,non-DOS,32 bit). For versions 5.00 and     later <code>c32</code> changed from COMBOOT to ELF binary format.</p> <p><code>.img</code></p> <p>:   is an ISOLINUX diskimage.</p> <p>Any other file extension (or none at all) indicate a linux kernel image.</p> <p>The file type can also be forced by using one of the <code>KERNEL</code> keyword aliases: <code>LINUX</code>, <code>BOOT</code>, <code>BSS</code>, <code>PXE</code>, <code>FDIMAGE</code>, <code>COMBOOT</code> or <code>COM32</code>.</p> </li> </ul> <p><code>APPEND</code> string</p> <ul> <li>The <code>APPEND</code> keyword specifies a string of boot parameters that is     appended to the kernel command line. Only the last <code>APPEND</code> line     will be applied.</li> </ul> <p><code>SYSAPPEND</code></p> <ul> <li> <p>The <code>SYSAPPEND</code> keyword expects a numeric argument that is     interpreted as a bitmap. Each bit in this bitmap will add a specific     auto-generated string to the kernel command line.</p> <p><code>1:</code>Adds a string with network information: <code>ip=client:bootserver:gw:netmask</code></p> <p><code>2:</code>Adds <code>BOOTIF=</code> ..., identifying the active network interface by its mac address.</p> <p><code>4:</code>Adds the string <code>SYSUUID=</code>...</p> <p><code>8:</code>Add <code>CPU=</code>...</p> <p>Higher order bits (0x00010 through 0x10000) control additional strings from DMI/SMBIOS, if available. A full list can be found in the Syslinux wiki: http://www.syslinux.org/wiki/index.php/SYSLINUX\\\"</p> </li> </ul> <p><code>INITRD</code> filename</p> <ul> <li>The <code>INITRD</code> keyword is equivalent to <code>APPEND initrd=filename</code>.</li> </ul> <p><code>TIMEOUT</code> num</p> <ul> <li>For interactive use, the argument to <code>TIMEOUT</code> indicates the number     of tens of a second that SYSLINUX should wait for input on the     console or serial port.</li> </ul>"},{"location":"lpic2.202.3/#pxelinux_1","title":"PXELINUX","text":"<p>The PXELINUX bootloader is used as the second stage of a PXE network boot. The PXE network boot mechanism is further explained in Understanding PXE.</p> <p>PXELINUX expects a standard TFTP server with a <code>/tftpboot</code> directory containing the <code>pxelinux.0</code> syslinux bootloader, and the <code>ldlinux.c32</code> library module.</p> <p>In addition, a directory <code>/tftpboot/pxelinux.cfg</code> must exist for additional configuration details.</p> <p>A PXE TFTP boot server can serve many different clients, and needs a way to maintain different configuration files for different (categories of) clients. There are many different ways in which the name of the configuration file can be specified.</p>"},{"location":"lpic2.202.3/#combine-dhcp-option-209-and-210","title":"Combine DHCP Option 209 and 210","text":"<ul> <li> <p>Option 209 (<code>pxelinux.config-file</code>) specifies the filename for the     configfile.</p> <p>Option 210 (<code>pxelinux.pathprefix</code>) specifies the search path (directory prefix) on the TFTP server namespace (ending in the OS-specific separator character for the file system).</p> </li> </ul>"},{"location":"lpic2.202.3/#hardcoded-in-the-pxelinux0-image","title":"Hardcoded in the <code>pxelinux.0</code> image.","text":"<ul> <li> <p>The <code>pxelinux-options</code> command can be used to hardcode the options     as shown in this table</p> number option 6 domain-name-servers 15 domain-name 54 next-server 209 config-file 210 path-prefix 211 reboottime <p>Options can be specified as 'before-options', where DHCP has precedence, or as 'after-options', which override DHCP.</p> </li> </ul>"},{"location":"lpic2.202.3/#derived-from-uuid-mac-address-or-ip-address","title":"Derived from UUID, MAC-address, or IP-Address","text":"<ul> <li> <p>If no config file is specified, the filename is derived from a list     of variables. The first file in the list that actually exists on the     TFTP server will be used.</p> <p>The list of variables is:</p> <ul> <li> <p>The client's UUID, in lower case.</p> </li> <li> <p>The client's MAC address, in lower case hexadecimal, with bytes     separated by a dash (\\\"-\\\").</p> </li> <li> <p>The longest possible prefix of the Upper case hexadecimal     representation of the client's ipv4 address. Each time the     string does not match, PXELINUX drops the last character from     the string and tries again as long as the result contains at     least one character.</p> </li> <li> <p>As a last resort, PXELINUX will try to retrieve the file named     \\\"default\\\".</p> </li> </ul> </li> </ul>"},{"location":"lpic2.202.3/#understanding-pxe","title":"Understanding PXE","text":"<p>PXE is a specification created by Intel to enhance the original network boot protocols: BOOTP, TFTP and DHCP.</p> <p>BOOTP, RARP and TFTP were created by the IETF to enable systems to automatically retrieve their network configuration and initial bootloader from a server.</p> <p>The initial BOOTP standard was limited to a number of fixed fields in which client and server could exchange information. A client could supply its hardware address in <code>chaddr</code>, and request a specific type of <code>file</code>, and would receive its ip address as <code>yiaddr</code> and a servername <code>sname</code>. Combined with the server IP address field (<code>siaddr</code>) and the gateway IP address field, and the returned boot file name (<code>file</code>) this would tell the boot client where to retrieve its boot image, using TFTP.</p> <p>BOOTP Fields.</p> <pre><code>    ciaddr  4       client IP address\n    yiaddr  4       your IP address\n    siaddr  4       server IP address\n    giaddr  4       gateway IP address\n    chaddr  16      client hardware address\n    sname   64      optional server host name, null terminated string.\n    file    128     boot file name, null terminated string;\n    vend    n     n=64 in original BOOTP, starts with the 4 byte\n                    DHCP 'magic' number.\n</code></pre> <p>Over time networks and IT infrastructure became more complicated and requirements more demanding. To allow clients to provide more information about themselves and to retrieve tailored information, BOOTP received the BOOTP Vendor Information Extensions [RFC 1048], which in turn was enhanced with a new protocol, DHCP. DHCP extended BOOTP with a number of standard options, defining different types of messages. Some DHCP options may overlap with standard BOOTP fields, and should contain the same value in that case.</p> <p>Note A DHCP message is a BOOTP packet (request or response) with a special 4 byte value (the DHCP magic cookie) in the BOOTP \\\"Vendor Information Field\\\". Following that are DHCP options, consisting of a single byte option type, a length field, and <code>length</code> bytes of option content.</p> <p>This rule has two exceptions: Padding (<code>0</code>) and End of Options (<code>255</code>) are just one byte in length and lack a length field.</p> <p>Finally, Intel introduced PXE, to enhance the BOOTP/DHCP protocol even further, in an attempt to standardise the way clients can identify themselves. This allows boot clients and servers to minimize the number of packets that needs to be exchanged before they can decide on the correct parameters and the boot program needed to get going.</p> <p>A PXE boot request starts with a DHCP Discover message including at least five options, of which three are PXE-specific:</p> <pre><code>    (53) DHCP Message type (DHCP Discover),\n    (55) Parameter Request List,\n    (93) Client System Architecture,\n    (94) Client Network Device Interface, \n    (97) UUID/GUID-based Client Identifier\n</code></pre> <p>Options 93, 94, and 97 are defined in the PXE specification. In addition, option 55, the Parameter Request List, must *also* request options 128 through 135, even though a server is not required to provide a response to them. This list and the three options listed above act to identify the client as PXE aware.</p>"},{"location":"lpic2.202.3/#proxy-dhcp-for-pxe","title":"Proxy DHCP for PXE","text":"<p>Not every DHCP server (especially those embedded in network equipment) will be able to process a PXE request.</p> <p>The PXE specification allows PXE-aware DHCP servers to co-exist with simple DHCP servers, where the default DHCP server provides the basic network detail. The PXE-aware server can then provide additional detail for the actual TFTP boot process. This is called proxy-DHCP.</p> <p>It is even possible to separate DHCP services on the same server, in which the proxy DHCP service is expected to listen to UDP port 4011.</p>"},{"location":"lpic2.202.3/#example-dhcp-request","title":"Example DHCP request","text":"<p>See below for an example DHCP Discover message, including requests for standard network detail such as (1) Subnet Mask, (3) Router, (6) Name server, (12) Host Name, (15) Domain Name, etc.</p> <pre><code>    Option: (53) DHCP Message Type\n        Length: 1\n        DHCP: Discover (1)\n    Option: (57) Maximum DHCP Message Size\n        Length: 2\n        Maximum DHCP Message Size: 1464\n    Option: (55) Parameter Request List\n        Length: 35\n        Parameter Request List Item: (1) Subnet Mask\n        Parameter Request List Item: (2) Time Offset\n        Parameter Request List Item: (3) Router\n        Parameter Request List Item: (4) Time Server\n        Parameter Request List Item: (5) Name Server\n        Parameter Request List Item: (6) Domain Name Server\n        Parameter Request List Item: (12) Host Name\n        Parameter Request List Item: (13) Boot File Size\n        Parameter Request List Item: (15) Domain Name\n        Parameter Request List Item: (17) Root Path\n        Parameter Request List Item: (18) Extensions Path\n        Parameter Request List Item: (22) Maximum Datagram Reassembly Size\n        Parameter Request List Item: (23) Default IP Time-to-Live\n        Parameter Request List Item: (28) Broadcast Address\n        Parameter Request List Item: (40) Network Information Service Domain\n        Parameter Request List Item: (41) Network Information Service Servers\n        Parameter Request List Item: (42) Network Time Protocol Servers\n        Parameter Request List Item: (43) Vendor-Specific Information\n        Parameter Request List Item: (50) Requested IP Address\n        Parameter Request List Item: (51) IP Address Lease Time\n        Parameter Request List Item: (54) DHCP Server Identifier\n        Parameter Request List Item: (58) Renewal Time Value\n        Parameter Request List Item: (59) Rebinding Time Value\n        Parameter Request List Item: (60) Vendor class identifier\n        Parameter Request List Item: (66) TFTP Server Name\n        Parameter Request List Item: (67) Bootfile name\n        Parameter Request List Item: (97) UUID/GUID-based Client Identifier\n        Parameter Request List Item: (128) DOCSIS full security server IP [TODO]\n        Parameter Request List Item: (129) PXE - undefined (vendor specific)\n        Parameter Request List Item: (130) PXE - undefined (vendor specific)\n        Parameter Request List Item: (131) PXE - undefined (vendor specific)\n        Parameter Request List Item: (132) PXE - undefined (vendor specific)\n        Parameter Request List Item: (133) PXE - undefined (vendor specific)\n        Parameter Request List Item: (134) PXE - undefined (vendor specific)\n        Parameter Request List Item: (135) PXE - undefined (vendor specific)\n    Option: (97) UUID/GUID-based Client Identifier\n\n    Length: 17\n        Client Identifier (UUID): 00000000-0000-0000-0000-44123456789a\n    Option: (94) Client Network Device Interface\n        Length: 3\n        Major Version: 3\n        Minor Version: 16\n    Option: (93) Client System Architecture\n        Length: 2\n        Client System Architecture: EFI BC (7)\n    Option: (60) Vendor class identifier\n        Length: 32\n        Vendor class identifier: PXEClient:Arch:00007:UNDI:003016\n    Option: (255) End\n        Option End: 255\n</code></pre>"},{"location":"lpic2.202.3/#systems-with-uefi","title":"Systems with UEFI","text":"<p>UEFI is a protocol known as Unified Extensible Firmware Interface (UEFI) Secure Boot. This was to be a modern replacement for the aging BIOS system and would help ensure boot-time malware couldn't be injected into a system.</p> <p>The BIOS replacement, UEFI, requires a digital key installed for the OS to pass the UEFI firmware check to be able to boot. Mainstream Linux distributions like Red Hat, Ubuntu and Suse for example have purchased those keys so they have no problems with Secure Boot systems.</p> <p>Without this digital key you generally still should be able to use Linux on a secure boot system. You can start with disabling the folowing in your BIOS:</p> <pre><code>                         Quickboot/Fastboot\n\n                         Intel Smart Response Technology (ISRT)\n\n                         FastStartUp (if you have Windows 8).\n</code></pre> <p>If you get a Secure boot or signature error, you need to disable Secure Boot. If your system is running Windows 7, you can enter the BIOS by entering the keyboard key required to enter the BIOS settings and disable Secure Boot. If the system comes with Windows 8 you will need to boot into Windows and choose to do an Advanced startup. This should allow you to enter the BIOS and disable Secure Boot. Not: Sometimes a BIOS is able to run in EFI or legacy mode. If your system allows this you should not have any problems installing Linux</p>"},{"location":"lpic2.202.3/#booting-with-systemd-boot","title":"Booting with Systemd-boot","text":"<p>Systemd comes with Systemd-boot. This is intended for use with EFI systems. It can only start EFI executables such as the Linux kernel EFISTUB, UEFI Shell, GRUB and the Windows Boot Manager. Systemd-boot is managed with the <code>bootctl</code> command. systemd-boot requires an EFI System Partition (ESP), preferably mounted on <code>/boot</code>. The ESP must contain the EFI binaries. Further information and examples can be found at https://www.freedesktop.org/software/systemd/man/index.html</p>"},{"location":"lpic2.202.3/#booting-with-das-u-boot","title":"Booting with Das U-boot","text":"<p>Das U-boot \"the Universal Boot Loader\" is an open source, primary boot loader aimed at embedded devices. It is used to package the instructions to boot the kernel code. It is supporting many computer architectures, including 68k, ARM, AVR32, Blackfin, MicroBlaze, MIPS, Nios, SuperH, PPC and x86. U-Boot can be split into stages if there are size restraints. U-Boot requires explicit commands as to where the memory addresses are to copy the kernel, ramdisk, etc data to opposed to other bootloaders which automatically choose the memory locations. Due to the U-Boot commands being low-level, booting a kernel requires multiple steps. This allows U-Boot to be very flexible. U-Boot can boot from on board storage, the network and even serial ports.</p>"},{"location":"lpic2.203.0/","title":"Filesystem and Devices (203)","text":"<p>This topic has a weight of 9 points and contains the following three objectives:</p>"},{"location":"lpic2.203.0/#objective-2031-operating-the-linux-filesystem-4-points","title":"Objective 203.1; Operating the Linux filesystem (4 points)","text":"<ul> <li>Candidates should be able to properly configure and navigate the     standard Linux filesystem. This objective includes configuring and     mounting various filesystem types.</li> </ul>"},{"location":"lpic2.203.0/#objective-2032-maintaining-a-linux-filesystem-3-points","title":"Objective 203.2; Maintaining a Linux filesystem (3 points)","text":"<ul> <li>Candidates should be able to properly maintain a Linux filesystem     using system utilities. This objective includes manipulating     standard filesystems and monitoring SMART devices.</li> </ul>"},{"location":"lpic2.203.0/#objective-2033-creating-and-configuring-filesystem-options-2-points","title":"Objective 203.3; Creating and configuring filesystem options (2 points)","text":"<ul> <li>Candidates should be able to configure automount filesystems using     AutoFS. This objective includes configuring automount for network     and device filesystems. Also included is creating filesystems for     devices such as CD-ROMs and a basic feature knowledge of encrypted     filesystems.</li> </ul>"},{"location":"lpic2.203.1/","title":"Operating The Linux Filesystem (203.1)","text":""},{"location":"lpic2.203.1/#operating-the-linux-filesystem-2031","title":"Operating The Linux Filesystem (203.1)","text":"<p>Candidates should be able to properly configure and navigate the standard Linux filesystem. This objective includes configuring and mounting various filesystem types.</p>"},{"location":"lpic2.203.1/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>The concept of the <code>fstab</code> configuration</p> </li> <li> <p>Tools and utilities for handling SWAP partitions and files</p> </li> <li> <p>Use of UUIDs for identifying and mounting file systems</p> </li> <li> <p>Understanding of systemd mount units</p> </li> </ul>"},{"location":"lpic2.203.1/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/etc/fstab</code></p> </li> <li> <p><code>/etc/mtab</code></p> </li> <li> <p><code>/proc/mounts</code></p> </li> <li> <p><code>mount</code> and <code>umount</code></p> </li> <li> <p><code>sync</code></p> </li> <li> <p><code>swapon</code></p> </li> <li> <p><code>swapoff</code></p> </li> <li> <p><code>blkid</code></p> </li> </ul>"},{"location":"lpic2.203.1/#the-file-hierarchy","title":"The File Hierarchy","text":"<p>Historically, the location of certain files and utilities has not always been standard (or fixed). This has led to problems with development and upgrading between different \"distributions\" of Linux. The Linux directory structure (or Linux directory structure file hierarchy) was based on existing flavors of UNIX, but as it evolved, certain inconsistencies came into being. These were often small things such as the location (or placement) of certain configuration files, but this resulted in difficulties porting software from host to host.</p> <p>To equalize these differences a file standard was developed. This, to date, is an evolving process resulting in a fairly static model for the Linux file hierarchy. This filesystem hierarchy is standardized Linux file hierarchy in the filesystem hierarchy standard. The current version is 2.3. More information and documentation on the FHS can be found at Filesystem Hierarchy Standard homepage. See also the section on the FHS standard.</p> <p>The top level of the Linux file hierarchy is referred to as the root (or <code>/</code> ). The root directory typically contains several other directories. An overview was already presented in the section that discusses the contents of the root file system. A recap:</p> <pre><code>  `bin/`          Required boot-time binaries\n  `boot/`         Boot configuration files for the OS loader and kernel image\n  `dev/`          Device files\n  `etc/`          System configuration files and scripts\n  `home/`         User home directories\n  `lib/`          Main OS shared libraries and kernel modules\n  `lost+found/`   Storage directory for \"recovered\" files\n  `media/`        Mount point(s) for removable media like CD-ROM's, flash disks and floppies\n  `mnt/`          Temporary mount point for filesystems as needed by a system administrator\n  `opt/`          Reserved for the installation of large add-on application software packages\n  `proc/`         A \\\"virtual\\\" filesystem used by Linux systems to store information about the kernel, processes and current resource usage\n  `root/`         Linux (non-standard) home directory for the root user. Alternate location being the `/` directory itself\n  ` sbin/`        System administration binaries and tools\n  ` tmp/`         Location of temporary files\n  ` usr/`         Shareable, read-only data, containing e.g. user commands, C programs header files and non-vital system binaries\n  ` var/`         Variable data, usually machine specific. Includes spool directories for mail and news, administrative and logging data\n</code></pre> <p>Generally, the root should not contain any additional files NDASH a possible exception would be mount points for various purposes.</p>"},{"location":"lpic2.203.1/#filesystems","title":"Filesystems","text":"<p>A filesystem consists of methods and data structures that an filesystems operating system uses to keep track of files on a disk or partition; that is, the way the files are organised on the disk. The word is also used to refer to a partition or disk that is used to store the files or the type of the filesystem. Thus, one might say \"I have two filesystems\" meaning one has two partitions on which files are stored, or one might say \"I am using the XFS filesystem\", meaning the type of the XFS filesystem.</p> <p>The difference between a disk or partition and the partition filesystem it contains is important. A few programs (including those that create filesystems) operate directly on the raw sectors of a disk or partition; if a filesystem is already there it will be destroyed or seriously corrupted. Most programs operate on a filesystem, and therefore won't work on a partition that doesn't contain one (or that contains a filesystem of the wrong type).</p> <p>Before a partition or disk can be used as a filesystem, it needs to be initialized, and the bookkeeping data structures need to be written to the disk. This process is called making a filesystem. making a filesystem</p> <p>Most UNIX filesystem types have a similar general structure, although the exact details vary quite a bit. The central superblock inode directory blocks indirection blocks concepts are superblock, inode, data block, directory block, and indirection block. The superblock contains information about the filesystem as a whole, such as its size (the exact information here depends on the filesystem). An inode contains all information about a file, except its name. The name is stored in the directory, together with the number of the inode. A directory entry consists of a filename and the number of the inode which represents the file. The inode contains the numbers of several data blocks, which are used to store the data in the file. There is space only for a few data block numbers in the inode, however, and if more are needed, more space for pointers to the data blocks is allocated dynamically. These dynamically allocated blocks are indirect blocks; the name indicates that in order to find the data block, one has to find its number in the indirect block first.</p>"},{"location":"lpic2.203.1/#creating-filesystems","title":"Creating Filesystems","text":"<p>Before a partition can be mounted (or used), a filesystem must Creatingfilesystem first be installed on it NDASH with ext2, this is the process of creating i-nodes and data blocks.</p> <p>This process is the equivalent of initializing the partition. Under create filesystem mkfs Linux, the command to create a filesystem is called <code>mkfs</code>.</p> <p>The command is issued in the following way:</p> <pre><code>    mkfs [-c] [ -t fstype ] filesystem [ blocks ]\n</code></pre> <p>e.g.</p> <pre><code>    mkfs -t ext2 /dev/fd0 # Make a ext2 filesystem on a floppy\n</code></pre> <p>where:</p> <p><code>-c</code></p> <ul> <li>forces a check for bad blocks</li> </ul> <p><code>-t fstype</code></p> <ul> <li>specifies the filesystem type. For most filesystem types there is a     shorthand for this e.g.: <code>mkfs -t ext2</code> can also be called as ext2     <code>mke2fs</code> or mkfs.ext2 <code>mkfs.ext2</code> and <code>mkfs -t vfat</code> or     <code>mkfs -t msdos</code> can also be called as <code>mkfs.vfat</code>, <code>mkfs.msdos</code> or     <code>mkdosfs</code></li> </ul> <p><code>filesystem</code></p> <ul> <li>is either the device file associated with the partition or device OR     is the directory where the file system is mounted (this is used to     erase the old file system and create a new one)</li> </ul> <p>Note Creating a filesystem on a device with an existing filesystem will cause all data on the old filesystem to be erased.</p>"},{"location":"lpic2.203.1/#mounting-and-unmounting","title":"Mounting and Unmounting","text":"<p>Linux presents all filesystems as one directory tree. Hence to add a new device with a filesystem on it its filesystem needs to be made part of that one directory tree. The way this is done is by attaching the new filesystem under an existing (preferably empty) directory, which is part of the existing directory tree - the \"<code>mount</code>\" point.</p> <p>To attach a new file system to the directory mount unmount hierarchy you must mount its associated device file. First you will need to create the mount point; a directory where the device will be attached. As directories are part of a filesystem too the mount point exists on a previously mounted device. It should be empty. If is is not the files in the directory will not be visible while the device is mounted to it, but will reappear after the device has been disconnected (or unmounted). This type of security by obscurity is sometimes used to hide information from the casual onlooker.</p> <p>To mount a device, use the mount command:</p> <pre><code>    mount [options] device_file mount_point\n</code></pre> <p>With some devices, mount will detect what type of filesystem exists on the device, however it is more usual to use mount in the form of:</p> <pre><code>    mount [options] -t file_system_type device_file mount_point\n</code></pre> <p>Generally, only the root user can use the mount command - mainly due to the fact that the device files are owned by root. For example, to mount the first partition on the second (IDE) hard drive off the <code>/usr</code> directory and assuming it contained the ext2 filesystem, you'd enter the command:</p> <pre><code>    mount -t ext2 /dev/hdb1 /usr\n</code></pre> <p>A common device that is mounted is the floppy drive. A floppy disk generally contains the FAT, also known as msdos, filesystem (but not always) FAT and is mounted with the command:</p> <pre><code>    mount -t msdos /dev/fd0 /mnt\n</code></pre> <p>Note that the floppy disk was mounted under the <code>/mnt</code> directory. This is because the <code>/mnt</code> directory is the usual place to temporarily mount devices.</p> <p>To see which devices you currently have mounted, simply type the command <code>mount</code>. Some sample output:</p> <pre><code>    /dev/hda3 on / type ext2 (rw)\n    /dev/hda1 on /dos type msdos (rw)\n    none on /proc type proc (rw)\n    /dev/cdrom on /cdrom type iso9660 (ro)\n    /dev/fd0 on /mnt type msdos (rw)\n</code></pre> <p>Each line shows which device file is mounted, where it is iso9660 mounted, what filesystem type each partition is and how it is mounted (<code>ro</code> = read only, <code>rw</code> = read/write). Note the strange entry on line three NDASH the proc filesystem. This is a special \"virtual\" filesystem used by Linux systems to store information about the kernel, processes and current resource usage. It is actually part of the system's memory NDASH in other words, the kernel sets aside an area of memory in which it stores information about the system. This same area is mounted onto the filesystem so that user programs have access to this information.</p> <p>The information in the proc filesystem can also be used to see which filesystems are mounted by issuing the command: /proc/mounts</p> <pre><code>    $ cat /proc/mounts\n    /dev/root / ext2 rw 0 0\n    proc /proc proc rw 0 0\n    /dev/hda1 /dos msdos rw 0 0\n    /dev/cdrom /cdrom iso9660 ro 0 0\n    /dev/fd0 /mnt msdos rw 0 0\n</code></pre> <p>The difference between <code>/etc/mtab</code> and <code>/proc/mounts</code> is that <code>/etc/mtab</code> is the user space administration kept by <code>mount</code>, and <code>/proc/mounts</code> is the information kept by the kernel. The latter reflects the information in user space. Due to these different implementations the info in <code>/proc/mounts</code> is always up-to-date, while the info in <code>/etc/mtab</code> may become inconsistent.</p> <p>To release a device and disconnect it from the filesystem, the umount command is used. It is issued in the form: umount</p> <pre><code>    umount device_file\n</code></pre> <p>or</p> <pre><code>    umount mount_point\n</code></pre> <p>For example, to release the floppy disk, you'd issue the command:</p> <pre><code>    umount /dev/fd0\n</code></pre> <p>or</p> <pre><code>    umount /mnt\n</code></pre> <p>Again, you must be the root user or a user with privileges to do this. You can't unmount a device/mount point that is in use by a user (e.g. the user's current working directory is within the mount point) or is in use by a process. Nor can you unmount devices/mount points which in turn have devices mounted to them.</p> <p>The system needs to mount devices during boot. In true UNIX fashion, there is a file which governs the behaviour of mounting devices at boot time. In Linux, this file is <code>/etc/fstab</code>. Lines from the /etc/fstabfile use the following format:</p> <pre><code>    device_file mount_point file_system_type mount_options [n] [n]\n</code></pre> <p>The first three fields are self explanatory; the fourth field, <code>mount_options</code> defines how the device will be mounted (this includes information of access mode <code>ro</code> / <code>rw</code> , execute permissions and other information) - information on this can be found in the <code>mount</code> man pages (note that this field usually contains the word \"defaults\" ). The fifth and sixth fields are used by the system utilities <code>dump</code> and <code>fsck</code> respectively - see the next section for details.</p> <p>There's also a file called <code>/etc/mtab</code>. It lists the currently mounted partitions in fstab form.</p>"},{"location":"lpic2.203.1/#systemd-mount-units","title":"Systemd Mount Units","text":"<p>Linux distributions that have adopted the systemd initialization system have an additional way of mounting filesystems. Instead of using the <code>fstab</code> file for persistent mounting, a filesystem can be configured using a mount unit file. This mount unit file holds the configuration details for systemd to persistently mount filesystems.</p> <p>A systemd mount unit file has a specific naming convention. The file name refers to the absolute directory it will be mounted on and the file extension is <code>.mount</code>. For the name of the file the first and last forward slash (/) of the mount path it represents are removed and the remaining slashes are converted to a dash (-). So if, for example, a filesystem is mounted to the mount point <code>/home/user/data/</code> the mount unit file must be named <code>home-user-data.mount</code></p> <p>In the mount file three required sections are defined: <code>[Unit]</code>, <code>[Mount]</code> and <code>[Install]</code>. An example of a mount unit file <code>/etc/systemd/system/home-user-data.mount</code>:</p> <pre><code>    [Unit]\n    Description=Data for User\n\n    [Mount]\n    What=/dev/sda2\n    Where=/home/user/data\n    Type=ext4\n    Options=defaults\n\n    [Install]\n    WantedBy=multi-user.target\n</code></pre> <p>To test the configuration reload the systemctl daemon by using the command <code>systemctl daemon-reload</code> and then manually start the mount unit file with the command <code>systemctl start</code> followed by the mount unit file. In our example that would be <code>systemctl start home-user-data.mount</code>. Next you can check if the filesystem was mounted correctly by getting the overview from <code>mount</code>. If everything works as expected make the filesystem mount persistent by enabling the mount unit file with the command <code>systemctl enable home-user-data.mount</code>.</p>"},{"location":"lpic2.203.1/#swap","title":"Swap","text":"<p>Swap space in Linux is a partition or file that is used to move the contents of inactive pages of RAM to when RAM becomes full. Linux can use either a normal file in the filesystem or a swap separate partition for swap space. A swap partition is faster, but it is easier to change the size of a swap file (there's no need to repartition the whole hard disk, and possibly install everything from scratch). When you know how much swap space you need, you should use a swap partition, but if you are in doubt, you could use a swap file first, and use the system for a while so that you can get a feel for how much swap you need, and then make a swap partition when you're confident about its size. It is recommended to use a separate partition, because this excludes chances of file system fragmentation, which would reduce performance. Also, by using a separate swap partition, it can be guaranteed that the swap region is at the fastest location of the disk. On current HDDs this is at the beginning of the platters (outside rim, first cylinders). It is possible to use several swap partitions and/or swap files at the same time. This means that if you only occasionally need an unusual amount of swap space, you can set up an extra swap file at such times, instead of keeping the whole amount allocated all the time.</p> <p>The command <code>mkswap</code> is used to initialize a mkswap swap partition or a swap file. The partition or file needs to exist before it can be initialized. A swap partition is created with a disk partitioning tool like <code>fdisk</code> and a swap file can be created with: /dev/zero</p> <pre><code>    dd if=/dev/zero of=swapfile bs=1024 count=65535\n</code></pre> <p>When the partition or file is created, it can be initialized with:</p> <pre><code>    mkswap {device|file}\n</code></pre> <p>An initialized swap space is taken into use with <code>swapon</code>. This swapon command tells the kernel that the swap space may be used. The path to the swap space is given as the argument, so to start swapping on a temporary swap file one might use the following command:</p> <pre><code>    swapon /swapfile\n</code></pre> <p>or, when using a swap partition:</p> <pre><code>    swapon /dev/hda8\n</code></pre> <p>Swap spaces may be used automatically by listing them in the file <code>/etc/fstab</code>:</p> <pre><code>    /dev/hda8 none swap sw 0 0\n    /swapfile none swap sw 0 0\n</code></pre> <p>The startup scripts will run the command <code>swapon              -a</code>, which will start swapping on all the swap spaces listed in <code>/etc/fstab</code>. Therefore, the swapon command is usually used only when extra swap is needed. You can monitor the use of swap spaces with free <code>free</code>. It will report the total amount of swap space used:</p> <pre><code>    $ free\n    total used free shared buffers cached\n    Mem: 127148 122588 4560 50 1584 69352\n    -/+ buffers/cache: 51652 75496\n    Swap: 130748 57716 73032\n</code></pre> <p>The first line of output (<code>Mem:</code>) shows the physical memory. The <code>total</code> column does not show the physical memory used by the kernel, which is loaded into the RAM memory during the boot process. The <code>used</code> column shows the amount of memory used (the second line does not count buffers). The <code>free</code> column shows completely unused memory. The <code>shared</code> column shows the amount of memory used by tmpfs (shmem in /proc/meminfo); The <code>buffers</code> column shows the current size of the disk buffer cache.</p> <p>That last line (<code>Swap:</code> ) shows similar information for the swap spaces. If this line is all zeroes, swap space is not activated.</p> <p>The same information, in a slightly different format, can be shown by using <code>cat</code> on the file /proc/meminfo <code>/proc/meminfo</code>:</p> <pre><code>    $ cat /proc/meminfo\n    total used free shared buffers cached\n    Mem: 130199552 125177856 5021696 0 1622016 89280512\n    Swap: 133885952 59101184 74784768\n    MemTotal: 127148 kB\n    MemFree: 4904 kB\n    MemShared: 0 kB\n    Buffers: 1584 kB\n    Cached: 69120 kB\n    SwapCached: 18068 kB\n    Active: 80240 kB\n    Inactive: 31080 kB\n    HighTotal: 0 kB\n    HighFree: 0 kB\n    LowTotal: 127148 kB\n    LowFree: 4904 kB\n    SwapTotal: 130748 kB\n    SwapFree: 73032 kB\n</code></pre> <p>swapoff To disable a device or swap file, use the <code>swapoff</code> command:</p> <pre><code>    # swapoff /dev/sda3\n</code></pre>"},{"location":"lpic2.203.1/#uuids","title":"UUIDs","text":"<p>The term UUID stands for Universal Unique IDentifier. It's a 128 bit number that can be used to identify basically anything. Generating such UUIDs can be done using appropriate software. There are 5 various versions of UUIDs, all of them use a (pseudo)random element, current system time and some mostly unique hardware ID, for example a MAC address. Theoretically there is a very, very remote chance of an UUID not being unique, but this is seen as impossible in practice.</p> <p>On Linux, support for UUIDs was started within the e2fsprogs package. With filesystems, UUIDs are used to represent a specific filesystem. You can for example use the UUID in <code>/etc/fstab</code> to represent the partition which you want to mount.</p> <p>Usually, a UUID is represented as 32 hexadecimal digits, grouped in sequences of 8,4,4,4 and 12 digits, separated by hyphens. Here's what an fstab entry with a UUID specifier looks like:</p> <pre><code>    UUID=652b786e-b87f-49d2-af23-8087ced0c828 / ext4 errors=remount-ro,noatime 0 1\n</code></pre> <p>You might be wondering about the use of UUID's in fstab, since device names work fine. UUIDs come in handy when disks are moved to different connectors or computers, multiple operating systems are installed on the computer, or other cases where device names could change while keeping the filesystem intact. As long as the filesystem does not change, the UUID stays the same.</p> <p>Note the 'as long as the filesystem does not change'. This means, when you reformat a partition, the UUID will change. For example, when you use mke2fs to reformat partition <code>/dev/sda3</code>, the UUID will be changed. So, if you use UUIDs in <code>/etc/fstab</code>, you have to adjust those as well.</p> <p>blkid If you want to know the UUID of a specific partition, use <code>blkid /path/to/partition</code>:</p> <pre><code>    # blkid /dev/sda5\n    /dev/sda5: UUID=\"24df5f2a-a23f-4130-ae45-90e1016031bc\" TYPE=\"swap\"\n</code></pre> <p>Note It is possible to create a new filesystem and still make it have the same UUID as it had before, at least for 'ext' type filesystems.</p> <pre><code>    # tune2fs /dev/sda5 -U 24df5f2a-a23f-4130-ae45-90e1016031bc\n</code></pre> <p>Note On most Linux distributions you can generate your own UUIDs using the command <code>uuidgen</code>.</p> <p>sync</p> <p>To improve performance of Linux filesystems, many operations are done in filesystem buffers, stored in RAM. To actually flush the data contained in these buffers to disk, the <code>sync</code> command is used.</p> <p><code>sync</code> is called automatically at the right moment when rebooting or halting the system. You will rarely need to use the command yourself. <code>sync</code> might be used to force syncing data to an USB device before removing it from your system, for example.</p> <p><code>sync</code> does not have any operation influencing options, so when you need to, just execute \\\"<code>sync</code>\\\" on the command line.</p>"},{"location":"lpic2.203.2/","title":"Maintaining a Linux Filesystem (203.2)","text":""},{"location":"lpic2.203.2/#maintaining-a-linux-filesystem-2032","title":"Maintaining a Linux Filesystem (203.2)","text":"<p>Candidates should be able to properly maintain a Linux filesystem using system utilities. This objective includes manipulating standard filesystems and monitoring SMART devices.</p> <p>Resources: ???; ???; the <code>man</code> pages for <code>e2fsck</code>, <code>badblocks</code>, <code>dumpe2fs</code>, <code>debugfs</code> and <code>tune2fs</code>.</p>"},{"location":"lpic2.203.2/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Tools and utilities to manipulate ext2, ext3 and ext4.</p> </li> <li> <p>Tools and utilities to perform Btrfs operations, including     subvolumes and snapshots.</p> </li> <li> <p>Tools and utilities to manipulate xfs.</p> </li> <li> <p>Awareness of ZFS.</p> </li> </ul>"},{"location":"lpic2.203.2/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>fsck (fsck.*)</code></p> </li> <li> <p><code>mkfs (mkfs.*)</code></p> </li> <li> <p><code>mkswap</code></p> </li> <li> <p><code>tune2fs</code></p> </li> <li> <p><code>dumpe2fs</code></p> </li> <li> <p><code>debugfs</code></p> </li> <li> <p><code>btrfs</code></p> </li> <li> <p><code>btrfs-convert</code></p> </li> <li> <p><code>xfs_info</code>, <code>xfs_check</code>, <code>xfs_repair</code>, <code>xfs_dump</code> and <code>xfs_restore</code></p> </li> <li> <p><code>smartd</code> and <code>smartctl</code></p> </li> </ul>"},{"location":"lpic2.203.2/#disk-checks","title":"Disk Checks","text":"<p>Good disk maintenance requires periodic disk checks. Your best tool is <code>fsck</code>, and should be run at least monthly. Default checks will normally be run after 20 system reboots, but if your system stays up for weeks or months at a time, you'll want to force a check from time to time. Your best bet is performing routine system backups and checking your <code>lost+found</code> directories from time to time.</p> <p>The frequency of the checks at system reboot can be changed with <code>tune2fs</code>. This utility can also be used to tune2fs change the mount count, which will prevent the system from having to check all filesystems at the 20<sup>th</sup> reboot (which can take a long time).</p> <p>The <code>dumpe2fs</code> utility will provide important dumpe2fs information regarding hard disk operating parameters found in the superblock, and <code>badblocks</code> will perform surface checking. Finally, surgical procedures to remove areas grown bad on the disk can be accomplished using <code>debugfs</code>. debugfs</p>"},{"location":"lpic2.203.2/#fsck-fsck","title":"fsck (fsck.*)","text":"<p><code>fsck</code> is a utility to check and repair a fsck Linux filesystem. In actuality <code>fsck</code> is simply a front-end for the various filesystem checkers (<code>fsck.fstype</code>) available under Linux.</p> <p><code>fsck</code> is called automatically at system startup. If the filesystem is marked \"not clean\", or the maximum mount count is reached or the time between checks is exceeded, the filesystem is checked. To change the maximum mount count or the time between checks, use <code>tune2fs</code>.</p> <p>Frequently used options to <code>fsck</code> include:</p> <p><code>-s</code></p> <ul> <li>Serialize <code>fsck</code> operations. This is a fsck-a good idea if you're     checking multiple filesystems and the checkers are in an interactive     mode.</li> </ul> <p><code>-A</code></p> <ul> <li> <p>Walk through the <code>/etc/fstab</code> file fsck-A and try to check all     filesystems in one run. This option is typically used from the     /etc/rc system initialization file, instead of multiple commands for     checking a single filesystem.</p> <p>The root filesystem will be checked first. After that, filesystems will be checked in the order specified by the <code>fs_passno</code> (the sixth) field in the <code>/etc/fstab</code> file. Filesystems with a <code>fs_passno</code> value of 0 are skipped and are not checked at all. If there are multiple filesystems with the same pass number, fsck will attempt to check them in parallel, although it will avoid running multiple filesystem checks on the same physical disk.</p> </li> </ul> <p><code>-R</code></p> <ul> <li>When checking all filesystems with the -A flag, skip fsck-R the root     filesystem (in case it's already mounted read-write).</li> </ul> <p>Options which are not understood by fsck are passed to the filesystem-specific checker. These arguments(=options) must not take arguments, as there is no way for fsck to be able to properly guess which arguments take options and which don't. Options and arguments which follow the <code>--</code> are treated as filesystem-specific options to be passed to the filesystem-specific checker.</p> <p>The filesystem checker for the ext2 filesystem is called <code>fsck.e2fs</code> or <code>e2fsck</code>. Frequently used options include:</p> <p><code>-a</code></p> <ul> <li>This option does the same thing as the <code>-p</code> option. It is provided     for backwards compatibility only; it is suggested that people use -p     option whenever possible.</li> </ul> <p><code>-c</code></p> <ul> <li>This option causes e2fsck to run the fsck-c <code>badblocks(8)</code> program     to find any badblocks blocks which are bad on the filesystem, and     then marks them as bad by adding them to the bad block inode.</li> </ul> <p><code>-C</code></p> <ul> <li>This option causes e2fsck to write completion fsck-C information to     the specified file descriptor so that the progress of the filesystem     check can be monitored. This option is typically used by programs     which are running e2fsck. If the file descriptor specified is 0,     e2fsck will print a completion bar as it goes about its business.     This requires that e2fsck is running on a video console or terminal.</li> </ul> <p><code>-f</code></p> <ul> <li>Force checking even if the filesystem seems clean. fsck-f</li> </ul> <p><code>-n</code></p> <ul> <li>Open the filesystem read-only, and assume an answer of fsck-n \"no\"     to all questions. Allows e2fsck to be used non-interactively. (Note:     if the -c, -l, or -L options are specified in addition to the -n     option, then the filesystem will be opened read-write, to permit the     bad-blocks list to be updated. However, no other changes will be     made to the filesystem.)</li> </ul> <p><code>-p</code></p> <ul> <li>Automatically repair (\\\"preen\\\") the filesystem without fsck-p any     questions.</li> </ul> <p><code>-y</code></p> <ul> <li>Assume an answer of \"yes\" to all questions; allows fsck-y <code>e2fsck</code>     to be used non-interactively.</li> </ul>"},{"location":"lpic2.203.2/#mkfs","title":"mkfs (mkfs.*)","text":"<p>mkfs The <code>mk2fs</code> command is used to create a Linux filesystem. It can create different types of filesystems by specifying the <code>-t filesystem</code> or by giving the <code>mkfs.filesystem</code> command. Actually <code>mkfs</code> is a front-end for the several <code>mkfs.fstype</code> commands. Please read the mkfs man pages and section for more information. ???</p>"},{"location":"lpic2.203.2/#tune2fs","title":"tune2fs","text":"<p><code>tune2fs</code> is used to \"tune\" a tune2fs filesystem. This is mostly used to set filesystem check options, such as the <code>maximum mount count</code> and the <code>time between filesystem checks</code>.</p> <p>It is also possible to set the <code>mount count</code> to a specific value. This can be used to 'stagger' the mount counts of the different filesystems, which ensures that at reboot not all filesystems will be checked at the same time.</p> <p>So for a system that contains 5 partitions and is booted approximately once a month you could do the following to stagger the mount counts:</p> <pre><code>    tune2fs -c 5 -C 0\n    partition1\n    tune2fs -c 5 -C 1\n    partition2\n    tune2fs -c 5 -C 2\n    partition3\n    tune2fs -c 5 -C 3\n    partition4\n    tune2fs -c 5 -C 4\n    partition5\n</code></pre> <p>The maximum mount count is 20, but for a system that is not mount count frequently rebooted a lower value is advisable.</p> <p>Frequently used options include:</p> <p><code>-c max-mount-counts</code></p> <ul> <li> <p>Adjust the maximum mount count between two filesystem tunefs-c     checks. If max-mount-counts is 0 then the number of times the     filesystem is mounted will be disregarded by e2fsck(8) and the     kernel. Staggering the mount-counts at which filesystems are     forcibly checked will avoid all filesystems being checked at one     time when using journalling filesystems.</p> <p>You should strongly consider the consequences of disabling mount-count-dependent checking entirely. Bad disk drives, cables, memory and kernel bugs could all corrupt a filesystem without marking the filesystem dirty or in error. If you are using journalling on your filesystem, your filesystem will never be marked dirty, so it will not normally be checked. A filesystem error detected by the kernel will still force an fsck on the next reboot, but it may already be too late to prevent data loss at that point.</p> </li> </ul> <p><code>-C mount-count</code></p> <ul> <li>Set the number of times the filesystem has been tunefs-C mounted.     Can be used in conjunction with -c to force an fsck on the     filesystem at the next reboot.</li> </ul> <p><code>-i interval-between-checks[d|m|w]</code></p> <ul> <li> <p>Adjust the maximal time between two filesystem tunefs-i checks. No     suffix or d result in days, m in interval between checks months, and     w in weeks. A value of zero will disable the time-dependent     checking.</p> <p>It is strongly recommended that either -c (mount-count-dependent) or -i (time-dependent) checking be enabled to force periodic full e2fsck(8) checking of the filesystem. Failure to do so may lead to filesystem corruption due to bad disks, cables or memory or kernel bugs to go unnoticed, until they cause data loss or corruption.</p> </li> </ul> <p><code>-m reserved-blocks-percentage</code></p> <ul> <li>Set the percentage of reserved filesystem blocks. tunefs-m reserved     blocks</li> </ul> <p><code>-r reserved-blocks-count</code></p> <ul> <li>Set the number of reserved filesystem blocks. tunefs-r</li> </ul>"},{"location":"lpic2.203.2/#dumpe2fs","title":"dumpe2fs","text":"<p><code>dumpe2fs</code> prints the super block and blocks dumpe2fs group information for the filesystem present on device.</p> <p><code>-b</code></p> <ul> <li>print the blocks which are reserved as bad in the filesystem.</li> </ul> <p><code>-h</code></p> <ul> <li>only display the superblock information and not any of the block     group descriptor detail information.</li> </ul>"},{"location":"lpic2.203.2/#badblocks","title":"badblocks","text":"<p><code>badblocks</code> is a Linux utility to check for damaged sectors on a disk drive. It marks these sectors so that they are not used in the future and thus do not cause corruption of data. It is part of the e2fsprogs project.</p> <p>It is strongly recommended that badblocks not be run directly but to have it invoked through the <code>-c</code> option in <code>e2fsck</code> or <code>mke2fs</code>. A commonly used option is:</p> <p><code>-o output-file</code></p> <ul> <li>write the list of bad blocks to <code>output-file</code>.</li> </ul>"},{"location":"lpic2.203.2/#debugfs","title":"debugfs","text":"<p>With <code>debugfs</code>, you can modify the disk with direct disk writes. Since this utility is so powerful, you will normally want to invoke it as read-only until you are ready to actually make changes and write them to the disk. To invoke <code>debugfs</code> in read-only mode, do not use any options. To open in read-write mode, add the <code>-w</code> option. You may also want to include in the command line the device you wish to work on, as in <code>/dev/hda1</code> or <code>/dev/sda1</code>, etc. Once it is invoked, you should see a debugfs prompt.</p> <p>When the superblock of a partition is damaged, you can specify superblock location a different superblock to use:</p> <pre><code>    debugfs -b 1024 -s 8193 /dev/hda1\n</code></pre> <p>This means that the superblock at block 8193 will be used and the blocksize is 1024. Note that you have to specify the blocksize when you want to use a different superblock. The information about blocksize and backup superblocks can be found with:</p> <pre><code>    dumpe2fs /dev/hda1\n</code></pre> <p>The first command to try after invocation of <code>debugfs</code>, is <code>params</code> to show the mode (read-only or read-write), and the current file system. If you run this command without opening a filesystem, it will almost certainly dump core and exit. Two other commands, <code>open</code> and <code>close</code>, may be of interest when checking more than one filesystem. Close takes no argument, and appropriately enough, it closes the filesystem that is currently open. Open takes the device name as an argument. To see disk statistics from the superblock, the command <code>stats</code> will display the information by group. The command <code>testb</code> checks whether a block is in use. This can be used to test if any data is lost in the blocks marked as \"bad\" by the <code>badblocks</code> command. To get the filename for a block, first use the <code>icheck</code> command to get the inode and then <code>ncheck</code> to get the filename. The best course of action with bad blocks is to mark the block \"bad\" and restore the file from backup.</p> <p>To get a complete list of all commands, see the man page of <code>debugfs</code> or type <code>?</code>, <code>lr</code> or <code>list_requests</code>.</p>"},{"location":"lpic2.203.2/#ext4fs","title":"ext4","text":"<p>Ext4 is the evolution of the most used Linux filesystem, Ext3. In many ways, Ext4 is a deeper improvement over Ext3 than Ext3 was over Ext2. Ext3 was mostly about adding journaling to Ext2, but Ext4 modifies important data structures of the filesystem such as the ones destined to store the file data. The result is a filesystem with an improved design, better performance, reliability, and features. Therefore converting ext3 to ext4 is not as straightforward and easy as it was converting ext2 to ext3.</p> <p>To creating ext4 partitions from scratch, use:</p> <pre><code>    mkfs.ext4 /dev/sdxY\n</code></pre> <p>Note Tip: See the mkfs.ext4 man page for more options; edit <code>/etc/mke2fs.conf</code> to view/configure default options.</p> <p>Be aware that by default, mkfs.ext4 uses a rather low bytes-per-inode ratio to calculate the fixed amount of inodes to be created.</p> <p>Note Note: Especially for contemporary HDDs (750 GB+) this usually results in a much too large inode number and thus many likely wasted GB. The ratio can be set directly via the -i option; one of 6291456 resulted in 476928 inodes for a 2 TB partition.</p> <p>For the rest ext4 can be manipulated using all the same tools that are available for ext2/ext3 type of filesystems like badblocks, dumpe2fs, e2fsck and tune2fs.</p>"},{"location":"lpic2.203.2/#btrfs","title":"btrfs","text":"<p>Btrfs (abbreviation for: BTree File System)is a new copy on write (CoW) filesystem for Linux aimed at implementing advanced features while focusing on fault tolerance, repair and easy administration. Jointly developed at Oracle, Red Hat, Fujitsu, Intel, SUSE, STRATO and many others, Btrfs is licensed under the GPL and open for contribution from anyone. Btrfs has several features characteristic of a storage device. It is designed to make the file system tolerant of errors, and to facilitate the detection and repair of errors when they occur. It uses checksums to ensure the validity of data and metadata, and maintains snapshots of the file system that can be used for backup or repair. The core datastructure used by btrfs is the B-Tree - hence the name.</p> <p>Note Btrfs is still under heavy development, but every effort is being made to keep the filesystem stable and fast. Because of the speed of development, you should run the latest kernel you can (either the latest release kernel from kernel.org, or the latest -rc kernel.</p> <p>As of the beginning of the year 2013 Btrfs was included in the default kernel and its tools (btrfs-progs) are part of the default installation. GRUB 2, mkinitcpio, and Syslinux have support for Btrfs and require no additional configuration.</p> <p>The main Btrfs features available at the moment include:</p> <ul> <li> <p>Extent based file storage</p> </li> <li> <p>2^64 byte == 16 EiB maximum file size</p> </li> <li> <p>Space-efficient packing of small files</p> </li> <li> <p>Space-efficient indexed directories</p> </li> <li> <p>Dynamic inode allocation</p> </li> <li> <p>Writable snapshots, read-only snapshots</p> </li> <li> <p>Subvolumes (separate internal filesystem roots)</p> </li> <li> <p>Checksums on data and metadata (crc32c)</p> </li> <li> <p>Compression (zlib and LZO)</p> </li> <li> <p>Integrated multiple device support</p> </li> <li> <p>File Striping, File Mirroring, File Striping+Mirroring, Striping     with Single and Dual Parity implementations</p> </li> <li> <p>SSD (Flash storage) awareness (TRIM/Discard for reporting free     blocks for reuse) and optimizations (e.g. avoiding unnecessary seek     optimizations, sending writes in clusters, even if they are from     unrelated files. This results in larger write operations and faster     write throughput)</p> </li> <li> <p>Efficient Incremental Backup</p> </li> <li> <p>Background scrub process for finding and fixing errors on files with     redundant copies</p> </li> <li> <p>Online filesystem defragmentation</p> </li> <li> <p>Offline filesystem check</p> </li> <li> <p>Conversion of existing ext\u00be file systems</p> </li> <li> <p>Seed devices. Create a (readonly) filesystem that acts as a template     to seed other Btrfs filesystems. The original filesystem and devices     are included as a readonly starting point for the new filesystem.     Using copy on write, all modifications are stored on different     devices; the original is unchanged.</p> </li> <li> <p>Subvolume-aware quota support</p> </li> <li> <p>Send/receive of subvolume changes</p> </li> <li> <p>Efficient incremental filesystem mirroring</p> </li> </ul> <p>The most notable (unique) btrfs features are:</p>"},{"location":"lpic2.203.2/#raid-functionality","title":"RAID functionality","text":"<ul> <li> <p>A Btrfs filesystem provides support for integrated RAID     functionality, and can be created on top of many devices. More     devices can be added after the filesystem is created. By default,     metadata will be mirrored across two devices and data will be     striped across all of the devices present. If only one device is     present, metadata will be duplicated on that one device.</p> <p>Btrfs can add and remove devices online, and freely convert between RAID levels after the filesystem is created. Btrfs supports raid0, raid1, raid10, raid5 and raid6, and it can also duplicate metadata on a single spindle. When blocks are read in, checksums are verified. If there are any errors, Btrfs tries to read from an alternate copy and will repair the broken copy if the alternative copy succeeds.</p> <p><code>mkfs.btrfs</code> will accept more than one device on the command line. It has options to control the raid configuration for data (-d) and metadata (-m). Valid choices are raid0, raid1, raid10 and single. The option -m single means that no duplication of metadata is done, which may be desired when using hardware raid. here some examples on creating the filesystem.</p> <pre><code>    # Create a filesystem across four drives (metadata mirrored, linear data allocation)\n    mkfs.btrfs /dev/sdb /dev/sdc /dev/sdd /dev/sde\n\n    # Stripe the data without mirroring\n    mkfs.btrfs -d raid0 /dev/sdb /dev/sdc\n\n    # Use raid10 for both data and metadata\n    mkfs.btrfs -m raid10 -d raid10 /dev/sdb /dev/sdc /dev/sdd /dev/sde\n\n    # Don't duplicate metadata on a single drive (default on single SSDs)\n    mkfs.btrfs -m single /dev/sdb\n</code></pre> <p>After filesystem creation it can be mounted like any other filesystem. To see the devices used by the filesystem you can use the follwing command:</p> <pre><code>    butterfs filesystem show\n    label:  none  uuid: c67b1e23-887b-4cb9-b037-5958f6c0a333\n        total devices 2 FS bytes used 383.00KiB\n        devid   1 size 4.00 GiB used 847.12MiB path /dev/sdb\n        devid   2 size 4.00 GiB used 837.12MiB path /dev/sdc\n    Btrfs v4.8.5\n</code></pre> </li> </ul>"},{"location":"lpic2.203.2/#snapshotting","title":"Snapshotting","text":"<ul> <li> <p>Btrfs's snapshotting is simple to use and understand. The snapshots     will show up as normal directories under the snapshotted directory,     and you can cd into it and walk around there as you would in any     directory.</p> <p>By default, all snapshots are writeable in Btrfs, but you can create read-only snapshots if you choose so. Read-only snapshots are great if you are just going to take a snapshot for a backup and then delete it once the backup completes. Writeable snapshots are handy because you can do things such as snapshot your file system before performing a system update; if the update breaks your system, you can reboot into the snapshot and use it like your normal file system. When you create a new Btrfs file system, the root directory is a subvolume. Snapshots can only be taken of subvolumes, because a subvolume is the representation of the root of a completely different filesystem tree, and you can only snapshot a filesystem tree.</p> <p>The simplest way to think of this would be to create a subvolume for <code>/home</code>, so you could snapshot <code>/</code> and <code>/home</code> independently of each other. So you could run the following command to create a subvolume:</p> <pre><code>    btrfs subvolume create /home\n</code></pre> <p>And then at some point down the road when you need to snapshot <code>/home</code> for a backup, you simply run:</p> <pre><code>    btrfs subvolume snapshot /home/ /home-snap\n</code></pre> <p>Once you are done with your backup, you can delete the snapshot with the command</p> <pre><code>    btrfs subvolume delete /home-snap/\n</code></pre> <p>The hard work of unlinking the snapshot tree is done in the background, so you may notice I/O happening on a seemingly idle box; this is just Btrfs cleaning up the old snapshot. If you have a lot of snapshots or don't remember which directories you created as subvolumes, you can run the command:</p> <pre><code>    # btrfs subvolume list /mnt/btrfs-test/\n    ID 267 top level 5 path home\n    ID 268 top level 5 path snap-home\n    ID 270 top level 5 path home/josef\n</code></pre> <p>This doesn't differentiate between a snapshot and a normal subvolume, so you should probably name your snapshots consistently so that later on you can tell which is which.</p> </li> </ul>"},{"location":"lpic2.203.2/#subvolumes","title":"Subvolumes","text":"<ul> <li> <p>A subvolume in btrfs is not the same as an LVM logical volume, or a     ZFS subvolume. With LVM, a logical volume is a block device in its     own right; this is not the case with btrfs. A btrfs subvolume is not     a block device, and cannot be treated as one.</p> <p>Instead, a btrfs subvolume can be thought of as a POSIX file namespace. This namespace can be accessed via the top-level subvolume of the filesystem, or it can be mounted in its own right. So, given a filesystem structure like this:</p> <pre><code>    toplevel\n      `--- dir_a                * just a normal directory\n      |         `--- p\n      |         `--- q\n      `--- subvol_z             * a subvolume\n            `--- r\n            `--- s\n</code></pre> <p>the root of the filesystem can be mounted, and the full filesystem structure will be seen at the mount point; alternatively the subvolume can be mounted (with the <code>mount</code> option <code>subvol=subvol_z</code>), and only the files <code>r</code> and <code>s</code> will be visible at the mount point.</p> <p>A btrfs filesystem has a default subvolume, which is initially set to be the top-level subvolume. It is the default subvolume which is mounted if no subvol or subvolid option is passed to mount. Changing the default subvolume with btrfs subvolume default will make the top level of the filesystem inaccessible, except by use of the <code>subvolid=0</code> mount option.</p> </li> </ul>"},{"location":"lpic2.203.2/#space-efficient-indexed-directories","title":"Space-efficient indexed directories","text":"<ul> <li> <p>Directories and files look the same on disk in Btrfs, which is     consistent with the UNIX way of doing things. The ext file system     variants have to pre-allocate their inode space when making the file     system, so you are limited to the number of files you can create     once you create the file system.</p> <p>With Btrfs we add a couple of items to the B-tree when you create a new file, which limits you only by the amount of metadata space you have in your file system. If you have ever created thousands of files in a directory on an ext file system and then deleted the files, you may have noticed that doing an ls on the directory would take much longer than you'd expect given that there may only be a few files in the directory.</p> <p>You may have even had to run this command:</p> <pre><code>    e2fsck -D /dev/sda1\n</code></pre> <p>to re-optimize your directories in ext. This is due to a flaw in how the directory indexes are stored in ext: they cannot be shrunk. So once you add thousands of files and the internal directory index tree grows to a large size, it will not shrink back down as you remove files. This is not the case with Btrfs.</p> <p>In Btrfs we store a file index next to the directory inode within the file system B-tree. The B-tree will grow and shrink as necessary, so if you create a billion files in a directory and then remove all of them, an ls will take only as long as if you had just created the directory.</p> <p>Btrfs also has an index for each file that is based on the name of the file. This is handy because instead of having to search through the containing directory's file index for a match, we simply hash the name of the file and search the B-tree for this hash value. This item is stored next to the inode item of the file, so looking up the name will usually read in the same block that contains all of the important information you need. Again, this limits the amount of I/O that needs to be done to accomplish basic tasks.</p> </li> </ul>"},{"location":"lpic2.203.2/#mkswap","title":"mkswap","text":"<p>mkswap mkswap sets up a Linux swap area on a device or in a file. (After creating the swap area, you need to invoke the <code>swapon</code> command to start using it. Usually swap areas are listed in <code>/etc/fstab</code> so that they can be taken into use at boot time by a <code>swapon</code> <code>-a</code> command in some boot script.) See ???</p>"},{"location":"lpic2.203.2/#xfs_info","title":"xfs_info","text":"<p>xfs_info xfs_info shows the filesystem geometry for an XFS filesystem. xfs_info is equivalent to invoking xfs_growfs with the <code>-n</code> option.</p>"},{"location":"lpic2.203.2/#xfs_check","title":"xfs_check","text":"<p>xfs_check xfs_check checks whether an XFS filesystem is consistent. It is needed only when there is reason to believe that the filesystem has a consistency problem. Since XFS is a Journalling filesystem, which allows it to retain filesystem consistency, there should be little need to ever run <code>xfs_check</code>.</p>"},{"location":"lpic2.203.2/#xfs_repair","title":"xfs_repair","text":"<p>xfs_repair xfs_repair repairs corrupt or damaged XFS filesystems. xfs_repair will attempt to find the raw device associated with the specified block device and will use the raw device instead. Regardless, the filesystem to be repaired must be unmounted, otherwise, the resulting filesystem may become inconsistent or corrupt.</p>"},{"location":"lpic2.203.2/#smartmontools-smartd-and-smartctl","title":"smartmontools: smartd and smartctl","text":"<p>smartd smartctl Two utility programs, smartctl and smartd (available when the smartmontools package is installed) can be used to monitor and control storage systems using the Self-Monitoring, Analysis and Reporting Technology System (SMART). SMARTis built into most modern ATA and SCSI harddisks and solid-state drives. The purpose of SMARTis to monitor the reliability of the hard drive and predict drive failures, and to carry out different types of drive self-tests.</p> <p>*smartd*is a daemon that will attempt to enable SMARTmonitoring on ATA devices and polls these and SCSI devices every 30 minutes (configurable), logging SMARTerrors and changes of SMARTAttributes via the SYSLOG interface. smartd can also be configured to send email warnings if problems are detected. Depending upon the type of problem, you may want to run self-tests on the disk, back up the disk, replace the disk, or use a manufacturer's utility to force reallocation of bad or unreadable disk sectors.</p> <p>smartd can be configured at start-up using the configuration file /usr/local/etc/smartd.conf. When the USR1 signal is sent to smartd it will immediately check the status of the disks, and then return to polling the disks every 30 minutes. Please consult the manual page for smartd for specific configuration options.</p> <p>The smartctl utility controls the SMART system. It can be used to scan devices and print info about them, to enable or disable SMART on specific disks, to configure what to do when (imminent) errors are detected. Please consult the smartctl manual page for details.</p>"},{"location":"lpic2.203.2/#zfs-zpool-and-zfs","title":"ZFS: zpool and zfs","text":"<p>ZFS, currently owned by Oracle Corporation, was developed at Sun Microsystems as a next generation filesystem aimed at near infinite scalability and free from traditional design paradigms. Only Ubuntu currently offers kernel integration for ZFS on Linux. Other Linux distributions can make use of ZFS through userspace with the aid of Fuse.</p> <p>The main ZFS features available at the moment include:</p> <ul> <li> <p>High fault tolerance and data integrity</p> </li> <li> <p>Near unlimited storage due to 128 bit design</p> </li> <li> <p>Hybrid volume/filesystem management with RAID capabilities</p> </li> <li> <p>Compression/deduplication of data</p> </li> <li> <p>Data snapshots</p> </li> <li> <p>Volume provisioning (zvols)</p> </li> <li> <p>Ability to use different devices for caching and logging</p> </li> <li> <p>Ability to use delegate administrative rights to unprivileged users</p> </li> </ul> <p>The high fault tolerance and data integrity design makes it unneccesary to have a command like fsck available. ZFS works in transactions in where the ueberblock is only updated if everything was completed. Copies of previous uberblocks (128) are being kept in a round robin fashion. The so called vdev labels, which identify the disks used in a zfs pool, also have multiple copies: 2 at the beginning of the disk and 2 at the end. Periodic scrubbing of pools can reveal data integrity issues, and if a pool is equipped with more than one device, can repair it on the fly.</p> <p>ZFS allows for additional checksumming algoritms of blocks and can have multiple copies of those blocks stored. This can be configured per ZFS filesystem.</p> <p>ZFS pools can be considered the logical volume managent and can consist out of single or multiple disks. The pools can have seperate cache and logging devices attached so that reading/writing is offloaded to faster devices. Having multiple disks in a pool allows for on the fly data recovery.</p> <p>A typical simple ZFS pool:</p> <pre><code>    $ sudo zpool list -v\n    NAME   SIZE  ALLOC   FREE  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT\n    tank  1.98G   448K  1.98G         -     0%     0%  1.00x  ONLINE  -\n     sdb  1.98G   448K  1.98G         -     0%     0%\n</code></pre> <p>Status of the pool:</p> <pre><code>    $ sudo zpool status -v\n      pool: tank\n     state: ONLINE\n      scan: none requested\n    config:\n\n        NAME        STATE     READ WRITE CKSUM\n        tank        ONLINE       0     0     0\n          sdb       ONLINE       0     0     0\n        errors: No known data errors\n</code></pre> <p>History overview for ZFS pools:</p> <pre><code>    $ sudo zpool history\n    History for 'tank':\n    2017-01-11.11:32:50 zpool create -f -m /tank tank /dev/sdb\n    2017-01-11.12:37:44 zpool scrub tank\n</code></pre> <p>The ZFS pool is used as backing for one or more ZFS filesystems. By default the pool itself has a single filesystem named after the pool. ZFS filesystems are flexible in size and allow for customisation of various attributes like compression, size reservation, quota, block copies and so on. A full set of attributes can be seen with <code>zfs get all</code> and optionally a zfs filesystem, snapshot or volume.</p> <p>A typical ZFS filesystem listing</p> <pre><code>    $ sudo zfs list\n    NAME   USED  AVAIL  REFER  MOUNTPOINT\n    tank   242K  1.92G    19K  /tank\n</code></pre> <p>Create a ZFS filesystem \"documents\" and use compression</p> <pre><code>    $ sudo zfs create -o compression=on tank/documents\n    $ sudo zfs list tank/documents\n    NAME             USED  AVAIL  REFER  MOUNTPOINT\n    tank/documents    19K  1.92G    19K  /tank/documents\n</code></pre> <p>or</p> <pre><code>    $ sudo zfs create tank/documents\n    $ sudo zfs set compression=on tank/documents\n    $ sudo zfs list tank/documents\n    NAME             USED  AVAIL  REFER  MOUNTPOINT\n    tank/documents    19K  1.92G    19K  /tank/documents\n</code></pre> <p>With some data in <code>/tank/documents</code> compression ratio can be seen with</p> <pre><code>    $ sudo zfs get compressratio tank/documents \n    NAME            PROPERTY       VALUE  SOURCE\n    tank/documents  compressratio  1.68x  -\n</code></pre> <p>Creating a backup of <code>/tank/documents</code> can be done instantaniously and takes no space until <code>/tank/documents</code>'s content changes. The contents of the snapshot can be accessed through the <code>.zfs/snapshot</code> directory of that ZFS filesystem.</p> <pre><code>    $ sudo zfs snap tank/documents@backup\n    $ sudo zfs list -t snapshot\n    NAME                    USED  AVAIL  REFER  MOUNTPOINT\n    tank/documents@backup      0      -  45.0M  -\n</code></pre>"},{"location":"lpic2.203.3/","title":"Creating And Configuring Filesystem Options (203.3)","text":""},{"location":"lpic2.203.3/#creating-and-configuring-filesystem-options-2033","title":"Creating And Configuring Filesystem Options (203.3)","text":"<p>Candidates should be able to configure automount filesystems using AutoFS. This objective includes configuring automount for network and device filesystems. Also included is creating filesystems for devices such as CD-ROMs.</p>"},{"location":"lpic2.203.3/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>autofs configuration files</p> </li> <li> <p>UDF and ISO9660 tools and utilities</p> </li> <li> <p>awareness of CD-ROM filesystems (UDF, ISO9660, HFS)</p> </li> <li> <p>awareness of CD-ROM filesystem extensions (Joliet, Rock Ridge, El     Torito)</p> </li> <li> <p>basic feature knowledge of encrypted filesystems</p> </li> </ul>"},{"location":"lpic2.203.3/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/etc/auto.master</code></p> </li> <li> <p><code>/etc/auto.[dir]</code></p> </li> <li> <p><code>mkisofs</code></p> </li> <li> <p><code>dd</code></p> </li> <li> <p><code>mke2fs</code></p> </li> </ul>"},{"location":"lpic2.203.3/#autofs-and-automounter","title":"Autofs and automounter","text":"<p>Automounting is the process in which mounting (and unmounting) of filesystems is done automatically by a daemon. If the filesystem is not mounted and a user tries to access it, it will be automatically (re)mounted. This is useful in networked environments (especially when not all machines are always on-line) and for removable devices, such as floppies and CD-ROMs.</p> <p>The linux implementation of automounting, autofs, consists of automount a kernel component and a daemon called <code>automount</code>. Autofs uses <code>automount</code> to mount local and remote filesystems (over NFS) when needed and unmount them when they are not being used (after a timeout). Your <code>/etc/init.d/autofs</code> script first looks at <code>/etc/auto.master</code>: /etc/auto.master /etc/init.d/autofs</p> <pre><code>    # sample /etc/auto.master file\n    /var/autofs/floppy /etc/auto.floppy --timeout=2\n    /var/autofs/cdrom /etc/auto.cdrom --timeout=6\n</code></pre> <p>The file contains lines with three whitespace separated fields. The first field lists the directory in which the mounts will be done. The second field lists the filename in which we have placed configuration data for the devices to be mounted, the \"supplemental\" files. The last field specifies options. In our example we specified a timeout. After the timeout period lapses, the automount daemon will unmount the devices specified in the supplemental file.</p> <p>The configuration data in the supplemental files may consist of multiple lines and span multiple devices. The filenames and path to the supplemental files may be choosen freely. Each line in a supplemental file contains three fields:</p> <pre><code>    # sample /etc/auto.floppy file\n    floppy -user,fstype=auto :/dev/fd0\n</code></pre> <p>The first value is the \"pseudo\" directory. If the device is mounted, a directory of that name will appear and you can change into it to explore the mounted filesystem. The second value contains the mount options. The third value is the device (such as <code>/dev/fd0</code>, the floppy drive) which the \"pseudo\" directory is connected to.</p> <p>The configuration files are reread when the automounter is reloaded</p> <pre><code>    /etc/init.d/autofs reload\n</code></pre> <p>Please note that autofs does NOT reload nor restart if the mounted directory ( eg: <code>/home</code> ) is busy. Every entry in <code>auto.master</code> starts it's own daemon.</p> <p>The \"pseudo\" directory is contained in the directory which is defined in <code>/etc/auto.master</code>. When users try to access this \"pseudo\" directory, they will be rerouted to the device you specified. For example, if you specify a supplemental file to mount <code>/dev/fd0</code> on <code>/var/autofs/floppy/floppy</code>, the command <code>ls /var/autofs/floppy/floppy</code> will list the contents of the floppy. But if you do the command <code>ls /var/autofs/floppy</code>, you don't see anything even though the directory <code>/var/autofs/floppy/floppy</code> should exist. That is because <code>/var/autofs/floppy/floppy</code> does not exist yet. Only when you directly try to access that directory the automounter will mount it.</p> <p>Each device should have its own supplementary file. So, for example, configuration data for the floppy drive and that of the cdrom drive should not be combined into the same supplementary file. Each definition in the <code>/etc/auto.master</code> file results in spawning its own <code>automount</code> daemon. If you have several devices running under control of the same automount daemon - which is legit - but one of the devices fails, the daemon may hang or be suspended and other devices it controls might not be mounted properly either. Hence it is good practice to have every device under control of its own automount daemon and so there should be just one device per supplementary file per entry in the <code>/etc/auto.master</code> file.</p>"},{"location":"lpic2.203.3/#automount-with-systemd","title":"Automount with systemd","text":"<p>To initiate automount with systemd a unit file should be created in <code>/etc/systemd/system</code>. The unit file should be named after the mount point. In this example the file is named: mnt.mount because the mount point is /mnt.</p> <pre><code>    # cat /etc/systemd/systemd/mnt.mount\n    [Unit]\n    Description=My new file system\n\n    [Mount]\n    What=/dev/sdb1\n    Where=/mnt\n    Type=ext4\n    Options=\n\n    [Install]\n    WantedBy=multi-user.target\n</code></pre> <p>After creating the unit file it should be activated with the command:</p> <pre><code>    # systemctl start mnt.mount\n</code></pre> <p>Verify the activated mount point:</p> <pre><code>    # mount | grep sdb1\n    /dev/sdb1 on /mnt type ext4 (rw,relatime,data=ordered)\n</code></pre> <p>To activate the auto mounting on startup use the command:</p> <pre><code>    # systemctl enable mnt.mount\n</code></pre> <p>Initiate a reboot and verify if the partition is mounted. More information about mounting with systemd can be found in the man page of systemd.mount(5).</p>"},{"location":"lpic2.203.3/#autofs-with-systemd","title":"Autofs with systemd","text":"<p>To enable autofs with systemd a unit file with the extension <code>.automount</code> should be created in <code>/etc/systemd/system</code>. The information in that file is being controlled and supervised by systemd. The Automount units should be named after the directions they control. In this example the name of the automount unit configuration file is: <code>mnt.automount</code>.</p> <pre><code>    # cat /etc/systemd/system/mnt.automount\n    [Unit]\n    Description=My new automounted file system.\n\n    [Automount]\n    Where=/mnt\n\n    [Install]\n    WantedBy=multi-user.target\n</code></pre> <p>Activate the autofs automount unit.</p> <pre><code>    # systemctl status mnt.automount\n    mnt.automount - My new automounted file system.\n    Loaded: loaded (/etc/systemd/system/mnt.automount; disabled; vendor preset: disabled)\n    Active: inactive (dead)\n        Where: /mnt\n\n    # systemctl enable mnt.automount\n    Created symlink from /etc/systemd/system/multi-user.target.wants/mnt.automount to /etc/systemd/system/mnt.automount.\n\n    # systemctl start mnt.automount\n\n    # systemctl status mnt.automount\n    mnt.automount - My new automounted file system.\n    Loaded: loaded (/etc/systemd/system/mnt.automount; enabled; vendor preset: disabled)\n    Active: active (waiting) since Thu 2016-12-29 14:01:57 AST; 1min 2s ago\n        Where: /mnt\n\n    Dec 29 14:01:57 sue systemd[1]: Set up automount My new automounted file system..\n</code></pre> <p>Once it has been started the mount output shows the mount point enabled with autofs.</p> <pre><code>    # mount |grep mnt\n    systemd-1 on /mnt type autofs (rw,relatime,fd=25,pgrp=1,timeout=0,minproto=5,maxproto=5,direct)\n</code></pre> <p>The command <code>lsblk</code> shows that that disk is not mounted.</p> <pre><code>    # lsblk\n    NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\n    sda      8:0    0   30G  0 disk\n    |-sda1   8:1    0 28.8G  0 part /\n    |-sda2   8:2    0    1K  0 part\n    |-sda5   8:5    0  1.3G  0 part [SWAP]\n    sdb      8:16   0    1G  0 disk\n    |-sdb1   8:17   0 1023M  0 part\n</code></pre> <p>Let's do a file listing of the /mnt directory.</p> <pre><code>    # ls /mnt\n    lost+found\n</code></pre> <p>Then execute the command <code>lsblk</code> again to verify if partition sdb1 is mounted on /mnt.</p> <pre><code>    # lsblk\n    NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\n    sda      8:0    0   30G  0 disk\n    |-sda1   8:1    0 28.8G  0 part /\n    |-sda2   8:2    0    1K  0 part\n    |-sda5   8:5    0  1.3G  0 part [SWAP]\n    sdb      8:16   0    1G  0 disk\n    |-sdb1   8:17   0 1023M  0 part /mnt\n</code></pre> <p>The <code>mount</code> command shows the same.</p> <pre><code>    # mount | grep /mnt\n    systemd-1 on /mnt type autofs (rw,relatime,fd=25,pgrp=1,timeout=0,minproto=5,maxproto=5,direct)\n    /dev/sdb1 on /mnt type ext4 (rw,relatime,data=ordered)\n</code></pre> <p>Autofs combined with systemd is now working. See the manpage of systemd.automount(5) for more configuration options.</p>"},{"location":"lpic2.203.3/#cd-rom-filesystem","title":"CD-ROM filesystem","text":""},{"location":"lpic2.203.3/#creating-an-image-for-a-cd-rom","title":"Creating an image for a CD-ROM","text":"<p>The usual utilities for creating filesystems on hard-disk CD-ROM filesystem ISO9660 partitions write an empty filesystem onto them, which is then mounted and filled with files by the users as they need it. A writable CD is only writable once so if we wrote an empty filesystem to it, it would get formatted and remain completely empty forever. This is also true for re-writable media as you cannot change arbitrary sectors yet; you must erase the whole disk. The tool to create the filesystem is called <code>mkisofs</code>. A sample usage looks like this: mkisofs</p> <pre><code>    $ mkisofs -r -o cd_image private_collection/\n</code></pre> <p>The option <code>-r</code> sets the permissions of all files on the CD to be public readable and enables Rock Ridge extensions. You probably want to use this option unless you really know what you're doing (hint: without <code>-r</code> the mount point gets the permissions of private_collection!).</p> <p><code>mkisofs</code> will try to map all filenames to the 8.3 format used by DOS to ensure the highest possible 8.3 filename format compatibility. In case of naming conflicts (different files have the same 8.3 name), numbers are used in the filenames and information about the chosen filename is printed via STDERR (usually the screen). Don't panic: Under Linux you will never see these odd 8.3 filenames because Linux makes use of the Rock Ridge extensions which contain the original Rock Ridge file information (permissions, filename, etc.). Use the option <code>-J</code> (MS Joliet extensions) or use <code>mkhybrid</code> if you want to generate a more Windows-friendly CD-ROM. You can also use <code>mkhybrid</code> to create HFS CD-ROMS HFS Read the man-page for details on the various options. Another extention is El Torito, which is used to create bootable CD-ROM filesystems.</p> <p>Besides the ISO9660 filesystem as created by <code>mkisofs</code> there is the UDF (Universal Disk Format) filesystem. The Optical Storage Technology Association standardized the UDF filesystem to form a common filesystem for all (read-only and re-writable) optical media. It was intended to replace the ISO9660 filesystem.</p> <p>Tools to create and maintain a UDF filesystem are:</p> <p><code>mkudffs</code></p> <ul> <li>Creates a new UDF filesystem. Can be used on hard disks as well as     on CD-R(W).</li> </ul> <p><code>udffsck</code></p> <ul> <li>Used to check the integrity and correct errors on UDF filesystems.</li> </ul> <p><code>wrudf</code></p> <ul> <li>This command is used for maintaining UDF filesystems. It provides an     interactive shell with operations on existing UDF filesystems: cp,     rm, mkdir, rmdir, ls,.... etc.</li> </ul> <p><code>cdrwtool</code></p> <ul> <li>The <code>cdrwtool</code> provides facilities to manage CD-RW drives. This     includes formating new disks, setting the read and write speeds,     etc.</li> </ul> <p>These tools are part of the UDFtools package.</p> <p>Reasons why the output of <code>mkisofs</code> is not directly sent to the writer device:</p> <ul> <li> <p>mkisofs knows nothing about driving CD-writers;</p> </li> <li> <p>You may want to test the image before burning it;</p> </li> <li> <p>On slow machines it would not be reliable.</p> </li> </ul> <p>One could also think of creating an extra partition and writing the image to that partition instead to a file. This is possible, but has a few drawbacks. If you write to the wrong partition due to a typo, you could lose your complete Linux system. Furthermore, it is a waste of disk space because the CD-image is temporary data that can be deleted after writing the CD. However, using raw partitions saves you the time of deleting 650MB-sized files.</p>"},{"location":"lpic2.203.3/#test-the-cd-image","title":"Test the CD-image","text":"<p>Linux has the ability to mount files as if they were disk partitions. This feature is useful to check that the directory layout and file-access permissions of the CD image loop mount matches your wishes. Although media is very cheap today, the writing process is still time consuming, and you may at least want to save some time by doing a quick test.</p> <p>To mount the file cd_image created above on the directory <code>/cdrom</code>, give the command</p> <pre><code>    $ mount -t iso9660 -o ro,loop=/dev/loop0 cd_image /cdrom\n</code></pre> <p>Now you can inspect the files under <code>/cdrom</code> - they appear exactly as they were on a real CD. To unmount the CD-image, just say <code>umount /cdrom</code>.</p>"},{"location":"lpic2.203.3/#write-the-cd-image-to-a-cd","title":"Write the CD-image to a CD","text":"<p>The command <code>cdrecord</code> is used to write images to a SCSI CD-burner. Non-SCSI writers require cdrecord SCSI compatibility drivers, which make them appear as if they were real SCSI devices.</p> <p>CD-writers want to be fed a constant stream of data. So, the process of writing the image to the CD must not be interrupted or the CD may be corrupted. It is easy to unintentionally interrupt the data stream, for example by deleting a very large file. Say you delete an old 650 Mb CD-image - the kernel must update information on 650,000 blocks of the hard disk (assuming you have a block size of 1 Kb for your filesystem). That takes some time and will slow down disk activity long enough for the data stream to pause for a few seconds. However, reading mail, browsing the web, or even compiling a kernel generally will not affect the writing process on modern machines.</p> <p>Please note that no writer can re-position its laser and continue at the original spot on the CD when it gets disturbed. Therefore any strong vibrations or other mechanical shocks will probably destroy the CD you are writing.</p> <p>You need to find the SCSI-BUS, -ID and -LUN number with busSCSI LUN ID BUS <code>cdrecord -scanbus</code> and use these to write the CD:</p> <pre><code>    # SCSI_BUS=0 #\n    # SCSI_ID=6 # taken from cdrecord -scanbus\n    # SCSI_LUN=0 #\n    # cdrecord -v speed=2 dev=$SCSI_BUS,$SCSI_ID,$SCSI_LUN \\\n    -data cd_image\n\n    # same as above, but shorter:\n    # cdrecord -v speed=2 dev=0,6,0 -data cd_image\n</code></pre> <p>For better readability, the coordinates of the writer are stored in three environment variables whose names actually make sense: SCSI_BUS, SCSI_ID, SCSI_LUN.</p> <p>If you use cdrecord to overwrite a CD-RW, you must add the option <code>blank=...</code> to erase the old content. Please read the blank man page to learn more about the various methods of clearing the CD-RW.</p> <p>If the machine is fast enough, you can feed the output of mkisofs directly into cdrecord:</p> <pre><code>    # IMG_SIZE=`mkisofs -R -q -print-size private_collection/ 2&gt;&amp;1\\\n    | sed -e \"s/.* = //\"`\n\n    # echo $IMG_SIZE\n\n    # [ \"0$IMG_SIZE\" -ne 0 ] &amp;&amp; mkisofs -r\\\n    private_collection/ \\\n    | cdrecord speed=2 dev=0,6,0 tsize=${IMG_SIZE}s -data -\n\n    # don't forget the s --^ ^-- read data from STDIN\n</code></pre> <p>The first command is an empty run to determine the size of the image (you need the <code>mkisofs</code> from the <code>cdrecord</code> distribution for this to work). You need to specify all parameters you will use on the final run (e.g. <code>-J</code> or <code>-hfs</code>). If your writer does not need to know the size of the image to be written, you can leave this dry run out. The printed size must be passed as a tsize-parameter to <code>cdrecord</code> (it is stored in the environment variable IMG_SIZE). The second command is a sequence of <code>mkisofs</code> and <code>cdrecord</code>, coupled via a pipe.</p>"},{"location":"lpic2.203.3/#making-a-copy-of-a-data-cd","title":"Making a copy of a data CD","text":"<p>It is possible to make a 1:1 copy of a data CD. But you should be aware of the fact that any errors while reading the original (due to dust or scratches) will result in a defective copy. Please note that both methods will fail on audio CDs!</p> <p>First case: you have a CD-writer and a separate CD-ROM drive. By issuing the command</p> <pre><code>    # cdrecord -v dev=0,6,0 speed=2 -isosize /dev/scd0\n</code></pre> <p>you read the data stream from the CD-ROM drive attached as <code>/dev/scd0</code> and write it directly to the CD-writer.</p> <p>Second case: you don't have a separate CD-ROM drive. In this case you have to use the CD-writer to read out the CD-ROM first: dd</p> <pre><code>    # dd if=/dev/scd0 of=cdimage\n</code></pre> <p>This command reads the content of the CD-ROM from the device <code>/dev/scd0</code> and writes it into the file <code>cdimage</code>. The content of this file is equivalent to what <code>mkisofs</code> produces, so you can proceed as described earlier in this document (which is to take the file <code>cdimage</code> as input for <code>cdrecord</code>).</p>"},{"location":"lpic2.203.3/#encrypted-file-systems","title":"Encrypted file systems","text":"<p>Linux has native filesystem encryption support. You can choose from a number of symmetric encryption algorithms to encrypt your filesystem with, namely: Twofish, Advanced Encryption Standard (AES) also known as Rijndael, Data Encryption Standard (DES) and others. Twofish was also an AES candidate like Rijndael. Due performance reasons Rijndael was selected as the new AES standard. Twofish supports 128 bit block size and keys up to 256 bits. DES is the predecessor of the AES standard and is now considered as insecure because of the small key size. With current computing power it is possible to brute force 56 bits (+8 parity bits) DES keys in a relatively short time frame. AES uses a block size of 128 bits and a key size of 128, 192 or 256 bits. For many years 128 bits key size was sufficient but with the introduction of quantum computers the U.S. National Security Agency issued guidance for data classification up to Top Secret with 256 bits keys. Intel introduced in 2010 the Advanced Encryption Standard New Instructions (AES-NI) set. This new instruction set performs the encryption and decryption completely in hardware which helps to lower the risk of side-channel attacks and greatly improve AES performance. To check if your CPU supports the AES-NI instruction set use the command: <code>grep aes /proc/cpuinfo</code>. You can check AES-NI kernel support with the command: <code>sort -u /proc/crypto | grep module</code> and load the driver with the command: <code>modprobe aesni-intel</code> as root.</p>"},{"location":"lpic2.203.3/#device-mapper","title":"Device Mapper","text":"<p>As of linux 2.6 it is possible to use the devicemapper, a generic linux framework to map one block device to another. Devicemapper is used for software RAID and LVM. It is used as the filter between the filesystem on a virtual blockdevice and the encrypted data to be written to a hard disk. This enables the filesystem to present itself decrypted while everything read and written will be encrypted on disk. A virtual block device is created in <code>/dev/mapper</code>, which can be used as any other block device. All data to and from it goes to an encryption or decryption filter before being mapped to another blockdevice.</p>"},{"location":"lpic2.203.3/#device-mapper-crypt-dm-crypt","title":"Device Mapper crypt (dm-crypt)","text":"<p>Device mapper crypt provides a generic way for transparent encryption of block devices by using the kernel API and can be used in combination with RAID or LVM volumes. When the user creates a new block device he can specify several options: symmetric cipher, encryption mode, key and iv generation mode. Dm-crypt does not store any information in a header like LUKS does. After encrypting the disk it will be indistinguishable from a disk with random data. This means that the existence of of encrypted files deniable in the sense that it can not be proven that encrypted data exists. The user should keep track of the options that are used in the dm-crypt setup otherwise it could lead to data loss since no metadata is available. Only one encryption key can be used to encrypt and decrypt block devices and no master key can be used. Once the password of a encrypted block device is lost there is no possibility to recover the data. Dm-crypt should only be used by advanced users. Regular users should use LUKS for disk encryption.</p>"},{"location":"lpic2.203.3/#linux-unified-key-setup-luks","title":"Linux Unified Key Setup (LUKS)","text":"<p>LUKS is a standard utility on all generic linux distributions. It provides disk encryption for different type of volumes (plain dm-crypt volumes, LUKS volumes, etc.). It offers compatibility amongst distributions and provides secure management of user passwords. It also provides storage of cryptography options including the master key in the partition header enabling seamlessly transport or data migration. LUKS also provides up to 8 different keys per LUKS partition to enable key escrow (usage of keys per meaning). By creating encrypted partitions on different Linux distributions the default settings may vary but the settings are sufficient enough to protect the data on the volume(s). LUKS is the preferred method for data protection by regular users.</p>"},{"location":"lpic2.203.3/#example-with-dm-crypt","title":"Example with dm-crypt","text":"<p>This is an example to set up an encrypted filesystem. All relevant modules should be loaded at boot time:</p> <pre><code>    # echo aes &gt;&gt; /etc/modules\n    # echo dm_mod &gt;&gt; /etc/modules\n    # echo dm_crypt &gt;&gt; /etc/modules\n    # modprobe -a aes dm_mod dm_crypt\n</code></pre> <p>Create the device mapperblock device and use (for example) hda3 for it. Choose your password using: <code>cryptsetup -y create crypt /dev/hda3</code> Map the device:</p> <pre><code>    # echo \"crypt /dev/hda3 none none\" &gt;&gt; /etc/crypttab\n    # echo \"/dev/mapper/crypt /crypt reiserfs defaults 0 1\" &gt;&gt; /etc/fstab\n</code></pre> <p>Make a filesystem:</p> <pre><code>    # mkfs.reiserfs /dev/mapper/crypt\n</code></pre> <p>Now mount your encrypted filesystem. You will be prompted for the password you chose with cryptsetup. You will be asked to provide it at every boot:</p> <pre><code>    # mkdir /crypt\n    # mount /crypt\n</code></pre>"},{"location":"lpic2.203.3/#example-with-luks","title":"Example with LUKS","text":"<p>This is an example to create an 512 MiB encrypted LUKS container in a linux environment.</p> <pre><code>    # dd if=/dev/urandom of=/root/encrypted bs=1M count=512\n</code></pre> <p>Format the sparse file with LUKS and provide a passphrase:</p> <pre><code>    # cryptsetup -y luksFormat encrypted\n\n    WARNING!\n    ========\n    This will overwrite data on encrypted irrevocably.\n\n    Are you sure? (Type uppercase yes): YES\n    Enter passphrase:\n    Verify passphrase:\n</code></pre> <p>Open the container, provide a name and enter the passphrase:</p> <pre><code>    # cryptsetup luksOpen encrypted encrypted\n    Enter passphrase for encrypted:\n</code></pre> <p>Create a filesystem on the unencrypted container:</p> <pre><code>    mkfs.ext4 /dev/mapper/encrypted\n    mke2fs 1.43.3 (04-Sep-2016)\n    Creating filesystem with 522240 1k blocks and 130560 inodes\n    Filesystem UUID: 9fb28cc0-5a3e-4e0b-b3cc-3cbd6cf3c8f4\n    Superblock backups stored on blocks:\n            8193, 24577, 40961, 57345, 73729, 204801, 221185, 401409\n\n    Allocating group tables: done   \n    Writing inode tables: done\n    Creating journal (8192 blocks): done\n    Writing superblocks and filesystem accounting information: done\n</code></pre> <p>Mount the encrypted container for usage:</p> <pre><code>    # mount /dev/mapper/encrypted /mnt\n</code></pre> <p>Encrypted container as filesystem:</p> <pre><code>    # df -h\n    Filesystem             Size  Used Avail Use% Mounted on\n    udev                    10M     0   10M   0% /dev\n    tmpfs                  792M   26M  767M   4% /run\n    /dev/sda1               29G   16G   11G  60% /\n    tmpfs                  2.0G  400K  2.0G   1% /dev/shm\n    tmpfs                  5.0M     0  5.0M   0% /run/lock\n    tmpfs                  2.0G     0  2.0G   0% /sys/fs/cgroup\n    tmpfs                  396M   16K  396M   1% /run/user/133\n    tmpfs                  396M   20K  396M   1% /run/user/0\n    /dev/mapper/encrypted  486M  2.3M  455M   1% /mnt\n</code></pre> <p>Content of /mnt as any ext4 filesystem:</p> <pre><code>    # ls /mnt\n    lost+found\n</code></pre> <p>Unmount the encrypted container after usage:</p> <pre><code>    # umount /mnt\n</code></pre> <p>Close the encrypted container:</p> <pre><code>    # cryptsetup luksClose /dev/mapper/encrypted\n</code></pre>"},{"location":"lpic2.204.0/","title":"Advanced Storage Device Administration (204)","text":"<p>This topic has a weight of 8 points and contains the following objectives:</p>"},{"location":"lpic2.204.0/#objective-2041-configuring-raid-3-points","title":"Objective 204.1; Configuring RAID (3 points)","text":"<ul> <li>Candidates should be able to configure and implement software RAID.     This objective includes using and configuring RAID 0, 1 and 5.</li> </ul>"},{"location":"lpic2.204.0/#objective-2042-adjusting-storage-device-access-2-points","title":"Objective 204.2; Adjusting Storage Device Access (2 points)","text":"<ul> <li>Candidates should be able to configure kernel options to support     various drives. This objective includes software tools to view and     modify hard disk settings.</li> </ul>"},{"location":"lpic2.204.0/#objective-2043-logical-volume-manager-3-points","title":"Objective 204.3; Logical Volume Manager (3 points)","text":"<ul> <li>Candidates should be able to create and remove logical volumes and     physical volumes. This objective includes snapshots, and resizing     logical volumes.</li> </ul>"},{"location":"lpic2.204.1/","title":"Configuring RAID (204.1)","text":""},{"location":"lpic2.204.1/#configuring-raid-2041","title":"Configuring RAID (204.1)","text":"<p>Candidates should be able to configure and implement software RAID. This objective includes using and configuring RAID 0, 1, and 5.</p>"},{"location":"lpic2.204.1/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li>Software raid configuration files and utilities</li> </ul>"},{"location":"lpic2.204.1/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>mdadm</code></p> </li> <li> <p><code>mdadm.conf</code></p> </li> <li> <p><code>fdisk</code></p> </li> <li> <p><code>/proc/mdstat</code></p> </li> </ul>"},{"location":"lpic2.204.1/#what-is-raid","title":"What is RAID?","text":"<p>RAID stands for \"Redundant Array of Inexpensive Disks\".</p> <p>The basic idea behind RAID is to combine multiple small, inexpensive disk drives into an array which yields performance exceeding that of one large and expensive drive. This array of drives will appear to the computer as a single logical storage unit or drive.</p> <p>Some of the concepts used in this chapter are important factors in deciding which level of RAID to use in a particular situation. Parity is a concept used to add redundancy to storage. A parity bit is a binary digit which is added to ensure that the number of bits with value of one in a given set of bits is always even or odd. By using part of the capacity of the RAID for storing parity bits in a clever way, single disk failures can happen without data-loss since the missing bit can be recalculated using the parity bit. I/O transactions are movements of data to or from a RAID device or its members. Each I/O transaction consists of one or more blocks of data. A single disc can handle a maximum random number of transactions per second, since the mechanism has a seek time before data can be read or written. Depending on the configuration of the RAID, a single I/O transaction to the RAID can trigger multiple I/O transactions to its members. This affects the performance of the RAID device in terms of maximum number of I/O transactions and data transfer rate. Data transfer rate is the amount of data a single disk or RAID device can handle per second. This value usually varies for read and write actions, random or sequential access etc.</p> <p>RAID is a method by which information is spread across several disks, using techniques such as disk striping (RAID Level 0), disk mirroring (RAID level 1), and striping with distributed parity (RAID Level 5), to achieve redundancy, lower latency and/or higher bandwidth for reading and/or writing to disk, and maximize recoverability from hard-disk crashes.</p> <p>The underlying concept in RAID is that data may be distributed across each drive in the array in a consistent manner. To do this, the data must first be broken into consistently-sized chunks (often 32K or 64K in size, although different sizes can be used). Each chunk is then written to each drive in turn. When the data is to be read, the process is reversed, giving the illusion that multiple drives are actually one large drive. Primary reasons to use RAID include:</p> <ul> <li> <p>enhanced transfer speed</p> </li> <li> <p>enhanced number of transactions per second</p> </li> <li> <p>increased single block device capacity</p> </li> <li> <p>greater efficiency in recovering from a single disk failure</p> </li> </ul>"},{"location":"lpic2.204.1/#raid-levels","title":"RAID levels","text":"<p>There are a number of different ways to configure a RAID subsystem - some maximize performance, others maximize availability, while others provide a mixture of both. For the LPIC-2 exam the following are relevant:</p> <ul> <li> <p>RAID-0 (striping)</p> </li> <li> <p>RAID-1 (mirroring)</p> </li> <li> <p>RAID-\u2158</p> </li> <li> <p>Linear mode</p> </li> </ul>"},{"location":"lpic2.204.1/#level-0","title":"Level 0","text":"<p>RAID 0 striping RAID level 0, often called \"striping\", is a performance-oriented striped data mapping technique. This means the data being written to the array is broken down into strips and written across the member disks of the array. This allows high I/O performance at low inherent cost but provides no redundancy. Storage capacity of the array is equal to the sum of the capacity of the member disks. As a result, RAID 0 is primarily used in applications that require high performance and are able to tolerate lower reliability.</p>"},{"location":"lpic2.204.1/#level-1","title":"Level 1","text":"<p>RAID 1 mirroring RAID level 1, or \"mirroring\", has been used longer than any other form of RAID. Level 1 provides redundancy by writing identical data to each member disk of the array, leaving a mirrored copy on each disk. Mirroring remains popular due to its simplicity and high level of data availability. Level 1 operates with two or more disks that may use parallel access for high data-transfer rates when reading, but more commonly operate independently to provide high I/O transaction rates. Level 1 provides very good data reliability and improves performance for read-intensive applications but at a relatively high cost. Array capacity is equal to the capacity of the smallest member disk.</p>"},{"location":"lpic2.204.1/#level-4","title":"Level 4","text":"<p>RAID 4 RAID level 4 uses parity concentrated on a single disk drive to protect data. It is better suited to transaction I/O rather than large file transfers. Because the dedicated parity disk represents an inherent bottleneck, level 4 is seldom used without accompanying technologies such as write-back caching. Array capacity is equal to the capacity of member disks, minus the capacity of one member disk.</p>"},{"location":"lpic2.204.1/#level-5","title":"Level 5","text":"<p>RAID 5 The most common type of RAID is level 5 RAID. By distributing parity across some or all of the member disk drives of an array, RAID level 5 eliminates the write bottleneck inherent in level 4. The only bottleneck is the parity calculation process. Because the widespread use of modern CPUs and software RAID that is not really an issue anymore. As with level 4, the result is asymmetrical performance, with reads substantially outperforming writes. Level 5 is often used with write-back caching to reduce the asymmetry. The capacity of the array is equal to the total capacity of all member disks, minus the capacity of one member disk. Upon failure of a single member disk, subsequent reads can be calculated from the distributed parity such that no data is lost. RAID 5 requires at least three disks.</p>"},{"location":"lpic2.204.1/#linear-raid","title":"Linear RAID","text":"<p>Linear RAID is a simple grouping of drives to create a larger virtual drive. In linear RAID the chunks are allocated sequentially from one member drive, going to the next drive only when the first is completely filled. The difference with \"striping\" is that there is no performance gain for single process applications, mostly everything is written to one and the same disk. The disk(partition)s can have different sizes whereas \"striping\" requires them to be roughly the same size. If you have a larger number of mostly used disks in a linear RAID setup, multiple processes may benefit during reads as each process may access a different drive. Linear RAID also offers no redundancy, and in fact decreases reliability; if any one member drive fails, the entire array cannot be used. The capacity is the total of all member disks.</p> <p>RAID can be implemented either in hardware or in software; both scenarios are explained below.</p>"},{"location":"lpic2.204.1/#hardware-raid","title":"Hardware RAID","text":"<p>RAID hardware The hardware-based system manages the RAID subsystem independently from the host and presents to the host only a single disk per RAID array.</p> <p>A typical hardware RAID device might connect to a SCSI controller and present the RAID array(s) as a single SCSI drive. An external RAID system moves all RAID handling intelligence into a controller located in the external disk subsystem.</p> <p>SCSI RAID controllers also come in the form of cards that act like a SCSI controller to the operating system, but handle all of the actual drive communications themselves. In these cases, you plug the drives into the RAID controller just as you would a SCSI controller, but then you add them to the RAID controller's configuration, and the operating system never knows the difference.</p>"},{"location":"lpic2.204.1/#software-raid","title":"Software RAID","text":"<p>Software RAID implements the various RAID levels in the kernel disk (block device) code. It also offers the cheapest possible solution: Expensive disk controller cards or hot-swap chassis are not required, and software RAID works with cheaper SATA disks as well as SCSI disks. With today's fast CPUs, software RAID performance can excel in comparison with hardware RAID.</p> <p>MD Software RAID allows you to dramatically increase Linux disk I/O performance and reliability without having to buy expensive hardware RAID controllers or enclosures. The MD driver in the Linux kernel is an example of a RAID solution that is completely hardware independent. The performance of a software-based array is dependent on the server CPU performance and load. Also, the implementation and setup of the software RAID solution can significantly influence performance.</p> <p>The concept behind software RAID is simple - it allows you to combine two (three, at least, for RAID5) or more block devices (usually disk partitions) into a single RAID device. So if you have three empty partitions (for example: <code>hda3</code>, <code>hdb3</code>, and <code>hdc3</code>), using Software RAID you can combine these partitions and address them as a single RAID device, <code>/dev/md0</code>. <code>/dev/md0</code> can then be formatted to contain a filesystem and be used like any other partition.</p>"},{"location":"lpic2.204.1/#recognizing-raid-on-your-linux-system","title":"Recognizing RAID on your Linux system","text":"<p>Detecting hardware raid on a Linux system can be tricky and there is not one sure way to do this. Since hardware RAID tries to present itself to the operating system as a single block device, it often shows up as a single SCSI disc when querying the system. Often special vendor software or physical access to the equipment is required to adequately detect and identify hardware RAID equipment. Software raid can be easily identified by the name of the block device (/dev/mdn) and its major number 9.</p>"},{"location":"lpic2.204.1/#mdadm","title":"Configuring RAID (using <code>mdadm</code>)","text":"<p>Configuring software RAID using <code>mdadm</code> (Multiple Devices Admin) requires only that the md driver be configured into the kernel, or loaded as a kernel module. The optional <code>mdadm.conf</code> file may be used to direct <code>mdadm</code> in the simplification of common tasks, such as defining multiple arrays, and defining the devices used by them. The <code>mdadm.conf</code> has a number of possible options, described later in this document, but generally, the file details arrays and devices. It should be noted that, although not required, the <code>mdadm.conf</code> greatly reduces the burden on administrators to \"remember\" the desired array configuration when launching. The <code>mdadm</code> is used (as its acronym suggests) to configure and manage multiple devices. Multiple is key here. In order for RAID to provide any kind of redundancy to logical disks, there must obviously be at the very least two physical block devices (three for RAID5) in the array to establish redundancy, ergo protection. Since <code>mdadm</code> manages multiple devices, its application is not limited solely to RAID implementations, but may be also be used to establish multi-pathing. <code>mdadm</code> has a number of modes, listed below</p>"},{"location":"lpic2.204.1/#assemble","title":"Assemble","text":"<p>\"Rebuilds\" a pre existing array. Typically used when migrating arrays to new hosts, but more often used from system startup to launch a pre existing array.</p>"},{"location":"lpic2.204.1/#build","title":"Build","text":"<p>Does not create array superblocks, and therefore does not destroy any pre existing data. May be useful when attempting to recover or access stale data. (can not be used in combination with <code>mdadm.conf</code>). Typically used with legacy arrays, and rarely used.</p>"},{"location":"lpic2.204.1/#create","title":"Create","text":"<p>Creates an array from scratch, using pre-existing block devices, and activates the array.</p>"},{"location":"lpic2.204.1/#grow","title":"Grow","text":"<p>Used to modify a existing array, for example adding, or removing devices. Capability is expected to be extended during the development lifecycle of the 2.6 kernel.</p>"},{"location":"lpic2.204.1/#misc","title":"Misc","text":"<p>Used for performing various loosely bundled housekeeping tasks. Can be used to generate the initial mdadm.conf file for an existing array, setting the array into read only, and read/write modes, and for checking the status of array devices. The more typical uses are described in more detail later on in this section.</p> <p>The Linux kernel provides a special driver, <code>/dev/md0</code>, to access separate disk partitions as a logical RAID unit. These partitions under RAID do not actually need to be different disks, but in order to eliminate risks it is better to use different disks. <code>mdadm</code> may also be used to establish multipathing, also over filesystem devices (since multipathing is established at the block level). However, as with establishing RAID over multiple filesystems on the same physical disk, multipathing on the same physical disk provides only the vague illusion of redundancy, and its use should probably be restricted to test purposes only or out of pure curiosity.</p>"},{"location":"lpic2.204.1/#setting-up-software-raid","title":"Setting up software RAID","text":"<p>Follow these steps to set up software RAID in Linux:</p> <ol> <li> <p>Configure the RAID driver</p> </li> <li> <p>Initialise the RAID drive</p> </li> <li> <p>Check the replication using <code>/proc/mdstat</code></p> </li> <li> <p>Automate RAID activation after reboot</p> </li> <li> <p>Mount the filesystem on the RAID drive</p> </li> </ol> <p>Each of these steps is now described in detail:</p>"},{"location":"lpic2.204.1/#initialize-partitions-to-be-used-in-the-raid-setup","title":"Initialize partitions to be used in the RAID setup","text":"<p>Create partitions using any disk partitioning tool.</p>"},{"location":"lpic2.204.1/#configure-the-driver","title":"Configure the driver","text":"<p>A driver file for each independant array will be automatically created when <code>mdadm</code> creates the array, and will follow the convention <code>/dev/md[n]</code> for each increment. It may also be manually created using <code>mknod</code> and building a block device file, with a major number 9 (md device driver found in <code>/proc/devices</code>).</p>"},{"location":"lpic2.204.1/#initialize-raid-drive","title":"Initialize RAID drive","text":"<p>Here is an example of the sequence of commands needed to create and format a RAID drive:</p> <ol> <li> <p>Prepare the partition for auto RAID detection using <code>fdisk</code></p> <p>In order for a partition to be automatically recognised as part of a RAID set, it must first have its partition type set to \"fd\". This may be achieved by using the <code>fdisk</code> command menu, and using the <code>t</code> option to change the setting. Available settings may be listed by using the <code>l</code> menu option. The description may vary accross implementations, but should clearly show the type to be a Linux auto raid. Once set, the settings must be saved back to the partition table using the <code>w</code> option.</p> <p>In working practice, it may be that a physical disk containing the chosen partition for use in a RAID set also contains partitions for local filesystems which are not intended for inclusion within the RAID set. In order for <code>fdisk</code> to write back the changed partition table, all of the partitions on the physical disk must not be in use. For this reason, RAID build planning should take into account factors which may not allow the action to be performed truly online (i.e will require downtime).</p> </li> <li> <p>Create the array raidset using <code>mdadm</code></p> <p>To create an array for the first time, we need to have identified the partitions that will be used to form the RAIDset, and verify with <code>fdisk -l</code> that the fd partition type has been set. Once this has been achieved, the array may be created as follows. <code>mdadm</code> -C /dev/md0 -l raid5 -n 3 /dev/partition1 /dev/partition2 /dev/partition3</p> <p>This would create, and activate a raid5 array called md0,containing three devices, named /dev/partition1 /dev/partition2, and /dev/partiton3. Once created and running, the status of the array may be checked by <code>cat</code>'ing <code>/proc/mdstat</code>.</p> </li> <li> <p>Create filesystems on the newly created raidset</p> <p>The newly created RAID set may then be addressed as a single device using the <code>/dev/md0</code> device file, and formatted and mounted as normal. For example: <code>mkfs.ext3</code> <code>/dev/md0</code>.</p> </li> <li> <p>Create the <code>/etc/mdadm.conf</code> using the <code>mdadm</code> command.</p> <p>Creating the <code>/etc/mdadm.conf</code> file is pleasantly simple, requiring only that <code>mdadm</code> be called with the <code>--scan</code>, <code>--verbose</code>, and <code>--detail</code> options, and its standard output redirected. It may therefore also be used as a handy tool for determining any changes on the array simply by <code>diff</code>'ing the current and stored output. Create as follows:</p> <pre><code>mdadm --detail --scan --verbose &gt; /etc/mdadm.conf\n</code></pre> </li> <li> <p>Create mount points and edit <code>/etc/fstab</code></p> <p>Care must be taken that any recycled partitions used in the RAID set be removed from the <code>/etc/fstab</code> if they still exist.</p> </li> <li> <p>Mount filesystems using <code>mount</code></p> <p>If the array has been created online, and a reboot has not been executed, then the file systems will need to be manually mounted, either manually using the <code>mount</code> command, or simply using <code>mount -a</code></p> </li> </ol>"},{"location":"lpic2.204.1/#check-the-replication-using-procmdstat","title":"Check the replication using <code>/proc/mdstat</code>","text":"<p>The <code>/proc/mdstat</code> file shows the state of the kernels RAID/md driver.</p>"},{"location":"lpic2.204.1/#automate-raid-activation-after-reboot","title":"Automate RAID activation after reboot","text":"<p>raidstart</p> <p>Run <code>mdadm --assemble</code> in one of the startup files (e.g. <code>/etc/rc.d/rc.sysinit</code> or <code>/etc/init.d/rcS</code>) When called with the <code>-s</code> option (scan) to <code>mdadm                 --assemble</code>, instructs <code>mdadm</code> to use the <code>/etc/mdadm.conf</code> if it exists, and otherwise to fallback to <code>/proc/mdstat</code> for missing information. A typical system startup entry could be for example, <code>mdadm --assemble -s</code>.</p>"},{"location":"lpic2.204.1/#mount-the-filesystem-on-the-raid-drive","title":"Mount the filesystem on the RAID drive","text":"<p>Edit <code>/etc/fstab</code> to automatically mount the filesystem on the RAID drive. The entry in <code>/etc/fstab</code> is identical to normal block devices containing file systems.</p>"},{"location":"lpic2.204.1/#manual-raid-activation-and-mounting","title":"Manual RAID activation and mounting","text":"<p>Run <code>mdadm --assemble</code> for each RAID block device you want to start manually. After starting the RAID device you can mount any filesystem present on the device using <code>mount</code> with the appropriate options.</p>"},{"location":"lpic2.204.1/#configuring-raid-alternative","title":"Configuring RAID (alternative)","text":"<p>Instead of managing RAID via <code>mdadm</code>, it can be configured via <code>/etc/raidtab</code> and controlled via the <code>mkraid</code>, <code>raidstart</code>, and <code>raidstop</code> utilities.</p> <p>Here's an example <code>/etc/raidtab</code>:</p> <pre><code>    #\n    # Sample /etc/raidtab configuration file\n    #\n    raiddev /dev/md0\n      raid-level              0\n      nr-raid-disks           2\n      persistent-superblock   0\n      chunk-size              8\n\n      device                  /dev/hda1\n      raid-disk               0\n      device                  /dev/hdb1\n      raid-disk               1\n\n    raiddev /dev/md1\n      raid-level              5\n      nr-raid-disks           3\n      nr-spare-disks          1\n      persistent-superblock   1\n      parity-algorithm        left-symmetric\n\n      device                  /dev/sda1\n      raid-disk               0\n      device                  /dev/sdb1\n      raid-disk               1\n      device                  /dev/sdc1\n      raid-disk               2\n      device                  /dev/sdd1\n      spare-disk              0\n</code></pre> <p>The <code>mkraid</code>, <code>raidstart</code>, and <code>raidstop</code> utilities all use this file as input and respectively configure, activate (start) and unconfigure (stop) RAID devices. All of these tools work similiarly. If -a (or --all) is specified, the specified operation is performed on all of the RAID devices mentioned in the configuration file. Otherwise, one or more RAID devices must be specified on the command line.</p> <p>Refer to the manual pages for raidtab(8), mdstart(8) and raidstart, raidstop(8) for details.</p>"},{"location":"lpic2.204.2/","title":"Adjusting Storage Device Access (204.2)","text":""},{"location":"lpic2.204.2/#adjusting-storage-device-access-2042","title":"Adjusting Storage Device Access (204.2)","text":"<p>Candidates should be able to configure kernel options to support various drives. This objective includes software tools to view and modify hard disk settings including iSCSI devices.</p>"},{"location":"lpic2.204.2/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Tools and utilities to configure DMA for IDE devices including ATAPI     and SATA</p> </li> <li> <p>Tools and utilities to manipulate or analyse system resources (e.g.     interrupts)</p> </li> <li> <p>Awareness of <code>sdparm</code> command and its uses</p> </li> <li> <p>Tools and utilities for iSCSI</p> </li> <li> <p>SSD and NVMe configuration and awareness of SAN</p> </li> </ul>"},{"location":"lpic2.204.2/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>hdparm</code></p> </li> <li> <p><code>sdparm</code></p> </li> <li> <p><code>tune2fs</code></p> </li> <li> <p><code>sysctl</code></p> </li> <li> <p><code>iscsiadm, scsi_id, iscsid</code> and <code>iscsid.conf</code></p> </li> <li> <p><code>/dev/hd*</code> and <code>/dev/sd*</code></p> </li> <li> <p>WWID, WWN, LUN numbers</p> </li> </ul>"},{"location":"lpic2.204.2/#configuring-disks","title":"Configuring disks","text":""},{"location":"lpic2.204.2/#configuring-iscsi","title":"Configuring iSCSI","text":"<p>iSCSI is an abbreviation of Internet Small Computer System Interface. iSCSI is simply a networked implementation of the well-known standardized SCSI protocol. SCSI defines a model, cabling, electrical signals and commands to use to access various devices. iSCSI uses just the model and the commands. SCSI (and hence: iSCSI) can be used to access all kinds of devices and though mostly used for disks and tape-units has been used to access USB storage, printers and flatbed scanners too, just to name a few.</p> <p>The iSCSI setup is similar to the SCSI setup as it consists of a client and a server. In between is an IP based network, which can be a LAN, WAN or the Internet. The client issues low level SCSI commands as usual (e.g. <code>read</code>, <code>write</code>, <code>seek</code> or <code>erase</code>). The commands can be encrypted by the client and are then encapsulated and sent over the network. The server receives and possibly decrypts the commands and executes the commands. Unlike traditional Fibre Channel, which requires special-purpose cabling, iSCSI can be run over long distances using existing network infrastructure.</p> <p>Clients are refered to as \"initiators\". The commands are referred to as \"CDBs\" (Command Descriptor Blocks) and the server storage devices are known as \"targets\".</p> <p>Definitions: iSCSI target, iSCSI initiator The exported storage entity is the target and the importing entity is the initiator.</p>"},{"location":"lpic2.204.2/#iscsi-initiator","title":"iSCSI Initiator","text":"<p>On Linux hosts that act as a client (initiator) to a iSCSI server (target) you will need to install the client software. You will also need to edit the configuration file so you can discover the desired target(s). On Red Hat Linux and its derivatives the configuration file is <code>/etc/iscsi/iscsid.conf</code>. Edit the file so it points to the proper server (target) and contains a set of valid credentials - see example file at the bottom of this segment.</p> <p>After configuration, ensure that the iSCSI service runs using the following command:</p> <pre><code>    /etc/init.d/iscsi status\n</code></pre> <p>If needed start the iSCSI service using the following command:</p> <pre><code>    /etc/init.d/iscsi start\n</code></pre> <p>iscsiadm Use the <code>iscsiadm</code> command to discover the targets. Where our example shows questionmarks, substitute the IP address of the target:</p> <pre><code>    iscsiadm -m discovery -t sendtargets -p ???.???.???.???\n</code></pre> <p>After successfully discovering targets you can log in into the volumes that were discovered. This can be done with the <code>iscsiadm</code> tool, which can also be used to log out of a volume. A fast way to add newly discovered volumes is to restart the iscsi service:</p> <pre><code>    /etc/init.d/iscsi restart\n</code></pre> <p>Hint:</p> <p>When adding an iscsi mount point to the <code>fstab</code> file use the <code>_netdev</code> option:</p> <pre><code>    /dev/sdb1 /mnt/iscsi ext3(4) _netdev 0 0\n</code></pre> <p>The <code>_netdev</code> option ensures that the network is up before trying to mount the device.</p> <p>Example <code>/etc/iscsi/iscsid.config</code>:</p> <pre><code>    ###############\n    # iSNS settings\n    ###############\n    # Address of iSNS server\n    isns.address = ***.***.***.***\n    isns.port = 3260\n\n    # *************\n    # CHAP Settings\n    # *************\n\n    # To enable CHAP authentication set node.session.auth.authmethod\n    # to CHAP. The default is None.\n    node.session.auth.authmethod = CHAP\n\n    # To set a CHAP username and password for initiator\n    # authentication by the target(s), uncomment the following lines:\n    node.session.auth.username = ********\n    node.session.auth.password = ********\n\n    # To enable CHAP authentication for a discovery session to the target\n    # set discovery.sendtargets.auth.authmethod to CHAP. The default is None.\n    discovery.sendtargets.auth.authmethod = CHAP\n\n    # To set a discovery session CHAP username and password for the initiator\n    # authentication by the target(s), uncomment the following lines:\n    discovery.sendtargets.auth.username = ********\n    discovery.sendtargets.auth.password = ********\n</code></pre>"},{"location":"lpic2.204.2/#iscsi-target","title":"iSCSI Target","text":"<p>There are a number of ways to set up a target. The SCSI Target Framework (STGT/TGT) was the standard before linux 2.6.38. The current standard is the LIO target.</p> <p>Another well-known implementation was the iSCSI Enterprise Target (IET) and its successor the SCSI Target Subsystem (SCST). IET was a candidate for kernel inclusion too, but LIO was the final choice. LIO (an abbreviation of linux-iscsi.org) now is the standard open-source SCSI Target for shared data storage in Linux. It supports all prevalent storage fabrics, including Fibre Channel (QLogic), FCoE, iEEE 1394, iSCSI, iSER (Mellanox InfiniBand), SRP (Mellanox InfiniBand), USB, vHost, etc.</p>"},{"location":"lpic2.204.2/#adding-a-new-target-on-the-target-host","title":"Adding a new target (on the target host)","text":"<p>To add a new iSCSI target edit the <code>/etc/tgt/targets.conf</code> configuration file. This file contains many examples of different configuration options that have been commented out. A basic target may be defined as:</p> <pre><code>    &lt;target iqn.2008-09.com.example:server.target1&gt;\n        backing-store /srv/images/iscsi-share.img\n        direct-store /dev/sdd\n    &lt;/target&gt;\n</code></pre> <p>This example defines a single target with two LUNs. LUNs are described with either the backing-store or direct-store directives where backing-store refers to either a file or a block device, and direct-store refers to local SCSI devices. Device parameters, such as serial numbers and vendor names, will be passed through to the new iSCSI LUN.</p> <p>The target service is aptly named <code>tgtd</code>. To start it run:</p> <pre><code>    # service tgtd start\n</code></pre> <p>To stop the <code>tgtd</code> service, run:</p> <pre><code>    # service tgtd stop\n</code></pre> <p>If there are open connections, use:</p> <pre><code>    # service tgtd force-stop\n    Warning Using this command will terminate all target arrays.\n</code></pre>"},{"location":"lpic2.204.2/#wwid","title":"WWID","text":"<p>Any connected SCSI device is assigned a unique device name. The device name begins with <code>/dev/sd</code>, for example <code>/dev/sdd</code>, <code>/dev/sda</code>. Additionally, each SCSI device has a unique World Wide Identifier (WWID). The identifier can be obtained from the device itself by issuing the <code>inquiry</code> command. On Linux systems you can find the WWIDs in the <code>/dev/disk/by-id/</code> directory, in which you will find symbolic links whose names contain the WWID and which point to the assigned device name. There are two types of WWIDs, known as 'page 0x83' and 'page 0x80' and any SCSI device has one of these.</p> <p>For example, a device with a page 0x83 identifier would have:</p> <pre><code>    scsi-3600508b400105e210000900000490000 -&gt; ../../sda\n</code></pre> <p>Or, a device with a page 0x80 identifier would have:</p> <pre><code>    scsi-SSEAGATE_ST373453LW_3HW1RHM6 -&gt; ../../sda\n</code></pre> <p>Red Hat Enterprise Linux automatically maintains the proper mapping from the WWID-based device name to a current <code>/dev/sd</code> name on that system. Applications can use the <code>/dev/disk/by-id/</code> name to reference the data on the disk, even if the path to the device changes, and even when accessing the device from different systems. This also allows detection and access to plugable devices, say a photocamera. If it is plugged in, the system will sent a <code>inquiry</code> command and will create the proper symbolic link, hence allowing you to access the camera under the same name.</p> <p>It is possible and feasible to have more than one path to a device, for example to offer a fail-over or fall-back option and/or to increase performance. Such \"paths\" might be implemented as additional network paths (preferably using their own network card) or over fibre (preferably using their own HBAs) etc. If there are multiple paths from a system to a device, a special kernel-module and associated daemons and other software will use the WWID to detect the paths. A single \"pseudo-device\" in <code>/dev/mapper/wwid</code> will be created by them, such as <code>/dev/mapper/3600508b400105df70000e00000ac0000</code>, which will give access to the device, regardless which path(s) to it there are in use, as long as at least one of them can be used ('is active').</p> <p>The command <code>multipath -l</code> shows the mapping to the non-persistent identifiers: Host:Channel:Target:LUN, <code>/dev/sd</code> name, and the major:minor number:</p> <pre><code>    3600508b400105df70000e00000ac0000 dm-2 vendor,product \n    [size=20G][features=1 queue_if_no_path][hwhandler=0][rw] \n    \\_ round-robin 0 [prio=0][active] \n    \\_ 5:0:1:1 sdc 8:32  [active][undef] \n    \\_ 6:0:1:1 sdg 8:96  [active][undef]\n    \\_ round-robin 0 [prio=0][enabled] \n    \\_ 5:0:0:1 sdb 8:16  [active][undef] \n    \\_ 6:0:0:1 sdf 8:80  [active][undef]\n</code></pre> <p>Device-mapper-multipath automatically maintains the proper mapping of each WWID-based device name to its corresponding <code>/dev/sd</code> name on the system. These names are persistent a cross path changes, and they are consistent when accessing the device from different systems. When the user_friendly_names feature (of device-mapper-multipath) is used, the WWID is mapped to a name of the form <code>/dev/mapper/mpathn</code>. By default, this mapping is maintained in the file <code>/etc/multipath/bindings</code>. These <code>mpath</code> names are persistent as long as the file is maintained.</p> <p>Note Important If you use user_friendly_names, then additional steps are required to obtain consistent names in a cluster. Refer to the Consistent Multipath Device Names in a Cluster section in the Using DM Multipath Configuration and Administration book.</p>"},{"location":"lpic2.204.2/#lun","title":"LUN","text":"<p>Another way to address a SCSI device is by using its LUN, the Logical unit number. The LUN is a three bit number (0..7) which indicates a device within a target. Any target should at least have a device with LUN 0, which can be used like any device, but is also capable of providing information about the other LUNs in the device (if any). If there is just one device in a target that device has LUN 0 as any target should have a LUN 0.</p> <p>Say you bought a SCSI device that contained three disks (all connected over the same SCSI cable). To find out how many disks there are in your target (or tape units etc.) you would sent an inquiry to LUN 0. The device that has LUN 0 is designed to be able to tell you the configuration and might report that it knows of other devices. To address these the client uses the LUNs as specified by LUN 0.</p> <p>Because SCSI disks were often refered to by their LUN, the habit stuck and nowadays the term is also used to refer to a logical disk in a SAN. But there can be many more LUNs in a SAN than the humble 7 that are used in older configurations. Also, such a SAN-LUN may well consist of series of disks, which might possibly be configured as a RAID, possibly subdivided in volumes etc. - to the client, it is just a disk with a LUN.</p>"},{"location":"lpic2.204.2/#configuring-device-name-persistence-aka-lun-persistence","title":"Configuring device name persistence (aka LUN persistence)","text":"<p>Linux device names may change upon boot. This can lead to confusion and damage to data. Therefore, there are a number of techniques that allow persistent names for devices. This section covers how to implement device name persistence in guests and on the host machine with and without multipath. Persistence simply means that you will have the same name for the device, regardles its access paths. So, your camera or disk is always recognised as such and will be issued the same device name, regardless where you plug it in.</p>"},{"location":"lpic2.204.2/#implementing-device-name-persistence-without-multipath","title":"Implementing device name persistence without multipath","text":"<p>If your system is not using multipath, you can use <code>udev</code> to implement LUN persistence. <code>udev</code> is a device manager that listens to an interface with the kernel. If a new device is plugged in or a device is being detached, <code>udev</code> will receive a signal from the kernel and, using a set of rules, will perform actions, for example assign an additional device name to the device.</p> <p>Before implementing LUN persistence in your system you will first need to acquire the proper WWIDs from the devices you want to control. This can be done by using the <code>scsi_id</code> program. After you required the WWIDs of your devices, you will need to write a rule so <code>udev</code> can assign a persistent name to it.</p> <p>scsi_id A minor hurdle has to be taken first. The <code>scsi_id</code> program will not list any device by default and will only list devices it has been told to see ('whitelisted' devices). To whitelist a device you will need to add its WWID to the <code>scsi_id</code> configuration file, which is <code>/etc/scsi_id.conf</code>. That's safe, but a nuisance if you want to discover WWIDs of new devices. Hence you can specify the <code>-g</code> option to allow detection of any disk that has not been listed yet. If you feel that this should be the default behaviour, you may consider editing <code>/etc/scsi_id.conf</code>. If there is a line that says:</p> <pre><code>    options=-b\n</code></pre> <p>delete it or comment it out. Then add a line that says:</p> <pre><code>    options=-g\n</code></pre> <p>If this has been configured, next time a program uses the <code>scsi_id</code> command, it will add the <code>-g</code> option (and any other options you might have specified in the configuration file) and hence allow extracting the WWIDs from new devices. The <code>-g</code> should be used either by default from the configuration file or be set manually in any <code>udev</code> rule that uses the <code>scsi_id</code> command, or else your newly plugged in device won't be recognised.</p> <p>You then will need to find out what device file your new device was allocated by the kernel. This is routinely done by using the command <code>dmesg</code> after you plugged in the new device. Typically, you will see lines similar to these:</p> <pre><code>    usb 1-5: new high speed USB device using ehci_hcd and address 25\n    usb 1-5: configuration #1 chosen from 1 choice\n    scsi7 : SCSI emulation for USB Mass Storage devices\n    usb-storage: device found at 25\n    usb-storage: waiting for device to settle before scanning\n      Vendor: USB       Model: Flash Disk        Rev: 8.07\n      Type:   Direct-Access                      ANSI SCSI revision: 04\n    SCSI device sdc: 7886848 512-byte hdwr sectors (4038 MB)\n</code></pre> <p>As you see, we plugged in a 4Gb Flash Disk that was assigned the device name 'sdc'. This device is now available as <code>/sys/block/sdc</code> in the <code>/sys</code> pseudo-filesystem, and also as a devicefile <code>/dev/sdc</code>.</p> <p>To determine the device WWID, use the <code>scsi_id</code> command:</p> <pre><code>    # scsi_id -g -u -s /block/sdc\n    3200049454505080f\n</code></pre> <p>As you see, we used the <code>-g</code> forcibly. The <code>-s</code> option specifies that you want to use the device name relative to the root of the <code>sysfs</code> filesystem (<code>/sys</code>). Newer versions of scsi_id (e.g. those in RHEL6) do not allow use of <code>sysfs</code> names anymore, so should use the device name then:</p> <pre><code>    /sbin/scsi_id -g -u -d /dev/sdc\n    3200049454505080f\n</code></pre> <p>The long string of characters in the output is the WWID. The WWID does not change when you add a new device to your system. Acquire the WWID for each device in order to create rules for the devices. To create new device rules, edit the <code>20-names.rules</code> file in the <code>/etc/udev/rules.d</code> directory. The device naming rules follow this format:</p> <pre><code>    KERNEL=\"sd&lt;?&gt;\",  BUS=\"scsi\",  PROGRAM=\"&lt;scsi_id -options..&gt;\", RESULT=\"&lt;WWID&gt;\", NAME=\"&lt;devicename&gt;\"\n</code></pre> <p>So, when you plug in a new device the kernel will signal <code>udev</code> it found a new SCSCI device. the PROGRAM will be executed and the RESULT should match. If so, the NAME will be used for the device file.</p> <p>An example would be:</p> <pre><code>    KERNEL=\"sd*\",  BUS=\"scsi\",  PROGRAM=\"/sbin/scsi_id -g -u -d /dev/$parent\", RESULT=\"3200049454505080f\", NAME=\"bookone\"\n</code></pre> <p>Or on RHEL6 systems:</p> <pre><code>    KERNEL=\"sd*\",  BUS=\"scsi\",  PROGRAM=\"/sbin/scsi_id -g -u -s /block/$parent\", RESULT=\"3200049454505080f\", NAME=\"bookone\"\n</code></pre> <p>When the kernel allocates a new device which name matches the KERNEL pattern, the PROGRAM is executed and when the RESULT is found the NAME is created. Note the <code>-g</code> option that we have included so we can actually see the device, though it is not whitelisted.</p> <p>The <code>udevd</code> daemon is typically started by the execution of a local startup script, normally done by the <code>init</code> process and initiated by a line in the <code>/etc/inittab</code> file. On older systems you would ensure that this line was in <code>/etc/rc.local</code>:</p> <pre><code>    /sbin/start_udev\n</code></pre> <p>On some systems, e.g. RHEL6 the line should be in <code>/etc/rc.sysinit</code>.</p>"},{"location":"lpic2.204.2/#implementing-device-name-persistence-with-multipath","title":"Implementing device name persistence with multipath","text":"<p>You can implement device name persistence by using the <code>multipath</code> drivers and software. Of course, normally you would only use this if you have more than one path to your device. But you can actually define a <code>multipath</code> with only has one active path, and it will work just like any other disk. Just define an alias and the name will be persistent across boots.</p> <p>The <code>multipath</code> software consists of a daemon, that guards the paths to the various devices. It executes the external command <code>multipath</code> on failure. The <code>multipath</code> command in turn will signal the daemon after it has reconfigured paths.</p> <p>To implement LUN persistence in a multipath environment, you can define an alias name for the <code>multipath</code> device. Edit the device aliases in the configuration file of the <code>multipath</code> daemon, <code>/etc/multipath.conf</code>:</p> <pre><code>    multipaths {\n        multipath  {  \n            wwid       3600a0b80001327510000015427b625e\n            alias      backupdisk\n        }\n    }\n</code></pre> <p>This defines a device that has a persistent device file <code>/dev/mpath/backupdisk</code>. That will grant access to the device - whatever its name - that has WWID 600a0b80001327510000015427b625e. The alias names are persistent across reboots.</p>"},{"location":"lpic2.204.2/#physical-installation","title":"Physical installation","text":"<p>To install a new disk in your system, you will need to physically install the hard drive and configure it in your computer's BIOS. Linux will detect the new drive automatically in most cases. You could type <code>dmesg | more</code> to find out the name and device file of the drive. As an example: the second IDE drive in your system will be named <code>/dev/hdb</code>. We will assume that the new drive is <code>/dev/hdb</code>.</p> <p>On older kernels IDE devicenames match the pattern <code>/dev/hd[a-d]</code>, where a is used for the primary master IDE device, b is the primary slave, c the secondary master and d is the secondary slave IDE device. For PATA/SATA drives the Linux SCSI driver is used as the PATA/SATA architecture is similar to that of SCSCI. Newer devices hence have device files that match the pattern <code>/dev/sd*</code>.</p> <p>After installation of your disk and it being recognised by the kernel you can choose to (re)partition your new disk. As <code>root</code> in a shell type:</p> <pre><code>    fdisk /dev/hdb\n</code></pre> <p>This will take you to a prompt</p> <pre><code>    Command (m for help):\n</code></pre> <p>At the prompt, type <code>p</code> to display the existing partitions. If you have partitions that you need to delete, type <code>d</code>, then at the prompt, type the number of the partition that you wish to delete. Next, type <code>n</code> to create the new partition. Type <code>1</code> (assuming that this will be the first partition on the new drive), and hit <code>enter</code>. Then you will be prompted for the cylinder that you want to start with on the drive. Next, you will be asked for the ending cylinder for the partition. Repeat these steps until all partitions are created.</p> <p>To put a clean filesystem on the first partition of your newly partitioned drive, type:</p> <pre><code>    mkfs /dev/hdb1\n</code></pre> <p>Repeat this step for all partitions. You can use the <code>-t</code> parameter to define the filesystem type to build, e.g. <code>ext2</code>, <code>ext3</code>, <code>xfs</code>, <code>minix</code> etc. (???).</p> <p>You will now need to decide the mount point for each new partition on your drive. We will assume <code>/new</code>. Type:</p> <pre><code>    mkdir /new\n</code></pre> <p>to create the mount point for your drive. Now you will need to edit <code>/etc/fstab</code>. You will want to make an entry at the end of the file similar to this:</p> <pre><code>    /dev/hdb1       /new     ext2          defaults       1   1\n</code></pre> <p>Modern SSDs (Solid State Disks) might profit from some optimisation. SSDs are very fast compared to standard harddisks with platters but they have a bigger chance of suffering from bad blocks after many rewrites to blocks. An SSD can use TRIM to discard those blocks efficiently. <code>noatime</code> or <code>relatime</code> can also be used to reduce the amount of writes to disk. This will tell the filesystem not to keep track of last accessed times, but only last modified times. In <code>/etc/fstab</code> it would look like:</p> <pre><code>    /dev/hdb1        /new     ext4    discard,noatime       1      1\n</code></pre> <p>NVM Express (NVMe) is a specification for accessing SSDs attached through the PCI Express bus. The Linux NVMe driver is included in kernel version 3.3 and higher. NVMe devices can be found under <code>/dev/nvme*</code>. NVMe devices are a family of SSD's thatshould not be issued discards. Discards are usualy disabled on setups that use ext4 and LVM, but other filesystems might need discards to be disabled explicitly.</p> <pre><code>     /dev/nvme0n1p1  /new     ext4 defaults 0 0\n</code></pre> <p>Moving your <code>/tmp</code> partition to memory (tmpfs) is another way to reduce disk writes. This is advisable if your system has enough memory. Add the following entry to <code>/etc/fstab</code>:</p> <pre><code>    none             /tmp/                   tmpfs   size=10%                 0       0\n</code></pre> <p>After you have created a similar entry for each partition, write the file.</p> <pre><code>    mount -a\n</code></pre> <p>will mount the partitions in the directory that you specified in <code>/etc/fstab</code>.</p>"},{"location":"lpic2.204.2/#using-tune2fs","title":"Using <code>tune2fs</code>","text":"<p>When a kernel interacts with ext2 or ext3 filesystems the <code>tune2fs</code> command can be used to configure the interaction. Noteworthy options of this command are:</p> <p>-e error_behaviour</p> <ul> <li> <p>This option defines how the kernel should react in case of errors on     the filesystem to which this command is applied. Possible behaviours     are:</p> <p>continue</p> <p>:   Ignore the error on the filesystem. Report the read or write     error to the application that tries to access that part of the     filesystem.</p> <p>remount-ro</p> <p>:   Remount the filesystem as read-only. This secures data that is     already on disc. Applications that try to write to this     filesystem will result in error.</p> <p>panic</p> <p>:   This causes a kernel panic and the system will halt.</p> </li> </ul> <p>-m reserved_block_percentage</p> <ul> <li> <p>Full filesystems have very bad performance due to fragmentation. To     prevent regular users from filling up the whole filesystem a     percentage of the blocks will be reserved. This reserved part cannot     be used by regular users. Only the root user can make use this part     of the filesystem.</p> <p>The default percentage of the reserved blocks is 5%. With disks becoming ever larger, setting aside 5% would result in a large number of reserved blocks. For large disks 1% reserved blocks should be sufficient for most filesystems.</p> </li> </ul> <p>-O [^]mount_option</p> <ul> <li> <p>This sets the mount options of the filesystem. Command line options     or options in <code>/etc/fstab</code> take precedence. The ^-sign clears the     specified option.</p> <p>This option is supported by kernel 2.4.20 and above.</p> </li> </ul> <p>-s [0|1]</p> <ul> <li> <p>Enable or disable the sparse superblock feature. Enabling this     feature on large filesystems saves space, because less superblocks     are used.</p> <p>After enabling or disabling this feature the filesystem must be made valid again by running the <code>e2fsck</code> command.</p> </li> </ul>"},{"location":"lpic2.204.2/#using-hdparm","title":"Using <code>hdparm</code>","text":"<p>The <code>hdparm</code> command is used to set/get SATA/IDE device parameters. It provides a command line interface to various kernel interfaces supported by the Linux SATA/PATA/SAS \"libata\" subsystem and the older IDE driver subsystem. Newer (from 2008) USB disk enclosures now support \"SAT\" (SCSI-ATA Command Translation) so they might also work with <code>hdparm</code>.</p> <p>The syntax for this command is:</p> <pre><code>    hdparm [options] [device]\n</code></pre> <p>Frequently used options are:</p> <p>-a</p> <ul> <li>Get or set the sector count for filesystem read-ahead.</li> </ul> <p>-d [0|1]</p> <ul> <li>Get or set the <code>using_dma</code> flag.</li> </ul> <p>-g</p> <ul> <li>Display drive geometry.</li> </ul> <p>-i</p> <ul> <li>Display identification information.</li> </ul> <p>-r [0|1]</p> <ul> <li>Get (1) or set (0) the read-only flag.</li> </ul> <p>-t</p> <ul> <li>Perform device read for benchmarking.</li> </ul> <p>-T</p> <ul> <li>Perform device cache read for benchmarking.</li> </ul> <p>-v</p> <ul> <li>Display all settings, except -i.</li> </ul> <p>See also <code>man hdparm</code> for more information.</p>"},{"location":"lpic2.204.2/#using-sdparm","title":"Using <code>sdparm</code>","text":"<p>The <code>sdparm</code> command is used to access SCSI mode pages, read VPD (Vital Product Data) pages and send simple SCSI commands.</p> <p>The utility fetches and can change SCSI device mode pages. Inquiry data including Vital Product Data pages can also be displayed. Commands associated with starting and stopping the medium; loading and unloading the medium; and other housekeeping functionality may also be issued by this utility.</p>"},{"location":"lpic2.204.2/#configuring-kernel-options","title":"Configuring kernel options","text":"<p>In ??? and on, the process to configure and debug Configuring Linux kernel options kernels is described. Additional kernel options may be configured by patching the kernel source code. Normally the kernel's tunable parameters are listed in the various header files in the source code tree. There is no golden rule to apply here - you need to read the kernel documentation or may even need to crawl through the kernel-code to find the information you need. Additionally, a running kernel can be configured by either using the <code>/proc</code> filesystem or by using the <code>sysctl</code> command.</p>"},{"location":"lpic2.204.2/#using-the-proc-filesystem","title":"Using the <code>/proc</code> filesystem","text":"<p>Current kernels also support dynamic setting of kernel parameters. The /proc easiest method to set kernel parameters is by modifying the <code>/proc</code> filesystem. You can use the <code>echo</code> command to set parameters, in the format:</p> <pre><code>    # echo value &gt; /proc/kernel/parameter\n</code></pre> <p>e.g. to activate IP-forwarding:</p> <pre><code>    # echo 1 &gt;/proc/sys/net/ipv4/ip_forward\n</code></pre> <p>The changes take effect immediately but are lost during reboot. /proc/sys/net/ipv4/ip_forward</p> <p>The <code>/proc/</code> filesystem can also be queried. To see which interrupts a system uses, for example you could issue /proc/interrupts</p> <pre><code>    # cat /proc/interrupts\n</code></pre> <p>which generates output that may look like this:</p> <pre><code>               CPU0       \n      0:   16313284          XT-PIC  timer\n      1:     334558          XT-PIC  keyboard\n      2:          0          XT-PIC  cascade\n      7:      26565          XT-PIC  3c589_cs\n      8:          2          XT-PIC  rtc\n      9:          0          XT-PIC  OPL3-SA (MPU401)\n     10:          4          XT-PIC  MSS audio codec\n     11:          0          XT-PIC  usb-uhci\n     12:     714357          XT-PIC  PS/2 Mouse\n     13:          1          XT-PIC  fpu\n     14:     123824          XT-PIC  ide0\n     15:          7          XT-PIC  ide1\n    NMI:          0\n</code></pre> <p>On multicore systems you will see multiple CPU-columns, e.g. CPU0..CPU3 for a four core system. The interrupts are delivered to core 0 by default. This can create a performance bottleneck, especially on networked storage systems. As CPU0 gets swamped by IRQ's the system feels sluggish, even when the other cores have almost nothing to do. Newer kernels try to load balance the interrupts. But you can override the defaults and choose which core will handle which interrupt. The procedure is listed in the next paragraph.</p> <p>Each interrupt listed in the <code>/proc/interrupts</code> file has a subdirectory in the <code>/proc/irq/</code> tree. So, interrupt 12 corresponds to the directory <code>/proc/irq/12</code>. In that directory the file <code>smp_affinity</code> contains data that describes what core handles the interrupt. The file contains a bitmask that has one bit per core. By setting the proper bit the APIC chip will deliver the interrupt to the corresponding core, e.g. 2 selects CPU1, 4 selects CPU2, 8-3, 16-4.. etc. To set for example CPU5 to receive all interrupts #13, do:</p> <pre><code>    # echo 32 &gt;/proc/irq/13/smp_affinity\n</code></pre> <p>By carefully selecting which interrupts go to which processor you can dramatically influence the performance of a busy system.</p>"},{"location":"lpic2.204.2/#using-sysctl","title":"Using <code>sysctl</code>","text":"<p>Kernel tuning can be automated by putting the <code>sysctl</code> commands in the startup scripts (e.g. <code>/etc/sysctl.d/99-sysctl.conf</code>. The <code>sysctl</code> command is used to modify kernel parameters at runtime. The parameters that can be modified by this command are listed in the <code>/proc/sys</code> directory tree. Procfs is required for <code>sysctl</code> support under Linux. <code>sysctl</code> can be used to read as well as write kernel parameters.</p> <p>Frequently used options of the <code>sysctl</code> command are:</p> <p><code>-a</code>; <code>-A</code></p> <ul> <li>Display all values currently available.</li> </ul> <p><code>-e</code></p> <ul> <li>Use this option to ignore errors about unknown keys.</li> </ul> <p><code>-n</code></p> <ul> <li>Use this option to disable printing of the key name when printing     values.</li> </ul> <p><code>-p</code></p> <ul> <li>Load sysctl settings from the file specified, or /etc/sysctl.conf if     none given. Specifying <code>-</code> as filename means reading data from     standard input.</li> </ul> <p><code>-w</code></p> <ul> <li>Use this option to change a sysctl setting.</li> </ul>"},{"location":"lpic2.204.3/","title":"Logical Volume Manager (204.3)","text":""},{"location":"lpic2.204.3/#logical-volume-manager-2043","title":"Logical Volume Manager (204.3)","text":"<p>Candidates should be able to create and remove logical volumes, volume groups, and physical volumes. This objective includes snapshots and resizing logical volumes.</p>"},{"location":"lpic2.204.3/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Tools in the LVM suite</p> </li> <li> <p>Resizing, renaming, creating, and removing logical volumes, volume     groups, and physical volumes</p> </li> <li> <p>Creating and maintaining snapshots</p> </li> <li> <p>Activating volume groups</p> </li> </ul>"},{"location":"lpic2.204.3/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/sbin/pv*</code></p> </li> <li> <p><code>/sbin/vg*</code></p> </li> <li> <p><code>/sbin/lv*</code></p> </li> <li> <p><code>mount</code></p> </li> <li> <p><code>/dev/mapper</code></p> </li> <li> <p><code>lvm.conf</code></p> </li> </ul>"},{"location":"lpic2.204.3/#configuring-logical-volume-management","title":"Configuring Logical Volume Management","text":"<p><code>lvm</code> is a logical volume manager for Linux. It enables you to concatenate several physical volumes (hard disks etc.) to so-called volume groups, forming a storage pool, much like a virtual disk. IDE and SCSI disks, as well as multiple devices (MD) are supported.</p> <p>In the figure below, the concepts and terminology used by <code>lvm</code> are sketched. On the right side the names of the commands are shown that can be used to create and/or manipulate the layer sketched on the left.</p> <p></p>"},{"location":"lpic2.204.3/#the-physical-media-partitions","title":"The physical media / partitions","text":"<ul> <li>fdisk a hard disk, or a partition, e.g. <code>/dev/hda</code>, <code>/dev/hda6</code> or     <code>/dev/sda</code>. You should set the partition types of the disk or     partition to <code>0x8e</code>, which is \"Linux LVM\". Partitioning is done     using <code>fdisk</code>. Please note that your version of <code>fdisk</code> may not yet     know this type, so it will be listed as \"Unknown\". You can turn any     consecutive number of blocks on a block device into a Physical     Volume:</li> </ul> <p>Physical Volume (PV)</p> <ul> <li>Physical Volume a physical medium with some administrative data     added to it. The command <code>pvcreate</code> can be used to add the     administration onto the physical medium. The command <code>vgcreate</code> is     used to create a volume group, which consists of one or more PV's.     A PV that has been grouped in a volume group contains Physical     Extents:</li> </ul> <p>Physical Extents (PE)</p> <ul> <li>Physical Extents Physical Extents are blocks of diskspace, often     several megabytes in size. Using the command <code>lvcreate</code> you can     assign PEs to a Logical Volume:</li> </ul> <p>Logical Volume (LV)</p> <ul> <li>Logical Volume A Logical Volume. On a logical volume we can use the     command <code>mkfs</code> to get a Filesystem:</li> </ul> <p>Filesystem</p> <ul> <li><code>ext2</code>, <code>ReiserFS</code>, <code>NWFS</code>, <code>XFS</code>, <code>JFX</code>, <code>NTFS</code> etc. mount To the     linux kernel, there is no difference between a regular partition and     a Logical Volume. A simple <code>mount</code> suffices to be able to use your     logical volume.</li> </ul> <p>lvcreate lvol Some examples of typical usage of the LVM commandset follow. Initially, you need to set the partition type for the partitions to use to create logical volumes to <code>0x8e</code>. Let's assume we have partitions <code>/dev/hda4</code> and <code>/dev/hda5</code>, and they are set to the correct partitioning type. To create a physical volume on both partitions (i.e. to set up the volume group descriptor) you type (being the superuser): pvcreate</p> <pre><code>    # pvcreate /dev/hda4 /dev/hda5\n</code></pre> <p>Now we have created two physical volumes. Next, we will create a volume group. A volume group needs to have a name (we choose <code>volume01</code>). To create our volume group, using our previously defined physical volumes, type: vgcreate</p> <pre><code>    # vgcreate volume01 /dev/hda5 /dev/hda4\n</code></pre> <p>The previous command line is the most basic form (refer to the manual pages for a list of configurable parameters). This will create an array of physical extents, by default they are 4 Mb in size. Using these extents we can create one or more logical volumes, e.g:</p> <pre><code>    # lvcreate -L 100M volume01\n</code></pre> <p>This creates a logical volume with a default name choosen by <code>lvcreate</code> and starts with the string <code>lvol</code> followed by a digit NDASH let's assume <code>lvol0</code>. The logical volume will be created using the volumegroup <code>volume01</code>. The name of the devicefile for this volume will be <code>/dev/volume01/lvol0</code>. Next, we can make a filesystem on the volumegroup, as usual, using <code>mkfs</code>, e.g. an <code>xfs</code> filesystem: mkfs mount</p> <pre><code>    # mkfs -t xfs /dev/volume01/lvol0\n</code></pre> <p>The resulting filesystem can be mounted as usual:</p> <pre><code>    # mount /dev/volume01/lvol0 /mnt\n</code></pre>"},{"location":"lpic2.204.3/#modifying-logical-volumes-volume-groups-and-physical-volumes","title":"Modifying logical volumes, volume groups and physical volumes","text":"<p>A logical volume can be modified in order to create more space for the filesystem that is on top of this logical volume. Assuming that there is enough space in the volume group a logical volume can be increased in size with the command: lvextend</p> <pre><code>    # lvextend -L +50M /dev/volume01/lvol0\n</code></pre> <p>After the logical volume has been increased the filesystem on top of the logical volume still has the same size. To use the extra space of the logical volume the filesystem needs to be resized. This can be done by the command: xfs_grow</p> <pre><code>    # xfs_growfs /dev/volume01/lvol0\n</code></pre> <p>For an ext2/ext3/ext4 file system use the command <code>resize2fs</code>. Note that for resizing the filesystem it must not be mounted.</p> <p>In the previous example it was assumed that there was enough free space in the volume group. If this is not the case, extra disk space can be added to the volume group in a similar way. To do so use the command: vgextend</p> <pre><code>    # vgextend volume01 /dev/hda6\n</code></pre> <p>First device hda6 has to be converted into a physical volume with the command: pvcreate</p> <pre><code>    # pvcreate /dev/hda6\n</code></pre>"},{"location":"lpic2.204.3/#lvm-snapshots","title":"LVM Snapshots","text":"<p>snapshots One of the nicest features of LVM is the possibility of taking snapshots of volumes. A snapshot is a virtual copy of the volume to enable easy backups. LVM snapshots use a strategy called \"copy on write\". This means that the snapshot logical volume only saves data blocks from the original logical volume that are changed in the original logical volume. To do so the logical volume manager first reads the (unchanged) data block on the original and than writes the data block to the snapshot. On filesystems with many changes (e.g. databases) this can lead to performance issues.</p> <p>The <code>-s</code> option in the <code>lvcreate</code> command specifies that the newly created logical volume is a snapshot. lvcreate</p> <pre><code>    # lvcreate -L 50M -s -n snapshot0 /dev/volume01/lvol0\n</code></pre> <p>This will create a logical volume <code>/dev/volume01/snapshot0</code>, which then can be used, among others, for backup purposes. The advantage of the snapshot is that the data is consistent, i.e. the data doesn't change during backup.</p> <p>After the backup is finished, the snapshot has to be removed otherwise the performance issues mentioned earlier will start to come into play. To remove the snapshot use: lvremove</p> <pre><code>    # lvremove /dev/volume01/snapshot0\n</code></pre>"},{"location":"lpic2.204.3/#lvm-commands","title":"LVM commands","text":"<p>This section gives an overview of most lvm related commands. The manual pages describe the commands more in detail.</p> <p><code>pvchange</code> -   pvchange     Change attributes of a physical volume</p> <p><code>pvck</code> -   pvck     Check physical volume metadata</p> <p><code>pvcreate</code> -   pvcreate     Initialize a disk or partition for use by LVM</p> <p><code>pvdisplay</code> -   pvdisplay     Display attributes of a physical volume</p> <p><code>pvmove</code> -   pvmove     Move physical extents</p> <p><code>pvremove</code> -   pvremove     Remove a physical volume</p> <p><code>pvs</code> -   pvs     Report information about physical volumes</p> <p><code>pvscan</code> -   pvscan     Scan all disk for physical volumes</p> <p><code>lvchange</code> -   lvchange     Change attributes for a logical volume</p> <p><code>lvcreate</code> -   lvcreate     Create a logical volume in an existing volume group</p> <p><code>lvdisplay</code> -   lvdisplay     Display attributes of a logical volumes</p> <p><code>lvextend</code> -   lvextend     Extend the size of a logical volume</p> <p><code>lvmdiskscan</code> -   lvmdiskscan     Scan for all devices visible to LVM2</p> <p><code>lvreduce</code> -   lvmreduce     Reduce the size of a logical volume</p> <p><code>lvremove</code> -   lvmremove     Remove a logical volume</p> <p><code>lvrename</code> -   lvmrename     Rename a logical volume</p> <p><code>lvresize</code> -   lvmresize     Resize a logical volume</p> <p><code>lvs</code> -   lvs     Report information about logical volumes</p> <p><code>lvscan</code> -   lvscan     Scan (all) disks for logical volumes</p> <p><code>vgcfgbackup</code> -   vgcfgbackup     Backup volume group descriptor area</p> <p><code>vgchange</code> -   vgchange     Change attributes of a volume group</p> <p><code>vgck</code> -   vgck     Check volume group metadata</p> <p><code>vgconvert</code> -   vgconvert     Convert volume group metadata</p> <p><code>vgcreate</code> -   vgcreate     Create a volume group</p> <p><code>vgdisplay</code> -   vgdisplay     Display attributes of volume groups</p> <p><code>vgextend</code> -   vgextend     Add physical volumes to a volume group</p> <p><code>vgexport</code> -   vgexport     Make volume groups unknown to the system</p> <p><code>vgimport</code> -   vgimport     Make exported volume groups known to the system</p> <p><code>vgmerge</code> -   vgmerge     Merge two volume groups</p> <p><code>vgmknodes</code> -   vgmknodes     Recreate volume group directory and logical volume special files</p> <p><code>vgreduce</code> -   vgreduce     Reduce a volume group</p> <p><code>vgremove</code> -   vgremove     Remove a volume group</p> <p><code>vgrename</code> -   vgrename     Rename a volume group</p> <p><code>vgs</code> -   vgs     Report information about volume groups</p> <p><code>vgscan</code> -   vgscan     Scan all disk for volume groups and rebuild caches</p> <p><code>vgsplit</code> -   vgsplit     Split a volume group into two</p>"},{"location":"lpic2.204.3/#device-mapper","title":"Device mapper","text":"<p>The device mapper is a kernel driver that provides a framework for volume management. It provides a generic way of creating mapped devices, which may be used as logical volumes. It does not specifically know about volume groups or metadata formats.</p> <p>LVM logical volumes are activated using the device mapper. Each logical volume is translated into a mapped device. Each segment translates into a line in the mapping table that describes the device. The device mapper supports a variety of mapping targets, including linear mapping, striped mapping, and error mapping.</p>"},{"location":"lpic2.204.3/#lvmconf","title":"lvm.conf","text":"<p>At system startup <code>lvm.conf</code> configuration is loaded. The default directory is <code>/etc/lvm</code>. But it can be set with the environment variable LVM_SYSTEM_DIR. In the <code>lvm.conf</code> file you can specify additional configuration to load. To display the current settings, you can execute the lvm dumpconfig command.</p> <p>vgscan pvs The <code>vgscan</code> command scans for block devices with lvm metadata on it. These physical volumes are stored in the lvm cache. This command uses the <code>lvm.conf</code> file to determine that. When for instance you use multipath devices, the metadata is the same on all the disks, on the different paths. Which will cause a lot of duplicates when you run <code>pvs</code>. Also when you want to boot of a multipath device, it can boot of a single path. You can use the filter option in the devices section for this in the <code>lvm.conf</code>, to skip the other devices and only look for multipath devices. The filter option uses regular expression to accept or reject block devices, like in below examples. Add all discovered devices:</p> <pre><code>            filter = [ \"a/.*/\" ]\n</code></pre> <p>Filter to remove cdrom devices:</p> <pre><code>            filter = [ \"r|/dev/cdrom|\" ]\n</code></pre> <p>Filter only device mapper names on a multipath device:</p> <pre><code>            filter = [ \"a|/dev/disk/by-id/dm-uuid-.*-mpath-.*|\", \"r|.*|\" ]\n</code></pre> <p>This filter just adds partition 8 on the first IDE Harddrive and removes all other block devices.</p> <pre><code>            filter = [ \"a|^/dev/hda8$|\", \"r/.*/\" ]\n</code></pre> <p>Other usefull and commonly used option in the devices sections in the <code>lvm.conf</code> are: preferred_names The earliest pattern is used in any output like <code>pvs</code>. So in our example of multipath devices we want.</p> <pre><code>            preferred_names = [ \"^/dev/mpath/\", \"^/dev/mapper/mpath\", \"^/dev/[hs]d\" ]\n</code></pre> <p>types If you boot from a local device and the rest are multipath devices, you need to change the types option, next to the filter option with this example. I tells LVM the acceptable block devices (device-mapper) and the allowed partitions (253)</p> <pre><code>            types = [ \"device-mapper\", 253 ]\n</code></pre> <p>For other sections with options check: <code>man lvm.conf</code></p>"},{"location":"lpic2.204.4/","title":"Configuring PCMCIA Devices (204.4)","text":""},{"location":"lpic2.204.4/#configuring-pcmcia-devices-2044","title":"Configuring PCMCIA Devices (204.4)","text":"<p>Candidates should be able to configure a Linux installation to include PCMCIA support. This objective includes configuring PCMCIA devices, such as ethernet adapters, to be auto detected when inserted.</p>"},{"location":"lpic2.204.4/#key-files-terms-and-utilities-include","title":"Key files, terms and utilities include:","text":"<p>/etc/pcmcia/</p> <p>*.opts</p> <p>cardctl</p> <p>cardmgr</p>"},{"location":"lpic2.204.4/#overview-of-pcmcia","title":"Overview of PCMCIA","text":"<p>Nowadays, PCMCIA slots are quite a rarity. Only found on specialized and legacy devices.  but at the turn of the century almost all laptops, and even a number of desktops, contain PCMCIA slots. PCMCIA is an PCMCIA abbreviation for Personal Computer Memory Card International Association, a commission that defines standards for expansion cards. The PCMCIA itself was founded in 1990. It initially developed a set of standards by which memory could be added to portable systems. The PCMCIA specification 2.0 release in 1991 added protocols for I/O devices and hard disks. The 2.1 release in 1993 refined these specifications, and is the standard around which PCMCIA cards are built today. PCMCIA cards are credit card size adapters which fit into PCMCIA slots. There are three types of PCMCIA cards, Type I generally used for memory cards such as FLASH and STATIC RAM; Type II used for I/O peripherals Type II Type I Type III such as serial adapters and fax-modems and Type III which are used for rotating media such as hard disks. The only difference in the physical specification for these cards is thickness: type I is the thinnest, type III the thickest.</p> <p>PCMCIA cards are \"hot pluggable\" e.g. you can remove your network card without hot pluggable damaging your system (your network will not work of course) and plug it back in which will automatically start up your card and configure the card for your system. Linux supports PCMCIA standards. It features a daemon which monitors PCMCIA sockets to see if cards are removed or inserted (<code>cardmgr</code>), and runs scripts to configure the network into your system. Linux also features drivers for the various PCMCIA cards. These drivers are either part of the kernel distribution or are supplied via an additional package (Card Services for Linux). Card Services</p>"},{"location":"lpic2.204.4/#cardmgr","title":"cardmgr","text":"<p>The <code>cardmgr</code> daemon is responsible for monitoring PCMCIA cardmgr sockets, loading client drivers when needed and running user-level scripts in response to card insertions and removals. It records its actions in the system log, but also uses beeps to signal card status changes. The tones of the beeps indicate success or failure of particular configuration steps. Two high beeps indicate that a card was identified and configured successfully. A high beep followed by a low beep indicates that a card was identified, but could not be configured for some reason. One low beep indicates that a card could not be identified. The <code>cardmgr</code> daemon configures cards based on a database of known card types kept in <code>/etc/pcmcia/config</code>. This file describes the various client /etc/pcmcia/config drivers, then describes how to identify various cards and which driver(s) belong with which cards. The format of this file is described in the <code>pcmcia(5)</code> man page.</p>"},{"location":"lpic2.204.4/#the-stab-file","title":"The <code>stab</code> file","text":"<p>The <code>cardmgr</code> daemon records device information for each socket in the file <code>/var/lib/pcmcia/stab</code>. For the lines /var/lib/pcmcia/stab describing devices, the first field is the socket, the second is the device class, the third is the driver name, the fourth is used to number multiple devices associated with the same driver, the fifth is the device name, and the final two fields are the major and minor device numbers for this device (if applicable).</p>"},{"location":"lpic2.204.4/#the-etcpcmcia-directory","title":"The <code>/etc/pcmcia</code> directory","text":"<p>The <code>/etc/pcmcia</code> directory contains various configuration files for PCMCIA devices. Also, it contains scripts that start or stop PCMCIA PCMCIA/etc/pcmcia devices. For example the configuration file <code>config.opts</code> contains the local resource settings for PCMCIA devices, such as which ports to use, memory ranges to use and ports and irq's to exclude. Additionally, extra options for the modules can be specified here.</p>"},{"location":"lpic2.204.4/#card-services-for-linux","title":"Card Services for Linux","text":"<p>\"Card Services for Linux\" is a complete PCMCIA or \"PC Card\" support package. It includes a set of loadable kernel modules that implement a version of the Card Services applications-programming interface, a set of client drivers for specific cards and a card manager daemon that can respond to card LinuxCard Services insertion and removal events, loading and unloading drivers on demand. It supports \"hot swapping\" of most card types, so cards can be safely inserted and ejected at any time. The release includes drivers for a variety of ethernet cards, a driver for modem and serial port cards, several SCSI adapter drivers, a driver for ATA/IDE drive cards and memory-card drivers that should support most SRAM cards and some flash cards.</p> <p>You'll need the kernel source to install <code>pcmcia-cs</code>, since pcmcia-cs the driver modules contain references to the kernel source files. Installing the <code>pcmcia-cs</code> package results in a number of modules in the <code>/lib/modules/&lt;your-kernel-version&gt;</code> directory.</p> <p>The PCMCIA startup script recognizes several groups of startup options which are set via environment variables. Multiple options should be separated by spaces and enclosed in quotes. Placement of startup options depends on the Linux distribution used. They may be placed directly in the startup script or they may be kept in a separate option file. These are specific for various Linux distributions.</p> <p>Card Services should automatically avoid allocating IO ports and interrupts already in use by other standard devices. It will also attempt to detect conflicts with unknown devices, but this is not completely reliable. In PCMCIA/etc/pcmcia/config.opts some cases, you may need to explicitly exclude resources for a device in <code>/etc/pcmcia/config.opts</code>.</p>"},{"location":"lpic2.204.4/#newer-kernels-and-pcmcia","title":"Newer kernels and PCMCIA","text":"<p>As of kernel 2.4 PCMCIA support is integrated into the kernel - that is: the modules (drivers) are part of the kernel code distribution. You may want to try that first. However, in some situations the integrated support does not work. In many cases, you will still want to download and install \"Card Services for Linux\" (<code>pcmcia-cs</code>).</p> <p>The <code>cardctl</code> and <code>cardinfo</code> commands</p> <p>The <code>cardctl</code> command can be used to check the status of a socket or to see how it is configured. It can also be used to alter the cardctl cardinfo configuration status of a card.</p> <p>statusPCMCIAstatus   Display the current socket status flags.</p> <p>config               Display the socket configuration, including power                        PCMCIAconfig settings, interrupt and I/O window settings                        and configuration registers.</p> <p>ident                Display card identification information, including                        PCMCIAident product identification strings, manufacturer                        ID codes and function ID codes.</p> <p>suspend              Shut down and then disable power for a socket.                        PCMCIAsuspend</p> <p>resume               Restore power to a socket and re-configure for use.                        PCMCIAresume</p> <p>reset                Send a reset signal to a socket, subject to approval                        PCMCIAreset by any drivers already bound to the socket.</p> <p>eject                Notify all client drivers that this card will be                        PCMCIAeject ejected, then cut power to the socket.</p> <p>insert               Notify all client drivers that this card has                        PCMCIAinsert just been inserted.</p> <p>scheme               If no scheme name is given, cardctl will display the                        PCMCIAscheme current PCMCIA configuration scheme. If a                        scheme name is given, cardctl will de-configure all                        PCMCIA devices, and reconfigure for the new scheme.</p> <p>: <code>cardctl</code> commands</p> <p>If you are running X, the <code>cardinfo</code> utility produces a graphical interface to most <code>cardctl</code> functions.</p>"},{"location":"lpic2.205.0/","title":"Networking Configuration (205)","text":"<p>This topic has a weight of 11 points and contains the following objectives:</p>"},{"location":"lpic2.205.0/#objective-2051-basic-networking-configuration-3-points","title":"Objective 205.1; Basic Networking Configuration (3 points)","text":"<ul> <li>Candidates should be able to configure a network device to be able     to connect to a local, wired or wireless, and a wide-area network.     This objective includes being able to communicate between various     subnets within a single network.</li> </ul>"},{"location":"lpic2.205.0/#objective-2052-advanced-network-configuration-and-troubleshooting-4-points","title":"Objective 205.2; Advanced Network Configuration and Troubleshooting (4 points)","text":"<ul> <li>The candidate should be able to configure a network device to     implement various network-authentication schemes. This objective     includes configuring a multi-homed network device, configuring a     virtual private network and resolving networking and communication     problems.</li> </ul>"},{"location":"lpic2.205.0/#objective-2053-troubleshooting-network-issues-4-points","title":"Objective 205.3; Troubleshooting Network Issues (4 points)","text":"<ul> <li>Candidates should be able to identify and correct common network     setup issues to include knowledge of locations for basic     configuration files and commands.</li> </ul>"},{"location":"lpic2.205.1/","title":"Basic Networking Configuration (205.1)","text":""},{"location":"lpic2.205.1/#basic-networking-configuration-2051","title":"Basic Networking Configuration (205.1)","text":"<p>Candidates should be able to configure a network device to be able to connect to a local, wired or wireless, and a wide-area network. This objective includes being able to communicate between various subnets within a single network.</p>"},{"location":"lpic2.205.1/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Utilities to configure and manipulate ethernet network interfaces</p> </li> <li> <p>Configuring wireless networks</p> </li> </ul>"},{"location":"lpic2.205.1/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/sbin/route</code></p> </li> <li> <p><code>/sbin/ifconfig</code></p> </li> <li> <p><code>/sbin/ip</code></p> </li> <li> <p><code>/usr/sbin/arp</code></p> </li> <li> <p><code>/sbin/iw</code></p> </li> <li> <p><code>/sbin/iwconfig</code></p> </li> <li> <p><code>/sbin/iwlist</code></p> </li> </ul>"},{"location":"lpic2.205.1/#configuring-the-network-interface","title":"Configuring the network interface","text":"<p>Most network devices are supported by modern kernels. But you will need to configure your devices to fit into your network. They will need an IP address (IPv4, IPv6 or both), possibly a number of gateways/routers has to be made known to allow access to other networks and the default route needs to be set. Configuring Network Interface These tasks are usually performed from the routing table network-initialization script each time you boot the system. The basic tools for this process are <code>ifconfig</code> (where \"if\" stands <code>ifconfig</code> for interface) and <code>route</code>. route</p> <p>The <code>ifconfig</code> command is still widely used. It configures an interface and makes it accessible to the kernel networking layer. An IP address, submask, broadcast address and various other parameters can be set. The tool can also be used to activate and de-activate the interface, also known as \"bringing up\" and \"bringing down\" the interface. An active interface will send and receive IP datagrams through the interface. The simplest way to IP invoke it is:</p> <pre><code>    # ifconfig interface ip-address\n</code></pre> <p>This command assigns <code>ip-address</code> to <code>interface</code> and activates it. All other parameters are set to default values. For instance, the default network mask is derived from the network class of the IP address, such as 255.255.0.0 for a class B address.</p> <p><code>route</code> allows you to add or remove routes from the kernel routing table. It can be invoked as:</p> <pre><code>    # route {add|del} [-net|-host] target [if]\n</code></pre> <p>The <code>add</code> and <code>del</code> arguments determine whether to add or delete the route to <code>target</code>. The <code>-net</code> and <code>-host</code> arguments tell the route command whether the target is a network or a host (a host is assumed if you don't specify). The <code>if</code> argument specifies the interface and is optional, and allows you to specify to which network interface the route should be directed -- the Linux kernel makes a sensible guess if you don't supply this information.</p>"},{"location":"lpic2.205.1/#the-loopback-interface","title":"The Loopback Interface","text":"<p>TCP/IP implementations include a virtual network interface that can be used to emulate network traffic between two processes on the same host. The loopback interface is not connected to any real network, it is implemented entirely within the operating system's networking software. Traffic sent to the loopback IP address (often the address 127.0.0.1 is used) is simply passed back up the network software stack as if it had been received from another device. The IPv6 address used is ::1, and commonly the name \"localhost\" is used as hostname. It is the first interface to be activated during boot: loopback interface</p> <pre><code>    # ifconfig lo 127.0.0.1\n</code></pre> <p>Occasionally, you will see the dummy hostname localhost being used instead of the IP address. This requires proper configuration of the <code>/etc/hosts</code> file: 127.0.0.1</p> <pre><code>    # Sample /etc/hosts entry for localhost\n    127.0.0.1 localhost\n</code></pre> <p>To view the configuration of an interface simply invoke <code>ifconfig</code> with the interface name as lo sole argument:</p> <pre><code>    $ ifconfig lo\n    lo        Link encap:Local Loopback inet addr:127.0.0.1\n    Mask:255.0.0.0 UP LOOPBACK RUNNING MTU:3924 Metric:1 RX packets:0\n    errors:0 dropped:0 overruns:0 frame:0 TX packets:0 errors:0 dropped:0\n    overruns:0 carrier:0 Collisions:0\n</code></pre> <p>This example shows that the loopback interface has been assigned a netmask of 255.0.0.0 by default. 127.0.0.1 is a class A address.</p> <p>These steps suffice to use networking applications on a stand-alone host. After adding these lines to your network initialization script and ensuring its execution at boot time by rebooting your machine you can test the loopback interface. For instance, <code>telnet localhost</code> should establish a telnet telnet connection to your host, giving you a <code>login:</code> prompt.</p> <p>The loopback interface is often used as a test bed during development, but there are other applications. For example, all applications based on RPC use the loopback RPC interface to register themselves with the portmapper daemon at startup. These applications include NIS and NFS. NIS NFS Hence the loopback interface should always be configured, whether your machine is attached to a network or not.</p>"},{"location":"lpic2.205.1/#ethernet-interfaces","title":"Ethernet Interfaces","text":"<p>Configuring an Ethernet interface is pretty much the same as the ethernet interface loopback interface - it just requires a few more parameters when you use subnetting.</p> <p>Suppose we have subnetted the IP network, which was originally a class B network, into class C subnetworks. To make the interface netmask recognize this, the <code>ifconfig</code> invocation would look like this:</p> <pre><code>    # ifconfig eth0 172.16.1.2 netmask 255.255.255.0\n</code></pre> <p>This command assigns the eth0 interface an IP address of 172.16.1.2. If we had omitted the netmask, <code>ifconfig</code> would deduce the netmask from the IP network class, which would result in an incorrect netmask of 255.255.0.0. Now a quick check shows:</p> <pre><code>    # ifconfig eth0\n    eth0      Link encap 10Mps Ethernet HWaddr\n              00:00:C0:90:B3:42 inet addr 172.16.1.2 Bcast 172.16.1.255 Mask\n              255.255.255.0 UP BROADCAST RUNNING MTU 1500 Metric 1 RX packets 0\n              errors 0 dropped 0 overrun 0 TX packets 0 errors 0 dropped 0 overrun 0\n</code></pre> <p>You can see that <code>ifconfig</code> automatically sets the broadcast broadcast address address (the Bcast field) to the usual value, which is the host's network number with all the host bits set. Also, the maximum transmission unit (the maximum size of IP datagrams the MTU kernel will generate for this interface) has been set to the maximum size of Ethernet packets: 1,500 bytes. The defaults are usually what you will use, but all these values can be overridden if required.</p>"},{"location":"lpic2.205.1/#routing-through-a-gateway","title":"Routing Through a Gateway","text":"<p>You do not need routing if your host is on a single Ethernet. Quite frequently however, networks are connected to one another by gateways. These gateways may simply link two or more Ethernets, but may also provide a link to the outside world, such as the Internet. In order to use a gateway, you have to provide additional routing information to the networking layer.</p> <p>Imagine two ethernets linked through such a gateway, the host romeo. Assuming that romeo has already been configured, we just have to add an entry to the routing table telling the kernel all hosts on the other network can be reached through romeo. The appropriate invocation of <code>route</code> is shown below; the <code>gw</code> keyword tells it that the next argument denotes a gateway:</p> <pre><code>    # route add -net 172.16.0.0 netmask 255.255.255.0 gw romeo\n</code></pre> <p>Of course, any host on the other network you wish to communicate with must have a routing entry for our network. Otherwise you would only be able to send data to the other network, but the hosts on the other network would be unable to reply.</p> <p>This example only describes a gateway that switches packets between two isolated ethernets. Now assume that romeo also has a connection to the Internet (say, through an additional PPP link). In this case, we want datagrams to any destination network to be handed to romeo. This can be accomplished by making it the default gateway: default gateway</p> <pre><code>    # route add default gw romeo\n</code></pre> <p>Something that is frequently misunderstood is that only ONE default gateway can be configured. You may have many gateways, but only one can be the default.</p> <p>The network name <code>default</code> is a shorthand for 0.0.0.0, which denotes the default route. The default route 0.0.0.0 default route matches every destination and will be used if a more specific route is not available.</p>"},{"location":"lpic2.205.1/#the-ip-command","title":"The <code>ip</code> command","text":"<p>In recent years many people have advocated the use of the newer command <code>/sbin/ip</code>. It too can be used to show or manipulate routing and network devices, and also can be used to configure or show policy routing and tunnels. However, the old tools <code>ifconfig</code> and <code>route</code> can be used too if that is more convenient. A use case for the <code>ip</code> would be to show the IP addresses used on the network interfaces in a more concise way compared to <code>ifconfig</code>:</p> <pre><code>    # ip addr show\n    1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN \n        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n        inet 127.0.0.1/8 scope host lo\n        inet6 ::1/128 scope host \n           valid_lft forever preferred_lft forever\n    2: p8p1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000\n        link/ether 00:90:f5:b6:91:d1 brd ff:ff:ff:ff:ff:ff\n        inet 192.168.123.181/24 brd 192.168.123.255 scope global p8p1\n        inet6 fe80::290:f5ff:feb6:91d1/64 scope link \n           valid_lft forever preferred_lft forever\n    3: wlan0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc mq state DOWN qlen 1000\n        link/ether 88:53:2e:02:df:14 brd ff:ff:ff:ff:ff:ff\n    4: vboxnet0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN qlen 1000\n        link/ether 0a:00:27:00:00:00 brd ff:ff:ff:ff:ff:ff\n</code></pre> <p>in contrast to <code>ifconfig</code></p> <pre><code>    # ifconfig -a\n    lo        Link encap:Local Loopback  \n              inet addr:127.0.0.1  Mask:255.0.0.0\n              inet6 addr: ::1/128 Scope:Host\n              UP LOOPBACK RUNNING  MTU:16436  Metric:1\n              RX packets:48 errors:0 dropped:0 overruns:0 frame:0\n              TX packets:48 errors:0 dropped:0 overruns:0 carrier:0\n              collisions:0 txqueuelen:0 \n              RX bytes:4304 (4.2 KiB)  TX bytes:4304 (4.2 KiB)\n\n    p8p1      Link encap:Ethernet  HWaddr 00:90:F5:B6:91:D1  \n              inet addr:192.168.123.181  Bcast:192.168.123.255  Mask:255.255.255.0\n              inet6 addr: fe80::290:f5ff:feb6:91d1/64 Scope:Link\n              UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n              RX packets:6653 errors:0 dropped:0 overruns:0 frame:0\n              TX packets:7609 errors:0 dropped:0 overruns:0 carrier:0\n              collisions:0 txqueuelen:1000 \n              RX bytes:3843849 (3.6 MiB)  TX bytes:938833 (916.8 KiB)\n              Interrupt:53\n\n    vboxnet0  Link encap:Ethernet  HWaddr 0A:00:27:00:00:00  \n              BROADCAST MULTICAST  MTU:1500  Metric:1\n              RX packets:0 errors:0 dropped:0 overruns:0 frame:0\n              TX packets:0 errors:0 dropped:0 overruns:0 carrier:0\n              collisions:0 txqueuelen:1000 \n              RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)\n\n    wlan0     Link encap:Ethernet  HWaddr 88:53:2E:02:DF:14  \n              BROADCAST MULTICAST  MTU:1500  Metric:1\n              RX packets:2 errors:0 dropped:0 overruns:0 frame:0\n              TX packets:11 errors:0 dropped:0 overruns:0 carrier:0\n              collisions:0 txqueuelen:1000 \n              RX bytes:330 (330.0 b)  TX bytes:1962 (1.9 KiB)\n</code></pre> <p>An example of using <code>ip</code> as an alternative to <code>ifconfig</code> when configuring a network interface (p8p1):</p> <pre><code>    # ifconfig p8p1 192.168.123.15 netmask 255.255.255.0 broadcast 192.168.123.255\n</code></pre> <p>can be replaced by:</p> <pre><code>                ip addr add 192.168.123.15/24 broadcast 192.168.123.255 dev p8p1\n</code></pre> <p>The <code>ip</code> can also be used as alternative for the <code>route</code> command:</p> <pre><code>    # ip route add 192.168.123.254/24 dev p8p1\n\n\n    # ip route show\n    192.168.123.0/24 dev p8p1  proto kernel  scope link  src 192.168.123.181  metric 1 \n    default via 192.168.123.254 dev p8p1  proto static\n</code></pre> <p>The output of the <code>route</code> command in this case would be:</p> <pre><code>    # route\n    Destination     Gateway         Genmask         Flags Metric Ref    Use Iface\n    192.168.123.0   *               255.255.255.0   U     1      0        0 p8p1\n    default         192.168.123.254 0.0.0.0         UG    0      0        0 p8p1\n</code></pre> <p>As another example, to add a static route to network 192.168.1.0 over eth0, use:</p> <pre><code>    # ip route add 192.168.1.0/24 dev eth0\n</code></pre> <p>For more information please read the manual pages of <code>ip</code>.</p>"},{"location":"lpic2.205.1/#arp-address-resolution-protocol","title":"ARP, Address Resolution Protocol","text":"<p>In the ISO network model there are seven layers. The Internet Protocol is a layer 3 protocol and the NIC is a layer 2 device. In a local network (layer 2) devices know each other by the MAC (Media Access Control) address. In the IP network (layer 3) devices know each other by their IP address.</p> <p>To allow transfer from data to and from layer 3 IP communication requires a protocol to map between layer 2 and layer 3. This protocol is known as ARP - the Address Resolution Protocol. ARP creates a mapping between an IP address and the MAC address where the IP address is configured.</p> <p>When IP enabled devices want to communicate, the kernel of the originating device hands the IP packet to the network interface driver software and requests to deliver the IP packet to the recipient. The only way to communicate on a local Ethernet is by means of a MAC address, IP addresses are of no use there. To find out the MAC address of the recipient with the proper IP address, the network driver for the interface on the origination side will send an ARP request. An ARP request is a broadcast: it is sent to any computer on the local network. The computer that has the requested IP address will now answer back with its MAC address. The sender then has al the information needed to transmit the packet. Also, the MAC and IP addres are stored in a local cache for future reference.</p> <p>The command <code>arp</code> can be used to show the ARP cache. Example:</p> <pre><code>    # arp\n    Address                  HWtype  HWaddress           Flags Mask            Iface\n    10.9.8.126               ether   00:19:bb:2e:df:73   C                     wlan0\n</code></pre> <p>The cache can be manipulated manually, for example if a host is brought down you might want to remove it's arp entry. Normally you do not need to bother as the cache is not overly persistent. See the man pages for more information on the <code>arp</code> command.</p> <p>Note Additionally, there exists the reverse ARP protocol (RARP). This protocol is used to allow an Ethernet (layer 2) device which IP address(es) it has configured. ARP: broadcast IP and receive MAC. RARP: broadcast MAC and receive IP.</p>"},{"location":"lpic2.205.1/#wireless-networking","title":"Wireless networking","text":""},{"location":"lpic2.205.1/#iw","title":"iw","text":"<p><code>iw</code> is used to configure wireless devices. It only supports the nl80211 (netlink) standard. So if <code>iw</code> doesnt see your device, this might be the reason. You should use <code>iwconfig</code> (from the wireless_tools package) and <code>iwlist</code> to configure the wireless device. These are using the WEXT standard. wireless_tools is deprecated, but still widely supported.</p> <p>Syntax:</p> <pre><code>            # iw command\n            # iw [options] [object] command\n</code></pre> <p>Some common options:</p> <p>dev</p> <ul> <li>This is an object and the name op the wireless device should follow     after this option. with the command <code>iw dev</code> you can see the name of     your device.</li> </ul> <p>link</p> <ul> <li>This is a command and gets the link status of your wireless device.</li> </ul> <p>scan</p> <ul> <li>This is a command and scans the network for available access points.</li> </ul> <p>connect</p> <ul> <li>This is a command which lets you connect to an access point (essid),     you can specify a channel behind it and/or your password.</li> </ul> <p>set</p> <ul> <li>This is a command that lets you set a different interface/mode. For     instance <code>ibss</code> if you want to set the operation mode to Ad-Hoc. Or     set the power save state of the interface.</li> </ul> <p>Examples:</p> <pre><code>        # iw dev wlan0 link                 \n        # iw dev wlan0 scan                 \n        # iw dev wlan0 connect \"Access Point\"         \n        # iw dev wlan0 connect \"Access Point\" 2432        \n        # iw dev wlan0 connect \"Access Point\"  0:\"Your Key\"\n        # iw dev wlan0 set type ibss            \n        # iw dev wlan0 ibss join \"Access Point\" 2432\n        # iw dev wlan0 ibss leave\n        # iw dev wlan0 set power_save on\n</code></pre>"},{"location":"lpic2.205.1/#iwconfig","title":"<code>iwconfig</code>","text":"<p>iwconfig <code>iwconfig</code> is similar to <code>ifconfig</code>, but is dedicated to the wireless interfaces. It is used to set the parameters of the network interface which are specific to the wireless operation (for example : the frequency). <code>iwconfig</code> may also be used to display those parameters, and the wireless statistics.</p> <p>All parameters and statistics are device dependent. Each driver will provide only some of them depending on hardware support, and the range of values may change. Please refer to the man page of each device for details.</p> <p>Syntax:</p> <pre><code>    # iwconfig [interface]\n    # iwconfig interface [options]\n</code></pre> <p>Some common options:</p> <ul> <li> <p>essid</p> <ul> <li>Set the ESSID (or Network Name - in some products it may also be called Domain ID). With some cards, you may disable the ESSID checking (ESSID promiscuous) with off or any (and on to reenable it). If the ESSID of your network is one of the special keywords (off, on or any), you should use -- to escape it.</li> </ul> </li> <li> <p>mode</p> <ul> <li>Set the operating mode of the device, which depends on the network topology. The mode can be Ad-Hoc (the network is composed of one cell only and is without an Access Point), Managed (the node connects to a network composed of multiple Access Points, with roaming), Master (the node is the synchronisation master or acts as an Access Point), Repeater (the node forwards packets between other wireless nodes), Secondary (the node acts as a backup master/repeater), Monitor (the node is not associated with any cell and passively monitors all packets on the frequency) or Auto.</li> </ul> </li> </ul> <p>Examples:</p> <pre><code>    # iwconfig wlan0 essid any\n    # iwconfig wlan0 essid \"Access Point\"\n    # iwconfig wlan0 essid -- \"any\"\n    # iwconfig wlan0 mode Ad-Hoc\n</code></pre>"},{"location":"lpic2.205.1/#iwlist","title":"iwlist","text":"<p><code>iwlist</code> is used to scan for available wireless networks and display additional information about them. The syntax is as follows:</p> <pre><code>    # iwlist [interface] command\n</code></pre> <p><code>iwlist</code> can display ESSID's, frequency/channel information, bit-rates, encryption type, power management information of other wireless nodes in range. Which information is displayed is hardware dependent.</p> <p>Some useful options are:</p> <ul> <li> <p>scan[ning]</p> </li> <li> <p>Returns a list of ad-hoc networks and access points. Depending on     the type of card, more information is shown, i.e. ESSID, signal     strength, frequency. Scanning can only be done by root. When a     non-root users issues the scan command, results from the last scan     are returned, if available. This can also be achieved by adding the     option last. Furthermore, the option essid can be used to     scan for a specific ESSID. Depending on the driver, more options may     be available.</p> </li> <li> <p>keys/enc[ryption]</p> </li> <li> <p>List the encryption key sizes supported and list all the encryption     keys set in the device.</p> </li> </ul>"},{"location":"lpic2.205.2/","title":"Advanced Network Configuration and Troubleshooting (205.2)","text":""},{"location":"lpic2.205.2/#advanced-network-configuration-and-troubleshooting-2052","title":"Advanced Network Configuration and Troubleshooting (205.2)","text":"<p>The candidate should be able to configure a network device to implement various network authentication schemes. This objective includes configuring a multi-homed network device, configuring a virtual private network and resolving networking and communication problems.</p>"},{"location":"lpic2.205.2/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Utilities to manipulate routing tables</p> </li> <li> <p>Utilities to configure and manipulate ethernet network interfaces</p> </li> <li> <p>Utilities to analyse the status of the network devices</p> </li> <li> <p>Utilities to monitor and analyse the TCP/IP traffic</p> </li> </ul>"},{"location":"lpic2.205.2/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/sbin/route</code></p> </li> <li> <p><code>/sbin/ifconfig</code></p> </li> <li> <p><code>/bin/netstat</code></p> </li> <li> <p><code>/bin/ping</code></p> </li> <li> <p><code>/bin/ping6</code></p> </li> <li> <p><code>/usr/sbin/traceroute</code></p> </li> <li> <p><code>/usr/sbin/traceroute6</code></p> </li> <li> <p><code>/usr/sbin/arp</code></p> </li> <li> <p><code>/usr/sbin/tcpdump</code></p> </li> <li> <p><code>/usr/sbin/lsof</code></p> </li> <li> <p><code>/usr/sbin/ss</code></p> </li> <li> <p><code>/usr/bin/nc</code></p> </li> <li> <p><code>/usr/bin/mtr</code></p> </li> <li> <p><code>/sbin/ip</code></p> </li> <li> <p><code>nmap</code></p> </li> <li> <p><code>wireshark</code></p> </li> </ul>"},{"location":"lpic2.205.2/#virtual-private-network","title":"Virtual Private Network","text":""},{"location":"lpic2.205.2/#what-is-a-vpn","title":"What Is A VPN","text":"<p>A VPN (Virtual Private Network) allows you to connect VPN two or more remote networks securely over an insecure connection, for example over the public Internet. To do this an encrypted secure tunnel is created: all data will be encrypted before being tunnel sent over the insecure network. The resulting network connection acts and feels like a physical connection, but actually may traverse many physical networks and systems. Hence its name: \\\"virtual\\\".</p> <p>VPNs are frequently used to save costs. In olden days physical connections had to be leased from telecom providers or you had to use POTS or ISDN lines. This was a costly business. Nowadays the Internet is omnipresent, and almost always available at a low fixed monthly price. However, the Internet can be sniffed and intruders might inspect and/or intercept your traffic. A VPN shields you from most of the problems you might have otherwise.</p> <p>A use case might be to integrate LANs in several offices or branches. A user that works in the Los Angeles office hence can access the network services of the department in New York vice versa. In most cases, offices already have an Internet connection, so no additional investments need to be made.</p>"},{"location":"lpic2.205.2/#vpn-types","title":"VPN Types","text":"<p>There are many ways to implement a VPN, although most solutions either use IPSEC or SSL/TLS as their basis for encryption. Some companies use proprietary software implementations. Many routers have IPSEC based VPN support built in. A usable VPN can be built using a simple SSH SSH tunnel or by using a more sophisticated dedicated solution. Some VPN implementations include:</p> <ul> <li> <p>IPSEC</p> </li> <li> <p>VPND</p> </li> <li> <p>SSH</p> </li> <li> <p>Many Cisco Routers (or other proprietary implementations)</p> </li> <li> <p>SSL/TLS</p> </li> </ul> <p>This book will outline the implementations of OpenVPN and IPSEC. ??? is covered separately in the chapter on System Security. IPSEC</p>"},{"location":"lpic2.205.2/#ipsec","title":"IPSEC","text":"<p>IPSEC provides encryption and authentication services at the IP (Internet Protocol) level of the IPSEC network protocol stack. It replaces/enhances the regular level 3 IP layer so all packets are encrypted, including for example UDP packets. The IPSEC layer has been standardized by the IETF in RFCs 2401--2412. Implementing IPSEC is an option for IPv4 but is mandatory in IPv6 stacks.</p> <p>In a regular IPv4 network you might set up dedicated IPSEC gateway machines to provide encrypted IP network connections when needed. IPSEC can run on routers, firewall machines, various application servers and on end-user desktop or laptop machines - any system that has an IP stack.</p> <p>Using IPSEC is simple, as the protocol is built-in into the IP stack. But there are additional tasks in comparison with a regular IPv4 connection, for example encryption keys need to be exchanged between the end-points before an encrypted tunnel can be set up. It was decided to handle this over a higher-level protocol, the Internet Key Exchange protocol IKE (IKE). After IKE has done its work, the IP level services ESP and AH know which keys to use to do their work.</p> <p>The full names of the three protocols that are used in an IPSEC implementation are:</p> <p>ESP, Encapsulating Security Payload</p> <ul> <li>Encrypts and/or authenticates data;</li> </ul> <p>AH, Authentication Header</p> <ul> <li>Provides a packet authentication service;</li> </ul> <p>IKE, Internet Key Exchange</p> <ul> <li>Negotiates connection parameters, including keys, for the protocols     mentioned above. The IKE protocol ensures authentication of the     peers and exchange of their symmetric keys. The IKE protocol is     usually implemented by a user space daemon that uses port 500/udp.</li> </ul> <p>Note IPSEC standards define all three protocols, but in some contexts people use the term IPSEC to refer to just AH and ESP.</p> <p>OpenSwan, formerly known as FreeS/WAN, is a complete IPSEC implementation for Linux 2.0 - 2.6 kernels. StrongSwan (also derived from FreeS/WAN) is another implementation that also supports the 3.x kernel. Both OpenSwan and FreeSwan implement all three protocols mentioned earlier. The Openswan Openswan implementation has several main parts:</p> <ul> <li> <p>KLIPS (KerneL IPSec) which implements generic IPSEC packet handling,     AH and ESP on the kernel level, for all kernels before version     2.5.47. KLIPS has been superseded by native IPSEC kernel support     (NETKEY).</p> </li> <li> <p>NETKEY is the Kernel IPSec implementation included with the 2.6     kernel.</p> </li> <li> <p>Pluto (an IKE daemon) implements IKE, negotiating connections with     other systems.</p> </li> <li> <p>various scripts provide an administrator interface to the machinery.</p> </li> </ul>"},{"location":"lpic2.205.2/#the-config-file","title":"The config file","text":"<p>The config file contains three parts:</p> <ul> <li> <p>one or more connection specifications</p> <ul> <li>Each connection section starts with <code>conn ident</code>, where <code>ident</code> is an arbitrary name which is used to identify the connection.</li> </ul> </li> <li> <p>connection defaults</p> <ul> <li>This section starts with <code>conn %default</code>. For each parameter in it, any section which does not have a parameter of the same name gets a copy of the one from the <code>%default</code> section. There may be multiple %default sections, but only one default may be supplied for any specific parameter name and all <code>%default</code> sections must precede all non-<code>%default</code> sections of that type.</li> </ul> </li> <li> <p>the config section</p> <ul> <li>The config section starts with <code>config                                      setup</code> and contains information used Configuring Openswan when starting the software.</li> </ul> </li> </ul> <p>A sample configuration file is shown below:</p> <pre><code>    # basic configuration\n    config setup\n            interfaces=\"ipsec0=eth0\"\n            klipsdebug=none\n            plutodebug=none\n            plutoload=%search\n            plutostart=%search\n            # Close down old connection when new one using same ID shows up.\n            uniqueids=yes\n\n    # defaults that apply to all connection descriptions\n    conn %default\n            # How persistent to be in (re)keying negotiations (0 means very).\n            keyingtries=0\n            # How to authenticate gateways\n            authby=rsasig\n\n    # VPN connection for head office and branch office\n    conn head-branch\n            # identity we use in authentication exchanges\n            leftid=@head.example.com\n            leftrsasigkey=0x175cffc641f...\n            left=45.66.9.170\n            leftnexthop=45.66.11.254\n            leftsubnet=192.168.11.0/24\n            # right s.g., subnet behind it, and next hop to reach left\n            rightid=@branch.example.com\n            rightrsasigkey=0xfc641fd6d9a24...\n            right=17.120.138.134\n            rightnexthop=17.120.138.1\n            rightsubnet=192.168.0.0/24\n            # start automatically when ipsec is loaded\n            auto=start\n</code></pre> <p>In a typical setup you have two interconnected gateways that both run IPSEC and route packets. One of these gateways can be seen as 'the one on the left', the other as 'the one on the right'. Hence specifications are written in terms of <code>left</code> and <code>right</code> participants. There is no special meaning attached to either name, they are just labels - you might have defined the 'left' host to be the 'right' host and vice versa.</p> <p>Normally, you would use the exact same configuration file on both sides. Interpretation of that file is done by checking the local configuration. For example if it was stated in the configuration file that the IP address for 'left' is 1.2.3.4, the software assumes that it runs on the left node if it finds that IP address configured on one of its network devices. The same file is interpreted differently on the other node, as that hosts configuration differs.</p> <p>The <code>left</code>, <code>leftsubnet</code> and <code>leftnexthop</code> (and the <code>right...</code> counterparts) determine the layout of the connection:</p> <p></p> <p>The <code>leftid</code> and <code>leftrsasigkey</code> are used in authenticating the left participant. The <code>leftrsasigkey</code> is the public key of the left participant (in the example above the RSA keys are shortened for easy display). The private key is stored in the <code>/etc/ipsec.secrets</code> file and should be kept secure.</p> <p>The keys can be generated on both client and server with the command:</p> <pre><code>    # ipsec rsasigkey --verbose 2048 &gt; rsa.key\n</code></pre> <p>The IKE-daemon of IPSEC is called <code>pluto</code>. It will authenticate and negotiate the secure tunnels. Once the connections is set up, the kernel implementation of IPSEC routes traffic through the tunnel if need be.</p> <p><code>plutoload=%search</code> and <code>plutostart=%search</code> tell the <code>pluto</code> daemon to search the configuration file for <code>auto=</code> statements. All connections with <code>auto=add</code> will be loaded in the pluto database. Connections with <code>auto=start</code> will also be started.</p> <p>Troubleshooting</p> <p>Network troubleshooting is a very broad subject with thousands of tools available. There are some very good books available on this topic, so we will limit our discussion to an overview of some of the tools which can be used to solve or detect network problems.</p>"},{"location":"lpic2.205.2/#ifconfig","title":"ifconfig","text":"<p>Typing <code>ifconfig</code> without additional parameters displays the configuration for all network interfaces ifconfig on the system. You might use this command to verify the configuration of an interface if the user experiences connectivity problems, particularly when their system has just been (re)configured.</p> <p>When <code>ifconfig</code> is entered with an interface name and no other arguments, it displays the current values assigned to that particular interface. For example, checking interface <code>eth0</code> system gives this report:</p> <pre><code>    $ ifconfig eth0\n    eth0      Link encap:Ethernet  HWaddr 00:10:60:58:05:36  \n              inet addr:192.168.2.3  Bcast:192.168.2.255  Mask:255.255.255.0\n              UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n              RX packets:1398185 errors:0 dropped:0 overruns:0 frame:0\n              TX packets:1411351 errors:0 dropped:0 overruns:0 carrier:0\n              collisions:829 txqueuelen:100 \n              RX bytes:903174205 (861.3 Mb)  TX bytes:201042106 (191.7 Mb)\n              Interrupt:11 Base address:0xa000\n</code></pre> <p>The ifconfig command displays a few lines of output. The third line of the display shows the characteristics of the interface. Check for these characteristics:</p> <p>UP</p> <ul> <li>The interface is enabled for use. If the interface is \"down\", bring     the interface \"up\" with the <code>ifconfig</code> command (e.g.     <code>ifconfig eth0 up</code>).</li> </ul> <p>RUNNING</p> <ul> <li>This interface is operational. If the interface is not \"running\",     the driver for this interface may not be properly installed.</li> </ul> <p>The second line of <code>ifconfig</code> output shows the IP address, the subnet mask and the broadcast address. Check these three fields to make sure the network interface is properly configured.</p> <p>Two common interface configuration problems are misconfigured subnet masks and incorrect IP addresses. A bad subnet mask may be the case when the host can reach some hosts on its local subnet but is unable to reach other hosts, even if they are on the same subnet. <code>ifconfig</code> quickly reveals if a bad subnet mask is set.</p> <p>An incorrectly set IP address can be a subtle problem. If the network part of the address is incorrect, every <code>ping</code> will fail with the \"no answer\" ping error; because the IP address is unfamiliar to the other hosts on the network, return packets will be directed to their default gateway (often leading to the internet) or even dropped. In this case, using <code>ifconfig</code> may reveal the incorrect address. However, if the host part of the address is wrong, the problem can be more difficult to detect. A small system, such as a PC that only connects out to other systems and never accepts incoming connections, can run for a long time with the wrong address without its user noticing the problem. Additionally, the system that suffers the ill effects may not be the one that is misconfigured. It is possible for someone to accidentally use your IP address on his own system and for his mistake to cause intermittent communication problems to your system. This type of configuration error cannot be discovered by <code>ifconfig</code>, because the error is on a remote host. IP conflicts like this can be discovered using the <code>arp</code> command, which will show two alternating MAC addresses for the same IP address. arp</p> <p>The <code>ifconfig</code> command can be used to set up multihomed network device. There are two ways a host can be multihomed.</p> <ul> <li> <p>Two Or More Interfaces To The Same Network</p> <ul> <li>Devices such as servers or high-powered workstations may be equipped with two physical interfaces to the same network for performance and/or reliability reasons. They will have two IP addresses on the same network with the same network ID.</li> </ul> </li> <li> <p>Interfaces To Two Or More Different Networks</p> <ul> <li>Devices may have multiple interfaces to different networks. The IP addresses will typically have different network IDs in them.</li> </ul> </li> </ul>"},{"location":"lpic2.205.2/#ping-and-ping6","title":"ping and ping6","text":"<p>ping6 The basic format of the ping or ping6 command on a Linux system is:</p> <pre><code>    $ ping [-c count] host\n    $ ping6 [-c count] host\n</code></pre> <p>host</p> <ul> <li>The hostname or IP address of the remote host being tested. Note     that you cannot ping from an IPv4 host to an IPv6 host or vice     versa. Both ends need to use the same IP version.</li> </ul> <p>count</p> <ul> <li>The number of packets to be sent in the test. Use the count field     and set the value low. Otherwise, the ping command will continue to     send test packets until you interrupt it, usually by pressing     [CTRL+C]{.keycombo} (^C).</li> </ul> <p>To check that www.sue.nl can be reached from your workstation, send four packets with the following command.</p> <pre><code>    $ ping -c 4 www.sue.nl\n    PING home.NL.net (193.67.79.250): 56 data bytes\n    64 bytes from 193.67.79.250: icmp_seq=0 ttl=245 time=32.1 ms\n    64 bytes from 193.67.79.250: icmp_seq=1 ttl=245 time=32.1 ms\n    64 bytes from 193.67.79.250: icmp_seq=2 ttl=245 time=37.6 ms\n    64 bytes from 193.67.79.250: icmp_seq=3 ttl=245 time=34.1 ms\n\n    --- home.NL.net ping statistics ---\n    4 packets transmitted, 4 packets received, 0% packet loss\n    round-trip min/avg/max = 32.1/33.9/37.6 ms\n</code></pre> <p>This test shows a good wide-area network link to www.sue.nl with no packet loss and fast response. A small packet loss, and a round-trip time an order of magnitude higher, would not be abnormal for a connection made across a wide-area network. The statistics displayed by the ping command can indicate a low-level network problem. The key statistics are:</p> <ul> <li> <p>The sequence in which the packets are arriving, as shown by the ICMP     sequence number (icmp_seq) displayed ICMP for each packet;</p> </li> <li> <p>How long it takes a packet to make the round trip, displayed in     milliseconds after the string time=;</p> </li> <li> <p>The percentage of packets lost, displayed in a summary line at the     end of the ping output.</p> </li> </ul> <p>If the packet loss is high, the response time is very high or packets are arriving out of order, there could be a network hardware or link problem. If you see these conditions when communicating over great distances on a wide area network, there is nothing to worry about. TCP/IP was designed to deal with unreliable networks, and some wide-area networks suffer from a moderate level of packet loss. But if these problems are seen on a local-area network, they indicate trouble.</p> <p>On a local-network cable segment, the round-trip time should be close to zero; there should be little or no packet loss and the packets should arrive in order. If these conditions are not met, there is a problem with the network hardware or with the links connecting them. On an Ethernet, the problem could be improper cable termination, a bad cable segment or a bad piece of \"active\" hardware, such as a hub, switch or transceiver.</p> <p>The results of a simple ping test, even if the ping is successful, can help direct you to further testing toward the most likely causes of the problem. But other diagnostic tools are needed to examine the problem more closely and find the underlying cause.</p>"},{"location":"lpic2.205.2/#route","title":"route","text":"<p>To check the routing of a linux box, the <code>route</code> command is usually entered with no route parameters or with <code>-n</code> to turn off ip-address to name resolution. For example <code>route -n</code> might show:</p> <pre><code>    $ route -n\n    Kernel IP routing table\n    Destination     Gateway         Genmask         Flags Metric Ref    Use Iface\n    192.168.11.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0\n    145.66.8.0      0.0.0.0         255.255.252.0   U     0      0        0 eth1\n    0.0.0.0         145.66.11.254   0.0.0.0         UG    0      0        0 eth1\n</code></pre> <p>This host has two interfaces, one on subnet 192.168.11.0/24 the other on subnet 145.66.8.0/22. There is also a default route out on <code>eth1</code> to 145.66.11.254 (denoted by the <code>G</code> under \"Flags\" and a \"Destination\" and \"Genmask\" of 0.0.0.0).</p> <p>To be able to troubleshoot this information you need to know what the routing should be, perhaps by saving the routing information when the system is known to work.</p> <p>The two most common mistakes are:</p> <ul> <li> <p>No network entry for an interface. When a network interface is     configured a routing entry should be automatically added. This     informs the kernel about the network that can be reached through the     interface.</p> </li> <li> <p>No default route (or two default routes). There should be exactly     one default route. Note that two default gateways can go undetected     for a long time because the routing could \"accidentally\" use the     proper gateway.</p> </li> </ul> <p>In general, if there is a routing problem, it is better to first locate the part of the network where the problem originates, e.g. with <code>ping</code> or <code>traceroute</code> and then use traceroute <code>route</code> as part of the diagnostics.</p>"},{"location":"lpic2.205.2/#traceroute","title":"traceroute","text":"<p><code>traceroute</code> and <code>traceroute6</code> are tools used to discover the gateways along a path. Path discovery is an essential step in diagnosing routing problems. Note that <code>traceroute6</code> is equivalent to <code>traceroute -6</code></p> <p>The <code>traceroute</code> command is based on a clever use of the Time-To-Live (TTL) field in the IP packet's TTL header. The TTL field is used to limit the lifetime of a packet. When a router fails or is misconfigured, a routing loop or circular path may result. The TTL field prevents packets from remaining on a network indefinitely should such a routing loop occur. A packet's TTL field is decremented each time the packet crosses a router on its way through a network. When its value reaches 0, the packet is discarded rather than forwarded. When discarded, an ICMP TIME_EXCEEDED TIME_EXCEEDED message is sent back to the packet's source to inform the source that the packet was discarded. By manipulating the TTL field of the original packet, the program <code>traceroute</code> uses information from these ICMP messages to discover paths through a network.</p> <p><code>traceroute</code> sends a series of UDP packets with the destination address of the device you want a path to. By default, <code>traceroute</code> sends sets of three packets to discover each hop. traceroute sets the TTL field in the first three packets to a value of 1 so that they are discarded by the first router on the path. When the ICMP TIME_EXCEEDED messages are returned by that router, <code>traceroute</code> records the source IP address of these ICMP messages. This is the IP address of the first hop on the route to the destination.</p> <p>Next, three packets are sent with their TTL field set to 2. These will be discarded by the second router on the path. The ICMP messages returned by this router reveal the IP address of the second router on the path. The program proceeds in this manner until a set of packets finally has a TTL value large enough so that the packets reach their destination. Most implementations of <code>traceroute</code> default to trying only 30 hops before halting.</p> <p>An example traceroute on linux looks like this:</p> <pre><code>    $ traceroute vhost2.cistron.net\n    traceroute to vhost2.cistron.net (195.64.68.36), 30 hops max, 38 byte packets\n     1  gateway.kabel.netvisit.nl (145.66.11.254)  56.013 ms  19.120 ms  12.642 ms\n     2  145.66.3.45 (145.66.3.45)  138.138 ms  28.482 ms  28.788 ms\n     3  asd-dc2-ias-ar10.nl.kpn.net (194.151.226.2)  102.338 ms  240.596 ms  253.462 ms\n     4  asd-dc2-ipc-dr03.nl.kpn.net (195.190.227.242)  95.325 ms  76.738 ms  97.651 ms\n     5  asd-dc2-ipc-cr01.nl.kpn.net (195.190.232.206)  61.378 ms  60.673 ms  75.867 ms\n     6  asd-sara-ipc-dr01.nl.kpn.net (195.190.233.74)  111.493 ms  96.631 ms  77.398 ms\n     7  asd-sara-ias-pr10.nl.kpn.net (195.190.227.6)  78.721 ms  95.029 ms  82.613 ms\n     8  ams-icr-02.carrier1.net (212.4.192.60)  90.179 ms  80.634 ms  112.130 ms\n     9  212.4.192.21 (212.4.192.21)  49.521 ms  80.354 ms  63.503 ms\n    10  212.4.194.42 (212.4.194.42)  94.528 ms  60.698 ms  103.550 ms\n    11  vhost2.cistron.net (195.64.68.36)  102.057 ms  62.515 ms  66.637 ms\n</code></pre> <p>Again, knowing what the route through your network should be helps to localize the problem. Note that not all network problems can be detected with a <code>traceroute</code>, because of some complicating factors. First, the router at some hop may not return ICMP TIME_EXCEEDED messages. Second, some older routers may incorrectly forward packets even though the TTL is 0. A third possibility is that ICMP messages may be given low priority and may not be returned in a timely manner. Finally, beyond some point of the path, ICMP packets may be filtered by a firewall.</p> <p>The <code>traceroute</code> command is a great tool to narrow down the possible causes of a network problem.</p>"},{"location":"lpic2.205.2/#arp-and-arpwatch","title":"arp and arpwatch","text":"<p><code>arp</code> is used to manipulate the kernel's arp arpwatch ARP cache. The primary options are clearing an address mapping entry and manually setting one up. For debugging purposes, the <code>arp</code> program also allows a complete dump of the ARP cache. ARPcache</p> <p>If you know what the MAC address of a specific host should be, the dump may be used to determine a duplicate IP-address, but running <code>arpwatch</code> on a central system might prove more effective.</p> <p>IP address conflicts are often the result of configuration errors including:</p> <ul> <li> <p>assignment of the same static IP address by a network administrator</p> </li> <li> <p>assignment of a static IP address within a DHCP range (dynamic     range) resulting in the same address being automatically assigned by     the local DHCP server</p> </li> <li> <p>an error in the DHCP server</p> </li> <li> <p>a system coming back online after an extended period in stand-by or     hibernate mode with an IP address that has been reassigned and is in     use on the network.</p> </li> </ul> <p>Detection of duplicate IP addresses can be very hard even with <code>arpwatch</code>. IP address conflicts occur when two devices on a network are assigned the same IP address, resulting in one or both being disabled and losing connectivity until the conflict is resolved.</p> <p>If, for example, a rogue host rogue host uses the IP address of the host running the <code>arpwatch</code> program or never communicates with it, a duplicate IP address will go unnoticed. Still, <code>arpwatch</code> is a very useful tool in detecting networking problems.</p> <p><code>arpwatch</code> keeps track of ethernet/IP address pairings. Changes are reported via syslog and e-mail.</p> <p><code>arpwatch</code> will report a \"changed ethernet address\" when a known IP address shows up with a new ethernet address. When the old ethernet address suddenly shows up again, a \"flip flop\" is reported.</p>"},{"location":"lpic2.205.2/#tcpdump","title":"tcpdump","text":"<p><code>tcpdump</code> is a program that enables network tcpdump administrators to inspect every packet going through the network in real-time. This tool is typically used to monitor active connections or troubleshoot occasional network connectivity problems. In order to see traffic, however, the host running <code>tcpdump</code> must be somewhere along the path between two (or more) hosts exchanging traffic. This may prove to be difficult in a fully switched network. An easy solution is to run tcpdump on the host that needs to send or receive traffic. Another option is to configure a port on one of the switches where a copy of traffic from certain source and destination ports is sent; this is called a SPAN port.</p> <p><code>tcpdump</code> can generate a lot of output, so it is useful to narrow the scope of packets captured by specifying the interface you want to listen on using <code>-i</code>. In addition, you can specify the source, destination, protocol type and/or port number of the traffic you want to see joined by boolean AND and OR statements if necessary. An example command could be: <code>tcpdump -i eth0 src 10.10.0.1 and dst 10.10.0.254                 and tcp port 80</code>). Other useful options are <code>-n</code> to turn of name resolution and <code>-w</code> to write captured packets to a file for later inspection (e.g. in Wireshark).</p>"},{"location":"lpic2.205.2/#nmap","title":"nmap","text":"<p><code>nmap</code> is a versatile tool for network exploration and security auditing. Its main use is as a portscanner, which also can identify running services, versions of the running services and OS types.</p> <p>An example of this command and output is:</p> <pre><code>    $ nmap -A localhost\n\n        Starting Nmap 7.60 ( https://nmap.org ) at 2020-05-08 12:56 CEST\nNmap scan report for localhost (127.0.0.1)\nHost is up (0.00015s latency).\nOther addresses for localhost (not scanned): ::1\nNot shown: 994 closed ports\nPORT     STATE SERVICE  VERSION\n22/tcp   open  ssh      OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:\n|   2048 fc:4c:2d:44:51:30:9e:8a:56:0b:a9:29:fa:e3:d7:21 (RSA)\n|   256 83:bb:46:7c:fc:61:9a:61:26:25:87:89:1c:43:a6:6c (ECDSA)\n|_  256 bd:16:c8:7c:3e:29:00:6d:cc:79:d8:80:4a:92:0b:d7 (EdDSA)\n25/tcp   open  smtp     Postfix smtpd\n|_smtp-commands: oeboe.udonix.nl, PIPELINING, SIZE 10240000, ETRN, AUTH DIGEST-MD5 NTLM CRAM-MD5 LOGIN PLAIN, AUTH=DIGEST-MD5 NTLM CRAM-MD5 LOGIN PLAIN, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8,\n| smtp-ntlm-info:\n|_  Target_Name: OEBOE.UDONIX.NL\n111/tcp  open  rpcbind  2-4 (RPC #100000)\n| rpcinfo:\n|   program version   port/proto  service\n|   100000  2,3,4        111/tcp  rpcbind\n|   100000  2,3,4        111/udp  rpcbind\n|   100003  3           2049/udp  nfs\n|   100003  3,4         2049/tcp  nfs\n|   100005  1,2,3      42208/udp  mountd\n|   100005  1,2,3      48465/tcp  mountd\n|   100021  1,3,4      37657/tcp  nlockmgr\n|   100021  1,3,4      38288/udp  nlockmgr\n|   100227  3           2049/tcp  nfs_acl\n|_  100227  3           2049/udp  nfs_acl\n143/tcp  open  imap     Dovecot imapd (Ubuntu)\n|_imap-capabilities: SASL-IR more Pre-login post-login LITERAL+ IDLE listed capabilities ID have LOGIN-REFERRALS OK IMAP4rev1 AUTH=PLAINA0001 STARTTLS ENABLE\n| ssl-cert: Subject: commonName=oeboe.udonix.nl\n| Not valid before: 2018-06-23T13:16:13\n|_Not valid after:  2028-06-20T13:16:13\n|_ssl-date: TLS randomness does not represent time\n993/tcp  open  ssl/imap Dovecot imapd (Ubuntu)\n|_imap-capabilities: SASL-IR more IMAP4rev1 LITERAL+ IDLE post-login listed ID have LOGIN-REFERRALS Pre-login OK AUTH=PLAINA0001 capabilities ENABLE\n| ssl-cert: Subject: commonName=oeboe.udonix.nl\n| Not valid before: 2018-06-23T13:16:13\n|_Not valid after:  2028-06-20T13:16:13\n|_ssl-date: TLS randomness does not represent time\n2049/tcp open  nfs_acl  3 (RPC #100227)\nService Info: Host: no; OS: Linux; CPE: cpe:/o:linux:linux_kernel\n\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 14.54 seconds\n</code></pre> <p>Note Some of the <code>nmap</code> command options require root privileges, consult the <code>NMAP(1)</code> manpage for more information</p>"},{"location":"lpic2.205.2/#wireshark","title":"wireshark","text":"<p>Wireshark is an open source network protocol analyzer. It allows you to examine data from a live network or from a capture file on disk. You can interactively browse the capture data, delving down into just that level of packet detail you need.</p> <p>Wireshark has several powerful features, including a rich display filter language and the ability to view the reconstructed stream of a TCP session. It also supports hundreds of protocols and media types. A tcpdump-like console version named tethereal is also included. One word of caution is that Ethereal has suffered from dozens of remotely exploitable security holes, so stay up-to-date and be wary of running it with root privileges on untrusted or hostile networks (such as security conferences).</p>"},{"location":"lpic2.205.2/#lsof","title":"lsof","text":"<p>The <code>lsof</code> command lists all open files on a system. Since Linux treats everything as a file, it also shows open network sockets. It can be used to find open ports on a system as well as determining the origin of a network connection.</p> <p>Options of the <code>lsof</code> used for network troubleshooting.</p> <p>-i</p> <ul> <li>List IP sockets. The <code>-i</code> option also takes arguments to restrict     the sockets listed, like <code>-i</code> <code>tcp</code> or <code>-i</code> <code>192.168.1.2</code>.</li> </ul> <p>-n</p> <ul> <li>Do not resolve hostnames; can make <code>lsof</code> run faster.</li> </ul> <p>-P</p> <ul> <li>Do not resolve port names; can make <code>lsof</code> run faster.</li> </ul> <p>+P</p> <ul> <li>Resolve port name to protocol; default behaviour.</li> </ul>"},{"location":"lpic2.205.2/#ss","title":"ss","text":"<p>The <code>ss</code> command can be used to investigate network sockets on a system, similar to netstat.</p> <p>Useful options of the <code>ss</code> for network troubleshooting include:</p> <p>-a</p> <ul> <li>List all sockets. This includes sockets in listening state.</li> </ul> <p>-n</p> <ul> <li>Do not resolve port names.</li> </ul> <p>-l</p> <ul> <li>Only display listening sockets.</li> </ul> <p>-p</p> <ul> <li>Show processes using the sockets</li> </ul> <p>-t</p> <ul> <li>Restrict output to TCP sockets</li> </ul> <p>-u</p> <ul> <li>Restrict output to UDP sockets</li> </ul>"},{"location":"lpic2.205.2/#netstat","title":"netstat","text":"<p>Like <code>lsof</code>, <code>netstat</code> is a program to list open ports on a system. It looks for the standard ports, but it also finds custom ports opened by applications, for instance <code>netcat</code>.</p> <p>Frequently used options are:</p> <p>-a</p> <ul> <li>List all sockets.</li> </ul> <p>-e</p> <ul> <li>Extended mode.</li> </ul> <p>-inet</p> <ul> <li>List only IP connections</li> </ul> <p>-l</p> <ul> <li>Only show listening sockets</li> </ul> <p>-n</p> <ul> <li>Show IP numbers instead of resolving them to hostnames.</li> </ul> <p>-p</p> <ul> <li>Show the PID number and name of the process that is holding the     socket.</li> </ul> <p>-r</p> <ul> <li>Show the kernel routing table. Is the same as the <code>route</code> command.</li> </ul>"},{"location":"lpic2.205.2/#nc","title":"nc","text":"<p><code>nc</code> is used for establishing TCP and UDP connections between arbitrary ports on either end. After opening a port, it can listen for input, which can be passed through to another command for further processing. Note that you need to have administrative privileges on the system you're running this command on for opening a listening port below 1024. The command allows the user to set up, analyze and read connections between systems. It is a very useful tool in the troubleshooting toolbox. <code>nc</code> can be used to open up any port.</p> <p>Because <code>nc</code> is capable of connecting and listening to any port it can be used to transfer files between systems that lack Samba, FTP or SSH etc.</p> <p>if <code>nmap</code> is not available the <code>nc</code> command can be used to check for open ports: Run nc command with -z flag. You need to specify host name / ip along with the port range to limit and speedup operation. eg.</p> <pre><code>    # nc -z localhost 1-1023\n</code></pre>"},{"location":"lpic2.205.2/#mtr","title":"mtr","text":"<p>The <code>mtr</code> command is extremely helpful for troubleshooting network problems, because it combines the functionality of ping and traceroute. Rather than provide a simple outline of the route that traffic takes across the internet like traceroute, mtr collects additional information regarding the state, connection, and responsiveness of the intermediate hosts.</p> <p><code>mtr</code> can be used without any options. Just type: <code>mtr&gt;                 host</code> to get a visual display of the path between you and the host and per-hop statistics. Like <code>ping</code>, <code>mtr</code> will continue to send ICMP packets indefinitely by default. Useful options are:</p> <p>-n</p> <ul> <li>Do not reverse resolve IP addresses to hostnames</li> </ul> <p>-c count</p> <ul> <li>Send count number of probe packets, then stop</li> </ul>"},{"location":"lpic2.205.2/#ip","title":"ip","text":"<p>The <code>ip</code> command has already been discussed in the previous chapter.</p>"},{"location":"lpic2.205.3/","title":"Troubleshooting network issues (205.3)","text":""},{"location":"lpic2.205.3/#troubleshooting-network-issues-2053","title":"Troubleshooting network issues (205.3)","text":"<p>Candidates should be able to identify and correct common network setup issues, to include knowledge of locations for basic configuration files and commands.</p>"},{"location":"lpic2.205.3/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Location and content of access restriction files</p> </li> <li> <p>Utilities to configure and manipulate ethernet network interfaces</p> </li> <li> <p>Utilities to manage routing tables</p> </li> <li> <p>Utilities to list network states</p> </li> <li> <p>Utilities to gain information about the network configuration</p> </li> <li> <p>Methods of information about the recognised and used hardware     devices</p> </li> <li> <p>System initialisation files and their contents (Systemd and SysV     init process)</p> </li> <li> <p>Awareness of NetworkManager and its impact on network configuration</p> </li> </ul>"},{"location":"lpic2.205.3/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>ip</code></p> </li> <li> <p><code>ifconfig</code></p> </li> <li> <p><code>route</code></p> </li> <li> <p><code>ss</code></p> </li> <li> <p><code>netstat</code></p> </li> <li> <p><code>/etc/network/</code>, <code>/etc/sysconfig/network-scripts</code></p> </li> <li> <p><code>ping</code>, <code>ping6</code></p> </li> <li> <p><code>traceroute</code>, <code>traceroute6</code></p> </li> <li> <p><code>mtr</code></p> </li> <li> <p><code>hostname</code></p> </li> <li> <p>System log files such as <code>/var/log/syslog</code> &amp; <code>/var/log/messages</code></p> </li> <li> <p><code>dmesg</code></p> </li> <li> <p><code>/etc/resolv.conf</code></p> </li> <li> <p><code>/etc/hosts</code></p> </li> <li> <p><code>/etc/hostname</code>, <code>/etc/HOSTNAME</code></p> </li> <li> <p><code>/etc/hosts.allow</code>, <code>/etc/hosts.deny</code></p> </li> </ul>"},{"location":"lpic2.205.3/#introduction-to-network-troubleshooting","title":"Introduction to network troubleshooting","text":"<p>It would be great if you would be able to open up a book and find an index there of all possible network problems and their solutions. But in practice that is impossible. There are way too many scenarios to describe and new technologies are surfacing constantly, creating new options - and new problems. However, almost every problem can be solved by applying knowledge and logic. In the case of network troubleshooting, this means mostly that you should determine how traffic should flow from source to destination and back, and checking step by step if you can see the traffic passing by using the tools described earlier. Also, make sure to check traffic in both directions if possible, as many network problems stem from the fact that traffic from source to destination may not be following the same path as traffic the other way around.</p> <p>Key files, terms and utilities have already been described in ??? and other chapters. In this chapter we focus on the problem solving process and introduce a number of additional techniques, utilities and key files.</p>"},{"location":"lpic2.205.3/#an-example-situation","title":"An example situation","text":"<p>You are browsing the Internet on a PC. It is connected to the Internet via a local area network and a firewall. Suddenly, you can not access your favourite webpage anymore. It could be the network, the firewall, the ISP, or even the browser.. what is a reasonable approach to find the problem and solve it?</p> <p>Note The focus of this section is on troubleshooting networks. Hence we will focus on network components. In a real situation there are many more components involved, for example the browser, operating system, local firewall setups etc. on which we will touch only briefly.</p> <p>The first step is to assemble a list of all network components involved. The lenght of the list varies, depending on the complexity of the configuration and your personal knowledge. </p> <p>A simple list would at least contain this: troubleshooting components involved troubleshooting first step</p> <ul> <li> <p>The PC itself. It has a network interface that is connected to the     LAN (eth0 in most situations);</p> </li> <li> <p>The firewall. It has two interfaces: its eth0 interface which is     connected to the LAN and the eth1 interface which is connected to     the router that in turn is connected to the an ISP who provides     Internet connectivity;</p> </li> <li> <p>The site you are trying to reach, connected to the Internet.</p> </li> </ul> <p>Then think about how everything works together. You enter the URL in the browser. Your machine uses DNS to find out what the IP address is of the web site you are trying to reach etc.</p> <p>Packets travel through your eth0 interface over the LAN to the eth0 interface of the firewall and through the eth1 interface of the firewall to the ISP and from the ISP in some way to the web server.</p> <p>Now that you know how the different components interact, you can take steps to determine the source of the malfunction.</p> <p>The graphic below gives an example of step-by-step troubleshooting.</p> <p></p> <p>S</p> <ul> <li>The cause of the problem has been determined and can be S(olved).</li> </ul> <p>1</p> <ul> <li>Can we reach other machines on the internet ? Try another URL or try     pinging another machine on the internet. Be troubleshooting ping     troubleshooting ICMP careful to jump to conclusions if your <code>ping</code>     reports no connectivity - your firewall could be blocking ICMP     echo-requests and replies.</li> </ul> <p>2</p> <ul> <li>Is the machine we are trying to reach, the target, down? This is a     feasible theory if for example other sites can be reached. Try     reaching the machine via another network, contact a friend and let     him try to reach the machine, call the person responsible for the     machine etc.</li> </ul> <p>3</p> <ul> <li>Can we reach the firewall? Try pinging the firewall, login to it     etc.</li> </ul> <p>4</p> <ul> <li>Is there a router on the route (a \"hop\") down ? troubleshooting HOP     Use <code>traceroute</code> to find out what the hops are between you and the     target host. The route from a machine to LPI's web-server for     instance can be determined by issuing the command     <code>traceroute -I www.lpi.org</code>: troubleshooting traceroute<pre><code>    # traceroute -I www.lpi.org\n    traceroute to www.lpi.org (209.167.177.93), 30 hops max, 38 byte packets\n    1  fertuut.suegroningen (192.168.2.1)  0.555 ms  0.480 ms  0.387 ms\n    2  wc-1.r-195-85-156.essentkabel.com (195.85.156.1)  30.910 ms  26.352 ms  19.406 ms\n    3  HgvL-WebConHgv.castel.nl (195.85.153.145)  19.296 ms  28.656 ms  29.204 ms\n    4  S-AMS-IxHgv.castel.nl (195.85.155.2)  172.813 ms  199.017 ms  95.894 ms\n    5  f04-08.ams-icr-03.carrier1.net (212.4.194.13)  118.879 ms  84.262 ms  130.855 ms\n    6  g02-00.amd-bbr-01.carrier1.net (212.4.211.197)  30.790 ms  45.073 ms  28.631 ms\n    7  p08-00.lon-bbr-02.carrier1.net (212.4.193.165)  178.978 ms  211.696 ms  301.321 ms\n    8  p13-02.nyc-bbr-01.carrier1.net (212.4.200.89)  189.606 ms  413.708 ms  194.794 ms\n    9  g01-00.nyc-pni-02.carrier1.net (212.4.193.198)  134.624 ms  182.647 ms  411.876 ms\n    10  500.POS2-1.GW14.NYC4.ALTER.NET (157.130.94.249)  199.503 ms  139.083 ms  158.804 ms\n    11  578.ATM3-0.XR2.NYC4.ALTER.NET (152.63.26.242)  122.309 ms  191.783 ms  297.066 ms\n    12  188.at-1-0-0.XR2.NYC8.ALTER.NET (152.63.18.90)  212.805 ms  193.841 ms  94.278 ms\n    13  0.so-2-2-0.XL2.NYC8.ALTER.NET (152.63.19.33)  131.535 ms  131.768 ms  152.717 ms\n    14  0.so-2-0-0.TL2.NYC8.ALTER.NET (152.63.0.185)  198.645 ms  136.199 ms  274.059 ms\n    15  0.so-3-0-0.TL2.TOR2.ALTER.NET (152.63.2.86)  232.886 ms  188.511 ms  166.256 ms\n    16  POS1-0.XR2.TOR2.ALTER.NET (152.63.2.78)  153.015 ms  157.076 ms  150.759 ms\n    17  POS7-0.GW4.TOR2.ALTER.NET (152.63.131.141)  143.956 ms  146.313 ms  141.405 ms\n    18  akainn-gw.customer.alter.net (209.167.167.118)  384.687 ms  310.406 ms  302.744 ms\n    19  new.lpi.org (209.167.177.93)  348.981 ms  356.486 ms  328.069 ms\n</code></pre> </li> </ul> <p>5</p> <ul> <li>Can other machines in the network reach the firewall? Use ping, or     login to the firewall from that machine or try viewing a web page on     the internet from that machine.</li> </ul> <p>6</p> <ul> <li>Does the firewall block the traffic to that particular machine?     troubleshooting blocking traffic troubleshooting firewall Maybe     someone blocked traffic to and/or from that site.</li> </ul> <p>7</p> <ul> <li>Inspect the firewall. If the problem seems to be on the firewall,     test the interfaces on the firewall, inspect the firewalling rules,     check the cabling etc.</li> </ul> <p>8</p> <ul> <li>ifconfig Is our eth0 interface up? This can be tested by issuing the     command <code>ifconfig eth0</code>.</li> </ul> <p>9</p> <ul> <li>route Are your route definitions as they should be? Think of things     like default gateway. The route table can be viewed troubleshooting     routing by issuing the command <code>route -n</code>.</li> </ul> <p>10</p> <ul> <li>Is there a physical reason for the problem? Check if the the problem     is in the cabling. This could be a troubleshooting physical problem     defective cable or a badly shielded one. Putting power supply     cabling and data cabling through the same tube without metal     shielding between the two of them can cause unpredictable, hard to     reproduce errors in the data transmission.</li> </ul>"},{"location":"lpic2.205.3/#name-resolution-problems","title":"Name resolution problems","text":"<p>There are even more options why the connection fails:</p> <p>Name resolution is the translation of a hostname into an IP address. If a user tries to connect to a machine based on the hostname of that machine and the hostname resolution doesn't function properly then no connection will be established at all.</p> <p>The file <code>/etc/resolv.conf</code> contains the IP addresses of the nameservers. The nameservers are the servers that do the name resolution for a external network. For small (local) networks a local lookup table can be made by using the <code>/etc/hosts</code> file. This file contains a list of aliases or FQDN (fully qualified domain name) (or both) per IP address.</p> <p>You can check name resolution with the commands <code>dig</code> (dig is an acronym for Domain Information Groper) or <code>host</code>. Both of these commands return the IP address associated with the hostname.</p> <pre><code>    $ host ns12.zoneedit.com\n    ns12.zoneedit.com has address 209.62.64.46\n\n\n    $ dig zonetransfer.me\n\n    ; &lt;&lt;&gt; DiG 9.8.3-P1 &lt;&lt;&gt;&gt; zonetransfer.me\n    ;; global options: +cmd\n    ;; Got answer:\n    ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 6133\n    ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 1\n\n    ;; QUESTION SECTION:\n    ;zonetransfer.me.       IN  A\n\n    ;; ANSWER SECTION:\n    zonetransfer.me.    7142    IN  A   217.147.180.162\n\n    ;; AUTHORITY SECTION:\n    zonetransfer.me.    7142    IN  NS  ns12.zoneedit.com.\n    zonetransfer.me.    7142    IN  NS  ns16.zoneedit.com.\n\n    ;; ADDITIONAL SECTION:\n    ns12.zoneedit.com.  7116    IN  A   209.62.64.46\n\n    ;; Query time: 1 msec\n    ;; SERVER: 213.154.248.156#53(213.154.248.156)\n    ;; WHEN: Thu Jul  4 10:59:55 2013\n    ;; MSG SIZE  rcvd: 115\n</code></pre> <p><code>dig</code> is the swiss army knife of name resolving and has a lot of options. It provides elaborate output. The <code>host</code> command offers a fast and convenient way to seek out an IP address for a host known by its name.</p> <p>The hostname of a machine itself is stored in a file called <code>/etc/hostname</code> or <code>/etc/HOSTNAME</code> for Debian based systems. On RedHat systems the name is stored in the file <code>/etc/sysconfig/network</code>. For all systems the hostname can be found with the command <code>/bin/hostname</code>. When given no argument, this command gives replies with the hostname of the machine. In case an argument is given along with the command, the hostname of the machine will be changed.</p>"},{"location":"lpic2.205.3/#incorrect-initialization-of-the-system","title":"Incorrect initialization of the system","text":"<p>Another possible cause of network problems can be the incorrect initialization of the system. To find any initialization errors check out the file <code>/var/log/messages</code> or read the kernel ring buffer by using the <code>/bin/dmesg</code> command.</p>"},{"location":"lpic2.205.3/#security-settings","title":"Security settings","text":"<p>Security settings can also be a source of connection problems. The server may have blocked access from or allow access from certain clients using the <code>/etc/host.deny</code> resp. <code>/etc/host.allow</code></p>"},{"location":"lpic2.205.3/#network-configuration","title":"Network configuration","text":"<p>Perhaps network settings were copied over from another site and not adapted to the local situation?  You can check these settings in the files in the directory <code>/etc/sysconfig/network-scripts</code> for RedHat-based systems or in the file <code>/etc/network</code> for Debian-based systems.</p>"},{"location":"lpic2.205.3/#networkmanager","title":"NetworkManager","text":"<p>NetworkManager is a GUI based tool to manage your networkconnections. NetworkManager is a also a service that is able to report network changes. The purpose of NetworkManager is to simplify the use of configuring your network within Linux.</p> <p>Typically the user settings will be stored in: <code>/home/$user/.gconf/system/networking/connections</code> The system settings are stored in: <code>/etc/Networkmanager/ /etc/NetworkManager/system-connections</code> Be aware of the fact that NetworkManager will overwrite any configuration changes made to networksettings.</p> <p>There is also an option to configure your NetworManager on the commandline. It is called nmcli and you can find it at <code>/usr/bin/nmcli</code>.</p>"},{"location":"lpic2.206.0/","title":"System Maintenance (206)","text":"<p>This topic has a total weight of 7 points and contains the following objectives:</p>"},{"location":"lpic2.206.0/#objective-2061-make-and-install-programs-from-source-4-points","title":"Objective 206.1; Make and install programs from source (4 points)","text":"<ul> <li>Candidates should be able to build and install an executable program     from source. This objective includes being able to unpack a file of     sources.</li> </ul>"},{"location":"lpic2.206.0/#objective-2062-backup-operations-3-points","title":"Objective 206.2; Backup Operations (3 points)","text":"<ul> <li>Candidates should be able to use system tools to back up important     system data.</li> </ul>"},{"location":"lpic2.206.0/#objective-2063-notifying-users-on-system-related-issues-1-point","title":"Objective 206.3; Notifying users on system-related issues (1 point)","text":"<ul> <li>Candidates should be able to notify the users about current issues     related to the system.</li> </ul>"},{"location":"lpic2.206.1/","title":"Make and install programs from source (206.1)","text":""},{"location":"lpic2.206.1/#make-and-install-programs-from-source-2061","title":"Make and install programs from source (206.1)","text":"<p>Candidates should be able to build and install an executable program from source. This objective includes being able to unpack a file of sources.</p>"},{"location":"lpic2.206.1/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Unpack source code using common compression and archive utilities</p> </li> <li> <p>Understand basics of invoking make to compile programs</p> </li> <li> <p>Apply parameters to a configure script</p> </li> <li> <p>Know where sources are stored by default</p> </li> </ul>"},{"location":"lpic2.206.1/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/usr/src</code></p> </li> <li> <p><code>gunzip</code></p> </li> <li> <p><code>gzip</code></p> </li> <li> <p><code>bzip2</code></p> </li> <li> <p><code>xz</code></p> </li> <li> <p><code>tar</code></p> </li> <li> <p><code>configure</code></p> </li> <li> <p><code>make</code></p> </li> <li> <p><code>uname</code></p> </li> <li> <p><code>install</code></p> </li> <li> <p><code>patch</code></p> </li> </ul>"},{"location":"lpic2.206.1/#unpacking-source-code","title":"Unpacking source code","text":"<p>Most Open Source software is distributed as compressed tarballs containing source code and build scripts to compile and install the software. Preferably the source is extracted and compiled in <code>/usr/src/</code> but any location will do.</p> <p>These tarballs are generally compressed using gzip, bzip2 or xz. GNU tar supports these compression formats, and makes it easy to decompress such files. For example, to unpack a gzip compressed tarball:</p> <pre><code>    $ tar zxvf /path/to/tarball.tar.gz\n</code></pre> <p>The <code>z</code> option tells tar to use the gzip algorithm, and the <code>x</code> option tells tar to extract the file. To extract a bzip2 compressed file use GNU tar's <code>j</code> option:</p> <pre><code>    $ tar jxvf /path/to/tarball.tar.bz2\n</code></pre> <p>To extract a xz compressed file use GNU tar's <code>J</code> option:</p> <pre><code>    $ tar Jxvf /path/to/tarball.tar.xz\n</code></pre> <p>Although GNU tar supports these compression alghorithms, several other tar implementations don't. To extract compressed tarballs on machines with such tar implementations, you first need to decompress the file, and then extract the contents.</p> <p>For a gzip compressed tarball:</p> <pre><code>    $ gunzip /path/to/tarball.tar.gz\n</code></pre> <p>For a bzip2 compressed tarball:</p> <pre><code>    $ bunzip2 /path/to/tarball.tar.bz2\n</code></pre> <p>xz For a xz compressed tarball:</p> <pre><code>    $ unxz /path/to/tarball.tar.xz\n</code></pre> <p>As an alternative, you can also use the '-d' (decompress) argument to the <code>gzip</code>, <code>bzip2</code> and <code>xz</code> commands.</p> <p>After decompression, you can extract the contents by calling tar without giving a compression argument:</p> <pre><code>    $ tar xvf /path/to/tarball.tar\n</code></pre>"},{"location":"lpic2.206.1/#building-from-source","title":"Building from source","text":"<p>Usually the build scripts are generated using GNU autoconf and automake. automake is used to generate GNU Coding standard compliant Makefile.in files. autoconf produces self-contained configure scripts which can then be used to adapt, build and install the software on the target system.</p> <p>The usual way of building and installing software from source looks something like this:</p> <pre><code>    $ tar zxvf sue-2.0.3.tar.gz\n    $ cd sue-2.0.3\n    $ ./configure\n    $ make\n    $ su\n    # make install\n</code></pre> <p>The <code>./configure</code> command will check for both optional and mandatory dependencies. It will also adapt the source code to the target system (think system architecture, installed libraries, compiler flags, install directories, ...). If an optional dependency is missing, it will disable compilation to that dependency. In the case of missing required dependencies, it will print the error and exit.</p> <p>According to GNU standards, the commands above would install the \"sue\" application under <code>/usr/local</code>. If you want to install the application under some other directory structure, for example <code>/opt</code>, the configure command would look like:</p> <pre><code>    $ ./configure --prefix=/opt\n</code></pre> <p>Try <code>./configure --help</code> to see all possible configure arguments.</p> <p>The configure command also generates Makefiles which <code>make</code> uses to compile and install the software. The <code>Makefile</code> usually contains several \"build targets\" which you can call by giving them as an argument to make. Often used targets include \"all\" which is usually the default action, \"clean\" to clean up (remove) built object files from the source tree, and \"install\" to install the software after the build stage.</p> <p>It is possible to install the software in a location other than the build directory. This is for useful if you want to build the software on one machine, and install it on another:</p> <pre><code>    $ tar zxvf sue-2.0.3.tar.gz\n    $ cd sue-2.0.3\n    $ ./configure --prefix=/opt/sue\n    $ make DESTDIR=/tmp/sue_tmp install\n</code></pre> <p>This technique is often used to build software on one machine, and install it onto multiple others. In the above case, the <code>/tmp/sue_tmp</code> directory would only contain files installed by sue-2.0.3.</p> <p>If not cross-compiling for another platform, configure will use <code>uname</code> to guess what machine it 's running on. Configure can usually guess the canonical name for the type of system it's running on. To do so it runs a script called <code>config.guess</code>, which infers the name using the <code>uname</code> command or symbols predefined by the C preprocessor.</p> <pre><code>    $ cd /tmp/sue_tmp\n    $ tar zcf ../sue_2.0.3_built.tgz opt/\n</code></pre> <p>The c option (as opposed to the previously mentioned x option) to tar tells it to create a new archive.</p> <p>If you copy the resulting tarball to the target machines in, let's say, the <code>/tmp</code> directory, you can execute the following commands to install the sue software into <code>/opt/sue</code>:</p> <pre><code>    # cd /\n    # tar zxvf /tmp/sue_2.0.3_built.tgz\n</code></pre> <p>As alternative to using the make command you can use the install utility to copy binaries to the required location. When you copy the files with <code>install</code>, permissions and owner/group information will be set correctly. If the destination file(s) already exists they will be overwritten. But you can have <code>install</code> create a backup of these files by using the <code>-b</code> argument or using the VERSION_CONTROL enviroment variable.</p>"},{"location":"lpic2.206.1/#patch","title":"Patch","text":"<p><code>patch</code> is a program that updates files. In short: apply a diff file on a original file. <code>patch</code> takes a patchfile containing a difference listing produced by the diff program and applies those differences to one or more original files, producing patched versions. Normally the patched versions are put in place of the originals. The names of the files to be patched are usually taken from the patchfile, but if there's just one file to be patched it can specified on the command line as originalfile.</p> <p>Here is an example of how <code>patch</code> works:</p> <p>To apply a patch.</p> <pre><code>    $ patch -p1 &lt; /path/to/path-x.y.z\n</code></pre> <p>To revert a patch.</p> <pre><code>    $ patch -R -p1 &lt; /path/to/patch-x.y.z\n</code></pre> <p>Note Patching is not part of the LPIC-2 objectives, but is included here because it is used frequently when you build from source.</p>"},{"location":"lpic2.206.2/","title":"Backup Operations (206.2)","text":""},{"location":"lpic2.206.2/#backup-operations-2062","title":"Backup Operations (206.2)","text":"<p>Candidates should be able to use system tools to back up important system data.</p>"},{"location":"lpic2.206.2/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Knowledge about directories that have to be include in backups</p> </li> <li> <p>Awareness of network backup solutions such as Amanda, Bacula, Bareos and BackupPC</p> </li> <li> <p>Knowledge of the benefits and drawbacks of tapes, CDR, disk or other backup media</p> </li> <li> <p>Perform partial and manual backups</p> </li> <li> <p>Verify the integrity of backup files</p> </li> <li> <p>Partially or fully restore backups</p> </li> <li> <p>Awareness of Bareos</p> </li> </ul>"},{"location":"lpic2.206.2/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/bin/sh</code></p> </li> <li> <p><code>dd</code></p> </li> <li> <p><code>tar</code></p> </li> <li> <p><code>/dev/st*</code> and <code>/dev/nst*</code></p> </li> <li> <p><code>mt</code></p> </li> <li> <p><code>rsync</code></p> </li> </ul>"},{"location":"lpic2.206.2/#why","title":"Why?","text":"<p>Making backups is the sysadmins Pavlov reaction to having at least one system to administer. But do we still need backups? After all, nowadays data is often stored on RAID cabinets or \"in the cloud\".</p> <p>Well, it depends. First of all superredundant storage will only protect you against one reason for data-loss, namely hardware failure. But not against human error, software bugs and natural disasters.</p> <p>After all, humans are quite unreliable, they might make a mistake or be malicious and destroy data on purpose. Modern software does not even pretend to be reliable. A rock-solid program is an exception, not a rule. Nature may not be evil, but, nevertheless, can be very destructive sometimes. The most reliable thing is hardware, but it still breaks seemingly spontaneously, often at the worst possible time.</p> <p>To protect yourself against any of these threats, a very cheap and simple control is available: to make regular backups. There is a very low break-even point between the costs of data loss and those of making backups. In fact, the control used to be so cheap that employing it became a solid best practice.</p> <p>But please note that there are situations in which making a backup is not necessary. An example is a math-cluster. The results of its calculation are important and you probably will make backups of these. But cluster nodes themselves are discardable. Might a node fail you can simply replace it with a freshly installed one.</p> <p>So, in conclusion: making backups should always be the result of proper risk-analysis. But in the overwhelming majority of cases they are a cheap way of ensuring your data availability and in some cases your data integrity.</p>"},{"location":"lpic2.206.2/#what","title":"What?","text":"<p>What you need to backup should be the result of proper risk analysis. In olden days most system administrators simply backed up as much as possible - that may not be such a good idea anymore as it takes a lot of time to backup and restore large quantities of data. In all situations you do not need to backup certain parts of the Linux filesystem anyway, for example the <code>/proc</code> and <code>/sys</code> filesystems. They only contain data that the kernel generates automatically, it is never a good idea to back it up. The <code>/proc/kcore</code> file is especially unnecessary, since it is just an image of your current physical memory; it's pretty large as well. Some special files that are constantly changed by the operating system (e.g. <code>/etc/mtab</code>) should not be restored, hence not be backed up. There may be others on your system.</p> <p>Gray areas include the news spool, log files and many other things in <code>/var</code>. You must decide what you consider important - do a proper risk analysis. Also, consider what to do with the device files in <code>/dev</code>. Most backup solutions can backup and restore these special files, but you may want to re-generate them with a script or they may be created when you reinstall a system.</p> <p>The obvious things to back up are user files (<code>/home</code>) and system configuration files (<code>/etc</code>, but possibly other things scattered all over the filesystem).</p> <p>Generally it is a good idea to backup everything needed to rebuild the system as fast as required after a failure - and nothing else. It is often quite difficult to find out what to backup and what not, hence the sysadmins paradigm: whilst in doubt, back it up.</p>"},{"location":"lpic2.206.2/#when","title":"When?","text":"<p>Depending on the rate of change of the data, this may be anything from daily to almost never. The latter happens on firewall systems, where only the log files change daily (but logging should happen on a different system anyway). So, the only time when a backup is necessary, for example, is when the system is updated or after a security update.</p> <p>To determine your minimal backup frequency consider the amount of data you are confident you can afford to loose without severe consequences for you and/or your company. Then consider the minimal timespan needed to create that amount of data. You should make at least one backup during that timespan. Practical considerations like the time it takes to make a backup and whether or not you can do any work when a backup is being made, will restrict the maximum frequency. In the past systems were mainly used during the day and not at all in weekends. Hence many companies made incremental backups during the night and a full backup during the weekend. However, nowadays many systems need to be used 24 x 7 which creates the need for alternate strategies, for example creating snapshots on disk, which can subsequently be backed up on tape while the production systems continue their work on the live filesystem.</p> <p>Backups can take several hours to complete, but, for a successful backup strategy, human interaction should be minimal. Backups are mostly made to disk or on tape. In the latter case, the human interaction can be further reduced by having tape robots that change the tapes for you. However, make sure to store tapes off-site so any disaster will not take out your backups. And be sure to protect sensitive data on tapes you store off-site, for example by encrypting the data stored on them.</p>"},{"location":"lpic2.206.2/#how","title":"How?","text":"<p>While the brand or the technology of the hardware and software used for backups is not important, there are, nevertheless, important considerations in selecting them. Imagine, for example, the restore software breaks and the publisher has since gone out of business.</p> <p>No matter how you create your backups, the two most important parts in a backup strategy are:</p>"},{"location":"lpic2.206.2/#verifying-the-backup","title":"Verifying the backup","text":"<ul> <li>The safest method is to read back the entire backup and compare this     with the original files. This is very time-consuming and often not     an option. A faster, and relatively safe method, is to create a     table of contents (which should contain a checksum per file) during     the backup. Afterwards, read the contents of the tape and compare     the two.</li> </ul>"},{"location":"lpic2.206.2/#testing-the-restore-procedure","title":"Testing the restore procedure","text":"<ul> <li>This means that you must have a restore procedure.     This restore procedure has to specify how to restore anything from a     single file to the whole system. Every few months, you should test     this procedure by doing a restore.</li> </ul>"},{"location":"lpic2.206.2/#where","title":"Where?","text":"<p>If something fails during a backup, the medium will not contain anything useful. If you made that backup on your only medium you lost your data. So you should have at least two sets of backup media. But if you store both sets in the same building, the first disaster that comes along will destroy all your precious backups along with the running system.</p> <p>So you should have at least one set stored at a remote site. Depending on the nature of your data, you could store weekly or daily sets remotely.</p> <p>You will need a written plan, the backup plan, which describes what is backed up, how to restore what is being backed up an any other procedures surrounding the backup. Do not forget to store a copy of the backup-plan along with backupplan the backups at the remote site. Otherwise you cannot guarantee that the system will be back up-and-running in the shortest possible time.</p> <p>One important thing to be aware of, as noted in the previous paragraphs, you need to be able to rebuild your system (or restore certain files) as fast as required. In some enviroments restore times can be hours because of slow network lines or other causes. The time lost may be too much and can defeat the purpose of the backup system. Other solutions for continuity of service like cluster/failover systems are recommended.</p> <p>There are different types of backup media, each with their own benefits and drawbacks. The medium of choice however will often be made based on total cost. The main types are: Tape, Disk, Optical Media, Remote/Network</p>"},{"location":"lpic2.206.2/#tape","title":"Tape","text":"<p>Tape is one of the most used mediums for backup in enterprise environments. It is low cost and because tapes store passively they have a low chance for failure and consume little power on standby. A disadvantage of tape is that it is a streaming medium which means high access times, especially when a tape robot is used for accessing multiple tapes. Bandwidth can be high if data is provides/requisted in a continuous stream. Tape is especially suitable for long term backup and archiving. If a lot of small files have to be written or restored the tape will need to be stopped and started and may even need to be partially rewound frequently to allow processing by the restoring operating system. This may consume excessive time. In those cases tape is not the best medium.</p>"},{"location":"lpic2.206.2/#disk","title":"Disk","text":"<p>Local disk storage is hardly used for backup, (though it is used for network storage, see below). The advantages are high bandwidth, low latency and a reasonable price compared to capacity. But it is not suitable for off-site backup (or the disk has to be manually disconnected en transported to a safe location). And since disks are always connected and running, chances for failure are high. Though not suitable for off-site backup it is sometimes used as intermediate (buffer) medium between the backup system and an off-site backup server. The advantage is that fast recovery of recent files is possible and the production systems won't be occupied by long backup transfers. Another option, suitable for smaller systems, is using cheap USB bus based portable disks. These can be spun down and powered off when not in use, while still retaining their data. They can contain many terabytes of data and can be taken off-site easily. Also, modern disks employ fast USB protocols that reduce backup- and restore-time.</p>"},{"location":"lpic2.206.2/#optical-media","title":"Optical Media","text":"<p>Optical media like CDROM and DVDR disk are mostly used to backup systems which don't change a lot. Often a complete image of the system is saved to disk for fast recovery. Optical disks are low cost and have a high reliability when stored correctly. They can easily be transported off-site. Disadvantages are that most are write-once and the storage capacity is low. Access time and bandwidth are moderate, although mostly they have to be handled manually by the operator.</p>"},{"location":"lpic2.206.2/#remotenetwork-storage","title":"Remote/Network storage","text":"<p>Network storage is mostly remote disk storage (NAS or SAN). Using data protection techniques like RAID, the unreliability of disks can be reduced. Most modern network storage systems use compression and deduplication to increase potential capacity. Also most systems can emulate tape drives which makes it easy to migrate from tape. The cost of the systems can be high depending on the features, reliability and capacity. Also power costs should be considered because a network storage system is always on. This type of medium is thus not preferred for long time backup and archives. Access time and bandwidth can differ and depend on infrastructure, but are mostly high.</p>"},{"location":"lpic2.206.2/#backup-utilities","title":"Backup utilities","text":""},{"location":"lpic2.206.2/#rsync","title":"rsync","text":"<p><code>rsync</code> is a utility to copy/synchronise files from one location to the other while keeping the required bandwidth low. It wil look at the files to copy and the files already present at the destination and uses timestamps, filesize and an advanced algorithm to calculate which (portions of) files need to be transferred. Source and destination can be local or remote and in case of a remote server SSH or <code>rsync</code> protocol can be used for network transfer. <code>Rsync</code> is invoked much like the <code>cp</code> command. Recursive mode is enabled with <code>-r</code> and archive with <code>-a</code>. A simple example to copy files from a local directory to a remote directory via SSH:</p> <pre><code>    rsync -av -e ssh /sue remote:/sue\n</code></pre> <p>Note By default <code>rsync</code> copies over (relevant parts of) changed files and new files from a remote system. It does not delete files that were deleted on the remote system. Specify the option <code>--delete</code> if you want that behaviour. Also note that permissions will be copied over correctly, but if your local UIDs/GIDs do not match te remote set you may end up with incorrect local permissions still.</p>"},{"location":"lpic2.206.2/#tar","title":"tar","text":"<p>The <code>tar</code> utility is used to combine multiple files and directories into a continous stream of bytes (and revert the stream into files/directories). This stream can be compressed, transferred over network connections, saved to a file or streamed onto a tape device. When reading files from the stream, permissions, modes, times and other information can be restored. <code>Tar</code> is the most basic way for transferring files and directories to and from tape, either with or without compression.</p> <p>An example of extracting a gzipped <code>tar</code> archive, with verbose output and input data read from a file:</p> <pre><code>    tar xvzf sue.tgz\n</code></pre> <p>Extracting a <code>tar</code> archive from a scsi tape drive:</p> <pre><code>    tar xvf /dev/st0\n</code></pre> <p>Creating a archive to file from the directory <code>/sue</code>:</p> <pre><code>    cd /; tar cvf /tmp/sue.tar sue\n</code></pre> <p>By default the <code>tar</code> utility uses (scsi) tape as medium. As can be seen in the example above scsi tape devices can be found in <code>/dev/st*</code> or <code>/dev/nst*</code>. The latter one is a non rewinding tape, this means that the tape does not rewind automatically after each operation. This is an important feature for backups, because otherwise when using multiple <code>tar</code> commands for backups any backup but the last would be overwritten by the next backup.</p> <p>Tapes can be controlled by the <code>mt</code> command (magnetic tape). The syntax of this command is: <code>mt [-h] [-f device] command [count]</code>. The option -h (help) lists all possible commands. If the device is not specified by the -f option, the command will use the environment variable TAPE as default. More information can be found in the manual pages.</p>"},{"location":"lpic2.206.2/#dd","title":"dd","text":"<p>Using the <code>dd</code> utility, whole disks/partitions can be transferred from/to files or other disks/partitions. With <code>dd</code> whole filesystems can be backed-up at once. <code>dd</code> will copy data at byte level. Common options to <code>dd</code> are:</p> <p>if</p> <p>input file: for the input file/disk/partition</p> <p>of</p> <p>output file: for the output file/disk/partition</p> <p>bs</p> <p>block size: size of blocks used for transfer, can be optimised depending on used hardware</p> <p>count</p> <p>number of blocks to transfer (dd will read until end-of-file otherwise)</p> <p>An example of <code>dd</code> usage to transfer a 1GB partition to file:</p> <pre><code>    dd if=/dev/hda1 of=/tmp/disk.img bs=1024 count=1048576\n</code></pre>"},{"location":"lpic2.206.2/#cpio","title":"<code>cpio</code>","text":"<p>The <code>cpio</code> utility is used to copy files to and from archives. It can read/write various archive formats including <code>tar</code> and zip. Although it predates <code>tar</code> it is less well known. <code>cpio</code> has three modes, input mode (<code>-i</code>) to read an archive and extract the files, output mode (<code>-o</code>) to read a list of files and compress them into an archive and pass-through mode (<code>-p</code>) which reads a list of files and copies these to the destination directory. The file list is read from <code>stdin</code> and is often provided by <code>find</code>. An example of compressing a directory into a cpio archive:</p> <pre><code>    cd /sue; find . | cpio -o &gt; sue.cpio\n</code></pre>"},{"location":"lpic2.206.2/#backup-solutions","title":"Backup solutions","text":"<p>Complete backup solutions exist which help simplify the administration and configuration of backups in larger environments. These solutions can automate backup(s) of multiple servers and/or clients to multiple backup media. Many different solutions exist, each with their own strengths and weaknesses. Below you'll find some examples of these solutions.</p>"},{"location":"lpic2.206.2/#amanda","title":"Amanda","text":"<p>AMANDA, the Advanced Maryland Automatic Network Disk Archiver, is a backup solution that allows the IT administrator to set up a single master backup server to back up multiple hosts over network to tape drives/changers or disks or optical media. Amanda uses native utilities and formats (e.g. <code>dump</code> and/or GNU <code>tar</code>) and can back up a large number of servers and workstations running multiple versions of Linux or Unix.</p>"},{"location":"lpic2.206.2/#bacula","title":"Bacula","text":"<p>Bacula is a set of Open Source, enterprise ready, computer programs that permit you (or the system administrator) to manage backup, recovery, and verification of computer data across a network of computers of different kinds. Bacula is relatively easy to use and efficient, while offering many advanced storage management features that make it easy to find and recover lost or damaged files. In technical terms, it is an Open Source, enterprise ready, network based backup program. According to Source Forge statistics (rank and downloads), Bacula is by far the most popular Enterprise grade Open Source program.</p>"},{"location":"lpic2.206.2/#bareos","title":"Bareos","text":"<p>Bareos is a fork of the project Bacula version 5.2 and was started because of rejection and neglect of community contributions to the Bacula project. The Bareos backup program is open source and is almost the same as Bacula, but is does have some additional features like LTO hardware encryption, bandwidth limitation and new practical console commands. One focus in Bareos's development is keeping the obstacles for newcomers as low as possible. Because newcomers are usually overwhelmed by configuration options, the Bareos project offers package repositories for popular Linux distributions and Windows.</p>"},{"location":"lpic2.206.2/#backuppc","title":"BackupPC","text":"<p>BackupPC is a high-performance, enterprise-grade system for backing up Linux, WinXX and MacOSX PCs and laptops to a server's disk. BackupPC is highly configurable and easy to install and maintain.</p>"},{"location":"lpic2.206.3/","title":"Notifying users on system-related issues (206.3)","text":""},{"location":"lpic2.206.3/#notifying-users-on-system-related-issues-2063","title":"Notifying users on system-related issues (206.3)","text":"<p>Candidates should be able to notify the users about current issues related to the system.</p>"},{"location":"lpic2.206.3/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Automate communication with users through logon messages</p> </li> <li> <p>Inform active users of system maintenance</p> </li> </ul>"},{"location":"lpic2.206.3/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/etc/issue</code></p> </li> <li> <p><code>/etc/issue.net</code></p> </li> <li> <p><code>/etc/motd</code></p> </li> <li> <p><code>wall</code></p> </li> <li> <p><code>/sbin/shutdown</code></p> </li> <li> <p><code>/bin/systemctl</code></p> </li> </ul>"},{"location":"lpic2.206.3/#the-etcissue-etcissuenet-and-etcmotd-files","title":"The <code>/etc/issue</code>, <code>/etc/issue.net</code>, and <code>/etc/motd</code> files","text":"<p>The <code>/etc/issue</code>, <code>/etc/issue.net</code> and <code>/etc/motd</code> files are used to send simple messages to users that log in to the system. The <code>/etc/motd</code> is used to display a message after the user has authenticated successfully. The <code>/etc/issue</code> on the other hand is used to send a message to the user before they login. This message is only displayed to users that log in using the console and will often contain some information about the system like kernel version and architecture. The <code>/etc/issue.net</code> file has the same purpose as the <code>/etc/issue</code> file but is used for insecure logins using <code>telnet</code>. It is possible to use the <code>/etc/issue.net</code> file for <code>ssh</code> as well. For this to work you need to add or modify the following line in <code>/etc/ssh/sshd_config</code>:</p> <pre><code>    Banner /etc/issue.net\n</code></pre> <p>When using <code>/etc/issue.net</code> with ssh you should note that the special sequences may not work.</p>"},{"location":"lpic2.206.3/#the-wall-command","title":"The <code>wall</code> command","text":"<p>wall <code>wall</code> is used to broadcast a message of at most 22 lines to all interactive terminals. By default the command can be used by any user, but often is reconfigured so only root can use it. A user not wishing to receive broadcast messages may use the <code>mesg</code> to write disable their terminals. The broadcaster may use the <code>finger</code> command to see which terminals are write disabled.</p> <p>You can specify two options with the <code>wall</code> command: the <code>-n</code> option, which only works for the root user and the message itself. The <code>-n</code> suppresses the standard broadcast banner and replaces it with a remote broadcast banner. This option has meaning only when <code>wall</code> is used over the <code>rpc.walld</code> daemon. The second argument, the message itself can also be typed on <code>stdin</code>, in which case it must be terminated with an EOF (end of file, in most cases [Ctrl+D]{.keycombo}).</p>"},{"location":"lpic2.206.3/#the-shutdown-command-communication","title":"The <code>shutdown</code> command communication.","text":"<p>shutdown As its name suggests, the <code>shutdown</code> command is used to shutdown a server gracefully, stepping down through the run level kill scripts, and optionally halting, or rebooting the server. The shutdown command itself is not discussed here, and this small section explains only the communicative steps that <code>shutdown</code> takes before, and during the system shutdown.</p> <p>The last argument to the <code>shutdown</code> may optionally be used to broadcast some custom message explaining the purpose of the shutdown, and when it is expected to be returned to production. For example:</p> <pre><code>    # shutdown -H +10 Server halting in 10 minutes for change change number. Expected up at 00:00:00.\n</code></pre> <p>Shutdown can be used with the <code>-k</code>. This makes <code>shutdown</code> do a 'dry-run': it emulates the shutdown, but does NOT shut down the system.</p> <p>When you use the <code>-k</code> options you can append broadcast messages as part of the command line too, like in a \"real\" <code>shutdown</code>.</p> <p>Note Please note that <code>shutdown</code> <code>-k</code> will still temporarily disallow user logins as it will create the <code>/etc/nologin</code> file. It will be removed after the 'dry run' but your users will not be able to log in into the system as long as it is there.</p> <p>In the event that a running <code>shutdown</code> needs to be cancelled, the <code>shutdown</code> may be called with the <code>-c</code> option, and again a broadcast message added to the command line to inform the users of the U-turn. As with all forms of message broadcasts, the receiving terminals must be write enabled.</p>"},{"location":"lpic2.206.3/#the-systemctl-command-communication","title":"The <code>systemctl</code> command communication,","text":"<p>systemctl The <code>systemctl</code> the central management tool for the systemd init system. <code>systemctl</code> can be used to manage services, system states (runlevels) and config files.</p>"},{"location":"lpic2.206.3/#managing-services","title":"Managing services","text":""},{"location":"lpic2.206.3/#starting-and-stopping-services","title":"Starting and stopping services","text":"<p>Where you used the <code>service</code> command in sysVinit you will now use the systemctl command to manage services. If you are using a non-root user to run the command you will have to use sudo. The following example shows starting a service using the <code>start</code> command:</p> <pre><code>    $ systemctl start application.service\n</code></pre> <p>Because systemd knows you are running the system management commands on services you can also leave the .service suffix. For clarity we will keep using the suffix in the commands.</p> <pre><code>    $ systemctl start application\n</code></pre> <p>For some programs it is possible to start the application multiple times with different configuration files. In this case you can pass the name of the config file to the command using the @-sign. For example, to start the openvpn service twice with different configuration files you can use the following commands:</p> <pre><code>    $ systemctl start openvpn@config1.service\n    $ systemctl start openvpn@config2.service\n</code></pre> <p>Because they changed the order of the parameters for the systemctl command you can also start and stop multiple services at once: The following example show stopping multiple services using the <code>stop</code> command:</p> <pre><code>    $ systemctl stop application1.service application2.service\n</code></pre>"},{"location":"lpic2.206.3/#restarting-and-reloading-services","title":"Restarting and reloading services","text":"<p>For restarting a service you can use the <code>restart</code> command:</p> <pre><code>    $ systemctl restart application.service\n</code></pre> <p>If an application is able to reload it's configuration you can also use the <code>reload</code> command:</p> <pre><code>    $ systemctl reload application.server\n</code></pre> <p>If you not sure if a service can reload it's configuration you can also use the <code>reload-or-restart</code> command. This will reload is configuration if it is available, else it will restart the application:</p> <pre><code>    $ systemctl reload-or-restart application.service\n</code></pre>"},{"location":"lpic2.206.3/#enabling-and-disabling-service","title":"Enabling and disabling service","text":"<p>The previous commands are useful for starting and stopping services in the current session. If you want a service to start at boot, for which sysVinit use the <code>chkconfig</code> command, you have to enable them using <code>systemctl</code>:</p> <pre><code>    $ systemctl enable application.service\n</code></pre> <p>This <code>enable</code> command will create a symbolic link from this systems copy of the service file (which is usually found in /lib/systemd/system or /etc/systemd/system) to the directory where systemd looks for autostart files (usually /etc/systemd/system/some_target.target.wants). To disable a service from start at boot you use the <code>disable</code> command:</p> <pre><code>    $ systemctl disable application.service\n</code></pre> <p>This will remove the symbolic link that indicate that the service should start at boot.</p> <p>Note Remember that enabling a service will not start it in the current session. To start and enable a service you will need to issue both the start and enable command</p>"},{"location":"lpic2.206.3/#checking-the-status-of-services","title":"Checking the status of services","text":"<p>To check the current status of a service you can use the <code>status</code> command:</p> <pre><code>    $ systemctl status application.service\n</code></pre> <p>This command will give you the current state of the service, the cgroup hierarchy, and the first few log lines. It gives you a nice overview of the current status, and notifying you of any problems. For example the following output for the sshd service:</p> <pre><code>    $ systemctl status sshd.service\n      - sshd.service - OpenSSH server daemon\n         Loaded: loaded (/usr/lib/systemd/system/sshd.service; enabled; vendor preset: enabled)\n         Active: active (running) since Fri 2016-12-16 08:18:17 CET; 4h 58min ago\n           Docs: man:sshd(8)\n                 man:sshd_config(5)\n        Process: 1033 ExecStart=/usr/sbin/sshd $OPTIONS (code=exited, status=0/SUCCESS)\n       Main PID: 1067 (sshd)\n          Tasks: 1 (limit: 4915)\n         CGroup: /system.slice/sshd.service\n                 `-1067 /usr/sbin/sshd\n\n      Dec 16 08:18:17 localhost.localdomain systemd[1]: Starting OpenSSH server daemon...\n      Dec 16 08:18:17 localhost.localdomain systemd[1]: sshd.service: PID file /var/run/sshd.pid not readable (yet?) after start: No such file or directory\n      Dec 16 08:18:17 localhost.localdomain sshd[1067]: Server listening on 0.0.0.0 port 22.\n      Dec 16 08:18:17 localhost.localdomain sshd[1067]: Server listening on :: port 22.\n      Dec 16 08:18:17 localhost.localdomain systemd[1]: Started OpenSSH server daemon.\n</code></pre> <p>There are also commands available for checking specific states which can be particularly useful for using them in scripts. For example to check if as service is currently active you can use the <code>is-active</code> command:</p> <pre><code>    $ systemctl is-active application.service\n</code></pre> <p>This command will show if the application is active or inactive. If the application is active it will return an exit code of \"0\". To see if an application is enabled you can use the <code>is-enabled</code> command:</p> <pre><code>    $ systemctl is-enabled application.service\n</code></pre> <p>This command will return wheter the application is enbled or disable and will return an exit code of \"0\" if the application is enabled. To check if an application has failed you can use the <code>is-failed</code> command:</p> <pre><code>    $ systemctl is-failed application.service\n</code></pre> <p>This command wil return active if the application is running, failed if an error has occured, and inactive or unknown the the service was intentionally stopped. It will return an exit code of \"0\" if the service has failed.</p>"},{"location":"lpic2.206.3/#system-state-overview","title":"System state overview","text":"<p>The commands so far have been useful for managing single services. For exploring the the current state of the system there ar a number of systemctl commands that provide more information.</p>"},{"location":"lpic2.206.3/#listing-current-units","title":"Listing current units","text":"<p>To get a list of all the active units that systemd knows about you can use the <code>list-units</code> command:</p> <pre><code>    $ systemctl list-units\n</code></pre> <p>This command only shows a list of the currently active units. Then output has the following columns:</p> <pre><code>    UNIT: The systemd unit name\n    LOAD: Whether the unit's configuration has been parsed by systemd. The\n          configuration of loaded units is kept in memory.\n    ACTIVE: A summary state about whether the unit is active. This is usually a\n            fairly basic way to tell if the unit has started successfully or not.\n    SUB: This is a lower-level state that indicates more detailed information\n         about the unit This often varies by unit type, state, and the actual\n         method in which the unit runs.\n    DESCRIPTION: A short textual description of what the unit is/does/\n</code></pre> <p>Because the <code>list-units</code> command only shows the active units by default, all of the entries above will show \"loaded\" in the LOAD colymn and \"active\" in the ACTIVE column. This is also the default behaviour of systemctl when called without additional commands, so you will see the same output if you call systemctl without arguments.</p> <pre><code>    $ systemctl\n</code></pre> <p>You can also tell systemctl to output different information by adding additional flags. For instance, to show all units that systemd has loaded, whether they are active or not, you can use the <code>--all</code> flag:</p> <pre><code>    $ systemctl list-units --all\n</code></pre> <p>This will show all units that systemd loaded or attempted to load, regardless of it's current state on the system. It is also possible to filter units by the current state, for this you can use the <code>--state=</code> flag. You will have to keep the <code>--all</code> flag so that systemctl allows non-active units to be disaplayed. For example, if you wish to see all inactive units you can issue the following command:</p> <pre><code>    $ systemctl list-units --all --state=inactive\n</code></pre> <p>Another filter you can use is the <code>--type=</code> flag. You can tell systemctl to only show the unit types you are interested in. For example, to only show active service units you can use the following command:</p> <pre><code>    $ systemctl list-units --type=service\n</code></pre>"},{"location":"lpic2.206.3/#listing-unit-files","title":"Listing unit files","text":"<p>The <code>list-units</code> command we just used only shows units that systemd has attempted to load into memory. Systemd will only read units that it thinks it need so this will not necessarily include all availble units on the system. To see every unit file that is available in the systemd paths you can use the <code>list-unit-files</code> command instead:</p> <pre><code>    $ systemctl list-unit-files\n</code></pre> <p>Units are representations of resources that systemd knows about. Because systemd has not necessarily read all of the unit definitions in this view it only presents information about hte files themselves. The output of this command shows two columns, the UNIT FILE and the STATE. The STATE column will usually be \"enabled\",\"disabled\",\"static\" or \"masked\". For this command static means that the unit file doesn't contain an \"install\" section which is necessary to enable a service. A unit that has a state of static can't be enable will run a one-off action or is only used as a dependency of another unit. We will cover what \"masked\" means later.</p>"},{"location":"lpic2.206.3/#unit-management","title":"Unit management","text":"<p>So far we have been working with services an displaying information about the unit files that systemd knows about. With some additional commands we can get more specific information about units.</p>"},{"location":"lpic2.206.3/#displaying-a-unit-file","title":"Displaying a unit file","text":"<p>To display the unit file that systemd has loaded into it's memory you can use the <code>cat</code> command (which was added in systemd version 209). To see the unit file of the atd scheduling daemon you can use to following command:</p> <pre><code>    $ systemctl cat atd.service\n\n    [Unit]\n    Description=ATD daemon\n\n    [Service]\n    Type=forking\n    ExecStart=/usr/bin/atd\n\n    [Install]\n    WantedBy=multi-user.target\n</code></pre> <p>The output of this command is the unit file as it's known by the current systemd process. This is important to know if you've recently modified the unit files or if you're overriding certain options.</p>"},{"location":"lpic2.206.3/#displaying-dependencies","title":"Displaying dependencies","text":"<p>If we want to see the dependency tree of a service we can use the <code>list-dependencies</code> command:</p> <pre><code>    $ systemctl list-dependencies sshd.service\n</code></pre> <p>This command wil show a hierarchical view of the dependencies that must be dealt with in order to start the unit. Dependencies, in this context, are the units that are required or wanted by the units above it.</p> <pre><code>    sshd.service\n    |-system.slice\n    `-basic.target\n      |-microcode.service\n      |-rhel-autorelabel-mark.service\n      |-rhel-autorelabel.service\n      |-rhel-configure.service\n      |-rhel-dmesg.service\n      |-rhel-loadmodules.service\n      |-paths.target\n      |-slices.target\n\n    . . .\n</code></pre> <p>Recursive dependencies are only displayed for target units which indicate system states. To list all dependencies you can include the <code>--all</code> flag.</p> <p>To get the reverse dependencies you can add the <code>--reverse</code> flag to the command. Other useful flags are the <code>--before</code> and <code>--after</code> flags which can be used to show units to depend on the specified unit to start before or after them respectivly.</p>"},{"location":"lpic2.206.3/#checking-unit-properties","title":"Checking unit properties","text":"<p>To get the low-level properties of a unit you can use the <code>show</code>. This will display a list of properties in a key=value format:</p> <pre><code>    $ systemctl show sshd.service\n\n    Id=sshd.service\n    Names=sshd.service\n    Requires=basic.target\n    Wants=system.slice\n    WantedBy=multi-user.target\n    Conflicts=shutdown.target\n    Before=shutdown.target multi-user.target\n    After=syslog.target network.target auditd.service systemd-journald.socket basic.target system.slice\n    Description=OpenSSH server daemon\n\n    . . .\n</code></pre> <p>To get a single property you can pass the <code>-p</code> flag with the property name. For example, to see the conflicts that the sshd.service unit has you can use the following command:</p> <pre><code>    $ systemctl show sshd.service -p Conflicts\n\n    Conflicts=shutdown.target\n</code></pre>"},{"location":"lpic2.206.3/#masking-and-unmasking-units","title":"Masking and unmasking units","text":"<p>In the service management section we showed how to stop or disable a service, but systemd also has the ability to mark a unit as completely unstartable. To do this it creates a symbolic link to <code>/dev/null</code> which is called masking a unit. To do this you can use the <code>mask</code> command:</p> <pre><code>    $ systemctl mask nginx.service\n</code></pre> <p>This wil prevent the Nginx service from being start manually or automatically for as long as it's masked. If you check with the <code>list-unit-files</code> command you will see that the service is now listed as masked:</p> <pre><code>    $ systemctl list-unit-files\n\n    . . .\n\n    kmod-static-nodes.service              static\n    ldconfig.service                       static\n    mandb.service                          static\n    messagebus.service                     static\n    nginx.service                          masked\n    quotaon.service                        static\n    rc-local.service                       static\n    rdisc.service                          disabled\n    rescue.service                         static\n\n    . . .\n</code></pre> <p>If you try to start the service you will see a message like this:</p> <pre><code>    $ systemctl start nginx.service\n\n    Failed to start nginx.service: Unit nginx.service is masked.\n</code></pre> <p>To unmask a service you can use the <code>unmask</code> command:</p> <pre><code>    $ systemctl unmask nginx.service\n</code></pre> <p>This will return the unit to it's previous start allowing the service to be started or enabled.</p>"},{"location":"lpic2.206.3/#editing-unit-files","title":"Editing unit files","text":"<p>The systemctl command also has the possibility to edit unit files if you need to make adjustments. This functionality was added in systemd version 218.</p> <p>The <code>edit</code> will open a unit file snipper by default:</p> <pre><code>    $ systemctl edit nginx.service\n</code></pre> <p>This will be a blank file that can be used to override or add properties to the unit definition. A directory will be created within the <code>/etc/systemd/system</code> directory which will have the name of the unit with .d appended. For example, for the nginx.service, a directory callend nginx.service.d will be created.</p> <p>If you want to edit the full unit file, instead of adding a snippet, you can pass the <code>--full</code> flag:</p> <pre><code>    $ systemctl edit --full nginx.service\n</code></pre> <p>This will load the current unit file into the editor where you can modify it. When the editor exits the changes will be written to <code>/etc/systemd/system</code>. This new file will take precedence over the system unit definition (usually found somewhere in <code>/lib/systemd/system</code>).</p> <p>To remove any additions you have meid you can either remove the units .d configuration directory or the modiefied service file from <code>/etc/systemd/system</code>. For instance, to remove a snipper, you can type:</p> <pre><code>    $ rm -r /etc/systemd/system/nginx.service.d\n</code></pre> <p>To remove a full modified unit file you can type:</p> <pre><code>    $ rm /etc/systemd/system/nginx.service\n</code></pre> <p>After remove thile file or directory you should reload the systemd process so that it no longer attempts to reference the file and reverts back to using the system copies. You can do this by using the <code>daemon-reload</code> command:</p> <pre><code>    $ systemctl daemon-reload\n</code></pre>"},{"location":"lpic2.206.3/#adjusting-the-system-start-runlevel-with-targets","title":"Adjusting the system start (runlevel) with targets","text":"<p>Targets are special unit files that describe a system state. Like other units the files that define targets can be identified by their suffix which in this case is <code>.target</code>. Targets don't do much themselves but ar used to group other units together.</p> <p>These targets can be used to bring the system to a certain state, much like other init systems use runlevels. They are used as a reference for when certain functions are available allowing you to specify the desired state instead of the individual units needed to produce the same state.</p> <p>For instance, there is a <code>swap.target</code> which is used to indicate that swap is ready for use. Units that are part of this process can sync with this target by indicating in their configuration files that they are wanted by or required by the <code>swap.target</code>. Unit that require swap to be available can specify this condition by using the wants, requires, and after properties to indicate the natur of their relationship.</p>"},{"location":"lpic2.206.3/#getting-and-setting-the-default-target","title":"Getting and setting the default target","text":"<p>Systemd has a default target that is used when booting the system. Satisfying the cascade of dependencies from that target will bring the system into the desired state. To get the default target of your system you can use the <code>get-default</code> command:</p> <pre><code>    $ sytemctl get-default\n\n    multi-user.target\n</code></pre> <p>If you want to set another target as the default you can use the <code>set-default</code> command. For example, if you want to use the graphical desktop as default you can change this with the following command:</p> <pre><code>    $ systemctl set-default graphical.target\n</code></pre>"},{"location":"lpic2.206.3/#listing-available-targets","title":"Listing available targets","text":"<p>You can get a list of the available targets using the <code>list-unit-files</code> command in combination with the <code>--type=target</code> filter:</p> <pre><code>    $ systemctl list-unit-files --type=target\n</code></pre> <p>Unlike with runlevels it's possible to have multiple targets active at the same time. An active target indicates that systemd has attempted to start all of the units tied to the target and has not tried to tear them down again. To see all active targets use the following command:</p> <pre><code>    $ systemctl list-units --type=target\n</code></pre>"},{"location":"lpic2.206.3/#isolating-targets","title":"Isolating targets","text":"<p>It's possible to start all the units that are associated with a target and to stop all units that are not part of the dependency tree. The command we can use for this is the <code>isolate</code> command. This is similar to changing the runlevel in other init systems.</p> <p>For example, if you are working in a graphical environment with graphical.target active, you can shutdown the graphical system by isolating the multi-user.target. Since multi-user.target is a dependency of graphical.target and not the other way around, the isolate command will stop all the graphical units.</p> <p>You may wish to take a look at the dependencies of the target you're isolating to make sure you don't stop any services that are vital to you:</p> <pre><code>    $ systemctl list-dependencies multi-user.target\n</code></pre> <p>When you're satisfied with the units that will be kept alive you can isolate the target:</p> <pre><code>    $ systemctl isolate multi-user.target\n</code></pre>"},{"location":"lpic2.206.3/#using-shortcuts-for-important-events","title":"Using shortcuts for important events","text":"<p>Some targets are defined for important events like powering off or rebooting. However <code>systemctl</code> also has some shortcuts that add a bit of additional functionality.</p> <p>For instance, to put the system into rescue (single-user in System V init terms) mode you can just use the <code>rescue</code> instead of <code>isolate rescue.target</code>:</p> <pre><code>    $ systemctl rescue\n</code></pre> <p>This command will also provide the additional functionallity of alerting all logged in users about the event in comparison with the isolate command. To halt the system you can use the <code>halt</code> command:</p> <pre><code>    $ systemctl halt\n</code></pre> <p>To initiate a full shutdown you can use the <code>poweroff</code> command:</p> <pre><code>    $ systemctl poweroff\n</code></pre> <p>To reboot the system you can use the <code>reboot</code> command:</p> <pre><code>    $ systemctl reboot\n</code></pre> <p>Not that most systems will link the shorter, more conventional, commands for these operations so they will work properly with systemd. For example, to reboot a system you can usually type:</p> <pre><code>    $ reboot\n</code></pre>"},{"location":"lpic2.207.0/","title":"Domain Name Server (207)","text":"<p>This topic has a weight of 8 points and contains the following objectives:</p>"},{"location":"lpic2.207.0/#objective-2071-basic-dns-server-configuration-3-points","title":"Objective 207.1; Basic DNS server configuration (3 points)","text":"<ul> <li>Candidates should be able to configure BIND to function as a     caching-only DNS server. This objective includes the ability to     convert older BIND configuration files to newer format, managing a     running server and configuring logging.</li> </ul>"},{"location":"lpic2.207.0/#objective-2072-create-and-maintain-dns-zones-3-points","title":"Objective 207.2; Create and maintain DNS Zones (3 points)","text":"<ul> <li>Candidates should be able to create a zone file for a forward or     reverse zone or root level server. This objective includes setting     appropriate values for records, adding hosts in zones and adding     zones to the DNS. A candidate should also be able to delegate zones     to another DNS server.</li> </ul>"},{"location":"lpic2.207.0/#objective-2073-securing-a-dns-server-2-points","title":"Objective 207.3; Securing a DNS server (2 points)","text":"<ul> <li> <p>Candidates should be able to configure a DNS server to run as a     non-root user and run in a chroot jail. This objective includes     secure exchange of data between DNS servers.</p> <p>Note The following chapters regarding DNS still mention the upgrade from BIND 8 to BIND 9. The LPIC-2 exam focuses on BIND 9, which is what you should focus on when studying for the LPIC-2 exam.</p> </li> </ul>"},{"location":"lpic2.207.1/","title":"Basic DNS server configuration (207.1)","text":""},{"location":"lpic2.207.1/#basic-dns-server-configuration-2071","title":"Basic DNS server configuration (207.1)","text":"<p>Candidates should be able to configure BIND to function as an authoritive and as a recursive, caching-only DNS server. This objective includes the ability to manage a running server and configure logging.</p>"},{"location":"lpic2.207.1/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>BIND 9.x configuration files, terms and utilities.</p> </li> <li> <p>Defining the location of the BIND zone files in BIND configuration     files.</p> </li> <li> <p>Reloading modified configuration and zone file.</p> </li> <li> <p>Awareness of dnsmasq, djbdns and PowerDNS as alternate name servers.</p> </li> </ul>"},{"location":"lpic2.207.1/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/etc/named.conf</code></p> </li> <li> <p><code>/var/named/</code></p> </li> <li> <p><code>/usr/sbin/rndc</code></p> </li> <li> <p><code>/usr/sbin/named-checkconf</code></p> </li> <li> <p><code>kill</code></p> </li> <li> <p><code>dig</code></p> </li> <li> <p><code>host</code></p> </li> </ul>"},{"location":"lpic2.207.1/#name-server-components-in-bind","title":"Name-server components in BIND","text":"<p>Name servers like BIND (Berkeley Internet Name Domain system) are part of a worldwide DNS system that resolves machine names to IP addresses.</p> <p>In the early days of the Internet, host name to IP address mappings were maintained by the Network Information Center (NIC) in a single file called <code>HOSTS.TXT</code>. This file was then distributed by FTP to other Internet connected hosts.</p> <p>Due to the vast amount of hosts being connected to the Internet over time, another name resolving system was developed known as Domain Names. This system incorporated design goals like distributed updates and local caching, to increase resolving performance. Because of these features, every nameserver needs to be specifically configured for it's purpose. The following terms are apparent when configuring nameserver software like BIND:</p> <p>Zones are the equivalent of domains. Zone configuration files consist of hostnames and IP address information. Nameserver software responds to requests on port <code>53</code>, and translates DNS (host- or domain-)names to IP addresses. It can also translate IP addresses into DNS names, this is called a \"reverse DNS lookup\" (rDNS). In order for rDNS to work, a so called pointer DNS record (PTR record) has to exist for the host being queried.</p> <p>We distinguish authoritive nameservers, recursive nameservers and so called resolvers. The authoritive nameserver for a zone is the nameserver which administrates the zone configuration. It is therefore sometimes also referred to as the zone master. A recursive nameserver is a nameserver that resolves zones for which it is not authoritive for at other nameservers. The resolver is the part of the nameserver and DNS client software which performs the actual queries. In general, these are libraries as part of DNS software.</p> <p>Table Major BIND components lists the most relevant parts of BIND software on a system. Note that directories may vary across distributions.</p> Component Description <code>/usr/sbin/named</code> the real name server <code>/usr/sbin/rndc</code> name daemon control program <code>/usr/sbin/named-checkconf</code> program to check named.conf file for errors <code>named.conf</code> BIND configuration file /etc/init.d/bind` distribution specific start script <code>/var/named</code> working directory for <code>named</code> <p>Resolving is controlled by the file <code>nsswitch.conf</code> which is mentioned in ???.</p> <p>BIND components will be discussed below.</p>"},{"location":"lpic2.207.1/#the-namedconf","title":"The <code>named.conf</code>","text":"<p>The file <code>named.conf</code> is the main configuration file of BIND. bindnamed.conf It is the first configuration file read by <code>named</code>, the DNS name daemon.</p>"},{"location":"lpic2.207.1/#location-of-namedconf","title":"Location of <code>named.conf</code>","text":"<p>According to LPI the location of the file <code>named.conf</code> is in the <code>/etc</code> directory. However, the location may vary across distributions. For example in the Debian Linux distribution <code>named.conf</code> is located in the <code>/etc/bind</code> directory.</p>"},{"location":"lpic2.207.1/#a-caching-only-name-server","title":"A caching-only name server","text":"<p>caching-only nameserver A caching-only name server resolves names, which are also stored in a cache, so that they can be accessed faster when the nameserver is asked to resolve these names again. But this is what every name server does. The difference is that this is the only task a caching-only name server performs. It does not serve out zones, except for a few internal ones.</p> <p>This is an example of a caching-only <code>named.conf</code> file. The version below is taken from the Debian bind package (some comments removed).</p> <pre><code>    options {\n            directory \"/var/named\";\n\n            // query-source address * port 53;\n\n            // forwarders {\n            //      0.0.0.0;\n            // };\n    };\n\n    // reduce log verbosity on issues outside our control\n    logging {\n            category lame-servers { null; };\n            category cname { null; };\n    };\n\n    // prime the server with knowledge of the root servers\n    zone \".\" {\n            type hint;\n            file \"/etc/bind/db.root\";\n    };\n\n    // be authoritative for the localhost forward and reverse zones, and for\n    // broadcast zones as per RFC 1912\n\n    zone \"localhost\" {\n            type master;\n            file \"/etc/bind/db.local\";\n    };\n\n    zone \"127.in-addr.arpa\" {\n            type master;\n            file \"/etc/bind/db.127\";\n    };\n\n    zone \"0.in-addr.arpa\" {\n            type master;\n            file \"/etc/bind/db.0\";\n    };\n\n    zone \"255.in-addr.arpa\" {\n            type master;\n            file \"/etc/bind/db.255\";\n    };\n\n    // add entries for other zones below here\n</code></pre> <p>The Debian bind package that contains this file, will provide a fully functional caching-only name server. BIND packages of other manufacturers will provide the same functionality.</p>"},{"location":"lpic2.207.1/#syntax","title":"Syntax","text":"<p>The <code>named.conf</code> file contains statements that start with a keyword plus an bind{ bind} opening curly brace \"{\" and end with a closing curly brace \"}\". A statement may contain other statements. The <code>forwarders</code> statement is an example of this. bindforwarders A statement may also contain IP addresses or the <code>file</code> word followed by a filename. These simple statements bindfile must be terminated by a semi-colon (<code>;</code>).</p> <p>All kinds of comments are allowed, e.g., <code>//</code> and <code>#</code> as end of line comments. See the bind// bind# named.conf 5 manual page for details.</p> <p>Note The \";\" is NOT valid as a comment sign in <code>named.conf</code>. However, it is a comment sign in BIND zone bind; files, like the file <code>/etc/bind/db.local</code> from the <code>named.conf</code> example above. An example BIND zone file can be found in ???</p>"},{"location":"lpic2.207.1/#the-options-statement","title":"The <code>options</code> statement","text":"<p>Of the many possible entries (see named.confbindoptions 5) inside an <code>options</code> statement, only <code>directory</code>, <code>forwarders</code>, <code>forward</code>, <code>version</code> and <code>dialup</code> will be discussed below.</p> <p>Note There can be only one <code>options</code> statement in a <code>named.conf</code> file.</p> <p><code>directory</code></p> <ul> <li> <p>Specifies the working directory for the name daemon. binddirectory A     common value is <code>/var/named</code>. Also, zone files without a directory     part are looked up in this directory.</p> <p>Recent distributions separate the configuration directory from the working directory. In a recent Debian Linux distribution, for example, the working directory is specified as <code>/var/cache/bind</code>, but all the configuration files can be found in <code>/etc/bind</code>. All zone files can also be found in the latter directory and must be specified with their directory part, as can be seen in the <code>named.conf</code> example above.</p> </li> </ul> <p><code>forwarders</code></p> <ul> <li> <p>The <code>forwarders</code> statement contains one or more IP addresses of name     servers to query. bindforwarders How these IP addresses are used is     specified by the <code>forward</code> statement described below.</p> <p>The default is no forwarders. Resolving is done through the worldwide (or company local) DNS system.</p> <p>Usually the specified name servers are the same the Service Provider uses.</p> </li> </ul> <p><code>forward</code></p> <ul> <li> <p>The <code>forward</code> works only when bindforward <code>forwarders</code> are     specified.</p> <p>Two values can be specified: <code>forward first;</code> (default) and <code>forward only;</code>. With <code>forward first</code>, the query is sent first to the bindforward first; bindforward only; specified name-server IP addresses and if this fails it should perform lookups elsewhere. With <code>forward only</code>, queries are limited only to the specified name-server IP addresses.</p> <p>An example with both <code>forwarders</code> and <code>forward</code>:</p> <pre><code>    options {\n        // ...\n\n        forwarders {\n            123.12.134.2;\n            123.12.134.3;\n        }\n\n        forward only;\n\n        // ...\n    };\n</code></pre> <p>In this example bind is told to query only the name servers <code>123.12.134.2</code> and <code>123.12.134.3</code>.</p> </li> </ul> <p><code>version</code></p> <ul> <li> <p>It is possible to query the version from a running name server:     bindversion</p> <pre><code>    $ dig @ns12.zoneedit.com version.bind chaos txt\n\n    ; &lt;&lt;&gt;&gt; DiG 9.8.3-P1 &lt;&lt;&gt;&gt; @ns12.zoneedit.com version.bind chaos txt\n    ; (1 server found)\n    ;; global options: +cmd\n    ;; Got answer:\n    ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 59790\n    ;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0\n    ;; WARNING: recursion requested but not available\n\n    ;; QUESTION SECTION:\n    ;version.bind.          CH  TXT\n\n    ;; ANSWER SECTION:\n    VERSION.BIND.       0   CH  TXT \"8.4.X\"\n\n    ;; Query time: 169 msec\n    ;; SERVER: 209.62.64.46#53(209.62.64.46)\n    ;; WHEN: Tue Jun 25 11:38:48 2013\n    ;; MSG SIZE  rcvd: 60\n</code></pre> <p>Note that the BIND version is shown in the output. Because some BIND versions have known exploits, the BIND version is sometimes kept hidden. The <code>version</code> specification:</p> <pre><code>    version \"not revealed\";\n</code></pre> <p>or</p> <pre><code>    version none;\n</code></pre> <p>inside the <code>options</code> statement leads to <code>not revealed</code> responses on version queries.</p> </li> </ul> <p><code>dialup</code></p> <ul> <li> <p>When a name server sits behind a firewall, that connects to the     binddialup outside world through a dialup connection, some     maintenance normally done by name servers might be unwanted.     Examples of unwanted actions are: sending heartbeat packets, zone     transfers with a nameserver on the other side of the firewall.</p> <p>The following example, also inside the <code>options</code> part, stops external zone maintenance:</p> <pre><code>    heartbeat-interval 0;\n    dialup yes; // NOTE: This actually *stops* dialups!\n</code></pre> </li> </ul> <p>Many more options can be placed inside the options block. Refer to the manual pages for details.</p> <p>Depending on the distribution used, a seperate <code>bind.conf.options</code> file might be used which holds all the options for the BIND configuration. The main configuration file <code>named.conf</code> has to include this separate file though, which can be accomplished by adding the following line to <code>named.conf</code>:</p> <pre><code>    include \"/etc/bind/named.conf.options\";\n</code></pre> <p>Other separate configuration files like <code>named.conf.log</code> or <code>named.conf.default-zones</code> may be nested this way as well.</p>"},{"location":"lpic2.207.1/#the-logging-statement","title":"The <code>logging</code> statement","text":"<p>The BIND (version 8 and 9) logging system is too elaborate to discuss in detail here. An important difference between the two has to do with parsing the log configuration. BIND 8 used to parse the <code>logging</code> statement and start the logging configuration right away. BIND 9 only establishes the logging configuration after the entire configuration file has been parsed. While starting up, the server sends all logging messages regarding syntax errors in the configuration file to the default channels. These errors may be redirected to standard error output if the <code>-g</code> option has been given during startup.</p> <p>The distinction between categories and bindcategory channels is an important part of logging.</p> <p>A channel is an output specification. The <code>null</code> channel, for example, dismisses any output sent to the channel.</p> <p>A category is a type of data. The category <code>security</code> is one of many categories. To log messages of type (category) <code>security</code>, for example, to the <code>default_syslog</code> channel, use the following:</p> <pre><code>    logging {\n        category security { default_syslog; };\n        // ...\n    };\n</code></pre> <p>To turn off logging for certain types of data, send it to the <code>null</code> channel, as is done in the example <code>named.conf</code> shown earlier:</p> <pre><code>    logging {\n            category lame-servers { null; };\n            category cname { null; };\n    };\n</code></pre> <p>This means that messages of types <code>lame-servers</code> and <code>cname</code> are being discarded.</p> <p>There are reasonable defaults for logging. This means that a <code>named.conf</code> without <code>logging</code> statement is possible.</p> <p>Note A maximum of one <code>logging</code> statement is allowed in a <code>named.conf</code> file.</p>"},{"location":"lpic2.207.1/#predefined-zone-statements","title":"Predefined <code>zone</code> statements","text":"<p>A zone defined in <code>named.conf</code> can be referred to using the \"@\" symbol inside the corresponding zone file. bind@ The \"@\" is called the current origin. For example,</p> <pre><code>    zone \"127.in-addr.arpa\" {\n            type master;\n            file \"/etc/bind/db.127\";\n    };\n</code></pre> <p>will result in a current origin of <code>127.in-addr.arpa</code> that is available as \"@\" in file <code>/etc/bind/db.127</code>.</p> <p>Details about zone files, as well as how to create your bindzone file own <code>zone</code> files and statements will be covered in ???.</p> <p>The <code>named</code> name server daemon</p> <p>The <code>named</code> name server daemon is the program that communicates with other name servers to resolve names. It accepts queries, looks in its cache and queries other name servers if it does not yet have the answer. Once it finds an answer in its own cache or database or receives an answer from another nameserver, it sends the answer back to the name server that sent the query in the first place.</p> <p>Table table_title lists ways to control the <code>named</code> name server.</p> <p>Method                      See</p> <p>The <code>rndc</code> program          The program   Sending signals             Sending signals to    Using a start/stop script   Controlling with a start/stop script</p> <p>: Controlling <code>named</code></p> <p>The <code>rndc</code> program {#rndc}</p> <p>The <code>rndc</code> (Remote Name Daemon Control) program rndc can be used to control the <code>named</code> name server daemon, locally as well as remotely. It requires a <code>/etc/rndc.key</code> file which contains a key.</p> <pre><code>    key \"rndc-key\" {\n        algorithm hmac-md5;\n        secret \"tyZqsLtPHCNna5SFBLT0Eg==\";\n    };\n\n    options {\n        default-key \"rndc-key\";\n        default-server 127.0.0.1;\n        default-port 953;\n    };\n</code></pre> <p>The name server configuration file <code>/etc/named.conf</code> needs to contain the same key to allow a host to control the name server. The relevant part of that file is shown below.</p> <pre><code>    key \"rndc-key\" {\n        algorithm hmac-md5;\n        secret \"tyZqsLtPHCNna5SFBLT0Eg==\";\n    };\n\n    controls {\n        inet 127.0.0.1 port 953\n            allow { 127.0.0.1; } keys { \"rndc-key\"; };\n    };\n</code></pre> <p>The secret itself will never be transmitted over the network. Both ends calculate a hash using the algorithm declared after the <code>algorithm</code> keyword and compare hashes.</p> <p>Depending on the distribution used, the configuration files might also be stored in <code>/etc/bind/*</code>. The <code>rndc.key</code> file should be owned by root:bind and have a mode of 640. The main bind configuration file, <code>named.conf</code> should have a line that includes the keyfile. Running the program <code>rndc-confgen</code> will create a key in case none is available on the system.</p> <p>A command to the name server can be given as a parameter to rndc, e.g.: <code>rndc reload</code>. This will request the name server to reload its configuration and zone files. All commands specified in this way are understood by the name daemon. The help command presents a list of commands understood by the name server.</p> <p>While not discussed here <code>rndc</code> may be used to manage several name servers remotely. Consult the man pages and the \\\"BIND 9 Administrator Reference Manual\\\" for more information on rndc and BIND.</p> <p>The <code>named-checkconf</code> utility {#named-checkconf}</p> <p><code>named-checkconf</code> is a very useful utility that checks the <code>named.conf</code> file for errors. If the <code>named.conf</code> file is located in the regular <code>/etc/named.conf</code> location on your distribution you only have to type in the command to check the file.</p> <pre><code>    # named-checkconf\n</code></pre> <p>The location of the named.conf file can be different however (depending on the distribution you are using). In some cases for example the file is located at <code>/etc/bind/named.conf</code>. The <code>named-checkconf</code> utility wil not automatically recognize locations other than <code>/etc/named.conf</code> in these cases you will have to include path and filename after the command.</p> <pre><code>    # named-checkconf /etc/bind/named.conf\n</code></pre> <p>When the prompt returns without giving any messages it means that <code>named-checkconf</code> didn't find anything wrong with it. The example below will show what happens when it dit find something wrong. In this case I made an error by forgetting to add the letter <code>i</code> on an <code>include</code> statement.</p> <pre><code>    [root@localhost etc]# named-checkconf\n    /etc/named.conf:56: unknown option 'nclude'\n</code></pre> <p>The <code>named-checkconf</code> utility will only check the <code>named.conf</code> file. Other configuration files called from within the <code>named.conf</code> file using for example the <code>include</code> statement will not be checked automatically. It it possible to check them manually by adding their path and file name when executing the <code>named.checkconf</code> utility.</p> <p>Sending signals to <code>named</code> {#namedsigs}</p> <p>kill It is possible to send signals to the <code>named</code> process to control its behaviour. A full list of signals can be found in the <code>named</code> manpage. One example is the bindSIGHUP <code>SIGHUP</code> signal, that causes <code>named</code> to reload <code>named.conf</code> and the database files.</p> <p>Signals are sent to named with the kill command, e.g.,</p> <pre><code>    kill -HUP 217\n</code></pre> <p>This sends a <code>SIGHUP</code> signal to a <code>named</code> process with process id <code>217</code>, which triggers a reload.</p> <p>Controlling <code>named</code> with a start/stop script {#namedstartstop}</p> <p>Most distributions will come with a start/stop script that allows you to bindstart bindstop bindreload start, stop or control <code>named</code> manually, e.g., <code>/etc/init.d/bind</code> in Debian or <code>/etc/init.d/named</code> in Red Hat.</p> <p>Note Red Hat (based) systems have the <code>service</code> command which can be used instead. <code>service</code> uses the same set of parameters, so you might, for example, say:</p> <pre><code>    # service named reload\n</code></pre> <p>Table table_title lists parameters which a current version of <code>/etc/init.d/bind</code> accepts.</p> <p>Parameter        Description</p> <p><code>start</code>          starts <code>named</code> <code>stop</code>           stops <code>named</code> <code>restart</code>        stops and restarts <code>named</code> <code>reload</code>         reloads configuration   <code>force-reload</code>   same as <code>restart</code></p> <p>: <code>/etc/init.d/bind</code> parameters</p> <p>dnsmasq {#alternatedns}</p> <p><code>dnsmasq</code> is both a lightweight DNS forwarder and DHCP server. <code>dnsmasq</code> supports static and dynamic DHCP leases and supports BOOTP/TFTP/PXE network boot protocols.</p> <pre><code>    $ apt-cache search dnsmasq\n    dnsmasq - Small caching DNS proxy and DHCP/TFTP server\n    dnsmasq-base - Small caching DNS proxy and DHCP/TFTP server\n    dnsmasq-utils - Utilities for manipulating DHCP leases\n</code></pre>"},{"location":"lpic2.207.1/#djbdns","title":"djbdns","text":"<p><code>djbdns</code> - Daniel J. Bernstein DNS - was build due to frustrations with repeated BIND security holes. Besides holding a DNS cache, DNS server and DNS client <code>djbdns</code> also includes several DNS debugging tools. The source code was released into the public domain in 2007. There have been several forks, one of which is <code>dbndns</code>, the fork of the Debian Project.</p>"},{"location":"lpic2.207.1/#powerdns","title":"PowerDNS","text":"<p>PowerDNS is a Dutch supplier of DNS software and services. The PowerDNS software is open source (GPL), and comes packaged with many distributions as <code>pdns</code>, <code>powerdns-server</code> or <code>pdns-server</code>. The system allows multiple backends to allow access to DNS configuration data, including a simple backend that accepts BIND style files.</p> <pre><code>    $ apt-cache search pdns\n    pdns-backend-geo - geo backend for PowerDNS\n    pdns-backend-ldap - LDAP backend for PowerDNS\n    pdns-backend-lua - lua backend for PowerDNS\n    pdns-backend-mysql - generic MySQL backend for PowerDNS\n    pdns-backend-pgsql - generic PostgreSQL backend for PowerDNS\n    pdns-backend-pipe - pipe/coprocess backend for PowerDNS\n    pdns-backend-sqlite - sqlite backend for PowerDNS\n    pdns-backend-sqlite3 - sqlite backend for PowerDNS\n    pdns-server - extremely powerful and versatile nameserver\n    pdns-server-dbg - debugging symbols for PowerDNS\n    pdns-recursor - PowerDNS recursor\n    pdns-recursor-dbg - debugging symbols for PowerDNS recursor\n    pdnsd - Proxy DNS Server\n</code></pre>"},{"location":"lpic2.207.1/#the-dig-and-host-utilities","title":"The <code>dig</code> and <code>host</code> utilities","text":"<p>The Internet Systems Consortium (ICS) has deprecated <code>nslookup</code> in favor of <code>host</code> and <code>dig</code>. However, <code>nslookup</code> is still widely used due to longevity of older Unix releases. It remains part of most Linux distributions too.</p> <p>Both <code>dig</code> and <code>host</code> commands can be used to query nameservers, it's a matter of preference which one to use for which occasion. <code>dig</code> has far more options and provides a more elaborate output by default. The <code>help</code> for both commands should give some insights in the differences:</p> <pre><code>    $ host\n    Usage: host [-aCdlriTwv] [-c class] [-N ndots] [-t type] [-W time]\n                [-R number] [-m flag] hostname [server]\n           -a is equivalent to -v -t ANY\n           -c specifies query class for non-IN data\n           -C compares SOA records on authoritative nameservers\n           -d is equivalent to -v\n           -l lists all hosts in a domain, using AXFR\n           -i IP6.INT reverse lookups\n           -N changes the number of dots allowed before root lookup is done\n           -r disables recursive processing\n           -R specifies number of retries for UDP packets\n           -s a SERVFAIL response should stop query\n           -t specifies the query type\n           -T enables TCP/IP mode\n           -v enables verbose output\n           -w specifies to wait forever for a reply\n           -W specifies how long to wait for a reply\n           -4 use IPv4 query transport only\n           -6 use IPv6 query transport only\n           -m set memory debugging flag (trace|record|usage)\n\n\n    $ dig -h\n    Usage:  dig [@global-server] [domain] [q-type] [q-class] {q-opt}\n                {global-d-opt} host [@local-server] {local-d-opt}\n                [ host [@local-server] {local-d-opt} [...]]\n    Where:  domain    is in the Domain Name System\n            q-class  is one of (in,hs,ch,...) [default: in]\n            q-type   is one of (a,any,mx,ns,soa,hinfo,axfr,txt,...) [default:a]\n                     (Use ixfr=version for type ixfr)\n            q-opt    is one of:\n                     -x dot-notation     (shortcut for reverse lookups)\n                     -i                  (use IP6.INT for IPv6 reverse lookups)\n                     -f filename         (batch mode)\n                     -b address[#port]   (bind to source address/port)\n                     -p port             (specify port number)\n                     -q name             (specify query name)\n                     -t type             (specify query type)\n                     -c class            (specify query class)\n                     -k keyfile          (specify tsig key file)\n                     -y [hmac:]name:key  (specify named base64 tsig key)\n                     -4                  (use IPv4 query transport only)\n                     -6                  (use IPv6 query transport only)\n                     -m                  (enable memory usage debugging)\n            d-opt    is of the form +keyword[=value], where keyword is:\n                     +[no]vc             (TCP mode)\n                     +[no]tcp            (TCP mode, alternate syntax)\n                     +time=###             (Set query timeout) [5]\n                     +tries=###            (Set number of UDP attempts) [3]\n                     +retry=###            (Set number of UDP retries) [2]\n                     +domain=###           (Set default domainname)\n                     +bufsize=###          (Set EDNS0 Max UDP packet size)\n                     +ndots=###            (Set NDOTS value)\n                     +edns=###             (Set EDNS version)\n                     +[no]search         (Set whether to use searchlist)\n                     +[no]showsearch     (Search with intermediate results)\n                     +[no]defname        (Ditto)\n                     +[no]recurse        (Recursive mode)\n                     +[no]ignore         (Don't revert to TCP for TC responses.)\n                     +[no]fail           (Don't try next server on SERVFAIL)\n                     +[no]besteffort     (Try to parse even illegal messages)\n                     +[no]aaonly         (Set AA flag in query (+[no]aaflag))\n                     +[no]adflag         (Set AD flag in query)\n                     +[no]cdflag         (Set CD flag in query)\n                     +[no]cl             (Control display of class in records)\n                     +[no]cmd            (Control display of command line)\n                     +[no]comments       (Control display of comment lines)\n                     +[no]question       (Control display of question)\n                     +[no]answer         (Control display of answer)\n                     +[no]authority      (Control display of authority)\n                     +[no]additional     (Control display of additional)\n                     +[no]stats          (Control display of statistics)\n                     +[no]short          (Disable everything except short\n                                          form of answer)\n                     +[no]ttlid          (Control display of ttls in records)\n                     +[no]all            (Set or clear all display flags)\n                     +[no]qr             (Print question before sending)\n                     +[no]nssearch       (Search all authoritative nameservers)\n                     +[no]identify       (ID responders in short answers)\n                     +[no]trace          (Trace delegation down from root)\n                     +[no]dnssec         (Request DNSSEC records)\n                     +[no]nsid           (Request Name Server ID)\n                     +[no]sigchase       (Chase DNSSEC signatures)\n                     +trusted-key=####    (Trusted Key when chasing DNSSEC sigs)\n                     +[no]topdown        (Do DNSSEC validation top down mode)\n                     +[no]multiline      (Print records in an expanded format)\n                     +[no]onesoa         (AXFR prints only one soa record)\n            global d-opts and servers (before host name) affect all queries.\n            local d-opts and servers (after host name) affect only that lookup.\n            -h                           (print help and exit)\n            -v                           (print version and exit)\n</code></pre> <p>As demonstrated, the <code>dig</code> command provides the broader range of options. Without options though, the provided information is quite similar:</p> <pre><code>    $ host zonetransfer.me\n    zonetransfer.me has address 217.147.180.162\n    zonetransfer.me mail is handled by 20 ASPMX2.GOOGLEMAIL.COM.\n    zonetransfer.me mail is handled by 20 ASPMX3.GOOGLEMAIL.COM.\n    zonetransfer.me mail is handled by 20 ASPMX4.GOOGLEMAIL.COM.\n    zonetransfer.me mail is handled by 20 ASPMX5.GOOGLEMAIL.COM.\n    zonetransfer.me mail is handled by 0 ASPMX.L.GOOGLE.COM.\n    zonetransfer.me mail is handled by 10 ALT1.ASPMX.L.GOOGLE.COM.\n    zonetransfer.me mail is handled by 10 ALT2.ASPMX.L.GOOGLE.COM.\n\n\n    $ dig zonetransfer.me\n\n    ; &lt;&lt;&gt;&gt; DiG 9.8.4-rpz2+rl005.12-P1 &lt;&lt;&gt;&gt; zonetransfer.me\n    ;; global options: +cmd\n    ;; Got answer:\n    ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 31395\n    ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 1\n\n    ;; QUESTION SECTION:\n    ;zonetransfer.me.       IN  A\n\n    ;; ANSWER SECTION:\n    zonetransfer.me.    7193    IN  A   217.147.180.162\n\n    ;; AUTHORITY SECTION:\n    zonetransfer.me.    7193    IN  NS  ns12.zoneedit.com.\n    zonetransfer.me.    7193    IN  NS  ns16.zoneedit.com.\n\n    ;; ADDITIONAL SECTION:\n    ns12.zoneedit.com.  1077    IN  A   209.62.64.46\n\n    ;; Query time: 6 msec\n    ;; SERVER: 213.154.248.156#53(213.154.248.156)\n    ;; WHEN: Thu Jun 27 07:30:36 2013\n    ;; MSG SIZE  rcvd: 115\n</code></pre> <p><code>$</code> <code>man dig</code></p> <pre><code>    NAME\n           dig - DNS lookup utility\n\n    SYNOPSIS\n           dig [@server] [-b address] [-c class] [-f filename] [-k filename] [-m] [-p port#]\n               [-q name] [-t type] [-x addr] [-y [hmac:]name:key] [-4] [-6] [name] [type]\n               [class] [queryopt...]\n</code></pre> <p>An important option is <code>-t</code> to query for example only the MX or NS records. This option works for <code>dig</code> and <code>host</code>. (Look at the man pages of both commands for the explanation of the other options.)</p> <pre><code>    $ dig sue.nl\n\n    ; &lt;&lt;&gt;&gt; DiG 9.8.3-P1 &lt;&lt;&gt;&gt; sue.nl\n    ;; global options: +cmd\n    ;; Got answer:\n    ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 60605\n    ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0\n\n    ;; QUESTION SECTION:\n    ;sue.nl.            IN  A\n\n    ;; ANSWER SECTION:\n    sue.nl.     299 IN  A   213.154.248.202\n\n    ;; Query time: 52 msec\n    ;; SERVER: 8.8.8.8#53(8.8.8.8)\n    ;; WHEN: Tue Oct 20 09:55:13 2015\n    ;; MSG SIZE  rcvd: 41\n\n\n    $ dig -t NS sue.nl\n\n    ; &lt;&lt;&gt;&gt; DiG 9.8.3-P1 &lt;&lt;&gt;&gt; -t NS sue.nl\n    ;; global options: +cmd\n    ;; Got answer:\n    ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 26099\n    ;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 0\n\n    ;; QUESTION SECTION:\n    ;sue.nl.            IN  NS\n\n    ;; ANSWER SECTION:\n    sue.nl.     20361   IN  NS  ns1.transip.nl.\n    sue.nl.     20361   IN  NS  ns2.transip.eu.\n    sue.nl.     20361   IN  NS  ns0.transip.net.\n\n    ;; Query time: 59 msec\n    ;; SERVER: 8.8.8.8#53(8.8.8.8)\n    ;; WHEN: Tue Oct 20 10:00:24 2015\n    ;; MSG SIZE  rcvd: 108\n\n\n    $ dig -t MX sue.nl\n\n    ; &lt;&lt;&gt;&gt; DiG 9.8.3-P1 &lt;&lt;&gt;&gt; -t MX sue.nl\n    ;; global options: +cmd\n    ;; Got answer:\n    ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 36671\n    ;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 0\n\n    ;; QUESTION SECTION:\n    ;sue.nl.            IN  MX\n\n    ;; ANSWER SECTION:\n    sue.nl.     299 IN  MX  10 mc.sue.nl.\n    sue.nl.     299 IN  MX  20 mx1.sue.nl.\n\n    ;; Query time: 61 msec\n    ;; SERVER: 8.8.8.8#53(8.8.8.8)\n    ;; WHEN: Tue Oct 20 10:02:01 2015\n    ;; MSG SIZE  rcvd: 64\n</code></pre>"},{"location":"lpic2.207.2/","title":"Create and maintain DNS zones (207.2)","text":""},{"location":"lpic2.207.2/#create-and-maintain-dns-zones-2072","title":"Create and maintain DNS zones (207.2)","text":"<p>Candidates should be able to create a zone file for a forward or reverse zone and hints for root level servers. This objective includes setting appropriate values for records, adding hosts in zones and adding zones to the DNS. A candidate should also be able to delegate zones to another DNS server.</p>"},{"location":"lpic2.207.2/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>BIND 9 configuration files, terms and utilities</p> </li> <li> <p>Utilities to request information from the DNS server</p> </li> <li> <p>Layout, content and file location of the BIND zone files</p> </li> <li> <p>Various methods to add a new host in the zone files, including     reverse zones</p> </li> </ul>"},{"location":"lpic2.207.2/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/var/named/*</code></p> </li> <li> <p>zone file syntax</p> </li> <li> <p>resource record formats</p> </li> <li> <p><code>named-checkzone</code></p> </li> <li> <p><code>named-compilezone</code></p> </li> <li> <p><code>masterfile-format</code></p> </li> <li> <p><code>dig</code></p> </li> <li> <p><code>nslookup</code></p> </li> <li> <p><code>host</code></p> </li> </ul>"},{"location":"lpic2.207.2/#zones-and-reverse-zones","title":"Zones and reverse zones","text":"<p>There are zones and reverse zone reverse zone zones. Each <code>named.conf</code> will contain definitions for both.</p> <p>Examples of zones are <code>localhost</code> (used internally) and <code>example.com</code> (an external example which does not necessarily exist in reality). Examples of reverse zones are <code>127.in-addr.arpa</code> (used internally), and <code>240.123.224.in-addr.arpa</code> (a real-world example).</p> <p>How zones are related to reverse zones is shown below.</p>"},{"location":"lpic2.207.2/#db.local-file","title":"The <code>db.local</code> file","text":"<p>A special domain, <code>localhost</code>, will be predefined in most cases.</p> <p>Here is the corresponding zone file <code>/etc/bind/db.local</code> called from the example <code>named.conf</code> shown earlier in this chapter.</p> <pre><code>    ;\n    ; BIND data file for local loopback interface\n    ;\n    $TTL    604800\n    @   IN  SOA localhost. root.localhost. (\n                  1     ; Serial\n             604800     ; Refresh\n              86400     ; Retry\n            2419200     ; Expire\n             604800 )   ; Negative Cache TTL\n    ;\n    @   IN  NS      localhost.\n    @   IN  A       127.0.0.1\n</code></pre> <p>The <code>@</code> contains the name of the zone. It is called bind@ the current origin. A <code>zone</code> statement in <code>named.conf</code> defines that current origin, as is seen in this part of the named.conf file we saw earlier:</p> <pre><code>    zone \"localhost\" {\n            type master;\n            file \"/etc/bind/db.local\";\n    };\n</code></pre> <p>So in this case the zone is called <code>localhost</code> and all current origins in the zone file will become bindlocalhost <code>localhost</code>.</p> <p>Other parts of a zone file will be explained in Zone files below.</p>"},{"location":"lpic2.207.2/#the-db127-file","title":"The <code>db.127</code> file","text":"<p>To each IP range in a zone file, there is a corresponding binddb.127 reverse zone that is described in a reverse zone file. Here is the file <code>/etc/bind/db.127</code>:</p> <pre><code>    ;\n    ; BIND reverse data file for local loopback interface\n    ;\n    $TTL    604800\n    @   IN  SOA localhost. root.localhost. (\n                  1     ; Serial\n             604800     ; Refresh\n              86400     ; Retry\n            2419200     ; Expire\n             604800 )   ; Negative Cache TTL\n    ;\n    @       IN  NS      localhost.\n    1.0.0   IN  PTR     localhost.\n</code></pre> <p>This is the calling part from <code>named.conf</code>:</p> <pre><code>    zone \"127.in-addr.arpa\" {\n            type master;\n            file \"/etc/bind/db.127\";\n    };\n</code></pre> <p>As can be seen, the current origin will be <code>127.in-addr.arpa</code>, so all <code>@</code>'s in the reverse zone file will be replaced by <code>127.in-addr.arpa</code>.</p> <p>But there is more: all host names that do not end in a dot get the current origin appended. This is important, so I repeat:</p> <p>all host names that do not end in a dot get the current origin appended. bindcurrent origin</p> <p>As an example: <code>1.0.0</code> will become <code>1.0.0.127.in-addr.arpa</code>.</p> <p>Normal IP addresses (e.g. 127.0.0.1) do not get the current origin appended.</p> <p>Again, details about the reverse zone file will be discussed below.</p>"},{"location":"lpic2.207.2/#the-hints-file","title":"The hints file","text":"<p>The <code>localhost</code> and <code>127.in-addr.arpa</code> zones are for internal use within a system.</p> <p>In the outside world, zones are hierarchically organized. The root zone (denoted with a dot: <code>.</code>) is listed in bindhint a special hints file. The following zone statement from <code>named.conf</code> reads a root zone file called <code>/etc/bind/db.root</code></p> <pre><code>    zone \".\" {\n        type hint;\n        file \"/etc/bind/db.root\";\n    };\n</code></pre> <p>By the way, note the type: <code>hint</code>! It is a special type for the root zone. Nothing else is stored in this file, and it is not updated dynamically.</p> <p>Here is a part from the <code>db.root</code> file.</p> <pre><code>    ; formerly NS.INTERNIC.NET\n    ;\n    .                        3600000  IN  NS    A.ROOT-SERVERS.NET.\n    A.ROOT-SERVERS.NET.      3600000      A     198.41.0.4\n    ;\n    ; formerly NS1.ISI.EDU\n    ;\n    .                        3600000      NS    B.ROOT-SERVERS.NET.\n    B.ROOT-SERVERS.NET.      3600000      A     128.9.0.107\n</code></pre> <p>Note the dot at the left, this is the root zone!</p> <p>Either your distribution or you personally must keep the root zone file current. You can look at <code>ftp.rs.internic.net</code> for a new version. Or, you could run something like</p> <pre><code>    dig @a.root-servers.net . ns &gt; roothints\n</code></pre> <p>This will create a new file.</p> <p>You can also run</p> <pre><code>    dig @a.root-servers.net . SOA\n</code></pre> <p>You can do this periodically to see if the SOA version number (see below) has changed.</p>"},{"location":"lpic2.207.2/#zone-files","title":"Zone files","text":"<p>The root zone knows about all top-level domains directly under it, e.g. the <code>edu</code> and <code>org</code> domains as well as the country-specific domains like <code>uk</code> and <code>nl</code>.</p> <p>If the <code>example.org</code> domain (used here for illustration purposes) were a real domain, it would not be handled by the root name servers. Instead, the nameservers for the <code>org</code> domain would know all about it. This is called delegation: the root name servers have delegated authority for zones under <code>org</code> to the name servers for the <code>org</code> zone. Doing delegation yourself will be explained later in Delegating a DNS zone.</p> <p>A zone file is read from the <code>named.conf</code> file with a zone statement like</p> <pre><code>    zone \"example.org\" IN {\n        type master;\n        file \"/etc/bind/exampleorg.zone\";\n    };\n</code></pre> <p>This is an example zone file for the zone <code>example.org</code>.</p> <pre><code>    $TTL 86400\n    @      IN  SOA lion.example.org. dnsmaster.lion.example.org. (\n               2001110700    ; Ser: yyyymmhhee (ee: ser/day start 00)\n                    28800    ; Refresh\n                     3600    ; Retry\n                   604800    ; Expiration\n                    86400 )  ; Negative caching\n           IN  NS       lion.example.org.\n           IN  NS       cat.example.org.\n\n           IN  MX   0   lion.example.org.\n           IN  MX  10   cat.example.org.\n\n    lion   IN   A       224.123.240.1\n           IN  MX   0   lion.example.org.\n           IN  MX  10   cat.example.org.\n\n    doggy  IN   A       224.123.240.2\n    cat    IN   A       224.123.240.3\n\n    ; our laptop\n    bird   IN   A       224.123.240.4\n</code></pre> <p>Let's examine this file in detail.</p>"},{"location":"lpic2.207.2/#the-ttl-statement","title":"The <code>$TTL</code> statement","text":"<p>The <code>$TTL</code> is the default Time To Live for the zone. When a name server requests information about this zone, it also gets the TTL. After the TTL is expired, it should renew the data in the cache.</p> <pre><code>    $TTL 3h\n</code></pre> <p>This sets the default TTL to 3 hours, and</p> <pre><code>    $TTL 86400\n</code></pre> <p>this one to 86400 seconds (same as <code>1d</code> (1 day)).</p> <p>Note Since BIND version 8.2 each zone file should start with a default TTL. A default value is substituted and a warning generated if the TTL is omitted. The change is defined in RFC2308.</p> <p>At the same time, the last SOA time field changed meaning. Now it is the negative caching value, which is explained below.</p>"},{"location":"lpic2.207.2/#the-soa-resource-record","title":"The <code>SOA</code> resource record","text":"<p>The acronym SOA means Start Of Authority. It tells the outside world that this name server is the authoritative name server to query about this domain. The SOA record should contain the administrator contact address as well as a time-out setting for slave nameservers. Declaring a SOA record serves two aspects: first, the parent zone <code>org</code> has delegated (granted) the use of the <code>example.org</code> domain to us, the second is that we claim to be the authority over this zone.</p> <p>The SOA record is mandatory for every DNS zone file, and should be the first specified Resource Record (RR) of a zone file as well.</p> <p>Earlier we saw the following <code>SOA</code> record:</p> <pre><code>    @  IN  SOA lion.example.org. dnsmaster.lion.example.org. (\n           2001110700    ; Ser: yyyymmhhee (ee: ser/day start 00)\n                28800    ; Refresh\n                 3600    ; Retry\n               604800    ; Expiration\n                 3600 )  ; Negative caching\n</code></pre> <p>Elements of these <code>SOA</code> lines are</p> <p><code>@</code></p> <ul> <li>the current origin, which expands to <code>example.org</code> (see the     named.conf file).</li> </ul> <p><code>IN</code></p> <ul> <li>the Internet data class. From rfc4343: \\\"As described in [STD13]     and [RFC2929], DNS has an additional axis for data location called     CLASS. The only CLASS in global use at this time is the \\\"IN\\\"     (Internet) CLASS.\\\"</li> </ul> <p><code>SOA</code></p> <ul> <li>start of authority - that's what this section is about.</li> </ul> <p><code>lion.example.org.</code></p> <ul> <li>the name of the machine that has the master (see Master and slave     servers) name server for this domain.</li> </ul> <p>dnsmaster.lion.example.org.</p> <ul> <li>The email address of the person to mail in case of trouble, with the     commercial at symbol (<code>@</code>) normally in the email address replaced by     a dot. Uncovering the reason for this is left as an exercise for the     reader (something with current origin .....?)</li> </ul> <p><code>(</code>five numbers<code>)</code></p> <ul> <li> <ul> <li> <p>The first number is the serial number. For a zone definition         that never changes (e.g., the <code>localhost</code> zone) a single <code>1</code> is         enough.</p> <p>For zones that do change, however, another format is rather common: yyyymmddee. That is, 4 digits for the year, two for the month, two for the day, plus two digits that start with <code>00</code> and are incremented every time something is changed. For example a serial number of</p> <pre><code>    2001110701\n</code></pre> <p>corresponds to the second (!) change on the 7<sup>th</sup> of November in the year 2001. The next day, the first change will get the serial number <code>2001110800</code>.</p> <p>Note Each time something is changed in a zone definition, the serial number must grow (by at least one). If the serial number does not grow, changes in the zone will go unnoticed. :::</p> </li> <li> <p>The second number is the refresh rate. This is how frequently a     slave server (see below) should check to see whether data has     been changed.</p> <p>Suggested value in rfc1537: <code>24h</code></p> </li> <li> <p>The third number is the retry value. This is the time a slave     server must wait before it can retry after a refresh or failure,     or between retries.</p> <p>Suggested value in rfc1537: <code>2h</code></p> </li> <li> <p>The fourth number is the expiration value. If a slave server     cannot contact the master server to refresh the information, the     zone information expires and the slave server will stop serving     data for this zone.</p> <p>Suggested value in rfc1537: <code>30d</code></p> </li> <li> <p>The fifth number is the negative caching value TTL. Negative     caching means that a DNS server remembers that it could not     resolve a specific domain. The number is the time that this     memory is kept.</p> <p>Reasonable value: <code>1h (3600s)</code></p> </li> </ul> </li> </ul>"},{"location":"lpic2.207.2/#the-a-resource-record","title":"The <code>A</code> resource record","text":"<p>The <code>A</code> record is the address record. It connects an IP address to a hostname. An example record is</p> <pre><code>    lion   IN   A       224.123.240.1\n</code></pre> <p>This connects the name <code>lion.example.org</code> (remember that the current origin <code>example.org</code> is added to any name that does not end in a dot) to the IP address <code>224.123.240.1</code>.</p> <p>Note Each <code>A</code> record should have a corresponding <code>PTR</code> record. This is described in Reverse zone files.</p> <p>The A record is used by IPv4, the current version of the IP protocol. The next generation of the protocol, IPv6, has an <code>A6</code> record type. IPv6 is not discussed here.</p>"},{"location":"lpic2.207.2/#the-cname-resource-record","title":"The <code>CNAME</code> resource record","text":"<p>A <code>CNAME</code> (Canonical Name) record specifies another name for a host with an A record. BIND 8 used to allow multiple CNAME records, by accepting an option called <code>multiple-cnames</code>. From BIND 9.2 onward though, the CNAME rules are strictly enforced in compliance to the DNS standards. An example of a combined <code>A</code> and <code>CNAME</code> record is</p> <pre><code>    cat   IN  A     224.123.240.3\n    www   IN  CNAME cat.example.org.\n</code></pre> <p>This makes <code>www.example.org</code> point to <code>cat.example.org</code>.</p>"},{"location":"lpic2.207.2/#the-ns-resource-record","title":"The <code>NS</code> resource record","text":"<p>Specifies a name server for the zone. For example</p> <pre><code>    @    IN SOA .....\n\n         IN  NS    lion.example.org.\n         IN  NS    cat.example.org.\n</code></pre> <p>The first thing that catches the eye is that there is nothing before the IN tag in the NS lines. In this case, the current origin that was specified earlier (here with the <code>SOA</code>) is still valid as the current origin.</p> <p>Note There should be at least two independent name servers for each domain. Independent means connected to separate networks, separate power lines, etc. See Master and slave servers below.</p>"},{"location":"lpic2.207.2/#the-mx-resource-record","title":"The <code>MX</code> resource record","text":"<p>The MX (Mail Exchanger) record system is used by the mail transfer system, e.g., the <code>sendmail</code> and <code>postfix</code> daemons. Multiple MX records may be provided for each domain. The number after the <code>MX</code> tag is the priority. A priority of 0 is the highest priority. The higher the number, the lower the priority. Priority 0 will be used for the host where the mail is destined to. If that host is down, another host with a lower priority (and therefore a higher number) will temporarily store the mail.</p> <p>Example entries:</p> <pre><code>    lion   IN   A       224.123.240.1\n           IN  MX   0   lion.example.org.\n           IN  MX  10   cat.example.org.\n</code></pre> <p>So this example specifies that mail for <code>lion.example.org</code> is first sent to <code>lion.example.org</code>. If that host is down, <code>cat.example.org</code> is used instead.</p> <p>To distribute mail equally among two hosts, give them the same priority. That is, if another host with priority <code>10</code> is added, they will both receive a share of mail when <code>lion.example.org</code> is down.</p>"},{"location":"lpic2.207.2/#mxing-a-domain","title":"MXing a domain","text":"<p>Mail can be delivered to a host, as was shown in the previous section. But the Mail Transfer Agent (MTA) and the DNS can be configured in such a way that a host accepts mail for a domain.</p> <p>Considering our example, host <code>lion.example.org</code> can be configured to accept mail for <code>example.org</code>.</p> <p>To implement this, place MX records for <code>example.org</code> in the <code>example.org</code> zone file, e.g.:</p> <pre><code>    ; accept mail for the domain too\n    example.org.  IN  MX   0   lion.example.org.\n    example.org.  IN  MX  10   cat.example.org.\n</code></pre> <p>Mail addressed to <code>example.org</code> will only be accepted by the MTA on <code>lion.example.org</code> host if the MTA is configured for this.</p>"},{"location":"lpic2.207.2/#DNSReverseZoneFiles","title":"Reverse zone files","text":"<p>Each IP range has a reverse zone, that consists of part of the IP numbers in reverse order, plus <code>in-addr.arpa</code>. This system is among other things used to check whether a host name belongs to a specific address.</p> <p>Our <code>example.org</code> domain uses the IP range <code>224.123.240.</code>x. The corresponding reverse zone is called <code>240.123.224.in-addr.arpa</code>. In <code>named.conf</code> this could be the corresponding entry:</p> <pre><code>    zone \"240.123.224.in-addr.arpa\" IN {\n        type master;\n        file \"/etc/bind/exampleorg.rev\";\n    };\n</code></pre> <p>An example <code>/etc/bind/exampleorg.rev</code> (corresponding to the <code>example.org</code> domain we saw earlier) is:</p> <pre><code>    $TTL 86400\n    @      IN  SOA lion.example.org. dnsmaster.lion.example.org. (\n               2001110700    ; Ser: yyyymmhhee (ee: ser/day start 00)\n                    28800    ; Refresh\n                     3600    ; Retry\n                   604800    ; Expiration\n                     3600 )  ; Negative caching\n           IN  NS       lion.example.org.\n           IN  NS       cat.example.org.\n\n    1      IN   PTR     lion.example.org.\n    2      IN   PTR     doggy.example.org.\n    3      IN   PTR     cat.example.org.\n    4      IN   PTR     bird.example.org.\n</code></pre> <p>The current origin is <code>240.123.224.in-addr.arpa</code>, so the entry for bird actually is</p> <pre><code>    4.240.123.224.in-addr.arpa IN PTR bird.example.org.\n</code></pre>"},{"location":"lpic2.207.2/#the-ptr-record","title":"The <code>PTR</code> record","text":"<p>The <code>PTR</code> record connects the reverse name (<code>4.240.123.224.in-addr.arpa</code>) to the name given by the A record (<code>bird.example.org</code>).</p>"},{"location":"lpic2.207.2/#ipv6-records","title":"IPv6 records","text":""},{"location":"lpic2.207.2/#the-ipv6-address-format","title":"The IPv6 address format","text":"<p>IPv6 addresses are 128 bit addresses rather than IPv4's 32 bits. They are notated as 8 groups of 16-bit values, written in 4 hexadecimal numbers per part, separated by a colon. For the sake of readability leading zero's in every part may be omitted, and parts consisting of zero's only may be completely omitted. The latter may only be done once per address because multiple occurrences would create an ambiguous representation.</p> <p>For example: <code>2001:0db8:0000:0000:0000:ff00:0042:8329</code> can be rewritten to <code>2001:db8::ff00:42:8329</code>.</p> <p>The localhost (loopback) address <code>0:0:0:0:0:0:0:1</code> can be reduced to <code>::1</code></p>"},{"location":"lpic2.207.2/#the-aaaa-record","title":"The AAAA record","text":"<p>Where the <code>A</code> record is used for IPv4, the <code>AAAA</code> record is used for IPv6. It resolves a hostname to an IPv6 address in the same way as an <code>A</code> record does for IPv4.</p> <pre><code>    lion   IN   AAAA    2001:db8::ff00:42:8329\n</code></pre> <p>Note Note: Another format used to resolve IPv6 address records was the A6 record. While supported by the current BIND versions it is considered \\\"historic\\\" by RFC6563</p>"},{"location":"lpic2.207.2/#the-ptr-record_1","title":"The PTR record","text":"<p>For reverse resolution IPv6 address are represented in another format, with every hexadecimal digit separated by a dot. Our example above becomes: <code>2.0.0.1.0.d.b.8.0.0.0.0.0.0.0.0.0.0.0.0.f.f.0.0.0.0.4.2.8.3.2.9</code></p> <p>The IPv6 PTR record is that address in exact reverse order with the domain <code>ip6.arpa</code> appended. The above address becomes: <code>9.2.3.8.2.4.0.0.0.0.f.f.0.0.0.0.0.0.0.0.0.0.0.0.8.b.d.0.1.0.0.2.ip6.arpa</code></p> <p>Part of that domain may be delegated, just as IPv4 addresses. In <code>named.conf</code> this could be the corresponding entry:</p> <pre><code>    zone \"0.0.0.0.0.0.0.0.8.b.d.0.1.0.0.2.ip6.arpa\" IN {\n        type master;\n        file \"/etc/bind/exampleorg-ip6.rev\";\n    };\n</code></pre> <p>The corresponding file should look like the following file:</p> <pre><code>    $TTL 86400\n    @      IN  SOA lion.example.org. dnsmaster.lion.example.org. (\n               2001110700    ; Ser: yyyymmhhee (ee: ser/day start 00)\n                    28800    ; Refresh\n                     3600    ; Retry\n                   604800    ; Expiration\n                    86400 )  ; Negative caching\n           IN  NS       lion.example.org.\n           IN  NS       cat.example.org.\n\n    9.2.3.8.2.4.0.0.0.0.f.f.0.0.0.0      IN   PTR     lion.example.org.\n</code></pre> <p>As both IPv4 and IPv6 PTR records are in different zones (i.e. <code>in-addr.arpa</code> and <code>ip6.arpa</code>) they should be defined in separate zone files.</p>"},{"location":"lpic2.207.2/#master-and-slave-servers","title":"Master and slave servers","text":"<p>Each zone (except the ones local to the machine, such as <code>localhost</code>) must have at least one master name server. It can be supported by one or more slave name servers.</p> <p>There should be two independent name servers for each zone. Independent means connected to a different network and other power supplies. If one power plant or network fails the resolving names from the zone must still be possible. A good solution for this is one master and one slave name server at different locations.</p> <p>Both master and slave name servers are authoritative for the zone (if the zone was delegated properly, see Delegating a DNS zone). That is, they both give the same answers about the zone.</p> <p>The data of a zone originates from a master name server for that zone. The slave name server copies the data from the master. Other name servers can contact either a master or a slave to resolve a name.</p> <p>This implies that the configuration must handle</p> <ul> <li> <p>slave name server access control on the master</p> </li> <li> <p>other name server access control on both master and slave name     servers</p> </li> </ul>"},{"location":"lpic2.207.2/#configuring-a-master","title":"Configuring a master","text":"<p>A zone definition is defined as master by using the</p> <pre><code>    type master;\n</code></pre> <p>statement inside a zone definition. See, for example, this zone statement (in <code>named.conf</code>) that defines the <code>example.org</code> master.</p> <pre><code>    zone \"example.org\" IN {\n    type master;\n    file \"/etc/bind/exampleorg.zone\";\n    };\n</code></pre> <p>Of course, the <code>exampleorg.zone</code> file must be created as discussed earlier.</p> <p>There can be multiple independent master name servers for the same zone.</p> <p>A <code>notify</code> statement controls whether or not the master sends DNS NOTIFY messages upon change of a master zone. The <code>notify</code> statement can be put in a <code>zone</code> statement as well as in an <code>options</code> statement. If one is present in both the <code>zone</code> and <code>options</code> statements, the former takes precedence. When a slave receives such a NOTIFY request (and supports it), it initiates a zone transfer to the master immediately to update the zone data. The default is <code>notify yes;</code>. To turn it off (e.g. when a zone is served by masters only) set <code>notify                 no;</code>.</p> <p>How does the master know which slave servers serve the same zone? It inspects the <code>NS</code> records defined for the zone. In other words: the <code>NS</code> record for a zone should specify all slaves for that zone. Extra slave servers can be specified with the <code>also-notify</code> statement (see the named.conf(5) manpage).</p> <p>Note Older versions of BIND used the term primary instead of master.</p>"},{"location":"lpic2.207.2/#configuring-a-slave","title":"Configuring a slave","text":"<p>A zone definition is defined as slave by using the</p> <pre><code>    type slave;\n</code></pre> <p>statement inside a zone definition, accompanied by the IP address(es) of the master(s). Here, for example, is the zone statement (in <code>named.conf</code>), which defines a <code>example.org</code> slave:</p> <pre><code>    zone \"example.org\" IN {\n        type slave;\n        masters { 224.123.240.1; }; // lion\n        file \"db.example.org\";\n    };\n</code></pre> <p>The file <code>db.example.org</code> is created by the slave name server itself. The slave has no data for <code>example.org</code>. Instead, a slave receives its data from a master name server and stores it in the specified file.</p> <p>Note that the filename has no directory component. Hence it will be written in the BIND working directory given by the <code>directory</code> option in <code>named.conf</code>. For instance, <code>/var/cache/bind</code> or <code>/var/named</code>. The name server must have write access to the file.</p> <p>Note Older versions of BIND used the term secondary instead of slave.</p>"},{"location":"lpic2.207.2/#a-stub-name-server","title":"A <code>stub</code> name server","text":"<p>A stub zone is like a slave zone, except that it replicates only the <code>NS</code> records of a master zone instead of the entire zone. In other words, the DNS server hosting the stub zone is only a source of information on the authoritative name servers. This server must have network access to the remote DNS server in order to copy the authoritative name server information.</p> <p>The purpose of stub zones is two fold:</p> <ul> <li> <p>Keep delegated zone information current. By updating a stub zone     for one of its child zones regularly, the DNS server that hosts the     stub zone will maintain a current list of authoritative DNS servers     for the child zone.</p> </li> <li> <p>Improve name resolution. Stub zones make it possible for a DNS     server to perform name resolution using the stub zone's list of     name servers, without having to use forwarding or root hints.</p> </li> </ul> <p>Creating subdomains</p> <p>There are two ways to create a subdomain: inside a zone or as a delegated zone.</p> <p>The first is to put a subdomain inside a normal zone file. The subdomain will not have its own <code>SOA</code> and <code>NS</code> records. This method is not recommended - it is harder to maintain and may produce administrative problems, such as signing a zone.</p> <p>The other method is to delegate the subdomain to a separate zone. This is described in the next section.</p>"},{"location":"lpic2.207.2/#DNSdelegation","title":"Delegating a DNS zone","text":"<p>A real, independent subdomain can be created by configuring the subdomain as an independent zone (having its own <code>SOA</code> and <code>NS</code> records) and delegating that domain from the parent domain.</p> <p>A zone will only be authoritative if the parent zone has delegated its authority to the zone. For example, the <code>example.org</code> domain was delegated by the <code>org</code> domain.</p> <p>Likewise, the <code>example.org</code> domain could delegate authority to an independent <code>scripts.example.org</code> domain. The latter will be independent of the former and have its own <code>SOA</code> and <code>NS</code> records.</p> <p>Let's look at an example file of the <code>scripts.example.org</code> zone:</p> <pre><code>    $ORIGIN scripts.example.org.\n    ctl  IN  A  224.123.240.16\n         IN MX   0 ctl\n         IN MX  10 lion.example.org.\n    www  IN CNAME ctl\n    perl IN  A  224.123.240.17\n         IN MX   0 perl\n         IN MX  10 ctl\n         IN MX  20 lion.example.org.\n    bash IN  A  224.123.240.18\n         IN MX  0 bash\n         IN MX  10 ctl\n         IN MX  20 lion.example.org.\n    sh   IN CNAME bash\n</code></pre> <p>Nothing new, just a complete zone file.</p> <p>But, to get it authoritative, the parent domain, which is <code>example.org</code> in this case, must delegate its authority to the <code>scripts.example.org</code> zone. This is the way to delegate in the <code>example.org</code> zone file:</p> <pre><code>    scripts  2d IN NS ctl.scripts.example.org.\n             2d IN NS bash.scripts.example.org.\n    ctl.scripts.example.org.  2d IN  A 224.123.240.16\n    bash.scripts.example.org. 2d IN  A 224.123.240.18\n</code></pre> <p>That's all!</p> <p>The <code>NS</code> records for <code>scripts</code> do the actual delegation. The <code>A</code> records must be present, otherwise the name servers of <code>scripts</code> cannot be located.</p> <p>Note It is advised to insert a TTL field (like the <code>2d</code> in the example).</p> <p>Checking zone files for syntax errors</p> <p>named-checkzone After creating or making changes to a zone file it is a good idea to check them for syntax errors. This can be done with the <code>named-checkzone</code> command. The way to do this is by entering the domain name after the command followed by the name of the zone file. See below for an example.</p> <pre><code>    # named-checkzone test.com /var/named/test.com.zone\n    zone test.com/IN: loaded serial 0\n    OK\n</code></pre> <p>In this example I didn't put a dot at the end of the domain name but you can choose to do so. Both ways are correct and will give the same answer.</p> <p>As you can see in the example above, the utility gives an \\\"OK\\\" as a response this means the file is clear of any syntax errors. You maybe also want to consider checking the man page for <code>named-checkzone</code> for additional options.</p> <p>named-compilezone From version 9.9 of the BIND software secondary server zone files are by default saved in raw binary format instead of text format. Reading and checking these files can be a bit more challenging because of this. Luckily there is the tool <code>named-compilezone</code>. This tool is quite similair to the <code>named-checkzone</code> tool but makes it possible to change raw zone files to text format (and vice versa) so they are readable by normal human beings.</p> <p>masterfile-format It is possible to change to change this behaviour and change the default format back to text format. This can be done by adding the <code>masterfile-format</code> option to the zone statement in the named.conf files on the secondary name servers that you administer. Example below shows the correct syntax for this.</p> <pre><code>    masterfile-format text;\n</code></pre> <p>DNS Utilities</p> <p>dig nslookup Four DNS utilities can help to resolve names and even debug a DNS zone. They are called <code>dig</code>, <code>host</code>, <code>nslookup</code> and <code>dnswalk</code>. The first three are part of the BIND source distribution.</p>"},{"location":"lpic2.207.2/#the-dig-program","title":"The <code>dig</code> program","text":"<p>The <code>dig</code> command lets you resolve names in a way that is close to the setup of a zone file. For instance, you can do</p> <pre><code>    dig bird.example.org A\n</code></pre> <p>This will do a lookup of the <code>A</code> record of <code>bird.example.org</code>. Part of the output looks like this:</p> <pre><code>    ;; ANSWER SECTION:\n    bird.example.org. 1D IN A 224.123.240.4\n\n    ;; AUTHORITY SECTION:\n    example.org.      1D IN NS  lion.example.org.\n\n    ;; ADDITIONAL SECTION:\n    lion.example.org.  1D IN A 224.123.240.1\n</code></pre> <p>If <code>dig</code> shows a <code>SOA</code> record instead of the requested <code>A</code> record, then the domain is ok, but the requested host does not exist.</p> <p>It is even possible to query another name server instead of the one(s) specified in <code>/etc/resolv.conf</code>:</p> <pre><code>    dig @cat.example.org bird.example.org A\n</code></pre> <p>This will query name server <code>cat.example.org</code> for the <code>A</code> record of host <code>bird</code>. The name server that was contacted for the query will be listed in the tail of the output.</p> <p>The <code>dig</code> command can be used to test or debug your reverse zone definitions. For instance,</p> <pre><code>    dig 4.240.123.224.in-addr.arpa PTR\n</code></pre> <p>will test the reverse entry for the <code>lion</code> host. You should expect something like this:</p> <pre><code>    ;; ANSWER SECTION:\n    4.240.123.224.in-addr.arpa.  1D IN PTR lion.example.org.\n\n    ;; AUTHORITY SECTION:\n    240.123.224.in-addr.arpa.  1D IN NS  lion.example.org.\n\n    ;; ADDITIONAL SECTION:\n    lion.example.org.      1D IN A       224.123.240.4\n</code></pre> <p>If you get something like</p> <pre><code>    ;; ANSWER SECTION:\n    4.240.123.224.in-addr.arpa. 1D IN PTR lion.example.org.240.123.224.in-addr.arpa.\n</code></pre> <p>you've made an error in your zone file. Given a current origin of <code>240.123.224.in-addr.arpa.</code>, consider the line:</p> <pre><code>    4  IN PTR lion.example.org ; WRONG!\n</code></pre> <p>The dot at the end was omitted, so the current origin is appended automatically. To correct this, add the trailing dot:</p> <pre><code>    4  IN PTR lion.example.org. ; RIGHT!\n</code></pre> <p>Note When specifying a hostname like <code>bird.example.org</code> or <code>4.240.123.224.in-addr.arpa</code> to <code>dig</code>, a trailing dot may be added.</p>"},{"location":"lpic2.207.2/#the-host-program","title":"The <code>host</code> program","text":"<p>host</p> <p>The <code>host</code> program reports resolver information in a simple format.</p> <p>When a hostname is specified as a parameter, the corresponding <code>A</code> record will be shown. For example:</p> <pre><code>    host bird.example.org\n</code></pre> <p>will result in output like</p> <pre><code>    bird.example.org    A    224.123.240.4\n</code></pre> <p>The <code>host</code> program is especially useful when a hostname is wanted and an IP address is given. For example:</p> <pre><code>    host 224.123.240.4\n</code></pre> <p>from our example hosts shows output like:</p> <pre><code>    Name: bird.example.org\n    Address: 224.123.240.4\n</code></pre> <p>The following command is also possible:</p> <pre><code>    host 4.240.123.224.in-addr.arpa\n</code></pre> <p>resolves the PTR record:</p> <pre><code>    4.240.123.224.in-addr.arpa PTR bird.example.org\n</code></pre> <p>Note As is the case with <code>dig</code>, when specifying a hostname like <code>bird.example.org</code> or <code>4.240.123.224.in-addr.arpa</code> to <code>host</code>, a trailing dot may be added.</p>"},{"location":"lpic2.207.2/#the-nslookup-program","title":"The <code>nslookup</code> program","text":"<p>The <code>nslookup</code> program is yet another way to resolve names. As stated before the use of <code>nslookup</code> is deprecated, and the commands <code>host</code> and <code>dig</code> should be used instead. Despite this recommendation, you should have some knowledge of its usage.</p> <p>For instance, start the interactive mode by entering <code>nslookup</code> and typing:</p> <pre><code>    ls -d example.org.\n</code></pre> <p>In result, the output will be shown in a zonefile-like format (beginning shown):</p> <pre><code>    [lion.example.org]\n    $ORIGIN example.org.\n    @    1D IN SOA lion postmaster.lion (\n                    2001110800   ; serial\n                            8H   ; refresh\n                            1H   ; retry\n                            1W   ; expiry\n                            1D ) ; minimum\n\n                        1D IN NS   lion\n                        1D IN MX 0 lion\n</code></pre> <p>The first line, in square brackets, contains the name of the name server that sent the answer.</p> <p>Note The example shown requires a zone transfer from the connected name server. If this name server refuses zone transfers (as will be discussed in the next section), you will of course not see this output.</p> <p>A lot of commands can be given to <code>nslookup</code> in interactive mode: the <code>help</code> command will present a list.</p>"},{"location":"lpic2.207.2/#dnswalk","title":"DNSwalk","text":"<p>DNSwalk is a DNS debugger. Use with caution, since it tries to perform zone transfers while checking DNS databases for consistency and accuracy. Example:</p> <pre><code>    $ dnswalk zoneedit.com.\n    Checking zoneedit.com.\n    Getting zone transfer of zoneedit.com. from ns2.zoneedit.com...done.\n    SOA=ns2.zoneedit.com    contact=soacontact.zoneedit.com\n    WARN: zoneedit.com A 64.85.73.107: no PTR record\n    WARN: golf.zoneedit.com A 69.72.176.186: no PTR record\n    WARN: zoneapp1.zoneedit.com A 64.85.73.104: no PTR record\n    WARN: dynamic1.zoneedit.com A 64.85.73.40: no PTR record\n    WARN: zoneapp2.zoneedit.com A 64.85.73.107: no PTR record\n    WARN: ezzi.zoneedit.com A 207.41.71.242: no PTR record\n    WARN: dynamic2.zoneedit.com A 64.85.73.40: no PTR record\n    WARN: legacyddns.zoneedit.com A 64.85.73.40: no PTR record\n    WARN: api2.zoneedit.com A 64.85.73.104: no PTR record\n    WARN: wfb.zoneedit.com A 69.72.142.98: no PTR record\n    WARN: new.zoneedit.com A 64.85.73.107: no PTR record\n    WARN: zebra.zoneedit.com A 69.72.240.114: no PTR record\n    WARN: api.zoneedit.com A 64.85.73.40: no PTR record\n    WARN: www.zoneedit.com A 64.85.73.107: no PTR record\n    WARN: newapi.zoneedit.com A 64.85.73.104: no PTR record\n    0 failures, 15 warnings, 0 errors.\n</code></pre>"},{"location":"lpic2.207.3/","title":"Securing a DNS Server (207.3)","text":""},{"location":"lpic2.207.3/#securing-a-dns-server-2073","title":"Securing a DNS Server (207.3)","text":"<p>Candidates should be able to configure a DNS server to run as a non-root user and run in a chroot jail. This objective includes secure exchange of data between DNS servers.</p>"},{"location":"lpic2.207.3/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>BIND 9 configuration files</p> </li> <li> <p>Configuring BIND to run in a chroot jail</p> </li> <li> <p>Split configuration of BIND using the forwarders statement</p> </li> <li> <p>Configuring and using transaction signatures (TSIG)</p> </li> <li> <p>Awareness of DNSSEC and basic tools</p> </li> <li> <p>Awareness of DANE and related records</p> </li> </ul>"},{"location":"lpic2.207.3/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/etc/named.conf</code></p> </li> <li> <p><code>/etc/passwd</code></p> </li> <li> <p>DNSSEC</p> </li> <li> <p><code>dnssec-keygen</code></p> </li> <li> <p><code>dnssec-signzone</code></p> </li> </ul>"},{"location":"lpic2.207.3/#dns-security-strategies","title":"DNS Security Strategies","text":"<p>There are several strategies possible to make DNS more secure.</p> <p>When a security bug is discovered in the BIND nameserver, it will often be fixed within a few hours. This results in a new BIND release. Hence, older versions of BIND may have security related bugs. BIND users should frequently visit the BIND source site (http://www.isc.org/downloads/bind/) to check for new updates. You may consider subscribing to a security announcement list; most Linux distributions have one. For instance, the Debian <code>debian-security-announce</code>. To subscribe to that list visit https://lists.debian.org.</p>"},{"location":"lpic2.207.3/#making-information-harder-to-get","title":"Making information harder to get","text":"<p>Like all other programs, the BIND nameserver has features and security holes that can be misused. Criminal hackers (crackers) are well aware of this and keep track of versions and their security related issues. It is wise not to advertise your vulnerabilities so you may want to disable version number reporting in BIND.</p> <p>Also, bulk nameserver data can be used to disclose details about your infrastructure. Hence restrictions can be installed to prevent a user from obtaining a large amount of nameserver data or at least to get it in a short timeframe. Another reason to do so is that nameservers are built to answer a large number of short queries in a short timeframe. Having to serve large blobs of data unexpectedly might disrupt services.</p> <p>It is important to remember that hiding information is security through obscurity. Doing so, the easy way to get information has been blocked but there may be other ways to get it. Security through obscurity makes it harder, but not impossible to get the information. It does however introduce a longer timeframe in which you may be able to detect break-in attempts and act accordingly, for example by blocking the requestors IP address in your firewalls.</p>"},{"location":"lpic2.207.3/#hiding-the-version-number","title":"Hiding the version number","text":"<p>The command</p> <pre><code>    dig @target chaos version.bind txt\n</code></pre> <p>will show the version of the BIND nameserver on host target.</p> <p>The BIND version can be hidden by entering a <code>version</code> statement inside the <code>options</code> statement in <code>named.conf</code>. In the following example, the version will be set to the string <code>hidden</code>.</p> <pre><code>    options {\n        // ...\n\n        // hide bind version\n        version \"hidden\";\n    };\n</code></pre> <p>The CERT article (???) shows a way to limit access to the <code>bind</code> zone. This an alternative to replacing the BIND version.</p>"},{"location":"lpic2.207.3/#limiting-access","title":"Limiting access","text":"<p>There are several ways to limit access to nameserver data. First, an access control list must be defined. This is done with the <code>acl</code> statement.</p> <pre><code>    acl \"trusted\" {\n        localhost;\n        192.168.1.0/24;\n    };\n</code></pre> <p>This <code>acl</code> defines an access control list with label <code>trusted</code>. ACL labels are used to simplify administration: you only need to update your ACLs in one place, after that each reference to a label will automatically point to the updated data.</p> <p>A nameserver supports queries by resolvers and zone transfers by other nameservers.</p>"},{"location":"lpic2.207.3/#normal-queries","title":"normal queries","text":"<ul> <li>Normal queries occur when a resolver needs data only on a very     limited subset of the data. For example it wants to know which IP     address is associated with a hostname. The <code>allow-query</code> statement     controls from which hosts these queries are accepted.</li> </ul>"},{"location":"lpic2.207.3/#zone-transfers","title":"zone transfers","text":"<ul> <li> <p>The internet name space is built on the idea of a hierarchy of     domains. To find the IP address of a host, you need its fully     qualified domain name (FQDN). It consists of a series of     subdomains separated by dots, for example: <code>www.example.com</code>. The     first section is the hostname, i.e. \"www\". Next is the \"example\"     domain, which in turn is a subdivision of the \"com\" domain. Data on     a single domain is called a \"zone\". Slave (backup) nameservers must     be allowed to get the information from a master of the same zone. It     is important to restrict these \"zone transfers\" to the servers that     need the data only - no more.</p> <p>Zone transfers are controlled by the <code>allow-transfer</code> statement. This statement may also be specified in the <code>zone</code> statement, thereby overriding the global <code>options allow-transfer</code> statement. Traditionally zone transfers can be initiated by anybody.</p> </li> </ul> <p>The <code>allow-query</code> statement can be used inside a <code>zone</code> statement or an <code>options</code> statement as well. It can contain either an acl label (like <code>trusted</code>), <code>none</code>, or one or more IP addresses or IP ranges. Use labels whenever you can: keeping track of permissions is much easier that way and it makes you less vulnerable to accidental oversights that may cause security holes.</p>"},{"location":"lpic2.207.3/#limiting-zone-transfers","title":"Limiting zone transfers","text":"<p>Both <code>dig</code> and <code>host</code> can initiate a zone transfer. By default, both master and slave servers are allowed to send all zone information. An example using the <code>dig</code> command:</p> <pre><code>    $ dig axfr @ns12.zoneedit.com zonetransfer.me\n\n    ; &lt;&lt;&gt; DiG 9.8.3-P1 &lt;&lt;&gt;&gt; axfr @ns12.zoneedit.com zonetransfer.me\n    ; (1 server found)\n    ;; global options: +cmd\n    zonetransfer.me.    7200    IN  SOA ns16.zoneedit.com. soacontact.zoneedit.com. \\\n        2013064418 2400 360 1209600 300\n    zonetransfer.me.    7200    IN  NS  ns16.zoneedit.com.\n    zonetransfer.me.    7200    IN  NS  ns12.zoneedit.com.\n    zonetransfer.me.    7200    IN  A   217.147.180.162\n    zonetransfer.me.    7200    IN  MX  0 ASPMX.L.GOOGLE.COM.\n    zonetransfer.me.    7200    IN  MX  10 ALT1.ASPMX.L.GOOGLE.COM.\n    zonetransfer.me.    7200    IN  MX  10 ALT2.ASPMX.L.GOOGLE.COM.\n    zonetransfer.me.    7200    IN  MX  20 ASPMX2.GOOGLEMAIL.COM.\n    zonetransfer.me.    7200    IN  MX  20 ASPMX3.GOOGLEMAIL.COM.\n    zonetransfer.me.    7200    IN  MX  20 ASPMX4.GOOGLEMAIL.COM.\n    zonetransfer.me.    7200    IN  MX  20 ASPMX5.GOOGLEMAIL.COM.\n    zonetransfer.me.    301 IN  TXT \"Remember to call or email Pippa on +44 123 4567890 \\\n        or pippa@zonetransfer.me when making DNS changes\"\n    zonetransfer.me.    301 IN  TXT \"google-site-verification=tyP28J7JAUHA9fw2sHXMgcCC0I6XBmmoVi04VlMewxA\"\n    testing.zonetransfer.me. 301    IN  CNAME   www.zonetransfer.me.\n    164.180.147.217.in-addr.arpa.zonetransfer.me. 7200 IN PTR www.zonetransfer.me.\n    ipv6actnow.org.zonetransfer.me. 7200 IN AAAA    2001:67c:2e8:11::c100:1332\n    asfdbauthdns.zonetransfer.me. 7900 IN   AFSDB   1 asfdbbox.zonetransfer.me.\n    office.zonetransfer.me. 7200    IN  A   4.23.39.254\n    owa.zonetransfer.me.    7200    IN  A   207.46.197.32\n    info.zonetransfer.me.   7200    IN  TXT \"ZoneTransfer.me service provided by Robin \\\n        Wood - robin@digininja.org. See www.digininja.org/projects/zonetransferme.php for more information.\"\n    asfdbbox.zonetransfer.me. 7200  IN  A   127.0.0.1\n    canberra_office.zonetransfer.me. 7200 IN A  202.14.81.230\n    asfdbvolume.zonetransfer.me. 7800 IN    AFSDB   1 asfdbbox.zonetransfer.me.\n    email.zonetransfer.me.  2222    IN  NAPTR   1 1 \"\" \"E2U+email\" \"\" email.zoneedit.com.zonetransfer.me.\n    dzc.zonetransfer.me.    7200    IN  TXT \"AbCdEfG\"\n    dr.zonetransfer.me. 300 IN  LOC 53 20 56.558 N 1 38 33.526 W 0.00m 1m 10000m 10m\n    rp.zonetransfer.me. 321 IN  RP  robin.zonetransfer.me.zonetransfer.me. robinwood.zonetransfer.me.\n    sip.zonetransfer.me.    3333    IN  NAPTR   2 3 \"au\" \"E2U+sip\" \"!^.*$!sip:customer-service@zonetransfer.me!\".\n    alltcpportsopen.firewall.test.zonetransfer.me. 301 IN A 127.0.0.1\n    www.zonetransfer.me.    7200    IN  A   217.147.180.162\n    staging.zonetransfer.me. 7200   IN  CNAME   www.sydneyoperahouse.com.\n    deadbeef.zonetransfer.me. 7201  IN  AAAA    dead:beaf::\n    robinwood.zonetransfer.me. 302  IN  TXT \"Robin Wood\"\n    vpn.zonetransfer.me.    4000    IN  A   174.36.59.154\n    _sip._tcp.zonetransfer.me. 14000 IN SRV 0 0 5060 www.zonetransfer.me.\n    dc_office.zonetransfer.me. 7200 IN  A   143.228.181.132\n    zonetransfer.me.    7200    IN  SOA ns16.zoneedit.com. soacontact.zoneedit.com. \\\n        2013064418 2400 360 1209600 300\n    ;; Query time: 334 msec\n    ;; SERVER: 209.62.64.46#53(209.62.64.46)\n    ;; WHEN: Fri Jun 28 12:01:16 2013\n    ;; XFR size: 37 records (messages 37, bytes 2673)\n</code></pre> <p>The previous example shows the complete information about <code>zonetransfer.me</code>. The command <code>host -l</code> does the same but formats its output differently:</p> <pre><code>    $ host -l zonetransfer.me ns16.zoneedit.com\n    Using domain server:\n    Name: ns16.zoneedit.com\n    Address: 69.64.68.41#53\n    Aliases:\n\n    zonetransfer.me nameserver ns16.zoneedit.com.\n    zonetransfer.me nameserver ns12.zoneedit.com.\n    zonetransfer.me has address 217.147.180.162\n    164.180.147.217.in-addr.arpa.zonetransfer.me domain name pointer www.zonetransfer.me.\n    ipv6actnow.org.zonetransfer.me has IPv6 address 2001:67c:2e8:11::c100:1332\n    office.zonetransfer.me has address 4.23.39.254\n    owa.zonetransfer.me has address 207.46.197.32\n    asfdbbox.zonetransfer.me has address 127.0.0.1\n    canberra_office.zonetransfer.me has address 202.14.81.230\n    alltcpportsopen.firewall.test.zonetransfer.me has address 127.0.0.1\n    www.zonetransfer.me has address 217.147.180.162\n    deadbeef.zonetransfer.me has IPv6 address dead:beaf::\n    vpn.zonetransfer.me has address 174.36.59.154\n    dc_office.zonetransfer.me has address 143.228.181.132\n</code></pre> <p>Only validated slave nameservers should be allowed to issue a zone transfer request. This can be done by making adjustments to the configuration files (<code>named.conf</code>) of both the master and all slaves of a particular zone. For example:</p> <p>On master nameservers.</p> <p>On the master nameserver you should use the <code>allow-transfer</code> statement to limit zone transfers to a list of known slave servers.</p> <pre><code>    acl \"my_slave_servers\" {\n        224.123.240.3;  // cat.example.org\n    };\n\n    // ...\n\n    zone \"example.org\" IN {\n        type master;\n        // ....\n\n        allow-transfer {\n            my_slave_servers;\n        };\n    };\n</code></pre> <p>Now only the slaves (only the host <code>cat</code> in the example) can request a zone transfer from this master nameserver.</p> <p>On slave nameservers.</p> <p>On a slave nameserver you should never allow any zone transfers. This can be achieved by setting the <code>allow-transfer</code> clause to 'none':</p> <pre><code>    zone \"example.org\" IN {\n        type slave;\n        // ....\n\n        allow-transfer {\n            none;\n        };\n    };\n</code></pre> <p>Note IMPORTANT:*Don't forget to protect the *reverse zone as well!</p>"},{"location":"lpic2.207.3/#limiting-queries","title":"Limiting queries","text":"<p>Though strictly spoken any client should be allowed to query a nameserver, in practice you may want to limit queries to a range of hosts, for example the hosts in your own networks. This can be done as follows:</p> <pre><code>    acl \"myhosts\" {\n        224.123.240.0/24;\n    };\n\n    // ...\n\n    zone \"example.org\" IN {\n        // ...\n\n        allow-queries {\n            myhosts;\n        };\n    };\n</code></pre> <p>This limits queries to hosts with an IP address that starts with <code>224.123.240</code>.</p>"},{"location":"lpic2.207.3/#controlling-requests","title":"Controlling requests","text":"<p>There are more security controls that can be used.</p> <p>Spoofing is when a malicious nameserver answers a client request with false data. As nameserver data is extensively cached for performance reasons, cached data can get infected with the falsified data. Spoofing is quite difficult to achieve, but it is wise to take precautions against it. Many older spoofing methods have already been eliminated by patches in the software but BIND can be configured to further enhance spoofing protection.</p>"},{"location":"lpic2.207.3/#limiting-effects-of-an-intrusion","title":"Limiting effects of an intrusion","text":"<p>Even when you are prepared to implement DNS fixes as soon as they appear, it may be too late - even if by only a couple of hours: your system could be compromised anyway. Therefore it is advisable to take precautions to minimize the impact.</p>"},{"location":"lpic2.207.3/#running-bind-with-less-privileges","title":"Running BIND with less privileges","text":"<p>In some distributions, BIND runs as <code>root</code>. If BIND is compromised, the attacker might have root access. This can be prevented by running BIND under a non-privileged user and group.</p> <p>It might be tempting to employ the user <code>nobody</code> and group <code>nogroup</code>. But since many services already do this another security issue arises: these services may be able to communicate in one way or another.</p> <p>Best practice is to create a special user, e.g. <code>named</code>, and a corresponding group (which could also be called <code>named</code>), and run the nameserver under this user/group combination.</p> <p>Use the <code>-u</code> and <code>-g</code> options to run <code>named</code> as <code>named</code>/<code>named</code>:</p> <pre><code>    named -u named -g named\n</code></pre> <p>On a Debian system the start line in <code>/etc/init.d/bind</code> would be:</p> <pre><code>    start-stop-daemon ... --exec /usr/sbin/named -- -u named -g named\n</code></pre> <p>(For clarity other options were replaced by dots). The extra <code>--</code> tells the <code>start-stop-daemon</code> where its options end, all other options will be passed on to the <code>named</code> program.</p> <p>On a Red Hat (or compatible) system, the startup file can be found in <code>/etc/rc.d/init.d/named</code>. On RHEL systems the service is already configured to run under the user 'named'. You can set additional options in <code>/etc/sysconfig/named</code>, for example you can add <code>-u named</code> there. To start the service on Red Hat (compatible) systems, use the <code>service</code> command:</p> <pre><code>    # service named start\n    Generating /etc/rndc.key:                                  [  OK  ]\n    Starting named:                                            [  OK  ]\n</code></pre> <p>To make <code>named</code> start up in the proper runlevels on Red Hat (compatible) systems run <code>chkconfig named on</code>.</p> <p>Note Make sure the nameserver has write access in the directory specified by the <code>directory</code> option in <code>named.conf</code>.</p>"},{"location":"lpic2.207.3/#running-bind-in-a-chroot-jail","title":"Running BIND in a chroot jail","text":"<p>Another way to prevent damage from a compromised name-server process is to put the process in a chroot jail. On startup the process will set a directory (e.g. <code>/var/cache/bind</code>) as its root directory. Since no process is ever capable of accessing anything above its set root, this prevents the named process access to anything outside <code>/var/cache/bind</code>.</p>"},{"location":"lpic2.207.3/#preparing-a-chroot-jail","title":"Preparing a chroot jail","text":"<p>All files that BIND needs must be copied to the new root directory. Full details can be found here: ???.</p> <p>In short:</p> <ul> <li> <p>You will need to copy the <code>/etc</code>, <code>/dev</code>, <code>/lib</code>, <code>/sbin</code> or     <code>/usr/sbin</code>, and <code>/var/run</code> directories to the chroot.</p> </li> <li> <p>You'll probably need the <code>/dev/null</code> device under the new root. The     next command will create it:</p> <pre><code>    mknod -m 666 /var/cache/bind/dev/null c 1 3\n</code></pre> </li> <li> <p>You will need a <code>passwd</code> and a <code>group</code> file in the new <code>/etc</code>:</p> <pre><code>    cd /var/cache/bind/etc\n    cp -p /etc/{passwd,group} .\n</code></pre> <p>This copies the literal passwd and group files. An alternative is to create special <code>passwd</code> and <code>group</code> files, as will be shown in Combining special user and chroot.</p> <p>You may also need to copy <code>ld.so.cache</code> and <code>localtime</code>:</p> <pre><code>    cd /var/cache/bind/etc\n    cp /etc/ld.so.cache .\n    cp /etc/localtime .\n</code></pre> </li> <li> <p>The BIND configuration should also be placed under the new root, as     <code>named</code> might need it when you reload the server. Given that your     new root is set to <code>/var/cache/bind</code> you should copy the file over     to <code>/var/cache/bind/etc/bind</code>.</p> <p>Note that all directories in the new <code>named.conf</code> - as specified with the <code>directory</code> option - are relative to the new root directory, so you do not need (or should) include the prefix <code>/var/cache/bind</code> there.</p> </li> <li> <p>The new <code>lib</code> directory must contain at least all the shared     libraries used by BIND. You can list these with the <code>ldd</code> command.     For instance, suppose the command:</p> <pre><code>    ldd /usr/sbin/named\n</code></pre> <p>yields</p> <pre><code>    libc.so.6 =&gt; /lib/libc.so.6 (0x40015000)\n    /lib/ld-linux.so.2 =&gt; /lib/ld-linux.so.2 (0x40000000)\n</code></pre> <p>In the (real) <code>/lib</code> directory, <code>libc.so.6</code> is a symlink to <code>libc-2.1.3.so</code> and <code>ld-linux.so.2</code> is a symlink to <code>ld-2.1.3.so</code>. Both the symlinks and the files they point to must be copied to the <code>lib</code> directory under the new root:</p> <pre><code>    cd /var/cache/bind/lib\n    cp -pd /lib/{libc.so.6,libc-2.1.3.so,ld-linux.so.2,ld-2.1.3.so} .\n</code></pre> </li> <li> <p>Both the <code>named</code> and the <code>named-xfer</code> programs must be present under     the new root. The <code>rndc</code> program might be useful too. For example:</p> <pre><code>    cp -p /usr/sbin/named{,-xfer} /var/cache/bind/usr/sbin\n    cp -p /usr/sbin/rndc /var/cache/bind/usr/sbin\n</code></pre> </li> </ul>"},{"location":"lpic2.207.3/#running-bind-chrooted","title":"Running BIND chrooted","text":"<p>To start the BIND nameserver in a chroot jail, simply add the <code>-t</code> option followed by a directory name, either on the command line, in the startup script, or in the <code>sysconfig</code> file.</p> <p>Note The <code>-t</code> option actually runs the <code>chroot</code> command to start the nameserver. Read the manual pages on the <code>chroot</code> command to learn more.</p> <p>In some systems you may need to add the option to the startup file. For example:</p> <pre><code>    start-stop-daemon ... --exec /usr/sbin/named -- -t /var/cache/bind\n</code></pre> <p>or</p> <pre><code>    daemon ... /sbin/named -t /var/cache/bind\n</code></pre> <p>The BIND nameserver switches to the chroot immediately after command line argument parsing, so before configuration files are read. All paths in the configuration file should be relative to the new root.</p>"},{"location":"lpic2.207.3/#configuration-for-a-chrooted-bind","title":"Configuration for a chrooted BIND","text":"<p>As a consequence of a chrooted jail, all configuration files (e.g. zone files and <code>named.conf</code>) must be present in a directory (e.g., <code>/etc/bind</code>) under the chroot directory.</p> <p>Logging to syslog will not work either as the chrooted process has no access to the Unix socket located outside the jail (no access to <code>/dev/log</code>). There are various workarounds but the simplest is to use an alternative logfile inside the chrooted environment. See this fragment of a <code>named.conf</code> file you could use:</p> <pre><code>    logging {\n        channel some_log { \n            file \"bind.log\" versions 3;\n            severity info;\n        };\n\n        category default { some_log; };\n\n        // ...\n    };\n</code></pre> <p>This will write logging information to the file <code>/var/cache/bind/var/cache/bind/bind.log</code>.</p> <p>Zone files, if any, should also be put inside the chroot environment. For instance, if <code>named.conf</code> contains a definition of a master zone like this:</p> <pre><code>    zone \"example.com\" IN {\n        type master;\n        file \"/etc/bind/example.com.zone\";\n    };\n</code></pre> <p>Then the <code>example.com.zone</code> file needs to be located in <code>/var/cache/bind/etc/bind</code>, again assuming your chroot directory is <code>/var/cache/bind</code>.</p>"},{"location":"lpic2.207.3/#combining-special-user-and-chroot","title":"Combining special user and chroot","text":"<p>More technical security can be obtained by using a combination of a chrooted environment and running the nameserver under a special non-privileged user and group. Note that these users will have to be available in the copies of <code>/etc/passwd</code> and <code>/etc/group</code> that were created in the chrooted environment. Finally, set permissions on the chrooted zone and configuration files to make them read-only for the named user and group.</p> <p>Note Inspecting the source for BIND reveals the order of things:</p> <ul> <li> <p>parsing of command line options</p> </li> <li> <p>chrooting</p> </li> <li> <p>become a background process and write pid file</p> </li> <li> <p>change to new user and group</p> </li> </ul> <p>The pid file is still written by the <code>root</code> user, after that the less privileged 'named' user will be used.</p> <p>The <code>/etc/passwd</code>, <code>/etc/shadow</code>, and <code>/etc/group</code> files in the chroot environment may differ from the ones used by the rest of the system. The special user and group for the nameserver may not even exist outside the jail.</p>"},{"location":"lpic2.207.3/#securing-nameserver-connections","title":"Securing nameserver connections","text":"<p>Restricting access to trusted hosts can be done using the <code>allow-transfer</code> and <code>allow-query</code> statements in <code>named.conf</code> and may help limit risks. Since the restrictions are IP address based, there is still a residual risk that a villain use spoofing techniques. This could still lead to the misuse of your system.</p> <p>Signing data could help prevent this. When the server and client use a shared secret to sign the data between them we can be quite sure that both parties are whom they say they are.</p> <p>To further secure nameserver connections a set of protocols called DNSSEC (Domain Name System Security Extensions) can be used as an extra security layer.</p>"},{"location":"lpic2.207.3/#CCC","title":"A cryptography crash course","text":"<p>To understand how DNSSEC works you need to be aware of the concepts of message authentication codes, hashes and asymmetrical encryption.</p> <p>You are probably aware of the concept of symmetrical encryption. Using a key and some algorithm a cleartext message is scrambled into something incomprehensible. To restore the message, you need the same key. This works fine to shield a message from prying eyes, but it is not usable to prove that a message was sent by a given party. Either party could write a message, encrypt it with the private key and say it was the other party that wrote the message. There is no way you can tell if this is actually true.</p> <p>The related concept of asymmetrical encryption also allows enciphering and deciphering of messages. But instead of one shared key there are two separate but related ones: one is used to encipher a message, the other to decipher it. After generating such a key pair the owner hands out only one of these keys to the other party or parties, the public key. The other half of the key pair is kept secret (the private key). Whomever has access to the public key can use it to encrypt a message. The owner of the corresponding private key will be the only person that can decipher it. Hence the sender can be sure that he alone can read the message. Moreover he can send an encrypted message, using the private key to encipher it. Everyone with access to the public key will be able decipher it, and can be sure that it really was the owner of the corresponding private key that sent the message.</p> <p>Either private, public, or symmetric keys may be used to compute a MAC (Message Authentication Code). The algorithm to compute a MAC uses two inputs: the key and the message. The output is a fixed length string of hexadecimal digits. The MAC is computed using the key (or half of a key pair) and both the MAC and the message are subsequently sent. The receiving party will also use the message to calculate the MAC with the shared key or the other half of the key pair. If both hashes match there is a very high certainty the message has not been altered and that it originates from the sender. Note that when you use a MAC the message itself will not be encrypted, it can be read by anybody.</p> <p>DNSSEC signs its messages with a MAC. It uses a private key that is only known to DNSSEC. The corresponding public key is published on the nameservers of the next level zone. It can be obtained by querying the parent domain nameservers (the 'trust anchor'). So the public key for example of the <code>sidn.nl</code> domain will be available on the 'nl' nameservers. The public key itself in turn will be signed using a private key whose public key will be available on the next level above. So for the domain a.b.c the public keys of \"a\" can be found on the zone server for \"b\". The public keys are signed with the private key whose public key is published on the nameservers of \"c\" (You may want to read that sentence again ;-) ).</p> <p>Eventually the verification chain ends at the root servers. To obtain the keys used to sign the top level domains the <code>dig</code> could be used but of course, the query might be also be spoofed. Therefore serious validating resolvers obtain the keys by other means. For instance by retrieving them from a signed software package, similarly to the built-in SSL root certificates in browsers.</p>"},{"location":"lpic2.207.3/#using-the-dnssec-keygen-command","title":"Using the <code>dnssec-keygen</code> command","text":"<p>According to the lpic2 objective you must be able to use BIND 9's <code>dnssec-keygen</code>.</p> <p>Note The <code>dnssec-keygen</code> command is part of the DNSSEC security extension for DNS (fully described in ???).</p> <p>DNSSEC was not fully implemented in BIND versions older than 9.2.</p> <p>The 13 authoritive root servers use DNSSEC since May 6<sup>th</sup> 2010.</p> <p>The <code>dnssec-keygen</code> may be used to generate public/private and symmetric keys. See CrashCryptoCourse. The key pairs are meant to be used to authenticate zone data. The symmetric keys are for Request/Transaction signatures.</p> <p>The required parameters for generating a key:</p> <p>a algorithm (<code>-a</code> option)</p> <ul> <li>RSA | RSAMD5 | DH | DSA | RSASHA1 | HMAC-MD5</li> </ul> <p>a key size (<code>-b</code> option)</p> <ul> <li>Depends on chosen algorithm: RSAMD5: [512..4096], RSASHA1:     [512..4096], DH: [128..4096], DSA: [512..1024] and a multiple     of 64, HMAC-MD5: [1..512]</li> </ul> <p>a nametype (<code>-n</code> option)</p> <ul> <li>ZONE | HOST | ENTITY | USER | OTHER</li> </ul>"},{"location":"lpic2.207.3/#format-of-the-key-files","title":"Format of the key files","text":"<p><code>dnssec-keygen</code> creates two files: <code>K</code>name<code>+</code>algorithm<code>+</code>footprint<code>.private</code> and <code>K</code>name<code>+</code>algorithm<code>+</code>footprint<code>.key</code>.</p> <p>As an example, say we typed this command:</p> <pre><code>    $ dnssec-keygen -a DSA -b 768 -n ZONE example.com.\n</code></pre> <p>After completion there will be two files, which have names similar to <code>Kexample.com.+003+58649.key</code> and <code>Kexample.com.+003+58649.private</code>.</p> <p>The private key file <code>Kkey.example.com.+003+58649.private</code> will have contents similar to this:</p> <pre><code>    Private-key-format: v1.2\n    Algorithm: 3 (DSA)\n    Prime(p): ww4 ..\n    Subprime(q): qHwn .. \n    Base(g): ncWqWFJ ... \n    Private_value(x): YuO ...\n    Public_value(y): JKvGZ ...\n</code></pre> <p>Note that lines that have been truncated for better readability end in an ellipsis.</p> <p>The contents of <code>Kkey.example.com.+003+58649.key</code> will be similar to this:</p> <pre><code>    example.com. IN DNSKEY 256 3 3 BKh8J+a ...\n</code></pre> <p>Please note that generation of a HMAC-MD5 generates two files too, but both will contain the exact same 'key':</p> <pre><code>    $ dnssec-keygen -a HMAC-MD5 -b 512 -n HOST peek.a.boo\n    Kpeek.a.boo.+157+39506\n\n    $ ls Kpeek.a.boo.+157+39506.*\n    Kpeek.a.boo.+157+39506.key  Kpeek.a.boo.+157+39506.private\n\n    $ cat Kpeek.a.boo.+157+39506.key\n    peek.a.boo. IN KEY 512 3 157 HUcmGO7VZ ...\n\n    $ cat Kpeek.a.boo.+157+39506.private\n    Private-key-format: v1.2\n    Algorithm: 157 (HMAC_MD5)\n    Key: HUcmGO7VZ ...\n</code></pre>"},{"location":"lpic2.207.3/#using-the-key","title":"Using the key","text":"<p>You can refer to a key by adding a <code>key</code> statement in <code>named.conf</code>, and copy and paste the key you generated in that section:</p> <pre><code>    key key.example.com. {\n        algorithm \"hmac-md5\";\n        secret \"5HUcmGO7VZ ...\";\n    };\n</code></pre> <p>The key can be read (and possibly misused) by anybody who has access rights to the <code>named.conf</code> file. Make sure it can not be read by anybody but the nameserver user.</p> <p>You can also put the key statement in a separate file and include that file using the <code>include</code> statement. In this case the same warning applies with regard to permissions.</p> <p>To allow a client to use the key to connect to us we need to add a <code>server</code> clause in our configuration. Say we are on a server which has IP address <code>224.123.400.2</code> and want to allow access for a server with IP address <code>224.123.400.1</code> we may use:</p> <pre><code>    server 224.123.400.1 {\n        keys key.example.com.;\n    };\n</code></pre> <p>On the other server (<code>224.123.400.1</code>) we need to do the same for server <code>224.123.400.2</code>: add the <code>key</code> statement and copy in the key and allow the other host to connect to us.</p> <p>You can now configure the types of access that are allowed when one has a key. As an example, to limit zone-transfers to hosts that have the proper keys installed, use:</p> <pre><code>    zone \"example.com\" {\n        type master;\n        file \"example.com.zone\";\n        allow-transfer { key key.example.com.; };\n    };\n</code></pre> <p>See the <code>named.conf(5)</code> manual page for additional use cases.</p> <p>dnssec-signzone {#dnssecsignzone}</p> <p>DNSdnssec-keygen DNSdnssec-signzone Similar to the <code>dnssec-keygen</code> command, BIND 9 includes the <code>dnssec-signzone</code> utility. As its name implies <code>dnssec-signzone</code> can be used to sign a zone. We already saw how keys are used to authorize servers. Signing a zone helps a client to verify the integrity of the data.</p> <p>DNS RRSIG When using DNSSEC, so called <code>RRSIG</code> records store the actual digital signatures that were created while signing the resource records for a domain using a <code>dnskey</code>.</p> <p>The <code>dnssec-signzone</code> utility can be used to add RRSIG records to zones.</p> <p>DNSNSEC <code>NSEC</code> records (<code>Next SECure</code>) are used to specify a range of non-existing domains. NSEC records were invented to solve a problem: if you queried a secured nameserver (one that signs the results of a query) and you would ask for a non-existing name, it would simply return - nothing. As you can't sign 'nothing' you would never know if the anwer you got - nothing - really is what you should have gotten. Hence NSEC records. A NSEC record (Next SECure) states a range of names that do not exist. As NSEC records can be signed the answer can be trusted again.</p> <p>An Example of an NSEC record for the dnssec-tools.org domain:</p> <pre><code>    adonis.zonetransfer.me.       10800   IN      NSEC   helena.zonetransfer.me.\n</code></pre> <p>The record specifies that no DNS records exist between <code>adonis.zonetransfer.me.</code> and <code>helena.zonetransfer.me.</code>, which would exclude <code>brutus.zonetransfer.me.</code> from being an existing and therefore valid domain.</p> <p>Use of NSEC records solves one problem, but introduces the next: it allows easy retrieval of all zone data by simply asking for a random name. This works because NSEC records assume alphabetical ordering of domain names. An example: if you would request 'a.example.com' and the answer would be 'do not have it, but the next valid record is joe.example.com', you know that joe.example.com exists and nothing before it does. So, then you might try jof.example.com, as 'f' is the next letter in the alphabet, etc. A solution to solve this problem is the NSEC3 record. The NSEC3 record is actually a NSEC record too but it will not return the next name, but the hash of the next name. If you ask for a.example.com you will get a record that says 'not here, and this is the hash of the next valid domain name'. There are no known methods - other than brute force - to find a name that matches that hash. If you already know the next valid domain name, you can calculate its hash and verify the answer. If you do not, the data will not help you to find out.</p>"},{"location":"lpic2.207.3/#dane","title":"DANE","text":"<p>After having set up DNSSEC for a certain domain, it is possible to make use of DNS Authenticated Named Entities: DANE. In order to understand the advantage of DANE, we need to look at the problem DANE is trying to address. And this problem involves Certificate Authorities, or CA's in short.</p> <p>The problem with CA-dependant encryption solutions lies in the implementation. When visiting a SSL/TLS Encrypted website via HTTPS, the browser software will gladly accept ANY certificate that uses a matching CN value AND is considered as being issued by a valid Certificate Authority. The CN value is dependent on DNS, and luckily we just set up DNSSEC to have some assurence regarding that. But, modern browsers come with over 1000 trusted root certificates. Every certificate being presented to the browser by a webserver, will be validated using these root certificates. If the presented certificate can be correlated to one of the root certificates, the science matches and the browser will not complain. And that's a problem.</p> <p>In a perfect world, this system could provide some assurance. Unfortunately, every chain is only as strong as it's weakest link. Many known attack vectors exist in regards to integrity and confidentiality of HTTPS sessions. The Certificate Authorities are in a league of their own though. Just as every CA needs to be in control of their security 100% of the time, an attacker only needs one moment one CA is not. If an attacker gets hold of one of the keys used to sign certificates, it is Game Over[tm]. This has happened in the past, and there is no assurence it will not happen again in the future.</p> <p>The problem consists of browsers accepting any valid certificate for any domain. And lack of control about exactly which certificates are valid for exactly what domain. There are a couple of workarounds out there like Certificate Transparency and Certificate Pinning. But for now, these remain to be workarounds for a flawed system. After all, the problem is not limited to your Desktop. The provided trust in CA-issued certificates becomes a problem when that CA cannot be trusted anymore. This has happened.</p> <p>The infamous \"Black Tulip\" case describes a breach that has occured at a Dutch CA called DigiNotar. Attackers gained access to systems and generated fake certificates for major websites. Except, these certificates were not recognized as fake since they had been generated by a trusted CA. The certificate chain could be backtraced to DigiNotar and seemed valid. Despite DigiNotar never having received the order or permission to generate certificates for the affected domains. After it was discovered that attackers had issued multiple DigiNotar certificates, the trust in DigiNotar as a CA could not be maintained. The affected CA root certificate was removed from the list of trusted certificates by many software vendors. DigiNotar filed for bankcrupcy within weeks.</p> <p>If that already sounds bad, consider the total impact of this data breach. Because certificates issued by DigiNotar were blacklisted as a result, software depending on valid certificates could no longer function properly. This had real-world consequences, since DigiNotar also issued certificates to government and trading related customers. The tulips could not be shipped and went black, so to say. For this reason, some large corporations that depend on their online presence for core business get their certificates from more than one CA. This way, if one CA gets compromised and all related certificates have to be revoked, that will not be a Single Point Of Failure to the business. Good for the business, not good for transparency in regards to certificates.</p> <p>This is where DANE comes in; While depending on the assurance provided by DNSSEC, DNS records are provided with certificate associating information. This mitigates the dependency regarding static root certificates for certain types of SSL/TLS connections. These records have come to be known as TLSA records. As with HTTPS, DANE should be implemented either correctly or better yet not at all. When implemented correctly, DANE will provide added integrity regarding the certificates being used for encryption. By doing so, the confidentiality aspect of the session gets a boost as well.</p> <p>The TLSA Resource Record syntax is described in RFC 6698 sections 2 and 7. An example of a SHA-256 hashed association of a PKIX CA Certificate taken from RFC 6698 looks as follows:</p> <pre><code>    _443._tcp.www.example.com. IN TLSA (\n          0 0 1 d2abde240d7cd3ee6b4b28c54df034b9\n                7983a1d16e8a410e4561cb106618e971 )\n</code></pre> <p>Each TLSA Resource Record (RR) specifies the following fields in order to create the certificate association: Certificate Usage, Selector, Matching Type and Certificate Association Data. The Certificate Association Data Field in the example above is represented by the SHA-256 hash string value. The contents of this Data Field are dependent on the values preceeding from the previous three RR fields. These three fields are represented by <code>'0 0 1'</code> in the example above. We will explain these fields in reverse order. This makes sense if you look at the hash value and then read the values from right to left as <code>'1 0 0'</code>.</p> <p>The value <code>'1'</code> in the third field from the example above represents the Matching Type field. This field can have a value between <code>'0'</code> and <code>'2'</code>. It specifies whether the Certification Association Data field contents are NOT hashed (value <code>0</code>), hashed using SHA-256 (value <code>1</code>) or hashed using SHA-512 (value <code>2</code>). In the example above, the contents of the Certificate Association Data field represent a SHA-256 hash string.</p> <p>The second field represented by a <code>'0'</code> represents the Selector Field. The TLSA Selectors are represented by either a <code>'0'</code> or a <code>'1'</code>. A field value of <code>'0'</code> indicates that the Certificate Association Data field contents are based on a full certificate. A value of <code>'1'</code> indicates that the contents of the Certificate Association Data Field are based on the Public Key of a certificate. In the example above, the Selector field indicates that the SHA-256 hash string from the Certificate Association Data field is based on a full certificate.</p> <p>The first field represented by a '0' in the example above represents the Certificate Usage field. This field may hold a value between '0' and '3'. A value of <code>'0'</code> (PKIX-TA) specifies that the Certificate Association Data field value is related to a public Certificate Authority from the X.509 tree. A value of <code>'1'</code> (PKIX-EE) specifies that the Certificate Association Data field value is related to the certificate on the endpoint you are connecting to, using X.509 validation. A value of <code>'2'</code> (DANE-TA) specifies that the Certificate Association Data field value is related to a private CA from the X.509 tree. And a value of <code>'3'</code> (DANE-EE) specifies that the Certificate Association Data field value is related to the certificate on the endpoint you are connecting to. In the example above, the Certificate Usage field indicates that the certificate the SHA-256 string is based on belongs to a public Certificate Authority from the X.509 tree. Those are the same Certificate authorities that your browser uses. Field values of <code>'0'</code>, <code>'1'</code> or <code>'2'</code> still depend on these CA root certificates. The true benefit of TLSA records gets unleashed when DNSSEC is properly configured and using a value of <code>'3'</code> as a value for the Certificate Usage Field.</p> <p>Looking back at the very start of the TLSA Resource Record example above, the syntax clearly follows the <code>_port._protocol.subject</code> syntax. The TLSA Resource Record always starts with an underscore '_'. Then the service port is defined (443 for HTTPS) and a transport protocol is specified. This can be either tcp, udp, or sctp according to RFC 6698. When generating TLSA records, it is also possible to specify dccp as a transport protocol. RFC 6698 does not explicitly mention dccp though. The subject field usually equals the servername and should match the CN value of the certificate.</p> <p>It is not mandatory for the LPIC-2 exam to know all these details by heart. But, it is good to have an understanding about the different options and their impact. Just as using a value of <code>'3'</code> as the Certificate Usage can have some security advantages, a value of <code>'0'</code> as the Matching Type field can result in fragmented DNS replies when complete certificates end up in TLSA Resource Records. The success of security comes with usability.</p> <p>To generate your own TLSA records, a page like the following can be used and should provide some insight in to the used parameters and values: www.huque.com/bin/gen_tlsa</p> <p>As much as the previously mentioned website is suitable for creating occasional TLSA records, there are circumstances when custom tooling is more appropriate. The <code>hashslinger</code> command-line tool has been developed to ease the creation of TLSA records.</p> <p>When implemented correctly and supported widely, DANE has the potential to secure certificate based encryption for a variety of services.</p>"},{"location":"lpic2.207.3/#internal-dns","title":"Internal DNS","text":"<p>If your organization uses TCP/IP on its internal networks NDASH a very common situation nowadays NDASH they will also need a method to locally resolve hostnames into IP addresses and vice versa. In smaller organizations whose infrastructure typically does not change much over time they might use static files (hostfiles), but given the low break-even point between the costs of maintaining such an infrastructure and the costs of installing and maintaining your own DNS most organizations run an internal DNS system.</p> <p>In simpler setups, only one nameserver may suffice, though given the low costs involved nameservers will often be installed in pairs. Resolvers aware of more than one nameserver will query the other server if the primary server does not respond. If you have a number of divisions and various interconnected networks your setup will start resembling the Internet. But there are important differences.</p> <p>Suppose your division is located outside the firm's main building. The workgroup will have its own nameservers. Internally, hosts will be members of the <code>exworks</code> (short for bindexworks exampleworks) domain, that is, directly under the root (<code>.</code>) domain. To prevent accidental routing on the Internet the company chooses the use of one of the non-routable (private) IP networks: <code>192.168.72</code>. This implies we need to maintain both the domain zone and the reverse lookup zone <code>72.168.192.in-addr.arpa</code>.</p> <p>We can't use the Internet infrastructure as their root nameservers don't know anything about the <code>exworks</code> and <code>72.168.192.in-addr.arpa</code> zones, nor should they: we chose to use a private network after all. If we also like to be able to resolve real Internet hostnames and addresses, we can use what is known as a split-level DNS setup. split-level DNS Two split-level DNS setups will be shown.</p>"},{"location":"lpic2.207.3/#limiting-negotiations","title":"Limiting negotiations","text":"<p>We can use a feature introduced into BIND in the days of dial-up connections. BIND behind a dial-up connection can be a nuisance: every time a DNS wants to communicate with a root nameserver, an automatic dialer sets up a connection. This is expensive. You can stop BIND from doing this by putting bindheartbeat-interval</p> <pre><code>    // prevent dialup access\n    heartbeat-interval 0;\n    dialup yes; // Actually disables dialup!\n</code></pre> <p>inside the <code>options</code> statement of the <code>named.conf</code> file. It is a bit counterintuitive to have to put <code>dialup yes</code> in a configuration actually meant to prevent dialups, but that's the way to do it.</p> <p>This trick can also be used to limit communication from an internal zone like <code>exworks</code>. The <code>exworks</code> and <code>72.168.192.in-addr.arpa</code> zones are implemented as conventional master zones as described earlier in this chapter. The fundamental problem with this is that the real root servers still don't delegate the <code>exworks</code> (and corresponding reverse) domain.</p> <p>Therefore we should pull the internal zones together with the root nameserver definition into a separate DNS implementation. This requires at least two independent nameservers, and they can be set up in two different ways, as will be described below.</p>"},{"location":"lpic2.207.3/#split-dns-stand-alone-internal-master","title":"Split DNS: stand-alone internal master","text":"<p>The first approach consists of a stand-alone nameserver (that is, bind stand-alone master master for the internal zones) and another nameserver on another host that can be used to resolve names from both the outside world and the internal zones.</p> <p>The figure below presents the <code>exworks</code> domain that is used as an example. </p> <p></p> <p>The <code>exworks</code> network.</p> <p>The two nameservers in this example will be on different hosts. The first nameserver runs on <code>privdns</code> and will provide internal zone information. The other nameserver is on <code>liongate</code>, which will be a forwarding nameserver for both the internal zones and the outside world.</p> <p>The host <code>privdns</code> (for private DNS) will contain the DNS for both the <code>exworks</code> and <code>72.168.192.in-addr.arpa</code> zones. This nameserver will have the following characteristics:</p> <ul> <li> <p>it will be master for the root domain, but no DNS except itself will     be able to access this information</p> </li> <li> <p>it will be master for the the <code>exworks</code> and     <code>72.168.192.in-addr.arpa</code> domains. Only other nameservers inside the     building will be able to access this information</p> </li> </ul> <p>On the other hand, <code>liongate</code> will do the following:</p> <ul> <li> <p>do forwarding for the internal zones (this should be done first)</p> </li> <li> <p>do forwarding for the outside world</p> </li> </ul>"},{"location":"lpic2.207.3/#DNSinternalMaster","title":"Configuring the master on <code>privdns</code>","text":"<p>First, prepare a master file for the internal root zone. For example:</p> <pre><code>    $TTL 25h\n    .       IN  SOA privdns.exworks. postmaster.privdns.exworks. (\n                2001121000    ; yyyymmhhee (ee == ser/day start 00)\n                     28800\n                      3600\n                    604800\n                     86400 )\n            IN  NS privdns.exworks.\n    privdns.exworks. IN  A  192.168.72.2\n\n    ; glue records\n    exworks.                 IN NS privdns.exworks.\n    72.168.192.in-addr.arpa. IN NS privdns.exworks.\n</code></pre> <p>Note the glue records that delegate the <code>exworks</code> and <code>72.168.192.in-addr.arpa</code> zones as being hosted on nameserver 192.168.72.2.</p> <p>Next, add a <code>zone</code> statement in <code>named.conf</code> that points to the master file for the root zone:</p> <pre><code>    // ROOT MASTER zone for internal DNS server\n    zone \".\" IN {\n        type master;\n        file \"/etc/bind/internal.root.zone\";\n        allow-transfer { none; };\n        allow-query    { none; };\n    };\n</code></pre> <p>Using the type <code>master</code> tells the DNS that this really is a master server for the root zone. The root zone should not be known to any other nameservers, therefore the <code>allow-transfer</code> and bind allow-transfer bind allow-query <code>allow-query</code> are set to <code>none</code>.</p> <p>Note The root zone definition type <code>hint</code>, as present in a default caching-only server, should be turned off (by not including it in the <code>named.conf</code> file).</p> <p>Now, prepare zone files for the <code>exworks</code> and <code>72.168.192.in-addr.arpa</code> zones, and add the corresponding <code>zone</code> entries in the <code>named.conf</code> file. The entry for <code>exworks</code> should look like this:</p> <pre><code>    zone \"exworks\" IN {\n        type master;\n        file \"/etc/bind/exworks.zone\";\n        allow-transfer { none; };\n        allow-query    { 192.168.72.1; }; // liongate\n    };\n</code></pre> <p>The nameserver on <code>liongate</code> is the one providing names to the other hosts, so the IP address of <code>liongate</code> must be listed in the <code>allow-query</code> field.</p> <p>The same must be done for the corresponding reverse zone.</p> <p>Make sure the <code>options</code> statement contains</p> <pre><code>    recursion no;\n    fetch-glue no;\n</code></pre> <p>These statements tell the nameserver it should not accept queries for zones other than the ones it knows about.</p> <p>Hosts in the <code>exworks</code> zone should point their <code>resolv.conf</code> to <code>liongate</code>. bind resolv.conf That is, the file should contain the line:</p> <pre><code>    nameserver 192.168.72.1\n</code></pre> <p>where <code>192.168.72.1</code> is the IP address of <code>liongate</code>. On <code>liongate</code> itself, however,</p> <pre><code>    nameserver 127.0.0.1\n</code></pre> <p>ensures that local queries are run over the local loop interface, which is more efficient than using the outside IP address.</p> <p>Note The entries in <code>resolv.conf</code> on <code>privdns</code> should not point to the nameserver on <code>privdns</code> itself. If the host is to be used for purposes that require name resolving, it is better to point the entries to the nameserver on <code>liongate</code>.</p>"},{"location":"lpic2.207.3/#configuring-dns-on-liongate","title":"Configuring DNS on <code>liongate</code>","text":"<p>The functionality of the DNS is twofold: first it should resolve names of the <code>exworks</code> zone (and corresponding reverse zone), secondly, it should resolve names from the outside world.</p> <p>With the following <code>forwarders</code> statement queries bind forwarders to this nameserver are being forwarded to one on the listed IP addresses (remember that <code>forwarders</code> is part of the <code>options</code> statement):</p> <pre><code>    forwarders {\n        192.168.72.2;   // privdns\n        224.121.121.99; // ISP's DNS\n    };\n</code></pre> <p>The nameservers are tried in the order in which they are listed. Requests are forwarded to <code>privdns</code> first. If that one does not have the answer, the DNS of the ISP is contacted instead.</p> <p>Note that the IP address of <code>privdns</code> should be mentioned first: we don't want requests for internal names be sent to the ISP.</p> <p>Alternatively, the nameserver on <code>liongate</code> can be configured as <code>slave</code> for the <code>exworks</code> domain and corresponding reverse domain. We will discuss this in the next section.</p>"},{"location":"lpic2.207.3/#alternatives","title":"Alternatives","text":"<p>There are two alternatives to this setup. Both require two separate nameservers.</p> <p>The first alternative is to use two <code>nameserver</code> statements in <code>resolv.conf</code>:</p> <pre><code>    nameserver 192.168.72.2\n    nameserver 192.168.72.1\n</code></pre> <p>The first IP address points to <code>privdns</code>, the second to <code>liongate</code>. In this situation, <code>privdns</code> should also accept queries from <code>192.168.72.0/24</code> and the <code>forwarders</code> statement on <code>liongate</code> should not contain the <code>192.168.72.2</code> (the IP address of <code>privdns</code>). The downside of this is that there is no single nameserver entry-point.</p> <p>The second alternative is to use a <code>slave</code> setup bind slave for the <code>exworks</code> (plus corresponding reverse) domain. This situation is required when two nameservers are running on the same host. This will be elaborated below, so it will not be discussed here. For this to work, the <code>forwarders</code> statement on <code>liongate</code> should not contain the IP address of <code>privdns</code>.</p>"},{"location":"lpic2.207.3/#split-dns-two-dns-servers-on-one-machine","title":"Split DNS: two DNS servers on one machine","text":"<p>We assume the same network again but with one important Split DNS difference: host <code>privdns</code> is not available. This implies that the internal nameserver must now run on one of the other hosts, which also needs access to the outside world.</p> <p>Both nameservers will run on the same host. At least one of the nameservers must run chrooted. bind chrooted</p>"},{"location":"lpic2.207.3/#two-nameservers-on-one-host","title":"Two nameservers on one host","text":"<p>The following settings must be made:</p> <ul> <li> <p>The internal nameserver.</p> <p>There is a master nameserver that serves the <code>exworks</code> and corresponding reverse domains. It runs chrooted, under its own uid/gid, listening at a special port. It will not do any other resolver work. This nameserver will be referred to as the internal nameserver.</p> </li> <li> <p>The visible nameserver.</p> <p>The other nameserver does not need to run chrooted, but it does have its own uid/gid. It serves as a <code>slave</code> for the <code>exworks</code> and <code>72.168.192.in-addr.arpa</code> domains. It also forwards other requests to the ISP. This nameserver will be referred to as the visible nameserver, since this is the nameserver that will be visible to other hosts.</p> </li> </ul> <p>The <code>nameserver</code> line in the <code>resolv.conf</code> file for the visible nameserver points to <code>127.0.0.1</code>; other hosts in the <code>exworks</code> domain point their resolver to <code>192.168.72.1</code> (the IP address of <code>liongate</code>).</p>"},{"location":"lpic2.207.3/#configuring-the-internal-nameserver","title":"Configuring the internal nameserver","text":"<p>The nameserver is put into a chroot jail with his own user and group bind jail ID's. The nameserver will chroot to <code>/var/cache/bindInternal</code>. It will run, for example, as user <code>inamed</code> with UID <code>5301</code> and as group with the same name and GID <code>5301</code>.</p> <p>This chrooted nameserver should be able to write to some directories. To allow this, these directories should be owned by the <code>inamed</code> UID and GID. The directories (inside the chroot jail) that need this are <code>/var/run</code> (because it needs to write <code>named.pid</code>) and bind named.pid <code>/var/cache/bind</code> (because it needs to write e.g. a logfile).</p> <p>The configuration directory will be <code>/var/cache/bindInternal/etc/bind</code>, so that references from the <code>named.conf</code> file in that directory will be to <code>/etc/bind</code>. Files in that directory include the master file for the root zone and the zone files for both the <code>exworks</code> and <code>72.168.192.in-addr.arpa</code> domains.</p> <p>Here are the three master zone definitions:</p> <pre><code>    options {\n        directory \"/var/cache/bind\";\n        listen-on port 5353 { 127.0.0.1; };\n        recursion no;\n        fetch-glue no;\n    };\n\n    // NOT SHOWN HERE, described elsewhere:\n    // - special chroot logging, see above\n    // - zones \"localhost\", \"127.in-addr.arpa\", \"0.in-addr.arpa\" and\n    //   \"255.in-addr.arpa\" as usual\n\n    // ROOT MASTER for internal DNS server\n    zone \".\" IN {\n        type master;\n        file \"/etc/bind/internal.root.zone\";\n        allow-transfer { none; };\n        allow-query    { none; };\n    };\n    // NO root zone, type hint definition!\n\n    // EXWORKS ZONES\n    zone \"exworks\" IN {\n        type master;\n        file \"/etc/bind/exworks.zone\";\n        allow-transfer { 127.0.0.1; };\n        allow-query    { 127.0.0.1; };\n    };\n\n    zone \"72.168.192.in-addr.arpa\" IN {\n        type master;\n        file \"/etc/bind/exworks.rev\";\n        allow-transfer { 127.0.0.1; };\n        allow-query    { 127.0.0.1; };\n    };\n</code></pre> <p>The <code>directory</code> refers to a location inside the chrooted tree. The <code>listen-on</code> specifies that this nameserver should only listen on port <code>5353</code> on the internal address <code>127.0.0.1</code>. The other two, <code>recursion</code> and <code>fetch-glue</code>, prevent resolving anything except bind fetch-glue bind recursion the zones that were defined here.</p> <p>The root zone should does not allow queries and transfers, as it is meant for local use only.</p> <p>The <code>exworks</code> and <code>72.168.192.in-addr.arpa</code> zone definitions allow zone transfers and queries originated from the other nameserver (the visible one). No other transfers and queries are allowed for these zones.</p>"},{"location":"lpic2.207.3/#configuring-the-visible-nameserver","title":"Configuring the visible nameserver","text":"<p>This section will describe how to configure the visible nameserver (if in doubt read Two nameservers on one host again). Remember it does not run chrooted, nor does it use an alternate port. It does run under its own UID/GID though.</p> <p>The visible nameserver should be able to answer queries about both the inside and outside worlds.</p> <p>Note The visible nameserver on <code>liongate</code> could use forwarding to connect to the internal nameserver, given the software allows you to specify a port.</p> <p>The <code>named.conf</code> for the visible nameserver, with common parts omitted, looks like this:</p> <pre><code>    // /etc/bind/named.conf\n    // bind visible configuration on liongate\n\n    options {\n        directory \"/var/cache/bindVisible\";\n\n        // point to the ISP's nameserver for outside world\n        forwarders {\n            224.121.121.99; // ISP's DNS\n        };\n    };\n\n    // NOT SHOWN HERE, described elsewhere:\n    // - logging as usual\n    // - root zone type hint as usual\n    // - zones \"localhost\", \"127.in-addr.arpa\", \"0.in-addr.arpa\" and\n    //   \"255.in-addr.arpa\" as usual\n\n    // point to port 5353 for these zones, be slave for both\n    zone \"exworks\" IN {\n        type slave;\n        masters port 5353 { 127.0.0.1; };\n        file \"exworks.slave\";\n        allow-transfer { none; };\n        allow-query    { 127.0.0.1; 192.168.72.0/24; };\n    };\n\n    zone \"72.168.192.in-addr.arpa\" IN {\n        type slave;\n        masters port 5353 { 127.0.0.1; };\n        file \"72.168.192.in-addr.arpa.slave\";\n        allow-transfer { none; };\n        allow-query    { 127.0.0.1; 192.168.72.0/24; };\n    };\n</code></pre> <p>This implements:</p> <ul> <li> <p>a nameserver to perform slave resolving for the <code>exworks</code> and     <code>72.168.192.in-addr.arpa</code> zones.</p> </li> <li> <p>forwarding, to resolve names from the outside world.</p> </li> </ul> <p>The directory specified by the <code>directory</code> statement must be writable by the running nameserver. I.e. if the nameserver runs as user <code>vnamed</code> and group <code>vnamed</code>, the directory <code>/var/cache/bindVisible</code> must be owned by user <code>vnamed</code> and group <code>vnamed</code>. The slave files <code>exworks.slave</code> and <code>72.168.192.in-addr.arpa.slave</code> will be put there.</p> <p>Let's look at the slave zone definitions. Both refer to a master at port <code>5353</code> on the same host. Both definitions do not allow full zone transfers. The only zone transfers are from master (at port 5353) to slave (the configuration for the master allows this, see Configuring the master on ). Normal queries are allowed for the localhost (<code>127.0.0.1</code>, i.e., internal connections on <code>liongate</code>), as well as all hosts in the <code>exworks</code> zone (<code>192.168.72.</code>x).</p> <p>On <code>liongate</code> the <code>resolv.conf</code> file will contain</p> <pre><code>    nameserver 127.0.0.1\n</code></pre> <p>that is, it points to the visible nameserver which listens on port <code>53</code>. Other hosts in the <code>exworks</code> domain will have</p> <pre><code>    nameserver 192.168.72.1\n</code></pre> <p>(the IP address of <code>liongate</code>) in their <code>resolv.conf</code>.</p> <p>Note It is not possible to specify a portnumber in <code>resolv.conf</code>. The specified nameserver(s) will be contacted at port <code>53</code>.</p>"},{"location":"lpic2.207.3/#a-problem","title":"A problem","text":"<p>A master nameserver will send a notify message to a slave nameserver whenever a zone definition changes. This causes the slave to initiate a zone transfer. But as both servers listen on the same IP address, the only thing to distinct them are their port numbers. Alas you can't specify a port number in a <code>also-notify</code> statement, so there is no way to notify the slave if the master data has changed.</p> <p>There is a simple solution to this problem: if the master zone changes and after the internal nameserver has reloaded the zone data, restart the visible nameserver too.</p> <p>Linux supports binding more than one IP address to a network interface. Another approach would be to give both servers a unique local IP address. This involves other configuration changes, which by now you should be able to manage. Therefore the exercise on how to do this is left to the reader.</p>"},{"location":"lpic2.207.3/#tsig","title":"TSIG","text":"<p>TSIG (Transaction SIGnatures) provides a secured communication channel between nameservers for zone transfers. It is a resource friendly add-on, available in BIND version 8.2 and higher.</p> <p>TSIG uses shared keys and one-way hashing to provide authenticity and integrity. See CrashCryptoCourse for a short introduction to these concepts.</p>"},{"location":"lpic2.207.3/#configuring-tsig-for-bind","title":"Configuring TSIG for BIND","text":"<p>We need a HMAC-MD55 key pair, which can be generated using the now familiar <code>dnssec-keygen</code> command:</p> <pre><code>    # dnssec-keygen -a HMAC-MD5 -b 512 -n HOST rndc-key\n    Krndc-key.+157+24876\n</code></pre> <p>The utility will generate two output files. Note that the keys in both files will always be duplicates as we required a HMAC-MD5.</p> <pre><code>    # ls -l Krndc-key.+157+24876*\n    -rw------- 1 root bind 117 Jul  5 05:28 Krndc-key.+157+24876.key\n    -rw------- 1 root bind 229 Jul  5 05:28 Krndc-key.+157+24876.private\n</code></pre> <p>The contents of the private keyfile might be similar to this:</p> <pre><code>    # cat Krndc-key.+157+24876.private \n    Private-key-format: v1.3\n    Algorithm: 157 (HMAC_MD5)\n    Key: XIQDYlGaIbWfyopYHS1vtFrlfJiiIkiEbiNj4kN8Ke+F0hEqA7KVwcJMR/6URez32XBEmKZf2W1GUzjpbI2KJQ==\n    Bits: AAA=\n    Created: 20130705102726\n    Publish: 20130705102726\n    Activate: 20130705102726\n</code></pre> <p>Create a file to hold the secret you just generated and the IP addresses of slave nameservers. The name of the file can be freely chosen, in this example <code>tsig.key</code> will be used. The syntax of this file can be learned from this example:</p> <pre><code>    key \"TRANSFER\" {\n        algorithm hmac-md5;\n        secret \"XIQDYlGaIbWfyopYHS1vtFrlfJiiIkiEbiNj4kN8Ke+F0hEqA7KVwcJMR/6URez32XBEmKZf2W1GUzjpbI2KJQ==\";\n    };\n\n    # nameserver 2 (slave)\n    server 10.0.1.2 {\n        keys { TRANSFER; };\n    };\n\n    # nameserver 3 (slave)\n    server 10.0.1.3 {\n        keys { TRANSFER; };\n    };\n</code></pre> <p>Note: the server option points to the slave nameserver.</p> <p>Edit the BIND main configuration file <code>named.conf</code> and include the file like this:</p> <pre><code>    include \"/etc/bind/tsig.key\";\n</code></pre> <p>Now, reload the BIND configuration:</p> <pre><code>    # rndc reload\n    server reload successful\n</code></pre> <p>Use <code>rndc tsig-list</code> to list the currently active TSIG keys. This completes the configuration on the master. Next we will need to configure the slaves.</p> <p>To setup the slave nameserver, create a similar <code>tsig.key</code> file there, that contains the same secret as used on the master nameserver. However, now make the <code>server</code> option point to the master nameserver:</p> <pre><code>    key \"TRANSFER\" {\n        algorithm hmac-sha1;\n        secret \"XIQDYlGaIbWfyopYHS1vtFrlfJiiIkiEbiNj4kN8Ke+F0hEqA7KVwcJMR/6URez32XBEmKZf2W1GUzjpbI2KJQ==\";\n    };\n\n    # nameserver 1 (master)\n    server 10.0.1.1 {\n        keys { TRANSFER; };\n    };\n</code></pre> <p>As before, include the path to the <code>tsig.key</code> file to the BIND main configuration file and reload the configuration. TSIG is now enabled.</p>"},{"location":"lpic2.208.0/","title":"HTTP Services (208)","text":"<p>This topic has a weight of 11 points and contains the following objectives:</p>"},{"location":"lpic2.208.0/#objective-2081-basic-apache-configuration-4-points","title":"Objective 208.1; Basic Apache Configuration (4 points)","text":"<ul> <li>Candidates should be able to install and configure a web server.     This objective includes monitoring the server's load and     performance, restricting client user access, configuring support for     scripting languages as modules and setting up client user     authentication. Also included is configuring server options to     restrict usage of resources. Candidates should be able to configure     a web server to use virtual hosts and customize file access.</li> </ul>"},{"location":"lpic2.208.0/#objective-2082-apache-configuration-for-https-3-points","title":"Objective 208.2; Apache configuration for HTTPS (3 points)","text":"<ul> <li>Candidates should be able to configure a web server to provide     HTTPS.</li> </ul> <p>Objective 208.3; Implementing Squid as a caching proxy (2 points)</p> <ul> <li>Candidates should be able to install and configure a proxy server,     including access policies, authentication and resource usage.</li> </ul> <p>Objective 208.4; Implementing Nginx as a web server and a reverse proxy (2 points)</p> <ul> <li>Candidates should be able to install and configure a reverse proxy     server, Nginx. Basic configuration of Nginx as a HTTP server is     included.</li> </ul>"},{"location":"lpic2.208.1/","title":"Basic Apache Configuration (208.1)","text":""},{"location":"lpic2.208.1/#basic-apache-configuration-2081","title":"Basic Apache Configuration (208.1)","text":"<p>Candidates should be able to install and configure a web server. This objective includes monitoring the server's load and performance, restricting client user access, configuring support for scripting languages as modules and setting up client user authentication. Also included is configuring server options to restrict usage of resources. Candidates should be able to configure a web server to use virtual hosts and customise file access.</p>"},{"location":"lpic2.208.1/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Apache 2.x including 2.4 configuration files, terms and utilities</p> </li> <li> <p>Apache log files configuration and content</p> </li> <li> <p>Access restriction methods and files</p> </li> <li> <p>mod_perl and PHP configuration</p> </li> <li> <p>Client user authentication modules, files and utilities</p> </li> <li> <p>Configuration of maximum requests, minimum and maximim servers and clients</p> </li> <li> <p>Apache 2.x virtual host implementation (with and without dedicated IP addresses)</p> </li> <li> <p>Using redirect statements in Apache's configuration files to customise file access</p> </li> </ul>"},{"location":"lpic2.208.1/#terms-and-utilities","title":"Terms and utilities","text":"<ul> <li> <p><code>access.log</code> or <code>access_log</code></p> </li> <li> <p><code>error.log</code> or <code>error_log</code></p> </li> <li> <p><code>.htaccess</code></p> </li> <li> <p><code>httpd.conf</code></p> </li> <li> <p><code>mod_auth</code></p> </li> <li> <p><code>mod_authn_file</code></p> </li> <li> <p><code>mod_access_compat</code></p> </li> <li> <p><code>htpasswd</code></p> </li> <li> <p><code>AuthUserFile, AuthGroupFile</code></p> </li> <li> <p><code>apache2ctl</code></p> </li> <li> <p><code>httpd</code></p> </li> </ul>"},{"location":"lpic2.208.1/#installing-the-apache-web-server","title":"Installing the Apache web-server","text":"<p>Building Apache from source was routinely done when Apache emerged. Nowadays Apache is available in binary format for most modern (post 2005) Linux distributions. Installing programs from source is already covered in 206.1. Therefore, we will concentrate on working with rpm and apt package managers and tools during this chapter. Do not underestimate the importance of building Apache from source though. Depending on requirements and (lack of) availability, it might still be necessary to compile Apache and Apache modules from source. The Apache binary <code>httpd</code> can be invoked with certain command-line options that affect the behaviour of the server. But in general Apache is started by other scripts that serve as a wrapper for <code>httpd</code>. These scripts should take care of passing required flags to <code>httpd</code>. The behaviour of the server is configured by setting various options called <code>directives</code>. These <code>directives</code> are declared in configuration files. The location of configuration files and how they are organized varies. Red Hat and similar distributions have their configuration files in the <code>/etc/httpd/conf</code> directory. Other locations which are or have been used are <code>/etc/apache/config</code>, <code>/etc/httpd/config</code> and <code>/etc/apache2</code>.</p> <p>Depending on your Linux distribution and enabled repositories, your distribution may come with Apache 2.2 or Apache 2.4 or both. Apache 2.0 does comply to the LPIC-2 Apache 2.x scope due to its name, but Apache 2.0 is no longer maintained. It is therefore not recommended to use Apache 2.0. Instead, Apache 2.4 is recommended to be used by the Apache foundation. As a Linux administrator, you may however still encounter Apache 2.0 on servers. It is therefore recommended to familiarize yourself with the configuration differences between the different versions. The Apache foundation does provide guidence: Via https://httpd.apache.org/docs/ upgrade documents can be accessed that address the necessary steps when upgrading from Apache 2.0 to 2.2, and from Apache 2.2 to 2.4.</p> <p>It is important to distinguish between (global) directives that affect the Apache server processes, and options that affect a specific component of the Apache server, i.e. an option that only affects a specific website. The way the configuration files are layed out can often be a clue as to where which settings are configured. Despite this presumed obviousness, it is also important not to make assumptions. Always familiarize yourself with all the configured options. When in doubt about a specific option, use the documentation or a web search to find out more and consider whether the option is configured appropriately.</p> <p>On many (Red Hat based) distributions the main Apache configuration file is <code>httpd.conf</code>, other (Debian based) distributions favour the <code>apache2.conf</code> filename. Depending on your distribution and installation it might be one big file or a small generic one with references to other configuration files via <code>Include</code> and/or <code>IncludeOptional</code> statements. The difference between these two directives lies in the optional part. If Apache is configured to <code>Include</code> all <code>*.conf</code> files from a certain directory, there has to be at least one file that matches that pattern to include. Otherwise, the Apache server will fail to start. As an alternative, the <code>IncludeOptional</code> directive can be used to include configuration files if they are present and accessible. The Apache main configuration file can configure generic settings like servername, listening port(s) and which IP addresses these ports should be bound to. There may also be a seperate <code>ports.conf</code> configuration file though, so always follow the <code>Include</code> directives and familiarize yourself with the contents of all configuration files. The user and group Apache should run as can also be configured from the main configuration file. These accounts can be set to switch after startup. This way, the Apache software can be started as the root user, but then switch to a dedicated \"www\", \"httpd\" or \"apache\" user to adhere to the principle of least privilege. There are also various directives to influence the way Apache serves files from its document tree. For example there are <code>Directory</code> directives that control whether it is allowed to execute PHP files located in them. The default configuration file is meant to be self explanatory and contains a lot of valuable information. In regards to the LPIC-2 exam, you are required to be familiar with the most common Apache directives. We shall cover some of those in the section to come. At the time of this writing, Apache 2.4 is the latest stable version and the recommended version to use according to it's distributor, the Apache Foundation. Where applicable, this book will try to point out the differences between the various versions.</p> <p>An additional method to set options for a subdivision of the document tree is by means of an <code>.htaccess</code> file. For security reasons you will also need to enable the use of <code>.htaccess</code> files in the main configuration file by setting the <code>AllowOverride</code> directive for that <code>Directory</code> context. All options in an <code>.htaccess</code> file influence files in the directory and the ones below it, unless they are overridden by another <code>.htaccess</code> file or directives in the main configuration file.</p>"},{"location":"lpic2.208.1/#modularity","title":"Modularity","text":"<p>Apache has a modular source code architecture. You can custom build a server with only modules you really want. Many modules are available on the Internet and you could also write your own.</p> <p>Modules are compiled objects written in C. If you have questions about the development of Apache modules, join the Apache-modules mailing list at http://httpd.apache.org/lists.html. Remember to do your homework first: research past messages and check all the documentation on the Apache site before posting questions.</p> <p>Special modules exist for the use of interpreted languages like Perl and Tcl. They allow Apache to run interpreted scripts natively without having to reload an interpreter every time a script runs (e.g. <code>mod_perl</code> and <code>mod_tcl</code>). These modules include an API to allow for modules written in an interpreted (scripted) language.</p> <p>The modular structure of Apache's source code should not be confused with the functionality of run-time loading of Apache modules. Run-time modules are loaded after the core functionality of Apache has started and are a relatively new feature. In older versions, to use the functionality of a module, it needed to be compiled in during the build phase. Current implementations of Apache are capable of run-time module loading. The section on DSO has more details.</p>"},{"location":"lpic2.208.1/#DSO","title":"Run-time loading of modules (DSO)","text":"<p>Most modern Unix derivatives have a mechanism for the on demand linking and loading of so called Dynamic Shared Objects (DSO). This is a way to load a Dynamic Shared Objects special program into the address space of an executable at run-time. This can usually be done in two ways: either automatically by a system program called <code>ld.so</code> when the executable is started, or manually from within the executing program with the system calls <code>dlopen()</code> and <code>dlsym()</code>.</p> <p>In the latter method the DSO's are usually called shared objects or DSO files and can be named with an arbitrary extension. By convention the extension <code>.so</code> is used. These files are usually installed in a program-specific directory. The executable program manually loads the DSO at run-time into its address space via <code>dlopen()</code>.</p> <p>How to run Apache-SSL as a shareable (DSO) module: First of all, install the appropriate package:</p> <pre><code>    packagemanager installcommand modulename\n</code></pre> <p>Depending on your distribution, the configuration file(s) might or might not have been adjusted accordingly. Always check for the existence of a <code>LoadModule</code> line in one of the configuration files:</p> <pre><code>    LoadModule apache_ssl_module modules/libssl.so\n</code></pre> <p>This line might belong in the Apache main configuration file, or one of the included configuration files. A construction that has been receiving much support lately, is the use of seperate <code>modules-available</code> and <code>modules-enabled</code> directories. These directories are subdirectories inside the Apache configuration directory. Modules are installed in the <code>modules-available</code> directory, and an <code>Include</code> reference is made to a symbolic link inside the <code>modules-enabled</code> directory. This symbolic link then points back to the module. The <code>Include</code> reference might be a wildcard, including all files from a certain directory.</p> <p>Another construction is similar, but includes a <code>conf.modules.d</code> directory inside the Apache configuration directory. This file is in fact a symbolic link, pointing to a directory inside the Apache program directory somewhere else on the filesystem. An example from a Red Hat based host:</p> <pre><code>    Include conf.modules.d/*.conf\n</code></pre> <p>Again, the implementations you could encounter might differ significantly from each other. Various aspects such as Linux distribution used, Apache version installed or whether Apache is installed from packages or source may be of influence to the way Apache is implemented. Not to mention the administrator on duty. Important to remember is that Apache often uses configuration files that may be nested. But that there will always be one main Apache configuration file, at the top of the hiearchy.</p> <p>To see whether your version of Apache supports DSOs, execute the command <code>httpd -l</code> which lists the modules that have been compiled into Apache. If <code>mod_so.c</code> appears in the list of modules then your Apache server can make use of dyamic modules.</p>"},{"location":"lpic2.208.1/#apache-extension-apxs-support-tool","title":"APache eXtenSion (APXS) support tool","text":"<p>The APXS is a new support tool from Apache 1.3 and onwards which can be used to build an Apache module as a DSO outside the Apache source-tree. It knows the platform dependent build parameters for making DSO files and provides an easy way to run the build commands with them.</p>"},{"location":"lpic2.208.1/#monitoring-apache-load-and-performance","title":"Monitoring Apache load and performance","text":"<p>An Open Source system that can be used to periodically load-test pages of web-servers is Cricket. Cricket can be easily set up to record page-load times, and it has a web-based grapher that will generate charts to display the data in several formats. It is based on RRDtool (Round Robin Data Tool) whose ancestor is  MRTG (short MRTG for \"Multi-Router Traffic Grapher\"). RRDtool is a package that collects data in \"round robin\" databases; each data file is fixed in size so that running Cricket does not slowly fill up your disks. The database tables are sized when created and do not grow larger over time. As the data ages, it is averaged.</p>"},{"location":"lpic2.208.1/#enhancing-apache-performance","title":"Enhancing Apache performance","text":"<p>Lack of available RAM may result in memory swapping. A swapping webserver will perform badly, especially if the disk subsystem is not up to par. Causing users to hit stop and reload, further increasing the load. You can use the <code>MaxClients</code> setting to limit the amount of children your server may spawn hence reducing memory footprint. It is advised to <code>grep</code> through the Apache main configuration file for all directives that start with <code>Min</code> or <code>Max</code>. These settings define the MINimal and MAXimum boundaries for each affected setting. The default values should provide a concense balance between server load at idle on one hand, and the possibility to handle heavy load on the other. As each chain is only as strong as it's weakest link, the underlying system should be adequatetly configured to handle the expected load. The LPIC-2 exam focuses more on the detection of these performance bottlenecks in chapter 200.1.</p>"},{"location":"lpic2.208.1/#apache-access_log-file","title":"Apache <code>access_log</code> file","text":"<p>access logs The <code>access_log</code> contains a generic overview of page requests for your web-server. The format of the access log is highly configurable. The format is specified using a format string that looks much like a C-style <code>printf</code> format string. A typical configuration for the access log might look like the following:</p> <pre><code>    LogFormat \"%h %l %u %t \\\"%r\\\" %&gt;s %b\" common\n    CustomLog logs/access_log common\n</code></pre> <p>This defines the nickname common and associates it with a particular log format string. The format as shown is known as the Common Log Format (CLF). It is a standard format produced bymany web servers and can be read by most log analysis programs. Log file entries produced in CLF will look similar to this line:</p> <pre><code>    127.0.0.1 - bob [10/Oct/2000:13:55:36 -0100] \"GET /apache_pb.gif HTTP/1.0\" 200 2326\n</code></pre> <p>CLF contains the following fields:</p> <ol> <li> <p>IP address of the client (%h)</p> </li> <li> <p>RFC 1413 identity determined by <code>identd</code> (%l)</p> </li> <li> <p>userid of person requesting (%u)</p> </li> <li> <p>time server finished serving request (%t)</p> </li> <li> <p>request line of user (%r)</p> </li> <li> <p>status code servers sent to client (%s)</p> </li> <li> <p>size of object returned (%b).</p> </li> </ol>"},{"location":"lpic2.208.1/#apache-error_log-file","title":"Apache <code>error_log</code> file","text":"<p>The server error log, whose name and location is set by the ErrorLog directive, is a very important log file. This is the file to which Apache httpd will send diagnostic information and record any errors that it encounters in processing requests. It is a good place to look when a problem occurs starting the server or while operating the server. It will often contain details of what went wrong and how to fix it.</p> <p>The error log is usually written to a file (typically error_log on Unix systems and error.log on Windows). On Unix systems it is also possible to have the server send errors to syslog or pipe them to a program.</p> <p>The format of the error log is relatively free-form and descriptive. But there is certain information that is contained in most error log entries. For example, here is a typical message:</p> <pre><code>    [Wed Oct 11 14:32:52 2000] [error] [client 127.0.0.1] client denied by server \\\n    configuration: /export/home/live/ap/htdocs/test\n</code></pre> <p>The first item in the log entry is the date and time of the message. The second item lists the severity of the error being reported. The <code>LogLevel</code> directive is used to control the types of errors that are sent to the error log by restricting the severity level. The third item gives the IP address of the client that generated the error. Beyond that is the message itself, which in this case indicates that the server has been configured to deny the client access. The server reports the file-system path (as opposed to the web path) of the requested document.</p> <p>A very wide variety of different messages can appear in the error log. Most look similar to the example above. The error log will also contain debugging output from CGI scripts. Any information written to stderr by a CGI script will be copied directly to the error log.</p> <p>It is not possible to customize the error log by adding or removing information. However, error log entries dealing with particular requests have corresponding entries in the access log. For example, the above example entry corresponds to an access log entry with status code 403. Since it is possible to customize the access log, you can obtain more information about error conditions using that log file.</p> <p>During testing, it is often useful to continuously monitor the error log for any problems. On Unix systems, you can accomplish this using:</p> <pre><code>    tail -f error_log\n</code></pre> <p>Knowing how to customize Apache logging may prove to be a very usable skill. Manually reviewing Apache logs is not for the faint of heart. For a low-traffic server, this may still be doable. Otherwise, looking for information by sifting through logs on a busy server that serves multiple websites, can become a very intense textfile-manipulating-excercise. This creates a paradox: With little to no logging, hardly any input is available when looking for the cause of a problem. With very elaborate logging in place, the information may be overwhelming. For this reason, Apache logs are often interpreted by external facilities. The logs are either sent to or read by a system that has the capability to visualize statistics and recognize patterns. To ensure the provided logging is adequate, customizing the Apache logging first may be necessary.</p> <p>Apache 2.3.6 and later provide the possibility to enable different kinds of <code>LogLevel</code> configurations on a per-module or per-directory basis. The Apache documentation regarding the <code>Loglevel</code> directive is outstanding and there is not much we could add to that.</p>"},{"location":"lpic2.208.1/#restricting-client-user-access","title":"Restricting client user access","text":"<p>Many systems use either DAC or MAC to control access to objects:</p> <p>Discretionary Access Control (DAC)</p> <ul> <li>A system that employs DAC allows users to set object permissions     themselves. They can change these at their discretion.</li> </ul> <p>Mandatory Access Controls (MAC)</p> <ul> <li>A system that employs MAC has all its objects (e.g., files) under     strict control of a system administrator. Users are not allowed to     set any permissions themselves.</li> </ul> <p>Apache takes a liberal stance and defines discretionary controls to be controls based on usernames and passwords, and mandatory controls to be based on static or quasi-static data like the IP address of the requesting client.</p> <p>Apache uses modules to authenticate and authorise users. First of all, the difference between authentication and authorization should be clear. Authentication is the process in which a user should validate their identity. This is the who part. Authorization is the process of deciding who is allowed to do what. Authorization either allows or denies requests made to the Apache server. Authorization depends on authentication to make these decisions.</p> <p>The Apache modules that serve the purpose of autheNtication, follow the naming convention of <code>mod_authn_*</code>. The modules that serve the purpose of authoriZation, follow the convention of <code>mod_authz_*</code>. An exception to this rule is the <code>mod_authnz_ldap</code> module. As you might have guessed, due to the nature of LDAP this module can aid in both authentication as well as authorization.</p> <p>The location of these modules on the filesystem may vary. Most distributions create a <code>modules</code>, <code>modules.d</code> or <code>modules-available</code> directory within the Apache configuration directory. This directory can very well be a symbolic link to a directory somewhere else on the filesystem. This can be determined by invoking <code>pwd -P</code> or <code>ls -ld</code> from within the modules directory as shown by the following example:</p> <pre><code>    [user@redhatbased /etc/httpd]$ pwd -P\n    /usr/lib64/httpd/modules\n</code></pre> <p>In the example above, the symbolic link <code>/etc/httpd/modules</code> provides for easy reference to the modules from within Apache configuration files. Apache modules are loaded using the <code>LoadModule</code> directive. This directive expects the path to the module to be relative to the Apache configuration directory declared by the <code>ServerRoot</code> directive.</p> <p>In general, modules will use some form of database to store and retrieve credential data. The <code>mod_authn_file</code> module for instance uses text files where <code>mod_auth_dbm</code> employs a Unix DBM database.</p> <p>Below is a list of some modules that are included as part of the standard Apache distribution.</p> <p><code>mod_auth_file</code></p> <ul> <li>(DAC) This is the basis for most Apache security modules; it uses     ordinary text files for the authentication database.</li> </ul> <p><code>mod_access</code></p> <ul> <li>(MAC) This used to be the only module in the standard Apache     distribution which applies what Apache defines as     mandatory controls. It used to allow you to list hosts, domains,     and/or IP addresses or networks that were permitted or denied access     to documents. As of Apache 2.4, this module is no longer used.     Apache 2.4 and newer use an updated authentication and authorization     model. This new model also comes with new modules, new directives     and new syntax. The <code>mod_access</code> module is still an LPIC-2 exam     objective, so the pre-2.4 syntax should still be familiar to you. In     order to aid the migration towards Apache 2.4, a module called     <code>mod_access_compat</code> ships with Apache 2.4. This module serves the     purpose of still accepting the pre-2.4 syntax on Apache 2.4 servers.     If you encounter <code>mod_access</code> related errors after upgrading to     Apache 2.4 from a previous version, make sure the Apache 2.4     configuration loads this compabibility module with a line similar     to:<pre><code>LoadModule mod_access_compat modules/mod_access_compat.so\n</code></pre> </li> </ul> <p><code>mod_authn_anon</code></p> <ul> <li>(DAC) This module mimics the behaviour of anonymous FTP. Rather than     having a Apachemod_auth_anon database of valid credentials, it     recognizes a list of valid usernames (i.e., the way an FTP server     recognizes \"ftp\" and \"anonymous\") and grants access to any of those     with virtually any password. This module is more useful for logging     access to resources and keeping robots out than it is for actual     access control.</li> </ul> <p><code>mod_authn_dbm</code></p> <ul> <li>(DAC) Like <code>mod_auth_db</code>, except that credentials are stored in a     Unix DBM file.</li> </ul> <p><code>mod_auth_digest</code></p> <ul> <li> <p>(DAC) This module implements HTTP Digest Authentication (RFC2617),     Apachemod_auth_digest which used to provide a more secure     alternative to the <code>mod_auth_basic</code> functionality. The explanation     that follows is nice to know but outdated. The whole point of digest     authentication was to prevent user credentials to travel via     unencrypted HTTP over the wire. The hashing algorithms used by the     digest module are however seriously outdated. Using digest     authentication instead of basic HTTP authentication does not offer     as many advantages in terms of security as the use of HTTPS would.     The following documentation page provides more detail:     http://httpd.apache.org/docs/2.4/mod/mod_auth_digest.html.</p> <p>After receiving a request and a user name, the server will challenge the client by sending a <code>nonce</code>. The contents of a nonce can be any (preferably base 64 encoded) string, and the server may use the nonce to prevent replay attacks. A nonce might, for example, be constructed using an encrypted timestamp within a resolution of a minute, i.e. '201611291619'. The timestamp (and maybe other static data identifying the requested URI) might be encrypted using a private key known only to the server.</p> <p>Upon receival of the nonce the client calculates a hash (by default a MD5 checksum) of the received nonce, the username, the password, the HTTP method, and the requested URI and sends the result back to the server. The server will gather the same data from session data and password data retrieved from a local digest database. To reconstruct the nonce the server will try twice: the first try will use the current clocktime, the second try (if necessary) will use the current clocktime minus one minute. One of the tries should give the exact same hash the client calculated. If so, access to the page will be granted. This restricts validity of the challenge to one minute and prevents replay attacks.</p> <p>Please note that the contents of the nonce can be chosen by the server at will. The example provided is one of many possibilities. Like with <code>mod_auth</code>, the credentials are stored in a text file (the digest database). Digest database files are managed with the <code>htdigest</code> tool. Please refer to the module documentation for more details.</p> </li> </ul> <p><code>mod_authz_host</code></p> <ul> <li>The <code>mod_authz_host</code> module may be used to <code>Require</code> a certain     source of request towards Apache. The <code>mod_authz_host</code> module is     quite flexible about the arguments provided. Due to the name of the     module, it may seem logical to provide a hostname. While this     certainly works, it may not be the preferred choice. Not only does     this module need to perform a forward DNS lookup on the provided     hostname to resolve it to a numerical IP, the module is also     configured to perform a reverse DNS lookup on the resolved numerical     IP after the forward lookup is performed. Providing a hostname thus     leads to at least two DNS lookups for every affected webserver     request. And if the reverse DNS result differs from the provided     hostname, the request will be denied despite what the configuration     may allow. To circumvent this requirement regarding forward and     reverse DNS records matching, the <code>forward-dns</code> option may be used     when providing a hostname. Luckily, <code>mod_authz_host</code> not only     accepts hostnames as an argument. It can also handle (partial) IP     addresses, both IPv4 and IPv6, and CIDR style notations. There is     also an argument available called <code>local</code>. This will translate to     the <code>127.0.0.0/8</code> or <code>::1</code> loopback addresses as well as the     configured IP addresses of the server. This setting may come in     handy when restricting connections in regards to the local host.     Because of the liberal way that IP addresses are interpreted, it is     recommended to be as explicit as possible when using this module.     For instance, all of the following is regarded as valid input and     will be interpreted by the rules that apply:<pre><code> Require host: sue.nl\n Require ip: 10.6.6\n Require ip: 172\n Require ip: 10.9.9.9/32\n Require forward-dns: cloudhost.sue.nl\n Require local\n</code></pre> </li> </ul> <p>One of the noteworthy differences between Apache 2.2 and 2.4 lies in the directives used for authorization. The authorization functionality is provided by Apache <code>mod_authz_*</code> modules. Where previous versions of Apache used the <code>Order</code>, <code>Allow from</code>, <code>Deny from</code> and <code>Satisfy</code> directives, Apache 2.4 uses new directives called <code>all</code>, <code>env</code>, <code>host</code> and <code>ip</code>. These new directives have a significant impact on the syntax of configuration files. In order to aid the transition towards Apache 2.4, the <code>mod_access_compat</code> module can still interpret the previously used authorization directives. This module has to be explicitly enabled though. In doing so, backwards compatibility towards previous authorization configuration directives is maintained. The current authorization directives provide the possibility of a more granular configuration in regards to who is authorized to do what. This added granularity mostly comes from the availability of the <code>Require</code> directive. This directive could already be used before Apache 2.4 for authentication purposes. Since Apache 2.4 though, this directive can also be interpreted by the authorization modules.</p> <p>The following example puts the old en new syntax in comparison, while providing the same functionality.</p> <p>First, the pre-2.4 style:</p> <pre><code>    &lt;Directory /lpic2bookdev&gt;\n    Order deny,allow\n    Deny from all\n    allow from 10.6.6.0/24\n    Require group employees\n    Satisfy any\n    &lt;/Directory&gt;\n</code></pre> <p>And now the same codeblock, but using the Apache 2.4 style syntax:</p> <pre><code>    &lt;Directory /lpic2bookdev&gt;\n    &lt;RequireAny&gt;\n    Require ip 10.6.6.0/24\n    Require group employees\n    &lt;/RequireAny&gt;\n    &lt;/Directory&gt;\n</code></pre> <p>The benefit of the new syntax is all about efficiency. By accomplishing the same functionality with fewer lines, the processing of those lines will be handled more effectively by both humans and computers. The computers benefit from spending less processing cycles while accomplishing the same result. Humans benefit from a short configuration section. Long configurations are more prone to contain errors that may be overlooked. By creating sections within configuration files using the <code>RequireAll</code>, <code>RequireAny</code>, and <code>RequireNone</code> directives, these configurations can contain granular rules while at the same time preserving their readability.</p> <p>Another 2.4 change that is worth mentioning, has to do with the LPIC-2 exam objective regarding the <code>mod_auth</code> module. Starting with Apache 2.1, the functionality of the <code>mod_auth</code> module has been superseeded by more specific modules. One of these modules, <code>mod_authn_file</code> now provides the functionality that was previously offered by <code>mod_auth</code>. <code>mod_authn_file</code> allows for the use of a file that holds usernames and password as part of the authorization process. This file can be created and the contents may be maintained by the <code>htpasswd</code> utility. When using <code>mod_auth_digest</code> instead of <code>mod_auth_basic</code>, the <code>htdigest</code> utility should be used instead. This book will focus on the <code>mod_auth_basic</code> option. The <code>htpasswd -c</code> option will create a file with the provided argument as a filename during creation of a username and password pair. <code>htpasswd</code> allows for the creation of crypt, MD5 or SHA1 password algorithms. As of Apache 2.4.4, it is also possible to use bcrypt as the password encryption algorithm. Plaintext passwords can also be generated using the <code>htpasswd -p</code> option, but will only work if Apache 2.4 is hosted on Netware and MS Windows platforms. The crypt algorithm used to be the <code>htpasswd</code> default algorithm up to Apache version 2.2.17, but is considered insecure. Crypt will limit the provided password to the first eight characters. Every part of the password string from the ninth character on will be neglected. Crypt password strings are subject to fast brute force cracking and therefore pose a considerable security risk. The use of the crypt algorithm should be avoided whenever possible. Instead, the bcrypt algorithm should be considered when available. On a system with Apache 2.4.4 or later, the following syntax can be used to create a new password file <code>htpasswdfile</code>, supply it with the user \"bob\" and set the password for the user account using the bcrypt algorithm:</p> <pre><code>    htpasswd -cB /path/outside/document/root/htpasswdfile bob\n</code></pre> <p>The system will ask for the new password twice. To update this file anytime later by adding the user \"alice\", the <code>-c</code> option can be ommited to prevent the file from being rewritten:</p> <pre><code>    htpasswd -B /path/outside/document/root/htpasswdfile alice\n</code></pre> <p>Using the brypt algorithm with <code>htpasswd</code> also enables the use of the <code>-C</code> option. Using this option, the computing time used to calculate the password hash may be influenced. By default, the system uses a setting of 5. A value between 4 and 31 may be provided. Depending on the available resources, a value up to 18 should be acceptable to generate whilst increasing security. To add the user eve to the existing <code>htpasswdfile</code> while increasing the computing time to a value of 18, the following syntax may be used:</p> <pre><code>    htpasswd -B -C18 /path/outside/document/root/htpasswdfile eve\n</code></pre> <p>In the examples above, it is suggested that the password file is created outside of the webserver document tree. Otherwise, it could be possible for clients to download the password file.</p> <p>To use the generated password file for authentication purposes, Apache has to be aware of the <code>htpasswdfile</code> file. This can be accomplished by defining the <code>AuthUserFile</code> directive. This directive may be defined in either the Apache configuration files, or in a seperate <code>.htaccess</code> file. That <code>.htaccess</code> file should be located inside the directory of the document root it should represent. The Apache config responsible for that document root should have the <code>AllowOverride</code> directive specified. This way Apache will override directives from its configuration for directories that have <code>.htaccess</code> documents in them. The syntax for the <code>.htaccess</code> documents is the same as for Apache configuration files. A code block to use for user authentication could look as follows:</p> <pre><code>    &lt;Directory /web/document/root&gt;\n    AuthName \"Authentication Required\"\n    AuthType Basic\n    AuthUserFile /path/outside/document/root/htpasswdfile\n    Require valid-user\n    Documentroot /web/document/root\n    &lt;/Directory&gt;\n</code></pre> <p>Consult the contents of your Apache modules directory for the presence of mod_auth* files. There are multiple authentication and authorization modules available. Each has its own purpose, and some depend on each other. Each module adds functionality within Apache. This functionality can be addressed by using specific module-specific directives. Refer to the Apache documentation website https://httpd.apache.org/docs/2.4/mod/ for detailed usage options regarding the modules available for Apache 2.4.</p> <p>Configuring authentication modules</p> <p>ConfiguringApache Authentication Modules Apache security modules are configured by configuration directives. These are read from either the centralized configuration files (mostly found under or in the <code>/etc/</code> directory) or from decentralized <code>.htaccess</code> files. The latter are mostly used to restrict access to directories and are placed in the top level directory of the tree they help to protect. For example, authentication Apache.htaccess modules will read the location of their databases using the ApacheAuthUserFile ApacheAuthDBMGroupFile <code>AuthUserFile</code> or <code>AuthDBMGroupFile</code> directives.</p> <p>Centralized configuration.</p> <p>This is an example of a configuration as it might occur in a centralized configuration file: ApacheAuthType ApacheRequire valid-user</p> <pre><code>    &lt;Directory /home/johnson/public_html&gt;\n    &lt;Files foo.bar&gt;\n    AuthName \"Foo for Thought\"\n    AuthType Basic\n    AuthUserFile /home/johnson/foo.htpasswd\n    Require valid-user\n    &lt;/Files&gt;\n    &lt;/Directory&gt;\n</code></pre> <p>The resource being protected is \"any file named foo.bar\" in the <code>/home/johnson/public_html</code> directory or any underlying subdirectory. Likewise, the file specifies whom are authorized to access <code>foo.bar</code>: any user that has credentials in the <code>/home/johnson/foo.htpasswd</code> file.</p> <p>Decentralized configuration.</p> <p>The alternate approach is to place a <code>.htaccess</code> file in the top level directory of any document tree that needs access protection. Note that you must set the directive <code>AllowOverride</code> ApacheAllowOverride in the central configuration to enable this.</p> <p>The first section of <code>.htaccess</code> determines which authentication type should be used. It can contain the name of the password or group file to be used, e.g.:</p> <pre><code>    AuthUserFile {path to passwd file}\n    AuthGroupFile {path to group file}\n    AuthName {title for dialog box}\n    AuthType Basic\n</code></pre> <p>The second section of <code>.htaccess</code> ensures that only user <code>{username}</code> can access (GET) the current directory:</p> <pre><code>    &lt;Limit GET&gt;\n    require user {username} \n    &lt;/Limit&gt;\n</code></pre> <p>The <code>Limit</code> section can contain other directives to ApacheLimit restrict access to certain IP addresses or to a group of users.</p> <p>The following would permit any client on the local network (IP addresses 10.*.*.*) to access the <code>foo.html</code> page and require a username and password for anyone else:</p> <pre><code>    &lt;Files foo.html&gt;\n    Order Deny,Allow\n    Deny from All\n    Allow from 10.0.0.0/8\n    AuthName \"Insiders Only\"\n    AuthType Basic\n    AuthUserFile /usr/local/web/apache/.htpasswd-foo\n    Require valid-user\n    Satisfy Any\n    &lt;/Files&gt;\n</code></pre>"},{"location":"lpic2.208.1/#user-files","title":"User files","text":"<p>The <code>mod_auth</code> module uses plain text files that contain lists of valid users. The <code>htpasswd</code> Apachehtpasswd command can be used to create and update these files. The resulting files are plain text files, which can be read by any editor. They contain entries of the form \"username:password\", where the password is encrypted. Additional fields are allowed, but ignored by the software.</p> <p><code>htpasswd</code> encrypts passwords using either a version of MD5 modified for Apache or the older <code>crypt()</code> routine. You can mix and match.</p> <pre><code>    SYNOPSIS\n    htpasswd [ -c ] passwdfile username\n</code></pre> <p>Here are two examples of using <code>htpasswd</code> for creating an Apache password file. The first is for creating a new password file while adding a user, the second is for changing the password for an existing user.</p> <pre><code>    $ htpasswd -c /home/joe/public/.htpasswd joe\n    $ htpasswd /home/joe/public/.htpasswd stephan\n</code></pre> <p>Note Using the <code>-c</code> option, the specified password file will be overwritten if it already exists!</p>"},{"location":"lpic2.208.1/#group-files","title":"Group files","text":"<p>Apache can work with group files. Group files contain group names followed by the names of the people in the group. By authorizing a group, all users in that group have access. Group files are known as <code>.htgroup</code> files and by convention bear that name - though you can use any name you want. Group files can be located anywhere in the directory tree but are normally placed in the toplevel directory of the tree they help to protect. To allow the use of group files you will need to include some directives in the Apache main configuration file. This will normally be inside the proper <code>Directory</code> definition. Where the <code>AuthUserFile</code> may specify either an absolute or relative path, the <code>AuthGroupFile</code> directive will always treat the provided argument as relative to the <code>ServerRoot</code>. The <code>AuthGroupFile</code> file functions as an addition to the <code>AuthUserFile</code>. The file should contain a group on each line, followed by a colon. An example:</p> <p>ApacheAuthGroupFile Apache main configuration file:</p> <pre><code>    ...\n    AuthType Basic\n    AuthUserFile /var/www/.htpasswd\n    AuthGroupFile /var/www/.htgroup\n    Require group Management\n    ...\n</code></pre> <p>The associated <code>.htgroup</code> file might have the following syntax:</p> <pre><code>    Management: bob alice\n    Accounting: joe\n</code></pre> <p>Now the accounts \"bob\" and \"alice\" would have access to the resource but account \"joe\" would not due to the \"Require group Management\" statement in the main configuration file because \"joe\" is not a member of the required \"Management\" group. For this to work the users specified in the <code>.htgroup</code> file must have an entry in the <code>.htpasswd</code> file as well.</p> <p>Note A username can be in more than one group entry. This simply means that the user is a member of both groups.</p> <p>To use a DBM database (as used by <code>mod_auth_db</code>) you may use <code>dbmmanage</code>. For other types of user files/databases, please consult the documentation that comes with the chosen module.</p> <p>Note Make sure the various files are readable by the webserver.</p> <p>Configuring <code>mod_perl</code></p> <p><code>mod_perl</code> is another module for Apache, which loads the Perl interpreter into your Apache webserver, reducing spawning of child processes and hence memory footprint and need for processor power. Another benefit is code-caching: modules and scripts are loaded and compiled only once, and will be served from the cache for the rest of the webserver's life.</p> <p>ConfiguringApache mod_perl Using <code>mod_perl</code> allows inclusion of Perl statements into your webpages, which will be executed dynamically if the page is requested. A very basic page might look like this:</p> <pre><code>    print \"Content-type: text/plain\\r\\n\\r\\n\";\n    print \"Hello, you perly thing!\\n\";\n</code></pre> <p><code>mod_perl</code> also allows you to write new modules in Perl. You have full access to the inner workings of the web server and can intervene at any stage of request-processing. This allows for customized processing of (to name just a few of the phases) <code>URI-&gt;filename</code> translation, authentication, response generation and logging. There is very little run-time overhead.</p> <p>The standard Common Gateway Interface (CGI) within Apache can be replaced entirely with Perl code that handles the response generation phase of request processing. <code>mod_perl</code> includes two general purpose modules for this purpose. The first is <code>Apache::Registry</code>, which can transparently run well-written existing perl CGI scripts. If you have badly written scripts, you should rewrite them. If you lack resources, you may choose to use the second module <code>Apache::PerlRun</code> instead because it doesn't use caching and is far more permissive then <code>Apache::Registry</code>.</p> <p>You can configure your <code>httpd</code> server and handlers in Perl using <code>PerlSetVar</code>, and <code>&lt;Perl&gt;</code> ApachePerlSetVar sections. You can also define your own configuration directives, to be read by your own modules.</p> <p>There are many ways to install <code>mod_perl</code>, e.g. as a DSO, either using APXS or not, from source or from RPM's. Most of the possible scenarios can be found in the Mod_perl Guide ???.</p>"},{"location":"lpic2.208.1/#building-apache-from-source-code","title":"Building Apache from source code","text":"<p>For building Apache from source code you should have downloaded the Apache source code, the source code for <code>mod_perl</code> and have unpacked these in the same directory. You'll need a recent version of <code>perl</code> installed on your system. To build the module, in most cases, these commands will suffice:</p> <pre><code>    $ cd ${the-name-of-the-directory-with-the-sources-for-the-module}\n    $ perl Makefile.PL APACHE_SRC=../apache_x.x.x/src \\\n    DO_HTTPD=1 USE_APACI=1 EVERYTHING=1\n    $ make &amp;&amp; make test &amp;&amp; make install\n</code></pre> <p>After building the module, you should also build the Apache server. This can be done using the following commands:</p> <pre><code>    $ cd ${the-name-of-the-directory-with-the-sources-for-Apache}\n    $ make install\n</code></pre> <p>All that's left then is to add a few configuration lines to <code>httpd.conf</code> (the Apache configuration file) and start the server. Which lines you should add depends on the specific type of installation, but usually a few <code>LoadModule</code> and <code>AddModule</code> lines suffice.</p> <p>As an example, these are the lines you would need to add to <code>httpd.conf</code> to use <code>mod_perl</code> as a DSO:</p> <pre><code>    LoadModule perl_module modules/libperl.so\n    AddModule mod_perl.c\n    PerlModule Apache::Registry\n\n    Alias /perl/ /home/httpd/perl/ \n    &lt;Location /perl&gt;\n    SetHandler perl-script \n    PerlHandler Apache::Registry \n    Options +ExecCGI\n    PerlSendHeader On \n    &lt;/Location&gt;\n</code></pre> <p>The first two lines will add the <code>mod_perl</code> module when Apache starts. During startup, the <code>PerlModule</code> directive ensures that the named Perl module is read in too. This usually is a Perl package file ending in <code>.pm</code>. The <code>Alias</code> keyword reroutes requests for URIs in the form <code>http://www.example.com/perl/file.pl</code> to the directory <code>/home/httpd/perl</code>. Next, we define settings for that location. By setting the <code>SetHandler</code>, all requests for a Perl file in the directory <code>/home/httpd/perl</code> now will be redirected to the perl-script handler, which is part of the <code>Apache::Registry</code> module. The next line simply allows execution of CGI scripts in the specified location instead of displaying this file. Any URI of the form <code>http://www.example.com/perl/file.pl</code> will now be compiled once and cached in memory. The memory image will be refreshed by recompiling the Perl routine whenever its source is updated on disk. Setting <code>PerlSendHeader</code> to on tells the server to send an HTTP headers to the browser on every script invocation but most of the time it's better either to use the <code>$r-&gt;send_http_header</code> method using the Apache Perl API or to use the <code>$q-&gt;header</code> method from the <code>CGI.pm</code> module.</p>"},{"location":"lpic2.208.1/#configuring-mod_php-support","title":"Configuring <code>mod_php</code> support","text":"<p>PHP is a server-side, cross-platform, HTML embedded scripting language. PHP started as a quick Perl hack written by Rasmus Lerdorf in late 1994. Later he rewrote his code in C and hence the \\\"Personal Home Page/Forms Interpreter\\\" (PHP/FI) was born. Over the next two to three years, it evolved into PHP/FI 2.0. Zeev Suraski and Andi Gutmans wrote a new parser in the summer of 1997, which led to the introduction of PHP 3.0. PHP 3.0 defined the syntax and semantics used in both versions 3 and 4. PHP became the de facto programming language for millions of web developers. Still another version of the (Zend) parser and much better support for object oriented programming led to the introduction of version 5.0 in july 2004. Several subversions followed and also version 6 was started to include native Unicode support. However this version was abandoned. The current version of PHP at the time of writing is PHP 8</p> <p>PHP can be called from the CGI interface, but the common approach is to configure PHP in the Apache web server as a (dynamic) DSO module. To do this, you can either use pre-built modules extracted from RPM's or roll your own from the source code. You need to configure the <code>make</code> process first. To tell <code>configure</code> to build the module as a DSO, you need to tell it to use APXS:</p> <pre><code>    ./configure -with-apxs\n</code></pre> <p>.. or, in case you want to specify the location for the <code>apxs</code> binary:</p> <pre><code>    ./configure -with-apxs={path-to-apxs}/apxs\n</code></pre> <p>Next, you can compile PHP by running the <code>make</code> command. Once all the source files are successfully compiled, install PHP by using the <code>make install</code> command.</p> <p>Before Apache can use PHP, it has to know about the PHP module and when to use it. The <code>apxs</code> program took care of telling Apache about the PHP module, so all that is left to do is tell Apache about <code>.php</code> files. File types are controlled in the <code>httpd.conf</code> file, and it usually includes lines about PHP that are commented out. You may want to search for these lines and uncomment them:</p> <pre><code>    Addtype application/x-httpd-php .php\n</code></pre> <p>Then restart Apache by issuing the <code>apachectl restart</code> command. The <code>apachectl</code> command is another way of passing commands to the Apache server instead of using <code>/etc/init.d/httpd</code>. Consult the <code>apachectl(8)</code> manpage for more information.</p> <p>To test whether it actually works, create the following page:</p> <pre><code>    &lt;HTML&gt;\n    &lt;HEAD&gt;&lt;TITLE&gt;PHP Test &lt;/TITLE&gt;&lt;/HEAD&gt;\n    &lt;BODY&gt;\n    &lt;?php phpinfo( ) ?&gt;\n    &lt;/BODY&gt;\n    &lt;/HTML&gt;\n</code></pre> <p>Save the file as <code>test.php</code> in Apache's <code>htdocs</code> directory and aim your browser at <code>http://localhost/test.php</code>. A page should appear with the PHP logo and additional information about your PHP configuration. Notice that PHP commands are contained by <code>&lt;?</code> and <code>?&gt;</code> tags.</p>"},{"location":"lpic2.208.1/#apachehttpd","title":"The httpd binary","text":"<p>The <code>httpd</code> binary is the actual HTTP server component of Apache.  During normal operation, it is recommended to use the <code>apachectl</code> or  <code>apache2ctl</code> command to controlthe httpd daemon. On some distributions the <code>httpd</code> binary is named <code>apache2</code>.</p> <p>Apache used to be a daemon that forked child-processes only when needed. To allow better response times, nowadays Apache can also be run in pre-forked mode. This means that the server will spawn a number of child-processes in advance, ready to serve any communication requests. On most distributions the pre-forked mode is run by default.</p>"},{"location":"lpic2.208.1/#apacheoptions","title":"Configuring Apache server options","text":"<p>The <code>httpd.conf</code> file contains a number of sections that allow you to configure the behavior of the Apache server. A number of keywords/sections are listed below.</p> <p><code>MaxKeepAliveRequests</code></p> <ul> <li>The maximum number of requests to allow during a persistent     connection. Set to 0 to allow an unlimited amount.</li> </ul> <p><code>StartServers</code></p> <ul> <li>The number of servers to start initially.</li> </ul> <p><code>MinSpareServers</code>; <code>MaxSpareServers</code></p> <ul> <li>Used for server-pool size regulation. Rather than making you guess how     many server processes you need, Apache dynamically adapts to the load it     sees. That is, it tries to maintain enough server processes to     handle the current load, plus a few spare servers to handle     transient load spikes (e.g., multiple simultaneous requests from a     single browser). It does this by periodically checking how many     servers are waiting for a request. If there are fewer than     <code>MinSpareServers</code>, it creates a new spare. If there are more than     <code>MaxSpareServers</code>, the superfluous spares are killed.</li> </ul> <p><code>MaxClients</code></p> <ul> <li>Limit on total number of servers running, i.e., limit on the number     of clients that can simultaneously connect. If this     limit is ever reached, clients will be locked out, so it should     not be set too low. It is intended mainly as a brake to keep a     runaway server from taking the system with it as it spirals down.</li> </ul> <p>Note In most Red Hat derivates the Apache configuration is split into two subdirectories. The main configuration file <code>httpd.conf</code> is located in <code>/etc/httpd/conf</code>. The configuration of Apache modules is located in <code>/etc/httpd/conf.d</code>. Files in that directories with the suffix <code>.conf</code> are added to the Apache configuration during startup of Apache.</p>"},{"location":"lpic2.208.1/#apache-virtual-hosting","title":"Apache Virtual Hosting","text":"<p>Virtual Hosting is a technique that provides the capability to host more than one domain on one physical host. There are two methods to implement virtual hosting:</p> <p>Name-based virtual hosting</p> <p>With name-based virtual hosting, the HTTP server relies on the client (e.g. the browser) to report the hostname as part of the HTTP request headers. By using name-based virtual hosting, one IP address may serve multiple websites for different web domains. In other words: Name-based virtual hosts use the website address from the URL to determine the correct virtual host to serve.</p> <p>IP-based virtual hosting</p> <p>Using IP-based virtual hosting, each configured web domain is committed to at least one IP address. Since most host systems can be configured with multiple IP addresses, one host can serve multiple web domains. Each web domain is configured to use a specific IP address or range of IP addresses. In other words: IP-based virtual hosts use the IP address of the TCP connection to determine the correct virtual host to serve.</p>"},{"location":"lpic2.208.1/#name-based-virtual-hosting","title":"Name-based virtual hosting","text":"<p>Name-based virtual hosting is a fairly simple technique. You need to configure  your DNS server to map each domain name to the correct IP address first. Then, configure the Apache HTTP Server to recognize the different domain names and serve the appropriate websites.</p> <p>Name-based virtual hosting eases the demand for scarce IPv4 addresses. Therefore you could (or should) use name-based virtual hosting unless there is a specific reason to choose IP-based virtual hosting, see IP-based Virtual Hosting.</p> <p>To use name-based virtual hosting, you must designate the IP address (and possibly port) on the server that will be accepting requests for the hosts. On Apache 2.x up to 2.4, this is configured using the <code>NameVirtualHost</code> directive. This <code>NameVirtualHost</code> directive is deprectated since Apache 2.4. Each <code>VirtualHost</code> also implies a <code>NameVirtualHost</code>, so defining a <code>VirtualHost</code> is sufficient from Apache 2.4 on. Any available IP address can be used. There should be a balance between ease of configuration, use and administration on one hand, and security on the other. Using a wildcard as the listening IP address inside a <code>NameVirtualHost</code> or <code>VirtualHost</code> segment will enable the functionality of that specific configuration on all IP addresses specified by the <code>Listen</code> directive of Apache's main configuration file. If the main configuration file also uses a wildcard for the <code>Listen</code> option, this will result in the availability of the Apache HTTPD server on all configured IP addresses of the server. And therefore, the availability of the previously mentioned functionality on all of these IP addresses as well. Whether or not this is either preferable or imposes risk, depends on the circumstances. If the server is using multiple network interfaces and/or IP addresses, special care should be taken when configuring services. Every daemon exposing services to the network could contain code based or configuration based errors. These errors could be abused by someone with malicious intentions. By minimizing the so called network footprint of the server, the available attack surface is also minimized. Whether or not the additional configuration overhead of preventing wildcards is worth the effort, will always remain a trade off.</p> <ul> <li><code>Listen</code> can be used to specify the IP addresses and ports to which     an Apache listener should be opened in order to serve the configured     content.</li> </ul> <p>The <code>&lt;VirtualHost&gt;</code> directive is the next step to create for each different webdomain you would like to serve. The argument to the  <code>&lt;VirtualHost&gt;</code> directive should be the same as the argument to  the (pre-Apache 2.4) <code>NameVirtualHost</code> directive (i.e., an IP address or <code>*</code> for all addresses). Inside each <code>&lt;VirtualHost&gt;</code> block you will need, at minimum, a <code>ServerName</code> directive to designate which host is served and a <code>DocumentRoot</code> directive to point out where in the filesystem the content for that webdomain can be found.</p> <p>Suppose that both <code>www.domain.tld</code> and <code>www.otherdomain.tld</code> point to the IP address <code>111.22.33.44</code>. You could then add the following to <code>httpd.conf</code> or equivalent (included) configuration file:</p> <pre><code>    NameVirtualHost 111.22.33.44\n\n    &lt;VirtualHost 111.22.33.44&gt;\n        ServerName www.domain.tld\n        DocumentRoot /www/domain\n    &lt;/VirtualHost&gt;\n\n    &lt;VirtualHost 111.22.33.44&gt;\n        ServerName www.otherdomain.tld\n        DocumentRoot /www/otherdomain\n    &lt;/VirtualHost&gt;\n</code></pre> <p>The IP address <code>111.22.44.33</code> could be replaced by <code>*</code> to match all IP addresses for this server. The implications of using wildcards in this way have been addressed above.</p> <p>Many websites should be accessible by more than one name. For instance, the organization behind <code>domain.tld</code> wants to facilitate <code>blog.domain.tld</code>. There are multiple ways to implement this functionality, but one of them uses the <code>ServerAlias</code> directive. The <code>ServerAlias</code> directive is declared inside the \\&lt;VirtualHost&gt; section.</p> <p>If, for example, you add the following to the first \\&lt;VirtualHost&gt; block above</p> <pre><code>    ServerAlias domain.tld *.domain.tld\n</code></pre> <p>then requests for all hosts in the <code>domain.tld</code> domain will be served by the <code>www.domain.tld</code> virtual host. The wildcard characters <code>*</code> and <code>?</code> can be used to match names.</p> <p>Of course, you can't just make up names and place them in <code>ServerName</code> or <code>ServerAlias</code>. The DNS system must be properly configured to map those names to the IP address(es) declared in the <code>NameVirtualHost</code> directive.</p> <p>Finally, you can fine-tune the configuration of the virtual hosts by placing other directives inside the <code>&lt;VirtualHost&gt;</code> containers. Most directives can be placed in these containers and will then change the configuration only of the relevant virtual host. Configuration directives set in the main server context (outside any <code>&lt;VirtualHost&gt;</code> container) will be used only if they are not overridden by the virtual host settings.</p> <p>Now when a request arrives, the server will first check if it is requesting an IP address that matches the <code>NameVirtualHost</code>. If it is, then it will look at each <code>&lt;VirtualHost&gt;</code> section with a matching IP address and try to find one where the <code>ServerName</code> or <code>ServerAlias</code> matches the requested hostname. If it finds one, it then uses the corresponding configuration for that server. If no matching virtual host is found, then the first listed virtual host that matches the IP address will be used.</p> <p>As a consequence, the first listed virtual host is the default virtual host. The <code>DocumentRoot</code> from the main server will never be used when an IP address matches the <code>NameVirtualHost</code> directive. If you would like to have a special configuration for requests that do not match any particular virtual host, put that configuration in a <code>&lt;VirtualHost&gt;</code> container and place it before any other <code>&lt;VirtualHost&gt;</code> container specification in the Apache configuration.</p>"},{"location":"lpic2.208.1/#ip-based-virtual-hosting","title":"IP-based virtual hosting","text":"<p>Despite the advantages of name-based virtual hosting, there are some reasons why you might consider using IP-based virtual hosting instead. These are niche scenarios though:</p> <ul> <li> <p>Some older or exotic web clients are not compatible with name-based     virtual hosting for HTTP or HTTPS. HTTPS name-based virtual hosting     is implemented using an extension to the TLS protocol called Server     Name Indicator (SNI). Most modern browsers on modern operating     systems should support SNI at the time of this writing.</p> </li> <li> <p>Some operating systems and network equipment devices implement     bandwidth management techniques that cannot differentiate between     hosts unless they are on separate IP addresses.</p> </li> </ul> <p>As the term IP-based indicates, the server must have a different IP address for each IP-based virtual host. This can be achieved by equipping the machine with several physical network connections or by using virtual interfaces. Virtual interfaces are supported by most modern operating systems (refer to the system documentation for details on IP aliasing and the <code>ifconfig</code> or <code>ip</code> command).</p> <p>There are two ways of running the Apache HTTP server to support multiple hosts:</p> <ul> <li> <p>By running a separate <code>httpd</code> daemon for each hostname;</p> </li> <li> <p>By running a single daemon that supports all the virtual hosts.</p> </li> </ul> <p>Use multiple daemons when:</p> <ul> <li> <p>There are security issues, e.g., if you want to maintain strict     separation between the web-pages for separate customers. In this     case you would need one daemon per customer, each running with     different <code>User</code>, <code>Group</code>, <code>Listen</code> and <code>ServerRoot</code> settings;</p> </li> <li> <p>You can afford the memory and file descriptor requirements of     listening to every IP alias on the machine. It is only possible to     <code>Listen</code> to the \"wildcard\" address, or to specific IP addresses. So,     if you need to restrict one webdomain to a specific IP address, all     other webdomains need to be configured to use specific IP addresses     as well.</p> </li> </ul> <p>Use a single daemon when:</p> <ul> <li> <p>Sharing of the <code>httpd</code> configuration between virtual hosts is     acceptable;</p> </li> <li> <p>The machine serves a large number of requests, and so the     performance loss in running separate daemons may be significant.</p> </li> </ul>"},{"location":"lpic2.208.1/#setting-up-multiple-daemons","title":"Setting up multiple daemons","text":"<p>Create a separate <code>httpd</code> installation for each virtual host. For each installation, use the <code>Listen</code> directive in the configuration file to select which IP address (or virtual host) that daemon services:</p> <pre><code>    Listen 123.45.67.89:80\n</code></pre> <p>The <code>Listen</code> directive may be defined as an IP:PORT combination seperated by colons as above. Another option is to specify only the port number. By doing so, the Apache server will default to activating listeners on all configured IP addresses on the specified port(s):</p> <pre><code>    Listen 80\n    Listen 443\n</code></pre> <p>The above <code>Listen</code> configuration could also be defined using <code>0.0.0.0</code> as the IP address, again using the colon as a seperator.</p> <p>Another option of the <code>Listen</code> directive enables the exact specification of the protocol. In the previous example, port 80 and 443 are used. By default, Port 80 is configured for HTTP and port 443 for HTTPS in Apache. This configuration could be expanded by another HTTPS website on port 8443::</p> <pre><code>    Listen 80\n    Listen 443\n    Listen 8443 https\n</code></pre> <p>When configuring one or more Apache daemons, the <code>Listen</code> directive may be used to specify one or more ports above 1024. This will prevent the necessity of root privileges for that daemon, if no other ports below 1025 are specified. Unless certain key or certificate files which are only accessible with root privileges are included in the configuration. You will read more about this on the next page of this book.</p> <p>As of Apache 2.4, the <code>Listen</code> directive is mandatory and should be specified. Previous versions of Apache would default to port 80 for HTTP and 443 for HTTPS on all available IP addresses if no <code>Listen</code> directive was specified. Starting with Apache 2.4, the Apache server will fail to start if no valid <code>Listen</code> directive is specified.</p>"},{"location":"lpic2.208.1/#setting-up-a-single-daemon","title":"Setting up a single daemon","text":"<p>For this case, a single <code>httpd</code> will service requests for the main server and all the virtual hosts. The <code>VirtualHost</code> directive in the configuration file is used to set the values of <code>ServerAdmin</code>, <code>ServerName</code>, <code>DocumentRoot</code>, <code>ErrorLog</code> and <code>TransferLog</code> or <code>CustomLog</code> configuration directives to different values for each virtual host.</p> <pre><code>    &lt;VirtualHost www.sue.nl&gt;\n        ServerAdmin webmaster@mail.sue.nl\n        DocumentRoot /groups/sue/www\n        ServerName www.sue.nl\n        ErrorLog /groups/sue/logs/error_log\n        TransferLog /groups/sue/logs/access_log\n    &lt;/VirtualHost&gt;\n\n    &lt;VirtualHost www.unix.nl&gt;\n        ServerAdmin webmaster@mail.unix.nl\n        DocumentRoot /groups/unix_nl/www\n        ServerName www.unix.nl\n        ErrorLog /groups/unix_nl/logs/error_log\n        TransferLog /groups/unix_nl/logs/access_log\n    &lt;/VirtualHost&gt;\n</code></pre>"},{"location":"lpic2.208.1/#redirective","title":"Customizing file access","text":"<p><code>Redirect</code> allows you to tell clients about documents which used to exist in your server's namespace, but do not anymore. This allows you to tell the clients where to look for the relocated document.</p> <pre><code>    Redirect {old-URI} {new-URI}\n</code></pre>"},{"location":"lpic2.208.2/","title":"Apache configuration for HTTPS (208.2)","text":""},{"location":"lpic2.208.2/#apache-configuration-for-https-2082","title":"Apache configuration for HTTPS (208.2)","text":"<p>Candidates should be able to configure a web server to provide HTTPS.</p>"},{"location":"lpic2.208.2/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>SSL configuration files, tools and utilities</p> </li> <li> <p>Ability to generate a server private key and CSR for a commercial CA</p> </li> <li> <p>Ability to generate a self-signed Certificate from private CA</p> </li> <li> <p>Ability to install the key and Certificate</p> </li> <li> <p>Awareness of the issues with Virtual Hosting and use of SSL</p> </li> <li> <p>Security issues in SSL use</p> </li> <li> <p>Virtual Hosting and use of SSL through Server Name Indicator (SNI)</p> </li> <li> <p>Disabling insecure protocols and ciphers</p> </li> </ul>"},{"location":"lpic2.208.2/#terms-and-utilities","title":"Terms and Utilities:","text":"<ul> <li> <p><code>Apache2 configuration files</code></p> </li> <li> <p><code>/etc/ssl/, /etc/pki/</code></p> </li> <li> <p><code>openssl, CA.pl</code></p> </li> <li> <p><code>SSLEngine, SSLCertificateKeyFile, SSLCertificateFile</code></p> </li> <li> <p><code>SSLCACertificateFile, SSLCACertificatePath</code></p> </li> <li> <p><code>SSLProtocol, SSLCipherSuite, ServerTokens, ServerSignature, TraceEnable</code></p> </li> </ul>"},{"location":"lpic2.208.2/#apache2-configuration-files","title":"Apache2 configuration files","text":"<p>Depending on the Linux distribution in use, the following files and directories may be used for configuration of Apache 2.x when Apache is installed from packages: <code>httpd.conf</code>, <code>apache.conf</code>, <code>apache2.conf</code>, <code>/etc/httpd/</code>, <code>/etc/httpd/conf</code>, <code>/etc/httpd/conf.d</code>, <code>/etc/apache2/</code></p> <p>Configuration files are expected to contain predefined directives. If a directive is not explicitly defined, Apache will use a default setting. This default may vary per Linux distribution, so consult your distribution's Apache documentation. <code>/usr/share/doc</code> is a good place to start. Configuration files can be checked for syntax errors using either of the following commands:</p> <pre><code>    $ sudo apachectl configtest\n    $ sudo service httpd configtest\n</code></pre> <p>Because Apache usually serves a daemon that listens to ports below 1024, sudo or a root shell should be used to invoke all Apache related commands. Refer to your system documentation to check for the availability of the <code>apachectl</code> or <code>apache2ctl</code> command. If both exist, they might be symlinked. The naming difference for this command has a historical reason. <code>apachectl</code> was used for Apache 1.x and when Apache2 was released the command was hence renamed match the new name. Now that Apache2.x has become the standard, either <code>apache2ctl</code> has been renamed to <code>apachectl</code> or both commands are available for compatibility reasons. When available, the <code>service</code> facility may point to httpd on Red Hat based systems, or to apache2 on Debian-based systems: The <code>apachectl</code> command has many useful options. It is in fact a shell script that functions as a wrapper for the httpd binary. Consult the man page for all available arguments and options. Just two more examples to get you started: To show all configured virtual hosts, use:</p> <pre><code>    $ sudo apachectl -t -D DUMP_VHOSTS\n</code></pre> <p>To show all currently running websites, use:</p> <pre><code>    $ sudo apachectl -S\n</code></pre> <p>Be careful interpreting the output from the command above. That output shows the configuration of the currently running websites. There is no guarantee that the website configuration on disk has changed since these websites were brought online. In other words: The output from the running processes does not necessarily have to match the contents of the configuration files (anymore).</p> <p>In regards to the Apache configuration files, it is important to know about the different ways Apache may be installed and configured. Depending on the Linux distribution and Apache2.x version in use, configuration files may be located and even named differently across otherwise similar systems. As we will see further down this chapter, Apache often uses one main configuration file. Within this file, other configuration files may be included using the <code>INCLUDE /path/to/other/config</code> directive. The configuration file syntax may be checked for errors by invoking the <code>apachectl</code> script as shown previously. Each configuration file that is included from the main configuration file in use will be checked for consistency and syntax. Consistency here means that if a dependant configuration file, certificate file or key file can not be accessed properly by the user the httpd binary runs as, a warning will be shown. If <code>apachectl</code> does not appear in your <code>$PATH</code>, use the <code>sudo find</code> command with <code>apachectl</code> or <code>apache2ctl</code> as an argument. Depending on the size of your storage volumes, it may be wiser to narrow this search down to specific directories. You have been warned. If the <code>service</code> command is not available on your system, the Apache daemon may be started, checked and stopped by a SysV script instead. Look within the <code>/etc/init.d/</code> directory for a script called <code>httpd</code>, <code>apache2</code> or equivalent. This script may be then called upon as follows, to reveal the available arguments:</p> <pre><code>    $ sudo /etc/init.d/apache2\n</code></pre>"},{"location":"lpic2.208.2/#encrypted-webservers-ssl","title":"Encrypted webservers: SSL","text":"<p>Apache can support SSL/TLS for (reasonably) secure SSL/TLS online communication. While TLS in version 1.2 is actually the currently favourable option, TLS encrypted HTTPS sessions are still referred to as 'SSL' encrypted sessions. TLS could in fact be seen as the successor to SSL (v3.0). So, just as with Apache versus Apache2, whenever Apache/SSL is mentioned in this chapter, TLS is implied as well. Unless otherwise specified. We will cover the strengths and weaknesses of both protocols further down this chapter.</p> <p>The Secure Sockets Layer protocol (SSL) is a protocol which may be placed between a reliable connection-oriented network layer protocol (e.g., TCP/IP) and the application layer protocol (e.g., HTTP). SSL provides secure communication between client and server by allowing mutual authentication and the use of digital signatures for integrity and encryption for privacy. Currently there are two versions of SSL still in use: version 2 and version 3. Additionally, the successor to SSL, TLS (version 1.0, 1.1 and 1.2, which are based on SSL), TLS were designed by the IETF organisation.</p>"},{"location":"lpic2.208.2/#public-key-cryptography","title":"Public key cryptography","text":"<p>SSL/TLS uses Public Key Cryptography (PKC), also known as asymmetric PKC CryptographyPublic Key cryptography. Public key cryptography is used in situations where the sender and receiver do not share a common secret, e.g., between browsers and web servers, but wish to establish a trusted channel for their communication.</p> <p>PKC defines an algorithm which uses two keys, each of which may be used to encrypt a message. If one key is used to encrypt a message, then the other must be used to decrypt it. This makes it possible to receive secure messages by simply publishing one key (the public key) and keeping the other key secret (the private key). Anyone may encrypt a message using the public key, but only the owner of the private key will be able to read it. For example, Alice may send private messages to the owner of a key-pair (e.g., your web server), by encrypting the messages using the public key your server publishes. Only the server will be able to decrypt it using the corresponding private key.</p> <p></p> <p>A secure web server (e.g., Apache/SSL) uses HTTP over SSL/TLS, https Apache443 using port 443 by default. The SSL/TLS port can be configured by defining the <code>Listen</code> directive inside the main configuration file. There should already be a listener configured for port 80 (HTTP). On Debian-based systems, there is a dedicated file for defining the active listeners. This file is called <code>ports.conf</code> and is included from the main configuration file. Apart from this file, individual websites should specify the listening host at the end of the <code>ServerName</code> or <code>NameVirtualHost</code> declaration. Starting from Apache v2.4, <code>NameVirtualHost</code> has been deprecated in favour of <code>VirtualHost</code>. A declaration like that could look as follows: <code>&lt;VirtualHost *:443&gt;</code>. Within the browser, the use of HTTPS is signified by the use of the https:// scheme in the URL. The public key is exchanged during the set-up of the communication between server and client (browser). That public key should be signed (it contains a digital signature e.g., a message digest) by a so-called valid CA (Certificate Authority). Each browser contains a number of so-called Certificate Authority root-certificates: these can be used to determine the validity of the CA's that signed the key. Not every certificate out there is signed by one of these valid CA's. Especially for testing purposes, it is common to sign certificates without the intervention of a valid CA. This is done in order to save both (validation) time and (registration fee) money. As of 2015, it has become easier to maintain valid CA signed certificate. An organisation called Let's Encrypt is willing to sign certificates for free, as long as you play by the rules. Use your favourite web search engine to find out more about Let's Encrypt, after reading this chapter.</p>"},{"location":"lpic2.208.2/#apache-with-mod_ssl","title":"Apache with <code>mod_ssl</code>","text":"<p>The Apache Software Foundation provides excellent documentation regarding the use of <code>mod_ssl,</code>. We urge you to take the time to read through the resources collected at the following URL: https://httpd.apache.org/docs/current/ssl/</p> <p>The subject of encryption is so vast and complicated that entire books have been written around about it. The added confidentiality and integrity only provide their value when encryption is implemented correctly. So called 'best practices' in regards to encryption may change overnight. In addition to the collection of resources listed at the URL above, we want to add the following URL: http://httpd.apache.org/docs/trunk/ssl/ssl_howto.html</p> <p>As you can see, this URL does not point to the current version of the documentation. Instead, it points to the trunk version. At the time of this writing, this corresponds to the Apache 2.5 documentation. The trunk documentation will always point towards the most recent Apache version in development. And while the trunk Apache code may not be recommended to use, the documentation may be more recently updated than elsewhere. In regards to the subject of SSL/TLS, this results in more up-to-date best practices than the 2.4 documentation provides.</p> <p>The documentation provided by The Apache Software Foundation is vendor-neutral. So when the Apache documentation states that the following directives should be present in the Apache main configuration file:</p> <pre><code>    LoadModule mod_ssl modules/mod_ssl.so\n    Listen 443\n    &lt;Vhost&gt;\n    &lt;/Vhost&gt;\n</code></pre> <p>It can very well be that these directives are configured amongst several configuration files. This depends on your Linux distribution. In addition to the documentation provided by The Apache Software Foundation, we will try to point out the configuration differences between Red Hat and Debian based distributions.</p> <p>To use <code>mod_ssl</code> you will need to install the Apache and mod_ssl package. Apachemod_ssl On Red Hat based systems, this is done using the following command:</p> <pre><code>    $ sudo yum install httpd mod_ssl\n</code></pre> <p>On Debian-based systems, this is done using the following command:</p> <pre><code>    $ sudo apt-get install apache2 openssl\n</code></pre> <p>After installation, make sure the OpenSSL module is enabled within Apache. The module should be available to the Apache daemon, and included to be loaded during daemon start-up. Again, there are several ways this can be achieved. A common way is similar to the <code>websites-available</code> and <code>websites-enabled</code> strategy. However, now we are dealing with <code>modules-available</code> and <code>modules-                 enabled</code> directories instead. As a plus, Debian-based systems come with a utility called <code>a2enmod</code>. By invoking this command as follows:</p> <pre><code>    $ sudo a2enmod enable ssl\n</code></pre> <p><code>a2enmod</code> will create symlinks within the <code>mods-enabled                  directory, pointing to respectively                  mods-available/ssl.conf</code> and <code>mods-available/ssl.load</code>. When Apache is reloaded, these symlinks will ensure the SSL module will be loaded as well.</p> <p>Red Hat based systems use the <code>LoadModule</code> directive instead. This directive should be declared so it will be read during the start of the Apache daemon. On a Red Hat based system, this could be achieved by a <code>/etc/httpd/conf/httpd.conf</code> that holds the following INCLUDE directive:</p> <pre><code>    Include conf.d/*conf\n</code></pre> <p>The default file <code>/etc/httpd/conf.d/ssl.conf</code> could then contain the following <code>LoadModule</code> and <code>Listen</code> statements:</p> <pre><code>    LoadModule ssl_module modules/mod_ssl.so\n    Listen 443\n</code></pre> <p>After reloading Apache, the SSL module should be loaded together with the Apache daemon. It is always a good practice to check for configuration errors before restarting the Apache daemon. This can be done using the <code>apachectl configtest</code> command and has been covered earlier. The output should be clear to interpret whether Apache will encounter errors or not, and why (it will).</p> <p>Then, generate a key and Certificate Signing Request (CSR). Either sign the csr file yourself, thus creating a 'self-signed' certificate, or have it signed by a valid Certificate Authority (CA). Depending on who you are, a self-signed certificate might cause browser-warnings when presented via HTTPS. Having the csr signed by a valid CA might prevent this from happening.</p> <p>Some additional directives should be used to configure the secure server - for example the location of the key-files. It's beyond the scope of this book to document all of these directives. However, you should be familiar with most of the mod_ssl directives. You can find best practices by searching the web and should also refer to your distribution's specific mod_ssl documentation. The generic mod_ssl documentation can be found on the <code>mod_ssl</code> <code>mod_ssl</code> web-site.</p> <p><code>mod_ssl</code> can also be used to authenticate clients using client certificates. These client certificates can be signed by your own CA and <code>mod_ssl</code> will validate the certificates against this CA. To enable this functionality set the <code>SSLVerifyClient</code> to <code>require</code>. Use the value <code>none</code> to turn it off.</p> <p>Certificates that are installed as part of your Linux distribution are usually installed in <code>/etc/ssl/certs</code> on Debian-based systems, and in <code>/etc/pki/tls/certs</code> on Red Hat based systems. The Red Hat based systems may have a symlink in place that points <code>/etc/ssl/certs</code> to <code>/etc/pki/tls/certs</code> for convenience and compatibility.</p> <p>Keys or key-files that are installed as part of your Linux distribution are in turn usually installed in <code>/etc/ssl/private</code> on Debian-based systems and in <code>/etc/pki/tls/private</code> on Red Hat based systems. Other directories within <code>/etc/ssl</code> and <code>/etc/pki</code> may also contain specific key files.</p> <p>It is often considered a best practice to create subdirectories when working with specific keys and/or certificates. Especially because specific cryptographic keys and certificates belong to each other. By devoting a dedicated subdirectory to each keypair, structure will be maintained within both the filesystem and configuration files pointing to these files. These subdirecties may be created as part of the <code>/etc/ssl</code> or <code>/etc/pki</code> hierarchy. But creating subdirectories below <code>/etc/apache2</code> or <code>/etc/httpd</code> can be done as well.</p> <p>Directory /etc/ssl/ {#apachessl}</p> <pre><code>                /etc/ssl$ ls -l\n                total 32\n                drwxr-xr-x 3 root root     16384 2011-03-06 15:31 certs\n                -rw-r--r-- 1 root root      9374 2010-09-24 22:05 openssl.cnf\n                drwx--x--- 2 root ssl-cert  4096 2011-03-06 13:19 private\n</code></pre> <p>openssl The <code>openssl</code> program is a command line interface to the OpenSSL crypto library. You can use it to generate certificates, encrypt and decrypt files, create hashes and much more. It is generally seen as \"the Swiss Army knife\" of cryptography. One of the more common usages is to generate (self-signed) certificates for use on a secured webserver (to support the <code>https</code> protocol). <code>/etc/ssl/openssl.cnf</code> is the standard location for its configuration file, where you can set defaults for the name of your organization, the address etc.</p> <p>Note If you generate a certificate for a webserver you start by creating a Certificate Signing Request (.csr). The <code>openssl</code> tool will prompt you for information it needs to create the request, using defaults it fetches from the configuration file. When you generate such a signing request, make sure you enter the FQDN (\\\"Fully Qualified Domain Name\\\") of the server when <code>openssl</code> Fully Qualified Domain Name prompts you for the \"Common Name\" or CN (which is part of the \"Distinguished Name\"). For example when you generate a CSR for the web-site Common Name <code>https://www.foo.example/</code>, enter <code>www.foo.example</code> as the CN. Be aware that a certificate providing <code>foo.example</code> would not be valid for the website accessed via <code>https://www.foo.example</code>. Neither would this certificate be valid for the website behind the URL <code>https://webmail.foo.example</code>. Seperate certificates for each domain should be put in place. To combat this necessity, many organizations choose to use wilcard- certificates. Especially for internal hosted websites. When issuing a CSR for a certificate that could be used to serve any of the <code>.foo.example</code> websites, the request should be done for the CN value <code>*.foo.example</code>. Browsers will understand this wildcard certificate when presented, and decide accordingly. <code>www.foo.example</code> and <code>webmail.foo.example</code> could be configured to use this certificate. <code>https://foo.example</code> on the other hand, would issue a browser warning with this certificate.</p> <p>How to create a SSL server Certificate {#apachesslcert}</p> <p>While installing OpenSSL, the program <code>openssl</code> is installed CreatingSSL Server Certificate on your system. This command can be used to create the necessary files that implement a (self-signed) server certificate.</p> <p>More specifically:</p> <ul> <li> <p>RSA You start by generating the RSA key file. It contains a pair     of related keys, used to encrypt and decrypt messages to and from     you. One half of the keypair will be used to encrypt messages that     will be sent to you using the public key. The other half is used     to decrypt these received messages using the private key. The     public key will be made part of your digital certificate. This     allows client systems to sent encrypted messages to your webserver     that only this webserver can decrypt, as it holds the related     private key;</p> </li> <li> <p>Next you will create a Certificate Signing Request (CSR).     Certificate Signing Request This is a file which contains the public     key and identifying information like the name of your company,     location etc;</p> </li> <li> <p>The CSR is sent to a Certificate Authority (CA) which should     verify the correctness of the information you provided and generate     the certificate. This certificate contains a digital signature     that allows verification that the CA has approved of the contents of     the certificate. The certificate will contain the data you provided     (including your public key) and it is signed by the CA using its     private key. A certificate contains your RSA public key, your     name, the name of the CA and is digitally signed by your CA.     Browsers that know the CA can verify the Certificate Authority     signature on that certificate, thereby obtaining your RSA public     key. That enables them to send messages which only you can decrypt.</p> </li> </ul> <p>Note You can create a signing request and then sign it yourself. In fact, that is what Certificate Authorities do when they create their <code>root certificate</code>. A <code>root                  certificate</code> is simply a certificate that says that they say they are whom they say they are. So, anybody can create a root certificate and put any credentials on it just as they please. The root certificate itself is no proof of anything. You will need to ensure that it really was issued by a party you trust yourself. Either you visit them and get a copy directly from them, or fetch it using another method you trust or you rely on others you trust to have done this for you. One of the ways you implicitly \"trust\" a large number of CAs is by relying on their root certificates that are made part of your browser.</p> <p>Triple-DES PEM As an example: to create an RSA private key that has a keysize of 2048 bits, and which will be triple-des (3DES) encrypted, stored in a file named <code>server.key</code> in the default format (which is known as PEM), type:</p> <pre><code>    $ openssl genrsa -des3 -out server.key 2048\n</code></pre> <p>RSA keysizes below 1024 bits are considered out-of-date. 1024 bits seems to be a best practice today, with 2048, 3072, 4096 and onwards being valid options if all involved components are able to handle these keysizes without overexceeding thresholds.</p> <p>openssl <code>openssl</code> will ask for a pass-phrase, which will be used as the key to encrypt the private key. Please store this file in a secure backup location and remember the pass-phrase. If you loose the pass-phrase you will not be able to recover the key.</p> <p>For testing purposes, it might be preferable to strip the password from the key file. This can accomplished by reading the key and exporting it as follows:</p> <pre><code>    $ openssl rsa -in server.key -out stripped.key\n</code></pre> <p>The <code>server.key</code> file still holds the encrypted private key information in ciphertext. The <code>stripped.key</code> file is a plain text file with the unencrypted private key information as its contents. Handle with care.</p> <p>To create a Certificate Signing Request (CSR) with the server RSA private key (output will be PEM formatted), execute the following:</p> <pre><code>    $ openssl req -new -key server.key -out server.csr\n</code></pre> <p>The signing request can now either be sent to a real CA, which will sign the request and create a digital certificate, or you can create your own CA and do it yourself. Note that if you do it yourself, you will also need to install the root certificate of your CA into your clients (e.g. browser) to signal them that a certificate signed by your own CA can be trusted. If you omit this step, you will be getting a lot of disturbing warnings about missing trust and insecurity.</p> <p>CA.pl You can provide the <code>openssl</code> parameters yourself, but that can be a daunting task for less experienced users. Hence, for conveniences sake the OpenSSL software suite provides a perl script (<code>CA.pl</code>) to handle most CA related tasks a lot easier. It has a simplified syntax and supplies the more complex command line arguments to the underlying <code>openssl</code> command.</p> <p><code>CA.pl</code> will default use values it reads from the standard OpenSSL configuration file <code>/etc/ssl/openssl.cnf</code>. To create your own CA, find the <code>CA</code> shellscript or <code>CA.pl</code> perlscript that should be part of the OpenSSL package. On Red Hat based systems, this script is located in the <code>/etc/pki/tls/misc</code> directory. Depending on your distribution, the script might not interpret filenames for arguments. The script then instead looks for predifined values for the key file and csr file. Page the script source using a command like <code>less</code> or <code>more</code> and look for clues. The STDERR output might also show some valueable pointers. In the following example, <code>newkey.pem</code> and <code>newreq.pem</code> are used as file names by the <code>CA.pl</code> script:</p> <pre><code>    # /usr/lib/ssl/misc/CA.pl -newca\n    CA certificate filename (or enter to create)\n\n    Making CA certificate ...\n    Generating a 2048 bit RSA private key\n    ........................+++\n    ..................................+++\n    writing new private key to './demoCA/private/cakey.pem'\n    Enter PEM pass phrase: ********\n    Verifying - Enter PEM pass phrase: ********\n    You are about to be asked to enter information that will be incorporated\n    into your certificate request.\n    What you are about to enter is what is called a Distinguished Name or a DN.\n    There are quite a few fields but you can leave some blank\n    For some fields there will be a default value,\n    If you enter '.', the field will be left blank.\n    -----\n    Country Name (2 letter code) [NL]:\n    State or Province Name (full name) [None]:\n    Locality Name (eg, city) []:\n    Organization Name (eg, company) [Sue B.V.]:\n    Organizational Unit Name (eg, section) []:\n    Common Name (e.g. server FQDN or YOUR name) []:ssltest.sue.nl\n    Email Address []:\n\n    Please enter the following 'extra' attributes\n    to be sent with your certificate request\n    A challenge password []:\n    An optional company name []:\n    Using configuration from /usr/lib/ssl/openssl.cnf\n    Enter pass phrase for ./demoCA/private/cakey.pem:\n    Check that the request matches the signature\n    Signature ok\n    Certificate Details:\n    Serial Number:\n    ca:d8:22:43:94:6d:ca:6c\n    Validity\n    Not Before: Jul  9 13:49:38 2019 GMT\n    Not After : Jul  8 13:49:38 2020  GMT\n    Subject:\n    countryName               = NL\n    stateOrProvinceName       = None\n    organizationName          = Sue B.V.\n    commonName                = ssltest.sue.nl\n    X509v3 extensions:\n    X509v3 Subject Key Identifier: \n    83:F3:99:4B:98:E0:F1:37:78:67:DC:04:AC:04:65:03:48:BB:31:FB\n    X509v3 Authority Key Identifier: \n    keyid:83:F3:99:4B:98:E0:F1:37:78:67:DC:04:AC:04:65:03:48:BB:31:FB\n\n    X509v3 Basic Constraints: \n    CA:TRUE\n    Certificate is to be certified until Jul  8 13:49:38 2016 GMT (1095 days)\n\n    Write out database with 1 new entries\n    Data Base Updated\n</code></pre> <p>Next create a signing request:</p> <pre><code>    # /usr/lib/ssl/misc/CA.pl -newreq\n    Generating a 2048 bit RSA private key\n    ...........................+++\n    ...........................+++\n    writing new private key to 'newkey.pem'\n    Enter PEM pass phrase:\n    Verifying - Enter PEM pass phrase:\n    -----\n    You are about to be asked to enter information that will be incorporated\n    into your certificate request.\n    What you are about to enter is what is called a Distinguished Name or a DN.\n    There are quite a few fields but you can leave some blank\n    For some fields there will be a default value,\n    If you enter '.', the field will be left blank.\n    -----\n    Country Name (2 letter code) [NL]:\n    State or Province Name (full name) []:None\n    Locality Name (eg, city) []:\n    Organization Name (eg, company) []:Sue B.V.\n    Organizational Unit Name (eg, section) []:\n    Common Name (e.g. server FQDN or YOUR name) []:ssltest.sue.nl\n    Email Address []:\n\n    Please enter the following 'extra' attributes\n    to be sent with your certificate request\n    A challenge password []:\n    An optional company name []:\n    Request is in newreq.pem, private key is in newkey.pem\n</code></pre> <p>Then, we sign the request:</p> <pre><code>    # /usr/lib/ssl/misc/CA.pl -signreq\n    Using configuration from /usr/lib/ssl/openssl.cnf\n    Enter pass phrase for ./demoCA/private/cakey.pem:\n    Check that the request matches the signature\n    Signature ok\n    Certificate Details:\n    Serial Number:\n    ca:d8:22:43:94:6d:ca:6d\n    Validity\n    Not Before: Jul  9 13:53:53 2013 GMT\n    Not After : Jul  9 13:53:53 2014 GMT\n    Subject:\n    countryName               = NL\n    stateOrProvinceName       = None\n    organizationName          = Sue B.V.\n    commonName                = ssltest.sue.nl\n    X509v3 extensions:\n    X509v3 Basic Constraints: \n    CA:FALSE\n    Netscape Comment: \n    OpenSSL Generated Certificate\n    X509v3 Subject Key Identifier: \n    21:A4:61:83:B4:E7:C3:E9:2B:2C:0A:DD:36:FA:82:D0:77:3A:E2:01\n    X509v3 Authority Key Identifier: \n    keyid:83:F3:99:4B:98:E0:F1:37:78:67:DC:04:AC:04:65:03:48:BB:31:FB\n\n    Certificate is to be certified until Jul  9 13:53:53 2014 GMT (365 days)\n    Sign the certificate? [y/n]:y\n\n\n    1 out of 1 certificate requests certified, commit? [y/n]y\n    Write out database with 1 new entries\n    Data Base Updated\n    Signed certificate is in newcert.pem\n</code></pre> <p>You now created a certificate signed by your own CA (<code>newcert.pem</code>). You might want to rename the file to something more distinguishable, e.g <code>Certificate:ssltest.sue.nl</code>. While at it, rename the server key file too, for example <code>PrivateKey:ssltest.sue.nl</code>. Especially if you maintain a lot of keys and certificates on a lot of servers, it really helps to be able to learn from the name of a file what is in it.</p> <p>The Certificate Signing Request (CSR) could have been sent to an external Certificate Authority (CA) instead. You usually have to post the CSR into a web form, pay for the signing and await a signed Certificate. There are non-profit CA's that will perform similar tasks free of charge, for example <code>CAcert</code>. However, their root certificate is not yet included into most browsers so you will need to do that yourself if you are going to use their services.</p> <p>The <code>server.csr</code> file is no longer needed. Now you have two files: ApacheSSLCertificateFile ApacheSSLCertificateKeyFile <code>server.key</code> and <code>newcert.pem</code>. In your Apache's <code>httpd.conf</code> file you should refer to them using lines like these:</p> <pre><code>    SSLCertificateFile    /path/to/Certificate:ssltest.sue.nl\n    SSLCertificateKeyFile /path/to/PrivateKey:ssltest.sue.nl\n</code></pre> <p>It is considered a best practice to follow the 'least privilege' principle when managing key and certificate files. These files should preferebly be stored in a way that only the user account that runs the web server can access them.</p> <p>Apache SSL Directives {#ssldir}</p> <p>The following Apache SSL configuration directives should be familiar to you:</p> <p><code>SSLEngine</code></p> <ul> <li>This directive toggles the usage of the SSL/TLS Protocol Engine.     This should be used inside a \\&lt;VirtualHost&gt; section to enable     SSL/TLS for a that virtual host. By default the SSL/TLS Protocol     Engine is disabled for both the main server and all configured     virtual hosts.</li> </ul> <p><code>SSLCertificateKeyFile</code></p> <ul> <li>This directive points to the PEM-encoded private key file for the     server. If the contained private key is encrypted, the pass phrase     dialog is forced at startup time. This directive can be used up to     three times (referencing different filenames) when an RSA, a DSA,     and an ECC based private key is used in parallel. For each     SSLCertificateKeyFile directive, there must be a matching     SSLCertificateFile directive.</li> </ul> <p><code>SSLCertificateFile</code></p> <ul> <li>This directive points to a file with certificate data in PEM format.     At a minimum, the file must include an end-entity (leaf)     certificate. This directive can be used up to three times     (referencing different filenames) when an RSA, a DSA, and an ECC     based server certificate is used in parallel.</li> </ul> <p>Creating and installing a self-signed certificate for Apache {#ssssl}</p> <p>Sometimes, it might be acceptable to use a self-signed SSL certificate with Apache. The following steps explain how to accomplish this on a Debian based system. First, create a directory to hold the SSL keys. On the system we use as an example, all system-wide SSL certificates are stored in the directory <code>/etc/ssl/certs</code>. For our purpose, we create a new directory called <code>/etc/ssl/webserver</code> and use it to store our new keypair:</p> <pre><code>    # mkdir /etc/ssl/webserver\n    # openssl req -new -x509 -days 365 -nodes \\\n    &gt; -out /etc/ssl/webserver/apache.pem -keyout /etc/ssl/webserver/apache.key\n    Generating a 2048 bit RSA private key\n    ...............................+++\n    .......+++\n    writing new private key to '/etc/ssl/webserver/apache.key'\n    # ls /etc/ssl/webserver/\n    apache.key  apache.pem\n</code></pre> <p>Note During creation, openssl wil use the contents of <code>/etc/ssl/openssl/cnf</code> to fill in some variables. Other values will be asked by an interactive script. Be sure to use the proper FQDN here to distinguish this certificate from certificates with another purpose later on.</p> <p>In order to be able to use SSL with Apache, a module called <code>mod_ssl</code> has to be loaded. On this system, we can check the enabled modules by listing the contents of the <code>/etc/apache2/mods-enabled</code> directory. All currently available modules can be checked by listing the contents of the <code>/etc/apache2/mods-available</code> directory:</p> <pre><code>    # ls /etc/apache2/mods-enabled/\n    alias.conf            autoindex.conf  mime.conf         reqtimeout.load\n    alias.load            autoindex.load  mime.load         setenvif.conf\n    auth_basic.load       cgi.load        negotiation.conf  setenvif.load\n    authn_file.load       deflate.conf    negotiation.load  status.conf\n    authz_default.load    deflate.load    perl.load         status.load\n    authz_groupfile.load  dir.conf        php5.conf\n    authz_host.load       dir.load        php5.load\n    authz_user.load       env.load        reqtimeout.conf\n\n    # ls /etc/apache2/mods-available/\n    actions.conf          cgid.conf          include.load         proxy_ftp.conf\n    actions.load          cgid.load          info.conf            proxy_ftp.load\n    alias.conf            cgi.load           info.load            proxy_http.load\n    alias.load            charset_lite.load  ldap.conf            proxy.load\n    asis.load             dav_fs.conf        ldap.load            proxy_scgi.load\n    auth_basic.load       dav_fs.load        log_forensic.load    reqtimeout.conf\n    auth_digest.load      dav.load           mem_cache.conf       reqtimeout.load\n    authn_alias.load      dav_lock.load      mem_cache.load       rewrite.load\n    authn_anon.load       dbd.load           mime.conf            setenvif.conf\n    authn_dbd.load        deflate.conf       mime.load            setenvif.load\n    authn_dbm.load        deflate.load       mime_magic.conf      speling.load\n    authn_default.load    dir.conf           mime_magic.load      ssl.conf\n    authn_file.load       dir.load           mod-dnssd.conf       ssl.load\n    authnz_ldap.load      disk_cache.conf    mod-dnssd.load       status.conf\n    authz_dbm.load        disk_cache.load    negotiation.conf     status.load\n    authz_default.load    dump_io.load       negotiation.load     substitute.load\n    authz_groupfile.load  env.load           perl.load            suexec.load\n    authz_host.load       expires.load       php5.conf            unique_id.load\n    authz_owner.load      ext_filter.load    php5.load            userdir.conf\n    authz_user.load       file_cache.load    proxy_ajp.load       userdir.load\n    autoindex.conf        filter.load        proxy_balancer.conf  usertrack.load\n    autoindex.load        headers.load       proxy_balancer.load  vhost_alias.load\n    cache.load            ident.load         proxy.conf\n    cern_meta.load        imagemap.load      proxy_connect.load\n</code></pre> <p><code>ssl</code> appears to be available but has not been enabled yet because both ssl files, <code>ssl.load</code> and <code>ssl.conf</code>, are still present in the <code>/etc/apache2/mods-available/</code> directory and not in the <code>/etc/apache2/mods-enabled/</code> directory. We could create a symlink to activate support for ssl ourselves, but Debian provides a utility written in perl called <code>a2enmod</code> that takes care of this. Consult the <code>A2ENMOD(8)</code> manpage for more information. It's counterpart, conveniently called <code>a2dismod</code>, does the opposite and disables Apache modules by removing the symlinks from <code>/etc/apache2/mods-enabled/</code>.</p> <p>Let's enable SSL:</p> <pre><code>    # a2enmod ssl\n    Enabling module ssl.\n    See /usr/share/doc/apache2.2-common/README.Debian.gz on how to configure SSL \\\n        and create self-signed certificates.\n    To activate the new configuration, you need to run:\n    service apache2 restart\n    # service apache2 restart\n    [ ok ] Restarting web server: apache2 ... waiting .\n    # apachectl status |grep -i ssl\n    Server Version: Apache/2.2.22 (Debian) PHP/5.4.4-15.1 mod_ssl/2.2.22 OpenSSL/\n</code></pre> <p>SSL has now been enabled on the Apache HTTP server. In order for a site to actually use SSL, it's configuration has to be properly configured. HTTPS uses tcp port 443 by default, so we want to specify this in the apache config of Debian. Add the following line to your <code>/etc/apache2/ports.conf</code> file:</p> <pre><code>    Listen 443\n</code></pre> <p>Now, all sites that want to make use of SSL need to have their configuration files reconfigured. The following lines need to be added to each \"enabled\" site that should serve it's content by HTTPS:</p> <pre><code>    SSLEngine On\n    SSLCertificateFile /etc/ssl/webserver/apache.pem\n    SSLCertificateKeyFile /etc/ssl/webserver/apache.key\n</code></pre> <p>An example site configuration file for both a HTTP and HTTPS enabled site could be like the following:</p> <pre><code>    NameVirtualHost *:80\n    NameVirtualHost *:443\n\n    &lt;VirtualHost *:80&gt;\n    Servername  webserver.intranet\n    DocumentRoot    /srv/http\n    ErrorLog    /var/log/apache2/error.log\n    &lt;/VirtualHost&gt;\n\n    &lt;VirtualHost *:443&gt;\n    SSLEngine   On\n    SSLCertificateFile /etc/ssl/webserver/apache.pem\n    SSLCertificateKeyFile /etc/ssl/webserver/apache.key\n    Servername  webserver.intranet\n    DocumentRoot    /srv/http\n    ErrorLog    /var/log/apache2/error.log\n    &lt;/VirtualHost&gt;\n</code></pre> <p>Now, use <code>apachectl configtest</code> to test your site configuration and if no errors occur restart the Apache HTTP server. The SSL enabled sites should now be accessible by using the <code>https</code> URL instead of <code>http</code>.</p>"},{"location":"lpic2.208.2/#other-apache-directives","title":"Other Apache Directives","text":"<p>Apart from the directives used above, the following Apache configuration directives should be familiar to you:</p> <p><code>SSLCACertificateFile</code></p> <ul> <li>This directive sets the all-in-one file where you can assemble the     certificates of Certification Authorities (CA) whose clients you     deal with. These are used for Client Authentication. Such a file is     simply the concatenation of the various PEM-encoded certificate     files, in order of preference.</li> </ul> <p><code>SSLCACertificatePath</code></p> <ul> <li>Sets the directory where you keep the certificates of Certification     Authorities (CAs) whose clients you deal with. These are used to     verify the client certificate on Client Authentication.</li> </ul> <p><code>SSLCipherSuite</code></p> <ul> <li>This complex directive uses a colon-separated cipher-spec string     consisting of OpenSSL cipher specifications to configure the Cipher     Suite the client is permitted to negotiate in the SSL handshake     phase. Notice that this directive can be used both in per-server and     per-directory context. In per-server context it applies to the     standard SSL handshake when a connection is established. In     per-directory context it forces a SSL renegotiation with the     reconfigured Cipher Suite after the HTTP request was read but before     the HTTP response is sent.</li> </ul> <p><code>SSLProtocol</code></p> <ul> <li>This directive can be used to control the SSL protocol flavors     mod_ssl should use when establishing its server environment.     Clients then can only connect with one of the provided protocols.</li> </ul> <p><code>ServerSignature</code></p> <ul> <li>The <code>ServerSignature</code> directive allows the configuration of a     trailing footer line under server-generated documents (error     messages, mod_proxy ftp directory listings, mod_info output,     ...). The reason why you would want to enable such a footer line is     that in a chain of proxies, the user often has no possibility to     tell which of the chained servers actually produced a returned error     message.</li> </ul> <p><code>ServerTokens</code></p> <ul> <li>This directive controls whether the Server response header field     which is sent back to clients includes minimal information,     everything worth mentioning or somewhere in between. By default, the     <code>ServerTokens</code> directive is set to <code>Full</code>. By declaring this     (global) directive and setting it to <code>Prod</code>, the supplied     information will be reduced to the bare minimum. During the first     chapter of this subject the necessity for compiling Apache from     source is mentioned. Modifying the Apache Server response header     field values could be a scenario that requires modification of     source code. This could very well be part of a server hardening     process. As a result, the Apache server could provide different     values as response header fields.</li> </ul> <p><code>TraceEnable</code></p> <ul> <li>This directive overrides the behavior of <code>TRACE</code> for both the core     server and mod_proxy. The default <code>TraceEnable on</code> permits <code>TRACE</code>     requests per RFC 2616, which disallows any request body to accompany     the request. <code>TraceEnable off</code> causes the core server and mod_proxy     to return a <code>405</code> (method not allowed) error to the client. There is     also the non-compliant setting <code>extended</code> which will allow message     bodies to accompany the trace requests. This setting should only be     used for debugging purposes. Despite what a security scan may say,     the <code>TRACE</code> method is part of the HTTP/1.1 RFC 2616 specification     and should therefore not be disabled without a specific reason.</li> </ul>"},{"location":"lpic2.208.2/#sslvhost","title":"SSL with Apache Virtual Hosts","text":"<p>As we saw before, the FQDN plays an important part in SSL. It has to match the CN value of the certificate. This certificate is presented to the browser when initiating the connection to the HTTPS server. Only when the certificate is valid, issued by a known, trusted and registered party, and matches the hostname will the browser iniate the connection without warnings. Otherwise, the browser should present a warning about an invalid or expired certificate, an unknown issuer, or an invalid hostname. With IP-based virtual hosts we have a different IP/port combination for every virtual host, which means we can configure an SSL certificate for every virtual host. The HTTPS connection will be initiated on a dedicated IP address after all.</p> <p>When working with name based virtual hosts however, we have no unique identifier for the resource being requested except for the hostname. So the Apache HTTP server receives all requests for the virtual hosts it serves on the same IP/port combination. It isn't until after the SSL connection has been established that the HTTP server knows which virtual host is actually being requested based on the URL. The URL discloses the hostname for the virtual host. But, by then it might be too late; the client could have been offered a certificate with a different CN value due to the nature of the HTTP within SSL/TLS transaction.</p> <p>Currently, an extension called SNI (Server Name Indication) can be used to circumvent this name based issue. Using this extension, the browser includes the requested hostname in the first message of its SSL handshake as an UTF-8 encoded byte-string value representing the <code>server_name</code> attribute of the client hello message. This value should only consist of host and/or domain names. No IPv4 or IPv6 IP addresses should be used. Both the browser and Apache need to support SNI in order for the SNI mechanism to work. If SNI is used on the server and the browser doesn't support SNI the browser could show a \"untrusted certificate\" warning. This depends on the certificate that is presented for the \"default\" website of the HTTP server. As of this writing, most browsers do support SNI. Exceptions are the Android 2.x default browser, MS Internet Explorer on MS Windows XP before SP3 and versions of Oracle Java before 1.7 on any operating system.</p> <p>To use SNI on the Apache server and prevent \"untrusted certificate\" warnings due to non-SNI capable browsers, it is possible to use a multidomain certificate. This certificate should contain all the necessary domain names and should be used in the Apache configuration in a separate virtual host. In this virtual host no servername should be configured and because of this it will match all requests without a hostname and therefore serving all browsers without SNI support. Apache will show the content of the right requested (SNI) site due to the requested website being extracted from the URL. This extraction takes place after the encrypted session has been created, using the multidomain certificate. This solution will probably never receive an award for it's looks, but the science behind it at least works.</p> <p>Without SNI, a web server can serve multiple name based virtual hosts over HTTPS without browser warnings. With the requirement (or restriction) that the SSL certificate being used will be the same for all virtual hosts. The virtual hosts also have to be part of the same domain, e.g.: <code>virtual01.example.com</code> and <code>virtual02.example.com</code>. The SSL certificate has to be configured in such a way that the CN (Common Name) points to a wildcard for the domain being used, e.g.: <code>*.example.com</code>.</p>"},{"location":"lpic2.208.2/#ssl-security-issues","title":"SSL Security Issues","text":"<p>The cryptographic security aspect of SSL is entirely based on trust. Mid-2013, there were about 650 Certificate Authorities. Every one of these authorities may pose as the \"weakest link\", and therefore the security of your SSL certificate only goes as far as your trust in it's CA.</p> <p>The <code>SSLCertificateChainFile</code>  directive has been removed from the LPIC-2 objectives. This directive is good to know nevertheless. It is an addition to the <code>SSLCertificateFile</code> and <code>SSLCertificateKeyFile</code> directives. The impact of self signed certificates for HTTPS sessions has been pointed out earlier. But even if you send a CSR to a known CA and receive a validated certificate in return, set up your server correctly using this certificate and the correct key file used to generate the CSR, this does not mean every browser will validate a session using this certificate as valid. This is often due to the involved CA having signed the CSR using a certificate that is not known to your browser. This might for instance be the case if the signing certificate is newer than your browser. But also because many CA's offer different types of certificates from their product portfolio. Browsers recognize the validity of HTTPS certificates based on the availability of so called root-certificates. These could be seen as the top level within the certificate chain. The CSR's on the other hand are often signed using a so called intermediate certificate. These intermediate certificates are relatable to the root certificate, but exist on a lower level in the certificate chain. To restrict the amount of certificates being shipped with browser software, not all certificates being used to sign CSR's are included by default . This could result in browser warnings about an incomplete certificate chain. To remedy these warnings (actually errors) , one or more intermediate certificates may be needed to reassemble the certificate chain for completeness. In order to facilitate this, CA's using intermediate certificates usually offer these intermediate certificates for download. The website of the CA and/or the email holding the signed certificate information should point to the appropriate intermediate certificate(s). The different levels are often referred to as G*n*-level certificates, where n represents a certain number. These intermediate certicates fill the gap between your signed certificate, and the root certificates known to all major browsers. By using the <code>SSLCertificateChainFile</code> directive, you may point Apache to a file that holds two or more concatenated certificates. By concatenating the missing certificates in the right order, the certificate chain gap will be closed and the certificate chain will be complete again.</p>"},{"location":"lpic2.208.2/#disabling-of-insecure-protocols-and-ciphers","title":"Disabling of insecure protocols and ciphers","text":"<p>When Apache is configured as a Secure Server to serve content via the HTTPS protocol, the client and server negotiate upon encryption initiation which ciphers can be used to secure the connection. Both the Apache server and the browser then offer a list of their available encryption algorithms to each other. Depending on which settings are enforced, the server and browser then initiate a secure channel using an overlapping encryption algorithm from the list of available ciphers. By setting the <code>SSLHonorCipherOrder</code> directive to a value of <code>on</code>, the server will honor the order of ciphers as specified by the <code>SSLCipherSuite</code> directive. Otherwise, the client will have the upper hand when deciding which ciphers will be used. This secure channel then is used to transmit the encryption keys that will be used to secure the communication from here on forward. Those encryption keys must also be in a cipher format that both the server and client can handle. As is often the case, trade-offs have to be made between compatibility and security. Maximizing the amount of ciphers offered (and therefore browser compatibility) also increases the possibility that one or more of the ciphers in use may be susceptible to attack vectors. The term 'weak ciphers' is often used to refer to these vulnerable encryption algorithms. The list of (de)recommended ciphers, is heavily dependant on the publication of known vulnerabilities to abuse these ciphers. This leads to opinions that may change over time. It is therefore recommended to stay up to date about known vulnerabilities. Currently, use of so called Cipher Block Code ciphers is not recommended. These ciphers may be identified by a \"CBC\" part in their name. Neither is Arcfour (or RC4 in short) a recommended cipher to be used. As far as protocols go, SSL v2 and SSL v3 are known to be vulnerable to a plethora of attack vectors. TLS v1.0 and v1.1 also have their weaknesses. TLS v1.2 is currently the recommended protocol to use if security is a concern. With TLS v1.3 being almost visible on the horizon. Apache allows for configuration of the ciphers being offered to clients. By using the following directives, the list of ciphers that Apache offers to client software can be limited:</p> <pre><code>    SSLCipherSuite\n    SSLProtocol\n</code></pre> <p>The following section shows an example configuration on how these directives may be used. The <code>SSLCipherSuite</code> is configured to use strong ciphersuites only, while explicitly disabling <code>RC4</code>. The <code>SSLProtocol</code> directive disables support for <code>All</code> protocols, while explicitly enabling <code>TLSv1.2</code> support. The order in which the ciphers should be evaluated for mutual support by both the server and the client is determined by the server through use of the <code>SSLHonorCipherOrder</code> directive. Finally, the <code>SSLCompression</code> directive is configured to disable SSL/TLS compression. Disabling this compression mitigates the known CRIME (Compression Ratio Info-leak Made Easy) attack vector.</p> <pre><code>    SSLCipherSuite EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH:!RC4\n    SSLProtocol -All +TLSv1.2\n    SSLHonorCipherOrder On\n    SSLCompression Off\n</code></pre> <p>From Apache 2.4 on, <code>mod_ssl</code> dropped support for SSLv2. Only SSLv3 and TLS are supported. Be aware that support for recent TLS versions depends on the availability of recent OpenSSL libraries.</p> <p>A good reference before configuring a secure Apache server, is the Mozilla TLS Server project at Github. This website has example configuration strings for various major HTTP servers, including Apache. The project team members should keep the example configurations up to date according to the latest recommendations. Another good reference is https://cipherli.st. This website also offers example configurations.</p> <p>Regarding every example configuration is it always important not to copy/paste configurations without validating the content. As explained earlier, a trade-off has to be made in most cases. Configuring Apache to strictly serve a modern cipher like TLS 1.2 will mitigate most known attack vectors in regards to SSL and TLS connections. But not every browser on every operating system will be able to adhere to this requirement. The adoption of TLS v1.2 in client software requires the availability of recent SSL libraries. Not all software vendors keep these libraries on track. The trade-off here is therefore security in favor of compatibility. Using older ciphers like SSL v2 and SSL v3 will probably increase the chances of encrypted connections being vulnerable to known attacks. But at the same time this will maximize the compatibility of clients that will be able to set up these connections. Another trade off.</p> <p>Apart from explicitly specifying which protocols and ciphers _can_ be used, the preference for using a certain protocol or cipher may vary. The order in which the directives are specified has influence, but gives no guarantees. Servers and clients often use a technique called opportunistic encryption to decide which of the protocols and ciphers will be used. At the same time, it is possible for client software to specify exactly what protocol and ciphers should be used. Depending on the server configuration, the server will respect these demands by the client. It is this very functionality that is the basis for a category of known attacks called downgrade attacks.</p> <p>After having set up your server, it is regarded as a best practice to periodicly scan the system for known vulnerabilities. This can be done in multiple ways. An easy way is to use a public web service like Qualys SSLabs: https://ssllabs.com. The output will show you in detail whether and if so, which weak protocols and/or ciphers were detected.</p>"},{"location":"lpic2.208.3/","title":"Implementing Squid as a caching proxy (208.3)","text":""},{"location":"lpic2.208.3/#implementing-squid-as-a-caching-proxy-2083","title":"Implementing Squid as a caching proxy (208.3)","text":"<p>Candidates should be able to install and configure a proxy server, including access policies, authentication and resource usage.</p>"},{"location":"lpic2.208.3/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Squid 3.x configuration files, terms and utilities</p> </li> <li> <p>Access restriction methods</p> </li> <li> <p>Client user authentication methods</p> </li> <li> <p>Layout and content of ACL in the Squid configuration files</p> </li> </ul>"},{"location":"lpic2.208.3/#terms-and-utilities","title":"Terms and utilities:","text":"<ul> <li> <p><code>squid.conf</code></p> </li> <li> <p><code>acl</code></p> </li> <li> <p><code>http_access</code></p> </li> </ul>"},{"location":"lpic2.208.3/#web-caches","title":"Web-caches","text":"<p>A web-cache, also known as an http proxy, is web-cache http proxy used to reduce bandwidth demands and often allows for finer-grained access control. Using a proxy, in the client software the hostname and port number of a proxy must be specified. When the browser tries to connect to a web server, the request will be sent to the specified proxy server but to the user it looks like the request has been sent to the requested web server directly. The proxy server now makes a connection to the specified web server, waits for the answer and sends this back to the client. The proxy works like an interpreter: the client talks and listens to the proxy and the proxy talks and listens to the web server the client wants to talk to. A proxy will also use locally cached versions of web-pages if they have not yet expired and will also validate client requests.</p> <p>Additionally, there are transparent proxies. Usually this is the transparent proxy tandem of a regular proxy and a redirecting router. In these cases, a web request can be intercepted by the proxy, transparently. In this case there is no need to setup a proxy in the settings of the client software. As far as the client software knows, it is talking directly to the target server, whereas it is actually talking to the proxy.</p>"},{"location":"lpic2.208.3/#squid","title":"<code>squid</code>","text":"<p><code>squid</code> is a high-performance proxy caching server for web clients. squid <code>squid</code> supports more then just HTTP data objects: it supports FTP and <code>gopher</code> objects too. FTP gopher <code>squid</code> handles all requests in a single, non-blocking, I/O-driven process. <code>squid</code> keeps meta data and, especially, hot objects cached in RAM, it caches DNS lookups, supports non-blocking DNS lookups and implements negative caching of failed requests. <code>squid</code> also supports SSL, extensive access controls and full request squidSSL logging. By using the lightweight Internet Cache Protocol, <code>squid</code> caches can be arranged in a hierarchy or mesh for additional bandwidth savings.</p> <p><code>squid</code> can be used for a number of things, including bandwidth saving, handling traffic spikes and caching sites that are occasionally unavailable. <code>squid</code> can also be used for load balancing. Essentially, the first time <code>squid</code> receives a request from a browser, it acts as an intermediary and passes the request on to the server. <code>squid</code> then saves a copy of the object. If no other clients request the same object, no benefit will be gained. However, if multiple clients request the object before it expires from the cache, <code>squid</code> can speed up transactions and save bandwidth. If you've ever needed a document from a slow site, say one located in another country or hosted on a slow connection, or both, you will notice the benefit of having a document cached. The first request may be slower than molasses, but the next request for the same document will be much faster, and the originating server's load will be lightened.</p> <p><code>squid</code> consists of a main server program <code>squid</code>, a Domain Name System lookup program <code>dnsserver</code>, some optional programs for rewriting requests and performing authentication, and some management and client tools. When <code>squid</code> starts up, it spawns a configurable number of <code>dnsserver</code> processes, each of which can perform a single, blocking Domain Name System (DNS) lookup. This reduces the amount of time the cache waits for DNS lookups.</p> <p><code>squid</code> is normally obtained in source code format. On most systems a simple <code>make install</code> will suffice. After that, you will also have a set of configuration files. In most distributions all the squid configuration files are, by default, kept in the directory <code>/usr/local/squid/etc</code>. However, the location may vary, depending on the style and habits of your distribution. The Debian packages, for example, place the configuration files in <code>/etc</code>, which is the normal home directory for <code>.conf</code> files. Though there is more than one file in this directory, only one file is important to most administrators, namely the <code>squid.conf</code> file. There are just about 125 option tags in this file but only eight options are really needed to get <code>squid</code> up and running. The other options just give you additional flexibility.</p> <p><code>squid</code> assumes that you wish to use the default value if there is no occurrence of a tag in the <code>squid.conf</code> file. Theoretically, you could even run <code>squid</code> with a zero length configuration file. However, you will need to change at least one part of the configuration file, i.e. the default <code>squid.conf</code> denies access to all browsers. You will need to edit the Access Control Lists to allow your clients to use the <code>squid</code> proxy. The most basic way to perform access control is to use the <code>http_access</code> option (see below).</p> <p><code>http_port</code></p> <ul> <li>This option determines on which port(s) <code>squid</code> will listen     squidhttp_port for requests. By default this is port <code>3128</code>.     Another commonly used port is port <code>8080</code>.</li> </ul> <p><code>cache_dir</code></p> <ul> <li> <p>Used to configure specific storage areas. If you use more than one     disk squidcache_dir for cached data, you may need more than one     mount point (e.g., <code>/usr/local/squid/cache1</code> for the first disk,     <code>/usr/local/squid/cache2</code> for the second disk). <code>squid</code> allows you     to have more than one <code>cache_dir</code> option in your config file. This     option can have four parameters:</p> <pre><code>    cache_dir /usr/local/squid/cache/ 100 16 256\n</code></pre> <p>The first option determines in which directory the cache should be maintained. The next option is a size value in Megabytes where the default is 100 Megabytes. <code>squid</code> will store up to that amount of data in the specified directory. The next two options will set the number of subdirectories (first and second tier) to create in this directory. <code>squid</code> creates a large number of directories and stores just a few files in each of them in an attempt to speed up disk access (finding the correct entry in a directory with one million files in it is not efficient: it's better to split the files up into lots of smaller sets of files).</p> </li> </ul> <p><code>http_access</code>; <code>acl</code></p> <ul> <li> <p>The basic syntax of the option is     <code>http_access allow|deny [!]aclname</code>. squidhttp_access If you want     to provide access to an internal network, and deny access to anyone     else, your options might look like this:</p> <pre><code>    acl home src 10.0.0.0/255.0.0.0\n    http_access allow home\n</code></pre> <p>The first line sets up an Access Control List class called \"home\" of an internal network range of ip addresses. The second line allows access to that range of ip addresses. Assuming it's the final line in the access list, all other clients will be denied. See also the section on acl.</p> <p>::: {.tip} Note that <code>squid</code>'s default behavior is to do the opposite of your last access line if it can't find a matching entry. For example, if the last line is set to \"allow\" access for a certain set of network addresses, then <code>squid</code> will deny any client that doesn't match any of its rules. On the other hand, if the last line is set to \"deny\" access, then <code>squid</code> will allow access to any client that doesn't match its rules. :::</p> </li> </ul> <p><code>auth_param</code></p> <ul> <li>This option is used to specify which program to start up as an     squidauth_param authenticator. You can specify     the name of the program and any parameters needed.</li> </ul> <p><code>redirect_program</code>; <code>redirect_children</code></p> <ul> <li>The <code>redirect_program</code> is used to specify which program to start up     squidredirect_program as a redirector. The option     <code>redirect_children</code> is used to specify how many processes to start     up to do redirection.</li> </ul> <p>After you have made changes to your configuration, issue <code>squid -k reconfigure</code> so that <code>squid</code> will use squid-k reconfigure the changes.</p>"},{"location":"lpic2.208.3/#redirectors","title":"Redirectors","text":"<p><code>squid</code> can be configured to pass every incoming URL through a redirector process squidredirector that returns either a new URL or a blank line to indicate no change. A redirector is an external program, e.g. a script that you wrote yourself. Thus, a redirector program is NOT a standard part of the <code>squid</code> package. However, some examples are provided in the <code>contrib/</code> directory of the source distribution. Since everyone has different needs, it is up to the individual administrators to write their own implementation.</p> <p>A redirector allows the administrator to control the web sites his users can get access to. It can be used in conjunction with transparent proxies to deny the users of squiddeny access your network access to certain sites, e.g. porn-sites and the like.</p> <p>The redirector program must read URLs (one per line) on standard input, and write rewritten URLs or blank lines on standard output. Also, <code>squid</code> writes additional information after the URL which a redirector can use to make a decision. The input line consists of four fields:</p> <pre><code>    URL ip-address/fqdn ident method\n</code></pre> <ul> <li> <p>The URL originally requested.</p> </li> <li> <p>The IP address and domain name (if already cached by <code>squid</code>) of the     client making the request.</p> </li> <li> <p>The results of any IDENT / AUTH lookup done for this client, if     enabled.</p> </li> <li> <p>The HTTP method used in the request, e.g. <code>GET</code>.</p> </li> </ul> <p>A parameter that is not known or specified is replaced by a dash.</p> <p>A sample redirector input line:</p> <pre><code>    ftp://ftp.gnome.org/pub/GNOME/stable/releases/gnome-1.0.53/README 192.168.12.34/- - GET\n</code></pre> <p>A sample response:</p> <pre><code>    ftp://ftp.net.lboro.ac.uk/gnome/stable/releases/gnome-1.0.53/README 192.168.12.34/- - GET\n</code></pre> <p>It is possible to send an HTTP redirect to the new URL directly to the client, rather than have <code>squid</code> silently fetch the alternative URL. To do this, the redirector should begin its response with <code>301:</code> or <code>302:</code> depending on the type of redirect.</p> <p>A simple very fast redirector called <code>squirm</code> is a good place to start, it uses the <code>regex</code> library to allow pattern matching.</p> <p>The following Perl script may also be used as a template for writing your own redirector:</p> <pre><code>    #!/usr/local/bin/perl\n    $|=1;           # Unbuffer output\n    while (&lt;&gt;) {\n    s@http://fromhost.com@http://tohost.org@;\n    print;\n    }\n</code></pre> <p>This Perl script replaces requests to \"http://fromhost.com\" with \"http://tohost.org\".</p>"},{"location":"lpic2.208.3/#authenticators","title":"Authenticators","text":"<p><code>squid</code> can make use of authentication. Authentication squidauthentication can be done on various levels, e.g. network or user.</p> <p>Browsers are capable to send the user's authentication credentials using a special \"authorization request header\". This works as follows. If <code>squid</code> gets a request, given there was an <code>http_access</code> rule list that points to a <code>proxy_auth</code> ACL, <code>squid</code> looks for an authorization header. If the header is present, <code>squid</code> decodes it and extracts a username and password. If the header is missing, <code>squid</code> returns an HTTP reply with status 407 (Proxy Authentication Required). The user agent (browser) receives the 407 reply and then prompts the user to enter a name and password. The name and password are encoded, and sent in the authorization header for subsequent requests to the proxy.</p> <p>Authentication is actually performed outside of the main <code>squid</code> process. When <code>squid</code> starts, it spawns a number of authentication subprocesses. These processes read usernames and passwords on <code>stdin</code> and reply with <code>OK</code> or <code>ERR</code> on <code>stdout</code>. This technique allows you to use a number of different authentication schemes. The current supported schemes are: basic, digest, ntlm and negotiate.</p> <p>Squid has some basic authentication backends. These include:</p> <ul> <li> <p>LDAP: Uses the Lightweight Directory Access Protocol</p> </li> <li> <p>NCSA: Uses a NCSA-style username and password file</p> </li> <li> <p>MSNT: Uses a Windows NT authentication domain</p> </li> <li> <p>PAM: Uses the Unix Pluggable Authentication Modules scheme</p> </li> <li> <p>SMB: Uses a SMB server like Windows NT or Samba</p> </li> <li> <p>getpwam: Uses the old-fashioned Unix password file</p> </li> <li> <p>SASL: Uses SASL libraries (Simple Authentication and Security Layer)</p> </li> <li> <p>mswin_sspi: Windows native authenticator</p> </li> <li> <p>YP: Uses the NIS database</p> </li> </ul> <p>The ntlm, negotiate and digest authentication schemes provide more secure authentication methods because passwords are not exchanged over the wire or air in plain text.</p> <p>Configuration of each scheme is done via the auth_param director in the config file. Each scheme has some global and scheme-specific configuration options. The order in which authentication schemes are presented to the client is dependent on the order the scheme first appears in the config file.</p> <p>Example configuration file with multiple directors:</p> <pre><code>    #Recommended minimum configuration per scheme:\n    #\n    #auth_param negotiate program  &lt; uncomment and complete this line to activate&gt;\n    #auth_param negotiate children 20 startup=0 idle=1\n    #auth_param negotiate keep_alive on\n    #\n    #auth_param ntlm program &lt; uncomment and complete this line to activate&gt;\n    #auth_param ntlm children 20 startup=0 idle=1\n    #auth_param ntlm keep_alive on\n    #\n    #auth_param digest program &lt; uncomment and complete this line&gt;\n    #auth_param digest children 20 startup=0 idle=1\n    #auth_param digest realm Squid proxy-caching web server\n    #auth_param digest nonce_garbage_interval 5 minutes\n    #auth_param digest nonce_max_duration 30 minutes\n    #auth_param digest nonce_max_count 50\n    #\n    #auth_param basic program &lt; uncomment and complete this line&gt;\n    #auth_param basic children 5 startup=5 idle=1\n    #auth_param basic realm Squid proxy-caching web server\n    #auth_param basic credentialsttl 2 hours\n</code></pre>"},{"location":"lpic2.208.3/#access-policies","title":"Access policies","text":"<p>Many <code>squid.conf</code> options require the use of Access Control Lists squidsquid.conf (ACLs). Each ACL consists of a name, type and value (a string or filename). ACLs are often regarded as being the most difficult part of the <code>squid</code> cache configuration, i.e. the layout and concept is not immediately obvious to most people. Additionally, the use of external authenticators and the default ACL augment to the confusion. squidACL</p> <p>ACLs can be seen as definitions of resources that may or may not gain access to certain functions in the web-cache. Allowing the use of the proxy server is one of these functions.</p> <p>To regulate access to certain functions, you will have to define an ACL first, and then add a line to deny or allow access to a function of the cache, thereby using that ACL as a reference. In most cases the feature to <code>allow</code> or <code>deny</code> will be <code>http_access</code>, which allows or denies a web browsers access to the web-cache. The same principles apply to the other options, such as <code>icp_access</code> (Internet Cache Protocol).</p> <p>To determine whether a resource (e.g. a user) has access to the web-cache, <code>squid</code> works its way through the <code>http_access</code> list from top to bottom. It will squidhttp_access allow squidhttp_access deny match the rules, until one is found that matches the user and either denies or allows access. Thus, if you want to allow access to the proxy only to those users whose machines fall within a certain IP range you would use the following:</p> <pre><code>    acl ourallowedhosts src 192.168.1.0/255.255.255.0\n    acl all src 0.0.0.0/0.0.0.0\n\n    http_access allow ourallowedhosts\n    http_access deny all\n</code></pre> <p>If a user from 192.168.1.2 connects using TCP and requests an URL, <code>squid</code> will work it's way through the list of <code>http_access</code> lines. It works through this list from top to bottom, stopping after the first match to decide which one they are in. In this case, <code>squid</code> will match on the first <code>http_access</code> line. Since the policy that matched is <code>allow</code>, <code>squid</code> would proceed to allow the request.</p> <p>The <code>src</code> option on the first line is one of the options you can use to decide which domain the requesting user is in. You can regulate access based on the source or destination IP address, domain or domain regular expression, hours, days, URL, port, protocol, method, username or type of browser. ACLs may also require user authentication, specify an SNMP read community string, or set a TCP connection limit.</p> <p>For example, these lines would keep all internal IP addresses off the Web except during lunchtime:</p> <pre><code>    acl allowed_hosts src 192.168.1.0/255.255.255.0\n    acl lunchtime MTWHF 12:00-13:00\n    http_access allow allowed_hosts lunchtime\n</code></pre> <p>The <code>MTWHF</code> string denotes the proper days of the week, where <code>M</code> specifies Monday, <code>T</code> specifies Tuesday and so on. <code>WHFAS</code> means Wednesday until Sunday. For more options have a look at the default configuration file <code>squid</code> installs on your system.</p> <p>Another example is the blocking of certain sites, based on their domain names:</p> <pre><code>    acl adults dstdomain playboy.com sex.com\n    acl ourallowedhosts src 192.168.1.0/255.255.255.0\n    acl all src 0.0.0.0/0.0.0.0\n\n    http_access deny adults\n    http_access allow ourallowedhosts\n    http_access deny all\n</code></pre> <p>These lines prevent access to the web-cache (<code>http_access</code>) to users who request sites listed in the <code>adults</code> ACL. If another site is requested, the next line allows access if the user is in the range as specified by the ACL <code>ourallowedhosts</code>. If the user is not in that range, the third line will deny access to the web-cache.</p> <p>To use an authenticator, you have to tell <code>squid</code> which program it should use to authenticate a user (using the <code>authenticate_program</code> option in the <code>squid.conf</code> file). Next you need to set up an ACL of type <code>proxy_auth</code> and add a line to regulate the access to the web-cache using that <code>ACL</code>. Here's an example:</p> <pre><code>    authenticate_program /sbin/my_auth -f /etc/my_auth.db\n    acl name proxy_auth REQUIRED\n    http_access allow name\n</code></pre> <p>The ACL points to the external authenticator <code>/sbin/my_auth</code>. If a user wants access to the webcache (the <code>http_access</code> function), you would expect that (as usual) the request is granted if the ACL <code>name</code> is matched. HOWEVER, this is not the case!</p>"},{"location":"lpic2.208.3/#authenticator-behaviour","title":"Authenticator Behaviour","text":"<p>Authenticator <code>allow</code> rules act as <code>deny</code> rules!</p> <p>If the external authenticator allowed access, the <code>allow</code> rule actually acts as if it were a <code>deny</code> rule! Any following rules are consequently checked too until another matching ACL is found. In other words: the rule \"<code>http_access allow name</code>\" should be read as \"<code>http_access deny !name</code>\". The exclamation mark signifies a negation, thus the rule \"<code>http_access deny !name</code>\" means: \"deny access to users not matching the 'name' rule\".</p> <p><code>squid</code> always adds a default ACL!</p> <p><code>squid</code> automatically adds a final rule to the ACL section that reverses the preceding (last) rule: if the last rule was an \"<code>allow</code>\" rule, a \"<code>deny all</code>\" rule would be added, and vice versa: if the last rule was a \"<code>deny</code>\" rule, an \"<code>allow all</code>\" rule would be added automatically.</p> <p>Both warnings imply that if the example above is implemented as it stands, the final line \"<code>http_access allow name</code>\" implicitly adds a final rule \"<code>http_access deny all</code>\". If the external authenticator grants access, the access is not granted, but the next rule is checked - and that next rule is the default <code>deny</code> rule if you do not specify one yourself! This means that properly authorized people would be denied access. This exceptional behavior of <code>squid</code> is often misunderstood and puzzles many novice <code>squid</code> administrators. A common solution is to add an extra line, like this:</p> <pre><code>    http_access allow name \n    http_access allow all\n</code></pre>"},{"location":"lpic2.208.3/#utilizing-memory-usage","title":"Utilizing memory usage","text":"<p><code>squid</code> uses lots of memory. For performance reasons this makes sense since it takes much, much longer to read something from disk compared to reading directly from memory. A small amount of metadata for each cached object is kept in memory, the so-called StoreEntry. For <code>squid</code> version 2 this is 56-bytes on \"small\" pointer architectures (Intel, Sparc, MIPS, etc) and 88-bytes on \"large\" pointer architectures (Alpha). In addition, there is a 16-byte cache key (MD5 checksum) associated with each StoreEntry. This means squidStoreEntry there are 72 or 104 bytes of metadata in memory for every object in your cache. A cache with 1,000,000 objects therefore requires 72 MB of memory for metadata only.</p> <p>In practice, <code>squid</code> requires much more than that. Other uses of memory by <code>squid</code> include:</p> <ul> <li> <p>Disk buffers for reading and writing</p> </li> <li> <p>Network I/O buffers</p> </li> <li> <p>IP Cache contents</p> </li> <li> <p>FQDN Cache contents</p> </li> <li> <p>Netdb ICMP measurement database</p> </li> <li> <p>Per-request state information, including full request and reply     headers</p> </li> <li> <p>Miscellaneous statistics collection</p> </li> <li> <p>Hot objects which are kept entirely in memory</p> </li> </ul> <p>You can use a number of parameters in <code>squid.conf</code> to determine <code>squid</code>'s memory utilization:</p> <ul> <li> <p>The <code>cache_mem</code> parameter specifies how much memory to use for     caching squidcache_mem hot (very popular) requests. <code>squid</code>'s     actual memory usage depends strongly on your disk space (cache     space) and your incoming request load. Reducing <code>cache_mem</code> will     usually also reduce <code>squid</code>'s process size, but not necessarily.</p> </li> <li> <p>The <code>maximum_object_size</code> option in <code>squid.conf</code>     squidmaximum_object_size specifies the maximum file size that will     be cached. Objects larger than this size will NOT be saved on disk.     The value is specified in kilobytes and the default is 4MB. If speed     is more important than saving bandwidth, you should leave this low.</p> </li> <li> <p>The <code>minimum_object_size</code> option specifies that objects smaller than     this size will squidminimum_object_size NOT be saved on disk. The     value is specified in kilobytes, and the default is 0 KB, which     means there is no minimum (and everything will be saved to disk).</p> </li> <li> <p>The <code>cache_swap</code> option tells <code>squid</code> how much squidcache_swap disk     space it may use. If you have a large disk cache, you may find that     you do not have enough memory to run <code>squid</code> effectively. If it     performs badly, consider increasing the amount of RAM or reducing     the <code>cache_swap</code>.</p> </li> </ul>"},{"location":"lpic2.208.4/","title":"Implementing Nginx as a web server and a reverse proxy (208.4)","text":""},{"location":"lpic2.208.4/#implementing-nginx-as-a-web-server-and-a-reverse-proxy-2084","title":"Implementing Nginx as a web server and a reverse proxy (208.4)","text":"<p>Candidates should be able to install and configure a reverse proxy server, Nginx. Basic configuration of Nginx as a HTTP server is included.</p>"},{"location":"lpic2.208.4/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Nginx</p> </li> <li> <p>Reverse Proxy</p> </li> <li> <p>Basic Web Server</p> </li> </ul>"},{"location":"lpic2.208.4/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/etc/nginx/</code></p> </li> <li> <p><code>nginx</code></p> </li> </ul>"},{"location":"lpic2.208.4/#nginx","title":"NGINX","text":"<p>nginx Nginx can be used as a webserver, an HTTP reverse proxy or as an IMAP/POP3 proxy. It is pronounced as <code>engine-x</code>. Nginx is performing so well that large sites as Netflix, Wordpress and GitHub rely on Nginx. It doesn't work using threads as most of the other webserver software does but it's using an event driven (asynchronous) architecture. It has a small footprint and performs very well under load with predictable usage of resources. This predictable performance and small memory footprint makes Nginx interesting in both small and large environments. Nginx is distributed as Open Source software. There is also 'Nginx Plus', which is the commercial edition. This book will focus on the Open Source edition.</p>"},{"location":"lpic2.208.4/#reverse-proxy","title":"Reverse Proxy","text":"<p>A proxy server is a go-between or intermediary server that forwards requests for content from multiple clients to different servers across the Internet. A reverse proxy server is a type of proxy server that typically sits behind the firewall in a private network and directs client requests to the appropriate back-end server. A reverse proxy provides an additional level of abstraction and control to ensure the smooth flow of network traffic between clients and servers.</p> <p>Common uses for a reverse proxy server include:</p> <ul> <li> <p>Load balancing -- A reverse proxy server can act as a \"traffic cop,\"     sitting in front of your back-end servers and distributing client     requests across a group of servers in a manner that maximizes speed     and capacity utilization while ensuring no server is overloaded,     which can degrade performance. If a server goes down, the load     balancer redirects traffic to the remaining online servers.</p> </li> <li> <p>Web acceleration -- Reverse proxies can compress inbound and     outbound data, as well as cache commonly requested content, both of     which speed up the flow of traffic between clients and servers. They     can also perform additional tasks such as SSL encryption to take     load off of your web servers, thereby boosting their performance.</p> </li> <li> <p>Security and anonymity -- By intercepting requests headed for your     back-end servers, a reverse proxy server protects their identities     and acts as an additional defense against security attacks. It also     ensures that multiple servers can be accessed from a single record     locater or URL regardless of the structure of your local area     network.</p> </li> </ul> <p>Using Nginx as reverse HTTP proxy is not hard to configure. A very basic reverse proxy setup might look like this:</p> <pre><code>location / {\n      proxy_set_header X-Real-IP $remote_addr;\n      proxy_set_header X-Forwarded-For $remote_addr;\n      proxy_set_header Host      $host;\n      proxy_pass       http://localhost:8000;\n}\n</code></pre> <p>In this example all requests received by Nginx, depending on the configuration of the server parameters in <code>/etc/nginx/nginx.conf</code>, are forwarded to an HTTP server running on localhost and listening on port 8000. The Nginx configuration file looks like this:</p> <pre><code>server {\n    listen   80;\n\n    root /var/www/; \n    index index.php index.html index.htm;\n\n    server_name example.com www.example.com;\n\n    location / {\n        try_files $uri $uri/ /index.php;\n    }\n\n    location ~ \\.php$ {    \n        proxy_set_header X-Real-IP  $remote_addr;\n        proxy_set_header X-Forwarded-For $remote_addr;\n        proxy_set_header Host $host;\n        proxy_pass http://localhost:8080;\n    }\n\n    location ~ /\\.ht {\n        deny all;\n    }\n}\n</code></pre> <p>The line starting with <code>location  ~ /\\.ht</code> is added to prevent Nginx of displaying the content of Apache's .htaccess files. The try_files line is used to attempt to serve whatever page the visitor requests. If nginx is unable, then the file is passed to the proxy.</p>"},{"location":"lpic2.208.4/#basic-web-server","title":"Basic Web Server","text":"<p>The default location for the configuration file in Nginx is <code>/etc/nginx/nginx.conf</code>.</p> <p>A basic Nginx configuration, able to serve html files, looks like this:</p> <pre><code>server {\n    # This will listen on all interfaces, you can instead choose a specific IP\n    # such as listen x.x.x.x:80;  \n    listen 80;\n\n    # Here you can set a server name, you can use wildcards such as *.example.com\n    # however remember if you use server_name *.example.com; You'll only match subdomains\n    # to match both subdomains and the main domain use both example.com and *.example.com\n    server_name example.com www.example.com;\n\n    # It is best to place the root of the server block at the server level, and not the location level\n    # any location block path will be relative to this root. \n    root /usr/local/www/example.com;\n\n    # Access and error logging. NB: Error logging cannot be turned off. \n    access_log /var/log/nginx/example.access.log;\n    error_log /var/log/nginx/example.error.log;\n\n    location / { \n        # Rewrite rules and other criterias can go here\n        # Remember to avoid using if() where possible (http://wiki.nginx.org/IfIsEvil)\n    }\n}\n</code></pre> <p>For PHP support Nginx relies on a PHP fast-cgi spawner. Preferable is <code>php-fpm</code> which can be found at http://php-fpm.org. It has some unique features like adaptive process spawning and statistics and has the ability to start workers with different uid/gid/chroot/environment and different php.ini. The safe_mode can be replaced using this feature.</p> <p>You can add the content below to <code>nginx.conf</code>. A better practice is to put the contents in a file and include this file into the main configuration file of Nginx. Create a file, for example <code>php.conf</code> and include the next line at the end of the Nginx main configuration file:</p> <pre><code>include php.conf;\n</code></pre> <p>The content of <code>php.conf</code> :</p> <pre><code>location ~ \\.php {\n    # for security reasons the next line is highly encouraged\n    try_files $uri =404;\n\n    fastcgi_param  QUERY_STRING       $query_string;\n    fastcgi_param  REQUEST_METHOD     $request_method;\n    fastcgi_param  CONTENT_TYPE       $content_type;\n    fastcgi_param  CONTENT_LENGTH     $content_length;\n\n    fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;\n\n    # if the next line in yours still contains $document_root\n    # consider switching to $request_filename provides\n    # better support for directives such as alias\n    fastcgi_param  SCRIPT_FILENAME    $request_filename;\n\n    fastcgi_param  REQUEST_URI        $request_uri;\n    fastcgi_param  DOCUMENT_URI       $document_uri;\n    fastcgi_param  DOCUMENT_ROOT      $document_root;\n    fastcgi_param  SERVER_PROTOCOL    $server_protocol;\n\n    fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;\n    fastcgi_param  SERVER_SOFTWARE    nginx;\n\n    fastcgi_param  REMOTE_ADDR        $remote_addr;\n    fastcgi_param  REMOTE_PORT        $remote_port;\n    fastcgi_param  SERVER_ADDR        $server_addr;\n    fastcgi_param  SERVER_PORT        $server_port;\n    fastcgi_param  SERVER_NAME        $server_name;\n\n    # If using a unix socket...\n    # fastcgi_pass unix:/tmp/php5-fpm.sock;\n\n    # If using a TCP connection...\n    fastcgi_pass 127.0.0.1:9000;\n}\n</code></pre>"},{"location":"lpic2.209.0/","title":"File Sharing (209)","text":"<p>This topic has a weight of 8 points and contains the following objectives:</p>"},{"location":"lpic2.209.0/#objective-2091-samba-server-configuration-5-points","title":"Objective 209.1; SAMBA Server Configuration (5 points)","text":"<ul> <li>Candidates should be able to set up a SAMBA server for various     clients. This objective includes setting up Samba as a standalone     and a member server to a Windows Active Directory domain. Both     setups should be configured to share directories and printers to the     clients.</li> </ul>"},{"location":"lpic2.209.0/#objective-2092-nfs-server-configuration-3-points","title":"Objective 209.2; NFS Server Configuration (3 points)","text":"<ul> <li>Candidates should be able to export filesystems using NFS. This     objective includes access restrictions, mounting an NFS filesystem     on a client and securing NFS.</li> </ul>"},{"location":"lpic2.209.1/","title":"SAMBA Server Configuration (209.1)","text":""},{"location":"lpic2.209.1/#samba-server-configuration-2091","title":"SAMBA Server Configuration (209.1)","text":""},{"location":"lpic2.209.1/#objective-2091-configuring-a-samba-server-5-points","title":"Objective 209.1; Configuring a Samba Server (5 points)","text":"<ul> <li>Candidates should be able to set up a SAMBA server for various     clients. This objective includes setting up Samba as a standalone     and a member server to a Windows Active Directory domain. Both     setups should be configured to share directories and printers to the     clients.</li> </ul>"},{"location":"lpic2.209.1/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Samba 4 documentation</p> </li> <li> <p>Samba configuration files</p> </li> <li> <p>Samba tools and utilities</p> </li> <li> <p>Mounting Samba shares on Linux</p> </li> <li> <p>Samba daemons</p> </li> <li> <p>Mapping Windows usernames to Linux usernames</p> </li> <li> <p>User-Level and Share-Level security</p> </li> </ul>"},{"location":"lpic2.209.1/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>smbd, nmbd</code></p> </li> <li> <p><code>smbstatus, testparm, smbpasswd, nmblookup</code></p> </li> <li> <p><code>smbclient</code></p> </li> <li> <p><code>samba-tool</code></p> </li> <li> <p><code>net</code></p> </li> <li> <p><code>/etc/smb/</code></p> </li> <li> <p><code>/var/log/samba/</code></p> </li> </ul>"},{"location":"lpic2.209.1/#what-is-samba","title":"What is Samba?","text":"<p>Samba implements the Server Message Block (SMB) protocol.  This is the protocol used by Microsoft to implement file and printer sharing. By installing Samba on a Linux machine, machines running the Windows Operating System and other platforms for which a SMB client is available can connect to the Linux machine and thus use files and printers made available by the Linux machine. Shared resources are also called \"shares\" or \"services\".</p> <p>Samba is available for many platforms including Linux, AIX, HP-UX, Solaris, FreeBSD, OS/2, AmigaOS. Consult Samba, Opening Windows To A Wider World, for further information on platforms supporting Samba and for downloading a binary or source distribution for your platform.</p>"},{"location":"lpic2.209.1/#installing-the-samba-components","title":"Installing the Samba components","text":"<p>Depending on your distribution, you can</p> <ul> <li> <p>get the sources and compile them yourself</p> </li> <li> <p>install the package using <code>yum</code> or <code>rpm</code> (Red Hat, SuSE etc.)</p> </li> <li> <p>install the package using <code>apt</code>(Debian, Ubuntu)</p> </li> </ul> <p>Samba can be run either from <code>inetd</code> or as daemons. When run via <code>inetd</code> you can save some memory and use tcpwrappers for extra security. When run as daemons, the server is always ready and sessions are faster. If you wish to use encrypted passwords, you will need to have a separate <code>/etc/samba/smbpasswd</code> file because the layout sambasmbpasswd differs from <code>/etc/passwd</code>. During installation, you can choose to have <code>/etc/samba/smbpasswd</code> generated from your <code>/etc/passwd</code> file. If you choose not to do so, use <code>smbpasswd</code> to set individual passwords for users.</p> <p>Samba consists of two daemons:</p> <ul> <li> <p><code>nmbd</code>: the NetBIOS Name Service Daemon which     handles NetBIOS name lookups and WINS requests. If you've told     Samba to function as a WINS server, an extra copy of     <code>nmbd</code> will be running. Additionally, if DNS is used to translate     NetBIOS names, yet another copy of <code>nmbd</code> will be running.</p> </li> <li> <p><code>smbd</code>: the Server Message Block Daemon which handles file and     printer access. For each client connected to the server, an extra     copy of <code>smbd</code> runs.</p> </li> </ul> <p>Samba uses both the UDP and TCP protocols. TCP/139 is used for file and printer sharing. sambaport 139 UDP is used for the registration and translation of NetBIOS names, and for browsing the network. UDP/137 is used for name service requests and sambaport 137 responses. UDP/138 is used for datagram services to transmit small amounts of data, such as server announcements.</p>"},{"location":"lpic2.209.1/#samba-commands","title":"Samba commands","text":""},{"location":"lpic2.209.1/#samba-core-commands","title":"Samba core commands","text":""},{"location":"lpic2.209.1/#smbstatus","title":"smbstatus","text":"<p>Report on current Samba connections:</p> <pre><code>    $ smbstatus\n\n    Samba version 4.1.12\n    PID     Username      Group         Machine                        \n    -------------------------------------------------------------------\n    23632     nobody        nobody        10.20.24.186 (ipv4:10.20.24.186:49394)\n\n    Service      pid     machine       Connected at\n    -------------------------------------------------------\n    public       23632   10.20.24.186  Sat Oct 10 10:15:11 2015\n\n    No locked files\n</code></pre>"},{"location":"lpic2.209.1/#testparm","title":"testparm","text":"<p>Check an smb.conf configuration file for internal correctness. If <code>testparm</code> finds an error in the <code>smb.conf</code> file it returns an exit code of 1 to the calling program, else it returns an exit code of 0. This allows shell scripts to test the output from <code>testparm</code>.</p> <p>Useful command line options:</p> <p>-s</p> <ul> <li>Print service definitions without prompting for a carriage return</li> </ul> <p>-v</p> <ul> <li>List all options; by default only the ones specified in <code>smb.conf</code>     are listed</li> </ul>"},{"location":"lpic2.209.1/#smbpasswd","title":"smbpasswd","text":"<p>Change a user's SMB password. By default (when run with no arguments) <code>smbpasswd</code> will attempt to change the current user's SMB password on the local machine. This is similar to the way the <code>passwd</code>(1) program works. When run by root it can be used to manage user accounts in the configured password backend. Please note that even though this utility is called <code>smbpasswd</code> it doesn't necessarily write the changes to the <code>smbpasswd</code> file. <code>smbpasswd</code> works on the <code>passdb                      backend</code> configured in <code>smb.conf</code>. See also Account information databases.</p> <p>Command line usage:</p> <p>as root:</p> <ul> <li>smbpasswd [options] [username]</li> </ul> <p>as ordinary user:</p> <ul> <li>smbpasswd [options]</li> </ul> <p>Useful command line options:</p> <p>-a</p> <ul> <li>Add a new user to the password database.</li> </ul> <p>-x</p> <ul> <li>Remove user from database</li> </ul>"},{"location":"lpic2.209.1/#nmblookup","title":"nmblookup","text":"<p>Is used to query NetBIOS names and map them to IP addresses in a network using NetBIOS over TCP/IP queries. The options of this command allow the name queries to be directed at a particular IP broadcast area or to a particular machine. All queries are done over UDP.</p> <p>Useful command line options:</p> <p>-M</p> <ul> <li>Search master browser.</li> </ul> <p>-R</p> <ul> <li>Recursion. When using nmblookup to directly query a WIINS server     with the UNICAST command line option recursion is needed to have the     WINS server respond to queries not related to its own netbios name     or IP address. Without recursion set the WINS server will only     respond with its own netbios name.</li> </ul> <p>-U \\&lt;unicast address&gt;</p> <ul> <li>Send the query to the given UNICAST address (of a WINS server)     instead of broadcasting the query. Example: \"nmblookup -R -U     10.10.10.2 clientname\"</li> </ul>"},{"location":"lpic2.209.1/#smbclient","title":"smbclient","text":"<p>Is a client that can connect to an SMB/CIFS server. It offers an interface similar to that of the ftp program (see ftp(1)). Operations include actions like getting files from the server to the local machine, putting files from the local machine to the server, retrieving directory information from the server and so on.</p> <p>Useful command line options:</p> <p>-L \\&lt;netbios name/IP&gt;</p> <ul> <li>List services available on the server responding to the given     netbios name.</li> </ul> <p>-I \\&lt;IP address&gt;</p> <ul> <li>Connect to given IP address directly instead of querying the network     for the IP address of the given netbios name.</li> </ul> <p>-c \\&lt;command&gt;</p> <ul> <li>Run given SMB command on the server. One implementation is printing     with smbclient.</li> </ul> <p>-U</p> <ul> <li>Connect as the given user.</li> </ul>"},{"location":"lpic2.209.1/#samba-tool","title":"samba-tool","text":"<p>Samba-tool is the main administration tool available with samba4. It can be used to configure and manage all aspects of the samba server when it is configured as an Active Directory Domain Controller (AD DC). Even though the manpages currently state otherwise, it is not supported to use <code>samba-tool</code> to configure the server as a domain member or standalone server. These options will be removed in a future version of samba-tool. Note that this tool will not be available on all systems when installed using the packages. For example, on RHEL7 and CentOS 7, it will only be available when Samba4 is installed from source.</p> <p>A short list of the commands and what the are for is shown below. For a full list of the options for the commands you can view the manpage or the online manpages</p> <p>dbcheck</p> <ul> <li>To check to local AD database for errors.</li> </ul> <p>delegation</p> <ul> <li>To manage delegations.</li> </ul> <p>dns</p> <ul> <li>To manage the DNS records.</li> </ul> <p>domain</p> <ul> <li>To manage domain options, for example creating an AD DC.</li> </ul> <p>drs</p> <ul> <li>To manage Directory Replication Services (DRS).</li> </ul> <p>dsacl</p> <ul> <li>To manage DS ACLs.</li> </ul> <p>fsmo</p> <ul> <li>For manage Flexible Single Master Operations (FSMO).</li> </ul> <p>gpo</p> <ul> <li>To manage Group Policy Objects (GPO).</li> </ul> <p>group</p> <ul> <li>To manage or create groups.</li> </ul> <p>ldapcmp</p> <ul> <li>To compare two LDAP databases.</li> </ul> <p>ntacl</p> <ul> <li>To manage NT ACLs.</li> </ul> <p>rodc</p> <ul> <li>To manage Read-Only Domain Controllers (RODC)</li> </ul> <p>sites</p> <ul> <li>To manage sites.</li> </ul> <p>spn</p> <ul> <li>To manage Service Principal Names (SPN).</li> </ul> <p>testparm</p> <ul> <li>To check the configuration files.</li> </ul> <p>time</p> <ul> <li>To retrieve to time on a server.</li> </ul> <p>user</p> <ul> <li>To manage or create users.</li> </ul>"},{"location":"lpic2.209.1/#net","title":"net","text":"<p>net samba remote administration Tool for administration of Samba and remote CIFS servers. The Samba <code>net</code> utility is meant to work just like the net utility available for windows and DOS. The first argument should be used to specify the protocol to use when executing a certain command. ADS is used for ActiveDirectory, RAP is using for old (Win9x/NT3) clients and RPC can be used for NT4 and Windows. If this argument is omitted, <code>net</code> will try to determine it automatically. Not all commands are available on all protocols.</p> <p>The functionality of the <code>net</code> is too extensive to cover in this section. Have a look at <code>man                      net</code> or <code>net help</code> to show a list of available commands and command line options. <code>net help                      &lt;command&gt;</code> will give command specific information:</p> <pre><code>    $ net help user\n\n    net [&lt;method&gt;] user [misc. options] [targets]\n        List users\n\n    net [&lt;method&gt;] user DELETE &lt;name&gt; [misc. options] [targets]\n        Delete specified user\n\n    net [&lt;method&gt;] user INFO &lt;name&gt; [misc. options] [targets]\n        List the domain groups of the specified user\n\n    net [&lt;method&gt;] user ADD &lt;name&gt; [password] [-c container] [-F user flags] [misc. options] [targets]\n        Add specified user\n\n    net [&lt;method&gt;] user RENAME &lt;oldusername&gt; &lt;newusername&gt; [targets]\n        Rename specified user\n\n    Valid methods: (auto-detected if not specified)\n        ads             Active Directory (LDAP/Kerberos)\n        rpc             DCE-RPC\n        rap             RAP (older systems)\n\n    Valid targets: choose one (none defaults to localhost)\n        -S or --server=&lt;server&gt;       server name\n        -I or --ipaddress=&lt;ipaddr&gt;    address of target server\n        -w or --workgroup=&lt;wg&gt;        target workgroup or domain\n\n    Valid miscellaneous options are:\n        -p or --port=&lt;port&gt;       connection port on target\n        -W or --myworkgroup=&lt;wg&gt;  client workgroup\n        -d or --debuglevel=&lt;level&gt;    debug level (0-10)\n        -n or --myname=&lt;name&gt;     client name\n        -U or --user=&lt;name&gt;       user name\n        -s or --configfile=&lt;path&gt; pathname of smb.conf file\n        -l or --long            Display full information\n        -V or --version         Print samba version information\n        -P or --machine-pass        Authenticate as machine account\n        -e or --encrypt         Encrypt SMB transport (UNIX extended servers only)\n        -k or --kerberos        Use kerberos (active directory) authentication\n        -C or --comment=&lt;comment&gt; descriptive comment (for add only)\n        -c or --container=&lt;container&gt; LDAP container, defaults to cn=Users (for add in ADS only)\n</code></pre> <p>Using <code>net</code> to get a list of shares from server \"sambaserver\":</p> <pre><code>    $ net -S sambaserver -U alice share\n    Enter alice's password: \n    public\n    share1\n    share2\n    Printer_1\n    IPC$\n    alice\n    Printer_2\n</code></pre> <p>Using <code>net</code> to get the current time of server \"sambaserver\":</p> <pre><code>    $ net -S sambaserver time\n    Sat Oct 10 10:10:04 2015\n</code></pre>"},{"location":"lpic2.209.1/#commands-not-part-of-the-samba-core","title":"Commands not part of the Samba core","text":""},{"location":"lpic2.209.1/#smbmount","title":"smbmount","text":"<p>smbmount NOTE: Even though <code>smbmount</code> has been abandoned by most major Linux distributions in favor of <code>mount.cifs</code> you can still expect questions about <code>smbmount</code> during your LPIC2 exam.</p> <p>smbfs Even as <code>smbmount</code> was maintained by the Samba community is was not a part of the core samba-client packages. The \"smbfs\" package contains the <code>smbmount</code> command and must be installed to be able to use smbmount.</p> <p><code>smbmount</code> is used to mount file systems shared over SMB. Most probably these file systems are found on Windows systems and shared with Linux systems with SMB client software installed. <code>smbmount</code> is the command line utility for mounting SMB file systems. For a more permanent implementation the <code>smbfs</code> is available for use in <code>/etc/fstab</code>.</p> <p>Both methods to mount SMB file systems accept options to determine how the file system is mounted. The most common options are listed here:</p> <p>username</p> <ul> <li>Define username for authentication of the SMB session.</li> </ul> <p>password</p> <ul> <li>Define password for authentication of the SMB session.</li> </ul> <p>credentials</p> <ul> <li>This option points to a file containing a username and password. Use     of this option is prefered over using the username and password in     the command line options or in <code>/etc/fstab</code>. This file must have     proper protection so only the user and/or root can read it.<pre><code>    username=value\n    password=value\n</code></pre> </li> </ul> <p>uid</p> <ul> <li>Define UID used for the local representation of the files on the     mounted file system.</li> </ul> <p>gid</p> <ul> <li>Define GID used for the local representation of the files on the     mounted file system.</li> </ul> <p>fmask</p> <ul> <li> <p>Define permissions of remote files in the local representation of     the mounted file system. This doesn't affect the actual permissions     on the remote server.</p> <p>Important: The name of the option is deceptive. It's not a mask but the actual permissions that is defined.</p> </li> </ul> <p>dmask</p> <ul> <li> <p>Define permissions of remote directories in the local representation     of the mounted file system. This doesn't affect the actual     permissions on the remote server.</p> <p>Important: The name of the option is deceptive. It's not a mask but the actual permissions that is defined.</p> </li> </ul> <p>rw/ro</p> <ul> <li>Mount the filesystem read-write or read-only.</li> </ul> <p>Example command line usage:</p> <pre><code>    smbmount //windows/winshare2 /opt/winshare2 -o \\ \n        username=alice.jones,password=Alice,uid=nobody,gid=nobody,fmask=775,dmask=775,rw,hard\n</code></pre> <p>Example of <code>/etc/fstab</code> usage:</p> <pre><code>    //windows/winshare2 /opt/winshare2 smbfs \\ \n        username=alice.jones,password=Alice,uid=nobody,gid=nobody,fmask=775,dmask=775,rw,hard ://windows/winshare2 0 0\n</code></pre>"},{"location":"lpic2.209.1/#samba-logging","title":"Samba logging","text":"<p>Samba by default writes logging to files in the <code>/var/log/samba/</code> directory:</p> <ul> <li> <p>log.nmbd</p> </li> <li> <p>Logging from the Netbios name lookup daemon.</p> </li> <li> <p>log.smbd</p> <ul> <li>Logging from the SMB daemon.</li> </ul> </li> </ul> <p>Logging can be configured with global parameters in the Samba configuration. See Configuration parameters for a few of the most useful parameters.</p>"},{"location":"lpic2.209.1/#account-information-databases","title":"Account information databases","text":"<p>Samba can be configured to use different backends to store or retrieve account information. The most important are desribed here. Smb.conf configuration option: \"passwd backend\".</p>"},{"location":"lpic2.209.1/#smbpasswd_1","title":"smbpasswd","text":"<p>With the <code>smbpasswd</code> method a plain text file contains all account information. Passwords are encrypted.</p> <p>Drawbacks to using <code>smbpasswd</code>:</p> <ul> <li> <p>Doesn't scale.</p> </li> <li> <p>No replication.</p> </li> <li> <p>Lacks storage of Windows information (RIDs or NT groups).</p> </li> </ul> <p>Usage of <code>smbpasswd</code> is not recommended because it does not scale well or hold any Windows information.</p>"},{"location":"lpic2.209.1/#tdbsam","title":"tdbsam","text":"<p><code>tdbsam</code> also lacks scalability because it's just a local database (Trivial database) that doesn't support replication. One advantage of <code>tdbsam</code> over <code>smbpasswd</code> is its capabillity to also store Windows information with the accounts.</p> <p>Usage of <code>tdbsam</code> is not recommended for enterprise environments because it does not scale well and (FIXME what does he mean?) holds any Windows information. Tdbsam can be used for standalone Samba servers with a recommended maximum of 250 users.</p>"},{"location":"lpic2.209.1/#ldapsam","title":"ldapsam","text":"<p>In enterprise environments the usage of <code>ldapsam</code> is recommended. <code>Ldapsam</code> uses LDAP as backend and LDAP is highly scalable.</p>"},{"location":"lpic2.209.1/#samba-configuration","title":"Samba configuration","text":""},{"location":"lpic2.209.1/#samba-configuration-directory-etcsmb-or-etcsamba","title":"Samba configuration directory <code>/etc/smb</code> or <code>/etc/samba</code>.","text":"<p>The LPI objectives ask for knowledge about <code>/etc/smb/</code>. In some distributions <code>/etc/samba/</code> is used instead. Files and folders that exist in <code>/etc/smb/</code> or <code>/etc/samba/</code> are:</p> <ul> <li> <p><code>lmhosts</code> - The Samba NetBIOS hosts file;</p> </li> <li> <p><code>smb.conf</code> - The configuration file for the Samba suite;</p> </li> <li> <p><code>netlogon</code> - The logon directory for user logon.</p> </li> </ul>"},{"location":"lpic2.209.1/#smbconf","title":"smb.conf","text":"<p>Samba is configured via <code>/etc/samba/smbd.conf</code>. This file consists of sections containing configuration options. The name of the section is the name of the shared resource.</p>"},{"location":"lpic2.209.1/#special-sections","title":"special sections","text":"<p>There are three special sections within the samba configuration file:</p> <p>[global] -   samba     global     Global Samba configuration</p> <p>[homes] -   samba     homes     Special section: definition of home directories</p> <pre><code>Home directories can be accessed by using the user name as service,\nor by directly accessing the \"homes\" service:\n\n        smbclient //sambaserver/alice -U alice\n        smbclient //sambaserver/homes -U alice\n\n\nBoth these commands will result in access to the home directory of\nuser \"alice\".\n</code></pre> <p>[printers] -   samba     printers     Special resource or service: global configuration to enable access     to all printers</p> <pre><code>Note: individual printers can also be made available as a service\nwith the `printable` parameter.\n</code></pre>"},{"location":"lpic2.209.1/#configuration-parameters","title":"Configuration parameters","text":"<p>In this section the most important configuration options are explained, grouped by Samba configuration section (type). Most can also be found in the examples section further on.</p> <p>The smb.conf man pages divide parameters into two groups:</p> <p>global</p> <ul> <li>Parameters that can only be used in the <code>[global]</code> sections of the     Samba configuration.</li> </ul> <p>services</p> <ul> <li> <p>Parameters that are used in service sections of the Samba     configuration.</p> <p>Some of these paramaters can also be used globally.</p> </li> </ul>"},{"location":"lpic2.209.1/#global","title":"[global]","text":"<p>The <code>[global]</code> section contains global parameters, but it is also used to set service parameters in a global context (providing default values if the parameter is not set for a specific service).</p> <p>netbios name</p> <ul> <li>This option sets the NetBIOS name by which the Samba server is     known. This name will be the name that services are advertised     under. By default it is the same as the system's hostname.</li> </ul> <p>netbios aliases</p> <ul> <li>This option sets an alias by which the Samba server is alternatively     known.</li> </ul> <p>log file</p> <ul> <li>This option dictates to what file(s) logging is written. The file     name accepts macros enabling for instance writting a log file per     client: <code>/var/log/samba/log.%m</code>.</li> </ul> <p>workgroup</p> <ul> <li>Server and clients must be members of the same workgroup.</li> </ul> <p>realm</p> <ul> <li>This option specifies the kerberos realm to use. The realm is used     as the ADS equivalent of the NT4 domain.</li> </ul> <p>server string</p> <ul> <li>Any string you want to apear in list contexts.</li> </ul> <p>encrypt passwords</p> <ul> <li>Windows encrypts passwords. This option will also need to be turned     on for Samba.</li> </ul> <p>security</p> <ul> <li>This option determines what security mode to use. Most commonly used     is <code>user</code> for standalone file servers or Samba servers that also     function as a DC. If the Samba server is connected to a Windows     domain this option must be set to <code>ads</code> or <code>domain</code>.</li> </ul> <p>unix password sync</p> <ul> <li>This boolean parameter in the <code>[global]</code> section controls whether     Samba attempts to synchronize the UNIX password with the SMB     password when the encrypted SMB password in the <code>smbpasswd</code> file is     changed. If this is set to yes (unix password sync = yes), the     program specified in the <code>passwd</code> program parameter is called AS     ROOT - to allow the new UNIX password to be set without access to     the old UNIX password (as the SMB password change code has no access     to the old cleartext password).</li> </ul> <p>passdb backend</p> <ul> <li> <p>This option determines what account/password backend is used. See     also Account information databases</p> <p>Mostly used options are:</p> <p>smbpasswd[:argument]</p> <p>:   Old plaintext passdb backend. Optionally takes a path to the     smbpasswd file as an argument.</p> <pre><code>Example: `passdb backend = \n                                                        smbpasswd:/etc/samba/smbpasswd`\n</code></pre> <p>tdbsam[:argument]</p> <p>:   TDB based password storage backend. Optionally takes a path to     the TDB file as an argument.</p> <pre><code>Example: `passdb backend = \n                                                        tdbsam:/etc/samba/private/passdb.tdb`\n</code></pre> <p>ldapsam[:argument]</p> <p>:   LDAP backend. Optionally takes an LDAP URL as an argument.     (defaults to \"ldap://localhost\")</p> <pre><code>Example: `passdb backend = \n                                                        ldapsam:ldap://localhost`\n</code></pre> </li> </ul> <p>username map</p> <ul> <li> <p>samba username map This option in the <code>[global]</code> section allows you     to map the client supplied username to another username on the     server. The most common usage is to map usernames used on DOS or     Windows machines to those used on the UNIX system. Another usage is     to map multiple users to a single username so that they can more     easily share files. The username map is a file where each line     should contain a single UNIX username on the left then a \"=\"     followed by a space-delimited list of usernames on the right. Quotes     must be used to specify a username that includes a space. The list     of usernames on the right may contain names of the form \\@group in     which case they will match any UNIX username in that group. The     special client name \"*\" is a wildcard and can be used to match     unknown names to a known user. Each line of the map file may be up     to 1023 characters long. If a line begins with a \"!\" then the     processing will stop at that point if it matches a name. This is     useful for lines used before a wildcard otherwise names will still     be mapped to the one using the wildcard.</p> <p>Here is an example:</p> <pre><code>    username map = /usr/local/samba/private/usermap.txt\n</code></pre> <p>Example content of <code>usermap.txt</code>:</p> <pre><code>    root = administraor admin\n    nobody = guest pcguest smbguest\n    alice.jones = alice\n    readonly = glen fred terry sarah\n    lachlan = \"Lachlan Smith\"\n    users = @sales\n</code></pre> </li> </ul> <p>guest ok</p> <ul> <li>This parameter configures guest access for a service.</li> </ul> <p>map to guest</p> <ul> <li> <p>Is guest access is enabled this option determines what sessions are     mapped to guest access. Available values are:</p> <ul> <li> <p>Never</p> </li> <li> <p>Bad User</p> </li> <li> <p>Bad Password</p> </li> <li> <p>Bad Uid (only available in ADS or DOMAIN security mode)</p> </li> </ul> </li> </ul>"},{"location":"lpic2.209.1/#service-sections","title":"service sections","text":"<p>The following parameters are used in service definitions (both special as normal services).</p> <p>path</p> <ul> <li> <p>The context in which this parameter is used determines how it is     interpreted:</p> <ul> <li> <p>In the <code>[homes]</code> section it specifies the path to the directory     that must be served as the users home directories. If omitted     the home directory defaults to the system's home directory. If     used this parameter must contain the \"%S\" macro, expanding to     the username.</p> </li> <li> <p>In a section that is set to be <code>printable</code> this parameter points     to the directory where printer spool files are written prior to     being sent to the print queue. This directory must be     world-writable and have the sticky bit set if the printer is     configured for guest access.</p> </li> <li> <p>In a <code>share</code> definition this parameter points to the directory     the share must give access to.</p> </li> </ul> </li> </ul> <p>comment</p> <ul> <li>Text field showing in service listings.</li> </ul> <p>printer name</p> <ul> <li>Points to a local print queue when configuring an individual     printer.</li> </ul> <p>printable</p> <ul> <li>Declares a service as a printer.</li> </ul> <p>browseable</p> <ul> <li>Makes service browseable. A client can browse to a service instead     of having to know the full path to the service.</li> </ul> <p>guest ok</p> <ul> <li>Guest access is enabled for this service (or globally).</li> </ul> <p>(in)valid users</p> <ul> <li>Provide a list of users that are allowed access (<code>valid users</code>) to     this service, or that are denied access (<code>invalid users</code>). Names     starting with a \"@\" are interpreted as a NIS netgroup or a Unix     group. When a name starts with a \"+\" the nsswitch mechanism is used     to find the group. With a \"&amp;\" the group will only bee looked up in     NIS. See the manual for more information.</li> </ul> <p>hosts allow|deny</p> <ul> <li>Provide a list of clients that can be granted (<code>hosts allow</code>) or     denied (<code>hosts deny</code>) access. Names can be IP addresses, networks or     host names. Names started with a \"@\" are NIS netgroups.</li> </ul> <p>writable</p> <ul> <li>Determines if a user is allowed to write to this service. Defaults     to \"no\".</li> </ul> <p>Security levels and modes</p> <p>Samba knows two security levels: \"user-level\" and \"share-level\". The server will inform the client of the security level and the client will respond in correspondance with the choosen level. The security level is determined by setting the security mode.</p> <p>The security mode is a Global setting.</p>"},{"location":"lpic2.209.1/#user-level-security","title":"User-level security","text":"<p>User-level security means that each connection is authenticated by a username and password combination which has to match with authorizations on the requested service. For \"user-level\" security the server can be set up in three modes:</p> <p>user</p> <ul> <li> <p><code>security = user</code></p> <p>Samba is running as a standalone server and will use a local password database.</p> </li> </ul> <p>ads</p> <ul> <li> <p><code>security = ads</code></p> <p>Samba will act as a Active Directory domain member in an ADS realm.</p> </li> </ul> <p>domain</p> <ul> <li> <p><code>security = domain</code></p> <p>Samba will validate the username/password to a Windows NT Primary or Backup Domain Controller.</p> </li> </ul>"},{"location":"lpic2.209.1/#share-level-security","title":"Share-level security","text":"<p><code>security = share</code></p> <p>With share-level security the client expects a password to be associated with each share, independent of the user. With share-level security the client will only pass the password provided by the remote user and does so for each seperate share. The Samba sever will then try to match the password to a confgured list of users (if provided for the share that's affected), or will use system calls (looking in nsswitch.conf or /etc/passwd) to find a Linux account matching the provided password.</p> <p>Share-level service parameters:</p> <p>only user</p> <ul> <li> <p><code>only user - yes</code></p> <p>Only the users listed in <code>username</code> have access to this service. If not any user matching the provided password is given access.</p> </li> </ul> <p>username</p> <ul> <li> <p><code>username = fred, alice</code></p> <p>Determines which users have access to this service.</p> </li> </ul> <p>Note: Because with share-level security the password to access a share is not known by just one person but by everyone who needs access share-level security is considered to be insecure and therefor support for share-level security has been removed from Samba version 4.</p> <p>Examples</p> <p>The following image decribed the environment used to implement the examples described below.</p> <p></p> <p>We've got three machines connected via a network on which we want to accomplish the following:</p> <ul> <li> <p>The machines \"sambaserver\" and \"windows\" contain files the other     machines must be able to manipulate.</p> </li> <li> <p>All machines must be able to use the printer connected to     \"sambaserver\".</p> </li> <li> <p>\"sambaserver\" is running Linux and has Samba installed.</p> </li> <li> <p>\"windows\" is running Microsoft Windows.</p> </li> <li> <p>\"sambaclient\" is running Linux and has <code>smbclient</code> installed to be     able to function as a Samba client.</p> </li> <li> <p>We want to share only parts of the resources on \"sambaserver\" and     \"windows\".</p> <ul> <li> <p>Make share public available to everyone</p> </li> <li> <p>Make share share1 available to alice</p> </li> <li> <p>Make share share2 available to authenticated     users</p> </li> <li> <p>Make the home directories available to their respective     owners</p> </li> <li> <p>Map remote user alice.jones to user alice</p> </li> <li> <p>Make shares on windows available to users on     sambaclient</p> </li> <li> <p>Allow everyone to print on all printers on     sambaserver</p> </li> <li> <p>Disallow printing on Printer_1 from sambaclient</p> </li> <li> <p>List available services on sambaserver</p> </li> </ul> </li> </ul>"},{"location":"lpic2.209.1/#basic-global-section-to-support-the-examples","title":"Basic [global] section to support the examples","text":"<p>Basic global section needed to support the following examples:</p> <pre><code>    [global]\n      workgroup = OURGROUP\n      server string = Linux Samba Server %L for LPIC2 examples\n      encrypt passwords = yes\n      security = user\n      netbios name = sambaserver\n      netbios aliases = ss2\n      log file = /var/log/samba/log.%m\n      map to guest = bad user\n      hosts allow =\n      valid users =\n      guest ok = no\n</code></pre>"},{"location":"lpic2.209.1/#example-make-public-share-available-to-everyone","title":"Example: Make \"public\" share available to everyone","text":"<p>The configuration section inserted or modified to implement this example:</p> <pre><code>    [public]\n      comment = Public Storage on %L\n      path = /export/public\n      browsable = yes\n      writeable = yes\n      guest ok = yes\n      # valid users =\n</code></pre> <ul> <li> <p>The section <code>[public]</code> is added.</p> </li> <li> <p>The path that is made accessible by this service is     <code>/export/public</code>.</p> </li> <li> <p>The service is made browsable so a client can browse to the service     by connecting directly to the Samba server.</p> </li> <li> <p>The service is made writable.</p> </li> <li> <p>Guest access is enabled so no authentication is needed.</p> </li> <li> <p><code>valid users</code> is not set and the global value is used (defaults to     \"all authenticated users\"): all authenticated users have access.</p> </li> </ul> <p>All authenticated users have access and users that can not be authenticated will get access as \"guest\".</p> <p>Create a test file, connect with account \"jack\" that cannot be authenticated (effectively a \"guest\"), check the active share and copy the test file to the share.</p> <pre><code>    $ touch jack.txt\n    $ smbclient //SAMBASERVER/public -U jack -N\n    Domain=[OURGROUP] OS=[Unix] Server=[Samba 4.1.12]\n    smb: \\&gt; volume\n    Volume: |public| serial number 0x2b5c2e91\n    smb: \\&gt; put jack.txt\n    putting file jack.txt as \\jack.txt (0.0 kb/s) (average 0.0 kb/s)\n    smb: \\&gt; ls\n      .                                   D        0  Wed Oct 21 09:16:57 2015\n      ..                                  D        0  Wed Oct 21 07:44:56 2015\n      public.txt                          N        0  Wed Oct 21 07:45:07 2015\n      jack.txt                            A        0  Wed Oct 21 09:16:57 2015\n\n            54864 blocks of size 131072. 47234 blocks available\n    smb: \\&gt;\n</code></pre> <p>Output of smbstatus showing the session from user \"nobody\" which is our (default) configured Linux account for \"guest\" and checking the test file on the \"public\" share:</p> <pre><code>    $ smbstatus\n\n    Samba version 4.1.12\n    PID     Username      Group         Machine                        \n    -------------------------------------------------------------------\n    24265     nobody        nobody        10.20.27.158 (ipv4:10.20.27.158:49009)\n\n    Service      pid     machine       Connected at\n    -------------------------------------------------------\n    public       24265   10.20.27.158  Wed Oct 21 08:58:48 2015\n\n    No locked files\n    $ pwd\n    /export/public\n    $ ls -l\n    total 0\n    -rwxr--r--. 1 nobody nobody 0 Oct 21 09:16 jack.txt\n    -rw-r--r--. 1 root   root   0 Oct 21 07:45 public.txt\n</code></pre>"},{"location":"lpic2.209.1/#example-make-share1-share-available-to-alice","title":"Example: Make \"share1\" share available to alice","text":"<p>The configuration section inserted or modified to implement this example:</p> <pre><code>    [share1]\n      comment = Share1 on %L\n      path = /export/share1\n      # guest ok = no\n      browsable = yes\n      writeable = yes\n      valid users = alice\n</code></pre> <ul> <li> <p>The section <code>[share1]</code> is added.</p> </li> <li> <p>The path that is made accessible by this service is     <code>/export/share2</code>.</p> </li> <li> <p>The service is made browsable so a user can browse to the service by     directly connecting to the Samba server.</p> </li> <li> <p>The service is made writable.</p> </li> <li> <p><code>guest ok</code> is not set and the global value is used (default = \"no\"):     guest access is not allowed.</p> </li> <li> <p><code>valid users</code> is set to \"alice\" to allow access for the Linux user     \"alice\".</p> </li> </ul> <p>Failing attempt to access share1 as fred:</p> <pre><code>    $ smbclient //SAMBASERVER/share1\n    Enter fred's password: \n    Domain=[OURGROUP] OS=[Unix] Server=[Samba 4.1.12]\n    tree connect failed: NT_STATUS_ACCESS_DENIED\n</code></pre> <p>Successful attempt to access share1 as alice:</p> <pre><code>    $ smbclient //SAMBASERVER/share1\n    Enter alice's password: \n    Domain=[OURGROUP] OS=[Unix] Server=[Samba 4.1.12]\n    smb: \\&gt; volume\n    Volume: |share1| serial number 0xd62d5fc5\n    smb: \\&gt;\n</code></pre>"},{"location":"lpic2.209.1/#example-make-share2-share-available-to-authenticated-users","title":"Example: Make \"share2\" share available to authenticated users","text":"<p>The configuration section inserted or modified to implement this example:</p> <pre><code>    [share2]\n      comment = %S on %L\n      path = /export/share2\n      browsable = yes\n      writeable = no\n      # guest ok = no\n      # valid users =\n</code></pre> <ul> <li> <p>The section <code>[share2]</code> is added.</p> </li> <li> <p>The path that is made accessible by this service is     <code>/export/share2</code>.</p> </li> <li> <p>The service is made browsable so a user can browse to the service by     directly connecting to the Samba server.</p> </li> <li> <p>The service is NOT writable.</p> </li> <li> <p><code>guest ok</code> is not set and the global value is used (default = \"no\"):     guest access is not allowed.</p> </li> <li> <p><code>valid users</code> is not set and the global value is used (default =     \"empty\"): all authenticated users have access.</p> </li> </ul> <p>Because <code>guest ok</code> defaults to the global value of \"no\" and the empty <code>valid users</code> defaults to the global value of \"any authenticated user\" all (and only) authenticated users have access to \"share2\"</p> <p>Failing attempt to access share2 as guest:</p> <pre><code>    $ smbclient //SAMBASERVER/share1\n    Enter jack's password: \n    Domain=[OURGROUP] OS=[Unix] Server=[Samba 4.1.12]\n    tree connect failed: NT_STATUS_ACCESS_DENIED\n</code></pre> <p>Successful attempt to access share2 as an authenticated user:</p> <pre><code>    $ smbclient //SAMBASERVER/share2\n    Enter alice's password: \n    Domain=[OURGROUP] OS=[Unix] Server=[Samba 4.1.12]\n    smb: \\&gt; volume\n    Volume: |share2| serial number 0xb954cdf0\n    smb: \\&gt;\n</code></pre>"},{"location":"lpic2.209.1/#example-make-the-home-directories-available-to-their-respective-owners","title":"Example: Make the home directories available to their respective owners","text":"<p>The configuration section inserted or modified to implement this example:</p> <pre><code>    [homes]\n      comment = %U's homedirectory on %L from %m\n      # path =\n      browsable = no\n      writeable = yes\n      # guest ok = no\n      # valid users =\n</code></pre> <ul> <li> <p>The section <code>[public]</code> is added.</p> </li> <li> <p>The path that is made accessible by this service is     <code>/export/public</code>.</p> </li> <li> <p>The service is made browsable so a user can browse to the service by     directly connecting to the Samba server.</p> </li> <li> <p>The service is made writable.</p> </li> <li> <p>Guest access is enabled so no authentication is needed.</p> </li> <li> <p><code>valid users</code> is not set and the global value is used (default =     \"empty\"): all authenticated users have access to this special     service.</p> </li> </ul> <p>As \"fred\" access your home directory on \"sambaserver\":</p> <pre><code>    $ smbclient //SAMBASERVER/fred\n    Enter fred's password: \n    Domain=[OURGROUP] OS=[Unix] Server=[Samba 4.1.12]\n    smb: \\&gt; volume\n    Volume: |fred| serial number 0xce0909dd\n    smb: \\&gt;\n</code></pre> <p>Output of smbstatus showing the session from user \"fred\":</p> <pre><code>    $ smbstatus\n    Samba version 4.1.12\n    PID     Username      Group         Machine                        \n    -------------------------------------------------------------------\n    24457     fred          fred          10.20.27.158 (ipv4:10.20.27.158:49017)\n\n    Service      pid     machine       Connected at\n    -------------------------------------------------------\n    fred         24457   10.20.27.158  Wed Oct 21 09:36:34 2015\n\n    No locked files\n</code></pre>"},{"location":"lpic2.209.1/#smbexample5","title":"Example: Map remote user \"alice.jones\" to Linux user \"alice\"","text":"<p>Parameter added to the <code>global</code> section:</p> <pre><code>    [global]\n      ...\n      username map = /etc/samba/usermap.txt\n      ...\n</code></pre> <p>Sample contents of <code>/usr/local/samba/private/usermap.txt</code>:</p> <pre><code>    root = administraor admin\n    nobody = guest pcguest smbguest\n    alice = alice.jones\n    readonly = glen fred terry sarah\n    lachlan = \"Lachlan Smith\"\n    users = @sales\n</code></pre> <ul> <li>User mapping is a global setting. Login names (most probably Windows     account names) are mapped to local (Linux) users.</li> </ul> <p>If \"alice.jones\" tries to connect to the related home directory \"alice.jones\" will be mapped to \"alice\", the user will have access to all services enabled for \"alice\" and the home directory for \"alice\" will be served instead of \"alice.jones\".</p> <p>Connection from \"sambaclient\" to \"sambaserver\" as \"alice.jones\":</p> <pre><code>    $ smbclient //SAMBASERVER/alice.jones\n    Enter alice.jones's password: \n    Domain=[OURGROUP] OS=[Unix] Server=[Samba 4.1.12]\n    smb: \\&gt; volume\n    Volume: |alice| serial number 0x37da1047\n    smb: \\&gt;\n</code></pre> <p>Output of <code>smbstatus</code> on \"sambaserver\" showing active connections doesn't show \"alice.jones\" but only \"alice\":</p> <pre><code>    $ smbstatus\n\n    Samba version 4.1.12\n    PID     Username      Group         Machine                        \n    -------------------------------------------------------------------\n    23788     alice         alice         10.20.27.158 (ipv4:10.20.27.158:48988)\n\n    Service      pid     machine       Connected at\n    -------------------------------------------------------\n    alice        23788   10.20.27.158  Wed Oct 21 07:29:39 2015\n\n    No locked files\n</code></pre>"},{"location":"lpic2.209.1/#example-make-shares-on-windows-available-to-users-on-sambaclient","title":"Example: Make shares on \"windows\" available to users on \"sambaclient\"","text":"<p>Using <code>smbclient</code> to copy a file to <code>winshare1</code> on \"windows\":</p> <pre><code>    [fred@sambaclient ~]$ echo \"file from Fred\" &gt; fred.txt\n    [fred@sambaclient ~]$ smbclient //windows/winshare1\n    Enter fred's password: \n    Domain=[WINDOWS] OS=[Windows 7 Professional 7601 Service Pack 1] Server=[Windows 7 Professional 6.1]\n    smb: \\&gt; dir\n      .                                  DR        0  Tue Oct 27 07:21:20 2015\n      ..                                 DR        0  Tue Oct 27 07:21:20 2015\n      desktop.ini                       AHS       46  Tue Oct 27 07:16:15 2015\n      motd                                A        0  Tue Oct 27 07:21:20 2015\n      New Text Document.txt               A        0  Mon Oct 26 09:22:17 2015\n      passwd                              A     1055  Mon Oct 26 09:25:34 2015\n\n            40551 blocks of size 262144. 3397 blocks available\n    smb: \\&gt; put fred.txt\n    putting file fred.txt as \\fred.txt (14.6 kb/s) (average 14.6 kb/s)\n    smb: \\&gt; dir\n      .                                  DR        0  Tue Oct 27 07:23:58 2015\n      ..                                 DR        0  Tue Oct 27 07:23:58 2015\n      desktop.ini                       AHS       46  Tue Oct 27 07:16:15 2015\n      fred.txt                            A       15  Tue Oct 27 07:23:58 2015\n      motd                                A        0  Tue Oct 27 07:21:20 2015\n      New Text Document.txt               A        0  Mon Oct 26 09:22:17 2015\n      passwd                              A     1055  Mon Oct 26 09:25:34 2015\n\n            40551 blocks of size 262144. 3397 blocks available\n</code></pre> <p>Checking the result on \"windows\":</p> <p></p>"},{"location":"lpic2.209.1/#example-allow-everyone-to-print-on-all-printers-on-sambaserver","title":"Example: Allow everyone to print on all printers on \"sambaserver\"","text":"<p>The configuration section inserted or modified to implement this example:</p> <pre><code>    [printers]\n      comment = Printer %p on %L\n      path = /var/spool/samba\n      printable = yes\n      browseable = yes\n      guest ok = yes\n      # valid users = #\n</code></pre> <ul> <li> <p>The special section <code>[printers]</code> is added.</p> </li> <li> <p>Spool files are written to <code>/var/spool/samba</code>.</p> </li> <li> <p>The services matching this section (all printers) are made     printable.</p> </li> <li> <p>The service is made browsable so it can be looked up by connecting     to the server.</p> </li> <li> <p>Guest access is enabled so no authentication is needed.</p> </li> </ul> <p>Using Windows Explorer on Windows to browse and connnect to (enable) printer_1. </p> <p></p> <p>Right click enables connecting to the printer and adding it as a Generic text based printer. </p> <p></p> <p>Right click Printer_1 and print test page. Checking the spool file of the printer on \"sambaserver\":</p> <pre><code>                                   Windows\n                              Printer Test Page\n    Congratulations!\n    If you can read this information, you have correctly installed your \n    Generic / Text Only on WINDOWS.\n    The information below describes your printer driver and port settings.\n    Submitted Time: 11:45:31 AM .10/.26/.2015\n    Computer name:  WINDOWS\n    Printer name:   \\\\SAMBASERVER\\Printer_1\n    Printer model:  Generic / Text Only\n    Color support:  No\n    Port name(s):   \\\\SAMBASERVER\\Printer_1\n    Data format:    RAW\n    Driver name:    UNIDRV.DLL\n    Data file:      TTY.GPD\n    Config file:    UNIDRVUI.DLL\n    Help file:      UNIDRV.HLP\n    Driver version: 6.00\n    Environment:    Windows NT x86\n    Additional files used by this driver:\n     C:\\Windows\\system32\\spool\\DRIVERS\\W32X86\\3\\TTYRES.DLL \n    (6.1.7600.16385 (win7_rtm.090713-1255))\n     C:\\Windows\\system32\\spool\\DRIVERS\\W32X86\\3\\TTY.INI\n     C:\\Windows\\system32\\spool\\DRIVERS\\W32X86\\3\\TTY.DLL \n    (6.1.7600.16385 (win7_rtm.090713-1255))\n     C:\\Windows\\system32\\spool\\DRIVERS\\W32X86\\3\\TTYUI.DLL \n    (6.1.7600.16385 (win7_rtm.090713-1255))\n     C:\\Windows\\system32\\spool\\DRIVERS\\W32X86\\3\\TTYUI.HLP\n     C:\\Windows\\system32\\spool\\DRIVERS\\W32X86\\3\\UNIRES.DLL \n    (6.1.7600.16385 (win7_rtm.090713-1255))\n     C:\\Windows\\system32\\spool\\DRIVERS\\W32X86\\3\\STDNAMES.GPD\n     C:\\Windows\\system32\\spool\\DRIVERS\\W32X86\\3\\STDDTYPE.GDL\n     C:\\Windows\\system32\\spool\\DRIVERS\\W32X86\\3\\STDSCHEM.GDL\n     C:\\Windows\\system32\\spool\\DRIVERS\\W32X86\\3\\STDSCHMX.GDL\n    This is the end of the printer test page.\n</code></pre>"},{"location":"lpic2.209.1/#example-disallow-printing-on-printer_1-from-sambaclient","title":"Example: Disallow printing on \"Printer_1\" from \"sambaclient\"","text":"<p>The configuration section inserted or modified to implement this example:</p> <pre><code>    [Printer_1]\n      comment = Printer 1 on %L\n      path = /var/spool/samba\n      printer name = Printer_1\n      printable = yes\n      browseable = yes\n      guest ok = yes\n      hosts deny = sambaclient\n</code></pre> <ul> <li> <p>A section is created to explicitely match \"Printer_1\"</p> </li> <li> <p>Making the service printable identifies the service as a printer</p> </li> <li> <p>Spool files are written to <code>/var/spool/samba</code></p> </li> <li> <p>Print jobs are sent to the local printer queue \"Printer_1\"</p> </li> <li> <p>The service is not made browseable, so cannot be looked up by     connecting to the server</p> </li> <li> <p>Guest access is enabled so no authentication is needed.</p> </li> <li> <p>Access is explicitely denied for \"sambaclient\".</p> </li> </ul> <p>Samba will first match the requested service against sections explicitely matching the service name before trying a match on the special section <code>[printers]</code>. Any service other than \"Printer_1\" will not match any explicite sections and will fall through to the special section <code>[printers]</code>. A request for service \"Printer_1\" will first match the <code>[Printer_1]</code> section and will therefor never match the special section <code>[printers]</code>.</p> <p>Please note that in Samba it is not possible to configure something like \"sambaclient has access to all printer except for Printer_1\". In this case we need to configure all printers to accessible for all and add a configuration for any exception.</p> <p>Using <code>smbclient</code> to test printing from sambaclient</p> <pre><code>    $ smbclient //sambaserver/Printer_1/ -c \"print /etc/hosts\" \n    Enter alice's password: \n    Domain=[OURGROUP] OS=[Unix] Server=[Samba 4.1.12]\n    tree connect failed: NT_STATUS_ACCESS_DENIED\n</code></pre>"},{"location":"lpic2.209.1/#example-list-available-services-on-sambaserver","title":"Example: List available services on \"sambaserver\"","text":"<p>This example doesn't need additional configuration.</p> <p>Using <code>smbclient</code> to create a listing of \"sambaserver\". Note the comments.</p> <pre><code>    $ smbclient -L //SAMBASERVER\n    Enter fred's password: \n    Domain=[OURGROUP] OS=[Unix] Server=[Samba 4.1.12]\n\n        Sharename       Type      Comment\n        ---------       ----      -------\n        public          Disk      Public Storage on sambaserver\n        share1          Disk      Share1 on sambaserver\n        share2          Disk      share2 on sambaserver\n        Printer_1       Printer   Printer 1 on sambaserver\n        IPC$            IPC       IPC Service (Linux Samba Server sambaserver for LPIC2 examples)\n        fred            Disk      fred's homedirectory on sambaserver from sambaclient\n        Printer_2       Printer   Cups printer Printer_2\n    Domain=[OURGROUP] OS=[Unix] Server=[Samba 4.1.12]\n\n        Server               Comment\n        ---------            -------\n        SAMBACLIENT          Samba 4.1.12\n        SAMBASERVER          Linux Samba Server sambaserver for LPIC2 examples\n        SS2                  Linux Samba Server sambaserver for LPIC2 examples\n\n        Workgroup            Master\n        ---------            -------\n        OURGROUP             SAMBASERVER\n</code></pre>"},{"location":"lpic2.209.1/#setting-up-a-nmbd-wins-server","title":"Setting up a <code>nmbd</code> WINS server","text":""},{"location":"lpic2.209.1/#what-is-a-wins-server","title":"What is a WINS Server?","text":"<p>WINS stands for Windows Internet Name Service. This is a name service WINS used to translate NetBIOS names to ip addresses by using NetBIOS over TCP/IP queries. This is done using UDP packets.</p>"},{"location":"lpic2.209.1/#using-samba-as-a-wins-server","title":"Using Samba as a WINS Server","text":"<p>To tell Samba that it should also play the role of WINS Server, add sambaWINS the following line to the <code>[global]</code> section of the Samba configuration file <code>/etc/samba/smb.conf</code>:</p> <pre><code>    [global]\n    wins support = yes\n</code></pre> <p>Be careful, there should not be more than one WINS Server on a network and you should not set any of the other WINS parameters, such as \"wins server\", when enabling \"wins support\".</p> <p>Restart the smb and nmb services to pick up the changed configuration</p> <pre><code>    # service smb restart\n    # service nmb restart\n</code></pre>"},{"location":"lpic2.209.1/#creating-logon-scripts-for-clients","title":"Creating logon scripts for clients","text":"<p>Logon scripts can be very handy. For example, if every user needs sambalogon scripts his home directory mapped to drive H: automatically, a logon script can take care of that. The user is then presented with an extra hard-drive which gives you, as an administrator, the freedom to move home directories to another server should the need arise. To the user it remains drive H:, and all you have to do is change one line in the logon script.</p> <p>The same goes for printers and processes that should be accessible or run when a specific user logs on or when a certain machine logs on.</p> <p>The batch file must be a Windows-style batch file and should thus have both a carriage return and a line feed at the end of each line.</p> <p>The first thing to do is enable logon support. This is done by adding the following line to the <code>[global]</code> section of the Samba configuration file <code>/etc/samba/smb.conf</code>:</p> <pre><code>    [global]\n    logon server = yes\n</code></pre> <p>The second thing to do is create a share called <code>[netlogon]</code> where the logon scripts will reside and which is readable to all users:</p> <pre><code>    [netlogon]\n      Comment = Netlogon for Windows clients\n      path = /home/netlogon\n      browseable = no\n      guest ok = no\n      writeable = no\n</code></pre> <p>The definition of the logon script depends on whether you want a script per user or per client.</p>"},{"location":"lpic2.209.1/#based-on-the-users-name","title":"Based on the user's name","text":"<p>Add the following line to the <code>[netlogon]</code> section:</p> <pre><code>    logon script = %U.bat\n</code></pre> <p>and, assuming the user is \"fred\", create a file called <code>/home/netlogon/fred.bat</code>.</p>"},{"location":"lpic2.209.1/#based-on-the-clients-name","title":"Based on the client's name","text":"<p>Add the following line to the <code>[netlogon]</code> section:</p> <pre><code>    logon script = %m.bat\n</code></pre> <p>and, assuming the machine is called \"workstation1\", create a file called <code>/home/netlogon/workstation1.bat</code>.</p> <p>Configuring Samba as a domain member</p> <p>To configure Samba4 as a domain member you need to make sure there is no configuration present on the system before starting.</p> <p>There are two options for joining a domain. The server can be a member of and Active Directory domain or an older NT4 domain. Because an Active Directory domain uses Kerberos and DNS it is importatnt to configure the server correctly before joining the domain.</p>"},{"location":"lpic2.209.1/#configuring-dns","title":"Configuring DNS","text":"<p>For the server to locate the domain it is important that the DNS settings are configured correctly. An AD DC has a built-in DNS server which should be used by the system we want to connect. When manually configuring the ip settings you should configure the AD Domain Controller as the DNS server. How you do this depends on the distribution you use.</p> <p>When configured correctly your<code>/etc/resolv.conf</code> file should look as follows when the AD Domain Controller has an ipaddres of 192.168.1.2 and the domain is example.com:</p> <pre><code>    nameserver 192.168.1.2\n    search example.com\n</code></pre> <p>When you join the host to the domain Samba tries to register the host in the AD DNS zone. For this the <code>net</code> utility tries to resolve the hostname using DNS or a correct entry in /etc/hosts.</p> <p>When using <code>/etc/hosts</code> it is important that the hostname or FQDN doesn't resolve to 127.0.0.1. Because of this, a correctly configured hostfile will look as follows where server2.example.com is the hostname of the server we are adding as a domain member:</p> <pre><code>    127.0.0.1   localhost localhost.localdomain\n    192.168.1.3 server2.example.com server2\n</code></pre> <p>To check if the resolution is correct you can use the <code>getent</code> command as follows:</p> <pre><code>    $ getent hosts server2\n    192.168.1.3 server2.example.com server2\n</code></pre>"},{"location":"lpic2.209.1/#configuring-kerberos","title":"Configuring Kerberos","text":"<p>Currently Samba uses Heimdal Kerberos. This means that the Kerberos file <code>/etc/krb5.conf</code> only needs to contain the following information:</p> <pre><code>    [libdefaults]\n        default_realm = EXAMPLE.COM\n        dns_lookup_realm = false\n        dns_lookup_kdc = true\n</code></pre> <p>Using anyting other than the above can lead to errors.</p> <p>You will need to replace EXAMPLE.COM with you Kerberos realm.</p> <p>Kerberos requires a synchronised time on all domain members. It is recommended to set up a NTP client.</p>"},{"location":"lpic2.209.1/#configuring-samba","title":"Configuring Samba","text":"<p>The previous steps are only necessary when joining an Active Directory domain. The following steps are needed for both an Active Directory domain and a NT4 domain.</p>"},{"location":"lpic2.209.1/#setting-up-the-smbconf-file","title":"Setting up the smb.conf file","text":"<p>The next step is to configure the domain members <code>smb.conf</code> file. This file is usually located at <code>/etc/smb/smb.conf</code> or <code>/etc/samba/smb.conf</code>. If not you can use the following command to locate the file:</p> <pre><code>    $ smbd -b | grep CONFIGFILE\n    CONFIGFILE: /usr/local/samba/etc/smb.conf\n</code></pre> <p>Now that we know where the file is located we can add the following configuration:</p> <pre><code>    [global]\n        security = ADS\n        workgroup = EXAMPLE\n        realm = EXAMPLE.COM\n\n        log file = /var/log/samba/%m.log\n        log level = 1\n\n        # Default ID mapping configuration for local BUILTIN accounts\n        # and groups on a domain member. The default (*) domain:\n        # - must not overlap with any domain ID mapping configuration!\n        # - must use a read-write-enabled back end, such as tdb.\n        idmap config * : backend = tdb\n        idmap config * : range = 3000-7999\n</code></pre>"},{"location":"lpic2.209.1/#joining-the-domain","title":"Joining the domain","text":"<p>Now that we have configured samba it's time to join the domain. As also stated above it's not supported to use the <code>samba-tool</code> utility to do this.</p> <p>To join a domain you can use the following command. The output will depend on the type of domain you're joining.</p> <p>When joining an Active Directory domain:</p> <pre><code>    $ net ads join \u2013U administrator\n    Enter administrator\u2019s password:\n    Using short domain name \u2013 EXAMPLE\n    Joined \u2018server2\u2019 to dns domain \u2018example.com\u2019\n</code></pre> <p>When joining a NT4 domain:</p> <pre><code>    $ net ads join \u2013U administrator\n    Enter administrator\u2019s password:\n    Joined domain EXAMPLE.\n</code></pre>"},{"location":"lpic2.209.1/#configuring-the-name-service-switch-nss","title":"Configuring the Name Service Switch (NSS)","text":"<p>To make the domain users and groups available to the local system we have to append the winbind entry to the following databases in <code>/etc/nsswitch.conf</code>:</p> <pre><code>    passwd: files winbind\n    group: files winbind\n</code></pre>"},{"location":"lpic2.209.1/#starting-the-services","title":"Starting the services","text":"<p>Now we can start the services. If you only need Samba to lookup domain users and groups you only have to start the <code>winbind</code> service. If you also set up file and printer sharing you also need to start the <code>smbd</code> and <code>nmbd</code> services.</p> <pre><code>    $ systemctl start winbind smbd nmbd\n</code></pre> <p>You should NOT start the <code>samba</code> service. This service is only required on Active Directory Domain Controllers,</p>"},{"location":"lpic2.209.1/#testing-the-winbind-connectivity","title":"Testing the winbind connectivity","text":"<p>To verify if the winbind service is able to connect to Active Directory Domain Controllers or NT4 Domain Controllers you can use the <code>wbinfo</code> command:</p> <pre><code>    $ wbinfo --ping-dc\n    Checking the NETLOGON for domain[EXAMPLE] dc connection to \"server1.example.com\" succeeded\n</code></pre>"},{"location":"lpic2.209.2/","title":"Configuring an NFS Server (209.2)","text":""},{"location":"lpic2.209.2/#configuring-an-nfs-server-2092","title":"Configuring an NFS Server (209.2)","text":"<p>Candidates should be able to export filesystems using NFS. This objective includes access restrictions, mounting an NFS filesystem on a client and securing NFS.</p>"},{"location":"lpic2.209.2/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>NFS version 3 configuration files</p> </li> <li> <p>NFS tools and utilities</p> </li> <li> <p>Access restrictions to certain hosts and/or subnets</p> </li> <li> <p>Mount options on server and client</p> </li> <li> <p>TCP Wrappers</p> </li> </ul> <p>Awareness of NFSv4</p>"},{"location":"lpic2.209.2/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/etc/exports</code></p> </li> <li> <p><code>exportfs</code></p> </li> <li> <p><code>showmount</code></p> </li> <li> <p><code>nfsstat</code></p> </li> <li> <p><code>/proc/mounts</code></p> </li> <li> <p><code>/etc/fstab</code></p> </li> <li> <p><code>rpcinfo</code></p> </li> <li> <p><code>mountd</code></p> </li> <li> <p><code>portmapper</code></p> </li> </ul>"},{"location":"lpic2.209.2/#nfs-the-network-file-system","title":"NFS - The Network File System","text":"<p>The abbreviation NFS expands to Network File System. With NFS you can make a remote disk (or only some of Configuring SMB Server NFS it) part of your local filesystem.</p> <p>The NFS protocol is being adjusted, a process which has, so far, taken several years. This has consequences for those using NFS. Modern NFS daemons will currently run in kernel space (part of the running kernel) and support version 3 of the NFS protocol (version 2 will still be supported for compatibility with older clients). Older NFS daemons running in user space (which is almost independent of the kernel) and accepting only protocol version 2 NFS requests, will still be around. This section will primarily describe kernel-space NFS-servers supporting protocol version 3 and compatible clients. Differences from older versions will be pointed out when appropriate.</p> <p>Note Details about this NFS work-in-progress are in [NFS protocol versions] below.</p>"},{"location":"lpic2.209.2/#client-server-or-both","title":"Client, Server or both?","text":"<p>The system that makes filesystem(s) available to other systems is called a server. The system that connects to a server is called a client. Each system can be configured as server, client or both.</p>"},{"location":"lpic2.209.2/#setting-up-nfs","title":"Setting up NFS","text":"<p>This section describes NFS-related software and its configuration.</p>"},{"location":"lpic2.209.2/#requirements-for-nfs","title":"Requirements for NFS","text":"<p>To run NFS, the following is needed:</p> <ul> <li> <p>support for NFS (several options) must be built into the      kernel</p> </li> <li> <p>a portmapper must be running </p> </li> <li> <p>on systems with NFS-server support, an NFS daemon and a mount     daemon must be active</p> </li> <li> <p>support daemons may be needed</p> </li> </ul> <p>Each point is discussed in detail below.</p>"},{"location":"lpic2.209.2/#configuring-the-kernel-for-nfs","title":"Configuring the kernel for NFS","text":"<p>When configuring a kernel for NFS, it must be decided whether or not the system will be a client or a server. A system with a kernel that contains NFS-server support can also be used as an NFS client.</p> <p>Note The situation described here is valid for the 2.4.x kernel series. Specifications described here may change in the future.</p> <p>FIXME new kernel versions</p>"},{"location":"lpic2.209.2/#nfs-related-kernel-options","title":"NFS-related kernel options","text":"<p>See Kernel options for NFS.</p>"},{"location":"lpic2.209.2/#nfs-file-system-support-config_nfs_fs","title":"NFS file system support (CONFIG_NFS_FS):","text":"<ul> <li>If you want to use NFS as a client, select this. LinuxNFS Client If     this is the only NFS option selected, the system will support NFS     protocol version 2 only. To use protocol version 3 you will also     need to select CONFIG_NFS_V3. When CONFIG_NFS_FS is selected,     support for an old-fashioned user-space NFS-server (protocol     version 2) is also present. You can do without this option when the     system is a kernel-space NFS-server server only (i.e., neither     client nor user-space NFS-server).</li> </ul>"},{"location":"lpic2.209.2/#provide-nfsv3-client-support-config_nfs_v3","title":"Provide NFSv3 client support (CONFIG_NFS_V3):","text":"<ul> <li>Select this if the client system should be able to make NFS LinuxNFS     Client v3 connections to an NFS version 3 server. This can only be     selected if NFS support (CONFIG_NFS_FS) is also selected.</li> </ul>"},{"location":"lpic2.209.2/#nfs-server-support-config_nfsd-kernel-space-only","title":"NFS server support (CONFIG_NFSD): Kernel space only.","text":"<ul> <li>When you select this, you get a LinuxNFS Server kernel-space     NFS-server supporting NFS protocol version 2. Additional software is     needed to control the kernel-space NFS-server (as will be shown     later). To run an old-fashioned user-space NFS-server this option is     not needed. Select CONFIG_NFS instead.</li> </ul>"},{"location":"lpic2.209.2/#provide-nfsv3-server-support-config_nfsd_v3","title":"Provide NFSv3 server support (CONFIG_NFSD_V3):","text":"<ul> <li>This option adds support for version 3 of the NFS LinuxNFS Server v3     protocol to the kernel-space NFS-server. The kernel-space NFS-server     will support both version 2 and 3 of the NFS protocol. You can only     select this if you also select NFS server support (CONFIG_NFSD).</li> </ul> <p>When configuring during a compiler build (i.e., make menuconfig, make xconfig, etc), the options listed above can be found in the File Systems section, subsection Network File Systems.</p> <p>Kernel options for NFS provides an overview of NFS support in the kernel.</p> Description option(s) allows / provides NFS file system support CONFIG_NFS_FS allows both NFS (v2) client and user space NFS (v2) server NFSv3 client support CONFIG_NFS_FS and CONFIG_NFS_V3 allows NFS (v2 + v3) client NFS server support CONFIG_NFSD provides NFS (v2) kernel server NFSv3 server support CONFIG_NFSD and CONFIG_NFSD_V3 provides NFS (v2 + v3) kernel server <p>Selecting at least one of the NFS kernel options turns on Sun RPC (Remote Procedure Call) support automatically. RPC This results in a kernel space RPC input/output daemon. It can be recognised as <code>[rpciod]</code>in the process listing.</p>"},{"location":"lpic2.209.2/#the-portmapper","title":"The portmapper","text":"<p>The portmapper is used to interface TCP/IP connections to the appropriate RPC calls. It is needed for all NFS traffic because not only does it map (incoming) TCP connections to NFS (RPC) calls, it also can be used to map different NFS versions to different ports on which NFS is running. Most distributions will install the portmapper if NFS software (other than the kernel) is being installed.</p> <p>The portmapper itself need not be configured. Portmapper security, however, is an issue: you are strongly advised to limit access to the portmapper. This can be NFSportmapper security done using the tcp wrapper.</p>"},{"location":"lpic2.209.2/#securing-the-portmapper","title":"Securing the portmapper","text":"<p>First, make sure the portmapper has support for the tcp wrapper built-in (since it isn't started through inetd, portmapper needs its own built-in tcpwrapper support). You can test this by running <code>ldd /sbin/portmap</code>. The result could be something like</p> <pre><code>    libwrap.so.0 =&gt; /lib/libwrap.so.0 (0x40018000)\n    libnsl.so.1 =&gt; /lib/libnsl.so.1 (0x40020000)\n    libc.so.6 =&gt; /lib/libc.so.6 (0x40036000)\n    /lib/ld-linux.so.2 =&gt; /lib/ld-linux.so.2 (0x40000000)\n</code></pre> <p>The line with <code>libwrap.so.0</code> (libwrap belongs to the tcp wrapper) shows that this portmapper is tcp wrapper compiled with tcp-wrapper support. If that line is missing, get a better portmapper or compile one yourself.</p> <p>A common security strategy is blocking incoming portmapper requests by default, but allowing specific hosts to connect. This strategy will be described here.</p> <p>Start by editing the file <code>/etc/hosts.deny</code> and adding the following line:</p> <pre><code>    portmap: ALL\n</code></pre> <p>This denies every system access to the portmapper. It can be extended with a command:</p> <pre><code>    portmap: ALL: (echo illegal rpc request from %h | mail root) &amp;\n</code></pre> <p>Now all portmapper requests are denied. In the second example, requests are denied and reported to root.</p> <p>The next step is allowing only those systems access that are allowed to do so. This is done by putting a line in <code>/etc/hosts.allow</code>:</p> <pre><code>    portmap: 121.122.123.\n</code></pre> <p>This allows each host with an IP address starting with the numbers shown to connect to the portmapper and, therefore, use NFS. Another possibility is specifying part of a hostname:</p> <pre><code>    portmap: .example.com\n</code></pre> <p>This allows all hosts inside the example.com domain to connect. To allow all hosts of a NIS workgroup:</p> <pre><code>    portmap: @workstations\n</code></pre> <p>To allow hosts with IP addresses in a subnet:</p> <pre><code>    portmap: 192.168.24.16/255.255.255.248\n</code></pre> <p>This allows all hosts from 192.168.24.16 to 192.168.24.23 to connect (examples from ???).</p>"},{"location":"lpic2.209.2/#portmap-and-rpcbind","title":"portmap and rpcbind","text":"<p>Some linux distributions use portmap. Other linux distributions use rpcbind.</p> <p>The portmap daemon is replaced by rpcbind. Rpcbind has more features, like ipv6 support and nfs4 support.</p>"},{"location":"lpic2.209.2/#nfs","title":"General NFS daemons","text":""},{"location":"lpic2.209.2/#the-nfs-utils-package","title":"The <code>nfs-utils</code> package","text":"<p>NFS is implemented as a set of daemons. These NFSrpc.nfsd NFSrpc.mountd NFSrpc.lockd NFSrpc.statd can be recognized by their name: they all start with the rpc. prefix followed by the name of the daemon. Among these are: <code>rpc.nfsd</code> (only a support program in systems with a kernel NFS server), <code>rpc.mountd</code>, <code>rpc.lockd</code> and <code>rpc.statd</code>.</p> <p>The source for these daemons can be found in the <code>nfs-utils</code> package (see NFS for more information on nfs-utils). It will also contain the source of other support programs, such as <code>exportfs</code>, <code>showmount</code> and <code>nfsstat</code>. These will be discussed later in Exporting NFS and Testing NFS.</p> <p>Distributions may provide <code>nfs-utils</code> as a ready-to-use package, sometimes under different names. Debian, for example, provides lock and status daemons in a special <code>nfs-common</code> package, and the NFS and mount daemons in <code>nfs-*server</code> packages (which come in user-space and kernel-space versions).</p> <p>Each of the daemons mentioned here can also be secured using the tcp wrapper. Details in Securing NFS.</p>"},{"location":"lpic2.209.2/#nfs-server-software","title":"NFS server software","text":""},{"location":"lpic2.209.2/#the-nfs-daemon","title":"The NFS daemon","text":"<p>When implementing an NFS server, you can install support for an kernel-space or an user-space NFS server, depending on the kernel NFSkernel space NFSuser space configuration. The <code>rpc.nfsd</code> command (sometimes called <code>nfsd</code>) is the complete NFS server in user space. In kernel space, however, it is just a support program that can start the NFS server in the kernel.</p> <p>The kernel-space NFS server</p> <ul> <li> <p>The kernel-space NFS server is part of the running kernel. A kernel     NFS server appears as <code>[nfsd]</code> in the process list.</p> <p>The version of <code>rpc.nfsd</code> that supports the NFS server inside the kernel is just a support program to control NFS kernel server(s).</p> </li> </ul> <p>The user-space NFS daemon</p> <ul> <li>The <code>rpc.nfsd</code> program can also contain an old-fashioned user-space     NFS server (version 2 only). A user-space NFS server is a complete     NFS server. It can be recognized as <code>rpc.nfsd</code> in the process list.</li> </ul>"},{"location":"lpic2.209.2/#the-mount-daemon","title":"The mount daemon","text":"<p>The <code>mountd</code> (or <code>rpc.mountd</code>) mount-daemon handles incoming NFS (mount) requests. It is required on a system that provides NFS server support.</p> <p>The configuration of the mount daemon includes exporting (making available) a filesystem to certain hosts and specifying how they can use this filesystem.</p> <p>Exporting filesystems, using the <code>/etc/exports</code> /etc/exports file and the <code>exportfs</code> command exportfs will be discussed in [Exporting NFS].</p>"},{"location":"lpic2.209.2/#the-lock-daemon","title":"The lock daemon","text":"<p>A lock daemon for NFS is implemented in <code>rpc.lockd</code>.</p> <p>You won't need lock-daemon support when using modern (2.4.x) kernels. FIXME modern kernels These kernels provide one internally, which can be recognized as <code>[lockd]</code> in Linuxlockd the process list. Since the internal kernel lock-daemon takes precedence, starting <code>rpc.lockd</code> accidentally will do no harm.</p> <p>There is no configuration for <code>rpc.lockd</code>.</p>"},{"location":"lpic2.209.2/#the-status-daemon","title":"The status daemon","text":"<p>According to the manual page, the status daemon <code>rpc.statd</code> implements only a reboot notification service. It is a user-space daemon - even on systems with kernel-space NFS version 3 support. It can be recognized as <code>rpc.statd</code> in the process listing. It is used on systems with NFS client and NFS server support.</p> <p>There is no configuration for <code>rpc.statd</code>.</p>"},{"location":"lpic2.209.2/#exportingNFS","title":"Exporting filesystems","text":"<p>Exporting a filesystem, or part of it, makes it available for use by another system. A filesystem can be exported to a single host, a group of hosts or to everyone.</p> <p>Export definitions are configured in the file <code>/etc/exports</code> and will be activated by the /etc/exports <code>exportfs</code> command. The current export list can be queried with the command <code>showmount --exports</code>. showmount</p> <p>Note In examples below the system called <code>nfsshop</code> will be the NFS server and the system called <code>clientN</code> one of the clients.</p>"},{"location":"lpic2.209.2/#the-file-etcexports","title":"The file <code>/etc/exports</code>","text":"<p>The file <code>/etc/exports</code> contains the definition(s) of filesystem(s) to be exported, the name of the host that is allowed to access it and how the host can access it.</p> <p>Each line in <code>/etc/exports</code> has the following format:</p> <pre><code>        /dir hostname(options) ...\n</code></pre> <ul> <li> <p>Name of the directory to be exported</p> </li> <li> <p>The name of the system (host) that is allowed to access /dir (the     exported directory). If the name of the system is omitted all     hosts can connect. There are five possibilities to specify a system     name:</p> <p>single hostname</p> <ul> <li>The name of a host that is allowed to connect. Can be a name     (<code>clientN</code>) or an IP address.</li> </ul> <p>wildcard</p> <ul> <li>A group of systems is allowed. All systems in the <code>example.com</code>     domain will be allowed by the <code>*.example.com</code> wildcard.</li> </ul> <p>IP networks</p> <ul> <li>Ranges of ip numbers or address/subnetmask combinations.</li> </ul> <p>nothing</p> <ul> <li>Leaving the system part empty is mostly done by accident (see     the Caution below). It allows all hosts to connect. To prevent     this error, make sure that there is no spacing between the     system name and the opening brace that starts the options.</li> </ul> <p>@NISgroup</p> <ul> <li>NIS workgroups can be specified as a name starting with an <code>@</code>.</li> </ul> </li> <li> <p>Options between braces. Will be discussed further on.</p> </li> <li> <p>More than one system with options can be listed:</p> <pre><code>    /home/ftp/pub clientN(rw) *.example.com(ro)\n</code></pre> <p>Explanation: system <code>clientN</code> is allowed to read and write in <code>/home/ftp/pub</code>. Systems in <code>example.com</code> are allowed to connect, but only to read.</p> </li> </ul> <p>Make sure there is no space (not even white) between the hostname and the specification between braces. There is a lot of difference between</p> <pre><code>    /home/ftp/pub clientN(rw)\n</code></pre> <p>and</p> <pre><code>    /home/ftp/pub clientN (rw)\n</code></pre> <p>The first allows <code>clientN</code> read and write access. The second allows <code>clientN</code> access with default options (see <code>man 5 exports</code>) and all systems read and write access!</p>"},{"location":"lpic2.209.2/#export-options","title":"Export options","text":"<p>Several export options can be used in <code>/etc/exports</code>. Only the most important will be discussed here. See the exports(5) manual page for a full list. Two types of options will be listed here: general options and user/group id options.</p> <p><code>ro</code> (default)</p> <ul> <li>The client(s) has only read access. NFSro</li> </ul> <p><code>rw</code></p> <ul> <li>The client(s) has read and write access. Of course, the NFSrw client     may choose to mount read-only anyway.</li> </ul> <p>Also relevant is the way NFS handles user and group permissions across systems. NFS software considers users with the same UID and the same username as the same users. The same is true for GIDs.</p> <p>The user <code>root</code> is different. Because <code>root</code> can read (and write) everything, root permission over NFS is considered dangerous.</p> <p>A solution to this is called squashing: NFSsquashing all requests are done as user <code>nobody</code> (actually UID <code>65534</code>, often called <code>-2</code>) and group <code>nobody</code> (GID <code>65534</code>).</p> <p>At least four options are related to squashing: <code>root_squash</code>, NFSroot_squash <code>no_root_squash</code>, NFSno_root_squash <code>all_squash</code> and NFSall_squash <code>no_all_squash</code>. NFSno_all_squash Each will be discussed in detail.</p> <p><code>root_squash</code> (default)</p> <ul> <li>All requests by user <code>root</code> on <code>clientN</code> (the client) will be done     as user <code>nobody</code> on <code>nfsshop</code> (the server). This implies, for     instance, that user <code>root</code> on the client can only read files on the     server that are world readable.</li> </ul> <p><code>no_root_squash</code></p> <ul> <li> <p>All requests as <code>root</code> on the client will be done as <code>root</code> on the     server.</p> <p>This is necessary when, for instance, backups are to be made over NFS.</p> <p>This implies that root on <code>nfsshop</code> completely trusts user root on <code>clientN</code>.</p> </li> </ul> <p><code>all_squash</code></p> <ul> <li> <p>Requests of any user other than root on <code>clientN</code> are performed as     user <code>nobody</code> on <code>nfsshop</code>.</p> <p>Use this if you cannot map usernames and UID's easily.</p> </li> </ul> <p><code>no_all_squash</code> (default)</p> <ul> <li>All requests of a non-root user on <code>clientN</code> are attempted as the     same user on <code>nfsshop</code>.</li> </ul> <p>Example entry in <code>/etc/exports</code> on system <code>nfsshop</code> (the server system):</p> <pre><code>    /    client5(ro,no_root_squash) *.example.com(ro)\n</code></pre> <p>System <code>nfsshop</code> allows system <code>client5</code> read-only access to everything and reads by user root are done as root on <code>nfsshop</code>. Systems from the <code>example.com</code> domain are allowed read-only access, but requests from root are done as user <code>nobody</code>, because <code>root_squash</code> is true by default.</p> <p>Here is an example file:</p> <pre><code>    # /etc/exports on nfsshop\n    # the access control list for filesystems which may be exported\n    # to NFS clients.  See exports(5).\n\n    / client2.exworks(ro,root_squash)\n    / client3.exworks(ro,root_squash)\n    / client4.exworks(ro,root_squash)\n    /home client9.exworks(ro,root_squash)\n</code></pre> <p>Explanation: <code>client2</code>, <code>client3</code> and <code>client4</code> are allowed to mount the complete filesystem (<code>/</code>: root). But they have read-only access and requests are done as user <code>nobody</code>. The host <code>client9</code> is only allowed to mount the <code>/home</code> directory with the same rights as the other three hosts.</p>"},{"location":"lpic2.209.2/#the-exportfs-command","title":"The <code>exportfs</code> command","text":"<p>Once <code>/etc/exports</code> is configured, the export exportfs list in it can be activated using the <code>exportfs</code> command. It can also be used to reload the list after a change or deactivate the export list. Exportfs and fstab shows some of the functionality of <code>exportfs</code>.</p> <p>Command          Description</p> <p><code>exportfs -r</code>    reexport all directories   <code>exportfs -a</code>    export or unexport all directories   <code>exportfs -ua</code>   de-activate the export list (unexport all)</p> <p>: Overview of <code>exportfs</code></p> <p>Note Older (user-space) NFS systems may not have the <code>exportfs</code> command. On these systems the export list will be installed automatically by the mount daemon when it is started. Reloading after a change is done by sending a <code>SIGHUP</code> signal to the running mount-daemon NFSSIGHUP process.</p>"},{"location":"lpic2.209.2/#activating-an-export-list","title":"Activating an export list","text":"<p>The export list is activated (or reactivated) with the following command:</p> <pre><code>    exportfs -r\n</code></pre> <p>The <code>r</code> originates from the word NFS-r re-exporting.</p> <p>Before the <code>exportfs -r</code> is issued, no filesystems are exported and no other system can connect.</p> <p>When the export list is activated, the kernel export table will be filled. The following command will show the kernel export table:</p> <pre><code>    cat /proc/fs/nfs/exports\n</code></pre> <p>The output will look something like:</p> <pre><code>    # Version 1.1\n    # Path Client(Flags) # IPs\n    /   client4.exworks(ro,root_squash,async,wdelay) # 192.168.72.4\n    /home   client9.exworks(ro,root_squash,async,wdelay) # 192.168.72.9\n    /   client2.exworks(ro,root_squash,async,wdelay) # 192.168.72.2\n    /   client3.exworks(ro,root_squash,async,wdelay) # 192.168.72.3\n</code></pre> <p>Explanation: all named hosts are allowed to mount the root directory (<code>client9</code>: <code>/home</code>) of this machine with the listed options. The IP addresses are listed for convenience.</p> <p>Also use <code>exportfs -r</code> after you have made changes to <code>/etc/exports</code> on a running system.</p> <p>When running <code>exportfs -r</code>, some things will be done in the directory <code>/var/lib/nfs</code>. Files there are easy to corrupt by human intervention with far-reaching consequences.</p>"},{"location":"lpic2.209.2/#deactivating-an-export-list","title":"Deactivating an export list","text":"<p>All active export entries are unexported with the command:</p> <pre><code>    exportfs -ua\n</code></pre> <p>The letters <code>ua</code> are an abbreviation for NFS-ua unexport all.</p> <p>After the <code>exportfs -ua</code> no exports are active anymore.</p>"},{"location":"lpic2.209.2/#showmount","title":"The <code>showmount</code> command","text":"<p>The <code>showmount</code> command shows information about the exported file systems.</p> Command Description <code>showmount --exports</code> show active export list showmount` show names of clients with active mounts <code>showmount --directories</code> show directories that are mounted by remote clients <code>showmount --all</code> show both client-names and directories <p><code>showmount</code> accepts a host name as its last argument. If present, <code>showmount</code> will query the NFS-server on that host. If omitted, the current host will be queried (as in the examples below, where the current host is called <code>nfsshop</code>).</p> <p>With the <code>--exports</code> option.</p> <p>showmount lists the currently active export list:</p> <pre><code>    # showmount --exports\n    Export list for nfsshop:\n    / client2.exworks,client3.exworks,client4.exworks\n    /home client9.exworks\n</code></pre> <p>The information is more sparse compared to the output of <code>cat /proc/fs/nfs/exports</code> shown earlier.</p> <p>Without options.</p> <p><code>showmount</code> will show names of hosts currently connected to the system:</p> <pre><code>    # showmount\n    Hosts on nfsshop:\n    client9.exworks\n</code></pre> <p>With the <code>--directories</code> option.</p> <p><code>showmount</code> will show NFS--directories names of directories that are currently mounted by a remote host:</p> <pre><code>    # showmount --directories\n    Directories on nfsshop:\n    /home\n</code></pre> <p>With the <code>--all</code> option.</p> <p>the <code>showmount</code> command lists both the remote client (hosts) and the mounted directories:</p> <pre><code>    # showmount --all\n    All mount points on nfsshop:\n    client9.exworks:/home\n</code></pre>"},{"location":"lpic2.209.2/#nfs-client-software-and-configuration","title":"NFS client: software and configuration","text":"<p>An NFS client system is a system that does a mount-attempt, using the <code>mount</code> command. The <code>mount</code> needs to have support for NFS built-in. This will generally be the case.</p> <p>The NFS client-system needs to have appropriate NFS support in the kernel, as shown earlier (see Configuring NFS). Next, it needs a running portmapper. Last, software is needed to perform the remote mounts attempt: the <code>mount</code> command.</p> <p>Note Familiarity with the <code>mount</code> command and the file <code>/etc/fstab</code> is assumed in this paragraph. If in doubt, consult the appropriate manual pages.</p> <p>The <code>mount</code> command normally used NFSmount mount to mount a remote filesystem through NFS:</p> <pre><code>    mount -t nfs remote:/there  /here\n</code></pre> <ul> <li> <p>This specifies the filesystem /there on the remote server remote.</p> </li> <li> <p>The mount point /here on the client, as usual.</p> </li> </ul> <p>Example: to mount the <code>/usr</code> filesystem, which is on server system <code>nfsshop</code>, onto the local mount-point <code>/usr</code>, use:</p> <pre><code>    mount -t nfs nfsshop:/usr /usr\n</code></pre> <p>Fine-tuning of the mount request is done through options.</p> <pre><code>    mount -t nfs -o opts remote:/there /here\n</code></pre> <ul> <li>Several options are possible after the <code>-o</code> option selector. These     options affect either mount attempts or active NFS connections.</li> </ul> <p><code>ro</code> versus <code>rw</code></p> <ul> <li> <p>If <code>ro</code> is specified the remote NFS filesystem will be mounted     read-only. With the <code>rw</code> option the remote filesystem will be made     available for both reading and writing (if the NFS server agrees).</p> <p>The default on the NFS server side (<code>/etc/exports</code>) is <code>ro</code>, but the default on the client side (<code>mount -t nfs</code>) is <code>rw</code>. The server-setting takes precedence, so mounts will be done read-only.</p> </li> </ul> <p>Note <code>-o ro</code> can also be written as <code>-r</code>; <code>-o rw</code> can also be written as     <code>-w</code>.</p> <p><code>rsize=nnn</code> and <code>wsize=nnn</code></p> <ul> <li> <p>The <code>rsize</code> option specifies the size for NFSrsize NFSwsize read     transfers (from server to client). The <code>wsize</code> option specifies the     opposite direction. A higher number makes data transfers faster on a     reliable network. On a network where many retries are needed,     transfers may become slower.</p> <p>Default values are either <code>1024</code> or and <code>4096</code>, depending on your kernel NFS1024 NFS4096 version. Current kernels accept a maximum of up to <code>8192</code>. NFS8192 NFS version 3 over <code>tcp</code>, which will probably production-ready by the time you read this, allows a maximum size of <code>32768</code>. This size is defined with <code>NFSSVC_MAXBLKSIZE</code> in the file NFSNFSSVC_MAXBLKSIZE <code>include/linux/nfsd/const.h</code> found in the kernel source-archive.</p> </li> </ul> <p><code>udp</code> and <code>tcp</code></p> <ul> <li>Specifies the transport-layer protocol for the NFS connection. Most     NFS version 2 implementations support only <code>udp</code>, but <code>tcp</code>     implementations do exist. NFSudp NFStcp NFS version 3 will allow     both <code>udp</code> and <code>tcp</code> (the latter is under active development).     Future version 4 will allow only <code>tcp</code>. See NFS protocol     versions.</li> </ul> <p><code>nfsvers=n</code></p> <ul> <li>Specifies the NFS version used for the transport (see NFS protocol     versions). Modern versions of <code>mount</code> will use     version <code>3</code> by default. Older implementations that NFSnfsvers= still     use version <code>2</code> are probably numerous.</li> </ul> <p><code>retry=</code>n</p> <ul> <li>The <code>retry</code> option specifies the number of NFSretry= minutes to keep     on retrying mount-attempts before giving up. The default is <code>10000</code>     minutes.</li> </ul> <p><code>timeo=</code>n</p> <ul> <li>The <code>timeo</code> option specifies after how much time a mount-attempt     times out. The time-out value is NFStimeo= specified in deci-seconds     (tenth of a second). The default is <code>7</code> deci-seconds (0.7 seconds).</li> </ul> <p><code>hard</code> (default) versus <code>soft</code></p> <ul> <li> <p>These options control how hard the system will try. NFShard</p> <p><code>hard</code></p> <p>:   The system will try indefinitely.</p> <p><code>soft</code></p> <p>:   The system will try until an RPC (portmapper) timeout NFSsoft     occurs.</p> </li> </ul> <p><code>intr</code> versus <code>nointr</code> (default)</p> <ul> <li> <p>With these options one is able to control whether the user NFSintr     NFSnointr is allowed to interrupt the mount-attempt.</p> <p><code>intr</code></p> <p>:   A mount-attempt can be interrupted by the user if <code>intr</code> is     specified.</p> <p><code>nointr</code></p> <p>:   A mount-attempt cannot be interrupted by a user if <code>nointr</code> is     set. The mount request can seem to hang for days if <code>retry</code> has     its default value (10000 minutes).</p> </li> </ul> <p><code>fg</code> (default) and <code>bg</code></p> <ul> <li> <p>These options control the background mounting facility. It is off     by default.</p> <p><code>bg</code></p> <p>:   NFSbg This turns on background mounting: the client first     tries to mount in the foreground. All retries occur in the     background.</p> <p><code>fg</code></p> <p>:   All attempts occur in the foreground. </p> <p>Background mounting is also affected by other options. When <code>intr</code> is specified, the mount attempt will be interrupted by a an RPC timeout. This happens, for example, when either the remote host is down or the portmapper is not running. In a test setting the backgrounding was only done when a \"connection refused\" occurred.</p> </li> </ul> <p>Options can be combined using comma's:</p> <pre><code>    mount -t nfs -o ro,rsize=8192 nfsshop:/usr/share /usr/local/share\n</code></pre> <p>A preferred combination of options might be: <code>hard</code>, <code>intr</code> and <code>bg</code>. The mount will be tried indefinitely, with retries in the background, but can still be interrupted by the user that started the mount.</p> <p>Other mount options to consider are <code>noatime</code>, <code>noauto</code>, <code>nosuid</code> or even <code>noexec</code>. See <code>man 1 mount</code> and <code>man 5 nfs</code>. NFSnoatime NFSnoauto NFSnosuid NFSnoexec</p> <p>Of course, all these options can also be specified in <code>/etc/fstab</code>. Be sure to specify the <code>noauto</code> option if the filesystem should not be mounted automatically at boot time. The <code>user</code> option will allow non-root users to perform the mount. This is not default. Example entry in <code>/etc/fstab</code>:</p> <pre><code>    nfsshop:/home /homesOnShop  nfs ro,noauto,user   0  0\n</code></pre> <p>Now every user can do</p> <pre><code>    mount /homesOnShop\n</code></pre> <p>You can also use automounters to mount and unmount remote automount filesystems. However, these are beyond the scope of this objective.</p> <p>Testing NFS {#TestingNFS}</p> <p>After NFS has been set up, it can be tested. The following tools can help: <code>showmount</code>, <code>rpcinfo</code> and <code>nfsstat</code>.</p>"},{"location":"lpic2.209.2/#the-showmount-exports-command","title":"The <code>showmount --exports</code> command","text":"<p>As shown in showmount, the <code>showmount                 --exports</code> command lists the current exports for a server system. This can be used as a quick indication of the health of the created NFS system. showmount Nevertheless, there are more sophisticated ways of doing this.</p>"},{"location":"lpic2.209.2/#the-procmounts-file","title":"The <code>/proc/mounts</code> file","text":"<p>To see which file systems are mounted check /proc/mounts. It will also show nfs mounted filesystems.</p> <pre><code>    $ cat /proc/mounts\n</code></pre>"},{"location":"lpic2.209.2/#rpcinfo","title":"<code>rpcinfo</code>","text":"<p>portmapper The <code>rpcinfo</code> command reports RPC information. This can be used to probe the portmapper on a local or a remote rpcinfo system or to send pseudo requests.</p>"},{"location":"lpic2.209.2/#rpcinfo-probing-a-system","title":"rpcinfo: probing a system","text":"<p>The <code>rpcinfo -p</code> command lists all registered services the portmapper knows about. Each rpc... program registers itself at startup with the portmapper, so the names shown correspond to real daemons (or the kernel equivalents, as is the case for NFS version 3).</p> <p>It can be used on the server system <code>nfsshop</code> to see if the portmapper is functioning:</p> <pre><code>    program vers proto   port\n    100003    3   udp   2049  nfs\n</code></pre> <p>This selection of the output shows that this portmapper will accept connections for nfs version 3 on udp.</p> <p>A full sample output of <code>rpcinfo -p&gt;</code> on a server system:</p> <pre><code>    rpcinfo -p\n    program vers proto   port\n     100000    2   tcp    111  portmapper\n     100000    2   udp    111  portmapper\n     100024    1   udp    757  status\n     100024    1   tcp    759  status\n     100003    2   udp   2049  nfs\n     100003    3   udp   2049  nfs\n     100021    1   udp  32770  nlockmgr\n     100021    3   udp  32770  nlockmgr\n     100021    4   udp  32770  nlockmgr\n     100005    1   udp  32771  mountd\n     100005    1   tcp  32768  mountd\n     100005    2   udp  32771  mountd\n     100005    2   tcp  32768  mountd\n     100005    3   udp  32771  mountd\n     100005    3   tcp  32768  mountd\n</code></pre> <p>As can be seen in the listing above, the portmapper will accept RPC requests for versions 2 and 3 of the NFS protocol, both on udp.</p> <p>Note As can be seen, each RPC service has its own version number. The <code>mountd</code> service, for instance, supports incoming connections for versions 1, 2 or 3 of mountd on both udp and tcp.</p> <p>It is also possible to probe <code>nfsshop</code> (the server system) from a client system, by specifying the name of the server system after <code>-p</code>:</p> <pre><code>    rpcinfo -p nfsshop\n</code></pre> <p>The output, if all is well of course, will be the same.</p>"},{"location":"lpic2.209.2/#rpcinfo-making-null-requests","title":"rpcinfo: making null requests","text":"<p>It is possible to test a connection without doing any real work:</p> <p><code>rpcinfo -u</code> remotehost program</p> <p>This is like the <code>ping</code> command to test a network connection. However, <code>rpcinfo -u</code> works like a real rpc/nfs connection, sending a so-called null pseudo request. The <code>-u</code> option forces <code>rpcinfo</code> to use udp transport. The result of the test on <code>nfsshop</code>:</p> <pre><code>    rpcinfo -u nfsshop nfs\n    program 100003 version 2 ready and waiting\n    program 100003 version 3 ready and waiting\n</code></pre> <p>The <code>-t</code> options will do the same for tcp transport:</p> <pre><code>    rpcinfo -t nfsshop nfs\n    rpcinfo: RPC: Program not registered\n    program 100003 is not available\n</code></pre> <p>This system obviously does have support for nfs on udp, but not on tcp.</p> <p>Note In the example output, the number 100003 is used instead of or together with the name <code>nfs</code>. Name or number can be used in each others place. That is, we could also have written:</p> <pre><code>    rpcinfo -u nfsshop 100003\n</code></pre>"},{"location":"lpic2.209.2/#the-nfsstat-command","title":"The <code>nfsstat</code> command","text":"<p>The <code>nfsstat</code> command lists statistics (i.e., counters) about connections. This can be used to see whether something is going on at all and also to make sure nothing has gone crazy.</p> <p>table_title provides an overview of relevant options for <code>nfsstat</code>.</p> <pre><code>       rpc     nfs     both\n</code></pre> <p>server   <code>-sr</code> <code>-sn</code> <code>-s</code>   client   <code>-cr</code> <code>-cn</code> <code>-c</code>   both     <code>-r</code> <code>-n</code> <code>-nr</code></p> <p>: Some options for the <code>nfsstat</code> program</p> <p>Sample output from <code>nfsstat -sn</code> on the server host <code>nfsshop</code>:</p> <pre><code>    Server nfs v2:\n    null       getattr    setattr    root       lookup     readlink   \n    1       0% 3       0% 0       0% 0       0% 41      0% 0       0% \n    read       wrcache    write      create     remove     rename     \n    5595   99% 0       0% 0       0% 1       0% 0       0% 0       0% \n    link       symlink    mkdir      rmdir      readdir    fsstat     \n    0       0% 0       0% 0       0% 0       0% 7       0% 2       0%\n\n    Server nfs v3:\n    null       getattr    setattr    lookup     access     readlink   \n    1     100% 0       0% 0       0% 0       0% 0       0% 0       0% \n    read       write      create     mkdir      symlink    mknod      \n    0       0% 0       0% 0       0% 0       0% 0       0% 0       0% \n    remove     rmdir      rename     link       readdir    readdirplus\n    0       0% 0       0% 0       0% 0       0% 0       0% 0       0% \n    fsstat     fsinfo     pathconf   commit     \n    0       0% 0       0% 0       0% 0       0%\n</code></pre> <p>The <code>1</code>'s under both <code>null</code> headings are the result of the <code>rpcinfo -u                  nfsshop nfs</code> command shown earlier.</p>"},{"location":"lpic2.209.2/#securing-nfs","title":"Securing NFS","text":"<p>NFS security has several unrelated issues. First, the NFS protocol and implementations have some known weaknesses. NFS file-handles are numbers that should be random, but are not, in NFSsecuring reality. This opens the possibility of making a connection by guessing file-handles. Another problem is that all NFS data transfer is done as-is. This means that anyone able to listen to a connection can tap the information (this is called sniffing). Bad mount-point names combined with human error can be a completely different security risk.</p>"},{"location":"lpic2.209.2/#limiting-access","title":"Limiting access","text":"<p>Both sniffing and unwanted connection requests can be prevented by limiting access to each NFS server to a set of known, trusted hosts containing trusted users: within a small workgroup, for instance. Tcp-wrapper support or firewall software can be used to limit access to an NFS server.</p> <p>The tcp wrapper.</p> <p>Earlier on it was shown how to limit connections to the portmapper from specific hosts. The same can be done for the NFS related daemons, i.e., <code>rpc.mountd</code> and <code>rpc.statd</code>. If your system runs an old-fashioned user-space NFS server (i.e., has <code>rpc.nfsd</code> in the process list), consider protecting <code>rpc.nfsd</code> and possibly <code>rpc.lockd</code>, as well. If, on the other hand, your system is running a modern kernel-based NFS implementation (i.e., has <code>[nfsd]</code> in the process list), you cannot do this, since the <code>rpc.nfsd</code> program is not the one accepting the connections. Make sure tcp-wrapper support is built into each daemon you wish to protect.</p> <p>Firewall software.</p> <p>The problem with tcp-wrapper support is that there already is a connection inside the host at the time that the connection-request is refused. If a security-related bug exists within either the tcp-wrapper library or the daemon that contains the support, unwanted access could be granted. Firewall software (e.g., iptables) can make the kernel block connections before they enter the host. You may consider blocking unwanted NFS connections at each NFS server host or at the entry point of a network to all but acceptable hosts. Block at least the portmapper port (111/udp and 111/tcp). Also, considering blocking 2049/udp and 2049/tcp (NFS connections). You might also want to block other ports like the ones shown with the <code>rpcinfo -p</code> command: for example, the mount daemon ports 32771/udp and 32768/tcp. How to set up a firewall is shown in detail in ???.</p>"},{"location":"lpic2.209.2/#preventing-human-error","title":"Preventing human error","text":"<p>Simple human error in combination with bad naming may also result in a security risk. You would not be the first person to remove a remote directory tree because the mount point was not easily recognized as such and the remote system was mounted with read-write permissions.</p> <p>Mount read-only.</p> <p>Mounting a remote filesystem read-only can prevent accidental erasure. So, mount read-only whenever possible. If you do need to mount a part read-write, make the part that can be written (erased) as small as possible.</p> <p>Design your mountpoints well.</p> <p>Also, name a mount point so that it can easily be recognized as a mount point. One of the possibilities is to use a special name:</p> <pre><code>    /MountPoints/nfsshop\n</code></pre>"},{"location":"lpic2.209.2/#best-nfs-version","title":"Best NFS version","text":"<p>Progress has been made in NFS software. Although no software can prevent human error, other risks (e.g., guessable file-handles and sniffing) can be prevented with better software.</p> <p>Note NFS version 4 is a new version of the NFS protocol intended to fix NFSversion 4 all existing problems in NFS. At the time of this writing (May 2014) versions 4.0 and 4.1 have been released; version 4.2 is being developed. More about NFS version 4 and differences between earlier versions is covered in NFS protocol versions.</p> <p>Guessable file handles.</p> <p>One of the ways to break in a NFS server is to guess so-called file-handles. The old (32-bit) file-handles (used in NFS version 2) were rather easy to guess. NFSfile handles Version 3 of the NFS protocol offers improved security by using 64-bit file-handles that are considerably harder to guess.</p> <p>Version 4 security enhancements.</p> <p>Version 4 of the NFS protocol defines encrypted connections. When the connection is encrypted, getting information by sniffing is made much harder or even impossible.</p> <p>Overview of NFS components </p> <p>table_title provides an overview of the most important files and software related to NFS.</p> program or file description The kernel provides NFS support <code>portmap</code> handles RPC requests <code>rpc.nfsd</code> NFS server control (kernel space) or software (user space) <code>rpc.mountd</code> handles incoming (un)mount requests <code>/etc/exports</code> defines which filesystems are exported <code>exportfs</code> command (un)exports filesystems <code>showmount --exports</code> shows current exports The <code>rpcinfo</code> command reports RPC information The <code>nfsstat</code> command reports NFS statistics <code>showmount --all</code> shows active mounts to me (this host) `mount -t nfs mounts a remote filesystem remote:/there /here` <code>umount -t nfs -a</code> unmounts all remote filesystems"},{"location":"lpic2.209.2/#nfs-protocol-versions","title":"NFS protocol versions","text":"<p>Currently, there are a lot of changes in the NFS protocol that can affect the way the system is set up. </p> Protocol version Current status kernel or user space udp or tcp transport 1 never released 2 becoming obsolete user, kernel udp, some tcp impl. exist 3 new standard kernel udp, tcp: under development 4 new standard kernel tcp                           performance improvements;   mandates strong security;   stateful protocol <p>The trends that can be seen in this table  are: kernel space instead of user space and tcp instead of udp.</p> <p>A note on the transport protocol.</p> <p>Connections over <code>tcp</code> (NFS v3, v4, some v2) are considered better than connections over <code>udp</code> (NFS v2, v3). The <code>udp</code> option might be the best on a small, fast network. But <code>tcp</code> allows considerably larger packet sizes (<code>rsize</code>, <code>wsize</code>) to be set. With sizes of 64k, <code>tcp</code> connections are reported to be 10% faster than connections over <code>udp</code>, which does not allow sizes that large. Also, <code>tcp</code> is a more reliable protocol by design, compared to <code>udp</code>. </p>"},{"location":"lpic2.209.2/#nfsv4","title":"NFSv4","text":"<p>NFS version 4 (NFSv4) offers some new features compared to its predecessors. Instead of exporting multiple filesystems, NFSv4 exports a single pseudo file system for each client. The origin for this pseudo file system may be from different filesystems, but this remains transparent to the client.</p> <p>NFSv4 offers an extended set of attributes, including support form MS Windows ACL's. Although NFSv4 offers enhanced security features compared to previous versions of NFS, and has been around since 2003, it was never widely adopted. Users are encouraged to implement NFSv4.1 which has been ratified in January 2010. </p>"},{"location":"lpic2.210.0/","title":"Network Client Management (210)","text":"<p>This topic has a total weight of 11 points and contains the following 4 objectives:</p>"},{"location":"lpic2.210.0/#objective-2101-dhcp-configuration-2-points","title":"Objective 210.1; DHCP Configuration (2 points)","text":"<ul> <li>Candidates should be able to configure a DHCP server. This objective     includes setting default and per client options, adding static hosts     and BOOTP hosts. Also included is configuring a DHCP relay agent and     maintaining the DHCP server.</li> </ul>"},{"location":"lpic2.210.0/#objective-2102-pam-authentication-3-points","title":"Objective 210.2; PAM authentication (3 points)","text":"<ul> <li>The candidate should be able to configure PAM to support     authentication using various available methods.</li> </ul>"},{"location":"lpic2.210.0/#objective-2103-ldap-client-usage-2-points","title":"Objective 210.3; LDAP client usage (2 points)","text":"<ul> <li>Candidates should be able to perform queries and updates to an LDAP     server. Also included is importing and adding items, as well as     adding and managing users.</li> </ul>"},{"location":"lpic2.210.0/#objective-2104-configuring-an-openldap-server-4-points","title":"Objective 210.4; Configuring an OpenLDAP server (4 points)","text":"<ul> <li>Candidates should be able to configure a basic OpenLDAP server     including knowledge of LDIF format and essential access controls. An     understanding of the role of SSSD in authentication and identity     management is included.</li> </ul>"},{"location":"lpic2.210.1/","title":"DHCP Configuration (210.1)","text":""},{"location":"lpic2.210.1/#dhcp-configuration-2101","title":"DHCP Configuration (210.1)","text":"<p>Candidates should be able to configure a DHCP server. This objective includes setting default and per client options, adding static hosts and BOOTP hosts. Also included is configuring a DHCP relay agent and maintaining the DHCP server.</p>"},{"location":"lpic2.210.1/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>DHCP configuration files, terms and utilities</p> </li> <li> <p>Subnet and dynamically-allocated range setup</p> </li> </ul>"},{"location":"lpic2.210.1/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>dhcpd.conf</code></p> </li> <li> <p><code>dhcpd.leases</code></p> </li> <li> <p><code>/var/log/daemon.log</code> and <code>/var/log/messages</code></p> </li> <li> <p><code>arp</code></p> </li> <li> <p><code>dhcpd</code></p> </li> <li> <p><code>radvd</code></p> </li> <li> <p><code>radvd.conf</code></p> </li> </ul>"},{"location":"lpic2.210.1/#what-is-dhcp","title":"What is DHCP?","text":"<p>The \"Dynamic Host Configuration Protocol\" (DHCP)\u00a0is a\u00a0protocol that allows computers to get configuration information about the\u00a0network from the\u00a0network. DHCP addresses are\u00a0\"leased\" from servers to clients for a period of time. There is a separate protocol for assigning IPv6 addresses called DHCPv6, although the \"Neighbour Discovery Protocol\" (NDP) better fits this purpose.</p> <p>The process of requesting and assigning addresses works as follows:</p> <ul> <li> <p>When a\u00a0computer starts, it sends a\u00a0request to the\u00a0network.</p> </li> <li> <p>Any DHCP\u00a0servers that receive\u00a0this request decide\u00a0what address and     other configuration options to assign to the\u00a0client. This is     typically based on things like: which network the\u00a0request arrived     on, or the\u00a0MAC address of the\u00a0 interface that sent the\u00a0request.</p> </li> <li> <p>Each server sends a\u00a0packet which offers to assign the\u00a0address to the     client.</p> </li> <li> <p>The\u00a0client decides which offer to accept, and sends a\u00a0message\u00a0to the     server confirming the\u00a0choice.</p> </li> <li> <p>The server acknowledges that it has recorded this address.</p> </li> </ul> <p>Amongst the most commonly used configuration items are: <code>ip-address</code>, <code>host-name</code>, <code>domain-name</code>, <code>subnet-mask</code>, <code>broadcast-address</code>, <code>routers</code> and <code>domain-name-servers</code>.</p> <p>The information is requested by a DHCP client and provided by a DHCP DHCPServer DHCPClient server. By default, the server listens for requests on udp port 67 and 67 answers through udp port 68, but it can be told to listen to another 68 port instead with the <code>-p</code> option. The DHCP server will then answer through an udp port with a number one higher than the port it listens to.</p> <p>Hosts using IPv6 are actually capable of assigning themselves link-local IP addresses using stateless autoconfiguration. DHCPv6 or NDP may be used to assign additional globally unique addresses and other configuration parameters. NDP is described in further detail in the section on <code>radvd</code></p> <p>The web-site Resources for DHCP contains a lot of (pointers to) information on the DHCP protocol, including RFC's.</p>"},{"location":"lpic2.210.1/#how-is-the-server-configured","title":"How is the server configured?","text":"<p>dhcpd The configuration of the DHCP server, <code>dhcpd</code>, is done DHCPdhcpd.conf by means of its configuration file <code>/etc/dhcpd.conf</code>.</p> <p>The elements that can be used in a configuration file are: (global) parameters, shared networks, subnets, groups and hosts.</p>"},{"location":"lpic2.210.1/#what-are-global-parameters","title":"What are (global) parameters?","text":"<p>Parameters can be seen as variables that get assigned a value and are DHCPGlobal Parameters passed from the server to the client. Some parameters start with the option keyword and some do not. Parameters that do not start with the option keyword are either parameters that control the behaviour of the DHCP server or are parameters that are optional in the DHCP protocol.</p> <p>The difference between \"normal\" parameters and \"global\" parameters lies purely in the scope of the parameters. DHCPNormal Parameters If, for instance, the DNS is always the same, it is pointless to add a <code>domain-name-servers</code> parameter-definition statement to every network-definition statement. By assigning the <code>domain-name-servers</code> parameter a value at the beginning of the configuration file, the parameter becomes a global parameter and its value becomes the default value for that parameter.</p> <p>The value of a global parameter can be overridden by assigning it another value in subsequent sections.</p>"},{"location":"lpic2.210.1/#what-is-a-shared-network-declaration","title":"What is a shared-network declaration?","text":"<p>A shared-network declaration is used if there are multiple subnets DHCPshared network on the same physical network. Parameters that are the same for all the subnets belonging to the shared-network can be defined once above the subnet-declarations within the shared-network declaration that encompasses those subnet-declarations.</p>"},{"location":"lpic2.210.1/#what-is-a-subnet-declaration","title":"What is a subnet declaration?","text":"<p>A subnet-declaration is used to define a network segment. Parameters DHCPsubnet declaration that only apply to the subnet in question are defined within the subnet-declaration.</p> <p>A subnet-declaration must contain a range statement that defines the IP-addresses the DHCP-server can give to clients on that subnet.</p>"},{"location":"lpic2.210.1/#what-is-a-group-declaration","title":"What is a group declaration?","text":"<p>A group-declaration is used to group other declarations, including DHCPgroup declaration group-declarations, that have a number of properties in common so that the common properties only have to be be specified once in stead of for every declaration.</p>"},{"location":"lpic2.210.1/#what-is-a-host-declaration","title":"What is a host declaration?","text":"<p>A host declaration is used to set properties for a specific client. DHCPhost declaration The client identifies itself to the DHCP server by one of its unique properties such as its NIC address or its client-identifier. NIC address</p>"},{"location":"lpic2.210.1/#example","title":"Example","text":"<p>Consider a firm which has four departments: Sales, Administration, Engineering and Management. All departments are located in the same building and each department has three floors to its disposal.</p> <p>On each floor, there are up to 200 workstations and one laser printer (LPRT-xx). Furthermore each department has its own colour laser-printer (CLPRT-xx) located on the middle floor. The printers can only be used by users of the department the printers belong to.</p> <p>All users obtain an IP-address from the company's DHCP-server and must be able to reach the company's DNS-server and NTP-server. All users get their mail using the POP3 protocol, send their mail using the SMTP protocol and read their news using the NNTP protocol.</p> <p>A graphical representation of the company's network is shown below:</p> <p></p>"},{"location":"lpic2.210.1/#the-network-architecture","title":"The network architecture","text":"<p>Assuming that the IP range 21.31.x.x has been assigned to the company and that each department has its own network (determined by the highest four bits of the third octet; in other words: the netmask used is /20 or 255.255.240.0), the subnets could be set up as follows: Table 10.1. The first two octets are 21.31</p> Dept. Floor IP range Router Description 0001 0001 21.31.17.0 - 21.31.17.255 Sales floor #1 0001 0010 21.31.18.0 - 21.31.18.255 21.31.17.1 Sales floor #2 0001 0011 21.31.19.0 - 21.31.19.255 Sales floor #3 0010 0100 21.31.36.0 - 21.31.36.255 Administration #4 0010 0101 21.31.37.0 - 21.31.37.255 21.31.36.1 Administration #5 0010 0110 21.31.38.0 - 21.31.38.255 Administration #6 0011 0111 21.31.55.0 - 21.31.55.255 Engineering floor #7 0011 1000 21.31.56.0 - 21.31.56.255 21.31.55.1 Engineering floor #8 0011 1001 21.31.57.0 - 21.31.57.255 Engineering floor #9 0100 1010 21.31.74.0 - 21.31.74.255 Management floor #10 0100 1011 21.31.75.0 - 21.31.75.255 21.31.74.1 Management floor #11 0100 1100 21.31.76.0 - 21.31.76.255 Management floor #12"},{"location":"lpic2.210.1/#the-network-services-available-to-workstations","title":"The network services available to workstations","text":"<p>The workstations on the company's network obtain their IP-address and the IP-addresses of the available network services from the company's DHCP-server via the department's DHCP-relay which also functions as a router.</p>"},{"location":"lpic2.210.1/#subnet-independent-services","title":"Subnet-independent Services","text":"<p>Subnet-independent services are the services that are available to all workstations on the company's network regardless the subnet they are on. The table below shows those services and their fixed IP-addresses.</p> Service Description IP-address Host name DHCP DHCP-server 21.31.0.1 dhcp.company.com DNS DNS 21.31.0.2 dns.company.com SMTP SMTP-server 21.31.0.3 smtp.company.com POP3 POP3-server 21.31.0.4 pop3.company.com NEWS NNTP-server 21.31.0.5 news.company.com NTP NTP-server 21.31.0.6 ntp.company.com"},{"location":"lpic2.210.1/#subnet-dependent-services","title":"Subnet dependent services","text":"<p>Subnet-dependent services are the services that are only available to the workstations on the same subnet as the service. The table below shows those services and their fixed IP-addresses.</p> Department Service Description IP-address Name Router Sales Router floor #2 21.31.17.1 rtr-02.company.com Printer Laser Printer floor #1 21.31.17.2 lprt-01.company.com Sales Printer Laser Printer floor #2 21.31.18.2 lprt-02.company.com Printer Laser Printer floor #3 21.31.19.2 lprt-03.company.com Printer Color Laser Printer floor #2 21.31.18.3 clprt-02.company.com Router Administration Router floor #5 21.31.36.1 rtr-05.company.com Printer Laser Printer floor #4 21.31.36.2 lprt-04.company.com Administration Printer Laser Printer floor #5 21.31.37.2 lprt-05.company.com Printer Laser Printer floor #6 21.31.38.2 lprt-06.company.com Printer Color Laser Printer floor #5 21.31.37.3 clprt-05.company.com Router Engineering Router floor #8 21.31.55.1 rtr-08.company.com Printer Laser Printer floor #7 21.31.55.2 lprt-07.company.com Engineering Printer Laser Printer floor #8 21.31.56.2 lprt-08.company.com Printer Laser Printer floor #9 21.31.57.2 lprt-09.company.com Printer Color Laser Printer floor #8 21.31.56.3 clprt-08.company.com Router Management Router floor #11 21.31.74.1 rtr-11.company.com Printer Laser Printer floor #10 21.31.74.2 lprt-10.company.com Management Printer Laser Printer floor #11 21.31.75.2 lprt-11.company.com Printer Laser Printer floor #12 21.31.76.2 lprt-12.company.com Printer Color Laser Printer floor #11 21.31.75.3 clprt-11.company.com"},{"location":"lpic2.210.1/#building-the-dhcp-servers-configuration-file","title":"Building the DHCP-server's configuration file","text":"<p>The information needed to be able to build a configuration file has already been gathered in the previous sections when the network topology was devised.</p> <p>In this section the actual configuration file <code>/etc/dhcpd.conf</code> will be filled with the necessary information.</p>"},{"location":"lpic2.210.1/#the-global-parameters-for-services","title":"The global parameters for services","text":"<p>Global parameters are put at the top of the configuration file: DHCPoption DHCPdomain-name-servers DHCPsmtp-server DHCPpop-server DHCPnntp-server</p> <pre><code>    # DNS\n    option domain-name-servers 21.31.0.2;\n    # SMTP\n    option smtp-server 21.31.0.3;\n    # POP3\n    option pop-server 21.31.0.4;\n    # NEWS\n    option nntp-server 21.31.0.5;\n    # NTP\n    option time-servers 21.31.0.6;\n</code></pre> <p>Another way to do this is by using domain names. A single domain name must resolve to a single IP-address. Using domain names, you would put the following entries in the configuration file:</p> <pre><code>    # DNS\n    option domain-name-servers dns.company.com;\n    # SMTP\n    option smtp-server smtp.company.com;\n    # POP3\n    option pop-server pop3.company.com;\n    # NEWS\n    option nntp-server news.company.com;\n    # NTP\n    option time-servers ntp.company.com;\n</code></pre>"},{"location":"lpic2.210.1/#the-companys-shared-networks-and-subnets","title":"The company's shared-networks and subnets","text":"<p>As has been discussed in the previous sections, there are four different networks, one for each department and there are twelve different IP-address ranges, one for each floor. Furthermore, each network has its own router and printers.</p> <p>This translates into four shared-networks each having their own netmask and broadcast-address and encompassing three IP-address ranges.</p> <p>The netmask is an IP-address used to determine the network a workstation, or some other network device that uses an IP-address, is on. A netmask has 1's in the bit-positions that are the same for all network devices in that network and 0's in the other positions. Since all the subnets on a department's shared-network are on the same physical network, the distinction is made on the shared-network level, not on the floor level. The floor level has been coded into the IP-address (low-nibble of the third octet) to prepare for the planned instalment next year of one router per floor in stead of one router per department. The netmask is calculated as follows:</p> <pre><code>21.31.16.0 - : | 0001 0101 | 0001 1111 | 0001 0000 | 0000 0000 | SALES\n21.31.31.255 : | 0001 0101 | 0001 1111 | 0001 1111 | 1111 1111 | NETWORK\n\n21.31.32.0 - : | 0001 0101 | 0001 1111 | 0010 0000 | 0000 0000 | ADMINISTRATION\n21.31.47.255 : | 0001 0101 | 0001 1111 | 0010 1111 | 1111 1111 | NETWORK\n\n21.31.48.0 - : | 0001 0101 | 0001 1111 | 0011 0000 | 0000 0000 | ENGINEERING\n21.31.63.255 : | 0001 0101 | 0001 1111 | 0011 1111 | 1111 1111 | NETWORK\n\n21.31.64.0 - : | 0001 0101 | 0001 1111 | 0100 0000 | 0000 0000 | MANAGEMENT \n21.31.79.255 : | 0001 0101 | 0001 1111 | 0100 1111 | 1111 1111 | NETWORK\n\nfixed-bits   : | 1111 1111 | 1111 1111 | 1111 0000 | 0000 0000 | NETMASK\n                    255         255         240          0\n</code></pre> <p>Using a netmask of 255.255.240.0, the network an IP-address is on can be determined. This is done by AND-ing the IP-address with the netmask. To determine on which of the four networks a workstation with IP-address 21.31.57.105 is, the following calculation is performed:</p> <pre><code>21.31.57.105 : | 0001 0101 | 0001 1111 | 0011 1001 | 0110 1001 | IP-ADDRESS\n255.255.240.0: | 1111 1111 | 1111 1111 | 1111 0000 | 0000 0000 | AND NETMASK\n21.31.48.0:    | 0001 0101 | 0001 1111 | 0011 0000 | 0000 0000 | GIVES NETWORK\n</code></pre> <p>The IP-address 21.31.57.105 is on the 21.31.48.0 network, which is the Engineering-network.</p> <p>The broadcast-address is used to send packets to every workstation broadcast on a network. A broadcast-address differs per network and can be determined by replacing all bits reserved/used for the host address (as denoted by the subnet mask) with 1's.</p> <p>Another way of determining the broadcast-address is to take the inverse of the netmask, in this case 0.0.15.255, and then OR the result with the network address:</p> <pre><code>21.31.16.0 - : | 0001 0101 | 0001 1111 | 0001 0000 | 0000 0000 | SALES\n0.0.15.255   : | 0000 0000 | 0000 0000 | 0000 1111 | 1111 1111 | OR INV NETMASK\n21.31.31.255 : | 0001 0101 | 0001 1111 | 0001 1111 | 1111 1111 | GIVES BCAST\n\n21.31.32.0 - : | 0001 0101 | 0001 1111 | 0010 0000 | 0000 0000 | ADMINISTRATION\n0.0.15.255   : | 0000 0000 | 0000 0000 | 0000 1111 | 1111 1111 | OR INV NETMASK\n21.31.47.255 : | 0001 0101 | 0001 1111 | 0010 1111 | 1111 1111 | GIVES BCAST\n\n21.31.48.0 - : | 0001 0101 | 0001 1111 | 0011 0000 | 0000 0000 | ENGINEERING\n0.0.15.255   : | 0000 0000 | 0000 0000 | 0000 1111 | 1111 1111 | OR INV NETMASK\n21.31.63.255 : | 0001 0101 | 0001 1111 | 0011 1111 | 1111 1111 | GIVES BCAST\n\n21.31.64.0 - : | 0001 0101 | 0001 1111 | 0100 0000 | 0000 0000 | MANAGEMENT \n0.0.15.255   : | 0000 0000 | 0000 0000 | 0000 1111 | 1111 1111 | OR INV NETMASK\n21.31.79.255 : | 0001 0101 | 0001 1111 | 0100 1111 | 1111 1111 | GIVES BCAST\n</code></pre> <p>The broadcast-address for the network an IP-address is on can be determined by OR-ing the IP-address with the inverse-netmask. For a workstation with IP-address 21.31.57.105, the broadcast-address can be calculated as follows:</p> <pre><code>21.31.57.105 : | 0001 0101 | 0001 1111 | 0011 1001 | 0110 1001 | IP-ADDRESS\n0.0.15.255   : | 0000 0000 | 0000 0000 | 0000 1111 | 1111 1111 | OR INV NETMASK\n21.31.63.255 : | 0001 0101 | 0001 1111 | 0011 1111 | 1111 1111 | GIVES BCAST\n</code></pre> <p>The IP-address 21.31.57.105 belongs to a network that has broadcast-address 21.31.63.255, which is correct since the IP-address is on the Engineering-network.</p> <p>To tell the DHCP-server what IP-addresses to give-out per subnet, a range statement must be added to the subnet. Is this example the IP-addresses 21.31.x.0 to 21.31.x.10 and 21.31.x.211 to 21.31.x.255 on every floor are reserved for printers and routers. This means that for every subnet the range statement is:</p> <pre><code>range 21.31.x.11 21.31.x.210\n</code></pre> <p>Where \"x\" depends on the department and the floor.</p> <p>To implement this structure, the following lines are added to the configuration-file:</p> <pre><code># The Sales network, floors 1-3\nshared-network sales-net {\n  # Sales-net specific parameters\n  option routers 21.31.17.1;\n  option lpr-servers 21.31.17.2, 21.31.18.2, 21.31.19.2, 21.31.18.3;\n  option broadcast-address 21.31.31.255;\n  subnet 21.31.17.0 netmask 255.255.240.0 {\n    # Floor #1 specific parameters\n    range 21.31.17.11 21.31.17.210;\n  }\n  subnet 21.31.18.0 netmask 255.255.240.0 {\n    # Floor #2 specific parameters\n    range 21.31.18.11 21.31.18.210;\n  }\n  subnet 21.31.19.0 netmask 255.255.240.0 {\n    # Floor #3 specific parameters\n    range 21.31.19.11 21.31.19.210;\n  }\n}\n\n# The Administration network, floors 4-6\nshared-network administration-net {\n  # Administration-net specific parameters\n  option routers 21.31.36.1;\n  option lpr-servers 21.31.36.2, 21.31.37.2, 21.31.38.2, 21.31.37.3;\n  option broadcast-address 21.31.47.255;\n  subnet 21.31.36.0 netmask 255.255.240.0 {\n    # Floor #4 specific parameters\n    range 21.31.36.11 21.31.36.210;\n  }\n  subnet 21.31.37.0 netmask 255.255.240.0 {\n    # Floor #5 specific parameters\n    range 21.31.37.11 21.31.37.210;\n  }\n  subnet 21.31.38.0 netmask 255.255.240.0 {\n    # Floor #6 specific parameters\n    range 21.31.38.11 21.31.38.210;\n  }\n}\n\n# The Engineering network, floors 7-9\nshared-network engineering-net {\n  # Engineering-net specific parameters\n  option routers 21.31.55.1;\n  option lpr-servers 21.31.55.2, 21.31.56.2, 21.31.57.2, 21.31.56.3;\n  option broadcast-address 21.31.63.255;\n  subnet 21.31.55.0 netmask 255.255.240.0 {\n    # Floor #7 specific parameters\n    range 21.31.55.11 21.31.55.210;\n  }\n  subnet 21.31.56.0 netmask 255.255.240.0 {\n    # Floor #8 specific parameters\n    range 21.31.56.11 21.31.56.210;\n  }\n  subnet 21.31.57.0 netmask 255.255.240.0 {\n    # Floor #9 specific parameters\n    range 21.31.57.11 21.31.57.210;\n  }\n}\n\n# The Management network, floors 10-12\nshared-network management-net {\n  # Management-net specific parameters\n  option routers 21.31.74.1;\n  option lpr-servers 21.31.74.2, 21.31.75.2, 21.31.76.2, 21.31.75.3;\n  option broadcast-address 21.31.79.255;\n  subnet 21.31.74.0 netmask 255.255.240.0 {\n    # Floor #10 specific parameters\n    range 21.31.74.11 21.31.74.210;\n  }\n  subnet 21.31.75.0 netmask 255.255.240.0 {\n    # Floor #11 specific parameters\n    range 21.31.75.11 21.31.75.210;\n  }\n  subnet 21.31.76.0 netmask 255.255.240.0 {\n    # Floor #12 specific parameters\n    range 21.31.76.11 21.31.76.210;\n  }\n}\n</code></pre>"},{"location":"lpic2.210.1/#static-hosts","title":"Static hosts","text":"<p>A static host is a host that always gets the same IP-address from the DHCP-server in opposite to dynamic hosts which get their DHCPStatic Host IP-address from a range of IP-addresses.</p> <p>Obviously, the DHCP-server must be able recognize the host to be able to conclude that the host has been defined as a static one in the DHCP-server's configuration file. This can be done by using the <code>dhcp-client-identifier</code> option or by using the DHCPclient identifier <code>hardware ethernet</code> option. DHCPethernet address</p> <p>The <code>dhcp-client-identifier</code> is send to the server by the client (host) and must uniquely identify that client. This is not safe because there is no way to be sure that there isn't a second client that uses the same identifier.</p> <p>The <code>hardware ethernet</code> option causes the match to be done on the client's NIC-address which is world-wide unique.</p> <p>If the client does not send a <code>dhcp-client-identifier</code>, then the NIC-address is used to identify the client.</p> <p>There are two designers, working for the Engineering department, that come to the office sometimes to get a hardcopy of their designs in colour. These designers are called \"luke\" and \"leah\" and they bring their laptops and connect them to the Engineering-network. The host names of their machines will be \"luke\" and \"leah\".</p> <p>To make this so, the administrator has added the following lines to the DHCP-server's configuration file:</p> <pre><code>group {\n      # options that apply to all the static hosts\n      option routers 21.31.55.1;\n      option lpr-servers 21.31.56.3;\n      option broadcast-address 21.31.63.255;\n      netmask 255.255.240.0;\n      host luke {\n              # specific for luke\n              hardware ethernet AA:88:54:72:7F:92;\n              fixed-address 21.31.55.211;\n              option host-name \"luke\";\n      }\n\n      host leah {\n              # specific for leah\n              hardware ethernet CC:88:54:72:84:4F;\n              fixed-address 21.31.55.212;\n              option host-name \"leah\";\n      }\n}\n</code></pre>"},{"location":"lpic2.210.1/#static-bootp-hosts","title":"Static BOOTP hosts","text":"<p>This is a special static host. If luke and leah's laptops were BOOTP-clients, the administrator could have added the following DHCPBOOTP lines to the DHCP-server's configuration file:</p> <pre><code>group {\n      # options that apply to all the static hosts\n      option routers 21.31.55.1;\n      option lpr-servers 21.31.56.3;\n      option broadcast-address 21.31.63.255;\n      netmask 255.255.240.0;\n      host luke {\n              # specific for luke\n              filename \"lukes-boot-file\";\n              server-name \"server name to send to luke\";\n              next-server &lt;address of server to load boot-file from&gt;;\n              hardware ethernet AA:88:54:72:7F:92;\n              fixed-address 21.31.55.211;\n              option host-name \"luke\";\n      }\n\n      host leah {\n              # specific for leah\n              filename \"leahs-boot-file\";\n              server-name \"server name to send to leah\";\n              next-server &lt;address of server to load boot-file from&gt;;\n              hardware ethernet CC:88:54:72:84:4F;\n              fixed-address 21.31.55.212;\n              option host-name \"leah\";\n      }\n}\n</code></pre> <p>The <code>filename</code> option states the name of the file to get from the server defined in the <code>next-server</code> option. If the <code>next-server</code> is omitted, the server to get the file from is the DHCP-server. The <code>server-name</code> can be used to send the name of the server the client is booting from to the client.</p> <p>For information on the valid options, consult the dhcp-options man page (<code>man dhcp-options</code>) and the dhcpd.conf man page (<code>man dhcpd.conf</code>).</p> <p>Controlling the DHCP-server's behaviour</p>"},{"location":"lpic2.210.1/#leases","title":"Leases","text":"<p>A lease is the amount of time a client may use the IP-address it got from the DHCP-server. The client must refresh the lease periodically because the IP-address can be given to another client if the lease is expired. Normally, a client will be given the same IP-address if the lease is refreshed before it expired.</p> <p>The option <code>max-lease-time</code> is used to specify the DHCPmax-lease-time maximum amount of time in seconds that will be assigned to a lease if the client asks for a specific expiration time.</p> <p>The option <code>default-lease-time</code> is used to specify the DHCPdefault-lease-time amount of time in seconds that will be assigned to a lease if a client does not ask for a specific expiration time.</p> <p>The DHCP-server keeps a database of the leases it has issued in the file <code>/var/dhcp/dhcpd.leases</code>. If this file is DHCPdhcpd.leases empty, this is probably caused by the fact that you have only defined static hosts in the DHCP-server's configuration file and you haven't used any <code>range</code> statements. On the DHCP clients the leased IP addresses are kept in the file <code>dhclient.leases</code>.</p>"},{"location":"lpic2.210.1/#interfaces-the-dhcp-server-listens-on","title":"Interfaces the DHCP-server listens on","text":"<p>Unless you specify otherwise, <code>dhcpd</code> will listen on all interfaces for a dhcp request. If you only want to serve requests on eth0 for instance, you can tell this to the daemon by including the parameter on the command line that starts the daemon.</p>"},{"location":"lpic2.210.1/#reloading-the-dhcp-server-after-making-changes","title":"Reloading the DHCP-server after making changes","text":"<p>This is done as follows: DHCPreload</p> <pre><code># /etc/init.d/dhcp restart\n</code></pre> <p>This will stop the running daemon, wait two seconds, then start a new daemon which causes <code>/etc/dhcpd.conf</code> to be read again.</p>"},{"location":"lpic2.210.1/#logging","title":"Logging","text":"<p>By default the DHCP server logs using syslogd, although many Linux distributions have exchanged syslogd for Systemd's journald. Logging is configured in the <code>dhcpd.conf</code> file using the log-facility keyword. This statement causes the DHCP server to do all of its logging on the specified log facility once the dhcpd.conf file has been read. By default the DHCP server logs to the daemon facility. Possible log facilities include auth, authpriv, cron, daemon, ftp, kern, lpr, mail, mark, news, ntp, security, syslog, user, uucp, and local0 through local7. Not all of these facilities are available on all systems, and there may be other facilities available on other systems. In addition to setting log-facility value, you may need to modify your syslog.conf file to configure logging of the DHCP server. For example, you might add a line like this:</p> <pre><code>    local7.debug /var/log/dhcpd.log\n</code></pre> <p>The syntax of the syslog.conf file may be different on some operating systems - consult the syslog.conf manual page to be sure. To get syslog to start logging to the new file, you must first create the file with correct ownership and permissions (usually, the same owner and permissions of your /var/log/messages or /usr/adm/messages file should be fine) and send a SIGHUP to syslogd. Note that <code>journald</code> does not log to a plaintext file; it uses a binairy format instead. To view messages specific for <code>dhcpd</code>, you have to filter these out using the <code>journalctl</code> command.</p> <p>DHCP-relaying</p>"},{"location":"lpic2.210.1/#what-is-dhcp-relaying","title":"What is DHCP-relaying?","text":"<p>In our earlier example there is one DHCP-server for the whole DHCPrelaying network and there are routers between the clients and that server.</p> <p>If a client would be able to connect to the DHCP-server through a router, the DHCP-server would not see the NIC-address of the client but the NIC-address of the router. This would mean that a static host for instance, could not be recognized by its hardware address.</p> <p>A DHCP-relay agent, such as <code>dhcrelay</code> provides a dhcrelay means for relaying DHCP and BOOTP requests from one of the subnets to the company's DHCP-server.</p> <p>If you need more information, consult The Internet Consortium DHCP Homepage.</p> <p>The DHCP Relay Agent listens for DHCP and BOOTP queries and responses. When a query is received from a client, dhcrelay forwards it to the list of DHCP servers specified on the command line. When a reply is received from a server, it is broadcast or unicast (according to the relay agent's ability or the client's request) on the network from which the original request came. If no interface names are specified on the command line dhcrelay will identify all network interfaces, elimininating non-broadcast interfaces if possible, and attempt to configure each interface.</p> <p>Please consult the man page (<code>man dhcrelay</code>) for further details.</p> <p>Assigning addresses in IPv6 networks</p> <p>radvd The previous paragraphs were mainly concerned with automatic IP assignment in IPv4 networks. Networks using IPv6 often use the \"Neighbor Discovery Protocol\" to obtain an IP address that is valid for the network. In Linux, this protocol is handled by the \"Router Advertisement\" (<code>radvd</code>) daemon.</p> <p>The process for IPv6 address assignment works a bit different from IPv4 networks, because IPv6 hosts always assign link-local addresses for IPv6-enabled interfaces automatically, without any help from external hosts. NDP builds upon this stateless autoconfiguration process by distributing \"prefixes\" instead of addresses. Using the prefix (which is basically the network part of an IP address) obtained through NDP, hosts can assign valid IPv6 addresses to themselves. So in contrast with the DHCP daemon on IPv4 networks, NDP has no concept of IP pools and leases.</p> <p>Instead of requesting an address, clients send \"router sollicitation\" requests to obtain a valid IPv6 prefix. The <code>radvd</code> daemon responds to these requests with router advertisement messages. These messages contain the routing prefix used on the link, the maximum transmission unit (MTU), and the address of the responsible default router.</p> <p>The <code>radvd</code> daemon is configured by <code>/etc/radvd.conf</code>, which has to contain at least the interface the daemon should listen on and the prefix it has to serve. Additionally, <code>radvd</code> can periodically re-advertise its prefixes to hosts on the same network. If you wish, you can also configure the lifetime of the IPv6 addresses that hosts configure for themselves.</p> <p>A typical <code>radvd.conf</code> would look similar to the following:</p> <pre><code>interface eth0 { \n        AdvSendAdvert on;\n        MinRtrAdvInterval 3; \n        MaxRtrAdvInterval 10;\n        prefix 2001:0db8:0100:f101::/64 { \n                AdvOnLink on; \n                AdvAutonomous on; \n                AdvRouterAddr on; \n        };\n};\n</code></pre>"},{"location":"lpic2.210.2/","title":"PAM authentication (210.2)","text":""},{"location":"lpic2.210.2/#pam-authentication-2102","title":"PAM authentication (210.2)","text":"<p>The candidate should be able to configure PAM to support authentication using various available methods.</p>"},{"location":"lpic2.210.2/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>PAM configuration files, terms and utilities</p> </li> <li> <p>passwd and shadow passwords</p> </li> <li> <p>basic SSSD functionality for LDAP authentication</p> </li> </ul>"},{"location":"lpic2.210.2/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/etc/pam.d</code></p> </li> <li> <p><code>pam.conf</code></p> </li> <li> <p><code>nsswitch.conf</code></p> </li> <li> <p><code>pam_unix, pam_cracklib, pam_limits, pam_listfile</code></p> </li> </ul>"},{"location":"lpic2.210.2/#what-is-pam","title":"What is PAM?","text":"<p>PAM is the acronym for Pluggable Authentication Modules. PAM consists of a set of libraries and an API (Application Programming Interface) that can be used to perform authentication tasks. Privilege granting programs, such as <code>login</code> and <code>su</code>, use the API to perform standard authentication tasks.</p>"},{"location":"lpic2.210.2/#how-does-it-work","title":"How does it work?","text":"<p>account</p> <ul> <li>Provide account verification types of service: has the user's     password expired? Is this user permitted access to the requested     service?</li> </ul> <p>authentication</p> <ul> <li>Establish if the user really is whom he claims to be. This can be     done, for example, by asking a password or, given the right module,     by reading a chip-card or by performing a retinal or fingerprint     scan.</li> </ul> <p>password</p> <ul> <li>This group's responsibility is the task of updating authentication     mechanisms. Typically, such services are strongly coupled to those     of the authentication group. Some authentication mechanisms lend     themselves well to being updated. The user might be presented with a     question like \"Please enter the new password\".</li> </ul> <p>session</p> <ul> <li>This group of tasks covers things that should be done prior to a     service being offered and after it is withdrawn. Such tasks include     the maintenance of audit trails and the mounting of the user's home     directory. The session management group is important as it provides     both an opening and closing hook for modules that affect the     services available to a user.</li> </ul> <p>PAM can be configured using the file <code>/etc/pam.conf</code> which has the following format:</p> <pre><code>    service   type   control   module-path   module-arguments\n</code></pre> <p>service</p> <ul> <li>This is the name of the application involved, for example: <code>login</code>, <code>ssh</code> or <code>passwd</code>.</li> </ul> <p>type</p> <ul> <li>This is the type of group the task to be performed belongs to:     account, auth (the authentication group), password or session.</li> </ul> <p>control</p> <ul> <li> <p>This field indicates what the PAM-API should do in case     authentication fails for any module.</p> <p>re-quisite</p> <ul> <li>Upon failure, the authentication process will be     terminated immediately.</li> </ul> <p>required</p> <ul> <li>This will return failure after the remaining modules     for this service and type have been invoked.</li> </ul> <p>sufficient</p> <ul> <li>Upon success, the authentication process will be     satisfied, unless a prior required module has failed the     authentication.</li> </ul> <p>optional</p> <ul> <li>The success or failure of this module is only important     if this is the only module associated with this     service and this type.</li> </ul> </li> </ul> <p>module-path</p> <ul> <li>This is the filename, including the full path, of the PAM that is to     be used by the application.</li> </ul> <p>module-arguments</p> <ul> <li>These are module specific arguments, separated by spaces, that are     to be passed to the module. Refer to the specific module's     documentation for further details.</li> </ul> <p>Configuration is also possible using individual configuration files, which is recommended. These files should all be located in the <code>/etc/pam.d</code> directory. If this directory exists, the file <code>/etc/pam.conf</code> will be ignored. The filenames should all be lowercase and be identical to the name of the service, such as <code>login</code>. The format of these files is identical to <code>/etc/pam.conf</code> with the exception that there is no service field.</p> <p>Modules</p>"},{"location":"lpic2.210.2/#pam_unix","title":"pam_unix","text":"<p>This module configures authentication via <code>/etc/passwd</code> and <code>/etc/shadow</code>.</p> <p>account</p> <ul> <li> <p>The type \"account\" does not authenticate the user but checks     other things such as the expiration date of the password     and might force the user to change his password based on the     contents of the files <code>/etc/passwd</code> and <code>/etc/shadow</code>.</p> <p>debug</p> <ul> <li>Log information using <code>syslog</code>.</li> </ul> <p>audit</p> <ul> <li>Also logs information, even more than debug does.</li> </ul> </li> </ul> <p>auth</p> <ul> <li> <p>The type \"auth\" checks the user's password against the password     database(s). This component is configured in the file     <code>/etc/nsswitch.conf</code>. Please consult the man page     (<code>man nsswitch.conf</code>) for further details.</p> <p>audit</p> <ul> <li>Log information using <code>syslog</code>.</li> </ul> <p>debug</p> <ul> <li>Also logs information using <code>syslog</code> but less than audit.</li> </ul> <p>nodelay</p> <ul> <li>This argument sets the delay-on-failure, which has a default of     a second, to nodelay.</li> </ul> <p>nullok</p> <ul> <li>Allows empty passwords. Normally authentication fails if     the password is blank.</li> </ul> <p>try_first_pass</p> <ul> <li>Use the password from the previous stacked auth module and     prompt for a new password if the retrieved     password is blank or incorrect.</li> </ul> <p>use_first_pass</p> <ul> <li>Use the result from the previous stacked auth module, never      prompt the user for a password and fails if the     result was a fail.</li> </ul> </li> </ul> <p>password</p> <ul> <li> <p>The type \"password\" changes the user's password. PAM password</p> <p>audit</p> <ul> <li>Log information using <code>syslog</code>.</li> </ul> <p>bigcrypt</p> <ul> <li>Use the DEC \"C2\" extension to crypt().</li> </ul> <p>debug</p> <ul> <li>Also logs information using <code>syslog</code> but less than audit.</li> </ul> <p>md5</p> <ul> <li>Use md5 encryption instead of crypt().</li> </ul> <p>nis</p> <ul> <li>Use NIS (Network Information Service) passwords.</li> </ul> <p>not_set_pass</p> <ul> <li>Don't use the passwords from other stacked modules and do not     give the new password to other stacked modules.</li> </ul> <p>nullok</p> <ul> <li>Allows empty passwords. Normally authentication fails if the     password is blank.</li> </ul> <p>remember</p> <ul> <li>Remember the last n passwords to prevent the user from using one     of the last n passwords again.</li> </ul> <p>try_first_pass</p> <ul> <li>Use the password from the previous stacked auth module, and     prompt for a new password if the retrieved password is blank or     incorrect.</li> </ul> <p>use_authtok</p> <ul> <li>Set the new password to the one provided by a previous module.</li> </ul> <p>use_first_pass</p> <ul> <li>Use the result from the previous stacked auth module, never     prompt the user for a password and fails if the result was a     fail.</li> </ul> </li> </ul> <p>session</p> <ul> <li> <p>The type \"session\" uses syslog to log the user's name and session     type at the start and end of a session.</p> <p>The \"session\" type does not support any options.</p> </li> </ul> <p>For each service that requires authentication a file with the name of that service must be created in <code>/etc/pam.d</code>. Examples of those services are: <code>login</code>, <code>ssh</code>, <code>ppp</code>, <code>su</code>.</p> <p>For example purposes the file <code>/etc/pam.d/login</code> will be used:</p> <pre><code>    # Perform password authentication and allow accounts without a password\n    auth       required   pam_unix.so nullok\n\n    # Check password validity and continue processing other PAM's even if\n    # this test fails. Access will only be granted if a 'sufficient' PAM,\n    # that follows this 'required' one, succeeds.\n    account    required   pam_unix.so\n\n    # Log the user name and session type to syslog at both the start and the end\n    # of the session.\n    session    required   pam_unix.so\n\n    # Allow the user to change empty passwords (nullok), perform some additional\n    # checks (obscure) before a password change is accepted and enforce that a\n    # password has a minimum (min=4) length of 4 and a maximum (max=8) length of\n    # 8 characters.\n    password   required   pam_unix.so nullok obscure min=4 max=8\n</code></pre>"},{"location":"lpic2.210.2/#pam_nis","title":"pam_nis","text":"<p>This module configures authentication via NIS. ConfiguringNIS Authentication To be able to authenticate via NIS, the module <code>pam_nis.so</code> is needed. This module can be found at PAM NIS Authorisation Module.</p> <p>To set up things in such a way that NIS authentication is sufficient (and if that is not the case try <code>pam_unix.so</code>), the lines that do the trick in <code>/etc/pam.d/login</code> are:</p> <pre><code>    auth    sufficient pam_nis.so item=user \\\n    sense=allow map=users.byname value=compsci\n    auth    required   pam_unix.so try_first_pass\n\n    account sufficient pam_ldap.so \\\n    item=user sense=deny map=cancelled.byname error=expired\n    account required   pam_unix.so\n</code></pre>"},{"location":"lpic2.210.2/#pam_ldap","title":"pam_ldap","text":"<p>This module configures authentication via LDAP. To be able to authenticatie via LDAP, the module ConfiguringLDAP Authentication <code>pam_ldap.so</code> is needed. This module can be found at PADL Software Pty Ltd.</p> <p>To set up things in such a way that LDAP authentication is sufficient, (and if that is not the case try <code>pam_unix.so</code>), the lines that do the trick in <code>/etc/pam.d/login</code> are:</p> <pre><code>    auth    sufficient pam_ldap.so\n    auth    required   pam_unix.so try_first_pass\n\n    account sufficient pam_ldap.so\n    account required   pam_unix.so\n</code></pre>"},{"location":"lpic2.210.2/#pam_cracklib","title":"pam_cracklib","text":"<p>This plugin provides strength-checking for passwords. This is done by performing a number of checks to ensure passwords are not too weak. It checks the password against dictonaries, the previous password(s) and rules about the use of numbers, upper and lowercase and other characters.</p> <pre><code>    #%PAM-1.0\n    #\n    # These lines allow a md5 systems to support passwords of at least 14\n    # bytes with extra credit of 2 for digits and 2 for others the new\n    # password must have at least three bytes that are not present in the\n    # old password\n    #\n    password  required pam_cracklib.so \\\n    difok=3 minlen=15 dcredit= 2 ocredit=2\n    password  required pam_unix.so use_authtok nullok md5\n</code></pre>"},{"location":"lpic2.210.2/#pam_limits","title":"pam_limits","text":"<p>The pam_limits PAM module sets limits on the system resources that can be obtained in a user-session. Users of uid=0 are affected by this limits, too. By default limits are taken from the <code>/etc/security/limits.conf</code> config file. Then individual files from the <code>/etc/security/limits.d/</code> directory are read. The files are parsed one after another in the order of \\\"C\\\" locale. The effect of the individual files is the same as if all the files were concatenated together in the order of parsing. If a config file is explicitely specified with a module option then the files in the above directory are not parsed. The module must not be called by a multithreaded application.</p>"},{"location":"lpic2.210.2/#pam_listfile","title":"pam_listfile","text":"<p>This module allows or denies an action based on the presence of the item in a listfile. A listfile is a textfile containing a list of usernames, one username per line. The type of item can be set via the configuration parameter item and can have the value of user, tty, rhost, ruser, group, or shell. The sense configuration parameter determines whether the entries in the list are allowed. Possible values are allow and deny.</p>"},{"location":"lpic2.210.2/#sssd","title":"SSSD","text":"<p>Configure SSSD for LDAP authentication</p> <p>The following steps describe the configuration of SSSD to use LDAP for authentication:</p> <p>1. The following packages need to be installed:</p> <pre><code>    sssd-client\n    sssd-common\n    sssd-common-pac\n    sssd-ldap\n    sssd-proxy\n    python-sssdconfig\n    authconfig\n    authconfig-gtk\n</code></pre> <p>Use your package manager to install these packages.</p> <p>2. Check the current settings for sssd, if any:</p> <pre><code>    # authconfig --test\n</code></pre> <p>This will show you the current settings which are already in place. Also check for an existing <code>/etc/sssd/sssd.conf</code> file. On a fresh installation you can expect all settings to be disabled and that the sssd.conf file will not be present.</p> <p>3. Now configure sssd:</p> <pre><code>    # authconfig \\\n    --enablesssd \\\n    --enablesssdauth \\\n    --enablelocauthorize \\\n    --enableldap \\\n    --enableldapauth \\\n    --ldapserver=ldap://ldap.example.com:389 \\\n    --disableldaptls \\\n    --ldapbasedn=dc=example,dc=com \\\n    --enablerfc2307bis \\\n    --enablemkhomedir \\\n    --enablecachecreds \\\n    --update\n</code></pre> <p>4. Check the configuration in <code>/etc/sssd/sssd.conf</code>.</p> <p>In case you're using TLS make sure that the <code>ldap_tls_cacertdir</code> and <code>ldap_tls_cacert</code> parameters are configured correctly and point to your certificates. Also change <code>ldap_id_use_start_tls</code> to \"True\".</p> <p>To effect the changes, run:</p> <pre><code>    # systemctl restart sssd\n</code></pre> <p>Verify that all changes are effective by running:</p> <pre><code>    # authconfig test\n</code></pre> <p>5. Update <code>/etc/openldap/ldap.conf</code> to use the same ldap settings. Your <code>ldap.conf</code> file will look like this:</p> <pre><code>    SASL_NOCANON on\n    URI ldaps://ldap.example.com:389\n    BASE dc=example,dc=com\n    TLS_REQUIRE never\n    TLS_CACERTDIR /etc/pki/tls/cacerts\n    TLS_CACERT /etc/pki/tls/certs/mybundle.pem\n</code></pre> <p>Please note that <code>TLS_REQUIRE</code> is set to never. This is done in order to avoid issues with application stacks like <code>PHP</code>, which have difficulties with <code>LDAPS</code> and <code>TLS</code>.</p> <p>6. Make sure that sssd is up and running and that it will be started after a system reboot. Run <code>systemctl status sssd</code> to check this. To start sssd, run <code>systemctl start sssd</code> and to make sssd persistent across reboots, run <code>systemctl enable sssd</code>.</p>"},{"location":"lpic2.210.3/","title":"LDAP client usage (210.3)","text":""},{"location":"lpic2.210.3/#ldap-client-usage-2103","title":"LDAP client usage (210.3)","text":"<p>Candidates should be able to perform queries and updates to an LDAP server. Also included is importing and adding items, as well as adding and managing users.</p>"},{"location":"lpic2.210.3/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>LDAP utilities for data management and queries</p> </li> <li> <p>Change user passwords</p> </li> <li> <p>Querying the LDAP directory</p> </li> </ul>"},{"location":"lpic2.210.3/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>ldapsearch</code></p> </li> <li> <p><code>ldappasswd</code></p> </li> <li> <p><code>ldapadd</code></p> </li> <li> <p><code>ldapdelete</code></p> </li> </ul>"},{"location":"lpic2.210.3/#ldap","title":"LDAP","text":"<p>LDAP stands for Lightweight Directory Access Protocol. As the name suggests, it is a lighter version of DAP, which stands for the Directory Access Protocol that is defined by the X.500 standard. For more information on X.500, please read RFC 2116. LDAPRFC 2116</p> <p>The reason for a lightweight version is that DAP was rather heavy on processor load, thereby asking for more than the processors could provide at the time. LDAP is described in RFC 2251. LDAPRFC 2251</p> <p>The LDAP project was started at the University of Michigan, but, as can be read on their site, is no longer maintained there. For current information, the University of Michigan site points visitors to the OpenLDAP site instead.</p> <p>The type of information best suited for storage in a directory is information with a low mutation grade. The reason for this is that directories can not compete with RDBM systems because they are only optimized for read access. So then, what do we store in a directory? Typically, LDAP directories contain employee data such as surname, christian name, address, phone number, department, social security number, E-mail address. Alternatively, directories might store newsletters for everyone to read, description of company policies and procedures, templates supporting the house style of documents.</p> <p>LDAP is a client/server system. The server can use a variety of databases to store a directory, each optimized for quick and copious read operations. When an LDAP client application connects to an LDAP server, it can either query a directory or attempt to modify it. In the event of a query, the server either answers the query locally, or it can refer the querent to an LDAP server which does have the answer. If the client application is attempting to modify information within an LDAP directory, the server verifies that the user has permission to make the change and then adds or updates the information.</p> <p>entry</p> <ul> <li>A single unit within an LDAP directory. Each entry is identified by     its unique Distinguished Name (DN).</li> </ul> <p>attributes</p> <ul> <li> <p>Information directly associated with an entry. For example, an     organization could be represented as an LDAP entry. Attributes     associated with the organization might be its fax number, its     address, and so on. People can also be represented as entries in the     LDAP directory. Common attributes for people include the person's     telephone number and email address.</p> <p>Some attributes are required, while other attributes are optional. An objectclass definition sets which attributes are required and which are not for each entry. Objectclass definitions are found in various schema files, located in the <code>/etc/openldap/schema/</code> directory.</p> </li> </ul> <p>LDIF</p> <ul> <li> <p>The LDAP Data Interchange Format (LDIF) is an ASCII text     representation of LDAP entries. Files used for importing data to     LDAP servers must be in LDIF format. An LDIF entry looks similar to     the following example:</p> <pre><code>    [&lt;id&gt;]\n    dn: &lt;distinguished name&gt;\n    &lt;attrtype&gt;: &lt;attrvalue&gt;\n    &lt;attrtype&gt;: &lt;attrvalue&gt;\n    &lt;attrtype&gt;: &lt;attrvalue&gt;\n</code></pre> <p>Each entry can contain as many <code>&lt;attrtype&gt;: &lt;attrvalue&gt;</code> pairs as needed. A blank line indicates the end of an entry. A line may be broken and continued (folded) by indenting the continued portion of the line. For example, the following two statements are identical:</p> <pre><code>    dn: cn=some_example_user,dc=example,dc=com\n    dn: cn=some_e\n     xample_user,\n     dc=example,d\n     c=com\n</code></pre> <p>Note All <code>&lt;attrtype&gt;</code> and <code>&lt;attrvalue&gt;</code> pairs must be defined in a corresponding schema file to use this information.</p> <p>Any value enclosed within a <code>&lt;</code> and a <code>&gt;</code> is a variable and can be set whenever a new LDAP entry is created. This rule does not apply, however, to <code>&lt;id&gt;</code>. The <code>&lt;id&gt;</code> is a number determined by the application used to edit the entry.</p> </li> </ul> <p>ldapsearch</p> <p><code>ldapsearch</code> is a shell-accessible interface to the ldap_search(3) library call. <code>ldapsearch</code> opens a connection to an LDAP server, binds, and performs a search using specified parameters. The filter should conform to the string representation for search filters as defined in RFC 2254.</p>"},{"location":"lpic2.210.3/#ldap-filters","title":"LDAP Filters","text":"Match notation Effect Equality = Creates a filter which requires a field to have a given value. For example, cn=Eric Johnson. Presence =* Wildcard to represent that a field can equal anything except NULL. So it will return entries with one or more values. For example, cn=* manager=* Substring =string* string Returns entries containing attributes containing the specified substring. For example, cn=Bob* cn=John cn=E*John. The asterisk (*) indicates zero (0) or more characters. Approximate ~= Returns entries containing the specified attribute with a value that is approximately equal to the value specified in the search filter. For example, cn~=suret l~=san franciso could return cn=sarette l=san francisco Greater than or equal to &gt;= Returns entries containing attributes that are greater than or equal to the specified value. Less than or equal to &lt;= Returns entries containing attributes that are less than or equal to the specified value. Parentheses () Separates filters to allow other logical operators to function. And &amp; Boolean operator. Joins filters together. All conditions in the series must be true. For example, (&amp;(filter)(filter)...). Or | Boolean operator. Joins filters together. At least one condition in the series must be true. For example, ( Not ! Boolean operator. Excludes all objects that match the filter. Only one filter is affected by the NOT operator. For example, (!(filter)) <p>Boolean expressions are evaluated in the following order:</p> <ul> <li> <p>Innermost to outermost parenthical expressions first.</p> </li> <li> <p>All expressions from left to right.</p> </li> </ul> <p>Examples:</p> <pre><code>    ldapsearch -h myhost -p 389 -s base -b \"ou=people,dc=example,dc=com\" \"objectclass=*\"\n</code></pre> <p>This command searches the directory server myhost, located at port 389. The scope of the search (-s) is base, and the part of the directory searched is the base DN (-b) designated. The search filter \"objectclass=*\" means that values for all of the entry's object classes are returned. No attributes are returned because they have not been requested. The example assumes anonymous authentication because authentication options are not specified.</p> <pre><code>    ldapsearch -x \"(|(cn=marie)(!(telephoneNumber=9*)))\"\n</code></pre> <p>This example shows how to search for entries that have a cn of marie OR do NOT have a telephoneNumber beginning with 9.</p>"},{"location":"lpic2.210.3/#ldappasswd","title":"ldappasswd","text":"<p>ldappasswd - change the password of an LDAP entry</p> <p>ldappasswd is a tool to set the password of an LDAP user. ldappasswd uses the LDAPv3 Password Modify (RFC 3062) extended operation.</p> <p>ldappasswd sets the password associated with the user (or an optionally specified user). If the new password is not specified on the command line and the user doesn't enable prompting, the server will be requested to generate a password for the user.</p> <p>Example:</p> <pre><code>    ldappasswd -x -h localhost -D \"cn=root,dc=example,dc=com\" \\ \n        -s secretpassword -W uid=admin,ou=users,ou=horde,dc=example,dc=com\n</code></pre> <p>Set the password for \"uid=admin,ou=users,ou=horde,dc=example,dc=com on localhost\".</p>"},{"location":"lpic2.210.3/#ldapadd","title":"ldapadd","text":"<p>ldapadd - LDAP add entry tool</p> <p><code>ldapadd</code> is implemented as a link to the <code>ldapmodify</code> tool. When invoked as <code>ldapadd</code> the <code>-a</code> (add new entry) flag is turned on automatically.</p> <p>Option: <code>ldapmodify</code> <code>-a</code></p> <p><code>-a</code> Adds new entries. The default for <code>ldapmodify</code> is to modify existing entries. If invoked as <code>ldapadd</code>, this option is always set.</p> <p>Example:</p> <pre><code>    ldapadd -h myhost -p 389 -D \"cn=orcladmin\" -w welcome -f jhay.ldif\n</code></pre> <p>Using this command, user orcladmin authenticates to the directory myhost, located at port 389. The command then opens the file jhay.ldif and adds its contents to the directory. The file might, for example, add the entry \"uid=jhay,cn=Human Resources,cn=example,dc=com\" and its object classes and attributes.</p>"},{"location":"lpic2.210.3/#ldapdelete","title":"ldapdelete","text":"<p><code>ldapdelete</code> - LDAP delete entry tool</p> <p><code>ldapdelete</code> is a shell-accessible interface to the ldap_delete_ext(3) library call.</p> <p><code>ldapdelete</code> opens a connection to an LDAP server, binds, and deletes one or more entries. If one or more DN arguments are provided, entries with those Distinguished Names are deleted.</p> <p>Example:</p> <pre><code>    ldapdelete -h myhost -p 389 -D \"cn=orcladmin\" -w welcome \\\n    \"uid=hricard,ou=sales,ou=people,dc=example,dc=com\"\n</code></pre> <p>This command authenticates user orcladmin to the directory myhost, using the password welcome. Then it deletes the entry \"uid=hricard,ou=sales,ou=people,dc=example,dc=com\".</p>"},{"location":"lpic2.210.3/#more-on-ldap","title":"More on LDAP","text":"<p>If you would like to read more about LDAP, this section points you to a few sources of information:</p> <ul> <li> <p>The OpenLDAP site</p> </li> <li> <p>OpenLDAP Software 2.4 Administrator's     Guide</p> </li> <li> <p>The LDAP Linux HOWTO</p> </li> <li> <p>The Internet FAQ archives where RFC's     and other documentation can be searched and found.</p> </li> </ul>"},{"location":"lpic2.210.4/","title":"Configuring an OpenLDAP server (210.4)","text":""},{"location":"lpic2.210.4/#configuring-an-openldap-server-2104","title":"Configuring an OpenLDAP server (210.4)","text":"<p>Candidates should be able to configure a basic OpenLDAP server including knowledge of LDIF format and essential access controls.</p>"},{"location":"lpic2.210.4/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>OpenLDAP</p> </li> <li> <p>Directory based configuration</p> </li> <li> <p>Access Control</p> </li> <li> <p>Distinguished Names</p> </li> <li> <p>Changetype Operations</p> </li> <li> <p>Schemas and Whitepages</p> </li> <li> <p>Directories</p> </li> <li> <p>Object IDs, Attributes and Classes</p> </li> </ul>"},{"location":"lpic2.210.4/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>slapd</code></p> </li> <li> <p><code>slapd.conf</code></p> </li> <li> <p>LDIF</p> </li> <li> <p><code>slapadd</code></p> </li> <li> <p><code>slapcat</code></p> </li> <li> <p><code>slapindex</code></p> </li> <li> <p><code>/var/lib/ldap/</code></p> </li> <li> <p><code>loglevel</code></p> </li> </ul>"},{"location":"lpic2.210.4/#openldap","title":"OpenLDAP","text":"<p>OpenLDAP uses <code>slapd</code> which is the stand-alone LDAP daemon. It listens for LDAP connections on any number of ports (389 by default), responding to the LDAP operations it receives over these connections. OpenLDAP is typically started at boot time.</p> <p>It can be installed either from source obtaining it from OpenLDAP software but most linux distributions deliver it through their packagemanagement system like yum or apt.</p> <p>In OpenLDAP, directory entries are arranged in a hierarchical tree-like structure. Traditionally, this structure reflected the geographic and/or organizational boundaries. Entries representing countries appear at the top of the tree. Below them are entries representing states and national organizations. Below them might be entries representing organizational units, people, printers, documents, or just about anything else.</p>"},{"location":"lpic2.210.4/#access-control","title":"Access Control","text":"<p>While the OpenLDAP directory gets filled the protection of data may become more critical. Some data might be protected by law or be confidential in any other way. Therefore access to the directory needs to be controlled. The default policy allows read access to all clients. Regardless of what  access control policy is defined, the olcRootDN is always allowed full  rights (i.e. auth, search, compare, read, and write) on everything.</p> <p>Access to <code>slapd</code> entries and attributes is controlled by the <code>olcAccess</code> attribute, whose values are a sequence of access rules. They begin with the access directive followed by a list of conditions:</p> <pre><code>    olcAccess: to &lt;what&gt;\n           by &lt;who&gt; &lt;type of access&gt;\n           by &lt;who&gt; &lt;type of access&gt;\n</code></pre> <p>For example:</p> <pre><code>    olcAccess: to attrs=userPassword\n           by anonymous auth\n           by self write\n           by * none\n</code></pre> <p>This access specification is used to keep a user's password protected. It allows anonymous users an authentication comparison on a password for the purpose of of logging on. Additionally it grants a user permission to change his password. The bottom line denies everyone else any access to the password.</p> <p>Alternatively we could grant users permission to update all their data with access speficifations like the following:</p> <pre><code>    olcAccess: to attrs=userPassword\n           by anonymous auth\n           by * none\n    olcAccess: to *\n               by self write\n               by * none\n</code></pre>"},{"location":"lpic2.210.4/#distinguished-names","title":"Distinguished Names","text":"<p>A distinguished name (DN) is the name (set of attributes) which uniquely identifies an entry in the OpenLDAP directory and corresponds to the <code>path</code> which has to be traversed to reach that entry. A DN contains an attribute and value pair separated by commas.</p> <p>For example:</p> <pre><code>    cn=John Doe,ou=editing,o=Paris,c=F\n    cn=Jane Doe,ou=editing,o=London,c=UK\n    cn=Tom Jones,ou=reporting,o=Amsterdam,c=NL\n</code></pre> <p>Any of the attributes defined in the directory schema may be used to make up a DN. The order of the component attribute value pairs is important. The DN contains one component for each level of the directory hierarchy from the root down to the level where the entry resides. LDAP DNs begin with the most specific attribute and continue with progressively broader attributes. The first component of the DN is referred to as the Relative Distinguished Name (RDN). It identifies an entry distinctly from any other entries that have the same parent.</p> <p>An example to create an entry for a person:</p> <pre><code>    dn: cn=John Doe,o=bmi,c=us\n    objectclass: top\n    objectclass: person \n    cn: John Doe \n    sn: Doe\n    telephonenumber: 555-111-5555\n</code></pre> <p>Some characters have special meaning in a DN. For example, = (equals) separates an attribute name and value and comma separates attribute=value pairs. The special characters are: comma, equals, plus,less than, greater than, number sign, semicolon, backslash, quotation mark.</p> <p>A special character can be escaped in an attribute value to remove the special meaning. To escape these special characters or other characters in an attribute value in a DN string, use the following methods:</p> <p>If a character to be escaped is one of the special characters, precede it by a backslash (\"\\\" ASCII 92). This example shows a method of escaping a comma in an organization name:</p> <pre><code>    CN=Supergroup,O=Crosby\\, Stills\\, Nash and Young,C=US\n</code></pre>"},{"location":"lpic2.210.4/#slapd-config","title":"slapd-config","text":"<p>OpenLDAP 2.3 and later have transitioned to using a dynamic runtime configuration engine, <code>slapd-config</code>. The older style <code>slapd.conf</code> file is still supported, but its use is deprecated and support for it will be withdrawn in a future OpenLDAP release.</p> <p>Note Although the slapd-config system stores its configuration as (text-based) LDIF files, you should never edit any of the LDIF files directly. Configuration changes should be performed via LDAP operations, e.g. <code>ldapadd</code>, <code>ldapdelete</code>, or <code>ldapmodify</code>.</p> <p>Depending on the linux distribution the <code>slapd-config</code> configuration tree <code>slapd.d</code> may be located in <code>/etc/OpenLDAP</code> or <code>/usr/local/etc/OpenLDAP</code>.</p> <p>An example might look like this:</p> <pre><code>    /etc/OpenLDAP/slapd.d\n    |-- cn=config\n    |\u00a0\u00a0 |-- cn=module{0}.ldif\n    |\u00a0\u00a0 |-- cn=schema\n    |\u00a0\u00a0 |\u00a0\u00a0 |-- cn={0}core.ldif\n    |\u00a0\u00a0 |\u00a0\u00a0 |-- cn={1}cosine.ldif\n    |\u00a0\u00a0 |\u00a0\u00a0 `-- cn={2}inetorgperson.ldif\n    |\u00a0\u00a0 |-- cn=schema.ldif\n    |\u00a0\u00a0 |-- olcDatabase={0}config.ldif\n    |\u00a0\u00a0 |-- olcDatabase={-1}frontend.ldif\n    |\u00a0\u00a0 `-- olcDatabase={1}hdb.ldif\n    `-- cn=config.ldif\n</code></pre> <p>The <code>slapd.d</code> tree has a very specific structure. The root of the tree is named <code>cn=config</code> and contains global configuration settings. Additional settings are contained in separate child entries.</p> <p>These may be the following:</p> <ul> <li> <p>Dynamically loaded modules in the <code>cn=module{0}.ldif</code></p> </li> <li> <p>Schema definitations in the <code>cn=schema</code> directory (more about the     topic of schema's will follow below)</p> </li> <li> <p>Backend-specific configuration in the <code>cn=Database={1}hdb.ldif</code></p> </li> <li> <p>Database-specific configuration in the <code>cn=Database={0}config.ldif</code></p> </li> </ul> <p>The general layout of the LDIF (for more information on LDIF refer to the section below) that is used to create the configuration tree is as follows:</p> <pre><code>    # global configuration settings\n    dn: cn=config\n    objectClass: olcGlobal\n    cn: config\n    &lt;global config settings&gt;\n\n    # schema definitions\n    dn: cn=schema,cn=config\n    objectClass: olcSchemaConfig\n    cn: schema\n    &lt;system schema&gt;\n\n    dn: cn={X}core,cn=schema,cn=config\n    objectClass: olcSchemaConfig\n    cn: {X}core\n    &lt;core schema&gt;\n\n    # additional user-specified schema\n    ...\n\n    # backend definitions\n    dn: olcBackend=&lt;typeA&gt;,cn=config\n    objectClass: olcBackendConfig\n    olcBackend: &lt;typeA&gt;\n    &lt;backend-specific settings&gt;\n\n    # database definitions\n    dn: olcDatabase={X}&lt;typeA&gt;,cn=config\n    objectClass: olcDatabaseConfig\n    olcDatabase: {X}&lt;typeA&gt;\n    &lt;database-specific settings&gt;\n\n    # subsequent definitions and settings\n    ...\n</code></pre> <p>For the domain <code>example.com</code> the configuration file might look like this:</p> <pre><code>    dn: olcDatabase=hdb,cn=config\n    objectClass: olcDatabaseConfig\n    objectClass: olcHdbConfig\n    olcDatabase: hdb\n    olcSuffix: dc=example,dc=com\n    olcRootDN: cn=Manager,dc=example,dc=com\n    olcRootPW: secret \n    olcDbDirectory: /var/lib/ldap\n</code></pre> <p>It is more secure to generate a password hash using <code>slappasswd</code> instead of the plain text password secret as in the example above. In that case the <code>olcRootPW</code> line would be changed into something like the following:</p> <pre><code>    olcRootPW: {SSHA}xEleXlHqbSyi2FkmObnQ5m4fReBrjwGb\n</code></pre> <p>The <code>olcLogLevel</code> directive specifies at which debugging level statements and operation statistics should be syslogged. Log levels may be specified as integers or by keyword. Multiple log levels may be used and the levels are additive.</p> <p>Available levels are:</p> <pre><code>    1      (0x1 trace) trace function calls\n    2      (0x2 packets) debug packet handling\n    4      (0x4 args) heavy trace debugging (function args)\n    8      (0x8 conns) connection management\n    16     (0x10 BER) print out packets sent and received\n    32     (0x20 filter) search filter processing\n    64     (0x40 config) configuration file processing\n    128    (0x80 ACL) access control list processing\n    256    (0x100 stats) stats log connections/operations/results\n    512    (0x200 stats2) stats log entries sent\n    1024   (0x400 shell) print communication with shell backends\n    2048   (0x800 parse) entry parsing\n    16384  (0x4000 sync) LDAPSync replication\n    32768  (0x8000 none) only messages that get logged whatever log level is set\n</code></pre> <p>For example:</p> <pre><code>    olcLogLevel: -1\n</code></pre> <p>This will cause lots and lots of debugging information to be logged.</p> <pre><code>    olcLogLevel: conns filter\n</code></pre> <p>This will only log the connection and search filter processing.</p> <pre><code>    olcLogLevel: stats\n</code></pre> <p>Basic stats logging is configured by default. However, if no olcLogLevel is defined, no logging occurs (equivalent to a 0 level).</p> <p>Note that the actual OpenLDAP database holding the user data is not located in the <code>slapd.d</code> configuration directory tree. Its location may be changed with the olcDbDirectory directory (see the example above) but by convention it is usually <code>/var/lib/ldap</code> /var/lib/ldap/.</p> <p>Its contents typically looks like this:</p> <pre><code>    $ ls -l /var/lib/ldap\n    total 1168\n    -rw-r--r--. 1 ldap ldap    4096 Dec 12 14:29 alock\n    -rw-------. 1 ldap ldap    8192 Dec  2 21:31 cn.bdb\n    -rw-------. 1 ldap ldap 2351104 Dec 12 14:29 __db.001\n    -rw-------. 1 ldap ldap  819200 Dec 12 14:29 __db.002\n    -rw-------. 1 ldap ldap  163840 Dec 12 14:29 __db.003\n    -rw-rw-r--. 1 ldap ldap     104 Dec  2 21:12 DB_CONFIG\n    -rw-------. 1 ldap ldap    8192 Dec  2 21:31 dn2id.bdb\n    -rw-------. 1 ldap ldap   32768 Dec  2 21:31 id2entry.bdb\n    -rw-------. 1 ldap ldap    8192 Dec  2 21:31 objectClass.bdb\n</code></pre>"},{"location":"lpic2.210.4/#ldif","title":"LDIF","text":"<p>All modifications to the OpenLDAP database are formatted in the LDIF LDIF format. LDIF stands for LDAP Data Interchange Format. It is used by OpenLDAP's tools like <code>slapadd</code> in order to add data to the database. An example of a LDIF file:</p> <pre><code>    cat adduser.ldif\n\n    # John Doe's Entry\n    dn: cn=John Doe,dc=example,dc=com\n    cn: John Doe\n    cn: Johnnie Doe\n    objectClass: person\n    sn: Doe\n</code></pre> <p>Multiple entries are separated using a blank line. <code>Slapcat</code> <code>slapcat</code> can be used to export information from the LDAP database in the LDIF format.</p> <p>For example:</p> <pre><code>    slapcat -l all.ldif\n</code></pre> <p>This will generate a file called <code>all.ldif</code> which contains a full dump of the LDAP database.</p> <p>The generated output can be used by <code>slapadd</code> <code>slapadd</code> to import the data into an LDAP database.</p> <p>For example:</p> <pre><code>    slapadd -l all.ldif\n</code></pre> <p>Sometimes it may be necessary to regenerate LDAP's database indexes. This can be done using the <code>slapindex</code> tool. <code>slapindex</code> It may also be used to regenerate the index for a specific attribute like the UID:</p> <pre><code>    slapindex uid\n</code></pre> <p>Note that <code>slapd</code> should not be running (at least, not in read-write mode) when the command is run to ensure consistency of the database.</p>"},{"location":"lpic2.210.4/#directories","title":"Directories","text":"<p>A directory can be contrived of as an hierarchically organized collection of data. The best known example probably is the telephone directory, but the file system directory is another one. Generally speaking a directory is a database that is optimized for reading, browsing and searching. OpenLDAP directories contain descriptive, attribute-based information. They do not support the roll-back mechanisms or complicated transactions that are found in Relational Data Base Management Systems (RDBMS's). Updates are typically simple all-or-nothing changes, if allowed at all. This type of directories are designed to give quick responses to high-volume lookup or search operations. OpenLDAP directories can be replicated to increase availability and reliability. Replicated databases can be temporarily out-of-sync but will be synchronized eventually.</p>"},{"location":"lpic2.210.4/#schemas-and-whitepages","title":"Schemas and Whitepages","text":"<p>Schemas are the standard way of describing the structure of objects that may be stored inside a directory. A whitepages schema is a data model for organizing the data contained in entries in a directory service such as an address book or LDAP. In a whitepages directory, each entry typically represents an individual that makes use of network resources, such as by receiving email of having an account to log in to a system. LDAP schemas are used to formally define attributes, object classes, and various rules for structuring the directory information tree. Usually schemas are configured in <code>slapd-config</code> LDIF using the include include directive.</p> <p>For example:</p> <pre><code>    include: file:///etc/OpenLDAP/schema/core.ldif\n    include: file:///etc/OpenLDAP/schema/cosine.ldif\n    include: file:///etc/OpenLDAP/schema/inetorgperson.ldif\n</code></pre> <p>The first line imports the core schema, which contains the schemas of attributes and object classes necessary for standard LDAP use. The cosine.schema imports a number of commonly used object classes and attributes, including those used for storing document information and DNS records. The third provides the inetOrgPerson object class definition and its associated attribute definitions. Other schemas are available with OpenLDAP (in <code>/etc/OpenLDAP/schema</code>); refer to the OpenLDAP Software 2.4 Administrator's guide for more information.</p> <p>References</p> <ul> <li> <p>OpenLDAP Software 2.4 Administrator's     Guide</p> </li> <li> <p>Directory Service</p> </li> <li> <p>Lightweight Directory Access     Protocol</p> </li> <li> <p>System Security Services     Daemon</p> </li> <li> <p>White Pages     Schema</p> </li> </ul>"},{"location":"lpic2.211.0/","title":"E-Mail services (211)","text":"<p>This topic has a weight of 8 points and contains the following objectives:</p>"},{"location":"lpic2.211.0/#objective-2111-using-e-mail-servers-4-points","title":"Objective 211.1; Using e-mail servers (4 points)","text":"<ul> <li>Candidates should be able to manage an e-mail server, including the     configuration of e-mail aliases, e-mail quotas and virtual e-mail     domains. This objective includes configuring internal e-mail relays     and monitoring e-mail servers.</li> </ul>"},{"location":"lpic2.211.0/#objective-2112-managing-local-e-mail-delivery-2-points","title":"Objective 211.2; Managing local e-mail delivery (2 points)","text":"<ul> <li>Candidates should be able to implement client e-mail management     software to filter, sort and monitor incoming user e-mail.</li> </ul>"},{"location":"lpic2.211.0/#objective-2113-managing-remote-e-mail-delivery-2-points","title":"Objective 211.3 Managing remote e-mail delivery (2 points)","text":"<ul> <li>Candidates should be able to install and configure POP and IMAP     daemons.</li> </ul>"},{"location":"lpic2.211.1/","title":"Using e-mail servers (211.1)","text":""},{"location":"lpic2.211.1/#using-e-mail-servers-2111","title":"Using e-mail servers (211.1)","text":"<p>Candidates should be able to manage an e-mail server, including the configuration of e-mail aliases, e-mail quotas and virtual e-mail domains. This objective includes configuring internal e-mail relays and monitoring e-mail servers.</p>"},{"location":"lpic2.211.1/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Configuration files for postfix</p> </li> <li> <p>Basic knowledge of the SMTP protocol</p> </li> <li> <p>Awareness of sendmail and exim</p> </li> </ul>"},{"location":"lpic2.211.1/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p>Configuration files and commands for postfix</p> </li> <li> <p><code>/etc/aliases</code></p> </li> <li> <p><code>/etc/postfix/</code></p> </li> <li> <p><code>/var/spool/postfix/</code></p> </li> <li> <p>sendmail emulation layer commands</p> </li> <li> <p>mail-related logs in /var/log</p> </li> </ul>"},{"location":"lpic2.211.1/#basic-knowledge-of-the-smtp-protocol","title":"Basic knowledge of the SMTP protocol","text":"<p>Since October 2008, RFC 5321 is used to describe the SMTPprotocol.</p> <p>When an SMTPclienthas a message to transmit, it establishes a two-way transmission channel to an SMTPserver. The responsibility of the client is to transfer the message to one or more SMTP servers, or to report a failure to do so.</p> <p>The means by which an e-mail message is presented to an SMTP client, and how the domain name to transfer the message to is determined, is a local matter that will not be addressed here.</p> <p>Detailed information can be found at:RFC5321.</p> <p>For demonstration and testing purposes a plain text SMTP session can be initiated with <code>telnet</code>, <code>nc</code> or <code>ncat</code>: nc ncat telnet</p> <pre><code>    telnet mx1.unix.nl 25\n    Connected to mx1.unix.nl (213.154.248.146).\n    Escape character is '^]'.\n    220 mx1.unix.nl ESMTP Exim 4.63 Thu, 12 Aug 2010 08:50:30 +0200\n    ehlo sue.nl\n    250-mx1.unix.nl Hello mx1.unix.nl [81.23.226.83]\n    250-SIZE 52428800\n    250-PIPELINING\n    250-AUTH PLAIN LOGIN\n    250-STARTTLS\n    250 HELP\n</code></pre> <p>When using <code>nc</code> or <code>ncat</code> when performing the commands above, an additional <code>Enter</code> keystroke may be necessary. This is due to the differences in return characters that may exist between <code>telnet</code> and other, similar tools.</p> <p>With <code>telnet &lt;smtp servername&gt;              25</code> initial contact with the SMTP server is established. In the example above mx1.unix.nl was used as the server. The server responds with the maximum message size, the pipelining, and the authentication capabilities of the server, in this case AUTH PLAIN LOGIN. The server is also able to use STARTTLS, and HELP.</p> <ul> <li> <p>SIZE: when the size of the message the client wishes to send exceeds     the set limit, the SMTP transaction will be aborted with an ERROR     code pipelining. Also, when enabled, an SMTP client can transmit a     group of SMTP commands (e.g., RSET, MAIL FROM:, RCPT TO:) without     waiting for a response from the server.</p> </li> <li> <p>AUTH PLAIN LOGIN: the SMTP server is capable of handling a plain     password/username authentication. This can be handy for mobile     devices using the SMTP server while originating from different IP     addresses.</p> </li> <li> <p>STARTTLS: The SMTP protocol itself doesn't include any form of     encryption. With STARTTLS the communciation can be encrypted using     certificates. This is fully described in RFC 3207.</p> </li> </ul> <p>Since we have established the initial connection we can now proceed:</p> <pre><code>    mail from: nonexistent@sue.nl\n    250 OK\n    rcpt to: nonexistent@unix.nl\n    250 Accepted\n</code></pre> <p>The server responds with \"250 OK\" but when, for example, the \"MAIL FROM:\" command is followed by a misformatted or incomplete email address the server responds with \"501: sender address must contain domain\" or a similar error. With \"RCPT TO: \\&lt;email address&gt;\" the destination of the message is given. If the recipient's address is accepted the server responds with: \"250 Accepted\".</p> <p>Now the mail serverknows who we are and to whom we wish to transmit a message. The email client also knows what the SMTP server is capable of. We then proceed with the transmission:</p> <pre><code>    data\n    354 Enter message, ending with \".\" on a line by itself\n    mail from: Aiu &lt;nonexistent@sue.nl&gt;\n    From: &lt;nonexistent@sue.nl&gt;\n    To: Info &lt;nonexistent@unix.nl&gt;\n    Subject: Demo messages\n    Date: 12-02-2010 08:53:00\n    MesssageID: 31231233@sue.nl\n    This is a demonstration mesage.\n    .\n    250 OK id=1OjReS-0005kT-Jj\n    quit\n</code></pre> <p>With the DATA command we proceed with the contents of the message. The server responds with: \"354 Enter message, ending with \\\".\\\" on a line by itself\".</p> <p>Then the message contents is entered, starting with the message headers. These headers are used by the email client. In the example the commands Mail From:, To:, Subject:, Date: and MessageID: are used. MessageID: is a unique identifier generated by the SMTP client. These headers are required as described in RFC 5322.</p> <p>After the headers have been entered, a blank line indicates that the actual text of the message commences. The message ends, as the DATA command response has indicated, with a \".\" (without the quotes) on a line by itself. The server responds with: \"250 OK id=1OjReS-0005kT-Jj\". The id is a unique SMTP server identifier and can be used for troubleshooting.</p> <p>Note To fight spam, some SMTP servers can check whether a message is RFC 5322 compliant. Regular SMTP clients are RFC 5322 compliant, but spammers often use not so regular SMTP clients and hence could send malformed messages.</p>"},{"location":"lpic2.211.1/#sendmail","title":"Sendmail","text":"<p>Basic sendmail configuration steps are: sendmail</p> <ol> <li> <p>Download Sendmail</p> </li> <li> <p>Set up Sendmail</p> </li> <li> <p>Configure Sendmail</p> </li> <li> <p>Build the Sendmail User Table</p> </li> <li> <p>Add your domain names to Sendmail</p> </li> <li> <p>Test your configuration file</p> </li> </ol> <p>Basic configuration of sendmail is described at: Sendmail basic installation.</p> <p>An installation and operation guide for sendmail 8.12 can be found at: Sendmail installation and operation guide.</p> <p>Sendmail can either be built from source or installed as sendmail binaries. With sendmail you must build a run-time configuration file. This is a file that sendmail reads when it starts which describes the mailers it knows about, how to parse addresses, how to rewrite the message header, and the settings of various options. Although it can be quite complex, it can usually be built using an m4-based configuration language (m4 is a general-purpose macro processor). Assuming you have the standard sendmail distribution, see cf/README for more information.</p> <p>The sendmail configuration files are processed by m4 to facilitate local customization; the directory cf in the distribution directory contains the source files. It contains several subdirectories:</p>"},{"location":"lpic2.211.1/#cf","title":"cf","text":"<p>Both site-dependent and site-independent descriptions of hosts. The files can be named after hosts (e.g., ucbvax.mc) when these are gateways, or after categories (such as generic-solaris2.mc) as a general description of an SMTP-connected host running Solaris 2.x. Files ending with .mc (\"M4 Configuration\") are input definitions; the output is in the corresponding .cf file. The files' general structure is described below.</p>"},{"location":"lpic2.211.1/#domain","title":"domain","text":"<p>Site-dependent subdomain descriptions. These are tied to the way your organization wants to do addressing. For example, <code>domain/CS.Berkeley.EDU.m4</code> is our description for hosts in the CS.Berkeley.EDU subdomain. These are referenced using the DOMAIN m4 macro in the .mc file.</p>"},{"location":"lpic2.211.1/#feature","title":"feature","text":"<p>Definitions of specific features that a particular host at your site might need. These are referenced using the FEATURE m4 macro. An example is use_cw_file that tells sendmail to read an <code>/etc/mail/local-host-names</code> file on startup to determine the set of local hosts.</p>"},{"location":"lpic2.211.1/#hack","title":"hack","text":"<p>Local hacks, referenced using the HACK m4 macro. Try to avoid these. The point of having them here is to make it clear that they smell.</p>"},{"location":"lpic2.211.1/#m4","title":"m4","text":"<p>Site-independent m4(1) include files that have information common to all configuration files. This can be thought of as an #include directory.</p>"},{"location":"lpic2.211.1/#mailer","title":"mailer","text":"<p>Definitions of mailers, referenced using the MAILER m4 macro. The types that are known in this distribution are fax, local, smtp, uucp, and usenet. For example, to include support for UUCP-based mailers, use MAILER(uucp).</p>"},{"location":"lpic2.211.1/#ostype","title":"ostype","text":"<p>Definitions describing various operating system environments (such as the location of support files). These are referenced using the OSTYPE m4 macro.</p>"},{"location":"lpic2.211.1/#sh","title":"sh","text":"<p>Shell files used by the m4 build process. You probably don't have to change these.</p>"},{"location":"lpic2.211.1/#siteconfig","title":"siteconfig","text":"<p>Local UUCP connectivity information. This directory has been replaced by the mailertable feature; any new configurations should use that feature to do UUCP (and other) routing. The use of the siteconfig directory is deprecated.</p> <p>Make sure the m4 utility is available at the server. With it the .mc macro files can be converted to a sendmail.cf file. The recommended method to configure sendmail is to edit the macro files and not the sendmail.cf file itself.</p> <p>Details of sendmail installation files can be seen at: Sendmail installation and operation guide.</p> <p>Important sendmail files</p> <p><code>/etc/mail/sendmail.cf</code> - Main sendmail configuration file. sendmail.cf</p> <p>makemap access.db <code>/etc/mail/access</code> - The sendmail access database file can be created to accept or reject mail from selected domains, systems and users. Since it is a database, after editing the text file you have to use <code>makemap</code> to create or update it.</p> <p>To create a new access map:</p> <pre><code>    # makemap hash /etc/mail/access.db &lt; /etc/mail/access\n</code></pre> <p>OK</p> <ul> <li>Accept mail even if other rules in the running ruleset would reject     it, for example, if the domain name is unresolvable. \\\"Accept\\\" does     not mean \\\"relay\\\", but at most acceptance for local recipients.     Thus, OK allows less than RELAY.</li> </ul> <p>RELAY</p> <ul> <li>Accept mail addressed to the indicated domain or received from the     indicated domain for relaying through your SMTP server. RELAY also     serves as an implicit OK for the other checks.</li> </ul> <p>REJECT</p> <ul> <li>Reject the sender or recipient with a general purpose message.</li> </ul> <p>DISCARD</p> <ul> <li>Discard the message completely using the $#discard mailer. If it     is used in check_compat, it affects only the designated recipient,     not the whole message as it does in all other cases. This should     only be used if really necessary.</li> </ul> <p>SKIP</p> <ul> <li>This can only be used for host/domain names and IP addresses/nets.     It will abort the current search for this entry without accepting or     rejecting it but causing the default action.</li> </ul> <p><code>/etc/mail/local-host-names</code> - Local host names can be defined in the local-host-names file. Add each domain that should be considered local into /etc/mail/local-host-names.</p> <p><code>/etc/mail/virtusertable</code> - Used to map incoming email to a local account. With virtusertable, messages sent to one account can be distributed to two users. Also a \\\"catch all\\\" email address can be set up to route all mistyped email to one particular user to create a new virtusertable.</p> <p>To generate the virtusertable database map:</p> <pre><code>    # makemap hash /etc/mail/virtusertable &lt; sourcefile\n</code></pre> <p><code>/etc/mail/genericstable</code> - Used for outbound mail. Can be used to rewrite local usernames so they appear to have originated from a different host or domain.</p> <p><code>/etc/mail/genericsdomain</code> - Populate this file with the <code>hostname --long</code> command.</p> <pre><code>    # hostname --long &gt; genericsdomain\n</code></pre> <p><code>/etc/mail/mailertable</code> - Used to route email from remote systems.</p> <p><code>/etc/mail/domaintable</code> - Can be used to transition from an old domain name to a new one.</p> <p>newaliases <code>/etc/mail/aliases</code> - Used to redirect mail for local recepients. Each line of <code>/etc/aliases</code> has the format of alias: user. Two system aliases must always be present: mailer_daemon: postmaster and postmaster: root. You can use aliases for all kind of daemons, for example use ntp: root. Now you can add a line to redirect all mail to root to a specific user or group of administrators, for example root: marc. <code>newaliases</code> needs to be run after any change to this file.</p> <pre><code>    # newaliases\n</code></pre> <p>If any update is made to one of the configuration files, sendmail needs to reload its' configuration:</p> <pre><code>    # killall -HUP sendmail\n</code></pre> <p>Antirelaying</p> <p>antirelaying</p> <p>Starting with version 8.9, sendmail does not relay by default. When using an older sendmail version, make changes to the <code>sendmail.cf</code> or <code>access</code> files to make sure that it does not relay. Antirelaying tips are described at: Controlling SMTP relaying tips - Sendmail.org.</p>"},{"location":"lpic2.211.1/#sendmail-test-option","title":"Sendmail test option","text":"<p>Sendmail can be run in test mode. Use the <code>-b</code> and <code>-t</code> options to do this. You need to run this as root.</p> <pre><code>    # sendmail -bt\n</code></pre>"},{"location":"lpic2.211.1/#sendmail-and-dns","title":"Sendmail and DNS","text":"<p>Make sure that the MX records for the MTA's are available in DNS. This can be checked with: MX records</p> <pre><code>    $ dig MX somedomain.com\n</code></pre>"},{"location":"lpic2.211.1/#manual-entries-in-sendmailcf","title":"Manual entries in sendmail.cf","text":"<p>m4 As mentioned before this is not the recommended way. Change the m4 files instead and use <code>m4</code> to generate <code>sendmail.cf</code>.</p>"},{"location":"lpic2.211.1/#exim","title":"Exim","text":"<p>Exim is a mail transfer agent(MTA) developed at the University of Cambridge for use on Unix systems connected to the Internet. Exim can be installed instead of Sendmail, although the configuration of Exim is quite different. See exim.org for more detailed information.</p> <p>The exim4-config_files man page contains descriptions for each of them. Exim comes with an <code>exim.conf</code> template. Just edit this config file for your environment. The Exim Wiki on GitHub provides additional configuration help, FAQ, etc.</p>"},{"location":"lpic2.211.1/#postfix","title":"Postfix","text":"<p>Postfix is another, widely adopted, MTA. It focusses on speed, ease of administration and security. The author of the software, Wietse Venema, was dependant on long computer calculations during his study. It was during that time that he developed a habit of creating software that would be as fault-free and fault-resistant as possible. Only if he could trust the software to run for two weeks straight without errors, there would be no necessity to sleep on the floor for those two weeks while babysitting it. This coding habit stuck with the author for the years to come. When the Postfix program was first written, it was done with the same habit as those earlier study assignments. This habit then became a coding philosophy. By writing the code in a structured manner, only adding neccessary bits and making sure execution flows as efficient as possible, the resulting software became fast, easy to administer and secure. Today, Postfix is still under active development. Many people have contributed to it, and many still do. Despite this common effort, the original author still assures that only necessary code gets added. And that it is added in a way that does not interfere with the philosophy that has been part of Postfix from the start. This approach, in combination with the way that Postfix consists of various small programs working together instead of one big program, makes Postfix a very attractive alternative to other MTA solutions.</p> <p>At the time of writing Postfix version 3.1 is the latest stable release. Postfix version 3.2 is (still) considered experimental. Experimental Postfix releases can be recognized by their names. These will carry a date in them. An example of an experimental release is the following tarball: <code>postfix-3.2-20161204.tar.gz</code>. Stable Postfix versions only show (major and minor) version numbers without the date at the end. Due to its wide adoption, most Linux distributions offer Postfix. However there is a wide variety in versions being deployed. According to its website http://www.postfix.org, versions prior to Postfix 2.10 are End-Of-Support (EOS). CentOS 6.8 still ships with Postfix 2.6 though. Debian 7 did not get beyond Postfix 2.9. More recent Linux distribution versions like CentOS 7 and Debian 8 ship with Postfix &gt;2.10, while some bleeding edge Linux distribution versions offer Postfix &gt;3.1. There is absolutely no certainty that more recent versions of Postfix will have fewer bugs than older versions of Postfix. It is regarded as a 'best practice' to be aware of which version of Postfix you are exposing to the Internet, while at the same time keeping up to date about known Postfix vulnerabilities. There is no reason to restrict this best practice to Postfix alone though.</p> <p>To address the Postfix objectives that are defined for the LPIC-2 exam, the following will provide some examples. These asume you are using Postfix installed from packages on either a Debian-based or a Red Hat based Linux distribution. There may still be circumstances that require Postfix to be build from source. That subject is beyond the scope of this chapter but the topic in general is covered by LPIC objective 206.1.</p>"},{"location":"lpic2.211.1/#postfix-main.cf","title":"Postfix main.cf file format","text":"<p>The default location for the postfix configuration files is <code>/etc/postfix</code>. Amongst others there are two main ones that determine Postfix behavior: <code>main.cf</code> and <code>master.cf</code>. By default, the main.cf configuration file specifies a subset of all the parameters that control the operation of the Postfix mail system. Parameters not explicitly specified are left at their default values. Refer to the <code>postconf(5)</code> manpage for a full listing of all parameters. The <code>main.cf</code> file contains useful comments as well as references to other documentation sources at the top. On Debian-based systems, the <code>/etc/postfix/main.cf</code> file you encounter may be a stripped-down version. The <code>/usr/share/postfix</code> directory should then contain a <code>main.cf.dist</code> file that is more elaborate. The following line count operation gives an estimate about the differences between the different <code>main.cf</code> files on a Debian-based system:</p> <pre><code>    user@debian:/usr/share/postfix$ wc -l /etc/postfix/main.cf \n    43  /etc/postfix/main.cf\n    user@debian:/usr/share/postfix$ wc -l /usr/share/postfix/main.cf*\n    18  /usr/share/postfix/main.cf.debian\n    665 /usr/share/postfix/main.cf.dist\n     11 /usr/share/postfix/main.cf.tls\n</code></pre> <p>The example above demonstrates that the <code>/usr/share/postfix/main.cf.dist</code> file holds more than 600 lines, whereas the default <code>/etc/postfix/main.cf</code> file only holds 43. Keeping the main.cf file clean and tidy is a good habit. It is also a good habit to use a pager to read through the more elaborate <code>main.cf.dist</code> file on Debian-based systems. Red Hat based systems keep well documented configuration files within the <code>/etc/postfix</code> directory.</p> <p>By default, postfix will only read configuration files from the <code>/etc/postfix</code> directory. Other configuration directories may be specified by using the <code>alternate_config_directories</code> directive in <code>/etc/postfix/main.cf</code>. Red Hat based distributions may have <code>/etc/postfix/dynamicmaps.cf.d</code> and <code>/etc/postfix/postfix-files.d</code> directories. These directories exist to ease the life of the Postfix package creators and should be left alone unless you are really sure about what you are doing.</p> <p>Note The postfix configuration directory <code>/etc/postfix</code> is \"hard-coded\" in compilation. Chapter 4.6 of the following document explains how to change this value when building Postfix from source: Postfix Installation From Source Code</p> <p>The general format of the main.cf file is as follows:</p> <ul> <li> <p>Each logical line is in the form <code>parameter = value</code>. Whitespace     around the \"=\" is ignored, as is whitespace at the end of a logical     line.</p> </li> <li> <p>Empty lines and whitespace-only lines are ignored, as are lines     whose first non-whitespace character is a \"#\".</p> </li> <li> <p>A logical line starts with non-whitespace text. A line that starts     with whitespace continues a logical line.</p> </li> <li> <p>A parameter value may refer to other parameters.</p> </li> <li> <p>When the same parameter is defined multiple times, only the last     instance is remembered.</p> </li> <li> <p>Otherwise, the order of <code>main.cf</code> parameter definitions does not     matter.</p> </li> </ul> <p>Also see Postfix Configuration Parameters as an alternative to the <code>postconf</code> man page. The remainder of that document is a description of all Postfix configuration parameters. Default values are shown after the parameter name in parentheses. These default values can also be looked up with the <code>sudo /usr/sbin/postconf -d</code> command. Beware though, since this command will produce 877 lines of output on a Postfix 3.1 instance. Because it is an administrative command and usually located within <code>/usr/sbin</code>, <code>sudo</code> or a shell with root privileges should be used to invoke this command.</p> <p>One of the \"best practices\" to use with Postfix is to disable the <code>SMTP VRFY</code> command on a publicly accessible mail server. This VeRiFY command can be abused by an attacker to enumerate valid user accounts or email adddresses as follows:</p> <pre><code>    user@mailserver:~$ telnet mailserver 25\n    Trying ::1...\n    Connected to mailserver.\n    Escape character is '^]'.\n    220 localhost ESMTP Postfix (Linux/GNU)\n    EHLO localhost\n    250-localhost\n    250-PIPELINING\n    250-SIZE 10240000\n    250-VRFY\n    250-ETRN\n    250-STARTTLS\n    250-ENHANCEDSTATUSCODES\n    250-8BITMIME\n    250 DSN\n    VRFY root\n    252 2.0.0 root\n    VRFY wodan\n    550 5.1.1 &lt;wodan&gt;: Recipient address rejected: User unknown in local recipient table\n    VRFY postfix\n    252 2.0.0 postfix\n</code></pre> <p>The 200-category response codes expose valid recipients. Just like HTTP servers do, a SMTP server can respond with status codes. It is recommended to be familiar with the most common response codes. This will aid when debugging system performance or issues. It is usually not necessary to know the difference between 220 and 250 at first sight. But the difference between 2xx and 5xx status codes should be noticable and familiar. The VRFY command is enabled on Postfix by default. By enabling or adding the following line to <code>main.cf</code> the VRFY feature is disabled:</p> <pre><code>    disable_vrfy_command = yes\n</code></pre> <p>Let's try the <code>VRFY root</code> command from above again after both having disabled the VRFY command and having reloaded Postfix:</p> <pre><code>    user@mailserver:~$ telnet mailserver 25\n    Trying ::1...\n    Connected to localhost.\n    Escape character is '^]'.\n    220 localhost ESMTP Postfix (Linux/GNU)\n    EHLO localhost\n    250-localhost\n    250-PIPELINING\n    250-SIZE 10240000\n    250-ETRN\n    250-STARTTLS\n    250-ENHANCEDSTATUSCODES\n    250-8BITMIME\n    250 DSN\n    VRFY root\n    502 5.5.1 VRFY command is disabled\n    VRFY wodan\n    502 5.5.1 VRFY command is disabled\n    VRFY postfix\n    502 5.5.1 VRFY command is disabled\n</code></pre> <p>By disabling the possibility to distinguish between valid (2xx) and invalid (5xx) email recipients, the Internet has become a safer place.</p> <p>postfix The Postfix developers recommend to change no more than 2-3 parameters at a time, and test if Postfix still works after every change. After making changes to <code>main.cf</code> you need to reload postfix. Depending on the Linux distribution used, this can be accomplished using one of the following commands using <code>sudo</code> or a shell with root privileges: <code>postfix reload</code> or <code>systemctl restart postfix</code> or even <code>/etc/init.d/postfix reload</code>.</p>"},{"location":"lpic2.211.1/#postfix-mastercf-file-format","title":"Postfix master.cf file format","text":"<p>The Postfix mail system follows a modular approach by implementing a small number of (mostly) client commands that are invoked by users, and by a larger number of services that run in the background. Postfix services are implemented by daemon processes. These run in the background and are controlled by the master process. The <code>master.cf</code> configuration file defines how a client program connects to a service, and what daemon program runs when a service is requested.</p> <p>The general format of the <code>master.cf</code> file is as follows:</p> <ul> <li> <p>Empty lines and whitespace-only lines are ignored, as are lines     whose first non-whitespace character is a \"#\".</p> </li> <li> <p>A logical line starts with non-whitespace text. A line that starts     with whitespace continues a logical line.</p> </li> <li> <p>Each logical line defines a single Postfix service. Each service is     identified by its name and type as described below. When multiple     lines specify the same service name and type, only the last one is     remembered. Otherwise, the order of master.cf service definitions     does not matter.</p> </li> </ul> <p>Each logical line consists of eight fields separated by whitespace. These are described below in the order as they appear in the master.cf file. Where applicable a field of \"-\" requests that the built-in default value be used. For boolean fields specify \"y\" or \"n\" to override the default value.</p> <p>Chroot option (default: Postfix &gt;= 3.0: n, Postfix \\&lt;3.0: y) - Whether or not the service runs chrooted to the mail queue directory (pathname is controlled by the queue_directory configuration variable in de <code>main.cf</code> file).</p>"},{"location":"lpic2.211.1/#postfix-preparations","title":"Postfix preparations","text":"<p>Before postfix can be used, it needs to know:</p> <ul> <li> <p>what domains to receive mail for      (mydestination)</p> </li> <li> <p>which domain name to use for outbound mail     (myorigin)</p> </li> <li> <p>which domain(s) postfix is allowed to relay mail for     (relay_domains)</p> </li> <li> <p>what delivery method to use (relayhost)</p> </li> </ul>"},{"location":"lpic2.211.1/#myorigin","title":"myorigin","text":"<p>The <code>myorigin</code> parameter specifies the domain that appears as the \"From:\" domain in outgoing email. The <code>myorigin</code> option is subject to other options, which define whether the \"From:\" domain gets appended or replaced by the <code>myorigin</code> value. Refer to the <code>main.cf</code> file or <code>postconf</code> man page for details. By default, the <code>myorigin</code> value is defined as <code>$myhostname</code>. Changing the <code>myorigin</code> value to the configured domain name can be done as follows:</p> <pre><code>    myorigin = $mydomain\n</code></pre> <p>The <code>$myhostname</code> or <code>$mydomain</code> are replaced by postfix with the hostname or domain of the server it is running on.</p>"},{"location":"lpic2.211.1/#mydestination","title":"mydestination","text":"<p>Postfix needs to know for which domain(s) it will receive mail. The parameter <code>mydestination</code> is used for this. More than one domain may be specified. The domain names can be separated using whitespace or a comma. Also, a pattern can be used to point to a lookup table (hash, btree, nis, ldap or mysql).</p> <pre><code>    mydestination = $mydomain, localhost.$mydomain, hash:/etc/postfix/moredomains\n</code></pre> <p>Note You have to include <code>$mydomain</code> when the server is used as a mail server for the entire domain.</p>"},{"location":"lpic2.211.1/#relay_domains","title":"relay_domains","text":"<p>The default configuration of postfix will try to deliver incoming mail to authorized destinations only. The <code>relay_domains</code> parameter controls for which domains postfix will accept and forward emails.</p> <pre><code>    relay_domains =     (safe: never forward mail from strangers)\n\n\n    relay_domains = $mydomain (forward mail to my domain and subdomains)\n</code></pre>"},{"location":"lpic2.211.1/#relayhost","title":"relayhost","text":"<p>By default postfix tries to deliver directly to the internet depending on the domain name of the destination address in the mail message. Using the <code>relayhost</code> parameter we can specify to use another SMTP server as relay:</p> <pre><code>    relayhost =\n</code></pre> <p>This is the default, direct delivery to the internet, or using another ISP SMTP server:</p> <pre><code>    relayhost = mail.example.com\n</code></pre>"},{"location":"lpic2.211.1/#logging","title":"Logging","text":"<p>maillog Postfix uses the syslog daemon for its logging. When <code>/etc/syslog.conf</code> is configured like in the example below, Postfix log events are written to <code>/var/log/maillog</code>. Error messages are, in the example below, redirected to the console.</p> <pre><code>    mail.err    /dev/console\n    mail.debug  /var/log/maillog\n</code></pre>"},{"location":"lpic2.211.1/#pflogsumm","title":"pflogsumm","text":"<p>Using <code>egrep '&lt;reject|warning|error|fatal|panic&gt;'                      /var/log/maillog</code> will help you to find any problems postfix encountered. There are also third party utilities like <code>pflogsumm</code> that can generate statistics out of Postfix logging.</p>"},{"location":"lpic2.211.1/#virtual-domains","title":"virtual domains","text":"<p>Generally a postfix server is the final destination for a limited number of domains. But postfix can also be configured to handle mail for additional domains which are different from, for example, the domain in which the postfix server is located. These destinations are called virtual hosts. Using the <code>virtual_alias_domains</code> parameter we can specify for which virtual hosts we wish to receive mail. The format of the parameters is the same as in the samples above. Separate multiple virtual hosts using a space or a comma. Also a link to a (hashed) file on disk is possible:</p> <pre><code>    virtual_alias_domains = example.com, sue.nl, unix.nl\n</code></pre> <p>postmap or when using a hashed file (using the <code>postmap</code> utility):</p> <pre><code>    virtual_alias_domains = hash:/etc/postfix/virtual\n</code></pre> <p>The content of <code>/etc/postfix/virtual</code> can be:</p> <pre><code>    postmaster@example.com  peter\n    info@sue.nl     gerda\n    sales@example.com   petra\n    @example.com        jim\n</code></pre> <p>In the above example peter receives the postmaster\\@example.com email. Gerda receives the info\\@sue.nl email and the sales\\@example.com goes to petra. The last line is a \"catch all\" rule, all email for example.com without a valid destination goes to jim.</p> <p>Note Use <code>postmap /etc/postfix/virtual</code> to create the hashed file and issue a <code>postfix reload</code> afterwards.</p> <p>Sendmail emulation layer commands</p> <p>mailq</p> <p>newaliases Since Sendmail has been the de facto mail delivery standard on Unix-like systems for years, replacements like Postfix have felt compelled to implement sendmail emulation layer commands in order to maintain compatibility with outside programs. That is to say that certain commands that were originally included with the sendmail package are available with Postfix as well.</p> <p>Mailq</p> <ul> <li><code>mailq</code> is available on most systems to check the mail queue. It is     equivalent to <code>sendmail -bp</code>, which works with Postfix too. Its     native alternative is <code>postqueue -p</code>. postqueue</li> </ul> <p>Newaliases</p> <ul> <li><code>newaliases</code> is required to generate a binary aliases file with both     sendmail and postfix. Both employ <code>/etc/aliases</code> as the default     input file.</li> </ul> <p>On Postfix systems <code>man sendmail</code> will provide more details on the \"Postfix to Sendmail compatibility interface\".</p> <p>/var/spool/mail</p> <p>Specifies the default mail drop directory. By default all mail is delivered to the <code>/var/spool/mail/&lt;username&gt;</code> file.</p>"},{"location":"lpic2.211.1/#postfix-tls","title":"Postfix TLS","text":"<p>LPIC objective 208.2 covers HTTP over SSL/TLS. The SMTP protocol is similar to the HTTP protocol in that both protocols use plain text network commands. This comes in handy when debugging, because it allows for command execution through telnet- or netcat-like software. But it does not come in handy when transferring sensitive information across a range of systems. Due to the nature of the SMTP protocol, multiple machines may be involved to transfer an e-mail message from the source to the final destination. And there is no way of excluding the possibility that a message has been altered during transfer. This is where encryption comes in. By using encrypted communication, at least some form of confidentiality and authenticity can be added to SMTP transactions. Just like Apache needs to be set up properly for HTTPS transactions, Postfix needs to be configured for use with TLS as well. Unlike Apache, we leave out the SSL acronym and only refer to TLS for Postfix. The following paragraphs will explain more about TLS-specific Postfix directives and about configuring Postfix for use with TLS.</p> <p>At the time of writing, TLSv1.3 is the latest TLS version. TLSv1.3 has reached DRAFT status, and it will be a matter of time before it hits the streets. There will be some noteworthy changes between TLSv1.2 and TLSv1.3. Up to TLSv1.2, a ciphersuite consisted of an authentication algorithm, an encryption algorithm, a message digest algorithm and a key exchange algorithm. These four algorithms work together and are defined by their acronyms. From TLSv1.3 onward, the ciphersuite will consist of only the encryption and message authentication algorithm.</p> <p>The following paragraphs are ment to assist you in getting Postfix with TLS up and running. Encryption is an ever expanding subject, and it is recommended to take the time to read and understand the available documentation with regard to Postfix and the (proper) use of TLS. Postfix comes with extensive documentation that may be found within the <code>/usr/share/doc/postfix</code> directory (on Debian-based systems, you might have to install the <code>postfix-doc</code> package for completeness as is explained on the bottom of this page). The <code>TLS_README</code> document is definitely worth reading. It can be viewed using a pager like <code>less</code> or first expanded using a utility like <code>zcat</code> if the file is compressed. The <code>TLS_README.txt</code> document is also available on the Postix website http://www.postfix.org.</p> <p>openssl When creating a keypair for use with Apache, it may be preferred to use an encrypted private key. An encrypted key needs to be decrypted using a password before it can be used. OpenSSL will encrypt the private key during creation by default, unless specified otherwise. Postfix requires the private key used for TLS encrypted communication to be unencrypted, in other words without a password. A private key may be stripped from its password by reading, importing and exporting the key with OpenSSL. In the following example though, the <code>-nodes</code> option is used with OpenSSL during creation time of the key. This will prevent OpenSSL from encrypting the private key in the first place.</p> <pre><code>    sudo openssl req -nodes -x509 -newkey rsa:2048 \\\n    -keyout postfixkey.pem -out postfixcert.pem \\\n    -days 356\n</code></pre> <p>The self-signed certificate and private key created with the one-liner above can be used for postfix. Postfix demands the private key file is owned by, and readable only by root. The certificate file may be world-readable. Because the example above uses the RSA algorithm, the following directives are used to refer to these files:</p> <pre><code>    smtpd_tls_cert_file=postfixcert.pem\n    smtpd_tls_key_file=postfixkey.pem\n</code></pre> <p>Note smtpd_tls smtp_tls When declaring these directives, take special care to differentiate between <code>smtpd_tls_</code> directives and <code>smtp_tls</code> directives. The latter are used for client authentication.</p> <p>The certificate file must be in the PEM-format. This is the OpenSSL standard export format, so no additional flags should be required. In the example above, the RSA algorithm is used. Instead of RSA, DSA could also be used as the encryption algorithm. When using the DSA algorithm, the key needs to be generated using the <code>-t dsa</code> option and the directives for the certificate file and key slightly differ from their RSA counterparts:</p> <pre><code>    smtpd_tls_dcert_file=postfixcert.pem\n    smtpd_tls_dkey_file=postfixkey.pem\n</code></pre> <p>ECDSA is another valid encryption algorithm for use with Postfix. But because many mailservers still use OpenSSL 0.9.8 versions that lack the proper ECDSA implementation, the use of ECDSA for Postfix with TLS is currently not recommended. Currently RSA is the recommended encryption algorithm to use with TLS for Postfix. However if you do want to use ECDSA keys, the key must be generated using the <code>-t ecdsa</code> option and the certificate and key files have to be specified using the following directives:</p> <pre><code>    smtpd_tls_eccert_file=postfixcert.pem\n    smtpd_tls_eckey_file=postfixkey.pem\n</code></pre> <p>certificateself-signed CSR CA The OpenSSL example above creates a self-signed certificate. This is a way of getting the Postfix STARTTLS functionality working \"quick and dirty\". But in terms of authenticity, self-signed certificates may not be validated by many public SMTP servers. An alternative is to create a key and CSR, and sign the CSR using your own CA. This is demonstrated in the Apache chapter. By using certificates issued by your own CA, you could let your mailservers validate each other. Yet another option is to create a key and CSR, and have the CSR signed by a public CA. That way, public SMTP servers should be able to validate the certificate offered by your Postfix server. When going this route, it may be necessary to add additional root CA references to complete the certificate chain. Additional root CA files may be configured by using either the <code>smtpd_tls_CAfile</code> or <code>smtpd_tls_CApath</code> directives. The file directive should point to a (you guessed it) file holding the necessary root CA information. When concatenating several certificates in to one file, be aware that the files are read \"bottom to top\". The <code>smtpd_tls_CApath</code> directive should point to a directory holding the necessary file(s).</p> <p>Postfix uses opportunistic encryption by default. This means that a connecting system will try to create an encrypted connection at first. However, if this fails for any reason (say, due to an invalid certificate) then the system will continue to perform all SMTP commands without encryption. This behavior is determined by the value of the <code>smtpd_tls_security_level</code> directive. By changing the value of this directive from <code>may</code> to <code>encrypt</code>, unencrypted sessions are prevented. Be aware though! This directive may prevent the Postfix server from performing any SMTP transactions anymore if TLS sessions cannot be initiated.</p> <p>Note Certificate Authority Despite all the good intentions from various public Certificate Authorities, the Certificate Authority system is kind of flawed by design. After all, ANY Certificate Authority may issue certificates for ANY service on ANY host. The chapter on DNS mentions DANE TLSA records to combat this issue. When DNSSEC has been properly configured and TLSA records are supported, it is recommended to create 301 or 311 TLSA records for a given TLS-capable Postfix server. By shifting the trust from the CA trust store with over 1300 CA root certificates to the authenticity and integrity of DNSSEC, it becomes less of a problem to depend on self-signed certificates. If multiple domains are served on the same Postfix server, it is recommended to publish a digest for every seperate domain (and therefore certificate) in DNS. The <code>smtpd_tls_support_level</code> value can be set to either <code>dane</code> or <code>dane-only</code> to handle TLSA records. Refer to the <code>TLS_README</code> file for details.</p> <p>Directives and options Postfix has been written with many \"what if...\" fall-back scenarios in mind. The result is a very resilient piece of software. Being a result of good coding practices, Postfix uses a number of mechanisms to determine if circumstances are favourable or not. If system resources become scarse, the Postfix system will adapt as is deemed suitable regarding the circumstances. When configuring Postfix to use TLS encryption, there are some directives that deserve additional attention. When configured correctly, directives should complement each others functionality. When configured inconsistently or incorrectly, directives may conflict with each others functionality. It is advised to pay additional attention to directives that are involved when configuring the allowed protocols and cipher suites. Modern Postfix versions exclude the use of SSLv2. Because version upgrades may change the default protocols and allowed cipher suites, there is no harm in configuring these yourself. By declaring the following directives in <code>main.cf</code>, these options will stay constant despite Postfix version upgrades over time.</p> <pre><code>    smtpd_tls_protocols\n    smtpd_tls_mandatory_protocols\n    smtpd_tls_ciphers\n    smtpd_tls_mandatory_ciphers\n    smtpd_tls_exclude_ciphers\n</code></pre> <p>By disabling the <code>aNULL</code> ciphers, use of anonymous ciphers is prevented. The use of anonymous ciphers is one of the fall-back scenarios that helps Postfix in providing availability, at the expense of accountability.</p> <p>As mentioned before, the TLS functionality in Postfix can be configured using the <code>smtpd_tls_security_level</code> directive. According to RFC 2487, this directive should be set to the value <code>may</code>. This will result in Postfix announcing the availability of <code>STARTTLS</code> to connecting clients, without demanding its use. If you want to enforce the use of <code>STARTTLS</code>, the value of <code>smtpd_tls_security_level</code> should be set to <code>encrypt</code> instead. Again, be aware that this may result in degraded server compatibility towards other systems. By setting the directive value to <code>none</code>, the Postfix server will refrain from announcing the <code>STARTTLS</code> method at all. When a connecting system tries to initiate <code>STARTTLS</code>, the Postfix server will reply with a <code>502 5.5.1 Error: command not implemented</code> message.</p> <p>When enabling TLS for Postfix, various additional configuration directives become available. Most directives starting with <code>smtpd_tls_</code> or <code>smtp_tls_</code> are not significant for the working of Postfix unless TLS is enabled. One of these directives is the <code>smtpd_tls_loglevel</code> directive. This directive may be configured by setting a value from <code>0-4</code>. It is not recommended to use a setting above <code>2</code>, except for debugging purposes. A value of <code>0</code> will disable logging of TLS events. A value of <code>1</code> will log a summary message on TLS handshake completion. A value of <code>2</code> will also log levels during TLS negotiation. A value of <code>3</code> will log all of the above plus hex and text dumps of the TLS transaction. A value of <code>4</code> eventually will log all of the above but will not stop dumping after the TLS transaction has been processed. It will continue to dump the entire SMTP transmission after the STARTTLS command. Use with caution!</p> <p>On most Linux distributions, additional documentation regarding Postfix can be found in the <code>/usr/share/doc/postfix</code> directory. On Debian-based systems, this requires installing the <code>postfix-doc</code> package. Without the addition of this package, the contents of that directory will be very shallow.</p> <p>Note postfix-tls tlsmgr tlsproxy Postfix 3.x makes TLS easier by incorperating the <code>postfix-tls</code>. While reading up, you might also want to check out what <code>tlsmgr</code> and <code>tlsproxy</code> do.</p>"},{"location":"lpic2.211.2/","title":"Managing E-Mail Delivery (211.2)","text":""},{"location":"lpic2.211.2/#managing-e-mail-delivery-2112","title":"Managing E-Mail Delivery (211.2)","text":"<p>Candidates should be able to implement client e-mail management software to filter, sort and monitor incoming user email.</p>"},{"location":"lpic2.211.2/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Understanding of Sieve functionality, syntax and operators</p> </li> <li> <p>Use Sieve to filter and sort mail with respect to sender, recipient(s), headers and size</p> </li> <li> <p>Awareness of procmail</p> </li> </ul>"},{"location":"lpic2.211.2/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p>Conditions and comparison operators</p> </li> <li> <p>keep, fileinto, redirect, reject, discard, stop</p> </li> <li> <p>Dovecot vacation extension</p> </li> </ul>"},{"location":"lpic2.211.2/#procmail","title":"Procmail","text":"<p>Procmail is a email filtering utility that may be used for preprocessing and sorting of incoming mail. It can also be used to sort out email from mailinglists, to filter spam and send auto-replies. Procmail configuration is based on a file placed in the user's homedirectory. It is rarely run from the command line (except for testing purposes) but it's an autonomous program which is normally invoked by MTA's (Mail Transport Agent) like Sendmail or Postfix.</p> <p>Procmail follows the following scheme for reading its configuration (it reads both): <code>/etc/procmailrc</code>, <code>~/.procmailrc</code></p> <p>Be careful using the system-wide <code>/etc/procmailrc</code>. It is usually read and processed as root. This fact means that a poorly designed recipe in that file could do serious damage. For instance, a typo could cause Procmail to overwrite an important system binary rather than use that binary to process a message. For this reason, you should keep system-wide Procmail processing to a minimum and instead focus on using <code>~/.procmailrc</code> to process email using individual accounts.</p>"},{"location":"lpic2.211.2/#sieve","title":"Sieve","text":"<p>Dovecot Sieve is a scripting language that may be used to preprocess and sort incoming email. It can also be used to sort out email from mailinglists, to filter spam and send auto-replies. To use sieve it should first be configured on the email servers. In this setup postfix is used to deliver email to the Dovecot local delivery agent. In the file <code>main.cf</code> the mailbox_command option should be configured to use the local delivery agent.</p> <pre><code>    mailbox_command = /usr/lib/dovecot/dovecot-lda -a \"$RECIPIENT\"\n</code></pre> <p>The next step is enabling sieve support in dovecot. In the configuration file <code>15-lda.conf</code> the following options should be configured:</p> <pre><code>    lda_mailbox_autocreate = yes\n\n    lda_mailbox_autosubscribe = yes\n\n    protocol lda {\n      mail_plugins = $mail_plugins sieve\n    }\n</code></pre> <p>The configuration option: lda_mailbox_autocreate enables dovecot to create a mailbox if this action is initiated by a rule in sieve. The option: lda_mailbox_autosubscribe subscribes a user to a specific mailbox if this is initiated by an auto created action for a specific mailbox. The option: mail_plugins enables the sieve scripting module in dovecot. The configuration file <code>90-sieve.conf</code> needs the following adjustments:</p> <pre><code>    plugin {\n        sieve = ~/.dovecot.sieve\n        sieve_dir = ~/sieve\n        sieve_default = /var/lib/dovecot/sieve/default.sieve\n        sieve_global_dir = /var/lib/dovecot/sieve\n    }\n</code></pre> <p>The sieve configuration option is the location where users can save their sieve rules. The sieve_dir configuration option is the directory of a user which can hold multiple sieve scripts. The configuration option sieve_default is used to execute a default sieve script. If a user has a personal sieve configuration file in its home directory then the global configuration file is overruled. The option sieve_global_dir identifies a global directory to contain multiple global sieve scripts. After configuration the services should be restarted with <code>service postfix restart</code> and <code>service dovecot restart</code>.</p>"},{"location":"lpic2.211.2/#sieve-syntax","title":"Sieve syntax","text":"<p>The sieve syntax is easy to understand. It consists of three basic parts: Control, Test and Action commands. The control command controls the flow of the code. They affect how the commands will be carried out. The test command will be used in conjunction with control commands to specify a condition that could lead to an action. The action command will be executed after a condition is evaluated to true. You can also use single-line comments starting with a \"#\" and multi-line comments starting with \"/*\" and ending with \"*/\" to clarify sieve rules. Example:</p> <pre><code>    # comment\n    require [\"extension\"];\n\n    /* This is multi\n       line comment */\n\n    # if -&gt; control command\n    if &lt;condition&gt; { \n       action1; \n       action2;\n       ...\n       stop; #end processing\n</code></pre>"},{"location":"lpic2.211.2/#control-commands","title":"Control commands","text":"<p>The control commands in sieve are the basic <code>if</code>, <code>else</code> and <code>elsif</code> control statements. If the test condition is evaluated to true then the associated action will be executed. In the control statements the following tagged arguments can be used: <code>:contains</code>, <code>:is</code>, <code>:matches</code>, <code>:over</code>, and <code>:under</code> as shown in the upcoming sieve examples. The <code>require</code> control command is used to declare optional extensions at the beginning of a script (e.g. fileinto) and the <code>stop</code> command ends all processing of the script. Example:</p> <pre><code>    require \"fileinto\";\n    if header :contains \"from\" \"lottery\" {\n        discard;\n    } elsif header :contains [\"subject\"] [\"$$$\"] {\n        discard;\n    } else {\n        fileinto \"INBOX\";\n    }\n</code></pre> <p>Example:</p> <pre><code>    if header :contains \"subject\" \"money\" { \n       discard; \n       stop; \n    }\n</code></pre>"},{"location":"lpic2.211.2/#test-commands","title":"Test commands","text":"<p>The control commands as stated in the previous section can support different test commands, namely: <code>address</code>, <code>allof</code>, <code>anyof</code>, <code>exists</code>, <code>false</code>, <code>header</code>, <code>not</code>, <code>size</code> and <code>true</code>.</p> <p>With the <code>address</code> command you can only test if an email address is in the header. If the <code>to</code> header contains \"John Doe \\&lt;john\\@doe.com&gt;\", then the test would evaluate to false. If the <code>to</code> address contains \"john\\@doe.com\" then the test would be true because only the address is evaluated. Example:</p> <pre><code>    require \"fileinto\";\n\n    if address :is \"to\" \"john@doe.com\" {\n       fileinto \"john\";\n    }\n</code></pre> <p>The <code>allof</code> command is a logical \"AND\" meaning all conditions should be evaluated to true for further action. Example:</p> <pre><code>    if allof (header :contains \"from\" \"Bofh\", header :contains \"to\" \"abuse\")\n    {\n        fileinto \"spam\";\n    }\n</code></pre> <p>The <code>anyof</code> command is a logical \"OR\" meaning ANY condition should be evaluated to true for further action. Example:</p> <pre><code>    if anyof (size :over 1M, header :contains \"subject\" \"big file attached\")\n    {\n        reject \"I don't want messages that claim to have big files.\";\n    }\n</code></pre> <p>The <code>exists</code> command tests if a header exits with the message. All headers must return true for any action being executed. Example:</p> <pre><code>    if exists \"x-custom-header\" \n    {\n        redirect \"admin@example.com\";\n    }\n</code></pre> <p>The <code>false</code> command simply returns false.</p> <p>The <code>header</code> command tests if a header matches the condition set by the argument and evaluates to true. Example:</p> <pre><code>    if header :is [\"subject\"] \"make money fast\" {\n        discard; \n        stop;\n    }\n</code></pre> <p>The <code>not</code> command should be used with another test. This command negates the other test for the action to be taken. The example below means that if the message does NOT contain \"from\" and \"date\" then the discard action will be taken. Example:</p> <pre><code>    if not exists [\"from\", \"date\"] \n    { \n       discard; \n    }\n</code></pre> <p>The <code>size</code> command is used to specify the message size to be higher or lower than a specified value in order to evaluate the condition to true. The command accepts tagged arguments <code>:over</code> and <code>:under</code> and you can use M after the specified value for megabytes, K for kilobytes and no letter for bytes. Example:</p> <pre><code>    if size :over 500K {\n       discard;\n    }\n</code></pre> <p>The <code>true</code> command simply returns true.</p>"},{"location":"lpic2.211.2/#action-commands","title":"Action commands","text":"<p>The action commands are being executed after a test command is evaluated to true or operate on their own. The action commands are: <code>keep</code>, <code>fileinto</code>, <code>redirect</code> and <code>discard</code>. The <code>keep</code> action commands causes the message to be saved in the default location. The <code>fileinto</code> action command is an optional command and can be used by using <code>require \"fileinto\"</code> control command in the beginning of the script. If the test command is evaluated to true then the message is moved into the defined mailbox. Example:</p> <pre><code>    if attachment :matches [\"*.vbs\", \"*.exe\"] {\n        fileinto \"INBOX.suspicious\";\n    }\n</code></pre> <p>The <code>redirect</code> command redirects the message to the address that is specified in the argument without tampering the message. Example:</p> <pre><code>    if exists \"x-virus-found\" {\n        redirect \"admin@example.com\";\n    }\n</code></pre> <p>The <code>discard</code> command causes the message silently deleted without sending any notification or any other message. Example:</p> <pre><code>    if size :over 2M { \n        discard; \n    }\n</code></pre>"},{"location":"lpic2.211.2/#sieve-vacation-extension","title":"Sieve vacation extension","text":"<p>Sieve also offers an auto-responder functionality by using the <code>vacation</code> extension. Below is an example shown that uses the <code>vacation</code> extension.</p> <pre><code>    require [\"fileinto\", \"vacation\"];\n\n    vacation\n        # Reply at most once a day to a same sender\n        :days 1\n        :subject \"Out of office reply\"\n        # List of additional recipient addresses which are included in the auto replying.\n        # If a mail's recipient is not the envelope recipient and it's not on this list,\n        # no vacation reply is sent for it.\n        :addresses [\"j.doe@company.dom\", \"john.doe@company.dom\"]\n    \"I'm out of office, please contact Joan Doe instead.\n    Best regards\n    John Doe\";\n</code></pre> <p>The <code>vacation</code> extension provides several options, namely:</p> <ul> <li> <p><code>:days number</code> - Is used to specify the period where addresses are     kept and not responded to (in days).</p> </li> <li> <p><code>:subject string</code> - Specifies the subject line attached to any     vacation response.</p> </li> <li> <p><code>:from string</code> - Specifies an alternate to use in the From field of     vacation messages.</p> </li> <li> <p><code>:addresses string-list</code> - Specifies additional email addresses to     the recipient.</p> </li> <li> <p><code>:mime</code> - Specifies arbitrary mime content. For example to specify     multiple vacation messages in different languages.</p> </li> <li> <p><code>:handle string</code> - Tells sieve to treat two vacation actions with     different arguments as the same command for response tracking</p> </li> <li> <p>reason: string - The actual message</p> </li> </ul> <p>Example:</p> <pre><code>    require \"vacation\";\n    if header :contains \"subject\" \"lunch\" {\n           vacation :handle \"ran-away\" \"I'm out and can't meet for lunch\";\n    } else {\n           vacation :handle \"ran-away\" \"I'm out\";\n    }\n</code></pre>"},{"location":"lpic2.211.2/#mbox-and-maildir-storage-formats","title":"Mbox and maildir storage formats","text":"<p>Mbox and maildir are email storage formats. Postfix and Dovecot support the two email storage formats where maildir is the recommended format.</p>"},{"location":"lpic2.211.2/#mbox-format","title":"Mbox format","text":"<p>Mbox is the traditional email storage format. In this format there is only one regular text file which serves as the user's mailbox. Typically, the name of this file is <code>/var/spool/mail/&lt;user name&gt;</code>. Mbox locks the mailbox when an operation is performed on the mailbox. After the operation the mailbox is unlocked.</p>"},{"location":"lpic2.211.2/#advantages","title":"Advantages:","text":"<ul> <li> <p>Mbox format is universally supported</p> </li> <li> <p>Appending new email is fast</p> </li> <li> <p>Searching inside single mailbox is fast</p> </li> </ul>"},{"location":"lpic2.211.2/#disadvantages","title":"Disadvantages:","text":"<ul> <li> <p>Mbox is known for locking problems</p> </li> <li> <p>The mbox format is prone to corruption</p> </li> </ul>"},{"location":"lpic2.211.2/#maildir-format","title":"Maildir format","text":"<p>Maildir is the newer email storage format. A directory maildir is created for each email user, typically in the users' home directories. Under this maildir directory by default three more directories exist: new, cur and tmp.</p>"},{"location":"lpic2.211.2/#advantages_1","title":"Advantages:","text":"<ul> <li> <p>Locating, retrieving and deleting a specific email is fast,     particularly when a email folder contains hundreds of messages</p> </li> <li> <p>Minimal to no file locking needed</p> </li> <li> <p>Can be used on a network file system</p> </li> <li> <p>Immune to mailbox corruption (assuming the hardware will not fail)</p> </li> </ul>"},{"location":"lpic2.211.2/#disadvantages_1","title":"Disadvantages:","text":"<ul> <li> <p>Some filesystems may not efficiently handle a large number of small     files</p> </li> <li> <p>Searching text, which requires all email files to be opened is slow</p> </li> </ul>"},{"location":"lpic2.211.2/#recipe-differences-between-mbox-and-maildir-for-procmailrc","title":"Recipe differences between mbox and maildir for procmailrc","text":"<p>Before copying the recipes from this page into your procmailrc file, remember to adapt them to your particular maildir/mbox format, taking into consideration that the name of maildir folders end in \\\"/\\\". You do not need to lock the file when using maildir format (:0 instead of :0:).</p> <p>In mbox the format is:</p> <pre><code>    :0:\n    recipe\n    directory_name\n</code></pre> <p>While in maildir it would be:</p> <pre><code>    :0\n    recipe\n    directory_name/\n</code></pre>"},{"location":"lpic2.211.3/","title":"Managing Mailbox Access (211.3)","text":""},{"location":"lpic2.211.3/#managing-mailbox-access-2113","title":"Managing Mailbox Access (211.3)","text":"<p>Candidates should be aware of Courier email server and be able to install and configure POP and IMAP daemon on a Dovecot server.</p>"},{"location":"lpic2.211.3/#courier","title":"Courier","text":"<p>The Courier mail transfer agent (MTA) is an integrated mail/groupware server based on open commodity protocols, such as ESMTP, IMAP, POP3, LDAP, SSL, and HTTP. Courier provides ESMTP, IMAP, POP3, webmail, and mailing list services within a single, consistent framework. Individual components can be enabled or disabled at will. The Courier mail server now implements basic web-based calendaring and scheduling services integrated in the webmail module.</p> <p>The Courier mail server uses maildirs as its native mail storage format, but it can also deliver mail to legacy mailbox files as well. By default <code>/etc/courier</code> is the sysconfdir. All courier configuration files are stored here. The mail queue can be found at <code>/var/spool/mqueue</code>.</p> <p>Information about the configuration for Courier can be found at: Courier installation.</p>"},{"location":"lpic2.211.3/#dovecot","title":"Dovecot","text":"<p>Dovecot is an open source IMAP and POP3 email server for Linux/UNIX-like systems, written with security primarily in mind. Dovecot claims that it is an excellent choice for both small and large installations.</p> <p>The configuration files of Dovecot can be found in <code>/etc/dovecot/conf.d</code> and we need to configure several parameters: authentication, mailbox location, SSL settings and the configuration as POP3 server.</p>"},{"location":"lpic2.211.3/#authentication","title":"Authentication","text":"<p>Dovecot is capable of using several password database backends like: PAM, BDSAuth, LDAP, passwd, and SQL databases like MySQL, PostgreSQL and SQLite. The most common way is PAM authentication. The PAM configuration is usually located in <code>/etc/pam.d</code>. By default Dovecot uses <code>dovecot</code> as PAM service name.</p> <p>Here is an example of <code>/etc/pam.d/dovecot</code>:</p> <pre><code>                                  #%PAM-1.0\n\n                                  @include common-auth\n                                  @include common-account\n                                  @include common-session\n</code></pre> <p>The method used by clients to send the login credentials to the server, is configured via the mechanisms parameter. The simplest authentication mechanism is PLAIN. The client simply sends the password unencrypted to Dovecot. All clients support the PLAIN mechanism, but obviously there's the problem that anyone listening on the network can steal the password. For that reason (and some others) other mechanisms were implemented.</p> <p>SSL/TLS encryption can be used to secure the PLAIN authentication mechanism, since the password is sent over an encrypted stream. Non-plaintext mechanisms have been designed to be safe to use even without SSL/TLS encryption. Because of how cd /etc/they have been designed, they require access to the plaintext password or their own special hashed version of it. This means that it's impossible to use non-plaintext mechanisms with commonly used DES or MD5 password hashes. With success/failure password databases (e.g. PAM) it's not possible to use non-plaintext mechanisms at all, because they only support verifying a known plaintext password.</p> <p>Dovecot supports the following non-plaintext mechanisms: CRAM-MD5, DIGEST-MD5, SCRAM-SHA1,SCRAM-SHA-256, APOP, NTLM, GSS-SPNEGO, GSSAPI, RPA, ANONYMOUS, OTP and SKEY, OAUTHBEARER, XOATH2 and EXTERNAL. By default only the PLAIN mechanism is enabled. You can change this by modifying <code>10-auth.conf</code>:</p> <pre><code>                                  auth_mechanisms = plain login cram-md5\n</code></pre>"},{"location":"lpic2.211.3/#mailbox-location","title":"Mailbox location","text":"<p>Using the mail_location parameter in <code>10-mail.conf</code> we can configure which mailbox location we want to use:</p> <pre><code>    mail_location = maildir:~/Maildir\n</code></pre> <p>or</p> <pre><code>    mail_location = mbox:~/mail:INBOX=/var/mail/%u\n</code></pre> <p>In this case email is stored in <code>/var/mail/%u</code> where \"%u\" is converted into the username.</p>"},{"location":"lpic2.211.3/#ssl","title":"SSL","text":"<p>Before Dovecot can use SSL, the SSL certificates need to be created and Dovecot must be configured to use them.</p> <p>mkcert.sh Dovecot includes a script <code>/usr/share/dovecot/mkcert.sh</code> to create self-signed SSL certificates:</p> <pre><code>#!/bin/sh\n\n# Generates a self-signed certificate.\n# Edit dovecot-openssl.cnf before running this.\n\numask 077\nOPENSSL=${OPENSSL-openssl}\nSSLDIR=${SSLDIR-/etc/ssl}\nOPENSSLCONFIG=${OPENSSLCONFIG-dovecot-openssl.cnf}\n\nCERTDIR=/etc/dovecot\nKEYDIR=/etc/dovecot/private\n\nCERTFILE=$CERTDIR/dovecot.pem\nKEYFILE=$KEYDIR/dovecot.pem\n\nif [ ! -d $CERTDIR ]; then\n  echo \"$SSLDIR/certs directory doesn't exist\"\n  exit 1\nfi\n\nif [ ! -d $KEYDIR ]; then\n  echo \"$SSLDIR/private directory doesn't exist\"\n  exit 1\nfi\n\nif [ -f $CERTFILE ]; then\n  echo \"$CERTFILE already exists, won't overwrite\"\n  exit 1\nfi\n\nif [ -f $KEYFILE ]; then\n  echo \"$KEYFILE already exists, won't overwrite\"\n  exit 1\nfi\n\n$OPENSSL req -new -x509 -nodes -config $OPENSSLCONFIG -out $CERTFILE -keyout $KEYFILE -days 365 || exit 2\nchmod 0600 $KEYFILE\necho\n$OPENSSL x509 -subject -fingerprint -noout -in $CERTFILE || exit 2\n</code></pre> <p>The important SSL configuration options can be found in the file: <code>10-ssl.conf</code>. To enable encryption of the data in transit between a client and a Dovecot server the following changes should be made.</p> <pre><code>    ssl = required\n</code></pre> <p>This configuration option requires that the client is using SSL/TLS as transport layer mechanism. Authentication attempts without SSL/TLS will cause authentication failures. Another important configuration option to enable SSL/TLS is the configuration of the SSL/TLS key and the SSL/TLS certificate. The certificates in this example are auto generated by the installation of Dovecot.</p> <pre><code>    ssl_cert =\n</code></pre>"},{"location":"lpic2.212.0/","title":"System Security (212)","text":"<p>This topic has a total weight of 14 points and contains the following objectives:</p>"},{"location":"lpic2.212.0/#objective-2121-configuring-a-router-3-points","title":"Objective 212.1; Configuring a router (3 points)","text":"<p>Candidates should be able to configure a system to perform network     address translation (NAT, IP masquerading) and state its     significance in protecting a network. This objective includes     configuring port redirection, managing filter rules and averting     attacks.</p>"},{"location":"lpic2.212.0/#objective-2122-securing-ftp-servers-2-points","title":"Objective 212.2; Securing FTP servers (2 points)","text":"<p>Candidates should be able to configure an FTP server for anonymous     downloads and uploads. This objective includes precautions to be     taken if anonymous uploads are permitted and configuring user     access.</p>"},{"location":"lpic2.212.0/#objective-2123-secure-shell-ssh-4-points","title":"Objective 212.3; Secure shell (SSH) (4 points)","text":"<p>Candidates should be able to configure and secure an SSH daemon.     This objective includes managing keys and configuring SSH for users.     Candidates should also be able to forward an application protocol     over SSH and manage the SSH login.</p>"},{"location":"lpic2.212.0/#objective-2124-security-tasks-3-points","title":"Objective 212.4; Security tasks (3 points)","text":"<p>Candidates should be able to receive security alerts from various     sources, install, configure and run intrusion detection systems and     apply security patches and bugfixes.</p>"},{"location":"lpic2.212.0/#objective-2125-openvpn-2-points","title":"Objective 212.5; OpenVPN (2 points)","text":"<p>Candidates should be able to configure a VPN (Virtual Private     Network) and create secure point-to-point or site-to-site     connections.</p> <p>Sources of information: https://openvpn.net, IPTables, OpenSSH, FTP</p>"},{"location":"lpic2.212.1/","title":"Configuring a router (212.1)","text":""},{"location":"lpic2.212.1/#configuring-a-router-2121","title":"Configuring a router (212.1)","text":"<p>Candidates should be able to configure a system to perform network address translation (NAT, IP masquerading) and state its significance in protecting a network. This objective includes configuring port redirection, managing filter rules and averting attacks.</p>"},{"location":"lpic2.212.1/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Network Address Translation (NAT)</p> </li> <li> <p>iptables configuration files, tools and utilities</p> </li> <li> <p>Tools, commands and utilities to manage routing tables</p> </li> <li> <p>Private address ranges</p> </li> <li> <p>Port redirection and IP forwarding</p> </li> <li> <p>List and write filtering and rules that accept or block datagrams based on source or destination protocol, port and address</p> </li> <li> <p>Save and reload filtering configurations</p> </li> <li> <p>Awareness of ip6tables and filtering</p> </li> </ul>"},{"location":"lpic2.212.1/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>/proc/sys/net/ipv4</code></p> </li> <li> <p><code>/etc/services</code></p> </li> <li> <p><code>iptables</code></p> </li> </ul>"},{"location":"lpic2.212.1/#private-network-addresses","title":"Private Network Addresses","text":"<p>Why do Private Network Addresses exist? It has been common practice to Private Network Addresses assign globally-unique addresses to all hosts that use IP addresses. In order to extend the life of the IPv4 address space, address registries are requiring more justification concerning the need for extra address space than ever before, which makes it harder for organizations to acquire additional address space.</p> <p>Hosts within enterprises that use IP can be partitioned into three categories:</p> <ul> <li> <p>Category 1</p> </li> <li> <p>These hosts do not require access to the hosts of other IPCategory 1     enterprises or on the Internet itself; hosts within this category     may use IP addresses that are unambiguous within an enterprise, but     may be ambiguous between enterprises.</p> </li> <li> <p>Category 2</p> <ul> <li>These are hosts that need access to a limited set of outside IPCategory 2 services (e.g., E-mail, FTP, netnews, remote login), which can be handled by mediating gateways (e.g., application layer gateways). For many hosts in this category, unrestricted external access (provided via IP connectivity) may be unnecessary and even undesirable (for privacy/security reasons). These hosts, the same as category 1 hosts, may use IP addresses that are unambiguous within an enterprise, but may be ambiguous between enterprises.</li> </ul> </li> <li> <p>Category 3</p> <ul> <li>These hosts need network-layer access outside the enterprise IPCategory 3 (provided via IP connectivity); hosts in the last category require IP addresses that are globally unambiguous.</li> </ul> </li> </ul> <p>We will refer to the hosts in the first and second categories as \"private\" and to hosts in the third category as \"public\".</p> <p>Many applications require connectivity only within one enterprise and do not need external (outside the enterprise) connectivity for the majority of internal hosts. In larger enterprises it is often easy to identify a substantial number of hosts using TCP/IP that do not need network-layer connectivity outside the enterprise.</p> <p>The Internet Assigned Numbers Authority (IANA) has reserved the 10/8 172.16/12 192.168/16 following three blocks of the IP address space for private internets:</p> <pre><code>    10.0.0.0        -   10.255.255.255  (10/8 prefix)\n    172.16.0.0      -   172.31.255.255  (172.16/12 prefix)\n    192.168.0.0     -   192.168.255.255 (192.168/16 prefix)\n</code></pre> <p>We will refer to the first block as \"24-bit block\", the second as \"20-bit block\", and to the third as \"16-bit\" block. Note that when no subnetting is used (i.e. in pre- Classless Inter-Domain Routing (CIDR) notation) the first block is nothing but a single class A network number, while the second block is a set of 16 contiguous class B network numbers and third block is a set of 256 contiguous class C network numbers.</p> <p>Even though IPv6 addresses are not likely to run out in the foreseeable future, the need for allocating private addresses has been recognized. RFC4193 describes address block fc00::/7, which is the approximate counterpart of the IPv4 private addresses described above.</p> <p>In addition to private IP addresses, IPv6 re-introduces the concept of link-local addresses, valid only for communications within the network segment (link) or the broadcast domain that the host is connected to. Routers do not forward packets with link-local addresses, because they are not guaranteed to be unique outside their network segment. In IPv4, the network range 169.254.0.0/16 was reserved for interfaces to allocate an IP address to themselves automatically. In practice, finding an IP address in this range on an interface generally means that DHCP allocation has failed, as link-local addressing is not generally used in IPv4 networks.</p> <p>In IPv6 networks, interfaces always allocate a link-local address in addition to potentially other configured or allocated IPv6 addresses. Therefore, IPv6 interfaces usually have more than one address. Link-local address are an integral part of the IPv6 protocol standard to facilitate neighbour discovery (NDP) and allocating globally unique IP addresses using DHCP6. Interfaces configured for IPv6 use part of their MAC address as a means to create a (hopefully) unique link-local address in the fe80::/64 range.</p>"},{"location":"lpic2.212.1/#network-address-translation-nat","title":"Network Address Translation (NAT)","text":"<p>The figure above displays a hypothetical situation which will serve as an example in the following explanation.</p> <p>This section describes Network Address Translation (NAT), which is a technique to rewrite the source or destination address (or sometimes both) of certain IP traffic. It can be used to enable hosts using a private IP address to communicate with hosts using a globally unique IP address. NAT is primarily an IPv4 concept. IPv6 discourages the use of NAT, because its creators believed it causes more problems than it solves. Under certain circumstances beyond the scope of this book, however, a need to rewrite IPv6 addresses may arise.</p> <p>\"The Firm\" has four machines, 1 to 4, which are connected via a network switch and have private IP addresses in the 192.168.x.x range. Machine 4 serves as a router to the Internet and has two network interfaces. One connects the router to The Firm's internal network via the network switch and has a private IP address of 192.168.0.1, while the other connects the router to the Internet and has a valid (dynamic) IP address of 101.102.103.104.</p> <p>Let's say that the user at Machine 2 wishes to look at a web page on Some Host (http://SomeHost.example) with an IP address of 201.202.203.204. To be able to see the web page, Machine 2 must be able to get information from the Internet and thus must be, in some way, connected to the Internet. And indeed, Machine 2 has an indirect connection to the Internet via Machine 4, but how can this work? Machine 2 has a private IP address which is not supported (routed) on the Internet!</p> <p>This is where NAT kicks in. Machine 4, the router, replaces the private IP address of Machine 2 (and also of Machine 1 and 3 if needed) with its own IP address before sending the request to Some Host. Some Host thinks that a machine with IP address 101.102.103.104 asked for the web page and responds by sending the web page to Machine 4.</p> <p>Machine 4 knows that it has replaced the IP address of Machine 2 with its own before sending the request to Some Host so it also knows that the answer it got to the request has to go to Machine 2. Machine 4 accomplishes this by replacing its own IP address in the answer by the IP address of Machine 2.</p> <p>This is in a nutshell how NAT works. For more detailed information consult RFC1631</p>"},{"location":"lpic2.212.1/#the-linux-firewall-an-overview","title":"The Linux firewall, an overview","text":""},{"location":"lpic2.212.1/#implementation","title":"Implementation","text":"<p>The Linux firewall is implemented in the kernel (as of version 2.3.15). The NETFILTER modules implement the packet filtering rules. The user space application <code>iptables</code> is used to configure these rules.</p>"},{"location":"lpic2.212.1/#netfilter-hooks","title":"Netfilter \"hooks\"","text":"<p>As the figure above shows, netfilter supports five different hooks in netfilterhooks the protocol stack. These hooks enable us to examine and modify (if necessary) every packet passing through the kernel.</p> <p></p> <p>NF_ACCEPT</p> <ul> <li>Continue traversal as normal. iptablesNF_ACCEPT</li> </ul> <p>NF_DROP</p> <ul> <li>Drop the packet and do not continue traversal. iptablesNF_DROP</li> </ul> <p>NF_QUEUE</p> <ul> <li>Queue the packet for userspace handling. iptablesNF_QUEUE</li> </ul> <p>NF_REPEAT</p> <ul> <li>Call this hook again. iptablesNF_REPEAT</li> </ul> <p>NF_STOLEN</p> <ul> <li>Take over (absorb) the packet but do not continue traversal.     iptablesNF_STOLEN</li> </ul>"},{"location":"lpic2.212.1/#tables-and-chains","title":"Tables and Chains","text":"<p>By default five chains (the netfilter hooks) and three tables are supported. As the figure below shows, certain chains are only valid for certain tables.</p> <p>| | |CHAIN| | | | |----|----|----|----|----|----|----| | | |PREROUTING|INPUT|FORWARD|OUTPUT|POSTROUTING| |TABLE|MANGLE|V| | |V| | | |NAT|V| | |V|V| | |FILTER| |V|V|V| |</p>"},{"location":"lpic2.212.1/#the-filter-table","title":"The FILTER table","text":"<p>IPTABLESFILTER The FILTER table is used for filtering packets. The filter table contains three chains. The INPUT chain is used for all packets that are intended for the firewall itself. The FORWARD chain is used for all packets that come from outside the firewall and are destined for another machine outside the firewall. These packets must flow through the firewall. The OUTPUT chain is used for all packets generated by the firewall.</p>"},{"location":"lpic2.212.1/#the-nat-table","title":"The NAT table","text":"<p>IPTABLESNAT The NAT table is used for Network Address Translation. The NAT table contains three chains. The PREROUTING chain is the first used to alter incoming packets, before any routing decision has taken place. The OUTPUT chain is used to alter packets generated by the firewall. The POSTROUTING chain is the last chain where packets can be altered as they leave the firewall. Note that traffic flowing through the firewall passes the PREROUTING and POSTROUTING chains, whereas traffic originated by the firewall passes the OUTPUT and POSTROUTING chains.</p>"},{"location":"lpic2.212.1/#the-mangle-table","title":"The MANGLE table","text":"<p>IPTABLESMANGLE The MANGLE table is used to mangle packets. We can change several things but we can't do masquerading or network address translation here. The mangle table contains two chains. The PREROUTING chain is the first chain to alter incoming packets, before any routing decision has taken place. The OUTPUT chain is used to alter packets generated by the firewall.</p>"},{"location":"lpic2.212.1/#connection-tracking-stateful-firewalling","title":"Connection tracking: Stateful Firewalling","text":"<p>IPTABLESstateful Firewalls that are able to do connection tracking are called Stateful Firewall Stateful Firewalls. These firewalls keep track of established connections by memorizing the source and destination addresses and port numbers (so-called 5-tuples) mostly in order to determine valid return traffic. For protocols that do not use port numbers (e.g. ICMP) other properties are maintained. When using a stateful firewall, firewall rules have to be configured for traffic going one way only, as valid return traffic is passed automatically by a catch-all rule.</p> <p>The <code>iptables</code> option used for connection tracking is iptables--state state the <code>--state</code> option.</p> <p>state</p> <ul> <li>This module, when combined with connection tracking, allows access     to the connection tracking state for this packet.</li> </ul> <p>--state state</p> <ul> <li>Where state is a comma-separated list of the connection states to     match. Possible states are: NEW, ESTABLISHED, RELATED, and INVALID.</li> </ul> <pre><code>&lt;!-- --&gt;\n</code></pre> <p><code>ip_conntrack</code></p> <ul> <li>The main connection-tracking code. iptablesip_conntrack     ip_conntrack</li> </ul> <p><code>ip_conntrack_ftp</code></p> <ul> <li>Additional code needed to track ftp connections, both active and     iptablesip_conntrack_ftp ip_conntrack_ftp passive.</li> </ul> <p>The connection tracking modules have hooks into PREROUTING, FORWARD, OUTPUT and POSTROUTING.</p>"},{"location":"lpic2.212.1/#hooks-tables-and-chains-put-together","title":"Hooks, Tables and Chains put together","text":"<p>Putting what we've discussed so far into one picture:</p> <p></p>"},{"location":"lpic2.212.1/#adding-extra-functionality","title":"Adding extra functionality","text":"<p>ACCEPT</p> <ul> <li>Let the packet through. iptablesACCEPT</li> </ul> <p>DROP</p> <ul> <li>Absorb the packet and forget about it. iptablesDROP</li> </ul> <p>QUEUE</p> <ul> <li>Pass the packet to user space. iptablesQUEUE</li> </ul> <p>RETURN``</p> <ul> <li>Stop traversing this chain and resume at the next rule in the     previous calling chain. If the end of a built-in chain is reached or     a rule in a built-in chain with target RETURN matches the packet,     the target specified in the chain policy determines the fate of the     packet. iptablesRETURN</li> </ul> <p>Included in the standard distribution are a number of target extensions for which support in the kernel must be enabled if you wish to use them. Consult the man page of <code>iptables</code> for further details. Most of these targets have options. The extension LOG for instance, has the following five options: \"--log-level\", \"--log-prefix\", \"--log-tcp-sequence\", \"--log-tcp-options\", \"--log-ip-options\". Please consult the man page for details on options per target.</p> <p>LOG</p> <ul> <li>Turn on kernel logging of matching packets. When this option     iptablesLOG is set for a rule, the Linux kernel will print some     information on all matching packets (such as most IP header fields)     via printk().</li> </ul> <p>MARK</p> <ul> <li>This is used to set the netfilter mark value associated with     iptablesMARK the packet. It is only valid in the mangle table.</li> </ul> <p>REJECT</p> <ul> <li>This is used to send back an error packet in response to the     iptablesREJECT matched packet; otherwise, it is equivalent to DROP.     This target is only valid in the INPUT, FORWARD and OUTPUT chains     and user-defined chains which are only called by those chains.</li> </ul> <p>TOS</p> <ul> <li>This is used to set the 8-bit Type of Service field in the IP     iptablesTOS header. It is only valid in the mangle table.</li> </ul> <p>MIRROR</p> <ul> <li>This is an experimental demonstration target which inverts     iptablesMIRROR the source and destination fields in the IP header     and retransmits the packet. It is only valid in the INPUT, FORWARD     and OUTPUT chains and user-defined chains which are only called by     those chains.</li> </ul> <p>SNAT</p> <ul> <li>This target is only valid in the POSTROUTING chain of the     iptablesSNAT SNAT nat table. It specifies that the source address of     the packet should be modified (and all future packets in this     connection will also be mangled), and rules should cease being     examined.</li> </ul> <p>DNAT</p> <ul> <li>This target is only valid in the PREROUTING, OUTPUT and iptablesDNAT     DNAT user-defined chains (which are only called by those chains) of     the nat table. It specifies that the destination address of the     packet should be modified (and all future packets in this connection     will also be mangled), and rules should cease being examined.</li> </ul> <p>MASQUERADE</p> <ul> <li>This target is only valid in the POSTROUTING chain of the     iptablesMASQUERADE nat table. It should only be used with     dynamically assigned IP (dialup) connections: if you have a static     IP address, you should use the SNAT target. Masquerading is     equivalent to specifying a mapping to the IP address of the     interface the packet is going out, but also has the effect that     connections are forgotten when the interface goes down. This is the     correct behaviour when the next dialup is unlikely to have the same     interface address (and hence any established connections are lost     anyway).</li> </ul> <p>REDIRECT</p> <ul> <li>This target is only valid in the PREROUTING, OUTPUT and     iptablesREDIRECT user-defined chains (which are only called by those     chains) of the nat table. It alters the destination IP address to     send the packet to the machine itself (locally-generated packets are     mapped to the 127.0.0.1 address).</li> </ul> <p>tcp</p> <ul> <li>These extensions are loaded if \"--protocol tcp\" is specified,     iptablestcp and no other match is specified.</li> </ul> <p>udp</p> <ul> <li>These extensions are loaded if \"--protocol udp\" is specified,     iptablesudp and no other match is specified.</li> </ul> <p>icmp</p> <ul> <li>This extension is loaded if \"--protocol icmp\" is specified, and     iptablesicmp no other match is specified.</li> </ul> <p>mac</p> <ul> <li>Match source MAC address. It must be of the form iptablesmac     XX:XX:XX:XX:XX:XX. Note that this only makes sense for packets     entering the PREROUTING, FORWARD or INPUT chains for packets coming     from an ethernet device.</li> </ul> <p>limit</p> <ul> <li>This module matches at a limited rate using a token bucket     iptableslimit filter: it can be used in combination with the LOG     target to give limited logging. A rule using this extension will     match until this limit is reached (unless the \"!\" flag is used).</li> </ul> <p>multiport</p> <ul> <li>This module matches a set of source or destination ports. Up to     iptablesmultiport 15 ports can be specified. It can only be used in     conjunction with -p tcp or -p udp.</li> </ul> <p>mark</p> <ul> <li>This module matches the netfilter mark field associated with a     iptablesmark packet (which can be set using the MARK target).</li> </ul> <p>owner</p> <ul> <li>This module attempts to match various characteristics of the     iptablesowner packet creator for locally-generated packets. It is     only valid in the OUTPUT chain, and even then some packets (such as     ICMP responses) may have no owner and hence, never match.</li> </ul> <p>state</p> <ul> <li>This module, when combined with connection tracking, allows     iptablesstate state access to the connection tracking state for this     packet.</li> </ul> <p>unclean</p> <ul> <li>This module takes no options, but attempts to match packets     iptablesunclean which seem malformed or unusual. This is regarded as     experimental.</li> </ul> <p>tos</p> <ul> <li>This module matches the 8 bits of Type of Service field in the     iptablestos IP header (ie. including the precedence bits).</li> </ul>"},{"location":"lpic2.212.1/#iptables-options","title":"<code>iptables</code> options","text":"<p>-t, --table table</p> <ul> <li> <p>Table to manipulate (default: \"filter\"). The tables are as follows:</p> <p>filter</p> <p>:   This is the default table (if no -t option is passed). It     contains the built-in chains INPUT (for packets destined to     local sockets), FORWARD (for packets being routed through the     box), and OUTPUT (for locally-generated packets).</p> <p>nat</p> <p>:   This table is consulted when a packet that creates a new     connection is encountered. It consists of three built-ins:     PREROUTING (for altering packets as soon as they come in),     OUTPUT (for altering locally-generated packets before routing),     and POSTROUTING (for altering packets as they are about to go     out).</p> <p>mangle</p> <p>:   This table is used for specialized packet alteration. Until     kernel 2.4.17 it had two built-in chains: PREROUTING (for     altering incoming packets before routing) and OUTPUT (for     altering locally-generated packets before routing). Since kernel     2.4.18, three other built-in chains are also supported: INPUT     (for packets coming into the box itself), FORWARD (for altering     packets being routed through the box), and POSTROUTING (for     altering packets as they are about to go out).</p> <p>raw</p> <p>:   This table is used mainly for configuring exemptions from     connection tracking in combination with the NOTRACK target. It     registers at the netfilter hooks with higher priority and is     thus called before ip_conntrack, or any other IP tables. It     provides the following built-in chains: PREROUTING (for packets     arriving via any network interface) OUTPUT (for packets     generated by local processes).</p> </li> </ul> <p>-A, --append chain rule-specification</p> <ul> <li>Append one or more rules to the end of the selected chain.</li> </ul> <p>-D, --delete chain rule-specification; -D, --delete chain rulenum</p> <ul> <li>Delete one or more rules from the selected chain. You can use a     rule-specification or a rule number.</li> </ul> <p>-I, --insert chain [rulenum] rule-specification</p> <ul> <li>Insert one or more rules in the selected chain as the given rule     number.</li> </ul> <p>-R, --replace chain rulenum rule-specification</p> <ul> <li>Replace a rule in the selected chain.</li> </ul> <p>-L, --list [chain]</p> <ul> <li>List all rules in the selected chain. This option is often used with     the <code>-n</code> option for numeric output instead of displaying the output     with the host names, network names and service names. This option     also shows the default policy of each chain.</li> </ul> <p>-F, --flush [chain]</p> <ul> <li>Flush the selected chain (all the chains in the table if none is     given).</li> </ul> <p>-P, --policy chain target</p> <ul> <li>Set the policy for packets not matched by any rule in the chain to     the given target. This target can be a user-defined chain or one of     the special values ACCEPT, DROP or REJECT.</li> </ul> <p>-v, --verbose</p> <ul> <li>Verbose output.</li> </ul> <p>--line-numbers</p> <ul> <li>When listing rules, add line numbers to the beginning of each rule,     corresponding to the rule's position in the chain.</li> </ul> <p>-N, --new-chain chain</p> <ul> <li>Create a new user-defined chain by the given name. There must be     no target of that name already.</li> </ul> <p>-X, --delete-chain chain</p> <ul> <li>Delete the optional user-defined chain specified. There must be no     references to the chain. If there are, you must delete or replace     the referring rules befor the chain can be deleted. If no argument     is given, it will attempt to delete every non-builtin chain in the     table!</li> </ul> <p>Every chain has a default policy. This can only be changed when the chain is empty. You can see the default policy using the <code>-L</code> option. Then flush the chain of all its rules using the <code>-F table</code> option. Then set the default policy using the <code>-P</code> option.</p> <pre><code>    iptables -t filter -L\n    iptables -t filter -F INPUT\n    iptables -t filter -P INPUT DROP\n</code></pre> <p>REJECT is not possible as a default policy. If you still want REJECT as an (implied) last rule then add a REJECT rule yourself as the last rule in the chain.</p>"},{"location":"lpic2.212.1/#iptables-parameters","title":"<code>iptables</code> parameters","text":"<p>The following parameters make up a rule specification (as used in the add, delete, insert, replace and append commands).</p> <p>[!] -p, --protocol protocol</p> <ul> <li>The protocol of the rule or of the packet to check. The specified     protocol can be one of tcp, udp, udplite, icmp, esp, ah, sctp or the     special keyword \"all\", or it can be a numeric value representing one     of these protocols. A protocol name from <code>/etc/protocols</code> is also     allowed. A \"!\" argument before the protocol inverts the test. The     number zero is equivalent to all.</li> </ul> <p>[!] -s, --source address [/mask][,...]</p> <ul> <li>Source specification. Address can be either a network name, a     hostname, a network IP address (with /mask), or a plain IP address.     Hostnames will be resolved once only, before the rule is submitted     to the kernel. Please note that specifying any name to be resolved     with a remote query such as DNS is a really bad idea. The mask can     be either a network mask or a plain number, specifying the number of     1's at the left side of the network mask. Thus, a mask of 24 is     equivalent to 255.255.255.0. Multiple addresses can be specified,     but this will expand to multiple rules (when adding with -A), or     will cause multiple rules to be deleted (with -D).</li> </ul> <p>[!] -d, --destination address [/mask][,...]</p> <ul> <li>Destination specification. See also the \"source address\" parameter     above.</li> </ul> <p>-j, --jump target</p> <ul> <li>This specifies the target of the rule; i.e., what to do if the     packet matches it.</li> </ul> <p>[!] -i, --in-interface name</p> <ul> <li>Name of an interface via which a packet was received.</li> </ul> <p>[!] -o, --out-interface name</p> <ul> <li>Name of an interface via which a packet is going to be sent.</li> </ul>"},{"location":"lpic2.212.1/#iptables-match-extensions","title":"<code>iptables</code> match extensions","text":"<p><code>iptables</code> can use extended packet matching modules. These are loaded in two ways: implicitly, when <code>-p</code> or <code>--protocol</code> is specified, or with the <code>-m</code> or <code>-match</code> options, followed by the matching module name. Possible are: addrtype, ah, cluster, comment, connbytes, connlimit, connmark, conntrack, dccp, dscp, ecn, esp, hashlimit, helper, icmp, iprange, length, limit, mac, mark, multiport, owner, physdev, pkttype, policy, quota, ratetest, realm, recent, sctp, set, socket, state, statistic, string, tcp, tcpmss, time, tos, ttl, u32, udp and unclean. A few of them are explained her:</p> <p>-m state</p> <ul> <li> <p>This module, when combined with connection tracking, allows access     to the connection tracking state of this packet.</p> <p>[!] --state state</p> <p>:   Here state is a comma separated list of the connection states to     match. Possible states are INVALID (meaning that the packet     could not be identified for some reason), ESTABLISHED (meaning     that the packet is associated with a connection which has seen     packets in both directions), NEW (meaning that the packet has     started a new connection, or otherwise associated with a     connection which has not seen packets in both directions), and     RELATED (meaning that the packet is starting a new connection,     but is associated with an existing connection, such as an FTP     data transfer, or an ICMP error).</p> </li> </ul> <p>-m time</p> <ul> <li> <p>This matches if the packet arrival time/date is within a given     range. All options are optional, but are ANDed when specified. It     provides the following options:</p> <p>-m time --datestart YYYY [-MM [-DD [T*hh* [:mm [:ss]]]]]</p> <p>:   Only match during the given time, which must be in ISO 8601     \\\"T\\\" notation. The possible time range is 1970-01-01T00:00:00     to 2038-01-19T04:17:07.</p> <p>-m time --datestop YYYY [-MM [-DD [T*hh* [:mm [:ss]]]]]</p> <p>:   Only match during the given time, which must be in ISO 8601     \\\"T\\\" notation. The possible time range is 1970-01-01T00:00:00     to 2038-01-19T04:17:07.</p> </li> </ul> <p>-p udp, --protocol udp</p> <ul> <li> <p>These extensions can be used if \"--protocol udp\" is specified. It     provides the following options:</p> <p>[!] --source-port,--sport port [:port]</p> <p>:   Source port or port range specification.</p> <p>[!] --destination-port,--dport port [:port]</p> <p>:   Destination port or port range specification.</p> </li> </ul> <p>-p tcp, --protocol tcp</p> <ul> <li> <p>These extensions are loaded if \"--protocol tcp\" is specified. It     provides among other things the following options:</p> <p>--source-port, --sport [!] port[:port]</p> <p>:   Source port or port range specification. This can either be a     service name or a port number. An inclusive range can also be     specified, using the format port:port. If the first port is     omitted, \\\"0\\\" is assumed; if the last is omitted, \"65535\" is     assumed. If the second port greater then the first they will be     swapped. The flag --sport is a convenient alias for this     option.</p> <p>--destination-port, --dport [!] port[:port]</p> <p>:   Destination port or port range specification. The flag --dport     is a convenient alias for this option.</p> <p>--tcp-flags [!] mask comp</p> <p>:   Match when the TCP flags are as specified. The first argument is     the flags which we should examine, written as a comma-sepa rated     list, and the second argument is a comma-separated list of flags     which must be set. Flags are: SYN ACK FIN RST URG PSH ALL NONE.     Hence the command iptables -A FORWARD -p tcp --tcp-flags     SYN,ACK,FIN,RST SYN will only match packets with the SYN flag     set, and the ACK, FIN and RST flags unset.</p> <p>[!] --syn</p> <p>:   Only match TCP packets with the SYN bit set and the ACK and RST     bits cleared. Such packets are used to request TCP connection     initiation; for example, blocking such packets coming in an     interface will prevent incoming TCP connections, but outgoing     TCP connections will be unaffected. It is equivalent to     --tcp-flags SYN,RST,ACK SYN. If the \"!\" flag precedes the     \"--syn\", the sense of the option is inverted.</p> </li> </ul>"},{"location":"lpic2.212.1/#the-firms-network-with-iptables","title":"The Firm's network with IPTABLES","text":"<p>The picture below shows The Firm's network and the possible combinations of traffic initiation/destination. We will go through six possible scenario's.</p> <p></p>"},{"location":"lpic2.212.1/#1-traffic-initiated-by-the-firewall-and-destined-for-the-internet","title":"(1) Traffic initiated by the firewall and destined for the Internet","text":"<p>We are running a DNS on the Firewall that needs to be able to consult other DNS servers on the Internet (which use the UDP protocol and listen to port 53). We also want to be able to use <code>ssh</code> (which uses the TCP protocol and port 22) to connect to other systems on the Internet. We are participating in a distributed.net project RC564 (RC5 64 bit cracking) and are running a proxy server on the Firewall (which uses the TCP protocol and port 2064 to communicate with the keyserver). We want to be able to <code>ping</code> hosts on the Internet (the <code>ping</code> command uses the ICMP protocol and message type 8 (echo-request)). The Firewall communicates with the Internet through interface eth1. Taking all this into consideration, the <code>iptables</code> commands needed are:</p> <pre><code>    iptables -t filter -A OUTPUT -o eth1 -p udp  --destination-port dns        \\\n    -m state --state NEW -j ACCEPT  \n    iptables -t filter -A OUTPUT -o eth1 -p tcp  --destination-port ssh        \\\n    -m state --state NEW -j ACCEPT\n    iptables -t filter -A OUTPUT -o eth1 -p tcp  --destination-port 2064       \\\n    -m state --state NEW -j ACCEPT\n    iptables -t filter -A OUTPUT -o eth1 -p icmp --icmp-type echo-request      \\\n    -m state --state NEW -j ACCEPT\n</code></pre> <p>These four <code>iptables</code> commands tell the firewall to allow outgoing connection-initialization packets for DNS, SSH, TCP/2064 and ping.</p>"},{"location":"lpic2.212.1/#2-traffic-initiated-from-the-internet-and-destined-for-the-firewall","title":"(2) Traffic initiated from the Internet and destined for the Firewall","text":"<p>We want to be able to use <code>ssh</code>, which uses the TCP protocol and port 22, to connect to our Firewall from other systems on the Internet. The <code>iptables</code> command needed is:</p> <pre><code>    iptables -t filter -A INPUT  -i eth1 -p tcp --destination-port ssh         \\\n    -m state --state NEW -j ACCEPT\n</code></pre> <p>This <code>iptables</code> command tells the firewall to allow incoming connection initialization packets for SSH.</p>"},{"location":"lpic2.212.1/#3-traffic-initiated-by-the-firewall-and-destined-for-the-internal-network","title":"(3) Traffic initiated by the Firewall and destined for the internal network","text":"<p>We want to be able to use <code>ssh</code>, which uses the TCP protocol and port 22, to connect to one of our internal machines from our Firewall. The <code>iptables</code> command needed is:</p> <pre><code>    iptables -t filter -A OUTPUT -o eth0 -p tcp --destination-port ssh         \\\n    -m state --state NEW -j ACCEPT\n</code></pre> <p>This <code>iptables</code> command tells the Firewall to allow outgoing SSH connection initialization packets destined for a machine on the internal Network.</p>"},{"location":"lpic2.212.1/#4-traffic-initiated-by-the-internal-network-and-destined-for-the-firewall","title":"(4) Traffic initiated by the internal network and destined for the firewall","text":"<p>The machines on the internal network, using the DNS of the firewall, must be able to connect to the firewall using SSH, are processing RC564 keys, must be able to talk to the proxy on the firewall using port 2064 and must be able to ping the firewall for system administrative purposes. The <code>iptables</code> commands needed are:</p> <pre><code>    iptables -t filter -A INPUT  -i eth0 -p udp --destination-port dns         \\\n    -m state --state NEW -j ACCEPT\n    iptables -t filter -A INPUT  -i eth0 -p tcp --destination-port ssh         \\\n    -m state --state NEW -j ACCEPT\n    iptables -t filter -A INPUT  -i eth0 -p tcp --destination-port 2064        \\\n    -m state --state NEW -j ACCEPT\n    iptables -t filter -A INPUT  -i eth0 -p icmp --icmp-type echo-request      \\\n    -m state --state NEW -j ACCEPT\n</code></pre> <p>These four <code>iptables</code> commands tell the firewall to allow incoming connection-initialization packets for DNS, SSH, RC564 cracking and ping.</p>"},{"location":"lpic2.212.1/#5-traffic-initiated-by-the-internal-network-and-destined-for-the-internet","title":"(5) Traffic initiated by the internal network and destined for the Internet","text":"<p>Every connection from a machine on the internal network to a machine on the Internet is allowed. The <code>iptables</code> command needed is:</p> <pre><code>    iptables -t filter -A FORWARD -i eth0 -o eth1 -m state --state NEW -j ACCEPT\n    iptables -t nat -A POSTROUTING -o eth1 -j SNAT --to-source 101.102.103.104\n</code></pre> <p>This <code>iptables</code> command tells the firewall to allow ALL outgoing connection initialization packets.</p>"},{"location":"lpic2.212.1/#6-traffic-initiated-by-the-internet-and-destined-for-the-internal-network","title":"(6) Traffic initiated by the Internet and destined for the internal network","text":"<p>This does not occur because our local network uses private IP addresses that can't be used on the Internet. Our local machines aren't visible from the Internet.</p> <p>What we could do to make one of our machines available from the Internet is to let people connect to a certain port on the firewall and use NAT to redirect them to a port on one of the machines on the internal network.</p> <p>Suppose Machine 2 has a web-server (or some other program) running which listens to port 2345 and people from the Internet must be able to connect to that program. Since The Firm is using private IP addresses for their internal network, Machine 2 is not visible on the Internet. The solution here is to tell Machine 4 that all data from the Internet that is aimed at port 80 should be routed to port 2345 on Machine 2. The <code>iptables</code> commands needed are:</p> <pre><code>    iptables -t nat -A PREROUTING -i eth1 -p tcp --destination-port 80         \\\n    -j DNAT --to-destination 192.168.0.11:2345\n    iptables -t filter -A FORWARD -i eth1 -p tcp --destination-port 2345       \\\n    -m state --state NEW -j ACCEPT\n</code></pre> <p>The first line changes the destination address and port. Since this then becomes traffic aimed at another machine, the traffic must pass the FORWARD filter. The second line sees to it that this traffic will be allowed.</p>"},{"location":"lpic2.212.1/#traffic-as-a-result-of-initiated-traffic","title":"(!) Traffic as a result of initiated traffic","text":"<p>So far, we've only specified that connection initiation traffic is allowed, but that is not enough. We also must allow ESTABLISHED and RELATED traffic.</p> <p>Let's tell the firewall that all ESTABLISHED and RELATED traffic, regardless of type, interface etc. is allowed. We must also allow the initiation of traffic on the firewalls <code>lo</code> interface because otherwise some services, such a caching DNS server, will not work. We need the following <code>iptables</code> commands to realize this:</p> <pre><code>    iptables -t filter -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT\n    iptables -t filter -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT\n    iptables -t filter -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT\n    iptables -t filter -A INPUT   -m state --state NEW -i lo           -j ACCEPT\n</code></pre> <p>Remember that these last rules can't cause a security problem because the packets allowed are a result of the fact that we've accepted the initiation of the connection in the first place.</p>"},{"location":"lpic2.212.1/#all-iptables-commands-put-together","title":"All <code>iptables</code> commands put together","text":"<p>Adding stuff to start with a clean sheet and telling the firewall to masquerade packets from the internal network aimed at the Internet can be accomplished with the following commands:</p> <pre><code>###############################################################################\n# FLUSH ALL RULES IN THE MANGLE, NAT AND FILTER TABLES\n###############################################################################\niptables -t mangle -F\niptables -t nat    -F\niptables -t filter -F\n\n###############################################################################\n# DELETE ALL USER-DEFINED (NOT BUILT-IN) CHAINS IN THE TABLES\n###############################################################################\niptables -t mangle -X\niptables -t nat    -X\niptables -t filter -X\n\n###############################################################################\n# SET ALL POLICIES FOR ALL BUILT-IN CHAINS TO DROP\n###############################################################################\niptables -P INPUT   DROP\niptables -P FORWARD DROP\niptables -P OUTPUT  DROP\n\n###############################################################################\n# (1) TRAFFIC INITIATED BY THE FIREWALL AND DESTINED FOR THE INTERNET\n#     DNS, SSH, RC564, PING\n###############################################################################\n# ALLOW INITIATION BY THE FIREWALL\niptables -t filter -A OUTPUT -o eth1 -p udp  --destination-port dns        \\\n-m state --state NEW -j ACCEPT\niptables -t filter -A OUTPUT -o eth1 -p tcp  --destination-port ssh        \\\n-m state --state NEW -j ACCEPT\niptables -t filter -A OUTPUT -o eth1 -p tcp  --destination-port 2064       \\\n-m state --state NEW -j ACCEPT\niptables -t filter -A OUTPUT -o eth1 -p icmp --icmp-type echo-request      \\\n-m state --state NEW -j ACCEPT\n# ALLOW INCOMING RESPONSES \niptables -t filter -A INPUT  -i eth1                                       \\\n-m state --state ESTABLISHED,RELATED -j ACCEPT\n\n###############################################################################\n# (2) TRAFFIC INITIATED FROM THE INTERNET AND DESTINED FOR THE FIREWALL\n#     SSH\n###############################################################################\n# ALLOW INITIATION\niptables -t filter -A INPUT  -i eth1 -p tcp  --destination-port ssh        \\\n-m state --state NEW -j ACCEPT\n# ALLOW RESPONSE\niptables -t filter -A OUTPUT -o eth1 -p tcp  --destination-port ssh                     \\\n-m state --state ESTABLISHED,RELATED -j ACCEPT\n\n###############################################################################\n# (3) TRAFFIC INITIATED BY THE FIREWALL AND DESTINED FOR THE INTERNAL NETWORK\n#     SSH\n###############################################################################\n# ALLOW INITIATION\niptables -t filter -A OUTPUT -o eth0 -p tcp  --destination-port ssh        \\\n-m state --state NEW -j ACCEPT\n# ALLOW RESPONSE\niptables -t filter -A INPUT  -i eth0 -p tcp  --destination-port ssh        \\\n-m state --state ESTABLISHED,RELATED -j ACCEPT\n\n###############################################################################\n# (4) TRAFFIC INITIATED BY THE INTERNAL NETWORK AND DESTINED FOR THE FIREWALL\n#     DNS, SSH, RC564, PING\n###############################################################################\n# ALLOW INITIATION\niptables -t filter -A INPUT  -i eth0 -p udp  --destination-port dns        \\\n-m state --state NEW -j ACCEPT\niptables -t filter -A INPUT  -i eth0 -p tcp  --destination-port ssh        \\\n-m state --state NEW -j ACCEPT\niptables -t filter -A INPUT  -i eth0 -p tcp  --destination-port 2064       \\\n-m state --state NEW -j ACCEPT\niptables -t filter -A INPUT  -i eth0 -p icmp --icmp-type echo-request      \\\n-m state --state NEW -j ACCEPT\n# ALLOW RESPONSE \niptables -t filter -A OUTPUT -o eth0                                       \\\n-m state --state ESTABLISHED,RELATED -j ACCEPT\n\n###############################################################################\n# (5) TRAFFIC INITIATED BY THE INTERNAL NETWORK AND DESTINED FOR THE OUTSIDE\n#     EVERYTHING WE CAN INITIATE IS ALLOWED\n###############################################################################\n# ALLOW INITIATION OF EVERYTHING\niptables -t filter -A FORWARD -i eth0 -o eth1                              \\\n-m state --state NEW -j ACCEPT\n# ALLOW RECEPTION\niptables -t filter -A FORWARD -i eth1 -o eth0                              \\\n-m state --state ESTABLISHED,RELATED -j ACCEPT\n\n###############################################################################\n# (6) TRAFFIC INITIATED FROM THE INTERNET AND DESTINED FOR THE INTERNAL NETWORK\n#     ALL FORBIDDEN, EXCEPT WEBSERVER FORWARDING TO INTERNAL MACHINE\n###############################################################################\n# ALLOW DESTINATION NAT FROM FIREWALL:80 TO INTERNAL MACHINE:2345\niptables -t nat -A PREROUTING -i eth1 -p tcp --destination-port 80         \\\n-j DNAT --to-destination 192.168.0.11:2345\niptables -t filter -A FORWARD -i eth1 -p tcp --destination-port 2345       \\\n-m state --state NEW -j ACCEPT\n\n###############################################################################\n# (!) TRAFFIC AS A RESULT OF INITIATED TRAFFIC\n#     ALL ALLOWED\n###############################################################################\n# ALLOW ALL PACKETS RESULTING FROM ALLOWED CONNECTIONS\niptables -t filter -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT\niptables -t filter -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT\niptables -t filter -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT\niptables -t filter -A INPUT   -m state --state NEW -i lo           -j ACCEPT\n\n###############################################################################\n# MASQUERADE PACKAGES FROM OUR INTERNAL NETWORK DESTINED FOR THE INTERNET\n# THIS IS SNAT (SOURCE NAT)\n###############################################################################\niptables -t nat    -A POSTROUTING -o eth1 -j SNAT --to-source 101.102.103.104\n\n###############################################################################\n# ENABLE FORWARDING\n###############################################################################\necho 1 &gt; /proc/sys/net/ipv4/ip_forward\n</code></pre>"},{"location":"lpic2.212.1/#saving-and-restoring-firewall-rules","title":"Saving And Restoring Firewall Rules","text":"<p>Firewall rules can be saved and restored easily by using the commands <code>iptables-save</code> (which writes to iptablessave iptablesrestore iptables-save iptables-restore <code>stdout</code>) and <code>iptables-restore</code> (which reads from <code>stdin</code>). Assuming that we use the file <code>fwrules.saved</code> to save and/or restore the rules, the two commands are:</p> <pre><code>    iptables-save &gt; fwrules.saved\n    iptables-restore &lt; fwrules.saved\n</code></pre> <p>These commands can be used to initialize a firewall/routing machine at boottime by putting them into a SysV startup script.</p>"},{"location":"lpic2.212.1/#port-andor-ip-forwarding","title":"Port and/or IP forwarding","text":"<p>In the fifth example of this chapter the client thinks it's connecting directly to the external server. The router in between transparently routes all traffic and performs SOURCE NAT to masquerade the internal (private) addresses. Keyword in this example is transparency. If you need NAT for outgoing traffic to the internet you can use SNAT (specifying the WAN IP address) if you have a static WAN IP address. The kernel's connection tracking keeps track of all the connections when the interface is taken down and brought back up. This is not the case when using MASQUERADE. Using MASQUERADE is a better idea when you have a dynamic WAN IP address because you don't have to specify the used IP address but can specify the used interface. Whatever IP address is on that interface, it is applied to al the outgoing packets.</p> <p>Besides packet filtering, firewalls can also perform port and IP forwarding. In the sixth example (with port forwarding) an outside client will connect to a port on the firewall. To the client the connection will terminate on the firewall, but the firewall knows to what internal server connections on the receiving port should be forwarded. The firwewall will apply DESTINATION NAT to the packets and pass them on.</p> <p>Forwarded traffic can also have SOURCE NAT applied but in most cases this is undesired because this would seriously hamper auditing the connections on the receiving server(s). There is no way of telling the original source address in that case - all traffic seems to originate at the firewall.</p> <p>Situations in which port forwarding is used are (amongst others):</p> <ul> <li> <p>Transparency is unwanted (security or other considerations):</p> <ul> <li>Example: One specific service available through the firewall is     running on multiple internal servers, for instance one for each     customer of our organization. Based on the source address a     decision can be made to which server the traffic has to be     forwarded.</li> </ul> </li> <li> <p>Transparency is impossible (private IP addresses aren't routed on     the internet):</p> <ul> <li> <p>Example 1: If an organisation has only one external public IP     address, but several services that have to be accessible from     the internet running on different servers, these services will     need to be made available to the outside as seemingly     originating from one single IP address.</p> </li> <li> <p>Example 2: One internal server is serving a single service but     listening on different port numbers (for instance to seperate     between customer). Clients will connect to the IANA assigned     service port and based on source IP address the firewall will     forward the traffic to the assigned destination port for that     source address.</p> </li> </ul> </li> <li> <p>Scaling considerations:</p> <ul> <li>Example: If an organisation has only one external public IP     address but several services that have to be accessible from the     internet running on different servers these services will need     to be made available to the outside as seemingly originating     from one single IP address.</li> </ul> </li> </ul> <p>Most often port and/or IP forwarding is used to enable incoming connections from the internet to servers with a private IP address.</p> <p>Port forwarding examples:</p>"},{"location":"lpic2.212.1/#exaample-1","title":"Exaample 1","text":""},{"location":"lpic2.212.1/#example-2","title":"Example 2","text":""},{"location":"lpic2.212.1/#denial-of-service-dos-attacks","title":"Denial of Service (DoS) attacks","text":""},{"location":"lpic2.212.1/#description","title":"Description","text":"<p>DoS attackers abuse the fact that resources on the Internet are DoS Attack limited and that services can be disrupted by taking away (one of) AttacksDoS their resources: storage-capacity, bandwith or processor-capacity. This is often achieved by \"packet flooding\".</p> <p>Packet flooding can be done with TCP, ICMP and UDP. DoS AttacksPacket Flooding Packet Flooding When using TCP mostly the SYN, ACK and RST flags are used. DoS AttacksSYN AttacksSYN SYN Attack When using ICMP, the message types echo request and echo reply are used. This is called \"ping-flooding\". When using UDP, the chargen (character generator protocol) and echo UDP services are used.</p> <p>Also, two systems (A and B) can be played out against each other by a third system (C). System C sends packets to system A but changes the source IP address of the packages it sends to the IP address of system B. System A then thinks the packets came from system B and starts sending replies to system B. DoS AttacksIP address spoofing DoS with IP address spoofing This method is called \"DoS with IP address spoofing\".</p> <p>Check the site http://www.cert.org/ for a complete history of DoS and DDoS (Distributed DoS) attacks. And have a look at RFC2827 which describes Network Ingress Filtering, a method to DoS AttacksNetwork Ingress Filtering Network Ingress Filtering RFC2827 prevent IP address spoofing. This doesn't prevent DoS attacks but makes it possible to trace the real IP address of the offender.</p>"},{"location":"lpic2.212.1/#prevention","title":"Prevention","text":"<p>It is impossible to fully prevent DoS attacks without disconnecting from the Internet. What can be done to minimize the effects of DoS and DDoS attacks is to apply some packet filtering and rate limiting rules to the firewall.</p> <p>Using /proc/sys/net/ipv4 (sysctl) to prevent simple DOS attacks</p> <p>DoS Attackssysctl sysctl The kernel documentation describes the following sysctl options to prevent simple DoS attacks:</p> <ul> <li> <p>tcp_max_orphans - INTEGER:</p> <ul> <li>Maximal number of TCP sockets not attached to any user file     handle, held by system. If this number is exceeded orphaned     connections are reset immediately and a warning is printed.</li> </ul> </li> <li> <p>tcp_max_tw_buckets - INTEGER:</p> <ul> <li>Maximal number of timewait sockets held by system     simultaneously. If this number is exceeded time-wait socket is     immediately destroyed and a warning is printed.</li> </ul> </li> <li> <p>rp_filter - INTEGER:</p> <ul> <li> <p>0 - No source validation.</p> </li> <li> <p>1 - Strict mode as defined in RFC3704 Strict Reverse Path: Each     incoming packet is tested against the FIB and if the interface     is not the best reverse path the packet check will fail. By     default failed packets are discarded.</p> </li> <li> <p>2 - Loose mode as defined in RFC3704 Loose Reverse Path: Each     incoming packet's source address is also tested against the FIB     and if the source address is not reachable via any interface the     packet check will fail.</p> </li> </ul> </li> </ul>"},{"location":"lpic2.212.1/#routed","title":"Routed","text":"<p>In an environment that uses dynamic routing, the routed daemon may be used. The routed daemon manages the routing tables in the kernel. The routed daemon only implements the RIP (Routing Information Protocol) protocol. When you wish to dynamically route other types of protocols gated can be used instead. Gated is a vintage routing daemon which supports RIPv2, RIPng, OSPF, OSPF6, BGP4+ and BGP4-.</p> <p>The routed daemon finds interfaces to directly connected hosts and networks that are configured into the system and marked as up. (Mark networks as up using the ifconfig command.) If multiple interfaces are present, the routed daemon assumes that the local host forwards packets between networks. The routed daemon transmits a RIP request packet on each interface, using a broadcast message when the interface supports it.</p> <p>The routed daemon then listens for RIP routing requests and response packets from other hosts. When the routed daemon supplies RIP information to other hosts, it sends RIP update packets every 30 seconds (containing copies of its routing tables) to all directly connected hosts and networks.</p> <p>When the routed daemon receives a Routing Information Protocol (RIP) request packet to supply RIP routing information, the routed daemon generates a reply in the form of a response packet. The response packet is based on the information maintained in the kernel routing tables and contains a list of known routes. Each route is marked with a hop-count metric, which is the number of gateway hops between the source network and the destination network. The metric for each route is relative to the sending host. A metric of 16 or greater is considered infinite or beyond reach.</p>"},{"location":"lpic2.212.1/#when-to-use-routed","title":"When to use routed","text":"<p>If there are multiple possible paths to a certain destination, and you want an alternate route to that destination to be selected automatically (in case the default route to that destination for some reason is unusable) the <code>routed</code> program can do this for you automatically.</p> <p>Tools, commands and utilities to manage routing tables</p>"},{"location":"lpic2.212.1/#route","title":"<code>route</code>","text":"<p><code>route</code> manipulates the kernel's IP routing tables. Its primary use is to set up static routes to specific hosts or networks via an interface after is has been configured with the <code>ifconfig</code> command. (The newest Linux distro's use <code>ip route</code> these days instead of <code>route</code>.)</p> <p>SYNOPSIS (most important opions):</p> <pre><code>    route\n    route [-v] add [-net|-host] target [netmask NM] [gw GW] [metric N] [[dev] If]\n    route [-v] del [-net|-host] target [netmask NM] [gw GW] [metric N] [[dev] If]\n</code></pre> <p><code>route</code> itself, without any parameters, displays the routing table. The <code>-ee</code> option will generate a very long line with all paramaters from the routing table.</p> <p>-v</p> <ul> <li>Select verbose operation.</li> </ul> <p>-net|-host</p> <ul> <li>The target is a network or a host.</li> </ul> <p>netmask Nm</p> <ul> <li>When adding a network route, the netmask to be used.</li> </ul> <p>gw GW</p> <ul> <li>Route packets via a gateway. The specified gateway must be reachable     first.</li> </ul> <p>metric N</p> <ul> <li>Set the metric field in the routing table (used by routing daemons)     to N.</li> </ul> <p>dev If</p> <ul> <li>Force the route to be associated with the specified device. If dev     If is the last option on the command line, the word dev may be     omitted, as it's the default. Otherwise the order of the route     modifiers (metric, netmask, gw, dev) doesn't matter.</li> </ul> <p>Examples:</p> <pre><code>    route add -net 192.168.10.0 netmask 255.255.255.0 dev eth0\n    route add -net 192.168.20.0 netmask 255.255.255.0 gw 192.168.1.10\n    route add default gw 192.168.1.1 eth1\n</code></pre> <p>The output of the kernel routing table is organized in the following columns:</p> <p>Destination</p> <ul> <li>The destination network or destination host.</li> </ul> <p>Gateway</p> <ul> <li>The gateway address or \"*\" if none is set.</li> </ul> <p>Genmask</p> <ul> <li>The netmask for the destination net; \"255.255.255.255\" for a host     destination and \"0.0.0.0\" for the default route.</li> </ul> <p>Flags</p> <ul> <li>Possible flags include: U - Route is up, H - Target is a host, G -     Use gateway, R - Reinstate route for dynamic routing, D -     Dynamically installed by daemon or redirect, M - Modified from     routing daemon or redirect, C - Cache entry, ! - Reject route</li> </ul> <p>Metric</p> <ul> <li>The \"distance\" to the target (usually counted in hops).</li> </ul> <p>Ref</p> <ul> <li>Number of references to this route.</li> </ul> <p>Iface</p> <ul> <li>Interface to which packets for this route will be sent.</li> </ul> <p>Example:</p> <pre><code>    Kernel IP routing table\n    Destination     Gateway         Genmask         Flags Metric Ref    Use Iface\n    192.168.20.0    *               255.255.255.0   U     0      0        0 eth0\n    link-local      *               255.255.0.0     U     1002   0        0 eth0\n    default         192.168.20.1    0.0.0.0         UG    0      0        0 eth0\n</code></pre>"},{"location":"lpic2.212.1/#netstat","title":"<code>netstat</code>","text":"<p>Print network connections, routing tables, interface statistics, masquerade connections, and multicast memberships.</p> <p><code>netstat</code> has a lot of possible options but the most used is the following:</p> <pre><code>    # netstat -rn\n    Kernel IP routing table\n    Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface\n    192.168.20.0    0.0.0.0         255.255.255.0   U         0 0          0 eth0\n    169.254.0.0     0.0.0.0         255.255.0.0     U         0 0          0 eth0\n    0.0.0.0         192.168.20.1    0.0.0.0         UG        0 0          0 eth0\n</code></pre> <p><code>netstat -rn</code> will show also the routing table. The <code>-r</code> option will show the routing table where the <code>-n</code> will prevent resolving IP addresses and networks to names. Please look at the man pages for more interesting options.</p>"},{"location":"lpic2.212.1/#ip6tables","title":"ip6tables","text":"<p>Ip6tables is the ipv6 equivalent of iptables. The syntax is identical to its ipv4 counterpart, except for the use of 128-bit addresses instead of 32-bit addresses.</p> <p>The following example allows ICMPv6:</p> <pre><code>    ip6tables -A INPUT -p icmpv6 -j ACCEPT\n    ip6tables -A OUTPUT -p icmpv6 -j ACCEPT\n</code></pre> <p>Iptables and ip6tables may be used simultanously. Refer to the <code>iptables(8)</code> manpage for detailed information.</p>"},{"location":"lpic2.212.2/","title":"Managing FTP servers (212.2)","text":""},{"location":"lpic2.212.2/#managing-ftp-servers-2122","title":"Managing FTP servers (212.2)","text":"<p>Candidates should be able to configure an FTP server for anonymous downloads and uploads. This objective includes configuring user access, and precautions to be taken if anonymous uploads are permitted.</p>"},{"location":"lpic2.212.2/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>Configuration files, tools and utilities for Pure-FTPd and vsftpd</p> </li> <li> <p>Awareness of ProFTPd</p> </li> <li> <p>Understanding of passive vs. active FTP connections</p> </li> </ul>"},{"location":"lpic2.212.2/#terms-and-utilities","title":"Terms and Utilities","text":"<ul> <li> <p><code>vsftpd.conf</code></p> </li> <li> <p>important Pure-FTPd command line options</p> </li> </ul>"},{"location":"lpic2.212.2/#ftp-connection-modes","title":"FTP connection modes","text":"<p>FTP is a service that uses two ports for communication. Port 21 is used for the command port (also known as control port) and port 20 for the data port. FTP has two modes, active and passive FTP. These modes differ in the way connections are initiated. In active mode the client initates the control connection and the server initiates the data connection. In passive mode the client initiates both connections.</p>"},{"location":"lpic2.212.2/#active-mode","title":"Active mode","text":"<p>In active mode the client starts an FTP session. This is done by initiating a control connection originating on an unprivileged port (&gt;1023) to port 21 on the server. The client sends the server the IP address and port number on which the client will listen for the data connection. Usually this port is the next port above the used control connections port on the client. The server sends an ACK to the clients command port and actively opens a data connection originating on port 20 to the client. The client sends back an ACK on the data connection.</p> <p>Active mode example:</p> <ul> <li> <p>The client opens up a command channel from client port 1050 to     server port 21.</p> </li> <li> <p>The client sends PORT 1051 (1050 + 1) to the server and the server     acknowledges on the command channel.</p> </li> <li> <p>The server opens up a data channel from server port 20 to client     port 1051.</p> </li> <li> <p>The client acknowledges on the data channel.</p> </li> </ul>"},{"location":"lpic2.212.2/#passive-mode","title":"Passive mode","text":"<p>In situations in which the client is behind a firewall and unable to accept incoming TCP connections, passive mode may be used. In passive mode the client starts an FTP session. This is done by initiating a control connection originating on an unprivileged port (&gt;1023) to port 21 on the server. In this mode the client sends a PASV command to the server and receives an IP address and port number in return. The server replies with PORT XXXX where XXXX is the unprivileged port the server listens for the data connection and passively waits for the data connection. The client opens the data connection from the next port above the control connections port to the port specified in the <code>PORT</code> reply on the server. The server sends back an ACK to the client on the data connection.</p> <p>Passive mode example:</p> <ul> <li> <p>Client opens up command channel from client port 1050 to server     port 21.</p> </li> <li> <p>Client sends PASV command to server on command channel.</p> </li> <li> <p>Server sends back (on command channel) PORT 1234 after starting to     listen on that port.</p> </li> <li> <p>Client opens up data channel from client 1050 to server port 1234.</p> </li> <li> <p>Server acknowledges on data channel.</p> </li> </ul>"},{"location":"lpic2.212.2/#enabling-connections-through-a-firewall","title":"Enabling connections through a firewall","text":"<p>To enable passive FTP connections when iptables is used, the \"ip_conntrack_ftp\" module has to be loaded into the firewall and connections with the state \"related\" have to be allowed.</p>"},{"location":"lpic2.212.2/#vsftpd","title":"vsftpd","text":"<p>vsftpd (very secure FTP daemon) is a very popular, versatile, fast and secure FTP server.</p>"},{"location":"lpic2.212.2/#example-minimal-configuration-for-anonymous-up-and-downloads","title":"Example minimal configuration for anonymous up- and downloads","text":"<pre><code># If enabled, vsftpd will run in standalone mode. This means  that\n# vsftpd  must not be run from an inetd of some kind. Instead, the\n# vsftpd executable is run once directly. vsftpd itself will  then\n# take care of listening for and handling incoming connections.\n# Default: NO\nlisten=NO\n\n# Controls whether local logins are permitted or not. If enabled,\n# normal user accounts in /etc/passwd (or wherever your PAM config\n# references) may be used to log in. This must be enable for any\n# non-anonymous login to work, including virtual users.\n# Default: NO\nlocal_enable=YES\n\n# This controls whether any FTP commands which change the filesystem\n# are  allowed  or not. These commands are: STOR, DELE, RNFR,\n# RNTO, MKD, RMD, APPE and SITE.\n# Default: NO\nwrite_enable=YES\n\n# Controls  whether  anonymous  logins  are  permitted  or not. If\n# enabled, both the usernames ftp and anonymous are recognised  as\n# anonymous logins.\n# Default: YES\nanonymous_enable=YES\n\n# This option represents a directory  which  vsftpd  will  try  to\n# change  into  after  an  anonymous  login.  Failure  is silently\n# ignored.\n# Default: (none)\nanon_root=/var/ftp/pub\n\n# If set to YES, anonymous users will be permitted to upload files\n# under  certain  conditions.  For  this  to  work,   the   option\n# write_enable  must be activated, and the anonymous ftp user must\n# have write permission on desired upload locations. This  setting\n# is  also  required for virtual users to upload; by default, virtual \n# users  are  treated   with   anonymous   (i.e.   maximally restricted) privilege.\n# Default: NO\nanon_upload_enable=YES\n\n# When  enabled,  anonymous users will only be allowed to download\n# files which are world readable. This is recognising that the ftp\n# user may own files, especially in the presence of uploads.\n# Default: YES\nanon_world_readable_only=NO\n</code></pre> <p>Create the ftp user:</p> <pre><code>    useradd --home /var/ftp --shell /bin/false ftp\n</code></pre> <p>Create the FTP directory:</p> <pre><code>    mkdir -p --mode 733 /var/ftp/pub/incoming\n</code></pre> <p>Set up inetd to listen for FTP traffic and start vsftpd. Add the following line to <code>/etc/inetd.conf</code>:</p> <pre><code>    ftp   stream    tcp   nowait   root   /usr/sbin/tcpd   /usr/sbin/vsftpd\n</code></pre> <p>Reload the inetd daemon.</p> <p>An online HTML version of the manual page which lists all vsftpd config options can be found at: Manpage of vsftpd.conf.</p> <p>When anonymous users should only be allowed to upload files, e.g., for sending files for analysis to remote support, make sure this directory is read-writable by the owner, root, and writeable but not readable by group members and others. This allows the anonymous user to write into the incoming directory but not to change it.</p>"},{"location":"lpic2.212.2/#pure-ftpd","title":"Pure-FTPd","text":"<p>Pure-FTPd is a highly flexible, secure and fast FTP server.</p>"},{"location":"lpic2.212.2/#configuration","title":"Configuration","text":"<p>Unlike many daemons, Pure-FTPd doesn't read any configuration file (except for LDAP and SQL when used). Instead, it uses command-line options. For convenience a wrapper is provided which reads a configuration file and starts Pure-FTPd with the right command-line options.</p> <p>pure-ftpd Specific configuration options of <code>pure-ftpd</code> can be found at: Pure-FTPd Configuration file.</p>"},{"location":"lpic2.212.2/#important-command-line-options","title":"Important command line options","text":"<p>pure-ftpd If you want to listen for an incoming connection on a non-standard port, just append <code>-S</code> and the port number:</p> <pre><code>    /usr/local/sbin/pure-ftpd -S 42\n</code></pre> <p>If your system has many IP addresses and you want the FTP server to be reachable on only one of these addresses, let's say 192.168.0.42, just use the following command:</p> <pre><code>    /usr/local/sbin/pure-ftpd -S 192.168.0.42,21\n</code></pre> <p>Note</p> <p>The 21 port number could be left away since this is the default port.</p> <p>To limit the number of simultaneous connections use the <code>-c</code> option:</p> <pre><code>    /usr/local/sbin/pure-ftpd -c 50 &amp;\n</code></pre>"},{"location":"lpic2.212.2/#example-minimal-configuration-for-anonymous-up-and-downloads_1","title":"Example minimal configuration for anonymous up- and downloads","text":"<p>Create the ftp user:</p> <pre><code>    useradd --home /var/ftp --shell /bin/false ftp\n</code></pre> <p>Create the ftp directory structure with the correct permissions:</p> <pre><code>    # Set the proper permissions to disable writing\n    mkdir -p --mode 555 /var/ftp\n    mkdir -p --mode 555 /var/ftp/pub\n    # Set the proper permissions to enable writing\n    mkdir -p --mode 755 /var/ftp/pub/incoming\n</code></pre> <p>Change ownership:</p> <pre><code>    chown -R ftp:ftp /var/ftp/\n\n    192552    0 dr-xr-xr-x   3 ftp      ftp            16 Mar 11 11:54 /var/ftp\n    192588    0 dr-xr-xr-x   3 ftp      ftp             8 Mar 11 11:07 /var/ftp/pub\n    192589    0 drwxr-xr-x   2 ftp      ftp             8 Mar 11 11:55 /var/ftp/pub/incoming\n</code></pre> <p>Set up inetd to listen for FTP traffic and start <code>pure-ftpd</code>. Add the following line to <code>/etc/inetd.conf</code>:</p> <pre><code>    ftp   stream   tcp   nowait   root   /usr/sbin/tcpd   /usr/sbin/pure-ftpd -e\n</code></pre> <p>Reload the inetd daemon:</p> <pre><code>    killall -HUP inetd\n</code></pre> <p>or</p> <pre><code>    kill -HUP $(cat /var/run/inetd.pid)\n</code></pre>"},{"location":"lpic2.212.2/#other-ftp-servers","title":"Other FTP servers","text":"<p>There are numerous FTP servers available and in use on Linux systems. Some alternatives to the servers mentioned above are: wu-ftpd and ProFTPd.</p>"},{"location":"lpic2.212.2/#proftpd","title":"ProFTPd","text":"<p>ProFTPd - Professional configurable, secure file transfer protocol server.</p> <pre><code>SYNOPSIS\n    proftpd [ -hlntv ] [ -c config-file ] [ -d debuglevel ] [ -p 0|1 ]\n</code></pre> <p><code>proftpd</code> is the Professional File Transfer Protocol (FTP) server daemon. The server may be invoked by the Internet \"super-server\" <code>inetd(8)</code> each time a connection to the FTP service is made, or alternatively it can be run as a standalone daemon.</p> <p>When <code>proftpd</code> is run in standalone mode and it receives a SIGHUP then it will reread its configuration file. When run in standalone mode without the -n option, the main <code>proftpd</code> daemon writes its process ID to <code>/var/run/run/proftpd.pid</code> to make it easy to know which process to SIGHUP.</p> <p>See the man page of <code>proftpd</code> for detailed information on this ftp server. Detailed information can be found at: The ProFTPd Project.</p>"},{"location":"lpic2.212.3/","title":"Secure shell (SSH) (212.3)","text":""},{"location":"lpic2.212.3/#secure-shell-ssh-2123","title":"Secure shell (SSH) (212.3)","text":"<p>Candidates should be able to configure and secure an SSH daemon. This objective includes managing keys and configuring SSH for users. Candidates should also be able to forward an application protocol over SSH and manage the SSH login.</p>"},{"location":"lpic2.212.3/#key-knowledge-areas","title":"Key Knowledge Areas","text":"<ul> <li> <p>OpenSSH configuration files, tools and utilities</p> </li> <li> <p>Login restrictions for the superuser and the normal users</p> </li> <li> <p>Managing and using server and client keys to login with and without password</p> </li> <li> <p>Usage of multiple connections from multiple hosts to guard against loss of connection to remote host following configuration changes</p> </li> </ul>"},{"location":"lpic2.212.3/#terms-and-utilities","title":"Terms and utilities","text":"<ul> <li> <p><code>ssh</code></p> </li> <li> <p><code>sshd</code></p> </li> <li> <p><code>/etc/ssh/sshd_config</code></p> </li> <li> <p><code>/etc/ssh/</code></p> </li> <li> <p>Private and public key files</p> </li> <li> <p>PermitRootLogin, PubkeyAuthentication, AllowUsers,     PasswordAuthentication, Protocol</p> </li> </ul>"},{"location":"lpic2.212.3/#ssh-client-and-server","title":"SSH client and server","text":"<p><code>ssh</code> is a client program for logging into a remote ssh sshd machine and for executing commands on a remote machine.</p> <p><code>sshd</code> is the server (daemon) program for ssh.</p> <p>Together these two programs replace <code>rlogin</code> and <code>rsh</code>, providing secure encrypted communications between two untrusted hosts on an insecure network.</p> <p>To copy files over an insecure network the <code>scp</code> command can be used. Scp stands for Secure CoPy. It uses <code>ssh</code> for scp data transfer.</p> <p>SSH (Secure SHell) uses digital keys for both data encryption and authentication.</p> <p>Keys and their purpose</p> <p>Two types of keys are used: host and user ones. These will be discussed in the next paragraphs. sshkeys</p>"},{"location":"lpic2.212.3/#host-keys","title":"Host keys","text":"<p>There is a slight difference between the SSH protocol versions 1 and 2 in socalled forward security. sshHost Keys</p> <p>SSH protocol version 1</p> <ul> <li> <p>This version only supports RSA keys. Each node has a host key     (normally 2048 bits) sshprotocol version 1 to identify it. When the     daemon is started, an additional server key (normally 768 bits) is     generated. RSA-key sshRSA It is not stored on disk and recreated     every hour when used.</p> <p>When a client connects, the server daemon responds with its public host and server keys. The client compares the RSA host key against its own database to verify that it has not changed. The client then generates a 256 bit random number. It encrypts this random number using both the host and server keys, and sends the encrypted number to the server. Both sides then use this random number as a key that is used to encrypt all further communications in the session. The rest of the session is encrypted using a conventional cipher, currently Blowfish or 3DES, with 3DES being used by sshBlowfish default. The client selects the encryption algorithm from those offered by the server.</p> </li> </ul> <p>SSH protocol version 2</p> <ul> <li> <p>This protocol version is the default and it supports DSA, ECDSA and     RSA keysssh. Forward security is provided through a Diffie-Hellman     key agreement. This key agreement results in a shared session key.</p> <p>The rest of the session is encrypted using a symmetric cipher, currently 128-bit AES, Blowfish, 3DES, CAST128, Arcfour, 192-bit AES or 256-bit AES. The client selects the encryption algorithm to use from those offered by the server. Additionally, session integrity is provided through a cryptographic message authentication code ( hmac-md5, hmac-sha1, umac-64, umac-128, hmac-ripemd160, hmac-sha2-256 or hmac-sha2-512).</p> </li> </ul> <p>Finally, in both versions of the protocol, the server and the client enter an authentication dialog. The client tries to authenticate itself using host-based authentication, public key authentication, challange-response authentication, or password authentication. If possible, select SSH protocol version 2 as the only one to use.</p>"},{"location":"lpic2.212.3/#user-keys-public-and-private","title":"User keys, public and private","text":"<p><code>ssh</code> implements the RSA authentication mechanism sshUser Keys automatically. The user creates an RSA key pair by running <code>ssh-keygen</code>. This stores the private key in ssh-keygen <code>$HOME/.ssh/id_rsa</code> and the public key in sshid_rsa sshid_rsa.pub <code>$HOME/.ssh/id_rsa.pub</code> in the user's home directory. The user should then copy the id_rsa.pub into the <code>$HOME/.ssh/authorized_keys</code> file in his home sshauthorized_keys directory on the remote machine:</p> <pre><code>    # cat id_rsa.pub &gt;&gt; \u02dc/.ssh/authorized_keys\n</code></pre> <p>The <code>authorized_keys file</code> has only one key per line which can be very long. After this, the user can log in without giving the password. Instead of using rsa, dsa can also be used. The names of the keys reflect the kind of keys you created. Make sure the \u02dc/.ssh directory and the files in it have the proper rights. Use for example 700 on the .ssh directory and 600 on the files in it. If you don't, in some situations you can't login using digital keys.</p>"},{"location":"lpic2.212.3/#configuring-sshd","title":"Configuring <code>sshd</code>","text":"<p>Configuring <code>sshd</code> can be done by using command-line options or by editing the sshconfigure sshd sshsshd_config sshd_config configuration file <code>/etc/ssh/sshd_config</code>.</p> <p>-4</p> <ul> <li>Forces sshd to use IPv4 addresses only.</li> </ul> <p>-6</p> <ul> <li>Forces sshd to use IPv6 addresses only.</li> </ul> <p>-b bits</p> <ul> <li>Specifies the number of bits in the ephemeral protocol version 1     server key (default 1024).</li> </ul> <p>-C connection_spec</p> <ul> <li>Specify the connection parameters to use for the -T extended test     mode.</li> </ul> <p>-D</p> <ul> <li>When this option is specified, <code>sshd</code> will not detach and does not     become a daemon. This allows easy monitoring of sshd.</li> </ul> <p>-d Debug Mode</p> <ul> <li>The server sends verbose debug output to the system log, and does     not put itself in the background.</li> </ul> <p>-e</p> <ul> <li>When this option is specified, sshd will send the output to the     standard error instead of the system log.</li> </ul> <p>-f config_file</p> <ul> <li>Specifies the name of the configuration file. The default is     /etc/ssh/sshd_config. sshd refuses to start if there is no     configuration file.</li> </ul> <p>-g login_grace_time</p> <ul> <li>Gives the grace time for clients to authenticate themselves (default     120 seconds).</li> </ul> <p>-h host_key_file</p> <ul> <li>Specifies a file from which a host key is read.</li> </ul> <p>-i</p> <ul> <li>Specifies that sshd is being run from <code>inetd</code>. sshd is normally not     run from inetd because it needs to generate the server key before it     can respond to the client, and this may take tens of seconds.</li> </ul> <p>-k key_gen_time</p> <ul> <li>Specifies how often the ephemeral protocol version 1 server key is     regenerated (default 3600 seconds, or one hour).</li> </ul> <p>-o option</p> <ul> <li>Can be used to give options in the format used in the configuration     file. This is useful for specifying options for which there is no     separate command-line flag.</li> </ul> <p>-p port</p> <ul> <li>Specifies the port on which the server listens for connections     (default 22). Multiple port options are permitted.</li> </ul> <p>-q</p> <ul> <li>Quiet mode. Nothing is sent to the system log. Normally the     beginning, authentication, and termination of each connection is     logged.</li> </ul> <p>-T</p> <ul> <li>Extended test mode. Check the validity of the configuration file,     output the effective configuration to stdout and then exit.</li> </ul> <p>-t</p> <ul> <li>Test mode. Only check the validity of the configuration file and     sanity of the keys. This is useful for updating sshd reliably as     configuration options may change.</li> </ul> <p>-u len</p> <ul> <li>This option is used to specify the size of the field in the utmp     structure that holds the remote host name.</li> </ul> <p>The sshd configrations file in the <code>/etc/ssh/sshd_config</code> directory can also be used to configure sshd. This file should be writable by root only, but it is recommended (though not necessary) that it is world-readable.</p>"},{"location":"lpic2.212.3/#allow-or-deny-root-logins","title":"Allow or deny root logins","text":"<p>The allowing or denying of root logins is done by setting the keyword PermitRootLogin in the configuration file to the appropriate value. To make it more difficult for someone to gain full access, you shouldn't allow root logins. Without the possibility of remote root access someone who wants to get root access on a remote server has to get access via a regular user first. Which is an additional layer of security.</p> <p>yes</p> <ul> <li>This is the default. When set to yes, root can login using     sshPermitRootLogin <code>ssh</code>.</li> </ul> <p>no</p> <ul> <li>When set to no, root cannot login using <code>ssh</code>.</li> </ul> <p>without-password</p> <ul> <li>This means that password authentication is disabled for root.</li> </ul> <p>forced-commands-only</p> <ul> <li>This means that root can only use <code>ssh</code> to login to the system with     public key authentication and execute the commands that are given on     the command line. The allowed command(s) must be added to the public     key(s) in the <code>~/.ssh/authorized_keys</code> file. For example, if you add     command=\\\"/bin/date\\\" at the beginning of your public key line on     SERVERA, only the date command will be allowed for a login using     that public key. If you execute <code>ssh root@SERVERA</code> then only the     date command will be executed on the remote system. (This may be     useful for taking remote backups even if root login is normally not     allowed.) Please read the man pages for more information.</li> </ul>"},{"location":"lpic2.212.3/#allow-or-deny-non-root-logins","title":"Allow or deny non-root logins","text":"<p>There are a number of keywords that can be used to influence the behaviour of <code>sshd</code> in relation to logins.</p> <p>AllowUsers</p> <ul> <li>This keyword is followed by a list of user names, separated     sshAllowUsers by spaces. Login is allowed only for usernames that     match one of the patterns. You can use \"*\" and \"?\" as wildcards in     the patterns.</li> </ul> <p>DenyUsers</p> <ul> <li>This keyword is followed by a list of user names, separated     sshDenyUsers by spaces. User names that match one of the patterns     cannot login. You can use \"*\" and \"?\" as wildcards in the patterns.</li> </ul> <p>AllowGroups</p> <ul> <li>This keyword is followed by a list of group names, separated     sshAllowGroups by spaces. Login is allowed only for users who are a     member of one or more groups that match one of the patterns. You can     use \"*\" and \"?\" as wildcards in the patterns.</li> </ul> <p>DenyGroups</p> <ul> <li>This keyword is followed by a list of group names, separated     sshDenyGroups by spaces. Login is not allowed for users who are a     member of one or more groups that match one of the patterns. You can     use \"*\" and \"?\" as wildcards in the patterns.</li> </ul> <p>PasswordAuthentication</p> <ul> <li>sshPasswordAuthentication Specifies whether password authentication     is allowed. The default is \\\"yes\\\".</li> </ul> <p>Protocol</p> <ul> <li>sshProtocol Specifies the protocol versions sshd supports. The     possible values are \\\"1\\\" and \\\"2\\\". Multiple versions must be     comma-separated. The default is \\\"2,1\\\". Note that the order of the     protocol list does not indicate preference, because the client     selects among multiple protocol versions offered by the server.     Specifying \\\"2,1\\\" is identical to \\\"1,2\\\". Unless there are serious     arguments for using protocol version \\\"1\\\", only use version \\\"2\\\"     because it is far more secure.</li> </ul> <p>UsePAM</p> <ul> <li>Enables the Pluggable Authentication Modules interface. If set to     \"yes\" it will enable PAM authentication using     ChallengeResponseAuthentication and PasswordAuthentication in     addition to PAM account and session module processing for all     authentication types. The default is \"yes\".</li> </ul> <p>ChallengeResponseAuthentication</p> <ul> <li>Specifies whether challenge-response authentication is allowed     (e.g., via PAM or through authentication styles supported in     login.conf(5)). The default is \"yes\".</li> </ul> <p>If you want to fully disable password based logins, the following <code>sshd_config</code> settings should be set to no:</p> <ul> <li> <p>PasswordAuthentication</p> </li> <li> <p>ChallengeResponseAuthentication</p> </li> <li> <p>UsePAM</p> </li> </ul>"},{"location":"lpic2.212.3/#sqsshenablex","title":"Enabling or disabling X forwarding","text":"<p>This topic stays here to give you some information about this topic but it isn't anymore in the Key Knowledge Areas of lpi.org.</p> <p>There are a number of keywords that can be used to influence the behaviour of <code>sshd</code> in relation to the X Windows sshThe X Window System system.</p> <p>X11Forwarding</p> <ul> <li>X11 forwarding is a mechanism where the program runs on one     sshX11Forwarding machine and the X Windows output is shown on     another machine. The command <code>ssh -X                                 remote</code> will set the <code>DISPLAY</code> in the     server-shell to <code>localhost:num:0</code> which is actually the     tunnel-endpoint which is mapped back to the original <code>DISPLAY</code> in     the client context. This tunnel is secured using ssh. X11Forwarding     can be set to yes or no. The default is no.</li> </ul> <p>X11DisplayOffset</p> <ul> <li>This specifies the first display number that is available for the     X11 forwarding of <code>sshd</code>. This prevents sshX11DisplayOffset <code>sshd</code>     from interfering with real servers. The default is 10.</li> </ul> <p>XAuthLocation</p> <ul> <li>This specifies the fully qualified location of the <code>xauth</code> command.     The default location is sshXAuthLocation <code>/usr/bin/X11/xauth</code>.     <code>xauth</code> is used to edit and display the authorization information     used in connecting to the X server.</li> </ul> <p>If you connect to machine B from machine A using <code>ssh your_account@machineB</code> and start an <code>xterm</code> for instance, the process will run on machine B and the X output will be transferred through the SSH tunnel to machine A. To display the terminal, machine B will connect to the display on localhost that's opened by SSH for X11 Forwarding. SSH will forward the X-connection to X server on machine A where it will be displayed in your local display. Because the X output is seemingly created locally no xhost settings have to be changed to enable displaying the content.</p> <p>To enable X11 forwarding this also has to be enabled on the client side. ForwardX11 has to be set to \\\"yes\\\" in the SSH configuration on the client, or on the command line when initiating the connection.</p>"},{"location":"lpic2.212.3/#passwordless-authentication","title":"Passwordless authentication","text":"<p>Using SSH there are different ways for authentication. One way to do this is by using a public/private keypair for authentication. If public key authentication is enabled users can login without having to use a password. When trying to authenticate with a keypair the user will be asked for the passphrase (or ssh_agent will be queried). Also, passphraseless keys can be used (e.g., for automated sessions).</p> <p>Note on using passphraseless keys: because no passphrase is needed to use a passphraseless key, anyone who has access to the key can use it. This poses a serious security risk. The impact of connections with passphraseless keys should be reduced by allowing these connections only with forced commands and preferably from a limited set of clients, (see man authorized_keys).</p> <p>PubkeyAuthentication</p> <ul> <li>sshPubkeyAuthentication This parameter specifies whether public key     authentication is allowed. The default is \\\"yes\\\". Note that this     option applies to protocol version 2 only.</li> </ul> <p><code>ssh-agent</code></p> <p>This objective was moved to LPIC-1.</p> <p><code>ssh-agent</code> is a program to hold private keys used for sshssh-agent public-key authentication (RSA, DSA). The idea is that <code>ssh-agent</code> is started in the beginning of an X-session or a login session, and all other windows or programs are started as clients to the <code>ssh-agent</code> program. Through the use of environment variables the agent can be located and automatically used when logging in to other machines with <code>ssh</code>.</p>"},{"location":"lpic2.212.3/#enable-agent-forwarding","title":"Enable agent forwarding","text":"<p>sshForwardAgent In <code>ssh_config</code> (system wide or in <code>$HOME/.ssh/config</code>) set ForwardAgent to \\\"yes\\\".</p>"},{"location":"lpic2.212.3/#login-session","title":"Login session","text":"<p>Add the following two lines to your <code>$HOME/.bash_profile</code> file or equivalent sshssh-add (depending on the shell you are using) to be able to login without having to type your password each time:</p> <pre><code>    eval `ssh-agent`\n    ssh-add\n</code></pre> <p>The <code>eval `ssh-agent`</code> sets a number of environment variables. In fact, <code>ssh-agent</code> returns the strings needed to set them and <code>eval</code> sees to it that they get set.</p> <p>The <code>ssh-add</code> command without parameters reads the contents of the file <code>$HOME/.ssh/id_rsa</code> (or id_dsa) which contains the private key, as described earlier. You will be prompted to enter your passphrase, if necessary.</p> <p>When the user logs out from the system, the program <code>ssh-agent</code> must be terminated. To see to it that this happens automatically, add the following line to your <code>.bash_logout</code> file or equivalent, depending on the shell you are using:</p> <pre><code>    ssh-agent -k\n</code></pre> <p>The process id of of the current agent is determined by examining the contents of the environment variable $SSH_AGENT_PID, which has been sshSSH_AGENT_PID set by the <code>eval `ssh-agent`</code> command.</p>"},{"location":"lpic2.212.3/#enabling-x-sessions-with-ssh-agent","title":"Enabling X-sessions with ssh-agent","text":"<p>There are several ways to do this, depending on how X is started and sshX Sessions which display manager you are using.</p> <p>If you start X from the command line with <code>startx</code>, you can type <code>ssh-agent startx</code>, open a terminal window in X and type <code>ssh-add</code>, which will prompt you for the passphrase and load your keys.</p>"},{"location":"lpic2.212.3/#tunneling-an-application-protocol-over-ssh-with-portmapping","title":"Tunneling an application protocol over ssh with portmapping","text":""},{"location":"lpic2.212.3/#description","title":"Description","text":"<p>Using port forwarding, SSH will bind to a port and tunnel all traffic directed at that port through the SSH connection. Traffic is forwarded to the host at the other end of the SSH connection. The remote host may be the server on which the SSH connection terminates, but traffic can also be forwarded to another host. Port forwarding can be configured in both directions: local to remote, but also remote to local.</p> <p>The syntax is:</p> <pre><code>    ssh -R|L [bind_address:]port:host:host_port [user@]hostname [command]\n</code></pre>"},{"location":"lpic2.212.3/#example","title":"Example","text":"<p>As an example (example 1), consider the situation shown in the picture. We are working on MyMachine, and we want to connect to the mysql server on Machine 1. The firewall doesn't allow sql connections. The firewall has port forwarding configured so that incoming traffic on port 22 from the internet will be forwarded to port 22 on Machine1. John is an user on Machine1. </p> <p></p> <p>First open the tunnel by running <code>ssh</code> with the \\\"-L\\\" option:</p> <pre><code>    MyMachine# ssh -L 13306:localhost:3306 john@101.102.103.104\n</code></pre> <p>Then run your application, connecting to the local port that is forwarded by the SSH tunnel:</p> <pre><code>    MyMachine# mysql -P 13306\n</code></pre> <p>You are now connected to the remote MySQL server without the need to enable SQL connections over the network.</p> <p>Another example (example 2) would be where one side of the connection wants/needs to initialize the SSH connection to enable the remote party to connect back through the tunnel. In this simplified example an ssh tunnel is started on Machine1 to machine2 with the <code>-R</code>. Then the sql client on machine2 can connect on localhost:13306 and gets a connection with the mysql server on port 3306 through the SSH tunnel. </p> <p></p> <p>The tunnel will stay open as long as the SSH session is running or as long as there is a tunneled session going through it. This means there are two ways of working with SSH tunneling:</p> <ul> <li> <p>open an SSH session with port forwarding and keep it open for as     long as you need it. This is useful if you want to be able to     reconnect through the tunnel without the need to open a new SSH     session. Useful for connecting to a remote host and initializing a     tunnel in the reversed direction (example 2).</p> </li> <li> <p>open an SSH connection with port forwarding in the background and     keep it open just long enough to be able to initialize the     connection through the tunnel. (\\\"ssh -f -L \\&lt;your:port:definition&gt;     remote_user\\@remote_host sleep 10 ; \\&lt;your application&gt;\\\").</p> </li> </ul>"},{"location":"lpic2.212.4/","title":"Security tasks (212.4)","text":""},{"location":"lpic2.212.4/#security-tasks-2124","title":"Security tasks (212.4)","text":"<p>Candidates should be able to receive security alerts from various sources, install, configure and run intrusion detection systems and apply security patches and bugfixes.</p>"},{"location":"lpic2.212.4/#key-knowledge-areas","title":"Key Knowledge Areas:","text":"<ul> <li> <p>Tools and utilities to scan and test ports on a server</p> </li> <li> <p>Locations and organizations that report security alerts as Bugtraq, CERT, or other sources</p> </li> <li> <p>Tools and utilities to implement an intrusion detection system (IDS)</p> </li> <li> <p>Awareness of OpenVAS and Snort</p> </li> </ul>"},{"location":"lpic2.212.4/#terms-and-utilities","title":"Terms and utilities:","text":"<ul> <li> <p><code>telnet</code></p> </li> <li> <p><code>nmap</code></p> </li> <li> <p><code>fail2ban</code></p> </li> <li> <p><code>nc</code></p> </li> <li> <p><code>OpenVAS</code></p> </li> <li> <p><code>Snort IDS</code></p> </li> </ul>"},{"location":"lpic2.212.4/#nc-netcat","title":"<code>nc</code> (netcat)","text":""},{"location":"lpic2.212.4/#description","title":"Description","text":"<p>Netcat (nc) is a very versatile network tool. Netcat is a computer networking service for reading from and writing to network connections using TCP or UDP. Netcat is designed to be a dependable \\\"back-end\\\" device that can be used directly or easily driven by other programs and scripts. At the same time, it is a feature-rich network debugging and investigation tool. Netcat's features are numerous; Netcat can, for instance, be used as a proxy or portforwarder. It can use any local source port, or use loose source-routing. It is commonly referred to as the TCP/IP Swiss army knife.</p> <p>Some of the major features of netcat are:</p> <ul> <li> <p>Outbound or inbound connections, TCP or UDP, to or from any ports</p> </li> <li> <p>Full DNS forward/reverse checking, with appropriate warnings</p> </li> <li> <p>Ability to use any local source port</p> </li> <li> <p>Ability to use any locally-configured network source address</p> </li> <li> <p>Built-in port-scanning capabilities, with randomizer</p> </li> <li> <p>Built-in loose source-routing capability</p> </li> <li> <p>Can read command line arguments from standard input</p> </li> <li> <p>Slow-send mode, one line every N seconds</p> </li> <li> <p>Hex dump of transmitted and received data</p> </li> <li> <p>Optional ability to let another program service establish     connections</p> </li> <li> <p>Optional telnet-options responder</p> </li> </ul> <p>telnet Because netcat does not make any assumptions about the protocol used across the link, it is better suited to debug connections than <code>telnet</code>.</p>"},{"location":"lpic2.212.4/#example-netcat-using-netcat-to-perform-a-port-scan","title":"Example netcat. Using netcat to perform a port scan","text":"<p>With the -z option netcat will perform a portscan on the ports given on the command line. By default netcat will produce no output. When scanning only one port the exit status indicates the result of the scan, but with multiple ports the exit status will allways be \\\"0\\\" if one of the ports is listening. For this reason using the \\\"verbose\\\" option will be useful to see the actual results:</p> <pre><code>    # nc -vz localhost 75-85\n    nc: connect to localhost port 75 (tcp) failed: Connection refused\n    nc: connect to localhost port 76 (tcp) failed: Connection refused\n    nc: connect to localhost port 77 (tcp) failed: Connection refused\n    nc: connect to localhost port 78 (tcp) failed: Connection refused\n    Connection to localhost 79 port [tcp/finger] succeeded!\n    Connection to localhost 80 port [tcp/http] succeeded!\n    nc: connect to localhost port 81 (tcp) failed: Connection refused\n    nc: connect to localhost port 82 (tcp) failed: Connection refused\n    nc: connect to localhost port 83 (tcp) failed: Connection refused\n    nc: connect to localhost port 84 (tcp) failed: Connection refused\n    nc: connect to localhost port 85 (tcp) failed: Connection refused\n</code></pre> <p>The man page of netcat shows some more examples on how to use netcat.</p> <p>Netcat can easily be used in scripts for a lot of tests you want to run automated.</p>"},{"location":"lpic2.212.4/#the-fail2ban-command","title":"The <code>fail2ban</code> command","text":""},{"location":"lpic2.212.4/#description_1","title":"Description","text":"<p><code>Fail2ban</code> scans log files like <code>/var/log/pwdfail</code> or <code>/var/log/apache/error_log</code>, and bans IP addresses that cause too many rejected password attempts. It updates firewall rules to block the IP addresses.</p> <p>Fail2ban's main function is to block IP addresses that belong to hosts that may be trying to breach the system's security. It determines these by monitoring log files (e.g. <code>/var/log/pwdfail</code>, <code>/var/log/auth.log</code>, etc.) and bans any host IP that does too many login attempts or performs any other unwanted action within a time frame set by the administrator. Fail2ban is typically configured to unban a blocked host after a certain period, so as to not \\\"lock out\\\" any genuine connections. An unban time of several minutes is usually sufficient to prevent a network connection from being flooded by malicious attempts, as well as to reduce the likelihood of a successful dictionary attack.</p>"},{"location":"lpic2.212.4/#the-nmap-command","title":"The <code>nmap</code> command","text":""},{"location":"lpic2.212.4/#description_2","title":"Description","text":"<p><code>nmap</code> is a network exploration tool and nmap security scanner. It can be used to scan a network, determine which hosts are up and what services they are offering.</p> <p><code>nmap</code> supports a large number of scanning techniques network scanning nmapnetwork scanning such as: UDP, TCP connect(), TCP SYN (half open), ftp proxy (bounce TCP SYN bounce attack reverse-ident ping sweep ACK sweep Xmas Tree SYN sweep NULL Scan nmapTCP SYN nmapbounce attack nmapreverse-ident nmapping sweep nmapACK sweep nmapXmas Tree nmapSYN sweep nmapNULL Scan attack), Reverse-ident, ICMP (ping sweep), FIN, ACK sweep, Xmas Tree, SYN sweep, IP Protocol and Null scan.</p> <p>If you have built a firewall, and you wish to check that no ports are open nmaptesting a firewall that you do not want open, <code>nmap</code> is the tool to use.</p>"},{"location":"lpic2.212.4/#using-the-nmap-command","title":"Using the <code>nmap</code> command","text":"<p>If a machine gets infected by a rootkit, some system utilities like <code>top</code>, <code>ps</code> and <code>netstat</code> will usually be replaced by the attacker. The modified versions of these commands aide the attacker by not showing all available processes and listening ports. By performing portscans against our host we can explore which ports are open, and compare this with a list of known services. As an example, here's an example of a TCP portscan against our localhost:</p> <pre><code>    $ nmap -sT localhost\n\n    Starting Nmap 6.25 ( http://nmap.org ) at 2020-05-08 11:51 CEST\n    Nmap scan report for localhost (127.0.0.1)\n    Host is up (0.0011s latency).\n    Other addresses for localhost (not scanned): 127.0.0.1\n    Not shown: 993 closed ports\n    PORT     STATE SERVICE\n    22/tcp   open  ssh\n    25/tcp   open  smtp\n    53/tcp   open  domain\n    443/tcp   open  http\n    389/tcp  open  ldap\n\n    Nmap done: 1 IP address (1 host up) scanned in 0.20 seconds\n</code></pre> <p>Note By default, <code>nmap</code> will only scan the 1000 most common ports. Use the <code>-p 1-65535</code> or <code>-p -</code> switch to scan all available ports.</p> <p>Let's perform the same scan, using the UDP protocol:</p> <pre><code>    $ nmap -sU localhost\n    You requested a scan type which requires root privileges.\n    QUITTING!\n</code></pre> <p>Nmap is a very powerful network scanner, but some options require root privileges. If you would perform the command <code>nmap                  localhost</code> both as root and using your own privileges, nmap would use the <code>-sS</code> option as root and the <code>-sT</code> when run with normal user privileges.</p> <p>Now, let's run the UDP scan again using root privileges trough sudo:</p> <pre><code>$ sudo nmap -sU localhost\n\nStarting Nmap 7.60 ( https://nmap.org ) at 2020-05-08 12:42 CEST\nNmap scan report for localhost (127.0.0.1)\nHost is up (0.0000090s latency).\nOther addresses for localhost (not scanned): ::1\nNot shown: 998 closed ports\nPORT     STATE SERVICE\n111/udp  open  rpcbind\n2049/udp open  nfs\n\nNmap done: 1 IP address (1 host up) scanned in 1.62 seconds\n</code></pre> <p>Nmap is a very versatile and powerful tool, and offers a variety of options regarding its capabilities. Nmap can, for example, be used for active TCP/IP stack fingerprinting to determine the remote OS. You need administrator rights to do this:</p> <pre><code>jos@xml:~$ nmap -A lpic2.unix.nl\n\nStarting Nmap 7.60 ( https://nmap.org ) at 2020-05-08 12:46 CEST\nNmap scan report for lpic2.unix.nl (149.210.155.120)\nHost is up (0.011s latency).\nOther addresses for lpic2.unix.nl (not scanned): 2a01:7c8:aab3:101::8080\nrDNS record for 149.210.155.120: 149-210-155-120.colo.transip.net\nNot shown: 995 filtered ports\nPORT     STATE  SERVICE    VERSION\n25/tcp   closed smtp\n80/tcp   closed http\n443/tcp  open   ssl/ssl    Apache httpd (SSL-only mode)\n| http-methods:\n|_  Potentially risky methods: TRACE\n|_http-server-header: Apache/2.4.43 (FreeBSD) OpenSSL/1.1.1d-freebsd\n|_http-title: Maintenance\n| ssl-cert: Subject: commonName=lpic2.unix.nl\n| Subject Alternative Name: DNS:lpic2.unix.nl\n| Not valid before: 2020-05-06T08:18:57\n|_Not valid after:  2020-08-04T08:18:57\n|_ssl-date: TLS randomness does not represent time\n2222/tcp open   ssh        OpenSSH 7.8 (FreeBSD 20180909; protocol 2.0)\n| ssh-hostkey:\n|   2048 98:60:f4:d9:52:42:79:9c:81:bc:04:09:1b:97:3d:d3 (RSA)\n|   256 04:d7:19:2d:c9:81:b4:26:c6:22:46:b0:f8:98:10:c8 (ECDSA)\n|_  256 48:a7:4f:e9:c1:89:d0:67:8e:44:ab:29:a9:70:1c:b7 (EdDSA)\n8080/tcp closed http-proxy\nService Info: OS: FreeBSD; CPE: cpe:/o:freebsd:freebsd\n\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 18.04 seconds\n</code></pre> <p>As you can tell from the output, the tested machine was the machine which host this website.</p> <p>Please consult the manpage of <code>nmap(1)</code> to learn more about its features. nmapoptions</p>"},{"location":"lpic2.212.4/#openvas","title":"OpenVAS","text":"<p>OpenVAS The Open Vulnerability Assessment System (OpenVAS) is an open source framework of several services and tools offering a comprehensive and powerful vulnerability scanning and vulnerability management solution.</p> <p>The actual security scanner is accompanied with a daily updated feed of Network Vulnerability Tests (NVTs), over 50,000 in total (as of May 2020).</p> <p>Detailed information about OpenVAS can be found at: Openvas - Open vulnerability assessment system community site.</p>"},{"location":"lpic2.212.4/#the-snort-ids-intrusion-detection-system","title":"The Snort IDS (Intrusion Detection System)","text":"<p>Snort Snort is an open source network intrusion detection system (NIDS) capable of performing real-time traffic analysis and packet logging on IP networks. It can perform protocol analysis, content searching/matching and can be used to detect a variety of attacks and probes, such as buffer overflows, stealth port scans, CGI attacks, SMB probes, OS fingerprinting attempts and much more. Snort uses a flexible rules language to describe traffic that it should collect or pass, as well as a detection engine that utilizes a modular plugin architecture. Snort has a real-time alerting capability as well, incorporating alerting mechanisms for syslog, a user-specified file, a UNIX socket or WinPopup messages to Windows clients using Samba's smbclient. Snort has three primary uses. It can be used as a straight packet-sniffer like tcpdump, a packet-logger (useful for network traffic debugging, etc), or as a full blown network-intrusion detection system. Snort logs packets in either tcpdump binary format or in Snort's decoded ASCII format to logging directories that are named based on the IP address of the foreign host.</p>"},{"location":"lpic2.212.4/#basic-structure-of-snort-rules","title":"Basic structure of Snort rules","text":"<p>All Snort rules have two logical parts: rule header and rule options.</p> <p>The rule header contains information about what action a rule takes. It also contains criteria for matching a rule against data packets. The options part usually contains an alert message and information about which part of the packet should be used to generate the alert message. The options part contains additional criteria for matching a rule against data packets. A rule may detect one type or multiple types of intrusion activity. Intelligent rules should be able to apply to multiple intrusion signatures.</p>"},{"location":"lpic2.212.4/#structure-of-snort-rule-headers","title":"Structure of Snort rule headers","text":"<p>The action part of the rule determines the type of action taken when criteria are met and a rule is exactly matched against a data packet. Typical actions are generating an alert or log message or invoking another rule. You will learn more about actions later in this chapter.</p> <p>The protocol part is used to apply the rule on packets for a particular protocol only. This is the first criterion mentioned in the rule. Some examples of protocols used are IP, ICMP, UDP etc.</p> <p>The address parts define source and destination addresses. Addresses may be a single host, multiple hosts or network addresses. You can also use these parts to exclude some addresses from a complete network. More about addresses will be discussed later. Note that there are two address fields in the rule. Source and destination addresses are determined based on direction field. As an example, if the direction field is \"-&gt;\", the Address on the left side is source and the Address on the right side is destination.</p> <p>In case of TCP or UDP protocol, the port parts determine the source and destination ports of a packet on which the rule is applied. In case of network layer protocols like IP and ICMP, port numbers have no significance.</p> <p>The direction part of the rule actually determines which address and port number is used as source and which as destination.</p> <p>Just some examples:</p> <pre><code>    alert icmp any any -&gt; any any (msg: \"Ping with TTL=100\";  ttl: 100;)\n    alert udp any 1024:2048 -&gt; any any (msg: \"UDP ports\";)\n    alert tcp 192.168.2.0/24 23 &lt;&gt; any any (content: \"confidential\"; msg: \"Detected confidential\";)\n    log udp any !53 -&gt; any any log udp\n</code></pre> <p>Detailed information about Snort can be found at: Snort IDS.</p>"},{"location":"lpic2.212.4/#intrusion-detection-and-prevention-systems","title":"Intrusion Detection and Prevention Systems","text":"<p>When talking about Intrusion Detection Systems (IDS), we can make a distinction between Host Intrusion Detection Systems (HIDS) and Network Intrusion Detection Systems (NIDS). A HIDS alerts when a host is suffering from suspicious activities. A NIDS usually inspects network traffic, preferably at a low level and alerts if suspicious traffic is detected.</p> <p>Some IDS systems can be configured in a way that they do not only send out an alert, but also prevent access to a certain resource. This resource can either be a TCP/IP or UDP port, a physical port on a network device or complete access to a certain host or network segment trough a router or firewall. Since these systems not only detect, but also prevent they are called Intrusion Prevention Systems (IPS). As well as with IDS systems, we can distinguish HIPS from NIPS systems.</p> <p>Both intrusion detection and intrusion prevention systems use a system of definitions for detection. These definitions describe certain characteristics that when met, trigger off an alert or countermeasure. If a detection takes place and is correct, we call this a true positive. If a detection takes place but is inaccurate, this is called a false positive.. When the system does not detect something that does not occur, this is called a true negative. When there actually is an event which is not detected by the system, this is called a false negative.</p> <p>Often, the detection capabilities of the IDS are expanded by using heuristic detection methods. In order for these to be both effective and accurate, the system needs to be trained. During this period, a lot of false positives may be detected which isn't a bad thing. But the system needs to be tweaked so the amount of false positives will be reduced to a minimum. A false negative is equal to having no IDS in place, and is the most undesirable behavior for an IDS.</p>"},{"location":"lpic2.212.4/#keeping-track-of-security-alerts","title":"Keeping track of security alerts","text":"<p>Security alerts are warnings about vulnerabilities in certain pieces security alerts of software. Those vulnerabilities can result in a decrease of your vulnerability service level because certain individuals are very good at misusing those vulnerabilities. This can result in your system being hacked or blown out of the water.</p> <p>Most of the time there is already a solution for the problem or someone is already working on one, as will be described in the rest of this section.</p>"},{"location":"lpic2.212.4/#sqbugtraq","title":"Bugtraq","text":"<p>BugTraq is a full disclosure moderated mailing-list at securityfocus.com for detailed discussion and announcement of computer security vulnerabilities: what they are, how to exploit them and how to fix security vulnerabilities them.</p>"},{"location":"lpic2.212.4/#bugtraq-website","title":"Bugtraq website","text":"<p>The SecurityFocus website brings together many different resources related to security. One of them is the securityfocus Bugtraq mailing list. There also is a Bugtraq FAQ.</p>"},{"location":"lpic2.212.4/#how-to-subscribe-to-bugtraq","title":"How to subscribe to Bugtraq","text":"<p>Use the webform at http://www.securityfocus.com/ to subscribe to any of the SecurityFocus mailing lists.</p>"},{"location":"lpic2.212.4/#cert","title":"CERT","text":""},{"location":"lpic2.212.4/#description_3","title":"Description","text":"<p>The CERT Coordination Center (CERT/CC) is a center of Internet CERT security expertise, at the Software Engineering Institute, a SEI federally funded research and development center operated by Carnegie Mellon University. They study Internet security Carnegie Mellon vulnerabilities, handle computer security incidents, publish security alerts, research long-term changes in networked systems and develop information and training to help you improve security at your site.</p>"},{"location":"lpic2.212.4/#website","title":"Website","text":"<p>CERT maintains a website called CERThttp://www.cert.org The CERT Coordination Center CERThttp://www.cert.org</p>"},{"location":"lpic2.212.4/#how-to-subscribe-to-the-cert-advisory-mailing-list","title":"How to subscribe to the CERT Advisory mailing list","text":"<p>See the us-cert.gov lists and feed page to sign up for the CERT Advisory mailing list or the RSS feeds issued on diverse NCAS publications.</p>"},{"location":"lpic2.212.4/#ciac","title":"CIAC","text":""},{"location":"lpic2.212.4/#description_4","title":"Description","text":"<p>CIAC is the U.S. Department of Energy's Computer Incident Advisory CIAC Capability. Established in 1989, shortly after the Internet Worm, CIAC provides various computer security services free of charge to employees and contractors of the DOE, such as: Incident Handling consulting, Computer Security Information, On-site Workshops, White-hat Audits.</p>"},{"location":"lpic2.212.4/#website_1","title":"Website","text":"<p>There is a CIAC Website.</p>"},{"location":"lpic2.212.4/#subscribing-to-the-mailing-list","title":"Subscribing to the mailing list","text":"<p>CIAC has several self-subscribing mailing lists for electronic CIACsubscribing publications:</p> <p>CIAC-BULLETIN for Advisories, highest priority - time critical CIACBULLETIN information, and Bulletins, important computer security information.</p> <p>CIAC-NOTES for Notes, a collection of computer security articles. CIACNOTES</p> <p>SPI-ANNOUNCE for official news about Security Profile Inspector CIACSPI-ANNOUNCE (SPI) software updates, new features, distribution and availability.</p> <p>SPI-NOTES, for discussion of problems and solutions regarding the CIACSPI-NOTES use of SPI products.</p> <p>The mailing lists are managed by a public domain software package called ListProcessor, which ignores E-mail header subject lines. To subscribe (add yourself) to one of the mailing lists, send requests of the following form: subscribe list-name LastName, FirstName, PhoneNumber as the E-mail message body, substituting CIAC-BULLETIN, CIAC-NOTES, SPI-ANNOUNCE or SPI-NOTES for \"list-name\" and valid information for \"LastName\" \"FirstName\" and \"PhoneNumber.\" Send to: ciac-listproc\\@llnl.gov. CIAC ciac-listproc\\@llnl.gov</p> <p>You will receive an acknowledgment containing address and initial PIN, and information on how to change either of them, cancel your subscription or get help.</p>"},{"location":"lpic2.212.4/#unsubscribing-from-the-mailing-list","title":"Unsubscribing from the mailing list","text":"<p>To be removed from a CIAC mailing list, send the following request via CIAC unsubscribe E-mail to ciac-listproc\\@llnl.gov: unsubscribe list-name.</p> <p>Testing for open mail relays with telnet</p>"},{"location":"lpic2.212.4/#description_5","title":"Description","text":"<p>An open mail relay is a mail server that accepts SMTP connections open relay from anywhere and will forward emails to any domain. This means that everyone can connect to port 25 on that mail server and send mail to whomever they want. As a result your server's IP might end up on anti-spam blacklists. blacklisting</p>"},{"location":"lpic2.212.4/#testing-for-open-mail-relaying","title":"Testing for open mail relaying","text":"<p>open relay how to testTesting a mail relay can be done by delivering an email for a recipient to a server that's not supposed to do any relaying for the recipients domain. If the server accepts AND delivers the email it is an open relay.</p> <p>In the following example we use <code>telnet</code> to connect to a SMTP server running on port 25:</p> <pre><code>    $ telnet localhost 25\n    Trying ::1...\n    Connected to localhost.\n    Escape character is '^]'.\n    220 linux.mailserver ESMTP Exim 4.80 Wed, 03 Jul 2019 08:08:06 -0500\n    MAIL FROM: bob@example.com\n    250 OK\n    RCPT TO: root@localhost\n    250 Accepted\n    DATA\n    354 Enter message, ending with \".\" on a line by itself\n    Open Mail Relay test message\n    .\n    250 OK id=1UuMnI-0001SM-Pe\n    QUIT\n    221 linux.mailserver closing connection\n    Connection closed by foreign host.\n</code></pre> <p>The message is accepted because the mailserver is configured to accept connections that origin from the local host, and because <code>root@localhost</code> is a valid email address according to the SMTP server.</p> <p>Telnet is not considered very suitable as a remote login protocol because all data is being transmitted in clear text across the network. But the <code>telnet</code> command is very useful for checking open ports. The target port can be given as an argument, as can be seen in the example above.</p>"},{"location":"lpic2.212.5/","title":"OpenVPN (212.5)","text":""},{"location":"lpic2.212.5/#openvpn-2125","title":"OpenVPN (212.5)","text":"<p>Candidates should be able to configure a VPN (Virtual Private Network) and create secure point-to-point or site-to-site connections.</p>"},{"location":"lpic2.212.5/#key-knowledge-areas","title":"Key Knowledge Areas:","text":"<ul> <li>OpenVPN</li> </ul>"},{"location":"lpic2.212.5/#terms-and-utilities","title":"Terms and Utilities:","text":"<ul> <li> <p><code>/etc/openvpn/</code></p> </li> <li> <p><code>openvpn</code></p> </li> </ul>"},{"location":"lpic2.212.5/#openvpn","title":"OpenVPN","text":"<p>OpenVPN is a free and open source software application that implements virtual private network (VPN) techniques for creating secure point-to-point or site-to-site connections in routed or bridged configurations and remote access facilities. It uses SSL/TLS security for encryption and is capable of traversing network address translators (NATs) and firewalls.</p> <p>OpenVPN allows peers to authenticate each other using a pre-shared secret key, certificates, or username/password. When used in a multiclient-server configuration, it allows the server to release an authentication certificate for every client, using signature and Certificate authority. It uses the OpenSSL encryption library extensively, as well as the TLSv1.2/TLSv1.3 protocol, and contains many security and control features.</p>"},{"location":"lpic2.212.5/#installing","title":"Installing","text":"<p>OpenVPN is available on almost any modern operating system and can be built from source or installed as a pre-built package.</p> <p>OpenVPN is not compatible with IPsec or any other VPN package. The entire package consists of one binary for both client and server connections, an optional configuration file, and one or more key files depending on the authentication method used.</p>"},{"location":"lpic2.212.5/#openvpn-options","title":"<code>openvpn</code> options","text":"<p>OpenVPN allows any option to be placed either on the command line or in a configuration file. Though all command line options are preceded by a double-leading-dash (\"--\"), this prefix can be removed when an option is placed in a configuration file.</p> <p>--config file</p> <ul> <li>Load additional config options from file where each line corresponds     to one command line option, but with the leading \\\"--\\\" removed.</li> </ul> <p>-dev tunX|tapX|null</p> <ul> <li>TUN/TAP virtual network device (X can be omitted for a dynamic     device.).</li> </ul> <p>---nobind bits</p> <ul> <li>Do not bind to local address and port. The IP stack will allocate a     dynamic port for returning packets. Since the value of the dynamic     port could not be known in advance by a peer, this option is only     suitable for peers which will be initiating connections by using the     --remote option.</li> </ul> <p>--ifconfig l rn connection_spec</p> <ul> <li>Set TUN/TAP parameters. l is the IP address of the local VPN     endpoint. For TUN devices, rn is the IP address of the remote VPN     endpoint. For TAP devices, rn is the subnet mask of the virtual     ethernet segment which is being created or connected to.</li> </ul> <p>secret file [direction]</p> <ul> <li>Enable Static Key encryption mode (non-TLS). Use pre-shared secret     file which was generated with --genkey</li> </ul>"},{"location":"lpic2.212.5/#configuration","title":"Configuration","text":""},{"location":"lpic2.212.5/#simple-point-to-point-example","title":"Simple point-to-point example","text":"<p>This example uses static keys for authentication. This is a very simple setup, ideal for point-to-point networking. In the following example the tun interfaces will be used. Another possibility would be to use the tap interfaces but then the configuration would also be a little bit different. See the man pages for more information about using these interfaces.</p> <p>A VPN tunnel will be created with a server endpoint of 10.10.10.10 and a client endpoint of 10.10.10.11. The public ipaddress of the server is referenced by vpnserver.example.com. The communication between these endpoints will be encrypted and occur over the default OpenVPN port 1194.</p> <p>openvpn To setup this example a key has to be created: <code>openvpn --genkey                      --secret static.key</code>. Copy this key (<code>static.key</code>) to both client and server.</p> <p>Server configuration file (server.conf):</p> <pre><code>    dev tun\n    ifconfig 10.10.10.10 10.10.10.11\n    keepalive 10 60\n    ping-timer-rem\n    persist-tun\n    persist-key\n    secret static.key\n</code></pre> <p>Client configuration file (client.conf):</p> <pre><code>    remote vpnserver.example.com\n    dev tun \n    ifconfig 10.10.10.11 10.10.10.10\n    keepalive 10 60\n    ping-timer-rem\n    persist-tun\n    persist-key\n    secret static.key\n</code></pre> <p>Start the vpn on the server by running <code>openvpn server.conf</code> and running <code>openvpn client.conf</code> on the client.</p>"},{"location":"lpicbook_about/","title":"About this book","text":"<p>Copyright \u00a9 2001-2021 Sue B.V.  -  Open Sourced 2021</p>"},{"location":"lpicbook_about/#audience","title":"Audience","text":"<p>this book intends to help people prepare for the LPIC-201 exam. You will need to have at least 2 years of practical experience with Unix, preferably Linux. Though you may take the LPIC-2 exam without it, you should be an LPIC-1 alumnus to be allowed to the titles and rights that come with the LPIC-2 certification.</p>"},{"location":"lpicbook_about/#sources","title":"Sources","text":"<p>Our sources of information were partly material on the Internet. Mostly practical experience of the authors and others and research done by the authors are to be credited. We try to give credit where due, but are fallible. We apologize.</p> <p>While every precaution was made in the preparation of this book, we can assume no responsibility for errors or omissions. When you feel we have not given you proper credit or feel we may have violated your rights or when you have suggestions how we may improve our work please notify us immediately so we can take corrective actions.</p>"},{"location":"lpicbook_about/#organization-of-this-book","title":"Organization of this book:","text":"<p>This book is organized following the LPI Level 2 Topics, revision 4.5.0 of February 13<sup>th</sup>, 2017 and written in Markdown.</p>"}]}